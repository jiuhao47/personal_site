{"config":{"lang":["zh","en"],"separator":"[\\s\\-]+","pipeline":["stemmer","stopWordFilter","trimmer"]},"docs":[{"location":"","title":"\u4e3b\u9875","text":"","boost":2},{"location":"#_2","title":"\u7f51\u7ad9\u4fe1\u606f","text":"<p>\u8fd9\u662fJiuhao47\u7684\u4e2a\u4eba\u7f51\u7ad9\uff0c\u4e3b\u8981\u7528\u4e8e\u8bb0\u5f55\u5206\u4eab\u65e5\u5e38\u5b66\u4e60\u751f\u6d3b</p> <p>\u4e2a\u4eba\u7ea7\u5c0f\u7f51\u7ad9\uff0c\u66f4\u65b0\u770b\u5fc3\u60c5\u4e0e\u9700\u6c42\uff0c\u53ef\u9002\u5ea6\u50ac\u66f4\uff08\u9003\uff09</p> <p></p>","boost":2},{"location":"#_3","title":"\u8054\u7cfb\u65b9\u5f0f","text":"<p>QQ: 201499832</p> <p>Email: jiangjunyan22@mails.ucas.ac.cn</p>","boost":2},{"location":"blog/","title":"Blog","text":""},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/","title":"Libfuzzer \u6e90\u7801\u9605\u8bfb\uff08\u4e00\uff09","text":"","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerbuiltinsh","title":"FuzzerBuiltins.h","text":"<p>\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5305\u88c5\u51fd\u6570\u548c\u5b8f</p> C++<pre><code>#include \"FuzzerPlatform.h\"\n#include &lt;cstdint&gt;\n</code></pre> <ul> <li> <p><code>cstdint</code> \u662f C++11 \u5f15\u5165\u7684\u5934\u6587\u4ef6\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e9b\u6807\u51c6\u7684\u6574\u6570\u7c7b\u578b\uff0c\u5982 <code>int8_t</code>\u3001<code>int16_t</code>\u3001<code>int32_t</code>\u3001<code>int64_t</code>\u3001<code>uint8_t</code>\u3001<code>uint16_t</code>\u3001<code>uint32_t</code>\u3001<code>uint64_t</code> \u7b49\u3002</p> </li> <li> <p>FuzzerPlatform.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5e73\u53f0\u76f8\u5173\u7684\u5b8f\u548c\u51fd\u6570\u3002</p> </li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#_1","title":"\u90e8\u5206\u51fd\u6570\u53ca\u547d\u540d\u7a7a\u95f4\u5b9a\u4e49","text":"<p><code>C++</code>\u8bed\u8a00\u7684\u547d\u540d\u7a7a\u95f4\u662f\u4e00\u79cd\u7528\u4e8e\u7ec4\u7ec7\u4ee3\u7801\u7684\u673a\u5236\uff0c\u4e3b\u8981\u7528\u4e8e\u907f\u514d\u540d\u79f0\u51b2\u7a81\u3002\u547d\u540d\u7a7a\u95f4\u5141\u8bb8\u5c06\u6807\u8bc6\u7b26\uff08\u5982\u53d8\u91cf\u3001\u51fd\u6570\u3001\u7c7b\u7b49\uff09\u5206\u7ec4\uff0c\u4ece\u800c\u5728\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u540d\u79f0\u800c\u4e0d\u4f1a\u4ea7\u751f\u51b2\u7a81\u3002</p> C++<pre><code>namespace fuzzer {\n\ninline uint8_t  Bswap(uint8_t x)  { return x; }\ninline uint16_t Bswap(uint16_t x) { return __builtin_bswap16(x); }\ninline uint32_t Bswap(uint32_t x) { return __builtin_bswap32(x); }\ninline uint64_t Bswap(uint64_t x) { return __builtin_bswap64(x); }\n\ninline uint32_t Clzll(unsigned long long X) { return __builtin_clzll(X); }\ninline int Popcountll(unsigned long long X) { return __builtin_popcountll(X); }\n\n}\n</code></pre> <ul> <li><code>Bswap</code>\u7cfb\u5217\u51fd\u6570\uff1a\u7528\u4e8e\u5b57\u8282\u5e8f\u8f6c\u6362\uff0c\u5206\u522b\u5904\u74068\u4f4d\u300116\u4f4d\u300132\u4f4d\u548c64\u4f4d\u6574\u6570\u3002</li> <li><code>Clzll</code>\uff1a\u8ba1\u7b97\u65e0\u7b26\u53f7\u957f\u6574\u578b\u7684\u524d\u5bfc\u96f6\u6570\u91cf\u3002</li> <li><code>Popcountll</code>\uff1a\u8ba1\u7b97\u65e0\u7b26\u53f7\u957f\u6574\u578b\u7684\u4f4d\u6570\u4e2d1\u7684\u6570\u91cf\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerplatformh","title":"FuzzerPlatform.h","text":"<p>\u4e3b\u8981\u7528\u4e8e\u5b9a\u4e49\u4e0e\u5e73\u53f0\u76f8\u5173\u7684\u5b8f\uff0c\u4ee5\u4fbf\u5728\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u8fdb\u884c\u6a21\u7cca\u6d4b\u8bd5</p> C++<pre><code>#if defined(__has_feature)\n#if __has_feature(address_sanitizer)\n#define ATTRIBUTE_NO_SANITIZE_ALL ATTRIBUTE_NO_SANITIZE_ADDRESS\n#elif __has_feature(memory_sanitizer)\n#define ATTRIBUTE_NO_SANITIZE_ALL ATTRIBUTE_NO_SANITIZE_MEMORY\n#else\n#define ATTRIBUTE_NO_SANITIZE_ALL\n#endif\n#else\n#define ATTRIBUTE_NO_SANITIZE_ALL\n#endif\n</code></pre> <ul> <li><code>__has_feature</code>\uff1a\u7528\u4e8e\u68c0\u67e5\u7f16\u8bd1\u5668\u662f\u5426\u652f\u6301\u67d0\u4e2a\u7279\u6027\u3002</li> <li><code>address_sanitizer</code>\uff1a\u5730\u5740\u68c0\u6d4b\u5668\u3002</li> <li><code>memory_sanitizer</code>\uff1a\u5185\u5b58\u68c0\u6d4b\u5668\u3002</li> <li><code>ATTRIBUTE_NO_SANITIZE_ALL</code>\uff1a\u7528\u4e8e\u6307\u793a\u7f16\u8bd1\u5668\u4e0d\u8981\u5bf9\u51fd\u6570\u8fdb\u884c\u67d0\u79cd\u7c7b\u578b\u7684\u68c0\u6d4b\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#_2","title":"\u5185\u5b58/\u5730\u5740\u68c0\u6d4b\u5668","text":"<ul> <li>AddressSanitizer\uff1a\u5730\u5740\u68c0\u6d4b\u5668\uff0c\u7528\u4e8e\u68c0\u6d4b\u5185\u5b58\u8bbf\u95ee\u9519\u8bef\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerbuiltinsmsvch","title":"FuzzerBuiltinsMsvc.h","text":"<p>\u4e3b\u8981\u7528\u4e8e\u5728MSVC\u7f16\u8bd1\u5668\u4e0b\u63d0\u4f9b\u4e00\u4e9b\u5185\u7f6e\u51fd\u6570\u7684\u66ff\u4ee3\u5b9e\u73b0</p> C++<pre><code>#include \"FuzzerPlatform.h\"\n</code></pre> <ul> <li>FuzzerPlatform.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5e73\u53f0\u76f8\u5173\u7684\u5b8f\u548c\u51fd\u6570\u3002</li> </ul> C++<pre><code>// __builtin_return_address() cannot be compiled with MSVC. Use the equivalent\n// from &lt;intrin.h&gt;\n#define GET_CALLER_PC() _ReturnAddress()\n</code></pre> <p>\u5b9a\u4e49\u4e86<code>GET_CALLER_PC()</code>\u5b8f\uff0c\u4f7f\u7528<code>_ReturnAddress()</code>\u66ff\u4ee3<code>__builtin_return_address()</code>\uff0c\u56e0\u4e3a\u540e\u8005\u5728MSVC\u4e2d\u4e0d\u53ef\u7528\u3002</p> C++<pre><code>namespace fuzzer {\n\ninline uint8_t  Bswap(uint8_t x)  { return x; }\n// Use alternatives to __builtin functions from &lt;stdlib.h&gt; and &lt;intrin.h&gt; on\n// Windows since the builtins are not supported by MSVC.\ninline uint16_t Bswap(uint16_t x) { return _byteswap_ushort(x); }\ninline uint32_t Bswap(uint32_t x) { return _byteswap_ulong(x); }\ninline uint64_t Bswap(uint64_t x) { return _byteswap_uint64(x); }\n\n// The functions below were mostly copied from\n// compiler-rt/lib/builtins/int_lib.h which defines the __builtin functions used\n// outside of Windows.\ninline uint32_t Clzll(uint64_t X) {\n  unsigned long LeadZeroIdx = 0;\n\n#if !defined(_M_ARM) &amp;&amp; !defined(_M_X64)\n  // Scan the high 32 bits.\n  if (_BitScanReverse(&amp;LeadZeroIdx, static_cast&lt;unsigned long&gt;(X &gt;&gt; 32)))\n    return static_cast&lt;int&gt;(\n        63 - (LeadZeroIdx + 32)); // Create a bit offset from the MSB.\n  // Scan the low 32 bits.\n  if (_BitScanReverse(&amp;LeadZeroIdx, static_cast&lt;unsigned long&gt;(X)))\n    return static_cast&lt;int&gt;(63 - LeadZeroIdx);\n\n#else\n  if (_BitScanReverse64(&amp;LeadZeroIdx, X)) return 63 - LeadZeroIdx;\n#endif\n  return 64;\n}\n\ninline int Popcountll(unsigned long long X) {\n#if !defined(_M_ARM) &amp;&amp; !defined(_M_X64)\n  return __popcnt(X) + __popcnt(X &gt;&gt; 32);\n#else\n  return __popcnt64(X);\n#endif\n}\n}  // namespace fuzzer\n</code></pre> <ul> <li><code>Bswap</code>\u7cfb\u5217\u51fd\u6570\uff1a\u7528\u4e8e\u5b57\u8282\u5e8f\u8f6c\u6362\uff0c\u5206\u522b\u5904\u74068\u4f4d\u300116\u4f4d\u300132\u4f4d\u548c64\u4f4d\u6574\u6570\u3002</li> <li><code>Clzll</code>\uff1a\u8ba1\u7b97\u65e0\u7b26\u53f7\u957f\u6574\u578b\u7684\u524d\u5bfc\u96f6\u6570\u91cf\u3002</li> <li><code>Popcountll</code>\uff1a\u8ba1\u7b97\u65e0\u7b26\u53f7\u957f\u6574\u578b\u7684\u4f4d\u6570\u4e2d1\u7684\u6570\u91cf\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzercommandh","title":"FuzzerCommand.h","text":"C++<pre><code>#include \"FuzzerDefs.h\"\n#include \"FuzzerIO.h\"\n\n#include &lt;sstream&gt;\n#include &lt;algorithm&gt;\n#include &lt;string&gt;\n#include &lt;vector&gt;\n#include &lt;thread&gt;\n</code></pre> <ul> <li>FuzzerDefs.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5e38\u91cf\u548c\u6570\u636e\u7ed3\u6784\u3002</li> <li>FuzzerIO.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u8f93\u5165\u8f93\u51fa\u76f8\u5173\u7684\u51fd\u6570\u3002</li> <li><code>sstream</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u7528\u4e8e\u5b57\u7b26\u4e32\u6d41\u7684\u7c7b\u3002</li> <li><code>algorithm</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u7528\u4e8e\u64cd\u4f5c\u5e8f\u5217\u7684\u51fd\u6570\u3002</li> <li><code>string</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u7528\u4e8e\u5b57\u7b26\u4e32\u64cd\u4f5c\u7684\u51fd\u6570\u3002</li> <li><code>vector</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u7528\u4e8e\u5411\u91cf\u64cd\u4f5c\u7684\u51fd\u6570\u3002</li> <li><code>thread</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u7528\u4e8e\u7ebf\u7a0b\u64cd\u4f5c\u7684\u51fd\u6570\u3002</li> </ul> C++<pre><code>namespace fuzzer {\n\nclass Command final {\npublic:\n  // This command line flag is used to indicate that the remaining command line\n  // is immutable, meaning this flag effectively marks the end of the mutable\n  // argument list.\n  static inline const char *ignoreRemainingArgs() {\n    return \"-ignore_remaining_args=1\";\n  }\n\n  Command() : CombinedOutAndErr(false) {}\n\n  explicit Command(const std::vector&lt;std::string&gt; &amp;ArgsToAdd)\n      : Args(ArgsToAdd), CombinedOutAndErr(false) {}\n\n  explicit Command(const Command &amp;Other)\n      : Args(Other.Args), CombinedOutAndErr(Other.CombinedOutAndErr),\n        OutputFile(Other.OutputFile) {}\n\n  Command &amp;operator=(const Command &amp;Other) {\n    Args = Other.Args;\n    CombinedOutAndErr = Other.CombinedOutAndErr;\n    OutputFile = Other.OutputFile;\n    return *this;\n  }\n\n  ~Command() {}\n\n  // Returns true if the given Arg is present in Args.  Only checks up to\n  // \"-ignore_remaining_args=1\".\n  bool hasArgument(const std::string &amp;Arg) const {\n    auto i = endMutableArgs();\n    return std::find(Args.begin(), i, Arg) != i;\n  }\n\n  // Gets all of the current command line arguments, **including** those after\n  // \"-ignore-remaining-args=1\".\n  const std::vector&lt;std::string&gt; &amp;getArguments() const { return Args; }\n\n  // Adds the given argument before \"-ignore_remaining_args=1\", or at the end\n  // if that flag isn't present.\n  void addArgument(const std::string &amp;Arg) {\n    Args.insert(endMutableArgs(), Arg);\n  }\n\n  // Adds all given arguments before \"-ignore_remaining_args=1\", or at the end\n  // if that flag isn't present.\n  void addArguments(const std::vector&lt;std::string&gt; &amp;ArgsToAdd) {\n    Args.insert(endMutableArgs(), ArgsToAdd.begin(), ArgsToAdd.end());\n  }\n\n  // Removes the given argument from the command argument list.  Ignores any\n  // occurrences after \"-ignore_remaining_args=1\", if present.\n  void removeArgument(const std::string &amp;Arg) {\n    auto i = endMutableArgs();\n    Args.erase(std::remove(Args.begin(), i, Arg), i);\n  }\n\n  // Like hasArgument, but checks for \"-[Flag]=...\".\n  bool hasFlag(const std::string &amp;Flag) const {\n    std::string Arg(\"-\" + Flag + \"=\");\n    auto IsMatch = [&amp;](const std::string &amp;Other) {\n      return Arg.compare(0, std::string::npos, Other, 0, Arg.length()) == 0;\n    };\n    return std::any_of(Args.begin(), endMutableArgs(), IsMatch);\n  }\n\n  // Returns the value of the first instance of a given flag, or an empty string\n  // if the flag isn't present.  Ignores any occurrences after\n  // \"-ignore_remaining_args=1\", if present.\n  std::string getFlagValue(const std::string &amp;Flag) const {\n    std::string Arg(\"-\" + Flag + \"=\");\n    auto IsMatch = [&amp;](const std::string &amp;Other) {\n      return Arg.compare(0, std::string::npos, Other, 0, Arg.length()) == 0;\n    };\n    auto i = endMutableArgs();\n    auto j = std::find_if(Args.begin(), i, IsMatch);\n    std::string result;\n    if (j != i) {\n      result = j-&gt;substr(Arg.length());\n    }\n    return result;\n  }\n\n  // Like AddArgument, but adds \"-[Flag]=[Value]\".\n  void addFlag(const std::string &amp;Flag, const std::string &amp;Value) {\n    addArgument(\"-\" + Flag + \"=\" + Value);\n  }\n\n  // Like RemoveArgument, but removes \"-[Flag]=...\".\n  void removeFlag(const std::string &amp;Flag) {\n    std::string Arg(\"-\" + Flag + \"=\");\n    auto IsMatch = [&amp;](const std::string &amp;Other) {\n      return Arg.compare(0, std::string::npos, Other, 0, Arg.length()) == 0;\n    };\n    auto i = endMutableArgs();\n    Args.erase(std::remove_if(Args.begin(), i, IsMatch), i);\n  }\n\n  // Returns whether the command's stdout is being written to an output file.\n  bool hasOutputFile() const { return !OutputFile.empty(); }\n\n  // Returns the currently set output file.\n  const std::string &amp;getOutputFile() const { return OutputFile; }\n\n  // Configures the command to redirect its output to the name file.\n  void setOutputFile(const std::string &amp;FileName) { OutputFile = FileName; }\n\n  // Returns whether the command's stderr is redirected to stdout.\n  bool isOutAndErrCombined() const { return CombinedOutAndErr; }\n\n  // Sets whether to redirect the command's stderr to its stdout.\n  void combineOutAndErr(bool combine = true) { CombinedOutAndErr = combine; }\n\n  // Returns a string representation of the command.  On many systems this will\n  // be the equivalent command line.\n  std::string toString() const {\n    std::stringstream SS;\n    for (const auto &amp;arg : getArguments())\n      SS &lt;&lt; arg &lt;&lt; \" \";\n    if (hasOutputFile())\n      SS &lt;&lt; \"&gt;\" &lt;&lt; getOutputFile() &lt;&lt; \" \";\n    if (isOutAndErrCombined())\n      SS &lt;&lt; \"2&gt;&amp;1 \";\n    std::string result = SS.str();\n    if (!result.empty())\n      result = result.substr(0, result.length() - 1);\n    return result;\n  }\n\nprivate:\n  Command(Command &amp;&amp;Other) = delete;\n  Command &amp;operator=(Command &amp;&amp;Other) = delete;\n\n  std::vector&lt;std::string&gt;::iterator endMutableArgs() {\n    return std::find(Args.begin(), Args.end(), ignoreRemainingArgs());\n  }\n\n  std::vector&lt;std::string&gt;::const_iterator endMutableArgs() const {\n    return std::find(Args.begin(), Args.end(), ignoreRemainingArgs());\n  }\n\n  // The command arguments.  Args[0] is the command name.\n  std::vector&lt;std::string&gt; Args;\n\n  // True indicates stderr is redirected to stdout.\n  bool CombinedOutAndErr;\n\n  // If not empty, stdout is redirected to the named file.\n  std::string OutputFile;\n};\n\n} // namespace fuzzer\n</code></pre> <p>\u8be5\u6bb5\u4ee3\u7801\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>Command</code> \u7c7b\uff0c\u4e3b\u8981\u7528\u4e8e\u7ba1\u7406\u547d\u4ee4\u884c\u53c2\u6570\u548c\u76f8\u5173\u64cd\u4f5c\u3002\u4ee5\u4e0b\u662f\u9010\u90e8\u5206\u5206\u6790\uff1a</p>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#command","title":"Command\u7c7b\u5b9a\u4e49","text":"<ul> <li><code>class Command final</code>: \u5b9a\u4e49\u4e86\u4e00\u4e2a\u4e0d\u53ef\u7ee7\u627f\u7684 <code>Command</code> \u7c7b\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#_3","title":"\u516c\u5171\u6210\u5458","text":"<ul> <li>\u9759\u6001\u65b9\u6cd5:<ul> <li><code>static inline const char *ignoreRemainingArgs()</code>: \u8fd4\u56de\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u8868\u793a\u547d\u4ee4\u884c\u53c2\u6570\u7684\u7ed3\u675f\u6807\u5fd7\u3002</li> </ul> </li> <li>\u6784\u9020\u51fd\u6570:<ul> <li><code>Command()</code>: \u9ed8\u8ba4\u6784\u9020\u51fd\u6570\uff0c\u521d\u59cb\u5316 <code>CombinedOutAndErr</code> \u4e3a <code>false</code>\u3002</li> <li><code>explicit Command(const std::vector&lt;std::string&gt; &amp;ArgsToAdd)</code>: \u63a5\u53d7\u53c2\u6570\u5217\u8868\u5e76\u521d\u59cb\u5316\u3002</li> <li><code>explicit Command(const Command &amp;Other)</code>: \u62f7\u8d1d\u6784\u9020\u51fd\u6570\uff0c\u590d\u5236\u5176\u4ed6 <code>Command</code> \u5bf9\u8c61\u7684\u6210\u5458\u3002</li> </ul> </li> <li>\u8d4b\u503c\u8fd0\u7b97\u7b26:<ul> <li><code>Command &amp;operator=(const Command &amp;Other)</code>: \u8d4b\u503c\u8fd0\u7b97\u7b26\u91cd\u8f7d\uff0c\u590d\u5236\u6210\u5458\u5e76\u8fd4\u56de\u5f53\u524d\u5bf9\u8c61\u7684\u5f15\u7528\u3002</li> </ul> </li> <li>\u6790\u6784\u51fd\u6570:<ul> <li><code>~Command()</code>: \u9ed8\u8ba4\u6790\u6784\u51fd\u6570\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#_4","title":"\u6210\u5458\u51fd\u6570","text":"<ul> <li> <p>\u53c2\u6570\u7ba1\u7406:</p> <ul> <li><code>bool hasArgument(const std::string &amp;Arg)</code>: \u68c0\u67e5\u7ed9\u5b9a\u53c2\u6570\u662f\u5426\u5b58\u5728\u3002</li> <li><code>const std::vector&lt;std::string&gt; &amp;getArguments() const</code>: \u83b7\u53d6\u5f53\u524d\u6240\u6709\u547d\u4ee4\u884c\u53c2\u6570\u3002</li> <li><code>void addArgument(const std::string &amp;Arg)</code>: \u5728\u6807\u5fd7\u524d\u6dfb\u52a0\u53c2\u6570\u3002</li> <li><code>void addArguments(const std::vector&lt;std::string&gt; &amp;ArgsToAdd)</code>: \u6279\u91cf\u6dfb\u52a0\u53c2\u6570\u3002</li> <li><code>void removeArgument(const std::string &amp;Arg)</code>: \u79fb\u9664\u6307\u5b9a\u53c2\u6570\u3002</li> </ul> </li> <li> <p>\u6807\u5fd7\u7ba1\u7406:</p> <ul> <li><code>bool hasFlag(const std::string &amp;Flag)</code>: \u68c0\u67e5\u7ed9\u5b9a\u6807\u5fd7\u662f\u5426\u5b58\u5728\u3002</li> <li><code>std::string getFlagValue(const std::string &amp;Flag)</code>: \u83b7\u53d6\u6807\u5fd7\u7684\u503c\u3002</li> <li><code>void addFlag(const std::string &amp;Flag, const std::string &amp;Value)</code>: \u6dfb\u52a0\u5e26\u503c\u7684\u6807\u5fd7\u3002</li> <li><code>void removeFlag(const std::string &amp;Flag)</code>: \u79fb\u9664\u5e26\u503c\u7684\u6807\u5fd7\u3002</li> </ul> </li> <li> <p>\u8f93\u51fa\u7ba1\u7406:</p> <ul> <li><code>bool hasOutputFile() const</code>: \u68c0\u67e5\u662f\u5426\u6709\u8f93\u51fa\u6587\u4ef6\u3002</li> <li><code>const std::string &amp;getOutputFile() const</code>: \u83b7\u53d6\u5f53\u524d\u8f93\u51fa\u6587\u4ef6\u540d\u3002</li> <li><code>void setOutputFile(const std::string &amp;FileName)</code>: \u8bbe\u7f6e\u8f93\u51fa\u6587\u4ef6\u540d\u3002</li> <li><code>bool isOutAndErrCombined() const</code>: \u68c0\u67e5\u6807\u51c6\u9519\u8bef\u662f\u5426\u4e0e\u6807\u51c6\u8f93\u51fa\u5408\u5e76\u3002</li> <li><code>void combineOutAndErr(bool combine = true)</code>: \u8bbe\u7f6e\u6807\u51c6\u9519\u8bef\u4e0e\u6807\u51c6\u8f93\u51fa\u7684\u5408\u5e76\u72b6\u6001\u3002</li> </ul> </li> <li> <p>\u5b57\u7b26\u4e32\u8868\u793a:</p> <ul> <li><code>std::string toString() const</code>: \u8fd4\u56de\u547d\u4ee4\u7684\u5b57\u7b26\u4e32\u8868\u793a\uff0c\u901a\u5e38\u662f\u547d\u4ee4\u884c\u683c\u5f0f\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#_5","title":"\u79c1\u6709\u6210\u5458","text":"<ul> <li> <p>\u6210\u5458\u53d8\u91cf:</p> <ul> <li><code>std::vector&lt;std::string&gt; Args</code>: \u5b58\u50a8\u547d\u4ee4\u884c\u53c2\u6570\u3002</li> <li><code>bool CombinedOutAndErr</code>: \u6307\u793a\u6807\u51c6\u9519\u8bef\u662f\u5426\u91cd\u5b9a\u5411\u5230\u6807\u51c6\u8f93\u51fa\u3002</li> <li><code>std::string OutputFile</code>: \u5b58\u50a8\u8f93\u51fa\u6587\u4ef6\u540d\u3002</li> </ul> </li> <li> <p>\u79c1\u6709\u65b9\u6cd5:</p> <ul> <li><code>std::vector&lt;std::string&gt;::iterator endMutableArgs()</code>: \u8fd4\u56de\u53ef\u53d8\u53c2\u6570\u7684\u7ed3\u675f\u8fed\u4ee3\u5668\u3002</li> <li><code>std::vector&lt;std::string&gt;::const_iterator endMutableArgs() const</code>: \u8fd4\u56de\u53ef\u53d8\u53c2\u6570\u7684\u7ed3\u675f\u5e38\u91cf\u8fed\u4ee3\u5668\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerioh","title":"FuzzerIO.h","text":"<p><code>FuzzerIO.h</code>\u6587\u4ef6\u4e3b\u8981\u7528\u4e8e\u5b9a\u4e49\u6a21\u7cca\u6d4b\u8bd5\u4e2d\u7684\u8f93\u5165\u8f93\u51fa\uff08IO\uff09\u76f8\u5173\u7684\u51fd\u6570\u63a5\u53e3\u3002\u4ee5\u4e0b\u662f\u5bf9\u4ee3\u7801\u7684\u9010\u884c\u5206\u6790\uff1a</p> C++<pre><code>#include \"FuzzerDefs.h\"\n</code></pre> <ul> <li> <p>FuzzerDefs.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5e38\u91cf\u548c\u6570\u636e\u7ed3\u6784\u3002</p> </li> <li> <p>\u51fd\u6570\u58f0\u660e\uff1a</p> <ul> <li> <p>\u65f6\u95f4\u548c\u6587\u4ef6\u5904\u7406\uff08\u7b2c18-27\u884c\uff09\uff1a</p> <ul> <li><code>GetEpoch</code>\uff1a\u83b7\u53d6\u6307\u5b9a\u8def\u5f84\u7684\u65f6\u95f4\u6233\u3002</li> <li><code>FileToVector</code>\uff1a\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u5230\u5b57\u8282\u5411\u91cf\u4e2d\u3002</li> <li><code>FileToString</code>\uff1a\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u4e3a\u5b57\u7b26\u4e32\u3002</li> <li><code>CopyFileToErr</code>\uff1a\u5c06\u6587\u4ef6\u5185\u5bb9\u590d\u5236\u5230\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u3002</li> <li><code>WriteToFile</code>\uff1a\u91cd\u8f7d\u51fd\u6570\uff0c\u7528\u4e8e\u5c06\u6570\u636e\u5199\u5165\u6587\u4ef6\u3002</li> </ul> </li> <li> <p>\u8ffd\u52a0\u548c\u8bfb\u53d6\u6587\u4ef6\uff08\u7b2c32-41\u884c\uff09\uff1a</p> <ul> <li><code>AppendToFile</code>\uff1a\u5c06\u6570\u636e\u8ffd\u52a0\u5230\u6587\u4ef6\u3002</li> <li><code>ReadDirToVectorOfUnits</code>\uff1a\u8bfb\u53d6\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u5e76\u5b58\u50a8\u5230\u5355\u4f4d\u5411\u91cf\u4e2d\u3002</li> </ul> </li> <li> <p>\u8def\u5f84\u5904\u7406\uff08\u7b2c39-48\u884c\uff09\uff1a</p> <ul> <li><code>DirPlusFile</code>\uff1a\u8fd4\u56de\u76ee\u5f55\u548c\u6587\u4ef6\u540d\u7684\u7ec4\u5408\u8def\u5f84\u3002</li> <li><code>DirName</code>\uff1a\u83b7\u53d6\u6587\u4ef6\u540d\u7684\u76ee\u5f55\u90e8\u5206\u3002</li> <li><code>TmpDir</code>\uff1a\u83b7\u53d6\u4e34\u65f6\u76ee\u5f55\u8def\u5f84\u3002</li> <li><code>TempPath</code>\uff1a\u751f\u6210\u4e34\u65f6\u6587\u4ef6\u8def\u5f84\u3002</li> </ul> </li> <li> <p>\u6587\u4ef6\u7279\u6027\u68c0\u67e5\uff08\u7b2c51-53\u884c\uff09\uff1a</p> <ul> <li><code>IsInterestingCoverageFile</code>\uff1a\u68c0\u67e5\u6587\u4ef6\u662f\u5426\u4e3a\u6709\u8da3\u7684\u8986\u76d6\u6587\u4ef6\u3002</li> </ul> </li> <li> <p>\u6807\u51c6\u8f93\u51fa\u548c\u9519\u8bef\u5904\u7406\uff08\u7b2c53-66\u884c\uff09\uff1a</p> <ul> <li><code>DupAndCloseStderr</code>\uff1a\u590d\u5236\u5e76\u5173\u95ed\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u3002</li> <li><code>CloseStdout</code>\uff1a\u5173\u95ed\u6807\u51c6\u8f93\u51fa\u3002</li> </ul> </li> <li> <p>\u8f93\u51fa\u6587\u4ef6\u7ba1\u7406\uff08\u7b2c58-59\u884c\uff09\uff1a</p> <ul> <li><code>GetOutputFile</code>\u548c<code>SetOutputFile</code>\uff1a\u83b7\u53d6\u548c\u8bbe\u7f6e\u8f93\u51fa\u6587\u4ef6\u3002</li> </ul> </li> <li> <p>\u6253\u5370\u51fd\u6570\uff08\u7b2c61-66\u884c\uff09\uff1a</p> <ul> <li><code>Puts</code>\u3001<code>Printf</code>\u3001<code>VPrintf</code>\uff1a\u7528\u4e8e\u8f93\u51fa\u5b57\u7b26\u4e32\u548c\u683c\u5f0f\u5316\u8f93\u51fa\u3002</li> </ul> </li> <li> <p>\u5e73\u53f0\u7279\u5b9a\u51fd\u6570\uff08\u7b2c68-72\u884c\uff09\uff1a</p> <ul> <li><code>IsFile</code>\u3001<code>IsDirectory</code>\u3001<code>FileSize</code>\uff1a\u68c0\u67e5\u8def\u5f84\u662f\u5426\u4e3a\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5e76\u83b7\u53d6\u6587\u4ef6\u5927\u5c0f\u3002</li> </ul> </li> <li> <p>\u76ee\u5f55\u64cd\u4f5c\uff08\u7b2c73-85\u884c\uff09\uff1a</p> <ul> <li><code>ListFilesInDirRecursive</code>\uff1a\u9012\u5f52\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u3002</li> <li><code>MkDirRecursive</code>\u548c<code>RmDirRecursive</code>\uff1a\u9012\u5f52\u521b\u5efa\u548c\u5220\u9664\u76ee\u5f55\u3002</li> <li><code>IterateDirRecursive</code>\uff1a\u9012\u5f52\u904d\u5386\u76ee\u5f55\uff0c\u6267\u884c\u56de\u8c03\u51fd\u6570\u3002</li> </ul> </li> </ul> </li> <li> <p>\u7ed3\u6784\u4f53\u5b9a\u4e49\uff08\u7b2c87-90\u884c\uff09\uff1a</p> <ul> <li><code>SizedFile</code>\uff1a\u5305\u542b\u6587\u4ef6\u540d\u548c\u5927\u5c0f\uff0c\u5e76\u91cd\u8f7d\u5c0f\u4e8e\u8fd0\u7b97\u7b26\u3002</li> </ul> </li> <li> <p>\u6587\u4ef6\u5904\u7406\u51fd\u6570\uff08\u7b2c93-112\u884c\uff09\uff1a</p> <ul> <li><code>GetSizedFilesFromDir</code>\uff1a\u83b7\u53d6\u76ee\u5f55\u4e2d\u6240\u6709\u6587\u4ef6\u53ca\u5176\u5927\u5c0f\u3002</li> <li><code>OpenFile</code>\u3001<code>CloseFile</code>\u3001<code>DuplicateFile</code>\u3001<code>RemoveFile</code>\u3001<code>RenameFile</code>\u7b49\u51fd\u6570\u7528\u4e8e\u6587\u4ef6\u7684\u6253\u5f00\u3001\u5173\u95ed\u3001\u590d\u5236\u3001\u5220\u9664\u548c\u91cd\u547d\u540d\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerdefsh","title":"FuzzerDefs.h","text":"<p><code>FuzzerDefs.h</code>\u6587\u4ef6\u4e3b\u8981\u7528\u4e8e\u5b9a\u4e49\u6a21\u7cca\u6d4b\u8bd5\u4e2d\u7684\u57fa\u672c\u6570\u636e\u7ed3\u6784\u548c\u51fd\u6570\u63a5\u53e3\u3002 C++<pre><code>#include &lt;cassert&gt;\n#include &lt;cstddef&gt;\n#include &lt;cstdint&gt;\n#include &lt;cstring&gt;\n#include &lt;memory&gt;\n#include &lt;set&gt;\n#include &lt;string&gt;\n#include &lt;vector&gt;\n</code></pre></p> <ul> <li><code>cassert</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5b8f\uff0c\u7528\u4e8e\u5728\u7a0b\u5e8f\u4e2d\u63d2\u5165\u8c03\u8bd5\u65ad\u8a00\u3002</li> <li><code>cstddef</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0eC\u6807\u51c6\u5e93\u76f8\u5173\u7684\u5b8f\u3002</li> <li><code>cstdint</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u6807\u51c6\u7684\u6574\u6570\u7c7b\u578b\uff0c\u5982 <code>int8_t</code>\u3001<code>int16_t</code>\u3001<code>int32_t</code>\u3001<code>int64_t</code>\u3001<code>uint8_t</code>\u3001<code>uint16_t</code>\u3001<code>uint32_t</code>\u3001<code>uint64_t</code> \u7b49\u3002</li> <li><code>cstring</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0eC\u6807\u51c6\u5e93\u76f8\u5173\u7684\u5b8f\u3002</li> <li><code>memory</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0e\u5185\u5b58\u64cd\u4f5c\u76f8\u5173\u7684\u51fd\u6570\u3002</li> <li><code>set</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0e\u96c6\u5408\u64cd\u4f5c\u76f8\u5173\u7684\u51fd\u6570\u3002</li> <li><code>string</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0e\u5b57\u7b26\u4e32\u64cd\u4f5c\u76f8\u5173\u7684\u51fd\u6570\u3002</li> <li><code>vector</code>\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u4e0e\u5411\u91cf\u64cd\u4f5c\u76f8\u5173\u7684\u51fd\u6570\u3002</li> </ul> C++<pre><code>template &lt;class T&gt; T Min(T a, T b) { return a &lt; b ? a : b; }\ntemplate &lt;class T&gt; T Max(T a, T b) { return a &gt; b ? a : b; }\n</code></pre> <ul> <li>\u6a21\u677f\u51fd\u6570\uff1a<ul> <li><code>Min</code>\u51fd\u6570\uff1a\u8fd4\u56de\u4e24\u4e2a\u503c\u4e2d\u7684\u8f83\u5c0f\u8005\u3002</li> <li><code>Max</code>\u51fd\u6570\uff1a\u8fd4\u56de\u4e24\u4e2a\u503c\u4e2d\u7684\u8f83\u5927\u8005\u3002</li> </ul> </li> </ul> C++<pre><code>class Random;\nclass Dictionary;\nclass DictionaryEntry;\nclass MutationDispatcher;\nstruct FuzzingOptions;\nclass InputCorpus;\nstruct InputInfo;\nstruct ExternalFunctions;\n\n// Global interface to functions that may or may not be available.\nextern ExternalFunctions *EF;\n</code></pre> <ul> <li>\u7c7b\u548c\u7ed3\u6784\u7684\u524d\u5411\u58f0\u660e\uff1a\u58f0\u660e\u4e86\u591a\u4e2a\u7c7b\u548c\u7ed3\u6784</li> </ul> C++<pre><code>typedef std::vector&lt;uint8_t&gt; Unit;\ntypedef std::vector&lt;Unit&gt; UnitVector;\ntypedef int (*UserCallback)(const uint8_t *Data, size_t Size);\n</code></pre> <ul> <li>\u7c7b\u578b\u5b9a\u4e49\uff1a<ul> <li><code>Unit</code>\uff1a\u5b9a\u4e49\u4e3a<code>std::vector&lt;uint8_t&gt;</code>\uff0c\u8868\u793a\u4e00\u4e2a\u5b57\u8282\u6570\u7ec4\u3002</li> <li><code>UnitVector</code>\uff1a\u5b9a\u4e49\u4e3a<code>std::vector&lt;Unit&gt;</code>\uff0c\u8868\u793a\u591a\u4e2a\u5b57\u8282\u6570\u7ec4\u7684\u96c6\u5408\u3002</li> <li><code>UserCallback</code>\uff1a\u5b9a\u4e49\u4e3a\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u7c7b\u578b\uff0c\u63a5\u53d7\u5b57\u8282\u6570\u636e\u548c\u5927\u5c0f\u4f5c\u4e3a\u53c2\u6570\u3002</li> </ul> </li> </ul> C++<pre><code>int FuzzerDriver(int *argc, char ***argv, UserCallback Callback);\n\nuint8_t *ExtraCountersBegin();\nuint8_t *ExtraCountersEnd();\nvoid ClearExtraCounters();\n</code></pre> <ul> <li>\u51fd\u6570\u58f0\u660e\uff1a<ul> <li><code>FuzzerDriver</code>\uff1a\u4e3b\u9a71\u52a8\u51fd\u6570\uff0c\u63a5\u53d7\u547d\u4ee4\u884c\u53c2\u6570\u548c\u7528\u6237\u56de\u8c03\u51fd\u6570\u3002</li> <li><code>ExtraCountersBegin</code>\u548c<code>ExtraCountersEnd</code>\uff1a\u7528\u4e8e\u83b7\u53d6\u989d\u5916\u8ba1\u6570\u5668\u7684\u8d77\u59cb\u548c\u7ed3\u675f\u5730\u5740\u3002</li> <li><code>ClearExtraCounters</code>\uff1a\u6e05\u9664\u989d\u5916\u8ba1\u6570\u5668\u7684\u51fd\u6570\u3002</li> </ul> </li> </ul> C++<pre><code>extern bool RunningUserCallback;\n</code></pre> <ul> <li>\u5168\u5c40\u53d8\u91cf\uff1a\u58f0\u660e\u4e86\u4e00\u4e2a\u5916\u90e8\u5e03\u5c14\u53d8\u91cf<code>RunningUserCallback</code>\uff0c\u53ef\u80fd\u7528\u4e8e\u6307\u793a\u7528\u6237\u56de\u8c03\u662f\u5426\u6b63\u5728\u8fd0\u884c\u3002</li> </ul>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/libfuzzer-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B8%80/#fuzzerutilh","title":"FuzzerUtil.h","text":"C++<pre><code>#include \"FuzzerBuiltins.h\"\n#include \"FuzzerBuiltinsMsvc.h\"\n#include \"FuzzerCommand.h\"\n#include \"FuzzerDefs.h\"\n</code></pre> <ul> <li>FuzzerBuiltins.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5305\u88c5\u51fd\u6570\u548c\u5b8f\u3002</li> <li>FuzzerBuiltinsMsvc.h\uff1a\u5728MSVC\u7f16\u8bd1\u5668\u4e0b\u63d0\u4f9b\u4e00\u4e9b\u5185\u7f6e\u51fd\u6570\u7684\u66ff\u4ee3\u5b9e\u73b0\u3002</li> <li>FuzzerCommand.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u547d\u4ee4\u884c\u53c2\u6570\u76f8\u5173\u7684\u51fd\u6570\u3002</li> <li>FuzzerDefs.h\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5e38\u91cf\u548c\u6570\u636e\u7ed3\u6784\u3002</li> </ul> <p>\u51fd\u6570\u5b9a\u4e49\uff1a</p> <ul> <li><code>PrintHexArray</code>\u548c<code>PrintASCII</code>\uff1a\u7528\u4e8e\u6253\u5370\u5341\u516d\u8fdb\u5236\u6570\u7ec4\u548cASCII\u5b57\u7b26\u3002</li> <li><code>ToASCII</code>\u548c<code>IsASCII</code>\uff1a\u7528\u4e8e\u68c0\u67e5\u548c\u8f6c\u6362\u6570\u636e\u4e3aASCII\u683c\u5f0f\u3002</li> <li><code>Base64</code>\uff1a\u5c06\u6570\u636e\u7f16\u7801\u4e3aBase64\u683c\u5f0f\u3002</li> <li><code>PrintPC</code>\u548c<code>DescribePC</code>\uff1a\u7528\u4e8e\u6253\u5370\u7a0b\u5e8f\u8ba1\u6570\u5668\u4fe1\u606f\u3002</li> <li><code>ExecuteCommand</code>\uff1a\u6267\u884c\u547d\u4ee4\u5e76\u53ef\u83b7\u53d6\u8f93\u51fa\u3002</li> <li><code>CloneArgsWithoutX</code>\uff1a\u514b\u9686\u53c2\u6570\uff0c\u6392\u9664\u7279\u5b9a\u503c\u3002</li> <li><code>SimpleFastHash</code>\uff1a\u8ba1\u7b97\u6570\u636e\u7684\u5feb\u901f\u54c8\u5e0c\u503c\u3002</li> </ul> C++<pre><code>inline uint8_t *RoundUpByPage(uint8_t *P) {\n  uintptr_t X = reinterpret_cast&lt;uintptr_t&gt;(P);\n  size_t Mask = PageSize() - 1;\n  X = (X + Mask) &amp; ~Mask;\n  return reinterpret_cast&lt;uint8_t *&gt;(X);\n}\ninline uint8_t *RoundDownByPage(uint8_t *P) {\n  uintptr_t X = reinterpret_cast&lt;uintptr_t&gt;(P);\n  size_t Mask = PageSize() - 1;\n  X = X &amp; ~Mask;\n  return reinterpret_cast&lt;uint8_t *&gt;(X);\n}\n</code></pre> <p>\u5185\u5b58\u7ba1\u7406\uff1a</p> <p>\u63d0\u4f9b\u4e86\u4e0e\u5185\u5b58\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5982<code>RoundUpByPage</code>\u548c<code>RoundDownByPage</code>\uff0c\u7528\u4e8e\u6309\u9875\u9762\u5927\u5c0f\u5bf9\u9f50\u6307\u9488\u3002</p> <p>\u5e73\u53f0\u7279\u5b9a\u529f\u80fd</p> <ul> <li><code>SetSignalHandler</code>\uff1a\u8bbe\u7f6e\u4fe1\u53f7\u5904\u7406\u7a0b\u5e8f\uff0c\u5904\u7406\u6a21\u7cca\u6d4b\u8bd5\u4e2d\u7684\u7279\u5b9a\u4fe1\u53f7\u3002</li> <li><code>SleepSeconds</code>\uff1a\u4f7f\u7ebf\u7a0b\u6682\u505c\u6307\u5b9a\u7684\u79d2\u6570\u3002</li> <li><code>GetPid</code>\uff1a\u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684ID\u3002</li> <li><code>GetPeakRSSMb</code>\uff1a\u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u7684\u5cf0\u503c\u5e38\u9a7b\u96c6\u5927\u5c0f\uff08RSS\uff09\u3002</li> <li><code>ExecuteCommand</code>\uff1a\u6267\u884c\u547d\u4ee4\u5e76\u53ef\u83b7\u53d6\u8f93\u51fa\u3002</li> <li><code>OpenProcessPipe</code>\uff1a\u6253\u5f00\u8fdb\u7a0b\u7ba1\u9053\u4ee5\u6267\u884c\u547d\u4ee4\u3002</li> <li><code>CloseProcessPipe</code>\uff1a\u5173\u95ed\u6253\u5f00\u7684\u8fdb\u7a0b\u7ba1\u9053\u3002</li> </ul> C++<pre><code>#if __BYTE_ORDER == __LITTLE_ENDIAN\ntemplate &lt;typename T&gt; T HostToLE(T X) { return X; }\n#else\ntemplate &lt;typename T&gt; T HostToLE(T X) { return Bswap(X); }\n#endif\n</code></pre> <p>\u5b57\u8282\u5e8f\u8f6c\u6362\uff1a</p> <p>\u6839\u636e\u5b57\u8282\u5e8f\u5b9a\u4e49\u4e86<code>HostToLE</code>\u6a21\u677f\u51fd\u6570\u3002</p>","tags":["Fuzz","IIE","Libfuzzer"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/","title":"\u8bba\u6587\u7cbe\u8bfb\uff1aIJON: Exploring Deep State Spaces via Fuzzing \uff08\u66f4\u65b0\u4e2d\uff09","text":"<p>IJON: Exploring Deep State Sapces via Fuzzing</p> <p>IJON SPACE EXPLORER Github</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_1","title":"\u80cc\u666f\u4e0e\u6311\u6218","text":"<p>there are still many situations such as complex state machines where fully automated approaches fail.</p> <ul> <li>\u4f20\u7edf\u7684fuzzing\u6280\u672f\u5728\u63a2\u7d22\u6df1\u5c42\u72b6\u6001\u7a7a\u95f4\u65f6\u6548\u679c\u4e0d\u4f73</li> </ul> <p>State-of-the-art fuzzing methods offer very limited ability for a human to interact and aid the fuzzer in such cases</p> <ul> <li>\u73b0\u6709\u7684fuzzing\u65b9\u6cd5\u5bf9\u4eba\u7c7b\u5e72\u9884\u7684\u652f\u6301\u6709\u9650</li> </ul> <p>More specifically, most current approaches are limited to adding a dictionary or new seed inputs to guide the fuzzer. When dealing with complex programs, these mechanisms are unable to uncover new parts of the code base.</p> <ul> <li>\u5927\u591a\u6570\u73b0\u6709\u65b9\u6cd5\u4ec5\u9650\u4e8e\u6dfb\u52a0\u5b57\u5178\u6216\u65b0\u79cd\u5b50\u8f93\u5165\u6765\u5f15\u5bfcfuzzer\u3002\u5728\u5904\u7406\u590d\u6742\u7a0b\u5e8f\u65f6\uff0c\u8fd9\u4e9b\u673a\u5236\u65e0\u6cd5\u53d1\u73b0\u4ee3\u7801\u5e93\u7684\u65b0\u90e8\u5206\u3002</li> </ul> <p>Even with clever program analysis techniques such as symbolic or concolic execution, some constraints cannot be overcome easily.</p> <ul> <li>\u5373\u4f7f\u4f7f\u7528\u4e86\u7b26\u53f7\u6267\u884c\u6216\u5171\u4eab\u6267\u884c\u7b49\u806a\u660e\u7684\u7a0b\u5e8f\u5206\u6790\u6280\u672f\uff0c\u4e5f\u65e0\u6cd5\u8f7b\u677e\u514b\u670d\u4e00\u4e9b\u7ea6\u675f\u3002 </li> </ul> <p>Furthermore, in some cases, state explosion proves too much of a hindrance to current techniques\u2014whether they are fuzzing or symbolic execution based approaches. This is due to the fact that the underlying problem (finding bugs) is undecidable in the general case. As a result, we cannot expect that any single algorithm will perform very well across all target applications that are tested.</p> <ul> <li>\u6b64\u5916\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c \u72b6\u6001\u7206\u70b8 \u5bf9\u5f53\u524d\u6280\u672f\u6784\u6210\u4e86\u592a\u5927\u7684\u969c\u788d\u2014\u2014\u65e0\u8bba\u662f\u57fa\u4e8efuzzing\u8fd8\u662f\u57fa\u4e8e\u7b26\u53f7\u6267\u884c\u7684\u65b9\u6cd5\u3002\u8fd9\u662f\u56e0\u4e3a\u5e95\u5c42\u95ee\u9898\uff08\u67e5\u627e\u9519\u8bef\uff09\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u4e0d\u53ef\u5224\u5b9a\u7684\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u4e0d\u80fd\u671f\u671b \u4efb\u4f55\u5355\u4e2a\u7b97\u6cd5 \u5728\u6240\u6709\u6d4b\u8bd5\u7684\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e0a\u8868\u73b0\u975e\u5e38\u597d\u3002</li> </ul> <p>Since each update to the state data is triggered by certain code, a coverage-based fuzzer is able to explore each individual update in isolation. However, there is no feedback that rewards exploring combinations of different updates leading to new states, if all individual updates have been observed previously. In cases where a specific sequence of updates is needed to uncover a bug, this prevents the fuzzer from making progress.</p> <ul> <li>\u7531\u4e8e\u72b6\u6001\u6570\u636e\u7684\u6bcf\u6b21\u66f4\u65b0\u90fd\u662f\u7531\u67d0\u4e9b\u4ee3\u7801\u89e6\u53d1\u7684\uff0c\u57fa\u4e8e\u8986\u76d6\u7387\u7684fuzzer\u80fd\u591f\u72ec\u7acb\u5730\u63a2\u7d22\u6bcf\u4e2a\u5355\u72ec\u7684\u66f4\u65b0\u3002\u7136\u800c\uff0c\u5982\u679c\u6240\u6709\u5355\u72ec\u7684\u66f4\u65b0\u90fd\u5df2\u7ecf\u88ab\u89c2\u5bdf\u5230\uff0c\u90a3\u4e48\u6ca1\u6709\u53cd\u9988\u4f1a\u5956\u52b1\u63a2\u7d22 \u5bfc\u81f4\u65b0\u72b6\u6001\u7684\u4e0d\u540c\u66f4\u65b0 \u7684\u7ec4\u5408\u3002\u5728 \u9700\u8981\u7279\u5b9a\u7684\u66f4\u65b0\u5e8f\u5217 \u6765\u53d1\u73b0\u9519\u8bef\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u5c06\u963b\u6b62fuzzer\u53d6\u5f97\u8fdb\u5c55\u3002</li> </ul> <p>Similarly, concolic execution based approaches fail, since the exact sequence of updates (and consequently the precise code path chosen) is critical to uncover the bug. Since concolic execution fixes the path to the observed execution path, it is impossible for the solver to obtain an input that triggers the target condition. Lastly, even fully symbolic execution, which is free to explore different paths, fails if the state space grows too large.</p> <ul> <li>\u540c\u6837\uff0c\u57fa\u4e8e\u5171\u4eab\u6267\u884c\u7684\u65b9\u6cd5\u4e5f\u4f1a\u5931\u8d25\uff0c\u56e0\u4e3a \u66f4\u65b0\u7684\u786e\u5207\u987a\u5e8f\uff08\u56e0\u6b64\u9009\u62e9\u7684\u786e\u5207\u4ee3\u7801\u8def\u5f84\uff09\u5bf9\u4e8e\u53d1\u73b0\u9519\u8bef\u81f3\u5173\u91cd\u8981\u3002\u7531\u4e8e\u5171\u4eab\u6267\u884c\u56fa\u5b9a\u4e86\u8def\u5f84\u5230\u89c2\u5bdf\u5230\u7684\u6267\u884c\u8def\u5f84\uff0c\u6c42\u89e3\u5668\u65e0\u6cd5\u83b7\u5f97\u89e6\u53d1\u76ee\u6807\u6761\u4ef6\u7684\u8f93\u5165\u3002\u6700\u540e\uff0c\u5373\u4f7f\u662f\u5b8c\u5168\u7b26\u53f7\u6267\u884c\uff0c\u5982\u679c\u72b6\u6001\u7a7a\u95f4\u53d8\u5f97\u592a\u5927\uff0c\u4e5f\u4f1a\u5931\u8d25\u3002</li> </ul> <p>We note that there is a trend to use more complex solutions, which only support minimal environments/instruction sets, based on symbolic execution to overcome harder challenges in fuzzing On the downside, as observed by various sources, such methods sometimes scale poorly to complex applications.</p> <ul> <li>\u6211\u4eec\u6ce8\u610f\u5230\uff0c\u6709\u4e00\u79cd\u8d8b\u52bf\u662f\u4f7f\u7528\u66f4\u590d\u6742\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u8fd9\u4e9b\u89e3\u51b3\u65b9\u6848\u4ec5\u652f\u6301\u57fa\u4e8e\u7b26\u53f7\u6267\u884c\u7684\u6700\u5c0f\u73af\u5883/\u6307\u4ee4\u96c6\uff0c\u4ee5\u514b\u670dfuzzing\u4e2d\u66f4\u96be\u7684\u6311\u6218\u3002\u7136\u800c\uff0c\u6b63\u5982\u5404\u79cd\u6765\u6e90\u89c2\u5bdf\u5230\u7684\u90a3\u6837\uff0c\u8fd9\u79cd\u65b9\u6cd5\u6709\u65f6\u5728\u590d\u6742\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 \u6269\u5c55\u6027 \u8f83\u5dee\u3002</li> </ul> <p>Generally speaking, a fuzzer tries to sample from \u201cinteresting\u201d regions of the state space as efficiently as possible. However, it is hard to find an accurate and objective metric for how \u201cinteresting\u201d the state space of any given input is.</p> <ul> <li>\u4e00\u822c\u6765\u8bf4\uff0cfuzzer\u8bd5\u56fe\u5c3d\u53ef\u80fd\u9ad8\u6548\u5730\u4ece\u72b6\u6001\u7a7a\u95f4\u7684\u201c\u6709\u8da3\u201d\u533a\u57df\u4e2d\u91c7\u6837\u3002\u7136\u800c\uff0c\u5f88\u96be\u627e\u5230 \u4efb\u4f55\u7ed9\u5b9a\u8f93\u5165\u7684\u72b6\u6001\u7a7a\u95f4\u6709\u591a\u201c\u6709\u8da3\u201d\u7684\u51c6\u786e\u548c\u5ba2\u89c2\u7684\u5ea6\u91cf\u6807\u51c6 \u3002</li> </ul> <p>However, there are code constructs where this approach is unlikely to reach new coverage without exploring intermediate points in the state space.</p> <ul> <li>\u7136\u800c\uff0c\u6709\u4e9b\u4ee3\u7801\u7ed3\u6784\uff0c\u5982\u679c\u4e0d\u63a2\u7d22\u72b6\u6001\u7a7a\u95f4\u4e2d\u7684\u4e2d\u95f4\u70b9\uff0c\u8fd9\u79cd\u65b9\u6cd5\u5f88\u96be\u8fbe\u5230\u65b0\u7684\u8986\u76d6\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#ijon","title":"IJON\u7684\u60f3\u6cd5\u4e0e\u8bbe\u8ba1","text":"<p>IJON, an annotation mechanism that a human analyst can use to guide the fuzzer </p> <p>In contrast to the two aforementioned techniques (adding a dictionary or new seed inputs), this approach allows a more systematic exploration of the program\u2019s behavior based on the data representing the internal state of the program</p> <ul> <li>\u76f8\u8f83\u4e8e\u524d\u9762\u63d0\u5230\u7684\u6dfb\u52a0\u5b57\u5178\u6216\u65b0\u79cd\u5b50\uff0c\u5176\u57fa\u4e8e\u7a0b\u5e8f\u5185\u90e8\u72b6\u6001\u7684\u6570\u636e\uff0c\u5141\u8bb8\u66f4\u7cfb\u7edf\u5730\u63a2\u7d22\u7a0b\u5e8f\u7684\u884c\u4e3a</li> </ul> <p>We extended various AFL-based fuzzers with the ability to annotate the source code of the target application with guidance hints.</p> <ul> <li>\u901a\u8fc7\u5728\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u6e90\u4ee3\u7801\u4e2d\u6dfb\u52a0\u6307\u5bfc\u63d0\u793a\uff0c\u6269\u5c55\u4e86\u5404\u79cd\u57fa\u4e8eAFL\u7684fuzzer\u7684\u529f\u80fd</li> </ul> <p>Our evaluation demonstrates that such simple annotations are able to solve problems that\u2014to the best of our knowledge\u2014no other current fuzzer or symbolic execution based tool can overcome. </p> <p>To further demonstrate the capabilities of our annotations, we use AFL combined with IJON to uncover both novel security issues and issues that previously required a custom and comprehensive grammar to be uncovered.</p> <ul> <li> <p>\u8bc4\u4f30\u8868\u660e\uff0c\u8fd9\u79cd\u7b80\u5355\u7684\u6ce8\u91ca\u80fd\u591f\u89e3\u51b3\u6211\u4eec\u6240\u77e5\u9053\u7684\u5176\u4ed6\u4efb\u4f55\u5f53\u524dfuzzer\u6216\u57fa\u4e8e\u7b26\u53f7\u6267\u884c\u7684\u5de5\u5177\u65e0\u6cd5\u514b\u670d\u7684\u95ee\u9898\u3002</p> </li> <li> <p>\u4e3a\u4e86\u8fdb\u4e00\u6b65\u5c55\u793a\u6211\u4eec\u7684\u6ce8\u91ca\u7684\u80fd\u529b\uff0c\u6211\u4eec\u4f7f\u7528AFL\u7ed3\u5408IJON\u6765\u53d1\u73b0\u65b0\u7684\u5b89\u5168\u95ee\u9898\u548c\u4ee5\u524d\u9700\u8981\u81ea\u5b9a\u4e49\u548c\u5168\u9762\u7684\u8bed\u6cd5\u624d\u80fd\u53d1\u73b0\u7684\u95ee\u9898\u3002</p> </li> </ul> <p>As a result, much attention was placed on further improving fuzzing methods, often to achieve greater code coverage and reach deeper into a given software application.</p> <ul> <li>\u56e0\u6b64\uff0c\u4eba\u4eec\u66f4\u52a0\u5173\u6ce8\u8fdb\u4e00\u6b65\u6539\u8fdbfuzzing\u65b9\u6cd5\uff0c\u901a\u5e38\u662f \u4e3a\u4e86\u5b9e\u73b0\u66f4\u5927\u7684\u4ee3\u7801\u8986\u76d6\u7387\uff0c\u5e76\u6df1\u5165\u5230\u7ed9\u5b9a\u8f6f\u4ef6\u5e94\u7528\u7a0b\u5e8f\u4e2d \u3002</li> </ul> <p>Our approach is also motivated by the observation that many fuzzing practitioners in the industry already use a closed feedback loop in their fuzzing process</p> <ul> <li>\u6211\u4eec\u7684\u65b9\u6cd5\u4e5f\u53d7\u5230\u8fd9\u6837\u7684\u89c2\u5bdf\u7684\u542f\u53d1\uff1a\u8bb8\u591a\u884c\u4e1a\u4e2d\u7684fuzzing\u4ece\u4e1a\u8005\u5df2\u7ecf\u5728\u4ed6\u4eec\u7684fuzzing\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u4e86\u4e00\u4e2a \u5c01\u95ed\u7684\u53cd\u9988\u5faa\u73af</li> </ul> <p>First, they run the fuzzer for some time and then analyze the resulting code coverage. After this manual analysis, they tweak and adapt the fuzzing process to increase coverage. Common strategies for improving the fuzzing performance include removing challenging aspects from the target application (e.g., checksums), changing the mutation strategies, or explicitly adding input samples that solve certain constraints that the fuzzer did not generate in an automated way.This approach has two main reasons: on the one hand, all the \u201ceasy\u201d bugs (i.e., the ones which can be found fully automatically) are found very quickly during a fuzzing campaign. On the other hand, the more interesting bugs are\u2014by definition\u2014the ones that cannot be found using current tools in off-the-shelf configurations and hence, some manual tuning is required. We believe that by assisting and steering the fuzzing process, humans interacting with fuzzers allow for a vastly increased ability to analyze applications and overcome many of the current obstacles related to fuzzing of complex applications.</p> <p>\u9996\u5148\uff0c\u4ed6\u4eec\u8fd0\u884cfuzzer\u4e00\u6bb5\u65f6\u95f4\uff0c\u7136\u540e\u5206\u6790\u751f\u6210\u7684\u4ee3\u7801\u8986\u76d6\u7387\u3002\u5728\u8fd9\u79cd\u624b\u52a8\u5206\u6790\u4e4b\u540e\uff0c\u4ed6\u4eec \u8c03\u6574\u548c\u9002\u5e94fuzzing\u8fc7\u7a0b\u4ee5\u589e\u52a0\u8986\u76d6\u7387 \u3002\u6539\u8fdbfuzzing\u6027\u80fd\u7684\u5e38\u89c1\u7b56\u7565\u5305\u62ec: </p> <ul> <li>\u4ece\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5220\u9664\u5177\u6709\u6311\u6218\u6027\u7684\u65b9\u9762\uff08\u4f8b\u5982\uff0c\u6821\u9a8c\u548c\uff09</li> <li>\u66f4\u6539\u53d8\u5f02\u7b56\u7565</li> <li>\u660e\u786e\u6dfb\u52a0\u89e3\u51b3fuzzer\u672a\u4ee5\u81ea\u52a8\u65b9\u5f0f\u751f\u6210\u7684\u67d0\u4e9b\u7ea6\u675f\u7684\u8f93\u5165\u6837\u672c\u3002</li> </ul> <p>\u8fd9\u79cd\u65b9\u6cd5\u6709\u4e24\u4e2a\u4e3b\u8981\u539f\u56e0\uff1a</p> <ul> <li>\u5728fuzzing\u6d3b\u52a8\u671f\u95f4\uff0c\u6240\u6709\u201c\u5bb9\u6613\u201d\u53d1\u73b0\u7684\u9519\u8bef\uff08\u5373\uff0c\u53ef\u4ee5\u5b8c\u5168\u81ea\u52a8\u53d1\u73b0\u7684\u9519\u8bef\uff09\u90fd\u4f1a\u5f88\u5feb\u88ab\u53d1\u73b0\u3002</li> <li>\u66f4\u6709\u8da3\u7684\u9519\u8bef\u2014\u2014\u6839\u636e\u5b9a\u4e49\u2014\u2014\u662f\u90a3\u4e9b\u4e0d\u80fd\u4f7f\u7528\u5f53\u524d\u5de5\u5177\u5728\u73b0\u6210\u914d\u7f6e\u4e2d\u627e\u5230\u7684\u9519\u8bef\uff0c\u56e0\u6b64\uff0c\u9700\u8981\u4e00\u4e9b\u624b\u52a8\u8c03\u6574\u3002</li> </ul> <p>\u901a\u8fc7\u534f\u52a9\u548c\u5f15\u5bfcfuzzing\u8fc7\u7a0b\uff0c\u4e0efuzzer\u4e92\u52a8\u7684\u4eba\u7c7b\u53ef\u4ee5\u5927\u5927\u589e\u52a0\u5206\u6790\u5e94\u7528\u7a0b\u5e8f\u7684\u80fd\u529b\uff0c\u5e76\u514b\u670d\u4e0efuzzing\u590d\u6742\u5e94\u7528\u7a0b\u5e8f\u76f8\u5173\u7684\u8bb8\u591a\u5f53\u524d\u969c\u788d\u3002</p> <p>Specifically, we focus on a particular class of challenges: we observe that current fuzzers are not able to properly explore the state space of a program beyond code coverage. For example, program executions that result in the same code coverage, but different values in the state, cannot be explored appropriately by current fuzzers. In general, the problem of exploring state is challenging, as it is difficult to automatically infer which values are interesting and which are not. However, a human with a high-level understanding of the program\u2019s goals, often knows which values are relevant and which are not.</p> <ul> <li>\u5177\u4f53\u6765\u8bf4\uff0c\u6211\u4eec\u5173\u6ce8\u4e00\u7c7b\u7279\u5b9a\u7684\u6311\u6218\uff1a\u6211\u4eec\u89c2\u5bdf\u5230\uff0c\u5f53\u524d\u7684fuzzer\u65e0\u6cd5\u9002\u5f53\u5730\u63a2\u7d22\u7a0b\u5e8f\u7684\u72b6\u6001\u7a7a\u95f4\uff0c\u8d85\u51fa\u4e86\u4ee3\u7801\u8986\u76d6\u8303\u56f4\u3002\u4f8b\u5982\uff0c\u5bfc\u81f4\u76f8\u540c\u4ee3\u7801\u8986\u76d6\u7387\u4f46\u72b6\u6001\u503c\u4e0d\u540c\u7684\u7a0b\u5e8f\u6267\u884c\uff0c\u65e0\u6cd5\u88ab\u5f53\u524d\u7684fuzzer\u9002\u5f53\u5730\u63a2\u7d22\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u63a2\u7d22\u72b6\u6001\u7684\u95ee\u9898\u662f\u5177\u6709\u6311\u6218\u6027\u7684\uff0c\u56e0\u4e3a\u5f88\u96be \u81ea\u52a8\u63a8\u65ad\u54ea\u4e9b\u503c\u662f\u6709\u8da3\u7684\uff0c\u54ea\u4e9b\u503c\u662f\u65e0\u8da3\u7684 \u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u7a0b\u5e8f\u76ee\u6807\u6709\u9ad8\u7ea7\u7406\u89e3\u7684\u4eba\uff0c\u901a\u5e38\u77e5\u9053\u54ea\u4e9b\u503c\u662f\u76f8\u5173\u7684\uff0c\u54ea\u4e9b\u503c\u662f\u4e0d\u76f8\u5173\u7684\u3002</li> </ul> <p>a human analyst can annotate parts of the state space that should be explored more thoroughly, hence modifying the feedback function the fuzzer can use. The required annotations are typically small, often only one or two lines of additional code are needed.</p> <ul> <li>\u4eba\u7c7b\u5206\u6790\u5e08\u53ef\u4ee5\u6ce8\u91ca\u5e94\u8be5\u66f4\u5f7b\u5e95\u5730\u63a2\u7d22\u7684\u72b6\u6001\u7a7a\u95f4\u7684\u90e8\u5206\uff0c\u4ece\u800c\u4fee\u6539fuzzer\u53ef\u4ee5\u4f7f\u7528\u7684\u53cd\u9988\u51fd\u6570\u3002\u901a\u5e38\u53ea\u9700\u8981\u5f88\u5c11\u7684\u6ce8\u91ca\uff0c\u901a\u5e38\u53ea\u9700\u8981\u4e00\u4e24\u884c\u989d\u5916\u7684\u4ee3\u7801\u3002</li> </ul> <p>To demonstrate the practical feasibility of the proposed approach, we extended various AFL-based fuzzers with the ability to annotate the source code of the target application with hints to guide the fuzzer.</p> <ul> <li>\u4e3a\u4e86\u8bc1\u660e\u6240\u63d0\u51fa\u7684\u65b9\u6cd5\u7684\u5b9e\u9645\u53ef\u884c\u6027\uff0c\u6211\u4eec\u6269\u5c55\u4e86\u5404\u79cd\u57fa\u4e8eAFL\u7684fuzzer\u7684\u529f\u80fd\uff0c\u4f7f\u5176\u80fd\u591f\u7528\u63d0\u793a\u6ce8\u91ca\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u6e90\u4ee3\u7801\uff0c\u4ee5\u6307\u5bfcfuzzer\u3002</li> </ul> <p>The overall success of AFL and its derivative demonstrates that following the edge coverage is an effective metric to identify new interesting regions. Edge coverage is probably the feature with the best signal to noise ratio in practice\u2014 after all, in most (i.e., not obfuscated) programs, each new edge indicates a special case</p> <ul> <li>AFL\u53ca\u5176\u884d\u751f\u4ea7\u54c1\u7684\u6574\u4f53\u6210\u529f\u8bc1\u660e\uff0c\u9075\u5faa\u8fb9\u8986\u76d6\u662f\u8bc6\u522b\u65b0\u6709\u8da3\u533a\u57df\u7684\u6709\u6548\u6307\u6807\u3002\u8fb9\u8986\u76d6\u53ef\u80fd\u662f\u5b9e\u8df5\u4e2d\u4fe1\u566a\u6bd4\u6700\u597d\u7684\u7279\u5f81\u2014\u2014\u6bd5\u7adf\uff0c\u5728\u5927\u591a\u6570\uff08\u5373\u975e\u6df7\u6dc6\u7684\uff09\u7a0b\u5e8f\u4e2d\uff0c\u6bcf\u4e2a\u65b0\u8fb9\u90fd\u8868\u793a\u4e00\u4e2a\u7279\u6b8a\u60c5\u51b5</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#state-exploration","title":"State Exploration","text":"<p>Known Relevant State Values: Sometimes, code coverage adds no feedback to help the fuzzer to advance. If only a small subset of the states is interesting and a human analyst is able to identify these values, we can directly use them to guide the fuzzer.</p> <ul> <li>\u5df2\u77e5\u76f8\u5173\u72b6\u6001\u503c\uff1a\u6709\u65f6\uff0c\u4ee3\u7801\u8986\u76d6\u4e0d\u63d0\u4f9b\u4efb\u4f55\u53cd\u9988\u6765\u5e2e\u52a9fuzzer\u524d\u8fdb\u3002\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5c0f\u7684\u72b6\u6001\u5b50\u96c6\u662f\u6709\u8da3\u7684\uff0c\u5e76\u4e14\u4eba\u7c7b\u5206\u6790\u5e08\u80fd\u591f\u8bc6\u522b\u8fd9\u4e9b\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b83\u4eec\u6765\u6307\u5bfcfuzzer\u3002</li> </ul> <p>Known State Changes: Sometimes, the program is too complex, or it is not obvious which variables contain interesting state and which ones do not. In such situations, since no sufficiently small set of relevant state values are known to us, we cannot directly use them to guide the fuzzer. Instead, a human analyst might be able to identify positions in the code that are suspected to mutate the state. An analyst can use the history of such state changes as an abstraction for the more complex state and guide the fuzzer. For example, many programs process messages or chunks of inputs individually. Processing different types of input chunks most likely mutates the state in different ways.</p> <ul> <li>\u5df2\u77e5\u72b6\u6001\u53d8\u5316\uff1a\u6709\u65f6\uff0c\u7a0b\u5e8f\u592a\u590d\u6742\uff0c\u6216\u8005\u4e0d\u660e\u663e\u54ea\u4e9b\u53d8\u91cf\u5305\u542b\u6709\u8da3\u7684\u72b6\u6001\uff0c\u54ea\u4e9b\u53d8\u91cf\u4e0d\u5305\u542b\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7531\u4e8e\u6211\u4eec\u4e0d\u77e5\u9053\u8db3\u591f\u5c0f\u7684\u76f8\u5173\u72b6\u6001\u503c\u96c6\uff0c\u6211\u4eec\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528\u5b83\u4eec\u6765\u6307\u5bfcfuzzer\u3002\u76f8\u53cd\uff0c\u4eba\u7c7b\u5206\u6790\u5e08\u53ef\u80fd\u80fd\u591f\u8bc6\u522b\u4ee3\u7801\u4e2d\u7684\u4f4d\u7f6e\uff0c\u6000\u7591\u4f1a\u6539\u53d8\u72b6\u6001\u3002\u5206\u6790\u5e08\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u72b6\u6001\u53d8\u5316\u7684\u5386\u53f2\u4f5c\u4e3a\u66f4\u590d\u6742\u72b6\u6001\u7684\u62bd\u8c61\uff0c\u5e76\u6307\u5bfcfuzzer\u3002\u4f8b\u5982\uff0c\u8bb8\u591a\u7a0b\u5e8f\u9010\u4e2a\u5904\u7406\u6d88\u606f\u6216\u8f93\u5165\u5757\u3002\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7684\u8f93\u5165\u5757\u5f88\u53ef\u80fd\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u6539\u53d8\u72b6\u6001\u3002</li> </ul> <p>Missing Intermediate State: Unlike the previous two cases, there might be neither variables that contain the state, nor code that mutates the state that we care about. In such situations, an analyst can create artificial intermediate states to guide the fuzzer.</p> <ul> <li>\u7f3a\u5931\u4e2d\u95f4\u72b6\u6001\uff1a\u4e0e\u524d\u4e24\u79cd\u60c5\u51b5\u4e0d\u540c\uff0c\u65e2\u6ca1\u6709\u5305\u542b\u72b6\u6001\u7684\u53d8\u91cf\uff0c\u4e5f\u6ca1\u6709\u6211\u4eec\u5173\u5fc3\u7684\u6539\u53d8\u72b6\u6001\u7684\u4ee3\u7801\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u521b\u5efa\u4eba\u5de5\u4e2d\u95f4\u72b6\u6001\u6765\u6307\u5bfcfuzzer\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#approaches-to-state-exploration","title":"Approaches to State Exploration","text":"<p>Known Relevant State Values: As described before, sometimes the code coverage yields nearly no information about the state of the program, because all the interesting state is stored in data. For example, the coverage tells very little about the behavior of a branch-free AES implementation. If the analyst has an understanding of the variables that store the interesting state, he can directly expose the state to the fuzzer and the fuzzer is then able to explore inputs that cause different internal states.</p> <ul> <li>\u5df2\u77e5\u76f8\u5173\u72b6\u6001\u503c\uff1a\u5982\u524d\u6240\u8ff0\uff0c\u6709\u65f6\u4ee3\u7801\u8986\u76d6\u51e0\u4e4e\u4e0d\u63d0\u4f9b\u5173\u4e8e\u7a0b\u5e8f\u72b6\u6001\u7684\u4fe1\u606f\uff0c\u56e0\u4e3a\u6240\u6709\u6709\u8da3\u7684\u72b6\u6001\u90fd\u5b58\u50a8\u5728\u6570\u636e\u4e2d\u3002\u4f8b\u5982\uff0c\u8986\u76d6\u51e0\u4e4e\u4e0d\u63d0\u4f9b\u5173\u4e8e\u65e0\u5206\u652fAES\u5b9e\u73b0\u884c\u4e3a\u7684\u4fe1\u606f\u3002\u5982\u679c\u5206\u6790\u5e08\u4e86\u89e3\u5b58\u50a8\u6709\u8da3\u72b6\u6001\u7684\u53d8\u91cf\uff0c\u4ed6\u53ef\u4ee5\u76f4\u63a5\u5c06\u72b6\u6001\u66b4\u9732\u7ed9fuzzer\uff0c\u7136\u540efuzzer\u5c31\u80fd\u591f\u63a2\u7d22\u5bfc\u81f4\u4e0d\u540c\u5185\u90e8\u72b6\u6001\u7684\u8f93\u5165\u3002</li> </ul> C<pre><code>while (true) {\n  ox = x;\n  oy = y;\n  switch (input[i]) {\n  case 'w':\n    y--;\n    break;\n  case 's':\n    y++;\n    break;\n  case 'a':\n    x--;\n    break;\n  case 'd':\n    x++;\n    break;\n  }\n  if (maze[y][x] == '#') {\n    Bug();\n  }\n  // If target is blocked, do not advance\n  if (maze[y][x] != ' ') {\n    x = ox;\n    y = oy;\n  }\n}\n</code></pre> <p>Consider the code. It implements a small game, in which the player has to navigate a labyrinth by moving in one of four possible directions. It is based on the famous labyrinth demo that is commonly used by the symbolic execution community to demonstrate how a symbolic executor can explore the state space of a maze. In this modified version, it is possible to walk backward and to stay in the same place. This creates a vast amount of different paths through the program. At the same time, there are effectively only four branches that can be covered, thus the coverage alone is not a good indicator of interesting behavior. In this harder version, even KLEE fails to solve the labyrinth. Here, it is essential to understand that the x and y coordinates are relevant states that need to be explored. In mazes with dead ends, it is even impossible to find a solution by trying to increase x or y individually. The combination of both x and y has to be considered to uncover a solution. Since the maze is rather small (at most only a few hundred different x, y pairs are reachable), the analyst can instruct the fuzzer to consider any new pair as new coverage.</p> <ul> <li>\u8003\u8651\u4ee3\u7801\u3002\u5b83\u5b9e\u73b0\u4e86\u4e00\u4e2a\u5c0f\u6e38\u620f\uff0c\u73a9\u5bb6\u5fc5\u987b\u901a\u8fc7\u5728\u56db\u4e2a\u53ef\u80fd\u7684\u65b9\u5411\u4e2d\u79fb\u52a8\u6765\u5bfc\u822a\u8ff7\u5bab\u3002\u5b83\u57fa\u4e8e\u8457\u540d\u7684\u8ff7\u5bab\u6f14\u793a\uff0c\u901a\u5e38\u88ab\u7b26\u53f7\u6267\u884c\u793e\u533a\u7528\u6765\u6f14\u793a\u7b26\u53f7\u6267\u884c\u5668\u5982\u4f55\u63a2\u7d22\u8ff7\u5bab\u7684\u72b6\u6001\u7a7a\u95f4\u3002\u5728\u8fd9\u4e2a\u4fee\u6539\u540e\u7684\u7248\u672c\u4e2d\uff0c\u53ef\u4ee5\u5411\u540e\u8d70\uff0c\u4e5f\u53ef\u4ee5\u505c\u7559\u5728\u539f\u5730\u3002\u8fd9\u901a\u8fc7\u7a0b\u5e8f\u521b\u5efa\u4e86\u5927\u91cf\u4e0d\u540c\u7684\u8def\u5f84\u3002\u540c\u65f6\uff0c\u5b9e\u9645\u4e0a\u53ea\u6709\u56db\u4e2a\u5206\u652f\u53ef\u4ee5\u88ab\u8986\u76d6\uff0c\u56e0\u6b64\u4ec5\u4ec5\u8986\u76d6\u4e0d\u662f\u6709\u8da3\u884c\u4e3a\u7684\u597d\u6307\u6807\u3002\u5728\u8fd9\u4e2a\u66f4\u96be\u7684\u7248\u672c\u4e2d\uff0c\u5373\u4f7f\u662fKLEE\u4e5f\u65e0\u6cd5\u89e3\u51b3\u8ff7\u5bab\u3002\u5728\u8fd9\u91cc\uff0c\u91cd\u8981\u7684\u662f\u8981\u7406\u89e3x\u548cy\u5750\u6807\u662f\u9700\u8981\u63a2\u7d22\u7684\u76f8\u5173\u72b6\u6001\u3002\u5728\u6709\u6b7b\u80e1\u540c\u7684\u8ff7\u5bab\u4e2d\uff0c\u901a\u8fc7\u5c1d\u8bd5\u5355\u72ec\u589e\u52a0x\u6216y\u662f\u4e0d\u53ef\u80fd\u627e\u5230\u89e3\u51b3\u65b9\u6848\u7684\u3002\u5fc5\u987b\u8003\u8651x\u548cy\u7684\u7ec4\u5408\u624d\u80fd\u627e\u5230\u89e3\u51b3\u65b9\u6848\u3002\u7531\u4e8e\u8ff7\u5bab\u76f8\u5f53\u5c0f\uff08\u6700\u591a\u53ea\u6709\u51e0\u767e\u4e2a\u4e0d\u540c\u7684x\uff0cy\u5bf9\u662f\u53ef\u8fbe\u7684\uff09\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u6307\u793afuzzer\u5c06\u4efb\u4f55\u65b0\u5bf9\u89c6\u4e3a\u65b0\u8986\u76d6\u3002</li> </ul> <p>Known State Changes: In some scenarios, the user might not be aware of which parts of the relevant state are interesting to explore or the state might be spread out across the application and hard to identify. Alternatively, the state might be known, but no sufficiently small subset can be identified to be used to guide the fuzzer directly. However, it might be possible to identify parts of the code that are expected to change the state. This situation commonly occurs in applications that consume highly structured data such as sequences of messages or lists of chunks in file formats. In such situations, instead of directly exposing the state itself, the user can create a variable that contains a log of messages or chunk types. This variable can act as a proxy for the actual state changes and can be exposed to the feedback function (Figure 2.b). As a consequence, the fuzzer can now try to explore different combinations of those state changes. In such scenarios, the state change log serves as an abstraction layer to the real state that cannot easily be exposed to the fuzzer. We further elaborate on this in Example 4 of Section III-D.</p> <ul> <li>\u5df2\u77e5\u72b6\u6001\u53d8\u5316\uff1a\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u53ef\u80fd\u4e0d\u77e5\u9053\u54ea\u4e9b\u76f8\u5173\u72b6\u6001\u7684\u90e8\u5206\u662f\u6709\u8da3\u7684\u63a2\u7d22\uff0c\u6216\u8005\u72b6\u6001\u53ef\u80fd\u5206\u6563\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u5f88\u96be\u8bc6\u522b\u3002\u6216\u8005\uff0c\u72b6\u6001\u53ef\u80fd\u662f\u5df2\u77e5\u7684\uff0c\u4f46\u65e0\u6cd5\u8bc6\u522b\u8db3\u591f\u5c0f\u7684\u5b50\u96c6\u6765\u76f4\u63a5\u6307\u5bfcfuzzer\u3002\u4f46\u662f\uff0c\u53ef\u80fd\u53ef\u4ee5\u8bc6\u522b\u9884\u8ba1\u4f1a\u6539\u53d8\u72b6\u6001\u7684\u4ee3\u7801\u90e8\u5206\u3002\u8fd9\u79cd\u60c5\u51b5\u901a\u5e38\u53d1\u751f\u5728\u6d88\u8017\u9ad8\u5ea6\u7ed3\u6784\u5316\u6570\u636e\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u4f8b\u5982\u6d88\u606f\u5e8f\u5217\u6216\u6587\u4ef6\u683c\u5f0f\u4e2d\u7684\u5757\u5217\u8868\u3002 \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5305\u542b\u6d88\u606f\u6216\u5757\u7c7b\u578b\u65e5\u5fd7\u7684\u53d8\u91cf\u3002\u8fd9\u4e2a\u53d8\u91cf\u53ef\u4ee5\u4f5c\u4e3a\u5b9e\u9645\u72b6\u6001\u53d8\u5316\u7684\u4ee3\u7406\uff0c\u5e76\u66b4\u9732\u7ed9\u53cd\u9988\u51fd\u6570\u3002\u56e0\u6b64\uff0cfuzzer\u73b0\u5728\u53ef\u4ee5\u5c1d\u8bd5\u63a2\u7d22\u8fd9\u4e9b\u72b6\u6001\u53d8\u5316\u7684\u4e0d\u540c\u7ec4\u5408 \u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u72b6\u6001\u53d8\u5316\u65e5\u5fd7\u5145\u5f53\u4e86\u4e00\u4e2a\u62bd\u8c61\u5c42\uff0c\u7528\u4e8e\u65e0\u6cd5\u8f7b\u677e\u66b4\u9732\u7ed9fuzzer\u7684\u771f\u5b9e\u72b6\u6001\u3002</li> </ul> C<pre><code>msg = parse_msg();\nswitch (msg.type) {\ncase Hello:\n  eval_hello(msg);\n  break;\ncase Login:\n  eval_login(msg);\n  break;\ncase Msg_A:\n  eval_msg_a(msg);\n  break;\n}\n</code></pre> <p>Consider the dispatcher code shown in Listing 2, which is based on many common protocol implementations. The fuzzer will successfully uncover the different messages. However, AFL has difficulties to generate interesting sequences of messages, as no novel coverage is produced for chaining messages. The fundamental problem here is that the fuzzer is not able to distinguish between different states in the program state machine. By using a log of the types of messages that were successfully processed, the fuzzer is able to explore different states, resulting from combinations of messages, much more effectively.</p> <ul> <li>\u8003\u8651\u4ee3\u7801\u4e2d\u663e\u793a\u7684\u8c03\u5ea6\u7a0b\u5e8f\u4ee3\u7801\uff0c\u5b83\u57fa\u4e8e\u8bb8\u591a\u5e38\u89c1\u7684\u534f\u8bae\u5b9e\u73b0\u3002fuzzer\u5c06\u6210\u529f\u5730\u53d1\u73b0\u4e0d\u540c\u7684\u6d88\u606f\u3002\u7136\u800c\uff0cAFL\u96be\u4ee5\u751f\u6210\u6709\u8da3\u7684\u6d88\u606f\u5e8f\u5217\uff0c\u56e0\u4e3a\u6ca1\u6709\u4e3a\u94fe\u63a5\u6d88\u606f\u751f\u6210\u65b0\u7684\u8986\u76d6\u3002\u8fd9\u91cc\u7684\u6839\u672c\u95ee\u9898\u662ffuzzer\u65e0\u6cd5\u533a\u5206\u7a0b\u5e8f\u72b6\u6001\u673a\u4e2d\u7684\u4e0d\u540c\u72b6\u6001\u3002\u901a\u8fc7\u4f7f\u7528\u6210\u529f\u5904\u7406\u7684\u6d88\u606f\u7c7b\u578b\u7684\u65e5\u5fd7\uff0cfuzzer\u80fd\u591f\u66f4\u6709\u6548\u5730\u63a2\u7d22\u7531\u6d88\u606f\u7ec4\u5408\u4ea7\u751f\u7684\u4e0d\u540c\u72b6\u6001\u3002</li> </ul> <p>Missing Intermediate State: A simple example for issues where neither coverage nor values in the program provide relevant feedback are magic byte checks. Out of the box, AFLstyle fuzzers will not be able to solve them. Note that various approaches try to solve this case using additional methods. However, the same problem persists in more complex cases: if the relationship between the input and the final comparison gets more complex, even techniques like concolic execution will fail. A human analyst on the other hand, can usually reason about how the program behaves and can often provide an indicator of progress. By encoding this indicator as additional artificial intermediate states, the analyst is able to guide the fuzzer. Note that for simple magic bytes like situations, this is exactly what LAF-INTEL does.</p> <ul> <li>\u7f3a\u5931\u4e2d\u95f4\u72b6\u6001\uff1a\u65e2\u4e0d\u6d89\u53ca\u8986\u76d6\u7387\u4e5f\u4e0d\u6d89\u53ca\u503c\u7684\u53cd\u9988\u7684\u95ee\u9898\u7684\u4e00\u4e2a\u7b80\u5355\u4f8b\u5b50\u662f\u9b54\u672f\u5b57\u8282\u68c0\u67e5\u3002\u5728\u5f00\u7bb1\u5373\u7528\u7684\u60c5\u51b5\u4e0b\uff0cAFL\u98ce\u683c\u7684fuzzer\u5c06\u65e0\u6cd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u8bf7\u6ce8\u610f\uff0c\u5404\u79cd\u65b9\u6cd5\u5c1d\u8bd5\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u7136\u800c\uff0c\u5728\u66f4\u590d\u6742\u7684\u60c5\u51b5\u4e0b\uff0c\u540c\u6837\u7684\u95ee\u9898\u4ecd\u7136\u5b58\u5728\uff1a\u5982\u679c\u8f93\u5165\u548c\u6700\u7ec8\u6bd4\u8f83\u4e4b\u95f4\u7684\u5173\u7cfb\u53d8\u5f97\u66f4\u52a0\u590d\u6742\uff0c\u5373\u4f7f\u662f\u5171\u4eab\u6267\u884c\u8fd9\u6837\u7684\u6280\u672f\u4e5f\u4f1a\u5931\u8d25\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4eba\u7c7b\u5206\u6790\u5e08\u901a\u5e38\u53ef\u4ee5\u63a8\u7406\u7a0b\u5e8f\u7684\u884c\u4e3a\uff0c\u5e76\u7ecf\u5e38\u63d0\u4f9b\u8fdb\u5c55\u7684\u6307\u793a\u3002\u901a\u8fc7\u5c06\u8fd9\u4e2a\u6307\u793a\u7b26\u7f16\u7801\u4e3a\u989d\u5916\u7684\u4eba\u5de5\u4e2d\u95f4\u72b6\u6001\uff0c\u5206\u6790\u5e08\u80fd\u591f\u6307\u5bfcfuzzer\u3002\u8bf7\u6ce8\u610f\uff0c\u5bf9\u4e8e\u7b80\u5355\u7684\u9b54\u672f\u5b57\u8282\u60c5\u51b5\uff0c\u8fd9\u6b63\u662fLAF-INTEL\u6240\u505a\u7684\u3002</li> </ul> C<pre><code>// shortened version of a hashmap lookup from binutils\nentry *bfd_get_section_by_name(table *tbl, char *str) {\n  entry *lp;\n  uint32_t hash = bfd_hash_hash(str);\n  uint32_t i = hash % tbl-&gt;size;\n  // Every hash bucket contains a linked list of strings\n  for (lp = tbl-&gt;table[i]; lp != NULL; lp = lp-&gt;next) {\n    if (lp-&gt;hash == hash &amp;&amp; strcmp(lp-&gt;string, str) == 0)\n      return lp;\n  }\n  return NULL;\n}\n// used somewhere else\nsection = bfd_get_section_by_name(abfd, \".bootloader\");\nif (section != NULL) {\n  ...\n}\n</code></pre> <p>Consider the code in Listing 3, which is based on a hard case found in the well-known objdump binary. The program contains a function that performs a hash table lookup and one if condition where the lookup result is used to search for a given string. More specifically, the key is first hashed, and the corresponding bucket is checked. If the bucket is empty, no further processing takes place. If the bucket contains some values, they are compared individually. This poses a significant challenge both to a concolic execution based tools as well as fuzzers: solving this constraint requires to find a very specific combination of both a path (i.e., number of loop iterations necessary to calculate the hash) and the hash value that all share the same coverage. Even if the exact path is found, we now still depend on both the hash and the actual string matching. The fuzzer has to solve the comparison while maintaining that the hash of the input is always equal to the hash of the target string. A concolic executor would have great trouble finding the exact path to solve this constraint.</p> <ul> <li>\u8003\u8651\u4ee3\u7801\uff0c\u5b83\u57fa\u4e8e\u8457\u540d\u7684objdump\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\u7684\u4e00\u4e2a\u96be\u9898\u3002\u7a0b\u5e8f\u5305\u542b\u4e00\u4e2a\u6267\u884c\u54c8\u5e0c\u8868\u67e5\u627e\u7684\u51fd\u6570\u548c\u4e00\u4e2aif\u6761\u4ef6\uff0c\u5176\u4e2d\u67e5\u627e\u7ed3\u679c\u7528\u4e8e\u641c\u7d22\u7ed9\u5b9a\u7684\u5b57\u7b26\u4e32\u3002\u66f4\u5177\u4f53\u5730\u8bf4\uff0c\u9996\u5148\u5bf9\u5bc6\u94a5\u8fdb\u884c\u54c8\u5e0c\u5904\u7406\uff0c\u7136\u540e\u68c0\u67e5\u76f8\u5e94\u7684\u6876\u3002\u5982\u679c\u6876\u4e3a\u7a7a\uff0c\u5219\u4e0d\u8fdb\u884c\u8fdb\u4e00\u6b65\u5904\u7406\u3002\u5982\u679c\u6876\u5305\u542b\u4e00\u4e9b\u503c\uff0c\u5219\u9010\u4e2a\u8fdb\u884c\u6bd4\u8f83\u3002\u8fd9\u5bf9\u57fa\u4e8e\u5171\u4eab\u6267\u884c\u7684\u5de5\u5177\u548cfuzzer\u90fd\u6784\u6210\u4e86\u91cd\u5927\u6311\u6218\uff1a\u89e3\u51b3\u8fd9\u4e2a\u7ea6\u675f\u9700\u8981\u627e\u5230\u4e00\u4e2a\u975e\u5e38\u7279\u5b9a\u7684\u7ec4\u5408\uff0c\u5373\u8def\u5f84\uff08\u5373\uff0c\u8ba1\u7b97\u54c8\u5e0c\u6240\u9700\u7684\u5faa\u73af\u8fed\u4ee3\u6b21\u6570\uff09\u548c\u6240\u6709\u5171\u4eab\u76f8\u540c\u8986\u76d6\u7684\u54c8\u5e0c\u503c\u3002\u5373\u4f7f\u627e\u5230\u4e86\u786e\u5207\u7684\u8def\u5f84\uff0c\u6211\u4eec\u73b0\u5728\u4ecd\u7136\u4f9d\u8d56\u4e8e\u54c8\u5e0c\u548c\u5b9e\u9645\u5b57\u7b26\u4e32\u5339\u914d\u3002fuzzer\u5fc5\u987b\u5728\u4fdd\u6301\u8f93\u5165\u7684\u54c8\u5e0c\u59cb\u7ec8\u7b49\u4e8e\u76ee\u6807\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u7684\u60c5\u51b5\u4e0b\u89e3\u51b3\u6bd4\u8f83\u3002\u5171\u4eab\u6267\u884c\u5668\u5c06\u5f88\u96be\u627e\u5230\u89e3\u51b3\u8fd9\u4e2a\u7ea6\u675f\u7684\u786e\u5207\u8def\u5f84\u3002</li> </ul> <p>We found that similar conditions occur more than 500 times with various strings throughout the binutils code base. In most cases, the hash table is filled with values from the input, and a fixed string is looked up. A human can recognize that this effectively implements a one-to-many string comparison. Using this insight, she can guide the fuzzer to find a solution, by turning this complex constraint into a series of simple string comparisons that can be solved with LAF-INTEL-like feedback.</p> <ul> <li>\u6211\u4eec\u53d1\u73b0\u7c7b\u4f3c\u7684\u6761\u4ef6\u5728\u6574\u4e2abinutils\u4ee3\u7801\u5e93\u4e2d\u591a\u8fbe500\u591a\u6b21\uff0c\u4f7f\u7528\u5404\u79cd\u5b57\u7b26\u4e32\u3002\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u54c8\u5e0c\u8868\u586b\u5145\u4e86\u6765\u81ea\u8f93\u5165\u7684\u503c\uff0c\u5e76\u67e5\u627e\u4e86\u4e00\u4e2a\u56fa\u5b9a\u7684\u5b57\u7b26\u4e32\u3002\u4eba\u7c7b\u53ef\u4ee5\u8ba4\u8bc6\u5230\uff0c\u8fd9\u5b9e\u9645\u4e0a\u5b9e\u73b0\u4e86\u4e00\u5bf9\u591a\u7684\u5b57\u7b26\u4e32\u6bd4\u8f83\u3002\u5229\u7528\u8fd9\u4e00\u89c1\u89e3\uff0c\u5979\u53ef\u4ee5\u6307\u5bfcfuzzer\u627e\u5230\u89e3\u51b3\u65b9\u6848\uff0c\u5c06\u8fd9\u4e2a\u590d\u6742\u7684\u7ea6\u675f\u8f6c\u5316\u4e3a\u4e00\u7cfb\u5217\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u6bd4\u8f83\uff0c\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3cLAF-INTEL\u7684\u53cd\u9988\u6765\u89e3\u51b3\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#feedback-mechanisms","title":"Feedback Mechanisms","text":"<p>As no current fuzzer allows a human analyst to directly provide feedback to the fuzzer, we design a set of annotations that allow the analyst to influence the fuzzer\u2019s feedback function. Our goal is that an analyst can use these annotations to provide high-level steering for the fuzzing process. In an interactive fuzzing session, the analyst inspects the code coverage from time to time to identify branches that seem hard to cover for the fuzzer. Then the analyst can identify the reason why the fuzzer is unable to make progress. Typically, this is an easy task for a human. When the road block is found, the analyst can start a second fuzzing session that focuses on solving this road block using a custom annotation. The annotation itself is a small patch to the target application, typically consisting of one, sometimes two lines of code that provide additional feedback information. When the fuzzer solves the road block, the long-running fuzzing session picks the inputs that produce new coverage from the temporary session and continues fuzzing, hence overcoming the hard case.</p> <ul> <li>\u7531\u4e8e\u6ca1\u6709\u5f53\u524d\u7684fuzzer\u5141\u8bb8\u4eba\u7c7b\u5206\u6790\u5e08\u76f4\u63a5\u5411fuzzer\u63d0\u4f9b\u53cd\u9988\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u4e00\u7ec4\u6ce8\u91ca\uff0c\u5141\u8bb8\u5206\u6790\u5e08\u5f71\u54cdfuzzer\u7684\u53cd\u9988\u51fd\u6570\u3002\u6211\u4eec\u7684\u76ee\u6807\u662f\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6ce8\u91ca\u4e3afuzzing\u8fc7\u7a0b\u63d0\u4f9b\u9ad8\u7ea7\u522b\u7684\u5f15\u5bfc\u3002\u5728\u4ea4\u4e92\u5f0ffuzzing\u4f1a\u8bdd\u4e2d\uff0c\u5206\u6790\u5e08\u4e0d\u65f6\u68c0\u67e5\u4ee3\u7801\u8986\u76d6\u7387\uff0c\u4ee5\u8bc6\u522b\u5bf9fuzzer\u6765\u8bf4\u4f3c\u4e4e\u5f88\u96be\u8986\u76d6\u7684\u5206\u652f\u3002\u7136\u540e\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u786e\u5b9afuzzer\u65e0\u6cd5\u53d6\u5f97\u8fdb\u5c55\u7684\u539f\u56e0\u3002\u901a\u5e38\uff0c\u8fd9\u5bf9\u4eba\u7c7b\u6765\u8bf4\u662f\u4e00\u9879\u5bb9\u6613\u7684\u4efb\u52a1\u3002\u5f53\u627e\u5230\u8def\u969c\u65f6\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u542f\u52a8\u7b2c\u4e8c\u4e2afuzzing\u4f1a\u8bdd\uff0c\u91cd\u70b9\u89e3\u51b3\u8fd9\u4e2a\u8def\u969c\uff0c\u4f7f\u7528\u81ea\u5b9a\u4e49\u6ce8\u91ca\u3002\u6ce8\u91ca\u672c\u8eab\u662f\u5bf9\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u4e00\u4e2a\u5c0f\u8865\u4e01\uff0c\u901a\u5e38\u5305\u542b\u4e00\u884c\uff0c\u6709\u65f6\u5305\u542b\u4e24\u884c\u4ee3\u7801\uff0c\u63d0\u4f9b\u989d\u5916\u7684\u53cd\u9988\u4fe1\u606f\u3002\u5f53fuzzer\u89e3\u51b3\u4e86\u8def\u969c\u65f6\uff0c\u957f\u65f6\u95f4\u8fd0\u884c\u7684fuzzing\u4f1a\u8bdd\u4ece\u4e34\u65f6\u4f1a\u8bdd\u4e2d\u9009\u62e9\u4ea7\u751f\u65b0\u8986\u76d6\u7684\u8f93\u5165\uff0c\u5e76\u7ee7\u7eedfuzzing\uff0c\u4ece\u800c\u514b\u670d\u56f0\u96be\u60c5\u51b5\u3002</li> </ul> <p>To facilitate a workflow like this, we designed four general primitives that can be used to annotate source code:</p> <p>1) We allow the analyst to select which code regions are relevant to solve the problem at hand.</p> <p>2) We allow direct access to the AFL bitmap to store additional values. Bitmap entries can either be directly set or incremented, hence enabling to expose state values to the feedback function.</p> <p>3) We enable the analyst to influence the coverage calculation. This allows the same edge coverage to result in different bitmap coverage. This allows to create much more fine-grained feedback in different states.</p> <p>4) We introduce a primitive that allows the user to add hill climbing optimization [48]. This way, the user can provide a goal to work towards if the space of possible states is too large to explore exhaustively. </p> <ul> <li>\u4e3a\u4e86\u4fc3\u8fdb\u8fd9\u6837\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u56db\u4e2a\u901a\u7528\u539f\u8bed\uff0c\u53ef\u4ee5\u7528\u4e8e\u6ce8\u91ca\u6e90\u4ee3\u7801\uff1a<ul> <li>\u6211\u4eec\u5141\u8bb8\u5206\u6790\u5e08\u9009\u62e9\u54ea\u4e9b\u4ee3\u7801\u533a\u57df\u4e0e\u89e3\u51b3\u624b\u5934\u95ee\u9898\u76f8\u5173\u3002</li> <li>\u6211\u4eec\u5141\u8bb8\u76f4\u63a5\u8bbf\u95eeAFL\u4f4d\u56fe\u4ee5\u5b58\u50a8\u9644\u52a0\u503c\u3002\u4f4d\u56fe\u6761\u76ee\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u6216\u9012\u589e\uff0c\u4ece\u800c\u4f7f\u72b6\u6001\u503c\u66b4\u9732\u7ed9\u53cd\u9988\u51fd\u6570\u3002</li> <li>\u6211\u4eec\u4f7f\u5206\u6790\u5e08\u80fd\u591f\u5f71\u54cd\u8986\u76d6\u7387\u8ba1\u7b97\u3002\u8fd9\u5141\u8bb8\u76f8\u540c\u7684\u8fb9\u8986\u76d6\u4ea7\u751f\u4e0d\u540c\u7684\u4f4d\u56fe\u8986\u76d6\u3002\u8fd9\u5141\u8bb8\u5728\u4e0d\u540c\u72b6\u6001\u4e0b\u521b\u5efa\u66f4\u7ec6\u7c92\u5ea6\u7684\u53cd\u9988\u3002</li> <li>\u6211\u4eec\u5f15\u5165\u4e86\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u6dfb\u52a0\u722c\u5761\u4f18\u5316\u7684\u539f\u8bed\u3002\u8fd9\u6837\uff0c\u5982\u679c\u53ef\u80fd\u72b6\u6001\u7a7a\u95f4\u592a\u5927\u800c\u65e0\u6cd5\u8be6\u5c3d\u63a2\u7d22\uff0c\u7528\u6237\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u5de5\u4f5c\u76ee\u6807\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#annotations","title":"Annotations","text":"<ul> <li> <p>IJON-Enable: </p> <p>The IJON-ENABLE (and IJON-DISABLE) annotation can be used to enable and disable coverage feedback. This way, we can effectively exclude certain parts of the code base or guide the fuzzer to only explore code if certain conditions are met.</p> <ul> <li>IJON-ENABLE\uff08\u548cIJON-DISABLE\uff09\u6ce8\u91ca\u53ef\u7528\u4e8e\u542f\u7528\u548c\u7981\u7528\u8986\u76d6\u53cd\u9988\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u53ef\u4ee5\u6709\u6548\u5730\u6392\u9664\u4ee3\u7801\u5e93\u7684\u67d0\u4e9b\u90e8\u5206\uff0c\u6216\u8005\u6307\u5bfcfuzzer\u53ea\u5728\u6ee1\u8db3\u67d0\u4e9b\u6761\u4ef6\u65f6\u63a2\u7d22\u4ee3\u7801\u3002</li> </ul> </li> <li> <p>IJON-INC and IJON-SET</p> <p>The IJON-INC and IJON-SET annotations can be used to increment or set a specific entry in the bitmap. This effectively allows new values in the state to be considered as equal to new code coverage. The analyst can use this annotation to expose aspects of the state to the fuzzer selectively. As a result, the fuzzer can then explore many different values of this variable. Effectively, this annotation adds a feedback mechanism beyond code coverage. The fuzzer is now also rewarded for new data coverage obtained via its test cases. This annotation can be used to provide feedback in all three scenarios that we described earlier.</p> <ul> <li>IJON-INC\u548cIJON-SET\u6ce8\u91ca\u53ef\u7528\u4e8e\u9012\u589e\u6216\u8bbe\u7f6e\u4f4d\u56fe\u4e2d\u7684\u7279\u5b9a\u6761\u76ee\u3002\u8fd9\u5b9e\u9645\u4e0a\u5141\u8bb8\u5c06\u72b6\u6001\u4e2d\u7684\u65b0\u503c\u89c6\u4e3a\u65b0\u7684\u4ee3\u7801\u8986\u76d6\u3002\u5206\u6790\u5e08\u53ef\u4ee5\u4f7f\u7528\u6b64\u6ce8\u91ca\u6709\u9009\u62e9\u5730\u5c06\u72b6\u6001\u7684\u65b9\u9762\u66b4\u9732\u7ed9fuzzer\u3002\u7ed3\u679c\uff0cfuzzer\u73b0\u5728\u53ef\u4ee5\u63a2\u7d22\u8fd9\u4e2a\u53d8\u91cf\u7684\u8bb8\u591a\u4e0d\u540c\u503c\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u6ce8\u91ca\u6dfb\u52a0\u4e86\u4e00\u4e2a\u8d85\u51fa\u4ee3\u7801\u8986\u76d6\u7684\u53cd\u9988\u673a\u5236\u3002\u73b0\u5728\uff0cfuzzer\u8fd8\u5c06\u901a\u8fc7\u5176\u6d4b\u8bd5\u7528\u4f8b\u83b7\u5f97\u7684\u65b0\u6570\u636e\u8986\u76d6\u5956\u52b1\u3002\u6b64\u6ce8\u91ca\u53ef\u7528\u4e8e\u63d0\u4f9b\u6211\u4eec\u65e9\u671f\u63cf\u8ff0\u7684\u6240\u6709\u4e09\u79cd\u60c5\u51b5\u7684\u53cd\u9988\u3002 </li> </ul> <p>As another example, consider Listing 7. After each successfully parsed and handled message, we append the command index, which represents the type of the message, to the state change log. Then we set a single bit, addressed by the hash of the state change log. As a consequence, whenever we see a new combination of up to four successfully handled messages, the fuzzer considers the input as interesting, providing a much better coverage in the state space of the application.</p> <ul> <li>\u4f8b\u5982\uff0c\u8003\u8651\u4ee3\u7801\u3002\u5728\u6bcf\u6b21\u6210\u529f\u89e3\u6790\u548c\u5904\u7406\u6d88\u606f\u540e\uff0c\u6211\u4eec\u5c06\u547d\u4ee4\u7d22\u5f15\uff08\u8868\u793a\u6d88\u606f\u7c7b\u578b\uff09\u9644\u52a0\u5230\u72b6\u6001\u66f4\u6539\u65e5\u5fd7\u4e2d\u3002\u7136\u540e\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u4f4d\uff0c\u7531\u72b6\u6001\u66f4\u6539\u65e5\u5fd7\u7684\u54c8\u5e0c\u5730\u5740\u3002\u56e0\u6b64\uff0c\u6bcf\u5f53\u6211\u4eec\u770b\u5230\u6700\u591a\u56db\u4e2a\u6210\u529f\u5904\u7406\u7684\u6d88\u606f\u7684\u65b0\u7ec4\u5408\u65f6\uff0cfuzzer\u5c06\u8ba4\u4e3a\u8f93\u5165\u662f\u6709\u8da3\u7684\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u72b6\u6001\u7a7a\u95f4\u4e2d\u63d0\u4f9b\u66f4\u597d\u7684\u8986\u76d6\u3002</li> </ul> </li> </ul> <ul> <li> <p>IJON-STATE</p> <p>If the messages cannot easily be concatenated (e.g., because there is a message counter), the state change log might be insufficient to explore different states. To produce a more finegrained feedback, we can explore the Cartesian product of the state and the code coverage. To enable this, we provide a third primitive that is able to change the computation of the edge coverage itself. Similar to ANGORA, we extended the edge tuple with a third component named the \u201cvirtual state\u201d. This virtual state component is also considered when calculating the bitmap index of any edge. This annotation is called IJON-STATE. Whenever the virtual state changes, any edge triggers new coverage. This primitive has to be used carefully: if the number of virtual states grows too large, the fuzzer is overwhelmed with a large number of inputs which effectively slows down the fuzzing progress.</p> <ul> <li>\u5982\u679c\u6d88\u606f\u4e0d\u80fd\u8f7b\u677e\u8fde\u63a5\uff08\u4f8b\u5982\uff0c\u56e0\u4e3a\u6709\u4e00\u4e2a\u6d88\u606f\u8ba1\u6570\u5668\uff09\uff0c\u72b6\u6001\u66f4\u6539\u65e5\u5fd7\u53ef\u80fd\u4e0d\u8db3\u4ee5\u63a2\u7d22\u4e0d\u540c\u7684\u72b6\u6001\u3002\u4e3a\u4e86\u4ea7\u751f\u66f4\u7ec6\u7c92\u5ea6\u7684\u53cd\u9988\uff0c\u6211\u4eec\u53ef\u4ee5\u63a2\u7d22\u72b6\u6001\u548c\u4ee3\u7801\u8986\u76d6\u7684\u7b1b\u5361\u5c14\u79ef\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u80fd\u591f\u6539\u53d8\u8fb9\u8986\u76d6\u8ba1\u7b97\u672c\u8eab\u7684\u7b2c\u4e09\u4e2a\u539f\u8bed\u3002\u7c7b\u4f3c\u4e8eANGORA\uff0c\u6211\u4eec\u6269\u5c55\u4e86\u8fb9\u5143\u7ec4\uff0c\u589e\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a\u201c\u865a\u62df\u72b6\u6001\u201d\u7684\u7b2c\u4e09\u4e2a\u7ec4\u4ef6\u3002\u5728\u8ba1\u7b97\u4efb\u4f55\u8fb9\u7684\u4f4d\u56fe\u7d22\u5f15\u65f6\uff0c\u4e5f\u8003\u8651\u8fd9\u4e2a\u865a\u62df\u72b6\u6001\u7ec4\u4ef6\u3002\u8fd9\u4e2a\u6ce8\u91ca\u79f0\u4e3aIJON-STATE\u3002\u6bcf\u5f53\u865a\u62df\u72b6\u6001\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u4efb\u4f55\u8fb9\u90fd\u4f1a\u89e6\u53d1\u65b0\u7684\u8986\u76d6\u3002\u8fd9\u4e2a\u539f\u8bed\u5fc5\u987b\u5c0f\u5fc3\u4f7f\u7528\uff1a\u5982\u679c\u865a\u62df\u72b6\u6001\u7684\u6570\u91cf\u589e\u957f\u5f97\u592a\u5927\uff0cfuzzer\u5c06\u88ab\u5927\u91cf\u8f93\u5165\u6240\u6df9\u6ca1\uff0c\u8fd9\u5b9e\u9645\u4e0a\u4f1a\u51cf\u6162fuzzing\u7684\u8fdb\u5ea6\u3002</li> </ul> </li> <li> <p>IJON-MAX</p> <p>So far, we mostly dealt with providing feedback that can be used to increase the diversity of the inputs stored. In some cases, however, we want to optimize towards a specific goal or the state space is simply too large to cover completely. In such cases, we might not care about a diverse set of values or want to discard all intermediate values. To allow effective fuzzing in such cases, we provide a maximization primitive called IJON-MAX. It effectively turns the fuzzer into a generic hill climbing-based black box optimizer. To enable maximizing more than one value, multiple (by default 512) slots are provided to store those values. Like the coverage bitmap, each value is maximized independently. Using this primitive, it is also possible to easily build a minimization primitive for x, by maximizing \u2212x.</p> <ul> <li>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u4e3b\u8981\u5904\u7406\u63d0\u4f9b\u53cd\u9988\uff0c\u53ef\u4ee5\u7528\u6765\u589e\u52a0\u5b58\u50a8\u7684\u8f93\u5165\u7684\u591a\u6837\u6027\u3002\u7136\u800c\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u60f3\u8981\u4f18\u5316\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u6807\uff0c\u6216\u8005\u72b6\u6001\u7a7a\u95f4\u592a\u5927\uff0c\u65e0\u6cd5\u5b8c\u5168\u8986\u76d6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u4e0d\u5173\u5fc3\u591a\u6837\u5316\u7684\u503c\uff0c\u6216\u8005\u60f3\u8981\u4e22\u5f03\u6240\u6709\u4e2d\u95f4\u503c\u3002\u4e3a\u4e86\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5b9e\u73b0\u6709\u6548\u7684fuzzing\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u79f0\u4e3aIJON-MAX\u7684\u6700\u5927\u5316\u539f\u8bed\u3002\u5b83\u6709\u6548\u5730\u5c06fuzzer\u8f6c\u53d8\u4e3a\u4e00\u4e2a\u57fa\u4e8e\u9ed1\u76d2\u4f18\u5316\u5668\u7684\u901a\u7528\u722c\u5761\u7b97\u6cd5\u3002\u4e3a\u4e86\u4f7f\u591a\u4e2a\u503c\u6700\u5927\u5316\uff0c\u63d0\u4f9b\u4e86\u591a\u4e2a\uff08\u9ed8\u8ba4\u4e3a512\uff09\u63d2\u69fd\u6765\u5b58\u50a8\u8fd9\u4e9b\u503c\u3002\u50cf\u8986\u76d6\u4f4d\u56fe\u4e00\u6837\uff0c\u6bcf\u4e2a\u503c\u90fd\u662f\u72ec\u7acb\u6700\u5927\u5316\u7684\u3002\u4f7f\u7528\u8fd9\u4e2a\u539f\u8bed\uff0c\u8fd8\u53ef\u4ee5\u8f7b\u677e\u5730\u6784\u5efa\u4e00\u4e2ax\u7684\u6700\u5c0f\u5316\u539f\u8bed\uff0c\u901a\u8fc7\u6700\u5927\u5316-x\u3002</li> </ul> <p>Consider the video game Super Mario Bros., in which a player controls a character in a side-scrolling game. In each level, the objective is to reach the end of the level, while avoiding hazards such as enemies, traps, and pits. In case the character is touched by an enemy or falls into a pit, the game ends. To properly explore the state space of the game, it is important to reach the end of each level. As illustrated in Listing 9, we can finish the level by asking the fuzzer to try to maximize the player\u2019s x coordinate. Given that it is a side-scrolling game, this effectively guides the fuzzer to find a way through the level to successfully finish it</p> <ul> <li>\u8003\u8651\u89c6\u9891\u6e38\u620f\u8d85\u7ea7\u9a6c\u91cc\u5965\u5144\u5f1f\uff0c\u5176\u4e2d\u73a9\u5bb6\u63a7\u5236\u4e00\u4e2a\u89d2\u8272\u5728\u4e00\u4e2a\u6a2a\u5411\u6eda\u52a8\u7684\u6e38\u620f\u4e2d\u3002\u5728\u6bcf\u4e2a\u7ea7\u522b\u4e2d\uff0c\u76ee\u6807\u662f\u5230\u8fbe\u7ea7\u522b\u7684\u672b\u5c3e\uff0c\u540c\u65f6\u907f\u5f00\u654c\u4eba\u3001\u9677\u9631\u548c\u5751\u6d1e\u7b49\u5371\u9669\u3002\u5982\u679c\u89d2\u8272\u88ab\u654c\u4eba\u78b0\u5230\u6216\u6389\u8fdb\u5751\u91cc\uff0c\u6e38\u620f\u5c31\u4f1a\u7ed3\u675f\u3002\u4e3a\u4e86\u6b63\u786e\u63a2\u7d22\u6e38\u620f\u7684\u72b6\u6001\u7a7a\u95f4\uff0c\u91cd\u8981\u7684\u662f\u5230\u8fbe\u6bcf\u4e2a\u7ea7\u522b\u7684\u672b\u5c3e\u3002\u5982\u4ee3\u7801\u6240\u793a\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8981\u6c42fuzzer\u5c1d\u8bd5\u6700\u5927\u5316\u73a9\u5bb6\u7684x\u5750\u6807\u6765\u5b8c\u6210\u7ea7\u522b\u3002\u9274\u4e8e\u8fd9\u662f\u4e00\u4e2a\u6a2a\u5411\u6eda\u52a8\u7684\u6e38\u620f\uff0c\u8fd9\u5b9e\u9645\u4e0a\u5f15\u5bfcfuzzer\u627e\u5230\u4e00\u79cd\u901a\u8fc7\u7ea7\u522b\u7684\u65b9\u6cd5\uff0c\u6210\u529f\u5b8c\u6210\u5b83\u3002</li> </ul> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#ijon_1","title":"IJON \u7684\u5b9e\u73b0","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#ijon_2","title":"IJON \u7684\u8bc4\u4f30","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_2","title":"\u76f8\u5173\u5de5\u4f5c","text":"<p>After AFL was published about five years ago, its inner workings were analyzed in detail and multiple improvements were proposed. Different scheduling algorithms were proposed to improve fuzzing in various scenarios [10], [11], [13], [46], [56]. The second component of AFL is the input mutation strategy. Again, various improvements were proposed to increase the probability of generating interesting inputs by means of using more information on the target [6], [7], [9], [27], [40], [44] or taint tracking to limit the amount of input data that needs to be mutated [14], [45]. Lastly, AFL observes the programs behavior for each test case and receives feedback on its behavior. Different fully automated techniques were proposed that help improving the performance of this feedback generation [19], [50] or to extend the feedback [1], [29], [32]. To overcome various roadblocks, such as magic bytes, techniques based on concolic execution [20]\u2013[22], [26], [37], [53], [55], [60], [63] and\u2014less commonly\u2014on symbolic execution [16], [38] were proposed. Since fuzzing is very performance-critical, various aspects of it were optimized by other projects. For example, Xu et al. improved the performance of spawning subprocesses [58]. Various fuzzers used Intel-PT to increase the performance of coverage tracing on binary targets [5], [50]. Lastly, to make fuzzing more applicable it was adopted to targets ranging from firmware [16], [64] over hypervisors [28] and operating systems [4], [50], [54] to neural networks [42], [57]</p> <ul> <li>\u5728\u5927\u7ea6\u4e94\u5e74\u524d\u53d1\u5e03AFL\u4e4b\u540e\uff0c\u5176\u5185\u90e8\u5de5\u4f5c\u539f\u7406\u88ab\u8be6\u7ec6\u5206\u6790\uff0c\u5e76\u63d0\u51fa\u4e86\u591a\u79cd\u6539\u8fdb\u3002\u63d0\u51fa\u4e86\u4e0d\u540c\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c\u4ee5\u6539\u8fdb\u5404\u79cd\u573a\u666f\u4e0b\u7684fuzzing\u3002AFL\u7684\u7b2c\u4e8c\u4e2a\u7ec4\u4ef6\u662f\u8f93\u5165\u53d8\u5f02\u7b56\u7565\u3002\u540c\u6837\uff0c\u63d0\u51fa\u4e86\u5404\u79cd\u6539\u8fdb\uff0c\u901a\u8fc7\u4f7f\u7528\u66f4\u591a\u5173\u4e8e\u76ee\u6807\u7684\u4fe1\u606f\u6216\u6c61\u70b9\u8ddf\u8e2a\u6765\u9650\u5236\u9700\u8981\u53d8\u5f02\u7684\u8f93\u5165\u6570\u636e\u91cf\uff0c\u4ee5\u589e\u52a0\u751f\u6210\u6709\u8da3\u8f93\u5165\u7684\u6982\u7387\u3002\u6700\u540e\uff0cAFL\u89c2\u5bdf\u6bcf\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u7684\u7a0b\u5e8f\u884c\u4e3a\uff0c\u5e76\u63a5\u6536\u6709\u5173\u5176\u884c\u4e3a\u7684\u53cd\u9988\u3002\u63d0\u51fa\u4e86\u4e0d\u540c\u7684\u5b8c\u5168\u81ea\u52a8\u5316\u6280\u672f\uff0c\u6709\u52a9\u4e8e\u6539\u8fdb\u8fd9\u79cd\u53cd\u9988\u751f\u6210\u7684\u6027\u80fd\uff0c\u6216\u8005\u6269\u5c55\u53cd\u9988\u3002\u4e3a\u4e86\u514b\u670d\u5404\u79cd\u969c\u788d\uff0c\u4f8b\u5982\u9b54\u672f\u5b57\u8282\uff0c\u63d0\u51fa\u4e86\u57fa\u4e8e\u5171\u4eab\u6267\u884c\u548c\u7b26\u53f7\u6267\u884c\u7684\u6280\u672f\u3002\u7531\u4e8efuzzing\u975e\u5e38\u5173\u952e\uff0c\u5176\u4ed6\u9879\u76ee\u4f18\u5316\u4e86\u5b83\u7684\u5404\u4e2a\u65b9\u9762\u3002\u4f8b\u5982\uff0cXu\u7b49\u4eba\u6539\u8fdb\u4e86\u751f\u6210\u5b50\u8fdb\u7a0b\u7684\u6027\u80fd\u3002\u5404\u79cdfuzzer\u4f7f\u7528Intel-PT\u6765\u63d0\u9ad8\u4e8c\u8fdb\u5236\u76ee\u6807\u7684\u8986\u76d6\u8ddf\u8e2a\u6027\u80fd\u3002\u6700\u540e\uff0c\u4e3a\u4e86\u4f7ffuzzing\u66f4\u5177\u9002\u7528\u6027\uff0c\u5b83\u88ab\u5e94\u7528\u4e8e\u4ece\u56fa\u4ef6\u5230\u8d85\u7ea7\u7528\u6237\u5230\u64cd\u4f5c\u7cfb\u7edf\u5230\u795e\u7ecf\u7f51\u7edc\u7684\u5404\u79cd\u76ee\u6807\u3002</li> </ul> <p>Recently, human-in-the-loop fuzzing gained the attention of the research community. Current approaches commonly provide an interactive environment where the humans interactions are used as seeds by the fuzzer. In some scenarios this is very helpful, while in other common fuzzing scenarios, it is very hard to apply. For example, Shoshitaishvili et al. [52] introduced HACRS, a system that allows humans to interact with the target application via an emulated terminal. To help the human, HACRS analyzes the target and provides a list of strings that might be relevant to the application\u2019s behavior. If the target provides a text-based interface, a human is often able to figure out how to interact with the target application. However, HACRS does not work when the target application does not consume data in a format easily understood by humans, e.g., binary formats, or the program output does not contain helpful information on the expected input format. Consequently, the authors excluded any program containing binary characters in the provided example scenarios from their evaluation. Similarly, DYNODROID [36] traces a human\u2019s interaction with Android applications. In contrast to HACRS, this includes a more diverse set of input interfaces such as system events and swipe gestures. However, the fundamental principle remains the same. In contrast, our approach is based on annotating the code of the target application and does not require to understand the input format.</p> <ul> <li>\u6700\u8fd1\uff0c\u4eba\u673a\u534f\u540cfuzzing\u5f15\u8d77\u4e86\u7814\u7a76\u754c\u7684\u5173\u6ce8\u3002\u5f53\u524d\u7684\u65b9\u6cd5\u901a\u5e38\u63d0\u4f9b\u4e00\u4e2a\u4ea4\u4e92\u5f0f\u73af\u5883\uff0c\u5176\u4e2d\u4eba\u7c7b\u7684\u4ea4\u4e92\u88abfuzzer\u7528\u4f5c\u79cd\u5b50\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u8fd9\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\uff0c\u800c\u5728\u5176\u4ed6\u5e38\u89c1\u7684fuzzing\u573a\u666f\u4e2d\uff0c\u8fd9\u662f\u975e\u5e38\u96be\u4ee5\u5e94\u7528\u7684\u3002\u4f8b\u5982\uff0cShoshitaishvili\u7b49\u4eba\u5f15\u5165\u4e86HACRS\uff0c\u8fd9\u662f\u4e00\u4e2a\u5141\u8bb8\u4eba\u7c7b\u901a\u8fc7\u6a21\u62df\u7ec8\u7aef\u4e0e\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4ea4\u4e92\u7684\u7cfb\u7edf\u3002\u4e3a\u4e86\u5e2e\u52a9\u4eba\u7c7b\uff0cHACRS\u5206\u6790\u76ee\u6807\u5e76\u63d0\u4f9b\u53ef\u80fd\u4e0e\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u76f8\u5173\u7684\u5b57\u7b26\u4e32\u5217\u8868\u3002\u5982\u679c\u76ee\u6807\u63d0\u4f9b\u57fa\u4e8e\u6587\u672c\u7684\u63a5\u53e3\uff0c\u4eba\u7c7b\u901a\u5e38\u80fd\u591f\u5f04\u6e05\u695a\u5982\u4f55\u4e0e\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4ea4\u4e92\u3002\u7136\u800c\uff0c\u5f53\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4ee5\u4eba\u7c7b\u5bb9\u6613\u7406\u89e3\u7684\u683c\u5f0f\u6d88\u8017\u6570\u636e\u65f6\uff0c\u4f8b\u5982\uff0c\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u6216\u8005\u7a0b\u5e8f\u8f93\u51fa\u4e0d\u5305\u542b\u6709\u5173\u9884\u671f\u8f93\u5165\u683c\u5f0f\u7684\u6709\u7528\u4fe1\u606f\u65f6\uff0cHACRS\u65e0\u6cd5\u5de5\u4f5c\u3002\u56e0\u6b64\uff0c\u4f5c\u8005\u5728\u8bc4\u4f30\u4e2d\u6392\u9664\u4e86\u63d0\u4f9b\u793a\u4f8b\u573a\u666f\u4e2d\u5305\u542b\u4e8c\u8fdb\u5236\u5b57\u7b26\u7684\u4efb\u4f55\u7a0b\u5e8f\u3002\u7c7b\u4f3c\u5730\uff0cDYNODROID\u8ddf\u8e2a\u4eba\u7c7b\u4e0eAndroid\u5e94\u7528\u7a0b\u5e8f\u7684\u4ea4\u4e92\u3002\u4e0eHACRS\u76f8\u6bd4\uff0c\u8fd9\u5305\u62ec\u66f4\u591a\u6837\u5316\u7684\u8f93\u5165\u63a5\u53e3\uff0c\u5982\u7cfb\u7edf\u4e8b\u4ef6\u548c\u6ed1\u52a8\u624b\u52bf\u3002\u7136\u800c\uff0c\u57fa\u672c\u539f\u5219\u4fdd\u6301\u4e0d\u53d8\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u6211\u4eec\u7684\u65b9\u6cd5\u662f\u57fa\u4e8e\u5bf9\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u8fdb\u884c\u6ce8\u91ca\u7684\uff0c\u4e0d\u9700\u8981\u7406\u89e3\u8f93\u5165\u683c\u5f0f\u3002</li> </ul> <p>Our approach requires little understanding of software security or program analysis. Even complex games can typically be won by untrained users. On the other hand, when fuzzing binary file formats or network protocols, even an expert user will have a hard time to come up with novel inputs based on observing only the program output. IJON allows to guide the fuzzer\u2019s intrinsic ability to generate inputs to overcome fuzzing roadblocks and to explore a more diverse part of the state space. This approach requires no knowledge or understanding of the input format at all. In fact, we also typically had very limited understanding of the target application, as our annotations allow to provide guidance without deep understanding of the program context. For example, consider the bug shown in Listing 12. The annotation was added without any context or understanding of how kolyblk.XMLLength is calculated from the input. Still, IJON was able to trigger the integer overflow after a few minutes of analysis time.</p> <ul> <li>\u6211\u4eec\u7684\u65b9\u6cd5\u51e0\u4e4e\u4e0d\u9700\u8981\u5bf9\u8f6f\u4ef6\u5b89\u5168\u6216\u7a0b\u5e8f\u5206\u6790\u6709\u6240\u4e86\u89e3\u3002\u5373\u4f7f\u662f\u672a\u7ecf\u8bad\u7ec3\u7684\u7528\u6237\u901a\u5e38\u4e5f\u53ef\u4ee5\u8d62\u5f97\u590d\u6742\u7684\u6e38\u620f\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u5f53\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u683c\u5f0f\u6216\u7f51\u7edc\u534f\u8bae\u8fdb\u884cfuzzing\u65f6\uff0c\u5373\u4f7f\u662f\u4e13\u5bb6\u7528\u6237\u4e5f\u5f88\u96be\u6839\u636e\u4ec5\u89c2\u5bdf\u7a0b\u5e8f\u8f93\u51fa\u6765\u63d0\u51fa\u65b0\u7684\u8f93\u5165\u3002IJON\u5141\u8bb8\u5f15\u5bfcfuzzer\u751f\u6210\u8f93\u5165\u4ee5\u514b\u670dfuzzing\u969c\u788d\uff0c\u5e76\u63a2\u7d22\u72b6\u6001\u7a7a\u95f4\u7684\u66f4\u591a\u591a\u6837\u5316\u90e8\u5206\u3002\u8fd9\u79cd\u65b9\u6cd5\u6839\u672c\u4e0d\u9700\u8981\u5bf9\u8f93\u5165\u683c\u5f0f\u6709\u4efb\u4f55\u4e86\u89e3\u6216\u7406\u89e3\u3002\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u901a\u5e38\u5bf9\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u4e86\u89e3\u975e\u5e38\u6709\u9650\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u6ce8\u91ca\u5141\u8bb8\u5728\u6ca1\u6709\u5bf9\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u7684\u6df1\u5165\u4e86\u89e3\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u6307\u5bfc\u3002\u4f8b\u5982\uff0c\u8003\u8651\u4ee3\u7801\u4e2d\u663e\u793a\u7684\u9519\u8bef\u3002\u6ce8\u91ca\u662f\u5728\u6ca1\u6709\u4efb\u4f55\u4e0a\u4e0b\u6587\u6216\u5bf9kolyblk.XMLLength\u5982\u4f55\u4ece\u8f93\u5165\u8ba1\u7b97\u7684\u7406\u89e3\u7684\u60c5\u51b5\u4e0b\u6dfb\u52a0\u7684\u3002\u5c3d\u7ba1\u5982\u6b64\uff0cIJON\u80fd\u591f\u5728\u51e0\u5206\u949f\u7684\u5206\u6790\u65f6\u95f4\u540e\u89e6\u53d1\u6574\u6570\u6ea2\u51fa\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_3","title":"\u8ba8\u8bba\u4e0e\u672a\u6765\u5de5\u4f5c","text":"<p>In this paper we describe an interactive approach to fuzzing. While this offers new ways to steer the fuzzing process, it requires manual inspection of the test coverage, acquiring an understanding of why a constraint is hard to solve, and manually creating a well-suited annotation. This manual effort comes with a certain cost to the analyst, but our evaluation demonstrates that this approach can overcome several obstacles for current fuzzers. For example, it is clear that neither a grammar nor a dictionary will help a fuzzer to solve Super Mario levels. Additionally, it is not straightforward to find good seed inputs. While in such a case, a record and replay mechanism such as a version of HACRS or DYNODROID applicable to this target might be helpful, in many other cases such as binary formats, it would likely not. </p> <ul> <li>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u63cf\u8ff0\u4e86\u4e00\u79cd\u4ea4\u4e92\u5f0ffuzzing\u65b9\u6cd5\u3002\u867d\u7136\u8fd9\u63d0\u4f9b\u4e86\u5f15\u5bfcfuzzing\u8fc7\u7a0b\u7684\u65b0\u65b9\u6cd5\uff0c\u4f46\u5b83\u9700\u8981 \u624b\u52a8\u68c0\u67e5\u6d4b\u8bd5\u8986\u76d6\u7387 \uff0c\u4e86\u89e3\u4e3a\u4ec0\u4e48\u7ea6\u675f\u96be\u4ee5\u89e3\u51b3\uff0c\u5e76\u624b\u52a8\u521b\u5efa\u4e00\u4e2a\u5408\u9002\u7684\u6ce8\u91ca\u3002\u8fd9\u79cd\u624b\u52a8\u5de5\u4f5c\u5bf9\u5206\u6790\u5e08\u6765\u8bf4\u662f\u6709\u4e00\u5b9a\u6210\u672c\u7684\uff0c\u4f46\u6211\u4eec\u7684\u8bc4\u4f30\u8868\u660e\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53ef\u4ee5\u514b\u670d\u5f53\u524dfuzzer\u7684\u51e0\u4e2a\u969c\u788d\u3002\u4f8b\u5982\uff0c\u5f88\u660e\u663e\uff0c\u8bed\u6cd5\u548c\u5b57\u5178\u90fd\u65e0\u6cd5\u5e2e\u52a9fuzzer\u89e3\u51b3\u8d85\u7ea7\u9a6c\u91cc\u5965\u7684\u5173\u5361\u3002\u6b64\u5916\uff0c\u8981\u627e\u5230\u597d\u7684\u79cd\u5b50\u8f93\u5165\u4e5f\u4e0d\u662f\u4e00\u4ef6\u7b80\u5355\u7684\u4e8b\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8bb0\u5f55\u548c\u91cd\u653e\u673a\u5236\uff0c\u5982HACRS\u6216DYNODROID\u7684\u4e00\u4e2a\u7248\u672c\u9002\u7528\u4e8e\u8fd9\u4e2a\u76ee\u6807\uff0c\u53ef\u80fd\u4f1a\u6709\u6240\u5e2e\u52a9\uff0c\u4f46\u5728\u8bb8\u591a\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u4f8b\u5982\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u53ef\u80fd\u4e0d\u4f1a\u3002</li> </ul> <p>The annotations used in IJON are currently added manually. It would be interesting to design methods that automatically infer annotations only for difficult individual constraints. Some existing fuzzing approaches use a subset of the annotations described by us. For example, LAF-INTEL can be represented by annotating the number of equal bytes in a comparison. Similarly, ANGORA already implements call stack based virtual state for all coverage. However, all those tools use additional feedback indiscriminately. Therefore, they are limited to low information gain feedback mechanisms. Using more precise feedback in a similar manner would result in a much larger queue and decreased performance. Automated techniques to identify IJON annotations could make use of much more powerful annotations than LAF-INTEL and ANGORA, as they are applied sparsely. Finally, right now, the annotations require source access. In principle, there is no reason why similar annotations cannot be implemented for binary-only targets. Integrating IJON with a binary-only fuzzer would be interesting </p> <ul> <li>IJON\u4e2d\u4f7f\u7528\u7684\u6ce8\u91ca\u76ee\u524d\u662f\u624b\u52a8\u6dfb\u52a0\u7684\u3002\u8bbe\u8ba1\u65b9\u6cd5\u81ea\u52a8\u63a8\u65ad\u53ea\u9488\u5bf9\u56f0\u96be\u7684\u5355\u4e2a\u7ea6\u675f\u3002\u4e00\u4e9b\u73b0\u6709\u7684fuzzing\u65b9\u6cd5\u4f7f\u7528\u6211\u4eec\u63cf\u8ff0\u7684\u6ce8\u91ca\u7684\u5b50\u96c6\u3002\u4f8b\u5982\uff0cLAF-INTEL\u53ef\u4ee5\u901a\u8fc7\u6ce8\u91ca\u6bd4\u8f83\u4e2d\u76f8\u7b49\u5b57\u8282\u7684\u6570\u91cf\u6765\u8868\u793a\u3002\u7c7b\u4f3c\u5730\uff0cANGORA\u5df2\u7ecf\u4e3a\u6240\u6709\u8986\u76d6\u5b9e\u73b0\u4e86\u57fa\u4e8e\u8c03\u7528\u5806\u6808\u7684\u865a\u62df\u72b6\u6001\u3002\u7136\u800c\uff0c\u6240\u6709\u8fd9\u4e9b\u5de5\u5177\u90fd\u4e0d\u52a0\u533a\u522b\u5730\u4f7f\u7528\u989d\u5916\u7684\u53cd\u9988\u3002\u56e0\u6b64\uff0c\u5b83\u4eec\u53d7\u9650\u4e8e\u4f4e\u4fe1\u606f\u589e\u76ca\u53cd\u9988\u673a\u5236\u3002\u4ee5\u7c7b\u4f3c\u7684\u65b9\u5f0f\u4f7f\u7528\u66f4\u7cbe\u786e\u7684\u53cd\u9988\u5c06\u5bfc\u81f4\u4e00\u4e2a\u66f4\u5927\u7684\u961f\u5217\u548c\u6027\u80fd\u964d\u4f4e\u3002\u81ea\u52a8\u8bc6\u522bIJON\u6ce8\u91ca\u7684\u6280\u672f\u53ef\u4ee5\u5229\u7528\u6bd4LAF-INTEL\u548cANGORA\u66f4\u5f3a\u5927\u7684\u6ce8\u91ca\uff0c\u56e0\u4e3a\u5b83\u4eec\u5e94\u7528\u5f97\u5f88\u5c11\u3002\u6700\u540e\uff0c\u73b0\u5728\uff0c\u6ce8\u91ca\u9700\u8981\u6e90\u8bbf\u95ee\u3002\u539f\u5219\u4e0a\uff0c\u6ca1\u6709\u7406\u7531\u4e3a\u4ec5\u4e8c\u8fdb\u5236\u76ee\u6807\u5b9e\u73b0\u7c7b\u4f3c\u7684\u6ce8\u91ca\u3002\u5c06IJON\u4e0e\u4ec5\u4e8c\u8fdb\u5236fuzzer\u96c6\u6210\u5c06\u662f\u6709\u8da3\u7684\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_4","title":"\u7ed3\u8bba","text":"<p>In this paper, we have shown that a large number of hard problems for fuzzers can be solved by manually inspecting the code coverage during fuzzing and using only a few lines of annotations to guide the fuzzing process. Previously, practitioners in the industry often used to manually pick seed files that solve the coverage or to design custom mutators that solve constraints (for example, by providing dictionaries or grammars). Similarly, it is well documented that practitioners try to remove hard constraints such as checksum manually. We extended this toolkit with another manual but very flexible method: annotations that an analyst can use to guide the fuzzer. By using less than four lines of code, we demonstrated how a large set of problems could be solved that no other automated fuzzing approach is currently able to handle.</p> <ul> <li>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c55\u793a\u4e86fuzzer\u7684\u5927\u91cf\u96be\u9898\u53ef\u4ee5\u901a\u8fc7\u5728fuzzing\u8fc7\u7a0b\u4e2d\u624b\u52a8\u68c0\u67e5\u4ee3\u7801\u8986\u76d6\u7387\uff0c\u5e76\u4f7f\u7528\u51e0\u884c\u6ce8\u91ca\u6765\u5f15\u5bfcfuzzing\u8fc7\u7a0b\u6765\u89e3\u51b3\u3002\u4ee5\u524d\uff0c\u5de5\u4e1a\u754c\u7684\u4ece\u4e1a\u8005\u7ecf\u5e38\u624b\u52a8\u9009\u62e9\u89e3\u51b3\u8986\u76d6\u7387\u7684\u79cd\u5b50\u6587\u4ef6\uff0c\u6216\u8005\u8bbe\u8ba1\u81ea\u5b9a\u4e49\u53d8\u5f02\u5668\u6765\u89e3\u51b3\u7ea6\u675f\uff08\u4f8b\u5982\uff0c\u901a\u8fc7\u63d0\u4f9b\u5b57\u5178\u6216\u8bed\u6cd5\uff09\u3002\u540c\u6837\uff0c\u6709\u5145\u5206\u7684\u6587\u6863\u8bc1\u660e\uff0c\u4ece\u4e1a\u8005\u5c1d\u8bd5\u624b\u52a8\u5220\u9664\u786c\u7ea6\u675f\uff0c\u4f8b\u5982\u6821\u9a8c\u548c\u3002\u6211\u4eec\u6269\u5c55\u4e86\u8fd9\u4e2a\u5de5\u5177\u5305\uff0c\u589e\u52a0\u4e86\u53e6\u4e00\u79cd\u624b\u52a8\u4f46\u975e\u5e38\u7075\u6d3b\u7684\u65b9\u6cd5\uff1a\u5206\u6790\u5e08\u53ef\u4ee5\u4f7f\u7528\u6ce8\u91ca\u6765\u5f15\u5bfcfuzzer\u3002\u901a\u8fc7\u4f7f\u7528\u4e0d\u5230\u56db\u884c\u4ee3\u7801\uff0c\u6211\u4eec\u6f14\u793a\u4e86\u5982\u4f55\u89e3\u51b3\u4e00\u7cfb\u5217\u95ee\u9898\uff0c\u76ee\u524d\u6ca1\u6709\u5176\u4ed6\u81ea\u52a8fuzzing\u65b9\u6cd5\u80fd\u591f\u5904\u7406\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_5","title":"\u6982\u5ff5","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#concolic-execution","title":"Concolic Execution","text":"<p>Concolic testing (a portmanteau of concrete and symbolic, also known as dynamic symbolic execution) is a hybrid software verification technique that performs symbolic execution, a classical technique that treats program variables as symbolic variables, along a concrete execution (testing on particular inputs) path. Symbolic execution is used in conjunction with an automated theorem prover or constraint solver based on constraint logic programming to generate new concrete inputs (test cases) with the aim of maximizing code coverage. Its main focus is finding bugs in real-world software, rather than demonstrating program correctness.</p> <ul> <li>\u5171\u4eab\u6d4b\u8bd5\uff08concolic testing\uff09\u662f\u4e00\u79cd\u6df7\u5408\u8f6f\u4ef6\u9a8c\u8bc1\u6280\u672f\uff0c\u5b83\u6267\u884c\u7b26\u53f7\u6267\u884c\uff0c\u8fd9\u662f\u4e00\u79cd\u5c06\u7a0b\u5e8f\u53d8\u91cf\u89c6\u4e3a\u7b26\u53f7\u53d8\u91cf\u7684\u7ecf\u5178\u6280\u672f\uff0c\u6cbf\u7740\u5177\u4f53\u6267\u884c\uff08\u5728\u7279\u5b9a\u8f93\u5165\u4e0a\u8fdb\u884c\u6d4b\u8bd5\uff09\u8def\u5f84\u3002\u7b26\u53f7\u6267\u884c\u4e0e\u57fa\u4e8e\u7ea6\u675f\u903b\u8f91\u7f16\u7a0b\u7684\u81ea\u52a8\u5b9a\u7406\u8bc1\u660e\u5668\u6216\u7ea6\u675f\u6c42\u89e3\u5668\u7ed3\u5408\u4f7f\u7528\uff0c\u4ee5\u751f\u6210\u65b0\u7684\u5177\u4f53\u8f93\u5165\uff08\u6d4b\u8bd5\u7528\u4f8b\uff09\uff0c\u76ee\u7684\u662f\u6700\u5927\u5316\u4ee3\u7801\u8986\u76d6\u7387\u3002\u5b83\u7684\u4e3b\u8981\u91cd\u70b9\u662f\u5728\u73b0\u5b9e\u4e16\u754c\u7684\u8f6f\u4ef6\u4e2d\u67e5\u627e\u9519\u8bef\uff0c\u800c\u4e0d\u662f\u8bc1\u660e\u7a0b\u5e8f\u7684\u6b63\u786e\u6027\u6307\u5b9a\u7248\u672c</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#cgc-data-set","title":"CGC data set","text":"<p>Cancer Gene Census</p> <p>The Cancer Gene Census (CGC) is an ongoing effort to catalogue those genes which contain mutations that have been causally implicated in cancer and explain how dysfunction of these genes drives cancer. The content, the structure, and the curation process of the Cancer Gene Census was described and published in Nature Reviews Cancer.</p> <ul> <li>\u764c\u75c7\u57fa\u56e0\u666e\u67e5\uff08CGC\uff09\u662f\u4e00\u4e2a\u6301\u7eed\u7684\u52aa\u529b\uff0c\u65e8\u5728\u7f16\u76ee\u90a3\u4e9b\u5305\u542b\u5df2\u88ab\u8ba4\u4e3a\u4e0e\u764c\u75c7\u6709\u56e0\u679c\u5173\u7cfb\u7684\u7a81\u53d8\u7684\u57fa\u56e0\uff0c\u5e76\u89e3\u91ca\u8fd9\u4e9b\u57fa\u56e0\u7684\u529f\u80fd\u969c\u788d\u5982\u4f55\u9a71\u52a8\u764c\u75c7\u3002\u764c\u75c7\u57fa\u56e0\u666e\u67e5\u7684\u5185\u5bb9\u3001\u7ed3\u6784\u548c\u7b56\u5212\u8fc7\u7a0b\u5df2\u5728\u300a\u81ea\u7136\u8bc4\u8bba\u764c\u75c7\u300b\u4e2d\u63cf\u8ff0\u548c\u53d1\u8868\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#tpm-trusted-platform-module","title":"TPM (Trusted Platform Module)","text":"<p>Trusted Platform Module (Wikipedia)</p> <p>Trusted Platform Module (TPM) is an international standard for a secure cryptoprocessor, a dedicated microcontroller designed to secure hardware through integrated cryptographic keys. The term can also refer to a chip conforming to the standard ISO/IEC 11889. Common uses are to verify platform integrity (to verify that the boot process starts from a trusted combination of hardware and software), and to store disk encryption keys.</p> <ul> <li>\u53d7\u4fe1\u4efb\u5e73\u53f0\u6a21\u5757\uff08TPM\uff09\u662f\u4e00\u4e2a\u7528\u4e8e\u5b89\u5168\u52a0\u5bc6\u5904\u7406\u5668\u7684\u56fd\u9645\u6807\u51c6\uff0c\u662f\u4e00\u79cd\u4e13\u7528\u7684\u5fae\u63a7\u5236\u5668\uff0c\u65e8\u5728\u901a\u8fc7\u96c6\u6210\u7684\u52a0\u5bc6\u5bc6\u94a5\u4fdd\u62a4\u786c\u4ef6\u3002\u8be5\u672f\u8bed\u4e5f\u53ef\u4ee5\u6307\u7b26\u5408\u6807\u51c6ISO/IEC 11889\u7684\u82af\u7247\u3002\u5e38\u89c1\u7528\u9014\u662f\u9a8c\u8bc1\u5e73\u53f0\u5b8c\u6574\u6027\uff08\u9a8c\u8bc1\u5f15\u5bfc\u8fc7\u7a0b\u662f\u5426\u4ece\u53d7\u4fe1\u4efb\u7684\u786c\u4ef6\u548c\u8f6f\u4ef6\u7ec4\u5408\u5f00\u59cb\uff09\uff0c\u4ee5\u53ca\u5b58\u50a8\u78c1\u76d8\u52a0\u5bc6\u5bc6\u94a5\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#afl-based-fuzzers","title":"AFL-based fuzzers","text":"<p>AFL</p> <p>AFL is a coverage-guided, or feedback-based, fuzzer. More about these concepts can be found in a cool paper, Fuzzing: Art, Science, and Engineering. Let's wrap up general information about AFL:It modifies the executable file to find out how it influences coverage. Mutates input data to maximize coverage. Repeats the preceding step to find where the program crashes. It\u2019s highly effective, which is proven by practice. It\u2019s very easy to use.</p> <ul> <li>AFL\u662f\u4e00\u79cd\u8986\u76d6\u7387\u5f15\u5bfc\u6216\u53cd\u9988\u5f0ffuzzer\u3002\u5173\u4e8e\u8fd9\u4e9b\u6982\u5ff5\u7684\u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u5728\u4e00\u7bc7\u5f88\u9177\u7684\u8bba\u6587\u300aFuzzing: Art, Science, and Engineering\u300b\u4e2d\u627e\u5230\u3002\u8ba9\u6211\u4eec\u603b\u7ed3\u4e00\u4e0b\u5173\u4e8eAFL\u7684\u4e00\u822c\u4fe1\u606f\uff1a\u5b83\u4fee\u6539\u53ef\u6267\u884c\u6587\u4ef6\u4ee5\u627e\u51fa\u5b83\u5982\u4f55\u5f71\u54cd\u8986\u76d6\u7387\u3002\u53d8\u5f02\u8f93\u5165\u6570\u636e\u4ee5\u6700\u5927\u5316\u8986\u76d6\u7387\u3002\u91cd\u590d\u4e0a\u4e00\u6b65\u9aa4\u4ee5\u627e\u51fa\u7a0b\u5e8f\u5d29\u6e83\u7684\u4f4d\u7f6e\u3002\u5b83\u975e\u5e38\u6709\u6548\uff0c\u8fd9\u662f\u901a\u8fc7\u5b9e\u8df5\u8bc1\u660e\u7684\u3002\u5b83\u975e\u5e38\u5bb9\u6613\u4f7f\u7528\u3002</li> </ul> <p>This class of fuzzers typically uses code coverage to decide if an input reaches sufficiently different state than the ones existing in the corpus.</p> <ul> <li>\u8fd9\u7c7bfuzzer\u901a\u5e38\u4f7f\u7528\u4ee3\u7801\u8986\u76d6\u7387\u6765\u51b3\u5b9a\u8f93\u5165\u662f\u5426\u8fbe\u5230\u4e86\u4e0e\u8bed\u6599\u5e93\u4e2d\u73b0\u6709\u72b6\u6001\u8db3\u591f\u4e0d\u540c\u7684\u72b6\u6001\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#afl-coverage-feedback","title":"AFL Coverage Feedback","text":"<p>Various forks of AFL use instrumentation to obtain test coverage information. Typically, AFL-style fuzzers track how often individual edges in the control flow graph (CFG) are executed during each test input. There are two classes of feedback mechanisms commonly used: source code based forks of AFL typically use a custom compiler pass that annotates all edges with a custom piece of code. Binary-only versions of AFL use different mechanisms such as Dynamic Binary Instrumentation (DBI) or hardware accelerated tracing (typically Intel LBR or Intel PT) to obtain coverage information. Either way, the probes inserted into the target application then count the occurrences of each edge in the CFG and store them in a densely encoded representation.</p> <ul> <li>AFL\u7684\u5404\u79cd\u5206\u652f\u4f7f\u7528\u63d2\u6869\u6765\u83b7\u53d6\u6d4b\u8bd5\u8986\u76d6\u4fe1\u606f\u3002\u901a\u5e38\uff0cAFL\u98ce\u683c\u7684fuzzer\u8ddf\u8e2a\u63a7\u5236\u6d41\u56fe\uff08CFG\uff09\u4e2d\u7684\u5355\u4e2a\u8fb9\u5728\u6bcf\u4e2a\u6d4b\u8bd5\u8f93\u5165\u4e2d\u6267\u884c\u7684\u6b21\u6570\u3002\u901a\u5e38\u4f7f\u7528\u4e24\u7c7b\u5e38\u7528\u7684\u53cd\u9988\u673a\u5236\uff1a\u57fa\u4e8e\u6e90\u4ee3\u7801\u7684AFL\u5206\u652f\u901a\u5e38\u4f7f\u7528\u81ea\u5b9a\u4e49\u7f16\u8bd1\u5668\u63d2\u4ef6\uff0c\u8be5\u63d2\u4ef6\u4f7f\u7528\u81ea\u5b9a\u4e49\u4ee3\u7801\u7247\u6bb5\u6ce8\u91ca\u6240\u6709\u8fb9\u3002AFL\u7684\u4ec5\u4e8c\u8fdb\u5236\u7248\u672c\u4f7f\u7528\u4e0d\u540c\u7684\u673a\u5236\uff0c\u4f8b\u5982\u52a8\u6001\u4e8c\u8fdb\u5236\u4eea\u5668\uff08DBI\uff09\u6216\u786c\u4ef6\u52a0\u901f\u8ddf\u8e2a\uff08\u901a\u5e38\u662fIntel LBR\u6216Intel PT\uff09\u6765\u83b7\u53d6\u8986\u76d6\u4fe1\u606f\u3002\u65e0\u8bba\u54ea\u79cd\u65b9\u5f0f\uff0c\u63d2\u5165\u5230\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u63a2\u9488\u90fd\u4f1a\u8ba1\u7b97CFG\u4e2d\u6bcf\u4e2a\u8fb9\u7684\u53d1\u751f\u6b21\u6570\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728\u5bc6\u96c6\u7f16\u7801\u7684\u8868\u793a\u4e2d\u3002</li> </ul> <p>The resulting information is stored in a shared map that accumulates all edge counts during each test run. The fuzzer additionally maintains a global bitmap that contains all edge coverage encountered during the whole fuzzing campaign. The global bitmap is used to quickly check if a test input has triggered new coverage. AFL considers a test input interesting and stores it if it contains a previously unseen number of iterations on any edge. Since edges always connect two basic blocks, edges are encoded as a tuple consisting of two identifiers, one for the source basic block \\(id_s\\) and one for a target block \\(id_t\\). In the source code based versions, a static random value is assigned at compile-time to each basic block, which is used as \\(id_s\\) or \\(id_t\\). For binary-only implementations, it is common to use a cheap hash function applied to the address of the jump instruction/target instruction to derive the \\(id_s\\) and \\(id_t\\) values, respectively. This tuple (\\(id_s\\), \\(id_t\\)) is then used to index a byte in the shared map. Typically, the index is calculated as $ (id_s \\times 2) \\oplus id_t $. The multiplication is used to efficiently distinguish self-loops.</p> <ul> <li>\u7ed3\u679c\u4fe1\u606f\u5b58\u50a8\u5728\u4e00\u4e2a\u5171\u4eab\u56fe\u4e2d\uff0c\u8be5\u56fe\u5728\u6bcf\u6b21\u6d4b\u8bd5\u8fd0\u884c\u671f\u95f4\u7d2f\u79ef\u6240\u6709\u8fb9\u7684\u8ba1\u6570\u3002fuzzer\u8fd8\u7ef4\u62a4\u4e00\u4e2a\u5168\u5c40\u4f4d\u56fe\uff0c\u5176\u4e2d\u5305\u542b\u6574\u4e2afuzzing\u6d3b\u52a8\u671f\u95f4\u9047\u5230\u7684\u6240\u6709\u8fb9\u8986\u76d6\u3002\u5168\u5c40\u4f4d\u56fe\u7528\u4e8e\u5feb\u901f\u68c0\u67e5\u6d4b\u8bd5\u8f93\u5165\u662f\u5426\u89e6\u53d1\u4e86\u65b0\u7684\u8986\u76d6\u3002\u5982\u679c\u6d4b\u8bd5\u8f93\u5165\u5305\u542b\u4efb\u4f55\u8fb9\u4e0a\u4ee5\u524d\u672a\u89c1\u7684\u8fed\u4ee3\u6b21\u6570\uff0c\u5219AFL\u8ba4\u4e3a\u6d4b\u8bd5\u8f93\u5165\u6709\u8da3\u5e76\u5c06\u5176\u5b58\u50a8\u3002\u7531\u4e8e\u8fb9\u59cb\u7ec8\u8fde\u63a5\u4e24\u4e2a\u57fa\u672c\u5757\uff0c\u56e0\u6b64\u8fb9\u88ab\u7f16\u7801\u4e3a\u4e00\u4e2a\u7531\u4e24\u4e2a\u6807\u8bc6\u7b26\u7ec4\u6210\u7684\u5143\u7ec4\uff0c\u4e00\u4e2a\u7528\u4e8e\u6e90\u57fa\u672c\u5757\\(id_s\\)\uff0c\u4e00\u4e2a\u7528\u4e8e\u76ee\u6807\u5757\\(id_t\\)\u3002\u5728\u57fa\u4e8e\u6e90\u4ee3\u7801\u7684\u7248\u672c\u4e2d\uff0c\u6bcf\u4e2a\u57fa\u672c\u5757\u5728\u7f16\u8bd1\u65f6\u88ab\u5206\u914d\u4e00\u4e2a\u9759\u6001\u968f\u673a\u503c\uff0c\u8be5\u503c\u7528\u4f5c\\(id_s\\)\u6216\\(id_t\\)\u3002\u5bf9\u4e8e\u4ec5\u4e8c\u8fdb\u5236\u5b9e\u73b0\uff0c\u901a\u5e38\u4f7f\u7528\u5e94\u7528\u4e8e\u8df3\u8f6c\u6307\u4ee4/\u76ee\u6807\u6307\u4ee4\u5730\u5740\u7684\u4fbf\u5b9c\u54c8\u5e0c\u51fd\u6570\u6765\u5206\u522b\u63a8\u5bfc\\(id_s\\)\u548c\\(id_t\\)\u503c\u3002\u7136\u540e\uff0c\u8fd9\u4e2a\u5143\u7ec4\uff08\\(id_s\\)\uff0c\\(id_t\\)\uff09\u7528\u4e8e\u7d22\u5f15\u5171\u4eab\u56fe\uff08\u6620\u5c04\uff1f\uff09\u4e2d\u7684\u4e00\u4e2a\u5b57\u8282\u3002\u901a\u5e38\uff0c\u7d22\u5f15\u8ba1\u7b97\u4e3a$ (id_s \\times 2) \\oplus id_t $\u3002\u4e58\u6cd5\u7528\u4e8e\u6709\u6548\u533a\u5206\u81ea\u73af\u3002</li> </ul> <p>Before each new test run, the shared map is cleared. During the test run, each time an edge is encountered, the corresponding byte in the shared map is incremented. This implies that edge counts greater than 255 will overflow and might register as any number between 0 and 255. After the execution finished, the edge counts are bucketed such that each byte in the shared map with a non-zero edge count contains a power of 2. To this end, edge counts are discretized into the following ranges 1, 2, 3, 4 . . . 7, 8 . . . 15, 16 . . . 31, 32 . . . 127, 128 . . . 255. Each range of edge counts is assigned to one specific power of 2. To increase the precision on uncommon edges, 3 also maps to a unique power of 2, while the range 32 to 64 is omitted. Then we can compare the shared map against a global bitmap, which contains all bits that were previously observed in prior runs. If any new bit is set, the test input is stored because it has led to increased coverage, and the global bitmap is updated to contain the new coverage.</p> <ul> <li>\u5728\u6bcf\u6b21\u65b0\u7684\u6d4b\u8bd5\u8fd0\u884c\u4e4b\u524d\uff0c\u5171\u4eab\u56fe\u88ab\u6e05\u9664\u3002\u5728\u6d4b\u8bd5\u8fd0\u884c\u671f\u95f4\uff0c\u6bcf\u6b21\u9047\u5230\u4e00\u4e2a\u8fb9\uff0c\u5171\u4eab\u56fe\u4e2d\u7684\u76f8\u5e94\u5b57\u8282\u5c31\u4f1a\u589e\u52a0\u3002\u8fd9\u610f\u5473\u7740\u8fb9\u8ba1\u6570\u5927\u4e8e255\u5c06\u6ea2\u51fa\uff0c\u5e76\u53ef\u80fd\u6ce8\u518c\u4e3a0\u5230255\u4e4b\u95f4\u7684\u4efb\u4f55\u6570\u5b57\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u8fb9\u8ba1\u6570\u88ab\u5206\u6876\uff0c\u4ee5\u4fbf\u5171\u4eab\u56fe\u4e2d\u5177\u6709\u975e\u96f6\u8fb9\u8ba1\u6570\u7684\u6bcf\u4e2a\u5b57\u8282\u90fd\u5305\u542b2\u7684\u5e42\u3002\u4e3a\u6b64\uff0c\u8fb9\u8ba1\u6570\u88ab\u79bb\u6563\u5316\u4e3a\u4ee5\u4e0b\u8303\u56f41\u30012\u30013\u30014...7\u30018...15\u300116...31\u300132...127\u3001128...255\u3002\u6bcf\u4e2a\u8fb9\u8ba1\u6570\u8303\u56f4\u90fd\u5206\u914d\u7ed9\u4e00\u4e2a\u7279\u5b9a\u76842\u7684\u5e42\u3002\u4e3a\u4e86\u589e\u52a0\u5bf9\u4e0d\u5e38\u89c1\u8fb9\u7684\u7cbe\u5ea6\uff0c3\u4e5f\u6620\u5c04\u5230\u4e00\u4e2a\u552f\u4e00\u76842\u7684\u5e42\uff0c\u800c32\u523064\u7684\u8303\u56f4\u88ab\u7701\u7565\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5171\u4eab\u56fe\u4e0e\u5168\u5c40\u4f4d\u56fe\u8fdb\u884c\u6bd4\u8f83\uff0c\u5168\u5c40\u4f4d\u56fe\u5305\u542b\u4ee5\u524d\u8fd0\u884c\u4e2d\u89c2\u5bdf\u5230\u7684\u6240\u6709\u4f4d\u3002\u5982\u679c\u8bbe\u7f6e\u4e86\u4efb\u4f55\u65b0\u4f4d\uff0c\u6d4b\u8bd5\u8f93\u5165\u5c06\u88ab\u5b58\u50a8\uff0c\u56e0\u4e3a\u5b83\u5bfc\u81f4\u4e86\u8986\u76d6\u7387\u7684\u589e\u52a0\uff0c\u5e76\u4e14\u5168\u5c40\u4f4d\u56fe\u88ab\u66f4\u65b0\u4ee5\u5305\u542b\u65b0\u7684\u8986\u76d6\u7387\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#extending-feedback-beyond-coverage","title":"Extending Feedback Beyond Coverage","text":"<p>Fuzzers sometimes get stuck in a part of the search space, where no reasonable, probable mutation provides any new feedback.</p> <ul> <li>fuzzer\u6709\u65f6\u4f1a\u5361\u5728\u641c\u7d22\u7a7a\u95f4\u7684\u67d0\u4e2a\u90e8\u5206\uff0c\u6ca1\u6709\u5408\u7406\u7684\u3001\u53ef\u80fd\u7684\u53d8\u5f02\u63d0\u4f9b\u4efb\u4f55\u65b0\u7684\u53cd\u9988\u3002</li> </ul> <p>Notably, LAF-INTEL was an early approach to solve magic byte type constraints (e.g., if (input == 0xdeadbeef)) by splitting large compare instructions into multiple smaller ones.</p> <ul> <li>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0cLAF-INTEL\u662f\u4e00\u79cd\u65e9\u671f\u7684\u65b9\u6cd5\uff0c\u7528\u4e8e\u89e3\u51b3\u9b54\u672f\u5b57\u8282\u7c7b\u578b\u7ea6\u675f\uff08\u4f8b\u5982\uff0c<code>if (input == 0xdeadbeef)</code>\uff09\uff0c\u901a\u8fc7\u5c06\u5927\u7684\u6bd4\u8f83\u6307\u4ee4\u5206\u6210\u591a\u4e2a\u8f83\u5c0f\u7684\u6307\u4ee4\u3002</li> </ul> <p>The same idea was later implemented by using dynamic binary instrumentation in a tool called STEELIX. Splitting multi-byte compare instructions into multiple single byte instructions allows the fuzzer to find new coverage every time a single byte of the operands is matching. ANGORA assigns a random identifier to each function. It uses these identifiers to extend the coverage tuple by a third field that contains a hash of the current execution context. To compute this hash, it combines all identifiers of functions that have been called but have not yet returned (i.e., active functions) using an XOR operation. This allows finding the \u201csame\u201d coverage if it was used in a different calling context. For example, this method is helpful to solve multiple calls to the strcmp function. However, the downside of this approach (i.e., considering all calling contexts as unique) is that in certain situations, this creates a large number of inputs that are actually not interesting. Therefore, ANGORA requires a larger bitmap than AFL.</p> <ul> <li>\u540e\u6765\uff0c\u4f7f\u7528\u52a8\u6001\u4e8c\u8fdb\u5236\u63d2\u6869\u5728\u4e00\u4e2a\u540d\u4e3aSTEELIX\u7684\u5de5\u5177\u4e2d\u5b9e\u73b0\u4e86\u76f8\u540c\u7684\u60f3\u6cd5\u3002\u5c06\u591a\u5b57\u8282\u6bd4\u8f83\u6307\u4ee4\u5206\u6210\u591a\u4e2a\u5355\u5b57\u8282\u6307\u4ee4\uff0c\u4f7ffuzzer\u6bcf\u6b21\u64cd\u4f5c\u6570\u7684\u5355\u5b57\u8282\u5339\u914d\u65f6\u90fd\u80fd\u627e\u5230\u65b0\u7684\u8986\u76d6\u3002ANGORA\u4e3a\u6bcf\u4e2a\u51fd\u6570\u5206\u914d\u4e00\u4e2a\u968f\u673a\u6807\u8bc6\u7b26\u3002\u5b83\u4f7f\u7528\u8fd9\u4e9b\u6807\u8bc6\u7b26\u5c06\u8986\u76d6\u5143\u7ec4\u6269\u5c55\u4e3a\u5305\u542b\u5f53\u524d\u6267\u884c\u4e0a\u4e0b\u6587\u7684\u54c8\u5e0c\u7684\u7b2c\u4e09\u4e2a\u5b57\u6bb5\u3002\u4e3a\u4e86\u8ba1\u7b97\u8fd9\u4e2a\u54c8\u5e0c\uff0c\u5b83\u4f7f\u7528XOR\u64cd\u4f5c\u7ed3\u5408\u6240\u6709\u5df2\u8c03\u7528\u4f46\u5c1a\u672a\u8fd4\u56de\u7684\u51fd\u6570\u7684\u6807\u8bc6\u7b26\uff08\u5373\u6d3b\u52a8\u51fd\u6570\uff09\u3002\u8fd9\u5141\u8bb8\u5728\u4e0d\u540c\u7684\u8c03\u7528\u4e0a\u4e0b\u6587\u4e2d\u4f7f\u7528\u76f8\u540c\u7684\u8986\u76d6\u3002\u4f8b\u5982\uff0c\u8fd9\u79cd\u65b9\u6cd5\u6709\u52a9\u4e8e\u89e3\u51b3\u5bf9strcmp\u51fd\u6570\u7684\u591a\u6b21\u8c03\u7528\u3002\u7136\u800c\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7684\u7f3a\u70b9\uff08\u5373\u5c06\u6240\u6709\u8c03\u7528\u4e0a\u4e0b\u6587\u89c6\u4e3a\u552f\u4e00\uff09\u662f\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4f1a\u521b\u5efa\u5927\u91cf\u5b9e\u9645\u4e0a\u4e0d\u611f\u5174\u8da3\u7684\u8f93\u5165\u3002\u56e0\u6b64\uff0cANGORA\u9700\u8981\u6bd4AFL\u66f4\u5927\u7684\u4f4d\u56fe\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#bucketed","title":"Bucketed","text":"<p>\u5206\u6876\uff08Bucketing\uff09\u662f\u4e00\u79cd\u6570\u636e\u5904\u7406\u548c\u5b58\u50a8\u6280\u672f\uff0c\u901a\u5e38\u7528\u4e8e\u5c06\u6570\u636e\u5206\u6210\u591a\u4e2a\u7ec4\u6216\u201c\u6876\u201d\u3002\u6bcf\u4e2a\u6876\u5305\u542b\u4e00\u90e8\u5206\u6570\u636e\uff0c\u4fbf\u4e8e\u7ba1\u7406\u548c\u5206\u6790\u3002\u5206\u6876\u7684\u4e3b\u8981\u76ee\u7684\u5305\u62ec\uff1a</p> <ul> <li>\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff1a\u901a\u8fc7\u5c06\u6570\u636e\u5206\u6563\u5230\u4e0d\u540c\u7684\u6876\u4e2d\uff0c\u53ef\u4ee5\u51cf\u5c11\u6bcf\u6b21\u67e5\u8be2\u9700\u8981\u626b\u63cf\u7684\u6570\u636e\u91cf\u3002</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1a\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u5206\u6876\u53ef\u4ee5\u5e2e\u52a9\u5747\u5300\u5206\u914d\u6570\u636e\u5230\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u907f\u514d\u67d0\u4e9b\u8282\u70b9\u8fc7\u8f7d\u3002</li> <li>\u7b80\u5316\u6570\u636e\u7ba1\u7406\uff1a\u5c06\u6570\u636e\u5206\u6210\u5c0f\u5757\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u8fdb\u884c\u66f4\u65b0\u3001\u5220\u9664\u548c\u7ef4\u62a4\u3002</li> </ul> <p>\u5206\u6876\u5e38\u7528\u4e8e\u6570\u636e\u5e93\u3001\u6570\u636e\u4ed3\u5e93\u548c\u5927\u6570\u636e\u5904\u7406\u6846\u67b6\u4e2d\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#bitmap-data-structure","title":"Bitmap data structure","text":"<p>\u4f4d\u56fe\u6570\u636e\u7ed3\u6784</p> <p>\u4f4d\u56fe\uff08Bitmap\uff09\u662f\u4e00\u79cd\u975e\u5e38\u9ad8\u6548\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4e3b\u8981\u7528\u4e8e\u5904\u7406\u5927\u91cf\u6570\u636e\u7684\u5feb\u901f\u67e5\u627e\u3001\u53bb\u91cd\u7b49\u64cd\u4f5c\u3002\u5b83\u5229\u7528\u6bcf\u4e00\u4f4d\uff08bit\uff09\u6765\u8868\u793a\u67d0\u4e2a\u5143\u7d20\u662f\u5426\u5b58\u5728\u6216\u67d0\u79cd\u72b6\u6001\uff0c\u4ece\u800c\u6781\u5927\u5730\u8282\u7701\u4e86\u5b58\u50a8\u7a7a\u95f4\u3002\u5728\u5185\u5b58\u548c\u5b58\u50a8\u7a7a\u95f4\u76f8\u5bf9\u53d7\u9650\u7684\u73af\u5883\u4e0b\uff0c\u4f4d\u56fe\u5c24\u5176\u6709\u7528\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#state","title":"State","text":"<p>state denotes one configuration of memory and registers, as well as the state provided by the OS (e.g., file descriptors and similar primitives).</p> <ul> <li>\u72b6\u6001\u8868\u793a\u5185\u5b58\u548c\u5bc4\u5b58\u5668\u7684\u4e00\u4e2a\u914d\u7f6e\uff0c\u4ee5\u53ca\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u72b6\u6001\uff08\u4f8b\u5982\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b26\u548c\u7c7b\u4f3c\u7684\u539f\u8bed\uff09\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#state-space","title":"State Space","text":"<p>The state space is the set of all possible states a program can be in.</p> <ul> <li>\u72b6\u6001\u7a7a\u95f4\u662f\u7a0b\u5e8f\u53ef\u80fd\u5904\u4e8e\u7684\u6240\u6709\u53ef\u80fd\u72b6\u6001\u7684\u96c6\u5408\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#branch-free-aes-implementations","title":"Branch-free AES Implementations","text":"<p>For example, the coverage tells very little about the behavior of a branch-free AES implementation.</p> <ul> <li>\u4f8b\u5982\uff0c\u8986\u76d6\u51e0\u4e4e\u4e0d\u63d0\u4f9b\u5173\u4e8e\u65e0\u5206\u652fAES\u5b9e\u73b0\u884c\u4e3a\u7684\u4fe1\u606f\u3002</li> </ul> <p>\"Branch-free AES implementation\"\u662f\u6307\u4e00\u79cd\u907f\u514d\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528\u6761\u4ef6\u5206\u652f\uff08\u4f8b\u5982<code>if</code>\u8bed\u53e5\uff09\u7684\u9ad8\u7ea7\u52a0\u5bc6\u6807\u51c6\uff08AES\uff09\u7b97\u6cd5\u7684\u5b9e\u73b0\u3002\u8fd9\u79cd\u65b9\u6cd5\u901a\u5e38\u7528\u4e8e\u63d0\u9ad8\u6027\u80fd\u548c\u5b89\u5168\u6027\uff0c\u7279\u522b\u662f\u5728\u5bc6\u7801\u5b66\u5e94\u7528\u4e2d\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_6","title":"\u4e3b\u8981\u7279\u70b9","text":"<ul> <li> <p>\u6027\u80fd\uff1a\u901a\u8fc7\u6d88\u9664\u5206\u652f\uff0c\u5b9e\u73b0\u53ef\u4ee5\u5728\u73b0\u4ee3\u5904\u7406\u5668\u4e0a\u5b9e\u73b0\u66f4\u597d\u7684\u6027\u80fd\uff0c\u56e0\u4e3a\u5b83\u51cf\u5c11\u4e86\u7ba1\u9053\u505c\u6ede\u7684\u98ce\u9669\u5e76\u63d0\u9ad8\u4e86\u6307\u4ee4\u7ea7\u5e76\u884c\u6027\u3002</p> </li> <li> <p>\u5b89\u5168\u6027\uff1a\u65e0\u5206\u652f\u5b9e\u73b0\u53ef\u4ee5\u7f13\u89e3\u67d0\u4e9b\u4fa7\u4fe1\u9053\u653b\u51fb\uff0c\u4f8b\u5982\u5229\u7528\u7531\u6761\u4ef6\u5206\u652f\u5f15\u8d77\u7684\u6267\u884c\u65f6\u95f4\u53d8\u5316\u7684\u5b9a\u65f6\u653b\u51fb\u3002</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_7","title":"\u5b9e\u73b0\u6280\u672f","text":"<ul> <li> <p>\u67e5\u627e\u8868\uff1a\u4f7f\u7528\u9884\u8ba1\u7b97\u7684\u8868\u6765\u66ff\u6362\u6761\u4ef6\u903b\u8f91\u3002\u4f8b\u5982\uff0c\u5b9e\u73b0\u53ef\u4ee5\u4f7f\u7528\u67e5\u627e\u8868\u76f4\u63a5\u8bbf\u95ee\u6240\u9700\u7684\u503c\uff0c\u800c\u4e0d\u662f\u68c0\u67e5\u6761\u4ef6\u4ee5\u786e\u5b9a\u8981\u6267\u884c\u54ea\u79cd\u64cd\u4f5c\u3002</p> </li> <li> <p>\u4f4d\u64cd\u4f5c\uff1a\u5229\u7528\u4f4d\u64cd\u4f5c\u8fdb\u884c\u5fc5\u8981\u7684\u8ba1\u7b97\uff0c\u800c\u65e0\u9700\u5206\u652f\u3002</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#angora","title":"ANGORA","text":"<p>Angora is a mutation-based coverage guided fuzzer. The main goal of Angora is to increase branch coverage by solving path constraints without symbolic execution.</p> <ul> <li>Angora\u662f\u4e00\u79cd\u57fa\u4e8e\u53d8\u5f02\u7684\u8986\u76d6\u5f15\u5bfcfuzzer\u3002Angora\u7684\u4e3b\u8981\u76ee\u6807\u662f\u901a\u8fc7\u89e3\u51b3\u8def\u5f84\u7ea6\u675f\u800c\u4e0d\u4f7f\u7528\u7b26\u53f7\u6267\u884c\u6765\u589e\u52a0\u5206\u652f\u8986\u76d6\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/17/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BBijon-exploring-deep-state-spaces-via-fuzzing-%E6%9B%B4%E6%96%B0%E4%B8%AD/#_8","title":"\u6709\u8da3\u7684\u8bdd","text":"<p>Computers are incredibly fast, accurate and stupid; humans are incredibly slow, inaccurate and brilliant; together they are powerful beyond imagination</p> <ul> <li>\u8ba1\u7b97\u673a\u975e\u5e38\u5feb\u901f\u3001\u51c6\u786e\u548c\u611a\u8822\uff1b\u4eba\u7c7b\u975e\u5e38\u7f13\u6162\u3001\u4e0d\u51c6\u786e\u548c\u806a\u660e\uff1b\u5728\u4e00\u8d77\uff0c\u4ed6\u4eec\u7684\u529b\u91cf\u8d85\u4e4e\u60f3\u8c61\u3002</li> </ul> <p>Since even for trivially small programs, the state space is larger than the number of atoms in the universe, the fuzzer has to optimize the diversity of states reached by the test cases.</p> <ul> <li>\u7531\u4e8e\u5373\u4f7f\u5bf9\u4e8e\u5fae\u4e0d\u8db3\u9053\u7684\u5c0f\u7a0b\u5e8f\uff0c\u72b6\u6001\u7a7a\u95f4\u4e5f\u6bd4\u5b87\u5b99\u4e2d\u7684\u539f\u5b50\u6570\u91cf\u8fd8\u8981\u5927\uff0c\u56e0\u6b64fuzzer\u5fc5\u987b\u4f18\u5316\u6d4b\u8bd5\u7528\u4f8b\u8fbe\u5230\u7684\u72b6\u6001\u7684\u591a\u6837\u6027\u3002</li> </ul> <p>Glitches: Super Mario Bros. contains various wellknown glitches and secret passages, commonly exploited by speed-runners. Our fuzzer was able to find and exploit at least two of those. </p> <ul> <li>\u6bdb\u523a\uff1a\u8d85\u7ea7\u9a6c\u91cc\u5965\u5144\u5f1f\u5305\u542b\u5404\u79cd\u4f17\u6240\u5468\u77e5\u7684\u6bdb\u523a\u548c\u79d8\u5bc6\u901a\u9053\uff0c\u901a\u5e38\u88ab\u901f\u901a\u73a9\u5bb6\u5229\u7528\u3002\u6211\u4eec\u7684fuzzer\u80fd\u591f\u627e\u5230\u5e76\u5229\u7528\u5176\u4e2d\u81f3\u5c11\u4e24\u4e2a\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/","title":"\u8bb0\u7b2c\u4e8c\u6b21\u8bba\u6587\u7814\u8ba8","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#ijon-exploring-deep-state-spaces-via-fuzzing","title":"IJON: Exploring Deep State Spaces via Fuzzing","text":"<p>IJON: Exploring Deep State Sapces via Fuzzing</p> <p>IJON SPACE EXPLORER Github</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_2","title":"\u80cc\u666f\u4e0e\u6311\u6218","text":"<ul> <li> <p>\u4f20\u7edf\u7684fuzzing\u6280\u672f\u5728\u63a2\u7d22 \u6df1\u5c42\u72b6\u6001\u7a7a\u95f4 \u65f6\u6548\u679c\u4e0d\u4f73</p> </li> <li> <p>\u73b0\u6709\u7684fuzzing\u65b9\u6cd5\u5bf9 \u4eba\u7c7b\u5e72\u9884 \u7684\u652f\u6301\u6709\u9650</p> </li> <li> <p>\u5927\u591a\u6570\u73b0\u6709\u65b9\u6cd5\u4ec5\u9650\u4e8e\u6dfb\u52a0 \u5b57\u5178\u6216\u65b0\u79cd\u5b50 \u8f93\u5165\u6765\u5f15\u5bfcfuzzer\u3002\u5904\u7406\u590d\u6742\u7a0b\u5e8f\u65f6\u8fd9\u4e9b\u673a\u5236\u65e0\u6cd5\u53d1\u73b0\u4ee3\u7801\u5e93\u7684\u65b0\u90e8\u5206\u3002\u7b26\u53f7\u6267\u884c\u6216\u5171\u4eab\u6267\u884c\u7b49\u7a0b\u5e8f\u5206\u6790\u6280\u672f\u4e5f\u65e0\u6cd5\u8f7b\u677e\u514b\u670d\u4e00\u4e9b\u7ea6\u675f\u3002 </p> </li> <li> <p>\u72b6\u6001\u7206\u70b8 \u5bf9\u5f53\u524d\u6280\u672f\u6784\u6210\u4e86\u592a\u5927\u7684\u969c\u788d\u2014\u2014\u65e0\u8bba\u662f\u57fa\u4e8efuzzing\u8fd8\u662f\u57fa\u4e8e\u7b26\u53f7\u6267\u884c\u7684\u65b9\u6cd5\u3002\u8fd9\u662f\u56e0\u4e3a\u5e95\u5c42\u95ee\u9898\uff08\u67e5\u627e\u9519\u8bef\uff09\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u4e0d\u53ef\u5224\u5b9a\u7684\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u4e0d\u80fd\u671f\u671b \u4efb\u4f55\u5355\u4e2a\u7b97\u6cd5 \u5728\u6240\u6709\u6d4b\u8bd5\u7684\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e0a\u8868\u73b0\u975e\u5e38\u597d\u3002</p> </li> <li> <p>\u5982\u679c\u6240\u6709\u5355\u72ec\u7684\u66f4\u65b0\u90fd\u5df2\u7ecf\u88ab\u89c2\u5bdf\u5230\uff0c\u90a3\u4e48\u6ca1\u6709\u53cd\u9988\u4f1a\u5956\u52b1\u63a2\u7d22 \u5bfc\u81f4\u65b0\u72b6\u6001\u7684\u4e0d\u540c\u66f4\u65b0 \u7684\u7ec4\u5408\u3002\u5728 \u9700\u8981\u7279\u5b9a\u7684\u66f4\u65b0\u5e8f\u5217 \u6765\u53d1\u73b0\u9519\u8bef\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u5c06\u963b\u6b62fuzzer\u53d6\u5f97\u8fdb\u5c55\u3002</p> </li> <li> <p>\u66f4\u65b0\u7684\u786e\u5207\u987a\u5e8f\uff08\u56e0\u6b64\u9009\u62e9\u7684\u786e\u5207\u4ee3\u7801\u8def\u5f84\uff09\u5bf9\u4e8e\u53d1\u73b0\u9519\u8bef\u81f3\u5173\u91cd\u8981\u3002\u7531\u4e8e\u5171\u4eab\u6267\u884c\u56fa\u5b9a\u4e86\u8def\u5f84\u5230\u89c2\u5bdf\u5230\u7684\u6267\u884c\u8def\u5f84\uff0c\u6c42\u89e3\u5668\u65e0\u6cd5\u83b7\u5f97\u89e6\u53d1\u76ee\u6807\u6761\u4ef6\u7684\u8f93\u5165\u3002\u6700\u540e\uff0c\u5373\u4f7f\u662f\u5b8c\u5168\u7b26\u53f7\u6267\u884c\uff0c\u5982\u679c\u72b6\u6001\u7a7a\u95f4\u53d8\u5f97\u592a\u5927\uff0c\u4e5f\u4f1a\u5931\u8d25\u3002</p> </li> <li> <p>\u66f4\u590d\u6742\u7684\u89e3\u51b3\u65b9\u6848\u4ec5\u652f\u6301\u57fa\u4e8e\u7b26\u53f7\u6267\u884c\u7684\u6700\u5c0f\u73af\u5883/\u6307\u4ee4\u96c6\uff0c\u6709\u65f6\u5728\u590d\u6742\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684 \u6269\u5c55\u6027 \u8f83\u5dee\u3002</p> </li> <li> <p>\u5f88\u96be\u627e\u5230 \u4efb\u4f55\u7ed9\u5b9a\u8f93\u5165\u7684\u72b6\u6001\u7a7a\u95f4\u6709\u591a\u201c\u6709\u8da3\u201d\u7684\u51c6\u786e\u548c\u5ba2\u89c2\u7684\u5ea6\u91cf\u6807\u51c6 \u3002</p> </li> <li> <p>\u6709\u4e9b\u4ee3\u7801\u7ed3\u6784\u4e0d\u63a2\u7d22\u72b6\u6001\u7a7a\u95f4\u4e2d\u7684 \u4e2d\u95f4\u70b9 \u5f88\u96be\u8fbe\u5230\u65b0\u7684\u8986\u76d6\u3002</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#ijon","title":"IJON\u7684\u60f3\u6cd5\u4e0e\u8bbe\u8ba1","text":"<ul> <li> <p>\u76f8\u8f83\u4e8e\u524d\u9762\u63d0\u5230\u7684\u6dfb\u52a0\u5b57\u5178\u6216\u65b0\u79cd\u5b50\uff0c\u5176\u57fa\u4e8e \u7a0b\u5e8f\u5185\u90e8\u72b6\u6001\u7684\u6570\u636e \uff0c\u5141\u8bb8\u66f4\u7cfb\u7edf\u5730\u63a2\u7d22\u7a0b\u5e8f\u7684\u884c\u4e3a</p> </li> <li> <p>\u901a\u8fc7\u5728\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u6e90\u4ee3\u7801\u4e2d\u6dfb\u52a0 \u6307\u5bfc\u63d0\u793a \uff0c\u6269\u5c55\u4e86\u5404\u79cd\u57fa\u4e8eAFL\u7684fuzzer\u7684\u529f\u80fd</p> </li> <li> <p>\u5bf9\u4e8e\u7a0b\u5e8f\u76ee\u6807\u6709\u9ad8\u7ea7\u7406\u89e3\u7684\u4eba\uff0c\u901a\u5e38\u77e5\u9053\u54ea\u4e9b\u503c\u662f\u76f8\u5173\u7684\uff0c\u54ea\u4e9b\u503c\u662f\u4e0d\u76f8\u5173\u7684\u3002\u4eba\u7c7b\u5206\u6790\u5e08\u53ef\u4ee5\u6ce8\u91ca\u5e94\u8be5\u66f4\u5f7b\u5e95\u5730\u63a2\u7d22\u7684\u72b6\u6001\u7a7a\u95f4\u7684\u90e8\u5206\uff0c\u4ece\u800c\u4fee\u6539fuzzer\u53ef\u4ee5\u4f7f\u7528\u7684\u53cd\u9988\u51fd\u6570\u3002</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#fuzzing","title":"Fuzzing \u4ece\u4e1a\u8005\u7684\u5c01\u95ed\u53cd\u9988\u5faa\u73af","text":"<p>\u8fd0\u884cfuzzer\u4e00\u6bb5\u65f6\u95f4\uff0c\u5206\u6790\u751f\u6210\u7684\u4ee3\u7801\u8986\u76d6\u7387\u3002\u4eba\u5de5\u8c03\u6574\u548c\u9002\u5e94fuzzing\u8fc7\u7a0b\u4ee5\u589e\u52a0\u8986\u76d6\u7387 \u3002\u6539\u8fdbfuzzing\u6027\u80fd\u7684\u5e38\u89c1\u7b56\u7565\u5305\u62ec: </p> <ul> <li>\u4ece\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e2d \u5220\u9664\u5177\u6709\u6311\u6218\u6027\u7684\u65b9\u9762\uff08\u4f8b\u5982\uff0c\u6821\u9a8c\u548c\uff09</li> <li>\u66f4\u6539\u53d8\u5f02\u7b56\u7565</li> <li>\u660e\u786e\u6dfb\u52a0 \u89e3\u51b3fuzzer\u672a\u4ee5\u81ea\u52a8\u65b9\u5f0f\u751f\u6210\u7684 \u67d0\u4e9b\u7ea6\u675f\u7684\u8f93\u5165\u6837\u672c\u3002</li> </ul> <p>\u8fd9\u79cd\u65b9\u6cd5\u6709\u4e24\u4e2a\u4e3b\u8981\u539f\u56e0\uff1a</p> <ul> <li>\u5728fuzzing\u6d3b\u52a8\u671f\u95f4\uff0c\u6240\u6709\u201c\u5bb9\u6613\u201d\u53d1\u73b0\u7684\u9519\u8bef\uff08\u5373\uff0c\u53ef\u4ee5\u5b8c\u5168\u81ea\u52a8\u53d1\u73b0\u7684\u9519\u8bef\uff09\u90fd\u4f1a\u5f88\u5feb\u88ab\u53d1\u73b0\u3002</li> <li>\u66f4\u6709\u8da3\u7684\u9519\u8bef\u2014\u2014\u6839\u636e\u5b9a\u4e49\u2014\u2014\u662f\u90a3\u4e9b\u4e0d\u80fd\u4f7f\u7528\u5f53\u524d\u5de5\u5177\u5728\u73b0\u6210\u914d\u7f6e\u4e2d\u627e\u5230\u7684\u9519\u8bef\uff0c\u56e0\u6b64\uff0c\u9700\u8981\u4e00\u4e9b\u624b\u52a8\u8c03\u6574\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_3","title":"\u5982\u4f55\u66f4\u6df1\u5165\u7684\u63a2\u7d22\u72b6\u6001\u7a7a\u95f4","text":"<ul> <li> <p>\u5df2\u77e5\u76f8\u5173\u72b6\u6001\u503c\uff1a\u6709\u65f6\u4ee3\u7801\u8986\u76d6\u4e0d\u63d0\u4f9b\u4efb\u4f55\u53cd\u9988\u6765\u5e2e\u52a9fuzzer\u524d\u8fdb\u3002\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5c0f\u7684\u72b6\u6001\u5b50\u96c6\u662f\u6709\u8da3\u7684\uff0c\u5e76\u4e14\u4eba\u7c7b\u5206\u6790\u5e08\u80fd\u591f\u8bc6\u522b\u8fd9\u4e9b\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b83\u4eec\u6765\u6307\u5bfcfuzzer\u3002(\u8ff7\u5bab\u7684\u5206\u652f\u8986\u76d6\u5e76\u4e0d\u662f\u4e00\u4e2a\u597d\u7684\u6307\u6807)</p> </li> <li> <p>\u5df2\u77e5\u72b6\u6001\u53d8\u5316\uff1a\u6709\u65f6\u7a0b\u5e8f\u592a\u590d\u6742\uff0c\u6216\u8005\u54ea\u4e9b\u53d8\u91cf\u5305\u542b\u6709\u8da3\u7684\u72b6\u6001\u4e0d\u660e\u663e\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7531\u4e8e\u6211\u4eec\u4e0d\u77e5\u9053\u8db3\u591f\u5c0f\u7684\u76f8\u5173\u72b6\u6001\u503c\u96c6\uff0c\u6211\u4eec\u65e0\u6cd5\u76f4\u63a5\u4f7f\u7528\u5b83\u4eec\u6765\u6307\u5bfcfuzzer\u3002\u76f8\u53cd\uff0c\u4eba\u7c7b\u5206\u6790\u5e08\u53ef\u80fd\u80fd\u591f\u8bc6\u522b\u4ee3\u7801\u4e2d\u7684\u4f4d\u7f6e\uff0c\u6000\u7591\u4f1a\u6539\u53d8\u72b6\u6001\u3002\u5206\u6790\u5e08\u53ef\u4ee5\u4f7f\u7528\u8fd9\u79cd\u72b6\u6001\u53d8\u5316\u7684\u5386\u53f2\u4f5c\u4e3a\u66f4\u590d\u6742\u72b6\u6001\u7684\u62bd\u8c61\uff0c\u5e76\u6307\u5bfcfuzzer\u3002(\u72b6\u6001\u673a\u4e2d\u4e0d\u540c\u72b6\u6001\u96be\u533a\u5206\uff0c\u96be\u4ee5\u63a2\u7d22\u72b6\u6001\u53d8\u5316\u7684\u7ec4\u5408)</p> </li> <li> <p>\u7f3a\u5931\u4e2d\u95f4\u72b6\u6001\uff1a\u4e0e\u524d\u4e24\u79cd\u60c5\u51b5\u4e0d\u540c\uff0c\u65e2\u6ca1\u6709\u5305\u542b\u72b6\u6001\u7684\u53d8\u91cf\uff0c\u4e5f\u6ca1\u6709\u6211\u4eec\u5173\u5fc3\u7684\u6539\u53d8\u72b6\u6001\u7684\u4ee3\u7801\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5206\u6790\u5e08\u53ef\u4ee5\u521b\u5efa\u4eba\u5de5\u4e2d\u95f4\u72b6\u6001\u6765\u6307\u5bfcfuzzer\u3002(\u54c8\u5e0c\u5339\u914d\u3001\u9b54\u672f\u5b57\u8282\u7b49)</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_4","title":"\u53cd\u9988\u673a\u5236","text":"<ul> <li> <p>\u56db\u4e2a\u901a\u7528\u539f\u8bed\uff0c\u53ef\u4ee5\u7528\u4e8e\u6ce8\u91ca\u6e90\u4ee3\u7801\uff1a</p> <ul> <li>\u5141\u8bb8\u5206\u6790\u5e08\u9009\u62e9\u54ea\u4e9b\u4ee3\u7801\u533a\u57df\u4e0e\u89e3\u51b3\u624b\u5934\u95ee\u9898\u76f8\u5173\u3002</li> <li>\u5141\u8bb8\u76f4\u63a5\u8bbf\u95eeAFL\u4f4d\u56fe\u4ee5\u5b58\u50a8\u9644\u52a0\u503c\u3002\u4f4d\u56fe\u6761\u76ee\u53ef\u4ee5\u76f4\u63a5\u8bbe\u7f6e\u6216\u9012\u589e\uff0c\u4ece\u800c\u4f7f\u72b6\u6001\u503c\u66b4\u9732\u7ed9\u53cd\u9988\u51fd\u6570\u3002</li> <li>\u4f7f\u5206\u6790\u5e08\u80fd\u591f\u5f71\u54cd\u8986\u76d6\u7387\u8ba1\u7b97\u3002\u8fd9\u5141\u8bb8\u76f8\u540c\u7684\u8fb9\u8986\u76d6\u4ea7\u751f\u4e0d\u540c\u7684\u4f4d\u56fe\u8986\u76d6\u3002\u8fd9\u5141\u8bb8\u5728\u4e0d\u540c\u72b6\u6001\u4e0b\u521b\u5efa\u66f4\u7ec6\u7c92\u5ea6\u7684\u53cd\u9988\u3002</li> <li>\u5f15\u5165\u4e86\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u6dfb\u52a0\u722c\u5761\u4f18\u5316\u7684\u539f\u8bed\u3002\u8fd9\u6837\uff0c\u5982\u679c\u53ef\u80fd\u72b6\u6001\u7a7a\u95f4\u592a\u5927\u800c\u65e0\u6cd5\u8be6\u5c3d\u63a2\u7d22\uff0c\u7528\u6237\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u5de5\u4f5c\u76ee\u6807\u3002</li> </ul> </li> <li> <p>\u5177\u4f53\u5b9e\u73b0\uff1a</p> <ul> <li>IJON-Enable</li> <li>IJON-INC and IJON-SET</li> <li>IJON-STATE</li> </ul> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_5","title":"\u95ee\u9898","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#1","title":"\u95ee\u98981","text":"<p>Before each new test run, the shared map is cleared. During the test run, each time an edge is encountered, the corresponding byte in the shared map is incremented. This implies that edge counts greater than 255 will overflow and might register as any number between 0 and 255. After the execution finished, the edge counts are bucketed such that each byte in the shared map with a non-zero edge count contains a power of 2. To this end, edge counts are discretized into the following ranges 1, 2, 3, 4 . . . 7, 8 . . . 15, 16 . . . 31, 32 . . . 127, 128 . . . 255. Each range of edge counts is assigned to one specific power of 2. To increase the precision on uncommon edges, 3 also maps to a unique power of 2, while the range 32 to 64 is omitted. Then we can compare the shared map against a global bitmap, which contains all bits that were previously observed in prior runs. If any new bit is set, the test input is stored because it has led to increased coverage, and the global bitmap is updated to contain the new coverage.</p> <ul> <li>\u5728\u6bcf\u6b21\u65b0\u7684\u6d4b\u8bd5\u8fd0\u884c\u4e4b\u524d\uff0c\u5171\u4eab\u56fe\u88ab\u6e05\u9664\u3002\u5728\u6d4b\u8bd5\u8fd0\u884c\u671f\u95f4\uff0c\u6bcf\u6b21\u9047\u5230\u4e00\u4e2a\u8fb9\uff0c\u5171\u4eab\u56fe\u4e2d\u7684\u76f8\u5e94\u5b57\u8282\u5c31\u4f1a\u589e\u52a0\u3002\u8fd9\u610f\u5473\u7740\u8fb9\u8ba1\u6570\u5927\u4e8e255\u5c06\u6ea2\u51fa\uff0c\u5e76\u53ef\u80fd\u6ce8\u518c\u4e3a0\u5230255\u4e4b\u95f4\u7684\u4efb\u4f55\u6570\u5b57\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u8fb9\u8ba1\u6570\u88ab\u5206\u6876\uff0c\u4ee5\u4fbf\u5171\u4eab\u56fe\u4e2d\u5177\u6709\u975e\u96f6\u8fb9\u8ba1\u6570\u7684\u6bcf\u4e2a\u5b57\u8282\u90fd\u5305\u542b2\u7684\u5e42\u3002\u4e3a\u6b64\uff0c\u8fb9\u8ba1\u6570\u88ab\u79bb\u6563\u5316\u4e3a\u4ee5\u4e0b\u8303\u56f41\u30012\u30013\u30014...7\u30018...15\u300116...31\u300132...127\u3001128...255\u3002\u6bcf\u4e2a\u8fb9\u8ba1\u6570\u8303\u56f4\u90fd\u5206\u914d\u7ed9\u4e00\u4e2a\u7279\u5b9a\u76842\u7684\u5e42\u3002\u4e3a\u4e86\u589e\u52a0\u5bf9\u4e0d\u5e38\u89c1\u8fb9\u7684\u7cbe\u5ea6\uff0c3\u4e5f\u6620\u5c04\u5230\u4e00\u4e2a\u552f\u4e00\u76842\u7684\u5e42\uff0c\u800c32\u523064\u7684\u8303\u56f4\u88ab\u7701\u7565\u3002\u7136\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5171\u4eab\u56fe\u4e0e\u5168\u5c40\u4f4d\u56fe\u8fdb\u884c\u6bd4\u8f83\uff0c\u5168\u5c40\u4f4d\u56fe\u5305\u542b\u4ee5\u524d\u8fd0\u884c\u4e2d\u89c2\u5bdf\u5230\u7684\u6240\u6709\u4f4d\u3002\u5982\u679c\u8bbe\u7f6e\u4e86\u4efb\u4f55\u65b0\u4f4d\uff0c\u6d4b\u8bd5\u8f93\u5165\u5c06\u88ab\u5b58\u50a8\uff0c\u56e0\u4e3a\u5b83\u5bfc\u81f4\u4e86\u8986\u76d6\u7387\u7684\u589e\u52a0\uff0c\u5e76\u4e14\u5168\u5c40\u4f4d\u56fe\u88ab\u66f4\u65b0\u4ee5\u5305\u542b\u65b0\u7684\u8986\u76d6\u7387\u3002</li> </ul> <p>\u95ee\u9898 \uff1a\u8fd9\u91ccAFL\u7edf\u8ba1\u7684\u9891\u7387\u6709\u4ec0\u4e48\u7528\uff1fAFL\u4e3a\u4ec0\u4e48\u9700\u8981\u8fd9\u4e2a\u9891\u7387\uff1f\u7528\u6765\u505a\u4ec0\u4e48\uff1f</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#2","title":"\u95ee\u98982","text":"<p>As another example, consider Listing 7. After each successfully parsed and handled message, we append the command index, which represents the type of the message, to the state change log. Then we set a single bit, addressed by the hash of the state change log. As a consequence, whenever we see a new combination of up to four successfully handled messages, the fuzzer considers the input as interesting, providing a much better coverage in the state space of the application.</p> <ul> <li>\u4f8b\u5982\uff0c\u8003\u8651\u4ee3\u7801\u3002\u5728\u6bcf\u6b21\u6210\u529f\u89e3\u6790\u548c\u5904\u7406\u6d88\u606f\u540e\uff0c\u6211\u4eec\u5c06\u547d\u4ee4\u7d22\u5f15\uff08\u8868\u793a\u6d88\u606f\u7c7b\u578b\uff09\u9644\u52a0\u5230\u72b6\u6001\u66f4\u6539\u65e5\u5fd7\u4e2d\u3002\u7136\u540e\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u4f4d\uff0c\u7531\u72b6\u6001\u66f4\u6539\u65e5\u5fd7\u7684\u54c8\u5e0c\u5730\u5740\u3002\u56e0\u6b64\uff0c\u6bcf\u5f53\u6211\u4eec\u770b\u5230\u6700\u591a\u56db\u4e2a\u6210\u529f\u5904\u7406\u7684\u6d88\u606f\u7684\u65b0\u7ec4\u5408\u65f6\uff0cfuzzer\u5c06\u8ba4\u4e3a\u8f93\u5165\u662f\u6709\u8da3\u7684\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u72b6\u6001\u7a7a\u95f4\u4e2d\u63d0\u4f9b\u66f4\u597d\u7684\u8986\u76d6\u3002</li> </ul> <p>\u95ee\u9898\uff1a\u8fd9\u91cc\u4ece\u54ea\u91cc\u53ef\u4ee5\u770b\u51fa\u662f\u6700\u591a\u56db\u4e2a\u6210\u529f\u5904\u7406\u7684\u6d88\u606f\u7684\u65b0\u7ec4\u5408\u5c31\u4f1a\u8ba4\u4e3a\u6709\u8da3\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#3","title":"\u95ee\u98983","text":"<p>\u95ee\u9898\uff1a\uff08\u6e90\u81ea\u524d\u4e24\u5929\u548c\u540c\u5b66\u7684\u8ba8\u8bba\uff09\u5f53\u65f6\u6211\u8eab\u8fb9\u540c\u5b66\u8ba4\u4e3a\u53ef\u4ee5\u9010\u4e2a\u51fd\u6570\u8fdb\u884cfuzzing\uff0c\u4ece\u800c\u66f4\u7cbe\u786e\u7684\u5b9a\u4f4dBUG\u4f4d\u7f6e\uff0c\u81ea\u5e95\u5411\u4e0a\u7684\u5bf9\u4e00\u4e2a\u7cfb\u7edf\u8fdb\u884cfuzzing\u3002\u4f46\u662f\u6211\u5f53\u65f6\u611f\u89c9\u8fd9\u6837\u884c\u4e0d\u901a\uff0c\u56e0\u4e3a\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u7684\u5b58\u5728\uff0c\u8d8a\u662f\u9876\u5c42\u7684\u51fd\u6570\u6d89\u53ca\u7684\u72b6\u6001\u7a7a\u95f4\u8d8a\u5927\uff0c\u5176\u7ec4\u5408\u53ef\u80fd\u8d8a\u591a\u3002\u53ef\u80fd\u4e5f\u662f\u6211\u76ee\u524d\u4e86\u89e3\u6bd4\u8f83\u5c11\uff0c\u60f3\u4e86\u89e3\u4e00\u4e0b\u76ee\u524d\u9886\u57df\u5185\u5bf9\u4e00\u4e2a\u7a0b\u5e8f\u7684Fuzzing\u8fc7\u7a0b\u662f\u5982\u4f55\u8fdb\u884c\u7684\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_6","title":"\u76f8\u5173\u5de5\u4f5c","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#afl","title":"AFL","text":"<ul> <li>AFL\u53d1\u5e03\u540e\u63d0\u51fa\u4e86\u4e0d\u540c\u7684\u8c03\u5ea6\u7b97\u6cd5\uff0c\u4ee5\u6539\u8fdb\u5404\u79cd\u573a\u666f\u4e0b\u7684fuzzing\u3002</li> <li>AFL\u7684\u7b2c\u4e8c\u4e2a\u7ec4\u4ef6\u662f\u8f93\u5165\u53d8\u5f02\u7b56\u7565\uff0c\u5bf9\u6b64\u4e5f\u63d0\u51fa\u4e86\u5404\u79cd\u6539\u8fdb\u3002\u901a\u8fc7\u4f7f\u7528\u66f4\u591a\u5173\u4e8e\u76ee\u6807\u7684\u4fe1\u606f\u6216\u6c61\u70b9\u8ddf\u8e2a\u6765\u9650\u5236\u9700\u8981\u53d8\u5f02\u7684\u8f93\u5165\u6570\u636e\u91cf\uff0c\u4ee5\u589e\u52a0\u751f\u6210\u6709\u8da3\u8f93\u5165\u7684\u6982\u7387\u3002</li> <li>AFL\u89c2\u5bdf\u6bcf\u4e2a\u6d4b\u8bd5\u7528\u4f8b\u7684\u7a0b\u5e8f\u884c\u4e3a\uff0c\u5e76\u63a5\u6536\u6709\u5173\u5176\u884c\u4e3a\u7684\u53cd\u9988\u3002\u63d0\u51fa\u4e86\u4e0d\u540c\u7684\u5b8c\u5168\u81ea\u52a8\u5316\u6280\u672f\uff0c\u6709\u52a9\u4e8e\u6539\u8fdb\u8fd9\u79cd\u53cd\u9988\u751f\u6210\u7684\u6027\u80fd\uff0c\u6216\u8005\u6269\u5c55\u53cd\u9988\u3002</li> <li>\u4e3a\u4e86\u514b\u670d\u5404\u79cd\u969c\u788d\uff0c\u4f8b\u5982\u9b54\u672f\u5b57\u8282\uff0c\u63d0\u51fa\u4e86\u57fa\u4e8e\u5171\u4eab\u6267\u884c\u548c\u7b26\u53f7\u6267\u884c\u7684\u6280\u672f\u3002</li> <li>\u7531\u4e8efuzzing\u975e\u5e38\u5173\u952e\uff0c\u5176\u4ed6\u9879\u76ee\u4f18\u5316\u4e86\u5b83\u7684\u5404\u4e2a\u65b9\u9762\u3002</li> <li>\u5404\u79cdfuzzer\u4f7f\u7528Intel-PT\u6765\u63d0\u9ad8\u4e8c\u8fdb\u5236\u76ee\u6807\u7684\u8986\u76d6\u8ddf\u8e2a\u6027\u80fd\u3002</li> <li>\u4e3a\u4e86\u4f7ffuzzing\u66f4\u5177\u9002\u7528\u6027\uff0c\u5b83\u88ab\u5e94\u7528\u4e8e\u4ece\u56fa\u4ef6\u5230\u8d85\u7ea7\u7528\u6237\u5230\u64cd\u4f5c\u7cfb\u7edf\u5230\u795e\u7ecf\u7f51\u7edc\u7684\u5404\u79cd\u76ee\u6807\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#fuzzing_1","title":"\u4eba\u673a\u534f\u540c fuzzing","text":"<ul> <li>\u4eba\u673a\u534f\u540cfuzzing \u901a\u5e38\u63d0\u4f9b\u4e00\u4e2a\u4ea4\u4e92\u5f0f\u73af\u5883\uff0c\u5176\u4e2d\u4eba\u7c7b\u7684\u4ea4\u4e92\u88abfuzzer\u7528\u4f5c\u79cd\u5b50\u3002</li> <li>Shoshitaishvili\u7b49\u4eba\u5f15\u5165\u4e86HACRS\uff0c\u8fd9\u662f\u4e00\u4e2a\u5141\u8bb8\u4eba\u7c7b\u901a\u8fc7\u6a21\u62df\u7ec8\u7aef\u4e0e\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4ea4\u4e92\u7684\u7cfb\u7edf\u3002HACRS\u5206\u6790\u76ee\u6807\u5e76\u63d0\u4f9b\u53ef\u80fd\u4e0e\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u76f8\u5173\u7684\u5b57\u7b26\u4e32\u5217\u8868\uff0c\u4ee5\u5e2e\u52a9\u4eba\u7c7b\u3002\u5f53\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4ee5\u4eba\u7c7b\u5bb9\u6613\u7406\u89e3\u7684\u683c\u5f0f\u6d88\u8017\u6570\u636e\u65f6\uff0c\u4f8b\u5982\uff0c\u4e8c\u8fdb\u5236\u683c\u5f0f\uff0c\u6216\u8005\u7a0b\u5e8f\u8f93\u51fa\u4e0d\u5305\u542b\u6709\u5173\u9884\u671f\u8f93\u5165\u683c\u5f0f\u7684\u6709\u7528\u4fe1\u606f\u65f6\uff0cHACRS\u65e0\u6cd5\u5de5\u4f5c\u3002\u4f5c\u8005\u5728\u8bc4\u4f30\u4e2d\u6392\u9664\u4e86\u63d0\u4f9b\u793a\u4f8b\u573a\u666f\u4e2d\u5305\u542b\u4e8c\u8fdb\u5236\u5b57\u7b26\u7684\u4efb\u4f55\u7a0b\u5e8f\u3002</li> <li>DYNODROID\u8ddf\u8e2a\u4eba\u7c7b\u4e0eAndroid\u5e94\u7528\u7a0b\u5e8f\u7684\u4ea4\u4e92\uff0c\u8fd9\u5305\u62ec\u66f4\u591a\u6837\u5316\u7684\u8f93\u5165\u63a5\u53e3\uff0c\u5982\u7cfb\u7edf\u4e8b\u4ef6\u548c\u6ed1\u52a8\u624b\u52bf\u3002</li> <li>\u4e0eHACRS\u548cDYNODROID\u76f8\u6bd4\uff0cIJON\u7684\u65b9\u6cd5\u662f\u57fa\u4e8e\u5bf9\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u8fdb\u884c\u6ce8\u91ca\u7684\uff0c\u4e0d\u9700\u8981\u7406\u89e3\u8f93\u5165\u683c\u5f0f\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#ijon_1","title":"IJON","text":"<ul> <li>IJON\u51e0\u4e4e\u4e0d\u9700\u8981\u5bf9\u8f6f\u4ef6\u5b89\u5168\u6216\u7a0b\u5e8f\u5206\u6790\u6709\u6240\u4e86\u89e3\uff0c\u5373\u4f7f\u662f\u672a\u7ecf\u8bad\u7ec3\u7684\u7528\u6237\u901a\u5e38\u4e5f\u53ef\u4ee5\u8d62\u5f97\u590d\u6742\u7684\u6e38\u620f\u3002\u5f53\u5bf9\u4e8c\u8fdb\u5236\u6587\u4ef6\u683c\u5f0f\u6216\u7f51\u7edc\u534f\u8bae\u8fdb\u884cfuzzing\u65f6\uff0c\u5373\u4f7f\u662f\u4e13\u5bb6\u7528\u6237\u4e5f\u5f88\u96be\u6839\u636e\u4ec5\u89c2\u5bdf\u7a0b\u5e8f\u8f93\u51fa\u6765\u63d0\u51fa\u65b0\u7684\u8f93\u5165\u3002</li> <li>IJON\u5141\u8bb8\u5f15\u5bfcfuzzer\u751f\u6210\u8f93\u5165\u4ee5\u514b\u670dfuzzing\u969c\u788d\uff0c\u5e76\u63a2\u7d22\u72b6\u6001\u7a7a\u95f4\u7684\u66f4\u591a\u591a\u6837\u5316\u90e8\u5206\u3002\u8fd9\u79cd\u65b9\u6cd5\u6839\u672c\u4e0d\u9700\u8981\u5bf9\u8f93\u5165\u683c\u5f0f\u6709\u4efb\u4f55\u4e86\u89e3\u6216\u7406\u89e3\u3002\u4f5c\u8005\u901a\u5e38\u5bf9\u76ee\u6807\u5e94\u7528\u7a0b\u5e8f\u7684\u4e86\u89e3\u975e\u5e38\u6709\u9650\uff0c\u56e0\u4e3a\u4ed6\u4eec\u7684\u6ce8\u91ca\u5141\u8bb8\u5728\u6ca1\u6709\u5bf9\u7a0b\u5e8f\u4e0a\u4e0b\u6587\u7684\u6df1\u5165\u4e86\u89e3\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u6307\u5bfc\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_7","title":"\u8ba8\u8bba\u4e0e\u672a\u6765\u5de5\u4f5c","text":"<ul> <li> <p>IJON\u63d0\u4f9b\u4e86\u5f15\u5bfcfuzzing\u8fc7\u7a0b\u7684\u65b0\u65b9\u6cd5\uff0c\u4f46\u5b83\u9700\u8981 \u624b\u52a8\u68c0\u67e5\u6d4b\u8bd5\u8986\u76d6\u7387 \uff0c\u4e86\u89e3\u4e3a\u4ec0\u4e48\u7ea6\u675f\u96be\u4ee5\u89e3\u51b3\uff0c\u5e76\u624b\u52a8\u521b\u5efa\u4e00\u4e2a\u5408\u9002\u7684\u6ce8\u91ca\u3002\u8fd9\u79cd\u624b\u52a8\u5de5\u4f5c\u5bf9\u5206\u6790\u5e08\u6765\u8bf4\u662f \u6709\u4e00\u5b9a\u6210\u672c \u7684</p> </li> <li> <p>\u627e\u5230\u597d\u7684\u79cd\u5b50\u8f93\u5165 \u4e5f\u4e0d\u662f\u4e00\u4ef6\u7b80\u5355\u7684\u4e8b\u3002\u8bb0\u5f55\u548c\u91cd\u653e\u673a\u5236 \uff0c\u5982HACRS\u6216DYNODROID\u7684\u4e00\u4e2a\u7248\u672c\u9002\u7528\u4e8e\u8fd9\u4e2a\u76ee\u6807\uff0c\u53ef\u80fd\u4f1a\u6709\u6240\u5e2e\u52a9\uff0c\u4f46\u5728\u8bb8\u591a\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u4f8b\u5982 \u4e8c\u8fdb\u5236\u683c\u5f0f \uff0c\u53ef\u80fd\u4e0d\u4f1a\u3002</p> </li> <li> <p>IJON\u4e2d\u4f7f\u7528\u7684\u6ce8\u91ca\u76ee\u524d\u662f\u624b\u52a8\u6dfb\u52a0\u7684\u3002\u8bbe\u8ba1\u65b9\u6cd5\u81ea\u52a8\u63a8\u65ad\u53ea\u9488\u5bf9\u56f0\u96be\u7684\u5355\u4e2a\u7ea6\u675f\u662f\u6709\u8da3\u7684\u3002\u4e00\u4e9b\u73b0\u6709\u7684fuzzing\u65b9\u6cd5\u4f7f\u7528\u6211\u4eec\u63cf\u8ff0\u7684\u6ce8\u91ca\u7684\u5b50\u96c6\u3002\u7136\u800c\uff0c\u6240\u6709\u8fd9\u4e9b\u5de5\u5177\u90fd\u4e0d\u52a0\u533a\u522b\u5730\u4f7f\u7528\u989d\u5916\u7684\u53cd\u9988\u3002\u56e0\u6b64\uff0c\u5b83\u4eec\u53d7\u9650\u4e8e\u4f4e\u4fe1\u606f\u589e\u76ca\u53cd\u9988\u673a\u5236\u3002</p> </li> <li> <p>\u6700\u540e\uff0c\u73b0\u5728\uff0c\u6ce8\u91ca\u9700\u8981\u6e90\u8bbf\u95ee\u3002\u539f\u5219\u4e0a\uff0c\u6ca1\u6709\u7406\u7531\u4e3a\u4ec5\u4e8c\u8fdb\u5236\u76ee\u6807\u5b9e\u73b0\u7c7b\u4f3c\u7684\u6ce8\u91ca\u3002\u5c06IJON\u4e0e\u4ec5\u4e8c\u8fdb\u5236fuzzer\u96c6\u6210\u5c06\u662f\u6709\u8da3\u7684\u3002</p> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_8","title":"\u8ba8\u8bba","text":"","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#fuzzer","title":"Fuzzer","text":"<p>Fuzzer\u7684\u8f93\u5165\u4e3a\u6570\u636e\u8f93\u5165\uff08\u79cd\u5b50\uff09\u548c\u7a0b\u5e8f\uff0c\u7136\u540eFuzzer\u7a0b\u5e8f\u4f1a\u5bf9\u6570\u636e\u8f93\u5165\uff08\u79cd\u5b50\uff09\u8fdb\u884c\u53d8\u5f02\uff0c\u7136\u540e\u8fd0\u884c\u7a0b\u5e8f\uff0c\u89c2\u5bdf\u7a0b\u5e8f\u7684\u884c\u4e3a\uff0c\u7136\u540e\u6839\u636e\u7a0b\u5e8f\u7684\u884c\u4e3a\u6765\u9009\u62e9\u6570\u636e\u8f93\u5165\uff08\u79cd\u5b50\uff09\uff0c\u4ee5\u6b64\u6765\u8fbe\u5230\u66f4\u597d\u7684\u8986\u76d6\u7387\u3002</p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2dFuzzer\u7ef4\u62a4\u4f4d\u56fe\u6570\u636e\u7ed3\u6784\uff0865535\u5927\u5c0f\uff09\u6765\u8bb0\u5f55\u7a0b\u5e8f\u7684\u72b6\u6001\uff08\u901a\u8fc7\u63d2\u6869\u7edf\u8ba1\uff09\uff0c\u4ee5\u6b64\u6765\u9009\u62e9\u66f4\u597d\u7684\u6570\u636e\u8f93\u5165\uff08\u79cd\u5b50\uff09\u3001\u6dd8\u6c70\u5dee\u7684\u6570\u636e\u8f93\u5165\uff08\u79cd\u5b50\uff09\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_9","title":"\u53d8\u5f02\u7b56\u7565","text":"<p>\u53d8\u5f02\u7b56\u7565\u662fFuzzer\u7684\u6838\u5fc3\uff0cFuzzer\u7684\u53d8\u5f02\u7b56\u7565\u51b3\u5b9a\u4e86Fuzzer\u7684\u6027\u80fd\u3002</p> <p>Fuzzer\u9009\u62e9\u521d\u59cb\u79cd\u5b50 -&gt; \u8fd0\u884c -&gt; \u6839\u636e\u4f4d\u56fe\u9009\u62e9\u66f4\u597d\u7684\u79cd\u5b50 -&gt; \u53d8\u5f02 -&gt; \u8fd0\u884c -&gt; \u6839\u636e\u4f4d\u56fe\u9009\u62e9\u66f4\u597d\u7684\u79cd\u5b50 -&gt; \u53d8\u5f02 -&gt; \u8fd0\u884c -&gt; ... </p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#fuzzing_2","title":"Fuzzing\u6a21\u5f0f","text":"<p>\u73b0\u5728\u7684Fuzzing\u6a21\u5f0f\u662f\u5bf9\u6574\u4e2a\u7a0b\u5e8f\u8fdb\u884cFuzzing\uff0c\u56e0\u4e3a\u51fd\u6570\u4e4b\u95f4\u7684\u4f9d\u8d56\u65e0\u6cd5\u89e3\u51b3\uff08\u4e0a\u4e0b\u6587\u5173\u7cfb\uff09\uff0c\u6240\u4ee5\u5373\u4f7f\u5bf9\u5355\u4e2a\u51fd\u6570Fuzzing\u5b8c\u5168\uff0c\u4e5f\u65e0\u6cd5\u8bc1\u660e\u6574\u4f53\u7684\u5b89\u5168\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/19/%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_10","title":"\u4efb\u52a1","text":"<ul> <li>\u4fee\u6539Libfuzzer\u6e90\u7801\uff0cLibfuzzer.a\u6587\u4ef6-&gt;clang\u7684\u5e93\uff0c\u540d\u5b57\u4e00\u81f4\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u8dd1\u8d77\u6765\uff1b</li> <li>\u6e90\u7801\u9605\u8bfb\uff1a\u68b3\u7406Libfuzzer\u6e90\u7801 Runone\u5230ExecuteCallback\u7684\u8def\u5f84</li> <li>\u6d4b\u8bd5\u7a0b\u5e8f\uff0cif (input == \"FUZZZZZME\"){bug()}</li> <li>\u8bba\u6587\u7cbe\u8bfb\uff1aAFL Feedback: Coverage-based Greybox Fuzzing as Markov Chain </li> <li>\u8bba\u6587\u7cbe\u5ea6\uff1aNEZHA: Efficient Domain-Independent Differential Testing</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/","title":"\u8bb0\u7b2c\u4e00\u6b21\u8bba\u6587\u7814\u8ba8","text":"<p>NEZHA: Efficient Domain-Independent Differential Testing </p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_2","title":"\u524d\u8a00","text":"<p>\u5c5e\u4e8e\u662f\u521a\u5f00\u59cb\u505a\u6ca1\u4ec0\u4e48\u7ecf\u9a8c\uff0c\u6628\u5929\u770b\u5230\u8001\u5e08\u53d1\u7684\u95ee\u9898\u6a21\u677f\uff1a</p> <ul> <li>\u8fd9\u7bc7\u6587\u7ae0\u8bb2\u4e86\u4ec0\u4e48</li> <li>\u5b66\u5230\u54ea\u4e9b\u91cd\u8981\u6982\u5ff5</li> <li>\u4f60\u8ba4\u4e3a\u5b83\u597d\u7684\u5730\u65b9</li> <li>\u4e0d\u89e3\u7684\u5730\u65b9\uff0c\u60f3\u8981\u8fdb\u4e00\u6b65\u4ea4\u6d41</li> </ul> <p>\u4eca\u5929\u8d76\u5de5\u603b\u7ed3\u4e00\u4e0b\u524d\u4e24\u5929\u9605\u8bfbPaper\u7684\u8fc7\u7a0b\u53ca\u6536\u83b7\uff0c\u5199\u4e00\u4e2aBlog\u5427\u3002</p> <p>\u4ee5\u540e\u53ef\u80fd\u4f1a\u4e0d\u5b9a\u671f\u66f4\u65b0\u8fd9\u4e2aBlog\u4e13\u680f\uff0c\u66f4\u65b0\u9891\u6b21\u968f\u673a</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_3","title":"\u8bba\u6587\u7b80\u4ecb","text":"<p>\u8fd9\u7bc7\u6587\u7ae0\u8bb2\u4e86\u4ec0\u4e48</p> <p>NEZHA\uff0c\u4e00\u79cd\u9ad8\u6548\u7684\u3001\u4e0e\u9886\u57df\u65e0\u5173\u7684\u5dee\u5206\u6d4b\u8bd5\u6846\u67b6\u3002</p> <ul> <li>\u5dee\u5206\u6d4b\u8bd5\u7684\u6311\u6218\uff1a<ul> <li>\u5927\u591a\u6570\u5dee\u5206\u6d4b\u8bd5\u5de5\u5177\u4f9d\u8d56\u4e8e\u8f93\u5165\u683c\u5f0f\u7684\u9886\u57df\u7279\u5b9a\u77e5\u8bc6\uff0c\u96be\u4ee5\u9002\u5e94\u65b0\u7684\u9886\u57df\u3002</li> <li>\u73b0\u6709\u5de5\u5177\u5728\u53d1\u73b0\u8bed\u4e49\u9519\u8bef\u65f6\u6548\u7387\u8f83\u4f4e\uff0c\u9700\u8981\u5927\u91cf\u8f93\u5165\u624d\u80fd\u627e\u5230\u5355\u4e2a\u9519\u8bef\u3002</li> <li>\u8bb8\u591a\u5de5\u5177\u4f7f\u7528\u4e3a\u53d1\u73b0\u5d29\u6e83\u6216\u5185\u5b58\u635f\u574f\u9519\u8bef\u800c\u8bbe\u8ba1\u7684\u6280\u672f\u751f\u6210\u8f93\u5165\uff0c\u5ffd\u7565\u4e86\u6d4b\u8bd5\u7a0b\u5e8f\u4e4b\u95f4\u7684\u884c\u4e3a\u4e0d\u5bf9\u79f0\u6027\u3002</li> </ul> </li> <li>NEZHA\u7684\u8bbe\u8ba1\uff1a<ul> <li>\u5229\u7528\u591a\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\u4e4b\u95f4\u7684\u884c\u4e3a\u4e0d\u5bf9\u79f0\u6027\uff0c\u4e13\u6ce8\u4e8e\u66f4\u53ef\u80fd\u89e6\u53d1\u8bed\u4e49\u9519\u8bef\u7684\u8f93\u5165\u3002 <p>For the rest of the paper, we focus on using differential testing to discover program discrepancies in this setting, i.e., where at least one test program validates and accepts an input and another program with similar functionality rejects the same input as invalid</p> </li> <li>\u5f15\u5165\u4e86\u03b4-\u5206\u96c6(\u03b4-diversity)\u6982\u5ff5\uff0c\u7528\u4e8e\u603b\u7ed3\u591a\u4e2a\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u89c2\u5bdf\u5230\u7684\u884c\u4e3a\u4e0d\u5bf9\u79f0\u6027\u3002</li> </ul> </li> <li>\u8f93\u5165\u751f\u6210\u673a\u5236\uff1a\u8bbe\u8ba1\u4e86\u4e24\u79cd\u9ad8\u6548\u7684\u3001\u4e0e\u9886\u57df\u65e0\u5173\u7684\u8f93\u5165\u751f\u6210\u673a\u5236\uff0c\u4e00\u79cd\u662f\u7070\u76d2\u7684\uff0c\u53e6\u4e00\u79cd\u662f\u9ed1\u76d2\u7684\u3002<ul> <li>\u7070\u76d2\u8f93\u5165\u751f\u6210\u673a\u5236\uff1a\u8fd9\u79cd\u673a\u5236\u5728\u7a0b\u5e8f\u6267\u884c\u65f6\u6536\u96c6\u8be6\u7ec6\u7684\u8fd0\u884c\u65f6\u4fe1\u606f\uff0c\u4f8b\u5982\u63a7\u5236\u6d41\u56fe\uff08CFG\uff09\u4e2d\u7684\u8def\u5f84\u3002\u901a\u8fc7\u8ddf\u8e2a\u591a\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\u7684\u6267\u884c\u8def\u5f84\uff0c\u7070\u76d2\u673a\u5236\u53ef\u4ee5\u751f\u6210\u66f4\u6709\u53ef\u80fd\u89e6\u53d1\u8bed\u4e49\u9519\u8bef\u7684\u8f93\u5165\u3002</li> <li>\u9ed1\u76d2\u8f93\u5165\u751f\u6210\u673a\u5236\uff1a\u8fd9\u79cd\u673a\u5236\u4e0d\u9700\u8981\u7a0b\u5e8f\u7684\u5185\u90e8\u4fe1\u606f\uff0c\u800c\u662f\u57fa\u4e8e\u7a0b\u5e8f\u7684\u8f93\u51fa\uff08\u5982\u9519\u8bef\u4fe1\u606f\u3001\u8fd4\u56de\u503c\u7b49\uff09\u6765\u751f\u6210\u8f93\u5165\u3002\u901a\u8fc7\u89c2\u5bdf\u4e0d\u540c\u7a0b\u5e8f\u5728\u76f8\u540c\u8f93\u5165\u4e0b\u7684\u8f93\u51fa\u5dee\u5f02\uff0c\u9ed1\u76d2\u673a\u5236\u53ef\u4ee5\u6709\u6548\u5730\u53d1\u73b0\u8bed\u4e49\u9519\u8bef\u3002</li> </ul> </li> <li>\u5b9e\u9a8c\u7ed3\u679c\uff1aNEZHA\u5728\u53d1\u73b0\u8bed\u4e49\u9519\u8bef\u65b9\u9762\u6bd4\u73b0\u6709\u5de5\u5177\u66f4\u9ad8\u6548\uff0c\u5e73\u5747\u53d1\u73b0\u5dee\u5f02\u7684\u901f\u5ea6\u6bd4Frankencerts\u548cMucerts\u5206\u522b\u9ad852\u500d\u548c27\u500d\u3002</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_4","title":"\u91cd\u8981\u6982\u5ff5","text":"<p>\u5b66\u5230\u54ea\u4e9b\u91cd\u8981\u6982\u5ff5</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_5","title":"\u8bc1\u4e66","text":"<p>\u8bc1\u4e66\u662f\u4e00\u79cd\u6570\u5b57\u6587\u6863\uff0c\u7528\u4e8e\u9a8c\u8bc1\u5b9e\u4f53\uff08\u5982\u4e2a\u4eba\u3001\u7ec4\u7ec7\u6216\u8bbe\u5907\uff09\u7684\u8eab\u4efd\u3002\u5b83\u901a\u5e38\u7531\u53d7\u4fe1\u4efb\u7684\u7b2c\u4e09\u65b9\uff08\u79f0\u4e3a\u8bc1\u4e66\u9881\u53d1\u673a\u6784\uff0cCA\uff09\u7b7e\u53d1\uff0c\u5e76\u5305\u542b\u4ee5\u4e0b\u5173\u952e\u5143\u7d20\uff1a</p> <ul> <li>\u516c\u94a5\uff1a\u7528\u4e8e\u52a0\u5bc6\u548c\u89e3\u5bc6\u6570\u636e\u3002</li> <li>\u6301\u6709\u8005\u4fe1\u606f\uff1a\u5305\u62ec\u6301\u6709\u8005\u7684\u540d\u79f0\u3001\u7ec4\u7ec7\u7b49\u3002</li> <li>\u9881\u53d1\u8005\u4fe1\u606f\uff1a\u5305\u62ec\u9881\u53d1\u8bc1\u4e66\u7684CA\u7684\u540d\u79f0\u548c\u7b7e\u540d\u3002</li> <li>\u6709\u6548\u671f\uff1a\u8bc1\u4e66\u7684\u6709\u6548\u8d77\u59cb\u548c\u7ed3\u675f\u65e5\u671f\u3002</li> <li>\u5e8f\u5217\u53f7\uff1a\u552f\u4e00\u6807\u8bc6\u8bc1\u4e66\u7684\u7f16\u53f7\u3002</li> </ul> <p>\u8bc1\u4e66\u5728\u7f51\u7edc\u5b89\u5168\u4e2d\u8d77\u7740\u91cd\u8981\u4f5c\u7528\uff0c\u7279\u522b\u662f\u5728SSL/TLS\u534f\u8bae\u4e2d\uff0c\u7528\u4e8e\u786e\u4fdd\u7f51\u7edc\u901a\u4fe1\u7684\u5b89\u5168\u6027\u3002</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#semantic-bug","title":"\u8bed\u4e49\u6f0f\u6d1e\uff08Semantic Bug\uff09","text":"<p>\u8bed\u4e49\u6f0f\u6d1e\u662f\u6307\u7a0b\u5e8f\u5728\u903b\u8f91\u4e0a\u5b58\u5728\u7684\u7f3a\u9677\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u5229\u7528\u8fd9\u4e9b\u7f3a\u9677\uff0c\u901a\u8fc7\u6784\u9020\u7b26\u5408\u89c4\u5219\u4f46\u4e0d\u7b26\u5408\u9884\u671f\u7684\u8f93\u5165\u6765\u653b\u51fb\u7a0b\u5e8f\u3002\u8fd9\u7c7b\u6f0f\u6d1e\u4e0d\u4f1a\u8868\u73b0\u51fa\u660e\u663e\u7684\u9519\u8bef\u884c\u4e3a\uff08\u5982\u5d29\u6e83\u6216\u65ad\u8a00\u5931\u8d25\uff09\uff0c\u56e0\u6b64\u5f88\u96be\u88ab\u53d1\u73b0</p> <p>Semantic bugs are errors in software that cause it to deviate from its intended behavior or specifications without causing obvious failures like crashes</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#-diversitydifferential-diversity","title":"\u03b4-\u5206\u96c6\uff08\u03b4-diversity\uff09(Differential-diversity)","text":"<p>\u03b4\u5206\u96c6\uff08\u03b4-diversity\uff09\u662f\u4e00\u79cd\u7528\u4e8e\u603b\u7ed3\u591a\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\u4e4b\u95f4\u884c\u4e3a\u4e0d\u5bf9\u79f0\u6027\u7684\u65b9\u6cd5\u3002\u5b83\u901a\u8fc7\u8ddf\u8e2a\u6d4b\u8bd5\u7a0b\u5e8f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u89c2\u5bdf\u5230\u7684\u884c\u4e3a\u5dee\u5f02\uff0c\u6765\u6307\u5bfc\u8f93\u5165\u751f\u6210\u8fc7\u7a0b\uff0c\u4ee5\u66f4\u6709\u6548\u5730\u53d1\u73b0\u8bed\u4e49\u9519\u8bef\u3002</p> <p>We introduce the notion of \u03b4-diversity, which summarizes the observed asymmetries between the behaviors of multiple test applications. Based on \u03b4-diversity, we design two efficient domain-independent input generation mechanisms for differential testing, one gray-box and one blackbox. We demonstrate that both of these input generation scheme</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#differential-testing","title":"\u5dee\u5206\u6d4b\u8bd5\uff08Differential Testing\uff09","text":"<p>\u5dee\u5206\u6d4b\u8bd5\u662f\u4e00\u79cd\u4f7f\u7528\u76f8\u4f3c\u7a0b\u5e8f\u4f5c\u4e3a\u4ea4\u53c9\u53c2\u8003\u6765\u53d1\u73b0\u8bed\u4e49\u9519\u8bef\u7684\u65b9\u6cd5\uff0c\u8fd9\u4e9b\u9519\u8bef\u4e0d\u4f1a\u8868\u73b0\u51fa\u660e\u663e\u7684\u9519\u8bef\u884c\u4e3a\uff0c\u5982\u5d29\u6e83\u6216\u65ad\u8a00\u5931\u8d25\u3002\u5dee\u5206\u6d4b\u8bd5\u901a\u8fc7\u6bd4\u8f83\u591a\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\u7684\u884c\u4e3a\u4e0d\u5bf9\u79f0\u6027\uff0c\u4e13\u6ce8\u4e8e\u66f4\u53ef\u80fd\u89e6\u53d1\u8bed\u4e49\u9519\u8bef\u7684\u8f93\u5165</p> <p>Differential testing uses similar programs as cross-referencing oracles to find semantic bugs that do not exhibit explicit erroneous behaviors like crashes or assertion failures. By comparing the behavioral asymmetries between multiple test programs, it focuses on inputs that are more likely to trigger semantic bugs</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#program-instrumentation","title":"\u7a0b\u5e8f\u63d2\u6869\uff08Program Instrumentation\uff09","text":"<p>\u7a0b\u5e8f\u63d2\u6869\uff08Instrumentation\uff09\u662f\u4e00\u79cd\u5728\u7a0b\u5e8f\u8fd0\u884c\u65f6\u6536\u96c6\u4fe1\u606f\u7684\u6280\u672f\u3002\u901a\u8fc7\u5728\u7a0b\u5e8f\u7684\u7279\u5b9a\u4f4d\u7f6e\u63d2\u5165\u4ee3\u7801\uff0c\u53ef\u4ee5\u76d1\u63a7\u7a0b\u5e8f\u7684\u884c\u4e3a\uff0c\u4f8b\u5982\u6267\u884c\u8def\u5f84\u3001\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u548c\u51fd\u6570\u8c03\u7528\u7b49\u3002\u8fd9\u4e9b\u4fe1\u606f\u5bf9\u4e8e\u8c03\u8bd5\u3001\u6027\u80fd\u5206\u6790\u548c\u5b89\u5168\u68c0\u6d4b\u975e\u5e38\u6709\u7528</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#binary-rewriting","title":"\u4e8c\u8fdb\u5236\u91cd\u5199\uff08Binary Rewriting\uff09","text":"<p>\u4e8c\u8fdb\u5236\u91cd\u5199\uff08Binary Rewriting\uff09\u662f\u4e00\u79cd\u6280\u672f\uff0c\u7528\u4e8e\u5728\u4e0d\u9700\u8981\u6e90\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\u4fee\u6539\u5df2\u7f16\u8bd1\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002\u5b83\u53ef\u4ee5\u7528\u4e8e\u591a\u79cd\u76ee\u7684\uff0c\u5305\u62ec\u6027\u80fd\u4f18\u5316\u3001\u5b89\u5168\u6027\u589e\u5f3a\u3001\u9519\u8bef\u4fee\u590d\u548c\u529f\u80fd\u6dfb\u52a0\u3002\u4e8c\u8fdb\u5236\u91cd\u5199\u901a\u5e38\u6d89\u53ca\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u89e3\u6790\u4e8c\u8fdb\u5236\u6587\u4ef6\uff1a\u5206\u6790\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u7ed3\u6784\u548c\u5185\u5bb9\u3002</li> <li>\u4fee\u6539\u4ee3\u7801\u6216\u6570\u636e\uff1a\u6839\u636e\u9700\u8981\u63d2\u5165\u3001\u5220\u9664\u6216\u66ff\u6362\u6307\u4ee4\u6216\u6570\u636e\u3002</li> <li>\u91cd\u7ec4\u4e8c\u8fdb\u5236\u6587\u4ef6\uff1a\u786e\u4fdd\u4fee\u6539\u540e\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u4ecd\u7136\u662f\u6709\u6548\u7684\u53ef\u6267\u884c\u6587\u4ef6</li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#cfg","title":"\u63a7\u5236\u6d41\u56fe\uff08CFG\uff09","text":"<p>CFG \u662f\u63a7\u5236\u6d41\u56fe\uff08Control Flow Graph\uff09\u7684\u7f29\u5199\u3002\u5b83\u662f\u4e00\u79cd\u56fe\u5f62\u8868\u793a\u6cd5\uff0c\u7528\u4e8e\u63cf\u8ff0\u7a0b\u5e8f\u4e2d\u5404\u4e2a\u57fa\u672c\u5757\uff08basic blocks\uff09\u4e4b\u95f4\u7684\u63a7\u5236\u6d41\u5173\u7cfb\u3002\u57fa\u672c\u5757\u662f\u6307\u4e00\u6bb5\u6ca1\u6709\u5206\u652f\u7684\u4ee3\u7801\u5e8f\u5217\uff0c\u63a7\u5236\u6d41\u56fe\u901a\u8fc7\u8282\u70b9\u548c\u8fb9\u6765\u8868\u793a\u7a0b\u5e8f\u7684\u6267\u884c\u8def\u5f84\uff0c\u5176\u4e2d\u8282\u70b9\u4ee3\u8868\u57fa\u672c\u5757\uff0c\u8fb9\u4ee3\u8868\u63a7\u5236\u6d41\u7684\u8f6c\u79fb</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_6","title":"\u7c92\u5ea6","text":"<p>\u7c92\u5ea6\u662f\u6307\u8f6f\u4ef6\u7cfb\u7edf\u4e2d\u5404\u4e2a\u7ec4\u4ef6\u4e4b\u95f4\u7684\u5173\u8054\u7a0b\u5ea6\u3002\u7c92\u5ea6\u8d8a\u7ec6\uff0c\u7ec4\u4ef6\u4e4b\u95f4\u7684\u5173\u8054\u8d8a\u5c0f\uff0c\u7cfb\u7edf\u7684\u6a21\u5757\u5316\u7a0b\u5ea6\u8d8a\u9ad8\u3002\u7c92\u5ea6\u7684\u9009\u62e9\u5bf9\u8f6f\u4ef6\u7cfb\u7edf\u7684\u6027\u80fd\u3001\u53ef\u7ef4\u62a4\u6027\u548c\u6269\u5c55\u6027\u7b49\u65b9\u9762\u90fd\u6709\u5f71\u54cd</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_7","title":"\u8bba\u6587\u521b\u65b0\u70b9","text":"<p>\u4f60\u8ba4\u4e3a\u5b83\u597d\u7684\u5730\u65b9</p> <p>@\u65b9\u8001\u5e08\uff1a\u8fd9\u7bc7\u6587\u7ae0\u7684\u6838\u5fc3\u5728\u4e8e\u5176\u63d0\u51fa\u4e86\u4e00\u79cd\u65b0\u7684\u7a0b\u5e8f\u6267\u884c\u4e0d\u6b63\u786e\u7684\u63cf\u8ff0\u65b9\u5f0f\uff08Unexpected Execution\uff09</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_8","title":"\u4e0d\u89e3\u4e4b\u5904","text":"<p>\u4e0d\u89e3\u7684\u5730\u65b9\uff0c\u60f3\u8981\u8fdb\u4e00\u6b65\u4ea4\u6d41</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#-","title":"\u6982\u5ff5-\u03b4\u5206\u96c6\u53ca\u5176\u5728\u6a21\u7cca\u6d4b\u8bd5\u4e2d\u7684\u6548\u7387\u63d0\u5347\u539f\u7406","text":"<p>@\u65b9\u8001\u5e08\uff1a\u5b9e\u9645\u8fd9\u7bc7\u6587\u7ae0\u7684\u6838\u5fc3\u4e0d\u5728\u03b4\u5206\u96c6\u4e0a\uff0c\u4e14\u5176\u5b9e\u9a8c\u6548\u679c\u4e5f\u5b58\u5728\u4e00\u70b9\u70b9trick</p>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_9","title":"\u8ba8\u8bba\u603b\u7ed3","text":"<ul> <li>\u91cd\u70b9\uff1a\u5982\u4f55\u5b9a\u4e49\u7a0b\u5e8f\u7684\u6b63\u786e\u6027<ul> <li>Unexpected Execution(e.g. \u7f13\u51b2\u533a\u6ea2\u51fa\uff0c\u5185\u5b58\u6cc4\u6f0f\uff0cUse after free)<ul> <li>\u4eba\u5de5\u6d4b\u8bd5(Bug Oracle)</li> <li>\u5dee\u5206\u6d4b\u8bd5</li> </ul> </li> </ul> </li> <li>\u4efb\u52a1\uff1a<ul> <li>\u6982\u5ff5\u7406\u89e3\uff1a<ul> <li>\u7a0b\u5e8f\u63d2\u6869</li> </ul> </li> <li>\u6587\u7ae0\u9605\u8bfb\uff1a<ul> <li>\u7cbe\u8bfb NEZHA: Efficient Domain-Independent Differential Testing (2\u904d)</li> <li>\u7cbe\u8bfb IJON: Exploring Deep State Spaces via Fuzzing</li> </ul> </li> <li>\u6e90\u7801\u9605\u8bfb\uff1a<ul> <li>libfuzzer\u7684\u6e90\u7801</li> </ul> </li> <li>\u6e90\u7801\u6267\u884c\uff1a<ul> <li>libfuzzer\u7684\u6e90\u7801</li> <li>NEZHA\u7684\u6e90\u7801</li> </ul> </li> </ul> </li> <li>\u6ce8\u610f\uff1a<ul> <li>\u505a\u597d\u9605\u8bfb\u8fc7\u7a0b\u4e2d\u7684\u95ee\u9898\u8bb0\u5f55\uff0c\u53ca\u65f6\u53cd\u9988</li> </ul> </li> </ul>","tags":["Fuzz","IIE"]},{"location":"blog/2024/09/13/%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AE%BA%E6%96%87%E7%A0%94%E8%AE%A8/#_10","title":"\u5e38\u6001\u5316\uff08\u7ec4\u4f1a\uff09","text":"<p>\u4e0b\u6b21\u65f6\u95f4\uff1a2024-09-21</p>","tags":["Fuzz","IIE"]},{"location":"ctf/","title":"\u4ecb\u7ecd","text":"<p>\u5185\u5bb9\u5df2\u8fc1\u79fb\u81f3UCAS-CTF Wiki\u3002</p> <p>\u4ee5\u4e0b\u4e3aGPT\u53d1\u766b</p> <p>\ud83d\ude80 \u3010CTF\uff1a\u7f51\u7edc\u5b89\u5168\u7684\u7ec8\u6781\u6311\u6218\u3011</p> <p>\ud83c\udf1f \u6b22\u8fce\u6765\u5230CTF\u7684\u4e16\u754c\uff0c\u4e00\u4e2a\u5145\u6ee1\u523a\u6fc0\u4e0e\u6311\u6218\u7684\u6570\u5b57\u6218\u573a\u3002\u5728\u8fd9\u91cc\uff0c\u4f60\u5c06\u5316\u8eab\u4e3a\u4e00\u540d\u7f51\u7edc\u5b89\u5168\u7684\u52c7\u58eb\uff0c\u7528\u4f60\u7684\u667a\u6167\u548c\u6280\u80fd\u53bb\u6355\u6349\u90a3\u4e9b\u98d8\u5ffd\u4e0d\u5b9a\u7684\u201c\u65d7\u5e1c\u201d\u3002</p> <p>\ud83c\udfae \u60f3\u8c61\u4e00\u4e0b\uff0c\u4f60\u5750\u5728\u7535\u8111\u524d\uff0c\u6307\u5c16\u5728\u952e\u76d8\u4e0a\u98de\u821e\uff0c\u773c\u524d\u662f\u4e00\u8fde\u4e32\u590d\u6742\u7684\u4ee3\u7801\u548c\u6570\u636e\u6d41\u3002\u4f60\u7684\u76ee\u6807\uff1f\u53d1\u73b0\u5e76\u5229\u7528\u7cfb\u7edf\u4e2d\u7684\u6f0f\u6d1e\uff0c\u83b7\u53d6\u9690\u85cf\u5728\u6df1\u5904\u7684\u79d8\u5bc6\u4fe1\u606f\u3002</p> <p>\ud83d\udd10 \u8fd9\u4e0d\u662f\u6e38\u620f\uff0c\u8fd9\u662f\u73b0\u5b9e\u3002CTF\uff08Capture The Flag\uff09\u662f\u4e00\u573a\u5168\u7403\u6027\u7684\u7f51\u7edc\u5b89\u5168\u7ade\u8d5b\uff0c\u5b83\u5c06\u5e26\u4f60\u8fdb\u5165\u4e00\u4e2a\u5145\u6ee1\u672a\u77e5\u548c\u60ca\u559c\u7684\u6570\u5b57\u4e16\u754c\u3002</p> <p>\ud83c\udf10 \u5728\u8fd9\u91cc\uff0c\u4f60\u5c06\u5b66\u4e60\u5230\u6700\u524d\u6cbf\u7684\u7f51\u7edc\u5b89\u5168\u6280\u672f\uff0c\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\uff1a</p> <p>\ud83d\udd29 \u9006\u5411\u5de5\u7a0b\uff1a\u50cf\u4fa6\u63a2\u4e00\u6837\uff0c\u4ece\u8f6f\u4ef6\u7684\u5185\u90e8\u7ed3\u6784\u4e2d\u5bfb\u627e\u7ebf\u7d22\u3002 \ud83d\udd12 \u5bc6\u7801\u5b66\uff1a\u89e3\u9501\u52a0\u5bc6\u7684\u79d8\u5bc6\uff0c\u4fdd\u62a4\u4fe1\u606f\u7684\u5b89\u5168\u3002 \ud83d\udcbb \u7cfb\u7edf\u5b89\u5168\uff1a\u6784\u5efa\u575a\u4e0d\u53ef\u6467\u7684\u9632\u5fa1\u4f53\u7cfb\uff0c\u62b5\u5fa1\u9ed1\u5ba2\u7684\u653b\u51fb\u3002 \ud83c\udf10 \u7f51\u7edc\u534f\u8bae\uff1a\u638c\u63e1\u7f51\u7edc\u901a\u4fe1\u7684\u89c4\u5219\uff0c\u786e\u4fdd\u6570\u636e\u7684\u987a\u7545\u6d41\u52a8\u3002 \ud83c\udfc6 CTF\u4e0d\u4ec5\u4ec5\u662f\u4e00\u573a\u6bd4\u8d5b\uff0c\u5b83\u662f\u4e00\u4e2a\u5b66\u4e60\u7684\u5e73\u53f0\uff0c\u4e00\u4e2a\u5c55\u793a\u4f60\u624d\u534e\u7684\u821e\u53f0\u3002\u5728\u8fd9\u91cc\uff0c\u4f60\u5c06\u4e0e\u6765\u81ea\u4e16\u754c\u5404\u5730\u7684\u9876\u5c16\u9ad8\u624b\u540c\u53f0\u7ade\u6280\uff0c\u5171\u540c\u6210\u957f\u3002</p> <p>\ud83c\udf93 \u65e0\u8bba\u4f60\u662f\u5b66\u751f\u3001\u5f00\u53d1\u8005\u3001\u5b89\u5168\u7814\u7a76\u5458\uff0c\u8fd8\u662f\u5bf9\u7f51\u7edc\u5b89\u5168\u5145\u6ee1\u70ed\u60c5\u7684\u7231\u597d\u8005\uff0cCTF\u90fd\u662f\u4f60\u63d0\u5347\u6280\u80fd\u3001\u953b\u70bc\u601d\u7ef4\u7684\u6700\u4f73\u9009\u62e9\u3002</p> <p>\ud83c\udf1f \u52a0\u5165\u6211\u4eec\uff0c\u4f60\u5c06\u83b7\u5f97\uff1a</p> <p>\ud83c\udfc5 \u8363\u8a89\u4e0e\u5956\u52b1\uff1a\u5728\u7ade\u8d5b\u4e2d\u83b7\u5f97\u540d\u6b21\uff0c\u8d62\u5f97\u8363\u8a89\u548c\u5956\u91d1\u3002 \ud83d\udcc8 \u6280\u80fd\u63d0\u5347\uff1a\u901a\u8fc7\u5b9e\u6218\u6f14\u7ec3\uff0c\u5feb\u901f\u63d0\u5347\u4f60\u7684\u6280\u672f\u80fd\u529b\u3002 \ud83e\udd1d \u4eba\u8109\u62d3\u5c55\uff1a\u7ed3\u8bc6\u5fd7\u540c\u9053\u5408\u7684\u670b\u53cb\uff0c\u5efa\u7acb\u5b9d\u8d35\u7684\u804c\u4e1a\u7f51\u7edc\u3002 \ud83d\udcbc \u804c\u4e1a\u53d1\u5c55\uff1a\u4e3a\u4f60\u7684\u7b80\u5386\u589e\u6dfb\u4eae\u70b9\uff0c\u5f00\u542f\u7f51\u7edc\u5b89\u5168\u9886\u57df\u7684\u804c\u4e1a\u751f\u6daf\u3002 \ud83d\udce2 \u73b0\u5728\uff0c\u5c31\u8ba9\u6211\u4eec\u4e00\u8d77\u8e0f\u4e0a\u8fd9\u573a\u6fc0\u52a8\u4eba\u5fc3\u7684\u65c5\u7a0b\uff0c\u7528\u4f60\u7684\u667a\u6167\u548c\u52c7\u6c14\u53bbCapture The Flag\uff01</p>"},{"location":"ctf/c_s0/","title":"C \u8bed\u8a00\u57fa\u7840","text":""},{"location":"ctf/c_s0/#hello-world","title":"Hello World","text":"C<pre><code>// helloworld.c\n#include &lt;stdio.h&gt;\n// \u5934\u6587\u4ef6\nint main()\n{\n    printf(\"Hello, World!\\n\");\n    return 0;\n}\n</code></pre>"},{"location":"ctf/c_s0/#_1","title":"\u7f16\u8bd1\u8fd0\u884c","text":"Bash<pre><code># \u7f16\u8bd1\ngcc -c helloworld.c\ngcc helloworld.o -o helloworld\n# \u8fd0\u884c\n./helloworld\n</code></pre>"},{"location":"ctf/c_s0/#makefile","title":"Makefile","text":"<p>\u672c\u6559\u7a0b\u57fa\u4e8eMakefile\u57fa\u7840</p>"},{"location":"ctf/c_s0/#_2","title":"\u5b89\u88c5","text":"Bash<pre><code>sudo apt install make\n</code></pre>"},{"location":"ctf/c_s0/#_3","title":"\u57fa\u7840\u89c4\u5219","text":"<p>\u4f60\u9700\u8981\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Makefile</code>\u7684\u6587\u4ef6\uff0c\u7136\u540e\u5728\u5176\u4e2d\u7f16\u5199\u89c4\u5219\u3002</p>"},{"location":"ctf/c_s0/#_4","title":"\u6587\u4ef6\u751f\u6210\u6307\u4ee4\u4e0e\u4f9d\u8d56\u5173\u7cfb","text":"Makefile<pre><code>target: dependencies\n    command\n</code></pre> <ul> <li><code>target</code>\uff1a\u76ee\u6807\u6587\u4ef6\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u4e2d\u95f4\u6587\u4ef6\u3002</li> <li><code>dependencies</code>\uff1a\u4f9d\u8d56\u6587\u4ef6\uff0c\u5982\u679c\u4f9d\u8d56\u6587\u4ef6\u7684\u65f6\u95f4\u6233\u6bd4\u76ee\u6807\u6587\u4ef6\u7684\u65f6\u95f4\u6233\u8981\u65b0\uff0c\u90a3\u4e48<code>command</code>\u5c06\u4f1a\u88ab\u6267\u884c\u3002</li> <li><code>command</code>\uff1a\u751f\u6210\u76ee\u6807\u6587\u4ef6\u7684\u6307\u4ee4\u3002\uff08\u8fd9\u91cc\u5e76\u4e0d\u9650\u5236command\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u662f\u4efb\u4f55shell\u547d\u4ee4\uff09</li> </ul>"},{"location":"ctf/c_s0/#_5","title":"\u793a\u4f8b","text":"Makefile<pre><code>hello: hello.o\n    gcc -o hello hello.o\nhello.o: hello.c\n    gcc -c hello.c\n</code></pre>"},{"location":"ctf/c_s0/#_6","title":"\u4f2a\u76ee\u6807","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u4e00\u4e9b\u4e0d\u4ea7\u751f\u6587\u4ef6\u7684\u76ee\u6807\uff0c\u8fd9\u79cd\u76ee\u6807\u79f0\u4e3a\u4f2a\u76ee\u6807\u3002\u4f2a\u76ee\u6807\u7684\u7279\u70b9\u662f\uff0c\u5b83\u603b\u662f\u88ab\u6267\u884c\uff0c\u4e0d\u7ba1\u4f9d\u8d56\u6587\u4ef6\u662f\u5426\u5b58\u5728\u3002</p> Makefile<pre><code># make\u4e0d\u4f1a\u5c06clean\u89c6\u4e3a\u4e00\u4e2a\u6587\u4ef6\n.PHONY: clean\nclean:\n    rm -f hello hello.o\n</code></pre>"},{"location":"ctf/c_s0/#_7","title":"\u591a\u6761\u547d\u4ee4","text":"<p>Makefile<pre><code>cd_ok:\n    pwd; cd ..; pwd;\n# \u5206\u53f7\u7528\u4e8e\u5206\u9694\u547d\u4ee4\uff0c\u8fd9\u91cc\u7684\u547d\u4ee4\u4f1a\u4f9d\u6b21\u6267\u884c\uff0c\u4e0a\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u4f1a\u5f71\u54cd\u4e0b\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\n</code></pre> \u4e5f\u53ef\u4ee5\u5199\u6210</p> Makefile<pre><code>cd_ok:\n    pwd; \\\n    cd ..; \\\n    pwd\n</code></pre> <p>\u53e6\u4e00\u4e2a\u4f8b\u5b50</p> Makefile<pre><code>cd_ok:\n    pwd\n    cd ..\n    pwd\n# \u8fd9\u91cc\u7684\u547d\u4ee4\u4f1a\u4f9d\u6b21\u6267\u884c\uff0c\u4e0a\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd\u4e0b\u4e00\u6761\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\n</code></pre>"},{"location":"ctf/c_s0/#_8","title":"\u63a7\u5236\u6253\u5370","text":"Makefile<pre><code># @\u7b26\u53f7\u7528\u4e8e\u63a7\u5236make\u662f\u5426\u6253\u5370\u547d\u4ee4\n@echo \"hello world\"\n# \u53ea\u4f1a\u8f93\u51fahello world\uff0c\u4e0d\u4f1a\u8f93\u51faecho \"hello world\"\n</code></pre>"},{"location":"ctf/c_s0/#c_1","title":"\u591a\u6587\u4ef6\u7f16\u8bd1C","text":"<p>C<pre><code>// hello.c\n#include &lt;stdio.h&gt;\n\nint hello()\n{\n    printf(\"hello, world!\\n\");\n    return 0;\n}\n</code></pre> C<pre><code>// hello.h\nint hello();\n</code></pre> C<pre><code>// main.c\n#include &lt;stdio.h&gt;\n#include \"hello.h\"\n\nint main()\n{\n    printf(\"start...\\n\");\n    hello();\n    printf(\"exit.\\n\");\n    return 0;\n}\n</code></pre></p> <p>\u7f16\u8bd1<code>hello.c</code>,<code>hello.h</code>,<code>main.c</code>\u4e3a <code>world.out</code> Makefile<pre><code># \u751f\u6210\u53ef\u6267\u884c\u6587\u4ef6:\nworld.out: hello.o main.o\n    cc -o world.out hello.o main.o\n\n# \u7f16\u8bd1 hello.c:\nhello.o: hello.c\n    cc -c hello.c\n\n# \u7f16\u8bd1 main.c:\nmain.o: main.c hello.h\n    cc -c main.c\n\nclean:\n    rm -f *.o world.out\n</code></pre></p>"},{"location":"ctf/c_s0/#_9","title":"\u53d8\u91cf","text":"Makefile<pre><code># \u5b9a\u4e49\u53d8\u91cf\nCC = cc\nCFLAGS = -Wall -g\n\n# \u4f7f\u7528\u53d8\u91cf\nhello: hello.o\n    $(CC) -o hello hello.o\n\nhello.o: hello.c\n    $(CC) -c hello.c $(CFLAGS)\n</code></pre>"},{"location":"ctf/c_s0/#_10","title":"\u81ea\u52a8\u53d8\u91cf","text":"<ul> <li><code>$@</code>\uff1a\u8868\u793a\u89c4\u5219\u4e2d\u7684\u76ee\u6807\u6587\u4ef6\u540d</li> <li><code>$&lt;</code>\uff1a\u8868\u793a\u89c4\u5219\u4e2d\u7684\u7b2c\u4e00\u4e2a\u4f9d\u8d56\u6587\u4ef6\u540d</li> <li><code>$^</code>\uff1a\u8868\u793a\u89c4\u5219\u4e2d\u7684\u6240\u6709\u4f9d\u8d56\u6587\u4ef6\u540d</li> </ul> Makefile<pre><code>hello: hello.o\n    $(CC) -o $@ $^\nhello.o: hello.c\n    $(CC) -c $&lt; $(CFLAGS)\n</code></pre>"},{"location":"ctf/c_s0/#_11","title":"\u6a21\u677f","text":"Makefile<pre><code>SRC_DIR = ./src\nBUILD_DIR = ./build\nTARGET = $(BUILD_DIR)/world.out\n\nCC = cc\nCFLAGS = -Wall\n\n# ./src/*.c\nSRCS = $(shell find $(SRC_DIR) -name '*.c')\n# ./src/*.c =&gt; ./build/*.o\nOBJS = $(patsubst $(SRC_DIR)/%.c,$(BUILD_DIR)/%.o,$(SRCS))\n# ./src/*.c =&gt; ./build/*.d\nDEPS = $(patsubst $(SRC_DIR)/%.c,$(BUILD_DIR)/%.d,$(SRCS))\n\n# \u9ed8\u8ba4\u76ee\u6807:\nall: $(TARGET)\n\n# build/xyz.d \u7684\u89c4\u5219\u7531 src/xyz.c \u751f\u6210:\n$(BUILD_DIR)/%.d: $(SRC_DIR)/%.c\n    @mkdir -p $(dir $@); \\\n    rm -f $@; \\\n    $(CC) -MM $&lt; &gt;$@.tmp; \\\n    sed 's,\\($*\\)\\.o[ :]*,$(BUILD_DIR)/\\1.o $@ : ,g' &lt; $@.tmp &gt; $@; \\\n    rm -f $@.tmp\n\n# build/xyz.o \u7684\u89c4\u5219\u7531 src/xyz.c \u751f\u6210:\n$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c\n    @mkdir -p $(dir $@)\n    $(CC) $(CFLAGS) -c -o $@ $&lt;\n\n# \u94fe\u63a5:\n$(TARGET): $(OBJS)\n    @echo \"buiding $@...\"\n    @mkdir -p $(dir $@)\n    $(CC) -o $(TARGET) $(OBJS)\n\n# \u6e05\u7406 build \u76ee\u5f55:\nclean:\n    @echo \"clean...\"\n    rm -rf $(BUILD_DIR)\n\n# \u5f15\u5165\u6240\u6709 .d \u6587\u4ef6:\n-include $(DEPS)\n</code></pre>"},{"location":"ctf/env/","title":"\u7b2c\u4e00\u6b21\u8bfe","text":""},{"location":"ctf/env/#_2","title":"\u5199\u5728\u524d\u9762","text":"<p>\u8bfe\u7a0b\u4e3b\u8981\u8d77\u5f15\u5bfc\u4f5c\u7528\uff0c\u6587\u6863\u4e2d\u7ed9\u51fa\u7684\u94fe\u63a5\u5e76\u4e0d\u662f\u552f\u4e00\u9009\u62e9\uff0c\u4e14\u7531\u4e8e\u4e0d\u540c\u4eba\u7684\u673a\u5668\u73af\u5883\u4e0d\u540c\uff0c\u7ed9\u51fa\u7684\u94fe\u63a5\u5e76\u4e0d\u4e00\u5b9a\u80fd\u8fd0\u884c\u5728\u6240\u6709\u4eba\u7684\u673a\u5668\u4e0a\u3002</p> <p>\u4ee5\u53ca\uff0c\u8bfe\u7a0b\u9f13\u52b1\u5927\u5bb6\u81ea\u884c\u63a2\u7d22\uff0c\u4e0d\u8981\u5c40\u9650\u4e8e\u6587\u6863\u4e2d\u7ed9\u51fa\u7684\u5185\u5bb9\u3002</p> <p>\u8003\u8651\u5230\u4e0d\u662f\u6240\u6709\u4eba\u90fd\u53ef\u4ee5\u8fdb\u884c\u79d1\u5b66\u4e0a\u7f51\uff0c\u6545\u8fd9\u91cc\u627e\u7684\u6559\u7a0b\u5747\u4e3a\u56fd\u5185\u6559\u7a0b</p>"},{"location":"ctf/env/#_3","title":"\u73af\u5883\u5b89\u88c5","text":""},{"location":"ctf/env/#ubuntu-2204-vmware-workstation-17-pro","title":"Ubuntu 22.04 + VMware WorkStation 17 Pro","text":"<p>VMware \u5b89\u88c5\u914d\u7f6e Ubuntu</p>"},{"location":"ctf/env/#ubuntu-2204-apt","title":"Ubuntu 22.04 Apt\u6362\u6e05\u534e/\u963f\u91cc\u6e90","text":"<p>\u544a\u522b\u4e0b\u8f7d\u901f\u5ea6\u6162\u6162\u7684Apt\uff0c\u88c5Ubuntu\u7684\u8981\u4e8b\u4e4b\u4e00\uff08\u867d\u7136\u4f46\u662f\u6709\u4e9b\u65f6\u5019\u4e0d\u914d\u7f6e\u4e5f\u95ee\u9898\u4e0d\u5927\uff09</p> <p>Ubuntu 22.04\uff0c\u628a\u8f6f\u4ef6\u66f4\u65b0\u6e90\u66f4\u6539\u4e3a\u963f\u91cc\u6216\u8005\u6e05\u534e\u955c\u50cf</p>"},{"location":"ctf/env/#ubuntu-2204-ssh","title":"Ubuntu 22.04 \u5b89\u88c5 SSH","text":"<p>\u8bbf\u95eeLinux\u865a\u62df\u673a\u7684\u57fa\u672c\u59ff\u52bf\u4e4b\u4e00\uff1aSSH</p> <p>Ubuntu 22.04\u5b89\u88c5\u5e76\u542f\u7528OpenSSH</p>"},{"location":"ctf/env/#vscode-ssh-ubuntu-2204","title":"VScode SSH \u94fe\u63a5 Ubuntu 22.04","text":"<p>VsCode\u4f7f\u7528ssh\u8fde\u63a5Ubuntu\uff08\u5e76\u5b9e\u73b0\u514d\u5bc6\u8fde\u63a5\uff09</p>"},{"location":"ctf/env/#ubuntu-2204-samba","title":"\uff08\u53ef\u9009\uff09Ubuntu 22.04 \u914d\u7f6e Samba","text":"<p>Windows\u4e0eLinux\u5efa\u7acb\u5171\u4eab\u6587\u4ef6\u5939\u7684\u65b9\u6cd5\u4e4b\u4e00\uff1aSamba</p> <p>Ubuntu 22.04 \u6dfb\u52a0samba\uff0c\u5e76\u5728windows\u8bbf\u95ee</p>"},{"location":"ctf/env/#vscode-cc","title":"VScode \u914d\u7f6eC/C++\u73af\u5883","text":"<p>gcc \u7f16\u8bd1\u5668\uff0cgdb \u8c03\u8bd5\u5668\u7684\u5b89\u88c5 Bash<pre><code>sudo apt install gcc gdb\n</code></pre> VScode \u8fdc\u7a0bSSH\u94fe\u63a5\u5e76\u914d\u7f6eC/C++</p>"},{"location":"ctf/env/#gdb","title":"\uff08\u53ef\u9009\uff09GDB\u6269\u5c55\u5b89\u88c5","text":"<p>GEF\u548cPwndbg\u6bd4\u8f83\u63a8\u8350</p> <p>\u63a8\u8350\u51e0\u4e2a\u597d\u7528\u7684GDB\u56fe\u5f62\u5316\u529f\u80fd\u589e\u5f3a\u63d2\u4ef6</p>"},{"location":"ctf/env/#vscode-python","title":"VScode \u914d\u7f6ePython\u73af\u5883","text":"<p>vscode ssh\u8fdc\u7a0b\u8fde\u63a5\u670d\u52a1\u5668\u3001\u8c03\u8bd5python\u4ee3\u7801</p> <p>(\u6b64\u7bc7\u6559\u7a0b\u57fa\u672c\u770b\u5b8c\u5b89\u88c5\u6269\u5c55\u5c31\u53ef\u4ee5\u7ed3\u675f\u4e86\uff08\u81f3\u5c11\u5728\u6211\u8fd9\u8fb9\u673a\u5668\u4e0a\u6211\u80fd\u76f4\u63a5\u770b\u5230\u4e00\u4e2aPython Debugger\u7684\u8fd0\u884c\u914d\u7f6e\uff09)</p>"},{"location":"ctf/env/#vscode-github-copilot","title":"\uff08\u53ef\u9009\uff09VScode \u914d\u7f6eGithub Copilot","text":"<p>\u53cc\u56e0\u7d20\u8ba4\u8bc1\u662fGithub\u5b66\u751f\u8ba4\u8bc1\u7684\u524d\u63d0\uff0c\u4e0d\u505a\u4f1a\u5bfc\u81f4\u5b66\u751f\u8ba4\u8bc1\u5931\u8d25</p> <p>Github \u53cc\u56e0\u7d20\u8ba4\u8bc1</p> <p>Github \u5b66\u751f\u8ba4\u8bc1</p> <p>Github Copilot + VScode</p>"},{"location":"os/","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<p>Clone\u81eagithub\u9879\u76eexv6-riscv-book-Chinese</p> Bash<pre><code>git clone https://github.com/zhenyu-zang/xv6-riscv-book-Chinese\n</code></pre> <p>\u672c\u9879\u76ee\u662fMIT 6.S081\u4e0e6.828\u8bfe\u7a0b\u7528\u4e66xv6-riscv-book\u7684\u4e2d\u6587\u7ffb\u8bd1\u3002 \u6b64\u7248\u7ffb\u8bd1\u57fa\u4e8exv6-book-2020-Chinese\u4fee\u6539\u4e0e\u6821\u5bf9\u5b8c\u6210\uff0c\u5168\u90e8\u5185\u5bb9\u8f6c\u4e3aMarkdown\u683c\u5f0f\u3002</p>"},{"location":"os/Chapter-1/","title":"Chapter 1","text":""},{"location":"os/Chapter-1/#_1","title":"\u7b2c\u4e00\u7ae0\uff1a\u64cd\u4f5c\u7cfb\u7edf\u63a5\u53e3","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u7684\u5de5\u4f5c\u662f\u5c06\u8ba1\u7b97\u673a\u7684\u8d44\u6e90\u5728\u591a\u4e2a\u7a0b\u5e8f\u95f4\u5171\u4eab\uff0c\u5e76\u4e14\u7ed9\u7a0b\u5e8f\u63d0\u4f9b\u4e00\u7cfb\u5217\u6bd4\u786c\u4ef6\u672c\u8eab\u652f\u6301\u7684\u66f4\u6709\u7528\u7684\u670d\u52a1\u3002\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u5e76\u62bd\u8c61\u5e95\u5c42\u786c\u4ef6\uff0c\u56e0\u6b64\uff0c\u4e3e\u4f8b\u6765\u8bf4\uff0c\u4e00\u4e2a\u6587\u5b57\u5904\u7406\u7a0b\u5e8f\u4e0d\u9700\u8981\u53bb\u5173\u5fc3\u81ea\u5df1\u4f7f\u7528\u7684\u662f\u4f55\u79cd\u786c\u76d8\u3002\u64cd\u4f5c\u7cfb\u7edf\u8fd8\u5bf9\u786c\u4ef6\u8fdb\u884c\u591a\u8def\u590d\u7528\uff0c\u4f7f\u591a\u4e2a\u7a0b\u5e8f\u53ef\u4ee5\u540c\u65f6\u8fd0\u884c\u7684(\u6216\u8005\u770b\u8d77\u6765\u662f\u540c\u65f6\u8fd0\u884c)\u3002\u6700\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4e00\u79cd\u53ef\u63a7\u7684\u4ea4\u4e92\u65b9\u5f0f\uff0c\u4f7f\u5f97\u591a\u4e2a\u7a0b\u5e8f\u53ef\u4ee5\u5171\u4eab\u6570\u636e\uff0c\u5171\u540c\u5de5\u4f5c\u3002</p> <p>\u200b    \u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7\u63a5\u53e3\u5411\u7528\u6237\u7a0b\u5e8f\u63d0\u4f9b\u670d\u52a1\u3002\u8bbe\u8ba1\u4e00\u4e2a\u597d\u7684\u63a5\u53e3\u5b9e\u9645\u4e0a\u662f\u5f88\u56f0\u96be\u7684\u3002\u4e00\u65b9\u9762\uff0c\u6211\u4eec\u5e0c\u671b\u63a5\u53e3\u7b80\u5355\u548c\u7cbe\u51c6\uff0c\u8fd9\u6837\u5b83\u5c31\u5bb9\u6613\u6b63\u786e\u5730\u5b9e\u73b0\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u6211\u4eec\u53ef\u80fd\u53c8\u60f3\u4e3a\u5e94\u7528\u63d0\u4f9b\u8bb8\u591a\u66f4\u52a0\u590d\u6742\u7684\u529f\u80fd\u3002\u89e3\u51b3\u8fd9\u79cd\u77db\u76fe\u7684\u8bc0\u7a8d\u662f\u8ba9\u63a5\u53e3\u7684\u8bbe\u8ba1\u4f9d\u8d56\u4e8e\u4e00\u4e9b*\u673a\u5236* (mechanism)\uff0c\u5e76\u901a\u8fc7\u8fd9\u4e9b\u673a\u5236\u7684\u7ec4\u5408\u6765\u63d0\u4f9b\u901a\u7528\u6027\u3002</p> <p>\u200b    \u672c\u4e66\u4ee5\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u6765\u8bf4\u660e\u64cd\u4f5c\u7cfb\u7edf\u7684\u6982\u5ff5\u3002\u8fd9\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662fxv6\uff0c\u5b83\u63d0\u4f9b\u4e86\u5728Ken Thompson\u548cDennis Ritchie\u7684Unix\u64cd\u4f5c\u7cfb\u7edf[14]\u4e2d\u5f15\u5165\u7684\u57fa\u672c\u63a5\u53e3\uff0c\u540c\u65f6\u4e5f\u6a21\u4eff\u4e86Unix\u7684\u5185\u90e8\u8bbe\u8ba1\u3002Unix\u63d0\u4f9b\u4e86\u4e00\u4e2a\u673a\u5236\u7ec4\u5408\u5f97\u975e\u5e38\u826f\u597d\u7684\u7a84\u63a5\u53e3\uff0c\u5177\u6709\u60ca\u4eba\u7684\u901a\u7528\u6027\u3002\u8fd9\u6837\u7684\u63a5\u53e3\u8bbe\u8ba1\u975e\u5e38\u6210\u529f\uff0c\u8fd9\u4e5f\u4f7f\u5f97BSD\uff0cLinux\uff0cMac OS X\uff0cSolaris\u8fd9\u6837\u7684\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\uff0c\u751a\u81f3Windows\u90fd\u6709\u7c7b\u4f3cUnix\u7684\u63a5\u53e3\u3002\u7406\u89e3xv6\u662f\u7406\u89e3\u8fd9\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e00\u4e2a\u826f\u597d\u8d77\u70b9\u3002</p> <p>\u200b    \u5982\u56fe1.1\u6240\u793a\uff0cxv6\u4f7f\u7528\u4e86\u4f20\u7edf\u5f62\u5f0f\u7684**\u5185\u6838**\u2014\u2014\u4e00\u4e2a\u5411\u5176\u4ed6\u8fd0\u884c\u4e2d\u7684\u7a0b\u5e8f\u63d0\u4f9b\u670d\u52a1\u7684\u7279\u6b8a\u7a0b\u5e8f\u3002\u6bcf\u4e00\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\uff08\u79f0\u4e3a**\u8fdb\u7a0b**\uff09\uff0c\u90fd\u62e5\u6709\u81ea\u5df1\u7684\u5305\u542b\u6307\u4ee4\u3001\u6570\u636e\u3001\u6808\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u6307\u4ee4\u5b9e\u73b0\u7a0b\u5e8f\u7684\u8fd0\u7b97\uff0c\u6570\u636e\u662f\u7528\u4e8e\u8fd0\u7b97\u8fc7\u7a0b\u7684\u53d8\u91cf\uff0c\u6808\u5219\u7ba1\u7406\u7a0b\u5e8f\u7684\u8fc7\u7a0b\u8c03\u7528\u3002\u4e00\u53f0\u8ba1\u7b97\u673a\u901a\u5e38\u6709\u8bb8\u591a\u8fdb\u7a0b\uff0c\u4f46\u53ea\u6709\u4e00\u4e2a\u5185\u6838\u3002</p> <p></p> <p>\u200b    \u5f53\u4e00\u4e2a\u8fdb\u7a0b\u9700\u8981\u8c03\u7528\u4e00\u4e2a\u5185\u6838\u670d\u52a1\u65f6\uff0c\u5b83\u5c31\u4f1a\u8c03\u7528**\u7cfb\u7edf\u8c03\u7528**\uff0c\u8fd9\u662f\u64cd\u4f5c\u7cfb\u7edf\u63a5\u53e3\u4e2d\u7684\u4e00\u4e2a\u8c03\u7528\u3002\u7cfb\u7edf\u8c03\u7528\u4f1a\u8fdb\u5165\u5185\u6838\uff0c\u8ba9\u5185\u6838\u6267\u884c\u670d\u52a1\u7136\u540e\u8fd4\u56de\u3002\u6240\u4ee5\u8fdb\u7a0b\u4f1a\u5728\u7528\u6237\u7a7a\u95f4\u548c\u5185\u6838\u7a7a\u95f4\u4e4b\u95f4\u4ea4\u66ff\u8fd0\u884c\u3002</p> <p>\u200b    \u5185\u6838\u4f7f\u7528CPU[1]\u63d0\u4f9b\u7684\u786c\u4ef6\u4fdd\u62a4\u673a\u5236\u6765\u786e\u4fdd\u5728\u7528\u6237\u7a7a\u95f4\u4e2d\u6267\u884c\u7684\u6bcf\u4e2a\u8fdb\u7a0b\u53ea\u80fd\u8bbf\u95ee\u81ea\u5df1\u7684\u5185\u5b58\u3002\u5185\u6838\u8fd0\u884c\u65f6\u62e5\u6709\u786c\u4ef6\u7279\u6743\uff0c\u53ef\u4ee5\u8bbf\u95ee\u8fd9\u4e9b\u53d7\u5230\u4fdd\u62a4\u7684\u8d44\u6e90\uff0c\u800c\u7528\u6237\u7a0b\u5e8f\u8fd0\u884c\u65f6\u5219\u6ca1\u6709\u8fd9\u4e9b\u7279\u6743\u3002\u5f53\u7528\u6237\u7a0b\u5e8f\u8c03\u7528\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u786c\u4ef6\u63d0\u9ad8\u7279\u6743\u7ea7\u522b\u5e76\u5f00\u59cb\u6267\u884c\u5185\u6838\u4e2d\u9884\u5b9a\u4e49\u7684\u51fd\u6570\u3002</p> <p>\u5185\u6838\u63d0\u4f9b\u7684\u7cfb\u7edf\u8c03\u7528\u96c6\u5408\u5c31\u662f\u7528\u6237\u7a0b\u5e8f\u53ef\u89c1\u7684\u63a5\u53e3\u3002xv6\u5185\u6838\u63d0\u4f9b\u4e86\u4f20\u7edfUnix\u5185\u6838\u6240\u63d0\u4f9b\u7684\u670d\u52a1\u548c\u7cfb\u7edf\u8c03\u7528\u7684\u4e00\u4e2a\u5b50\u96c6\u3002\u56fe1.2\u5217\u51fa\u4e86xv6\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528\u3002</p> \u7cfb\u7edf\u8c03\u7528 \u63cf\u8ff0 int fork() \u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684PID\u3002 int exit(int status) \u7ec8\u6b62\u5f53\u524d\u8fdb\u7a0b\uff0c\u5e76\u5c06status\u4f20\u9012\u7ed9wait()\u3002\u4e0d\u4f1a\u8fd4\u56de\u3002 int wait(int *status) \u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff0c\u5e76\u5c06status\u63a5\u6536\u5230\u53c2\u6570*status\u4e2d\uff0c\u8fd4\u56de\u5176PID\u3002 int kill(int pid) \u7ec8\u6b62\u7ed9\u5b9aPID\u7684\u8fdb\u7a0b\uff0c\u6210\u529f\u8fd4\u56de0\uff0c\u5931\u8d25\u8fd4\u56de-1\u3002 int getpid() \u8fd4\u56de\u5f53\u524d\u8fdb\u7a0b\u7684PID\u3002 int sleep(int n) \u7761\u7720n\u4e2a\u65f6\u949f\u5468\u671f\u3002 int exec(char *file, char *argv[]) \u901a\u8fc7\u7ed9\u5b9a\u53c2\u6570\u52a0\u8f7d\u5e76\u6267\u884c\u4e00\u4e2a\u6587\u4ef6\uff1b\u53ea\u5728\u9519\u8bef\u65f6\u8fd4\u56de\u3002 char *sbrk(int n) \u4f7f\u8fdb\u7a0b\u5185\u5b58\u589e\u52a0n\u5b57\u8282\uff0c\u8fd4\u56de\u65b0\u5185\u5b58\u7684\u8d77\u59cb\u5730\u5740\u3002 int open(char *file, int flags) \u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\uff0cflags\u8868\u793a\u8bfb\u6216\u5199\uff0c\u8fd4\u56defd\uff08\u6587\u4ef6\u63cf\u8ff0\u7b26\uff09\u3002 int write(int fd, char *buf, int n) \u5c06buf\u4e2dn\u5b57\u8282\u5199\u5165\u5230\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e2d\uff1b\u8fd4\u56den\u3002 int read(int fd, char *buf, int n) \u4ece\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e2d\u8bfb\u53d6n\u5b57\u8282\u5230buf\uff1b\u8fd4\u56de\u8bfb\u53d6\u5b57\u8282\u6570\uff0c\u6587\u4ef6\u7ed3\u675f\u8fd4\u56de0\u3002 int close(int fd) \u91ca\u653e\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u3002 int dup(int fd) \u8fd4\u56de\u4e00\u4e2a\u65b0\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5176\u5f15\u7528\u4e0efd\u76f8\u540c\u7684\u6587\u4ef6\u3002 int pipe(int p[]) \u521b\u5efa\u7ba1\u9053\uff0c\u5c06\u8bfb/\u5199\u6587\u4ef6\u63cf\u8ff0\u7b26\u653e\u7f6e\u5728p[0]\u548cp[1]\u3002 int chdir(char *dir) \u6539\u53d8\u5f53\u524d\u76ee\u5f55\u3002 int mkdir(char *dir) \u521b\u5efa\u65b0\u76ee\u5f55\u3002 int mknod(char *file, int, int) \u521b\u5efa\u65b0\u8bbe\u5907\u6587\u4ef6\u3002 int fstat(int fd, struct stat *st) \u5c06\u6253\u5f00\u7684\u6587\u4ef6\u7684\u4fe1\u606f\u653e\u7f6e\u5728*st\u4e2d\u3002 int stat(char *file, struct stat *st) \u5c06\u547d\u540d\u6587\u4ef6\u4fe1\u606f\u653e\u7f6e\u5728*st\u4e2d\u3002 int link(char *file1, char * file2) \u4e3a\u6587\u4ef6file1\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u540d\u79f0(file2)\u3002 int unlink(char *file) \u79fb\u9664\u4e00\u4e2a\u6587\u4ef6\u3002 <p>\u56fe1.2  xv6\u7cfb\u7edf\u8c03\u7528. \u5982\u679c\u6ca1\u6709\u7279\u522b\u8bf4\u660e, \u8fd9\u4e9b\u8c03\u7528\u6210\u529f\u65f6\u8fd4\u56de0\uff0c\u5931\u8d25\u65f6\u8fd4\u56de-1\u3002</p> <p>\u200b    </p> <p>\u200b    \u672c\u7ae0\u5269\u4e0b\u7684\u90e8\u5206\u6982\u8ff0\u4e86xv6\u7684\u670d\u52a1\u7684\u6982\u8c8c\u2014\u2014\u8fdb\u7a0b\u3001\u5185\u5b58\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u7ba1\u9053\u548c\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u901a\u8fc7\u4ee3\u7801\u7247\u6bb5\u5bf9\u5176\u8fdb\u884c\u4e86\u8bf4\u660e\uff0c\u7136\u540e\u8ba8\u8bba\u4e86**shell**\uff08Unix\u7684\u547d\u4ee4\u884c\u7528\u6237\u63a5\u53e3\uff09\u4e2d\u662f\u5982\u4f55\u4f7f\u7528\u5b83\u4eec\u7684\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u5728shell\u4e2d\u7684\u5e94\u7528\u8bf4\u660e\u4e86\u7cfb\u7edf\u8c03\u7528\u7684\u8bbe\u8ba1\u5982\u4f55\u7cbe\u5de7\u3002</p> <p>\u200b    shell\u662f\u4e00\u4e2a\u666e\u901a\u7684\u7a0b\u5e8f\uff0c\u5b83\u4ece\u7528\u6237\u8bfb\u53d6\u547d\u4ee4\u5e76\u6267\u884c\u5b83\u4eec\u3002shell\u662f\u4e00\u4e2a\u7528\u6237\u7a0b\u5e8f\uff0c\u800c\u4e0d\u662f\u5185\u6838\u7684\u4e00\u90e8\u5206\uff0c\u8fd9\u4e00\u4e8b\u5b9e\u8bf4\u660e\u4e86\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u7684\u5f3a\u5927\uff1ashell\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u4e4b\u5904\u3002\u8fd9\u4e5f\u610f\u5473\u7740shell\u662f\u5f88\u5bb9\u6613\u88ab\u66ff\u6362\u7684;\u56e0\u6b64\uff0c\u4e8b\u5b9e\u4e0a\u73b0\u4ee3Unix\u7cfb\u7edf\u4e2d\u6709\u5404\u79cd\u5404\u6837\u7684shell\uff0c\u6bcf\u4e2a\u90fd\u6709\u81ea\u5df1\u7684\u7528\u6237\u754c\u9762\u548c\u811a\u672c\u7279\u6027\u3002xv6 shell\u662fUnix Bourne shell\u7684\u4e00\u4e2a\u7b80\u5355\u5b9e\u73b0\u3002\u5b83\u7684\u5b9e\u73b0\u53ef\u4ee5\u5728\uff08<code>user/sh.c:1</code>\uff09\u627e\u5230\u3002</p>"},{"location":"os/Chapter-1/#11-processes-and-memory11","title":"1.1 Processes and memory[1.1 \u8fdb\u7a0b\u548c\u5185\u5b58]","text":"<p>\u4e00\u4e2axv6\u8fdb\u7a0b\u7531\u7528\u6237\u7a7a\u95f4\u5185\u5b58\uff08\u6307\u4ee4\u3001\u6570\u636e\u548c\u5806\u6808\uff09\u548c\u5185\u6838\u79c1\u6709\u7684\u8fdb\u7a0b\u72b6\u6001\u7ec4\u6210\u3002Xv6\u5bf9\u8fdb\u7a0b\u63d0\u4f9b**\u5206\u65f6**\u7279\u6027\uff1a\u5b83\u900f\u660e\u5730\u5207\u6362\u5f53\u524dcpu\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\u3002\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u6682\u65f6\u4e0d\u4f7f\u7528cpu\u65f6\uff0cxv6\u4f1a\u4fdd\u5b58\u5b83\u7684CPU\u5bc4\u5b58\u5668\uff0c\u5728\u4e0b\u6b21\u8fd0\u884c\u8be5\u8fdb\u7a0b\u65f6\u6062\u590d\u5b83\u4eec\u3002\u5185\u6838\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u5173\u8054\u4e00\u4e2a**PID**(\u8fdb\u7a0b\u6807\u8bc6\u7b26)\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528**fork**\u7cfb\u7edf\u8c03\u7528\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u3002fork**\u521b\u5efa\u7684\u65b0\u8fdb\u7a0b\u88ab\u79f0\u4e3a**\u5b50\u8fdb\u7a0b\uff0c\u5176\u5185\u5b58\u5185\u5bb9\u4e0e\u8c03\u7528\u7684\u8fdb\u7a0b\u5b8c\u5168\u76f8\u540c\uff0c\u539f\u8fdb\u7a0b\u88ab\u79f0\u4e3a**\u7236\u8fdb\u7a0b**\u3002\u5728\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u4e2d\uff0cfork\u90fd\u4f1a\u8fd4\u56de\u3002\u5728\u7236\u8fdb\u7a0b\u4e2d\uff0cfork\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684PID\uff1b\u5728\u5b50\u8fdb\u7a0b\u4e2d\uff0cfork\u8fd4\u56de0\u3002\u4f8b\u5982\uff0c\u8003\u8651\u4ee5\u4e0b\u7528C\u7f16\u7a0b\u8bed\u8a00\u7f16\u5199\u7684\u7a0b\u5e8f\u7247\u6bb5[6]\u3002</p> C<pre><code>int* pid = fork();\nif (pid &gt; 0)\n{\n    printf(\"parent: child=%d\\n\", pid);\n    pid = wait((*int* *)0);\n    printf(\"child %d is done\\n\", pid);\n}\nelse if (pid == 0)\n{\n    printf(\"child: exiting\\n\");\n    exit(0);\n}\nelse\n{\n    printf(\"fork error\\n\");\n}\n</code></pre> <p>\u200b    **exit**\u7cfb\u7edf\u8c03\u7528\u4f1a\u4f7f\u5f97\u8c03\u7528\u5b83\u7684\u8fdb\u7a0b\u9000\u51fa\uff0c\u5e76\u91ca\u653e\u8d44\u6e90\uff0c\u4f8b\u5982\u5185\u5b58\u548c\u6253\u5f00\u7684\u6587\u4ef6\u3002**exit**\u9700\u8981\u4e00\u4e2a\u6574\u6570\u72b6\u6001\u53c2\u6570\uff0c\u901a\u5e380\u8868\u793a\u6210\u529f\uff0c1\u8868\u793a\u5931\u8d25\u3002**wait**\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\u5f53\u524d\u8fdb\u7a0b\u7684\u4e00\u4e2a\u5df2\u9000\u51fa\uff08\u6216\u88ab\u6740\u6b7b\uff09\u7684\u5b50\u8fdb\u7a0b\u7684PID\uff0c\u5e76\u5c06\u8be5\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u72b6\u6001\u7801\u590d\u5236\u5230\u4e00\u4e2a\u5730\u5740\uff0c\u8be5\u5730\u5740\u7531wait\u53c2\u6570\u63d0\u4f9b\uff1b\u5982\u679c\u8c03\u7528\u8005\u7684\u5b50\u8fdb\u7a0b\u90fd\u6ca1\u6709\u9000\u51fa\uff0c\u5219**wait**\u7b49\u5f85\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u9000\u51fa\u3002\u5982\u679c\u8c03\u7528\u8005\u6ca1\u6709\u5b50\u8fdb\u7a0b\uff0cwait\u7acb\u5373\u8fd4\u56de-1\u3002\u5982\u679c\u7236\u8fdb\u7a0b\u4e0d\u5173\u5fc3\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u72b6\u6001\uff0c\u53ef\u4ee5\u4f20\u9012\u4e00\u4e2a0\u5730\u5740\u7ed9wait\u3002</p> <p>\u200b    \u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u8f93\u51fa\u4e3a:</p> Text Only<pre><code>parent: child=1234\nchild: exiting\n</code></pre> <p>\u53ef\u80fd\u4f1a\u4ee5\u4efb\u4f55\u4e00\u79cd\u987a\u5e8f\u8f93\u51fa\uff0c\u8fd9\u53d6\u51b3\u4e8e\u662f\u7236\u8fdb\u7a0b\u8fd8\u662f\u5b50\u8fdb\u7a0b\u5148\u6267\u884c\u5b83\u7684**printf**\u8c03\u7528\u3002\u5728\u5b50\u7a0b\u5e8f\u9000\u51fa\u540e\uff0c\u7236\u8fdb\u7a0b\u7684**wait**\u8fd4\u56de\uff0c\u7236\u8fdb\u7a0b\u6253\u5370\uff1a</p> Text Only<pre><code>child 1234 is done\n</code></pre> <p>\u867d\u7136\u5b50\u8fdb\u7a0b\u6700\u521d\u4e0e\u7236\u8fdb\u7a0b\u62e5\u6709\u76f8\u540c\u7684\u5185\u5b58\u5185\u5bb9\uff0c\u4f46\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u662f\u5728\u4e0d\u540c\u7684\u5185\u5b58\u548c\u4e0d\u540c\u7684\u5bc4\u5b58\u5668\u4e2d\u6267\u884c\u7684\uff1a\u6539\u53d8\u5176\u4e2d\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\u7684\u53d8\u91cf\u4e0d\u4f1a\u5f71\u54cd\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002\u4f8b\u5982\uff0c\u5f53**wait**\u7684\u8fd4\u56de\u503c\u5b58\u50a8\u5230\u7236\u8fdb\u7a0b\u7684**pid**\u53d8\u91cf\u4e2d\u65f6\uff0c\u5e76\u4e0d\u4f1a\u6539\u53d8\u5b50\u8fdb\u7a0b\u4e2d\u7684\u53d8\u91cf**pid**\u3002\u5b50\u8fdb\u7a0b\u4e2d\u7684**pid**\u503c\u4ecd\u7136\u4e3a\u96f6\u3002</p> <p>**exec**\u7cfb\u7edf\u8c03\u7528\u4f7f\u7528\u65b0\u5185\u5b58\u6620\u50cf\u6765\u66ff\u6362\u8fdb\u7a0b\u7684\u5185\u5b58\uff0c \u65b0\u5185\u5b58\u6620\u50cf\u4ece\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u6587\u4ef6\u4e2d\u8fdb\u884c\u8bfb\u53d6\u3002\u8fd9\u4e2a\u6587\u4ef6\u5fc5\u987b\u6709\u7279\u5b9a\u7684\u683c\u5f0f\uff0c\u5b83\u6307\u5b9a\u4e86\u6587\u4ef6\u4e2d\u54ea\u90e8\u5206\u5b58\u653e\u6307\u4ee4\uff0c\u54ea\u90e8\u5206\u662f\u6570\u636e\uff0c\u5728\u54ea\u6761\u6307\u4ee4\u5f00\u59cb\uff0c\u7b49\u7b49\u3002xv6\u4f7f\u7528ELF\u683c\u5f0f\uff0c\u7b2c3\u7ae0\u5c06\u8be6\u7ec6\u8ba8\u8bba\u3002\u5f53**exec**\u6210\u529f\u65f6\uff0c\u5b83\u5e76\u4e0d\u8fd4\u56de\u5230\u8c03\u7528\u7a0b\u5e8f\uff1b\u76f8\u53cd\uff0c\u4ece\u6587\u4ef6\u4e2d\u52a0\u8f7d\u7684\u6307\u4ee4\u5728ELF\u5934\u58f0\u660e\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u6267\u884c\u3002**exec**\u9700\u8981\u4e24\u4e2a\u53c2\u6570\uff1a\u5305\u542b\u53ef\u6267\u884c\u6587\u4ef6\u7684\u6587\u4ef6\u540d\u548c\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570\u6570\u7ec4\u3002\u4f8b\u5982\uff1a</p> C<pre><code>char* *argv[3];\nargv[0] = \"echo\";\nargv[1] = \"hello\";\nargv[2] = 0;\nexec(\"/bin/echo\", argv);\nprintf(\"exec error\\n\");\n</code></pre> <p>\u4e0a\u8ff0\u4ee3\u7801\u4f1a\u6267\u884c/bin/echo\u7a0b\u5e8f\uff0c\u5e76\u5c06argv\u6570\u7ec4\u4f5c\u4e3a\u53c2\u6570\u3002\u5927\u591a\u6570\u7a0b\u5e8f\u90fd\u4f1a\u5ffd\u7565\u53c2\u6570\u6570\u7ec4\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u4e5f\u5c31\u662f\u7a0b\u5e8f\u540d\u79f0\u3002</p> <p>xv6 shell\u4f7f\u7528\u4e0a\u8ff0\u8c03\u7528\u6765\u5728\u7528\u6237\u7a7a\u95f4\u8fd0\u884c\u7a0b\u5e8f\u3002shell\u7684\u4e3b\u7ed3\u6784\u5f88\u7b80\u5355\uff0c\u53c2\u89c1**main**(user/sh.c:145)\u3002\u4e3b\u5faa\u73af\u7528**getcmd**\u8bfb\u53d6\u7528\u6237\u7684\u4e00\u884c\u8f93\u5165\uff0c\u7136\u540e\u8c03\u7528**fork**\uff0c\u521b\u5efashell\u526f\u672c\u3002\u7236\u8fdb\u7a0b\u8c03\u7528wait\uff0c\u800c\u5b50\u8fdb\u7a0b\u5219\u8fd0\u884c\u547d\u4ee4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7528\u6237\u5411shell\u8f93\u5165\u4e86**echo hello**\uff0c\u90a3\u4e48\u5c31\u4f1a\u8c03\u7528**runcmd**\uff0c\u53c2\u6570\u4e3a**echo hello**\u3002runcmd (user/sh.c:58) \u8fd0\u884c\u5b9e\u9645\u7684\u547d\u4ee4\u3002\u5bf9\u4e8e**echo hello**\uff0c\u5b83\u4f1a\u8c03\u7528**exec** (user/sh.c:78)\u3002\u5982\u679c**exec**\u6210\u529f\uff0c\u90a3\u4e48\u5b50\u8fdb\u7a0b\u5c06\u6267\u884cecho\u7a0b\u5e8f\u7684\u6307\u4ee4\uff0c\u800c\u4e0d\u662f**runcmd**\u7684\u3002\u5728\u67d0\u4e9b\u65f6\u5019\uff0cecho**\u4f1a\u8c03\u7528**exit\uff0c\u8fd9\u5c06\u4f7f\u7236\u7a0b\u5e8f\u4ecemain(user/sh.c:145)\u4e2d\u7684**wait**\u8fd4\u56de\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u5947\u602a\u4e3a\u4ec0\u4e48**fork**\u548c**exec**\u6ca1\u6709\u7ed3\u5408\u5728\u4e00\u6b21\u8c03\u7528\u4e2d\uff0c\u6211\u4eec\u540e\u9762\u4f1a\u770b\u5230shell\u5728\u5b9e\u73b0I/O\u91cd\u5b9a\u5411\u65f6\u5229\u7528\u4e86\u8fd9\u79cd\u5206\u79bb\u7684\u7279\u6027\u3002\u4e3a\u4e86\u907f\u514d\u521b\u5efa\u76f8\u540c\u8fdb\u7a0b\u5e76\u7acb\u5373\u66ff\u6362\u5b83\uff08\u4f7f\u7528exec\uff09\u6240\u5e26\u6765\u7684\u6d6a\u8d39\uff0c\u5185\u6838\u901a\u8fc7\u4f7f\u7528\u865a\u62df\u5185\u5b58\u6280\u672f\uff08\u5982copy-on-write\uff09\u6765\u4f18\u5316\u8fd9\u79cd\u7528\u4f8b\u7684fork\u5b9e\u73b0\uff08\u89c14.6\u8282\uff09\u3002</p> <p>Xv6\u9690\u5f0f\u5206\u914d\u5927\u90e8\u5206\u7528\u6237\u7a7a\u95f4\u5185\u5b58\uff1afork**\u590d\u5236\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u5230\u5b50\u8fdb\u7a0b\uff0c**exec**\u5206\u914d\u8db3\u591f\u7684\u5185\u5b58\u6765\u5bb9\u7eb3\u53ef\u6267\u884c\u6587\u4ef6\u3002\u4e00\u4e2a\u8fdb\u7a0b\u5982\u679c\u5728\u8fd0\u884c\u65f6\u9700\u8981\u66f4\u591a\u7684\u5185\u5b58\uff08\u53ef\u80fd\u662f\u4e3a\u4e86**malloc\uff09\uff0c\u53ef\u4ee5\u8c03\u7528sbrk(n)\u5c06\u5176\u6570\u636e\u5185\u5b58\u589e\u957fn\u4e2a\u5b57\u8282\uff1bsbrk\u8fd4\u56de\u65b0\u5185\u5b58\u7684\u4f4d\u7f6e\u3002</p>"},{"location":"os/Chapter-1/#12-io-and-file-descriptors12-io","title":"1.2 I/O and File descriptors[1.2 I/O \u548c\u6587\u4ef6\u63cf\u8ff0\u7b26]","text":"<p>\u6587\u4ef6\u63cf\u8ff0\u7b26**\u662f\u4e00\u4e2a\u5c0f\u6574\u6570\uff0c\u4ee3\u8868\u4e00\u4e2a\u53ef\u7531\u8fdb\u7a0b\u8bfb\u53d6\u6216\u5199\u5165\u7684\u5185\u6838\u7ba1\u7406\u5bf9\u8c61\u3002\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u3001\u76ee\u5f55\u3001\u8bbe\u5907\uff0c\u6216\u8005\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u7ba1\u9053\uff0c\u6216\u8005\u901a\u8fc7\u590d\u5236\u4e00\u4e2a\u73b0\u6709\u7684\u63cf\u8ff0\u7b26\u6765\u83b7\u5f97\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u901a\u5e38\u5c06\u6587\u4ef6\u63cf\u8ff0\u7b26\u6240\u6307\u5411\u7684\u5bf9\u8c61\u79f0\u4e3a\u6587\u4ef6\uff1b\u6587\u4ef6\u63cf\u8ff0\u7b26\u63a5\u53e3\u5c06\u6587\u4ef6\u3001\u7ba1\u9053\u548c\u8bbe\u5907\u4e4b\u95f4\u7684\u5dee\u5f02\u62bd\u8c61\u5316\uff0c\u4f7f\u5b83\u4eec\u770b\u8d77\u6765\u90fd\u50cf\u5b57\u8282\u6d41\u3002\u6211\u4eec\u628a\u8f93\u5165\u548c\u8f93\u51fa\u79f0\u4e3a**I/O\u3002</p> <p>\u5728\u5185\u90e8\uff0cxv6\u5185\u6838\u4e3a\u6bcf\u4e00\u4e2a\u8fdb\u7a0b\u5355\u72ec\u7ef4\u62a4\u4e00\u4e2a\u4ee5\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e3a\u7d22\u5f15\u7684\u8868\uff0c\u56e0\u6b64\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u4ece0\u5f00\u59cb\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u79c1\u6709\u7a7a\u95f4\u3002\u6309\u7167\u7ea6\u5b9a\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u4ece\u6587\u4ef6\u63cf\u8ff0\u7b260(\u6807\u51c6\u8f93\u5165)\u8bfb\u53d6\u6570\u636e\uff0c\u5411\u6587\u4ef6\u63cf\u8ff0\u7b261(\u6807\u51c6\u8f93\u51fa)\u5199\u5165\u8f93\u51fa\uff0c\u5411\u6587\u4ef6\u63cf\u8ff0\u7b262(\u6807\u51c6\u9519\u8bef)\u5199\u5165\u9519\u8bef\u4fe1\u606f\u3002\u6b63\u5982\u6211\u4eec\u5c06\u770b\u5230\u7684\u90a3\u6837\uff0cshell\u5229\u7528\u8fd9\u4e2a\u7ea6\u5b9a\u6765\u5b9e\u73b0I/O\u91cd\u5b9a\u5411\u548c\u7ba1\u9053\u3002shell\u786e\u4fdd\u81ea\u5df1\u603b\u662f\u6709\u4e09\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u6253\u5f00\uff08user/sh.c:151\uff09\uff0c\u8fd9\u4e9b\u6587\u4ef6\u63cf\u8ff0\u7b26\u9ed8\u8ba4\u662f\u63a7\u5236\u53f0\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002</p> <p>read/**write**\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u4ece\u6587\u4ef6\u63cf\u8ff0\u7b26\u6307\u5411\u7684\u6587\u4ef6\u8bfb\u5199\u6570\u636e\u3002\u8c03\u7528**read(fd, buf, n)**\u4ece\u6587\u4ef6\u63cf\u8ff0\u7b26**fd**\u4e2d\u8bfb\u53d6\u4e0d\u8d85\u8fc7**n**\u4e2a\u5b57\u8282\u7684\u6570\u636e\uff0c\u5c06\u5b83\u4eec\u590d\u5236\u5230**buf**\u4e2d\uff0c\u5e76\u8fd4\u56de\u8bfb\u53d6\u7684\u5b57\u8282\u6570\u3002\u6bcf\u4e2a\u5f15\u7528\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u90fd\u6709\u4e00\u4e2a\u4e0e\u4e4b\u76f8\u5173\u5173\u8054\u504f\u79fb\u91cf\u3002**read**\u4ece\u5f53\u524d\u6587\u4ef6\u504f\u79fb\u91cf\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u7136\u540e\u6309\u8bfb\u53d6\u7684\u5b57\u8282\u6570\u63a8\u8fdb\u504f\u79fb\u91cf\uff0c\u968f\u540e\u7684**read**\u5c06\u8fd4\u56de\u4e0a\u6b21\u8bfb\u53d6\u4e4b\u540e\u7684\u6570\u636e\u3002\u5f53\u6ca1\u6709\u66f4\u591a\u7684\u5b57\u8282\u53ef\u8bfb\u65f6\uff0c\u8bfb\u8fd4\u56de\u96f6\uff0c\u8868\u793a\u6587\u4ef6\u7ed3\u675f\u3002</p> <p>**write(fd, buf, n)**\u8868\u793a\u5c06**buf**\u4e2d\u7684**n**\u4e2a\u5b57\u8282\u5199\u5165\u6587\u4ef6\u63cf\u8ff0\u7b26**fd**\u4e2d\uff0c\u5e76\u8fd4\u56de\u5199\u5165\u7684\u5b57\u8282\u6570\u3002\u82e5\u5199\u5165\u5b57\u8282\u6570\u5c0f\u4e8en\u5219\u8be5\u6b21\u5199\u5165\u53d1\u751f\u9519\u8bef\u3002\u548c**read**\u4e00\u6837\uff0c**write**\u5728\u5f53\u524d\u6587\u4ef6\u504f\u79fb\u91cf\u5904\u5199\u5165\u6570\u636e\uff0c\u7136\u540e\u6309\u5199\u5165\u7684\u5b57\u8282\u6570\u5c06\u504f\u79fb\u91cf\u5411\u524d\u63a8\u8fdb\uff1a\u6bcf\u6b21**write**\u90fd\u4ece\u4e0a\u4e00\u6b21\u5199\u5165\u7684\u5730\u65b9\u5f00\u59cb\u3002</p> <p>\u4e0b\u9762\u7684\u7a0b\u5e8f\u7247\u6bb5(\u7a0b\u5e8f**cat**\u7684\u6838\u5fc3\u4ee3\u7801)\u5c06\u6570\u636e\u4ece\u5176\u6807\u51c6\u8f93\u5165\u590d\u5236\u5230\u5176\u6807\u51c6\u8f93\u51fa\u3002\u5982\u679c\u51fa\u73b0\u9519\u8bef\uff0c\u5b83\u4f1a\u5411\u6807\u51c6\u9519\u8bef\u5199\u5165\u4e00\u6761\u6d88\u606f\u3002</p> C<pre><code>char buf[512];\nint n;\nfor (;;)\n{\n    n = read(0, buf, sizeof buf);\n    if (n == 0)\n        break;\n    if (n &lt; 0)\n    {\n        fprintf(2, \"read error\\n\");\n        exit(1);\n    }\n    if (write(1, buf, n) != n)\n    {\n        fprintf(2, \"write error\\n\");\n        exit(1);\n    }\n}\n</code></pre> <p>\u5728\u8fd9\u4e2a\u4ee3\u7801\u7247\u6bb5\u4e2d\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c**cat**\u4e0d\u77e5\u9053\u5b83\u662f\u4ece\u6587\u4ef6\u3001\u63a7\u5236\u53f0\u8fd8\u662f\u7ba1\u9053\u4e2d\u8bfb\u53d6\u7684\u3002\u540c\u6837\uff0c**cat**\u4e5f\u4e0d\u77e5\u9053\u5b83\u662f\u5728\u6253\u5370\u5230\u63a7\u5236\u53f0\u3001\u6587\u4ef6\u8fd8\u662f\u5176\u4ed6\u4ec0\u4e48\u5730\u65b9\u3002\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u4f7f\u7528\u548c0\u4ee3\u8868\u8f93\u5165\uff0c1\u4ee3\u8868\u8f93\u51fa\u7684\u7ea6\u5b9a\uff0c\u4f7f\u5f97**cat**\u53ef\u4ee5\u5f88\u5bb9\u6613\u5b9e\u73b0\u3002</p> <p>close**\u7cfb\u7edf\u8c03\u7528\u4f1a\u91ca\u653e\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f7f\u5b83\u53ef\u4ee5\u88ab\u4ee5\u540e\u7684**open\u3001**pipe**\u6216**dup**\u7cfb\u7edf\u8c03\u7528\u6240\u91cd\u7528\uff08\u89c1\u4e0b\u6587\uff09\u3002\u65b0\u5206\u914d\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u603b\u662f\u5f53\u524d\u8fdb\u7a0b\u4e2d\u6700\u5c0f\u7684\u672a\u4f7f\u7528\u63cf\u8ff0\u7b26\u3002</p> <p>\u6587\u4ef6\u63cf\u8ff0\u7b26\u548c**fork**\u76f8\u4e92\u4f5c\u7528\uff0c\u4f7fI/O\u91cd\u5b9a\u5411\u6613\u4e8e\u5b9e\u73b0\u3002**fork**\u5c06\u7236\u8fdb\u7a0b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\u548c\u5b83\u7684\u5185\u5b58\u4e00\u8d77\u590d\u5236\uff0c\u8fd9\u6837\u5b50\u8fdb\u7a0b\u5f00\u59cb\u65f6\u6253\u5f00\u7684\u6587\u4ef6\u548c\u7236\u8fdb\u7a0b\u5b8c\u5168\u4e00\u6837\u3002\u7cfb\u7edf\u8c03\u7528**exec**\u66ff\u6362\u8c03\u7528\u8fdb\u7a0b\u7684\u5185\u5b58\uff0c\u4f46\u4f1a\u4fdd\u7559\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\u3002\u8fd9\u79cd\u884c\u4e3a\u5141\u8bb8shell\u901a\u8fc7**fork**\u5b9e\u73b0I/O\u91cd\u5b9a\u5411\uff0c\u5728\u5b50\u8fdb\u7a0b\u4e2d\u91cd\u65b0\u6253\u5f00\u6240\u9009\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u7136\u540e\u8c03\u7528**exec**\u8fd0\u884c\u65b0\u7a0b\u5e8f\u3002\u4e0b\u9762\u662fshell\u8fd0\u884c**cat &lt; input.txt**\u547d\u4ee4\u7684\u7b80\u5316\u7248\u4ee3\u7801\u3002</p> C<pre><code>char *argv[2];\nargv[0] = \"cat\";\nargv[1] = 0;\nif (fork() == 0)\n{\n    close(0);  // \u91ca\u653e\u6807\u51c6\u8f93\u5165\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\n    open(\"input.txt\", O_RDONLY);  // \u8fd9\u65f6input.txt\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e3a0\n    // \u5373\u6807\u51c6\u8f93\u5165\u4e3ainput.txt\n    exec(\"cat\", argv);  // cat\u4ece0\u8bfb\u53d6\uff0c\u5e76\u8f93\u51fa\u52301\uff0c\u89c1\u4e0a\u4e2a\u4ee3\u7801\u6bb5\n}\n</code></pre> <p>\u5728\u5b50\u8fdb\u7a0b\u5173\u95ed\u6587\u4ef6\u63cf\u8ff0\u7b260\u540e\uff0copen**\u4fdd\u8bc1\u5bf9\u65b0\u6253\u5f00\u7684**input.txt**\u4f7f\u7528\u8be5\u6587\u4ef6\u63cf\u8ff0\u7b260\u3002\u56e0\u4e3a\u6b64\u65f60\u5c06\u662f\u6700\u5c0f\u7684\u53ef\u7528\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u7136\u540e**cat**\u6267\u884c\u65f6\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b260\uff08\u6807\u51c6\u8f93\u5165\uff09\u4f1a\u6307\u5411**input.txt\u3002\u8fd9\u4e0d\u4f1a\u6539\u53d8\u7236\u8fdb\u7a0b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5b83\u53ea\u4f1a\u4fee\u6539\u5b50\u8fdb\u7a0b\u7684\u63cf\u8ff0\u7b26\u3002</p> <p>xv6 shell\u4e2d\u7684I/O\u91cd\u5b9a\u5411\u4ee3\u7801\u6b63\u662f\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u5de5\u4f5c\u7684\uff08user/sh.c:82\uff09\u3002\u56de\u60f3\u4e00\u4e0bshell\u7684\u4ee3\u7801\uff0cshell\u5df2\u7ecf**fork**\u5b50shell\uff0c**runcmd**\u5c06\u8c03\u7528**exec**\u6765\u52a0\u8f7d\u65b0\u7684\u7a0b\u5e8f\u3002</p> <p>open**\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u7531\u4e00\u7ec4\u7528\u4f4d\u8868\u793a\u7684\u6807\u5fd7\u7ec4\u6210\uff0c\u7528\u6765\u63a7\u5236**open**\u7684\u5de5\u4f5c\u3002\u53ef\u80fd\u7684\u503c\u5728\u6587\u4ef6\u63a7\u5236(fcntl)\u5934(kernel/fcntl.h:1-5)\u4e2d\u5b9a\u4e49\u3002**O_RDONLY, O_WRONLY, O_RDWR, O_CREATE, \u548c O_TRUNC, \u5b83\u4eec\u5206\u522b\u6307\u5b9aopen\u6253\u5f00\u6587\u4ef6\u65f6\u7684\u529f\u80fd\uff0c\u8bfb\u3001\u5199\u3001\u8bfb\u548c\u5199\u3001\u5982\u679c\u6587\u4ef6\u4e0d\u5b58\u5728\u5219\u521b\u5efa\u6587\u4ef6\u3001\u5c06\u6587\u4ef6\u957f\u5ea6\u622a\u65ad\u4e3a0\u3002</p> <p>\u73b0\u5728\u5e94\u8be5\u6e05\u695a\u4e3a\u4ec0\u4e48**fork**\u548c**exec**\u662f\u5206\u5f00\u8c03\u7528\u7684\uff1a\u5728\u8fd9\u4e24\u4e2a\u8c03\u7528\u4e4b\u95f4\uff0cshell\u6709\u673a\u4f1a\u91cd\u5b9a\u5411\u5b50\u8fdb\u7a0b\u7684I/O\uff0c\u800c\u4e0d\u5e72\u6270\u7236\u8fdb\u7a0b\u7684I/O\u8bbe\u7f6e\u3002\u6211\u4eec\u53ef\u4ee5\u5047\u8bbe\u4e00\u4e2a\u7531**fork**\u548c**exec**\u7ec4\u6210\u7684\u7cfb\u7edf\u8c03\u7528**forkexec**\uff0c\u4f46\u662f\u7528\u8fd9\u79cd\u8c03\u7528\u6765\u505aI/O\u91cd\u5b9a\u5411\u4f3c\u4e4e\u5f88\u7b28\u62d9\u3002shell\u5728\u8c03\u7528**forkexec**\u4e4b\u524d\u4fee\u6539\u81ea\u5df1\u7684I/O\u8bbe\u7f6e\uff08\u7136\u540e\u53d6\u6d88\u8fd9\u4e9b\u4fee\u6539\uff09\uff0c\u6216\u8005**forkexec**\u53ef\u4ee5\u5c06I/O\u91cd\u5b9a\u5411\u7684\u6307\u4ee4\u4f5c\u4e3a\u53c2\u6570\uff0c\u6216\u8005\uff08\u6700\u7cdf\u7cd5\u7684\u65b9\u6848\uff09\u6bcf\u4e2a\u7a0b\u5e8f\uff08\u6bd4\u5982cat\uff09\u90fd\u9700\u8981\u81ea\u5df1\u505aI/O\u91cd\u5b9a\u5411\u3002</p> <p>\u867d\u7136**fork**\u590d\u5236\u4e86\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\uff0c\u4f46\u6bcf\u4e2a\u5e95\u5c42\u6587\u4ef6\u7684\u504f\u79fb\u91cf\u90fd\u662f\u7236\u5b50\u5171\u4eab\u7684\u3002\u60f3\u4e00\u60f3\u4e0b\u9762\u7684\u4ee3\u7801\u3002</p> C<pre><code> if (fork() == 0)\n {\n     write(1, \"hello \", 6);\n     exit(0);\n }\nelse\n{\n    wait(0);\n    write(1, \"world\\n\", 6);\n}\n</code></pre> <p>\u5728\u8fd9\u4e2a\u7247\u6bb5\u7684\u6700\u540e\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b261\u6240\u5f15\u7528\u7684\u6587\u4ef6\u5c06\u5305\u542b\u6570\u636ehello world\u3002\u7236\u8fdb\u7a0b\u4e2d\u7684**write**\uff08\u7531\u4e8e\u6709\u4e86**wait**\uff0c\u53ea\u6709\u5728\u5b50\u8fdb\u7a0b\u7ed3\u675f\u540e\u624d\u4f1a\u8fd0\u884c\uff09\u4f1a\u4ece\u5b50\u8fdb\u7a0b\u7684**write**\u7ed3\u675f\u7684\u5730\u65b9\u5f00\u59cb\u3002\u8fd9\u79cd\u884c\u4e3a\u6709\u52a9\u4e8e\u4eceshell\u547d\u4ee4\u7684\u5e8f\u5217\u4e2d\u4ea7\u751f\u6709\u5e8f\u7684\u8f93\u51fa\uff0c\u6bd4\u5982**(echo hello; echo world) &gt;output.txt**\u3002</p> <p>**dup**\u7cfb\u7edf\u8c03\u7528\u590d\u5236\u4e00\u4e2a\u73b0\u6709\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u63cf\u8ff0\u7b26\uff0c\u5b83\u6307\u5411\u540c\u4e00\u4e2a\u5e95\u5c42I/O\u5bf9\u8c61\u3002\u4e24\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u5171\u4eab\u4e00\u4e2a\u504f\u79fb\u91cf\uff0c\u5c31\u50cf\u88ab**fork**\u590d\u5236\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e00\u6837\u3002\u8fd9\u662f\u5c06hello world\u5199\u8fdb\u6587\u4ef6\u7684\u53e6\u4e00\u79cd\u65b9\u6cd5\u3002</p> C<pre><code>fd = dup(1);\nwrite(1, \"hello \", 6);\nwrite(fd, \"world\\n\", 6);\n</code></pre> <p>\u5982\u679c\u4e24\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u662f\u901a\u8fc7\u4e00\u7cfb\u5217\u7684**fork**\u548c**dup**\u8c03\u7528\u4ece\u540c\u4e00\u4e2a\u539f\u59cb\u6587\u4ef6\u63cf\u8ff0\u7b26\u884d\u751f\u51fa\u6765\u7684\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u5171\u4eab\u4e00\u4e2a\u504f\u79fb\u91cf\u3002\u5426\u5219\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0d\u5171\u4eab\u504f\u79fb\u91cf\uff0c\u5373\u4f7f\u5b83\u4eec\u662f\u7531\u540c\u4e00\u4e2a\u6587\u4ef6\u7684\u6253\u5f00\u8c03\u7528\u4ea7\u751f\u7684\u3002dup**\u5141\u8bb8shell\u5b9e\u73b0\u8fd9\u6837\u7684\u547d\u4ee4\uff1al**s existing-file non-existing-file &gt; tmp1 2&gt;&amp;1\u30022&gt;&amp;1\u8868\u793a2\u662f1\u7684\u590d\u5236\uff08dup(1)\uff09\uff0c\u5373\u91cd\u5b9a\u5411\u9519\u8bef\u4fe1\u606f\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u5df2\u5b58\u5728\u6587\u4ef6\u7684\u540d\u79f0\u548c\u4e0d\u5b58\u5728\u6587\u4ef6\u7684\u9519\u8bef\u4fe1\u606f\u90fd\u4f1a\u663e\u793a\u5728\u6587\u4ef6tmp1\u4e2d\u3002xv6 shell\u4e0d\u652f\u6301\u9519\u8bef\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684I/O\u91cd\u5b9a\u5411\uff0c\u4f46\u73b0\u5728\u4f60\u77e5\u9053\u5982\u4f55\u5b9e\u73b0\u5b83\u4e86\u3002</p> <p>\u6587\u4ef6\u63cf\u8ff0\u7b26\u662f\u4e00\u4e2a\u5f3a\u5927\u7684\u62bd\u8c61\uff0c\u56e0\u4e3a\u5b83\u4eec\u9690\u85cf\u4e86\u5b83\u4eec\u8fde\u63a5\u7684\u7ec6\u8282\uff1a\u4e00\u4e2a\u5411\u6587\u4ef6\u63cf\u8ff0\u7b261\u5199\u5165\u7684\u8fdb\u7a0b\u53ef\u80fd\u662f\u5728\u5411\u4e00\u4e2a\u6587\u4ef6\u3001\u63a7\u5236\u53f0\u7b49\u8bbe\u5907\u6216\u5411\u4e00\u4e2a\u7ba1\u9053\u5199\u5165\u3002</p>"},{"location":"os/Chapter-1/#13-pipes13","title":"1.3 Pipes[1.3 \u7ba1\u9053]","text":"<p>**\u7ba1\u9053**\u662f\u4e00\u4e2a\u5c0f\u7684\u5185\u6838\u7f13\u51b2\u533a\uff0c\u4f5c\u4e3a\u4e00\u5bf9\u6587\u4ef6\u63cf\u8ff0\u7b26\u63d0\u4f9b\u7ed9\u8fdb\u7a0b\uff0c\u4e00\u4e2a\u7528\u4e8e\u8bfb\uff0c\u4e00\u4e2a\u7528\u4e8e\u5199\u3002\u5c06\u6570\u636e\u5199\u5165\u7ba1\u9053\u7684\u4e00\u7aef\u5c31\u53ef\u4ee5\u4ece\u7ba1\u9053\u7684\u53e6\u4e00\u7aef\u8bfb\u53d6\u6570\u636e\u3002\u7ba1\u9053\u4e3a\u8fdb\u7a0b\u63d0\u4f9b\u4e86\u4e00\u79cd\u901a\u4fe1\u65b9\u5f0f\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u4ee3\u7801\u8fd0\u884c\u7a0b\u5e8fwc\uff0c\u6807\u51c6\u8f93\u5165\u8fde\u63a5\u5230\u7ba1\u9053\u7684\u8bfb\u53d6\u7aef\u3002</p> C<pre><code>int p[2];\nchar *argv[2];\nargv[0] = \"wc\";\nargv[1] = 0;\npipe(p);\nif (fork() == 0)\n{\n    close(0);  // \u91ca\u653e\u6587\u4ef6\u63cf\u8ff0\u7b260\n    dup(p[0]); // \u590d\u5236\u4e00\u4e2ap[0](\u7ba1\u9053\u8bfb\u7aef)\uff0c\u6b64\u65f6\u6587\u4ef6\u63cf\u8ff0\u7b260\uff08\u6807\u51c6\u8f93\u5165\uff09\u4e5f\u5f15\u7528\u7ba1\u9053\u8bfb\u7aef\uff0c\u6545\u6539\u53d8\u4e86\u6807\u51c6\u8f93\u5165\u3002\n    close(p[0]);\n    close(p[1]);\n    exec(\"/bin/wc\", argv); // wc \u4ece\u6807\u51c6\u8f93\u5165\u8bfb\u53d6\u6570\u636e\uff0c\u5e76\u5199\u5165\u5230\u53c2\u6570\u4e2d\u7684\u6bcf// \u4e00\u4e2a\u6587\u4ef6\n}\nelse\n{\n    close(p[0]);\n    write(p[1], \"hello world\\n\", 12);\n    close(p[1]);\n}\n</code></pre> <p>\u7a0b\u5e8f\u8c03\u7528**pipe**\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7ba1\u9053\uff0c\u5e76\u5c06\u8bfb\u5199\u6587\u4ef6\u63cf\u8ff0\u7b26\u8bb0\u5f55\u5728\u6570\u7ec4**p**\u4e2d\uff0c\u7ecf\u8fc7**fork**\u540e\uff0c\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u90fd\u6307\u5411\u7ba1\u9053\u3002\u5b50\u8fdb\u7a0b\u8c03\u7528**close**\u548c**dup**\u4f7f\u6587\u4ef6\u63cf\u8ff0\u7b260\u5f15\u7528\u7ba1\u9053\u7684\u8bfb\u7aef\uff0c\u5e76\u5173\u95edp\u4e2d\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5e76\u8c03\u7528**exec**\u8fd0\u884c**wc**\u3002\u5f53**wc**\u4ece\u5176\u6807\u51c6\u8f93\u5165\u7aef\u8bfb\u53d6\u65f6\uff0c\u5b83\u5c06\u4ece\u7ba1\u9053\u4e2d\u8bfb\u53d6\u3002\u7236\u8fdb\u7a0b\u5173\u95ed\u7ba1\u9053\u7684\u8bfb\u7aef\uff0c\u5411\u7ba1\u9053\u5199\u5165\uff0c\u7136\u540e\u5173\u95ed\u5199\u7aef\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u6570\u636e\u53ef\u7528\uff0c\u7ba1\u9053\u4e0a\u7684**read**\u4f1a\u7b49\u5f85\u6570\u636e\u88ab\u5199\u5165\uff0c\u6216\u8005\u7b49\u5f85\u6240\u6709\u6307\u5411\u5199\u7aef\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u88ab\u5173\u95ed\uff1b\u5728\u540e\u4e00\u79cd\u60c5\u51b5\u4e0b\uff0c\u8bfb\u5c06\u8fd4\u56de0\uff0c\u5c31\u50cf\u6570\u636e\u6587\u4ef6\u7684\u7ed3\u675f\u4e00\u6837\u3002\u4e8b\u5b9e\u4e0a\uff0c\u5982\u679c\u6ca1\u6709\u6570\u636e\u5199\u5165\uff0c\u8bfb\u4f1a\u65e0\u9650\u963b\u585e\uff0c\u76f4\u5230\u65b0\u6570\u636e\u4e0d\u53ef\u80fd\u5230\u8fbe\u4e3a\u6b62\uff08\u5199\u7aef\u88ab\u5173\u95ed\uff09\uff0c\u8fd9\u4e5f\u662f\u5b50\u8fdb\u7a0b\u5728\u6267\u884c\u4e0a\u9762\u7684**wc**\u4e4b\u524d\u5173\u95ed\u7ba1\u9053\u7684\u5199\u7aef\u5f88\u91cd\u8981\u7684\u4e00\u4e2a\u539f\u56e0\uff1a\u5982\u679cwc\u7684\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u4ecd\u7136\u5f15\u7528\u4e86\u7ba1\u9053\u7684\u5199\u7aef\uff0c\u90a3\u4e48**wc**\u5c06\u6c38\u8fdc\u770b\u4e0d\u5230\u6587\u4ef6\u7684\u5173\u95ed\uff08\u88ab\u81ea\u5df1\u963b\u585e\uff09\u3002</p> <p>xv6\u7684shell\u5b9e\u73b0\u4e86\u7ba1\u9053\uff0c\u5982**grep fork sh.c | wc -l**\uff0cshell\u7684\u5b9e\u73b0\u7c7b\u4f3c\u4e8e\u4e0a\u9762\u7684\u4ee3\u7801\uff08user/sh.c:100\uff09\u3002\u6267\u884cshell\u7684\u5b50\u8fdb\u7a0b\u521b\u5efa\u4e00\u4e2a\u7ba1\u9053\u6765\u8fde\u63a5\u7ba1\u9053\u7684\u5de6\u7aef\u548c\u53f3\u7aef\uff08\u53bb\u770b\u6e90\u7801\uff0c\u4e0d\u770b\u96be\u61c2\uff09\u3002\u7136\u540e\uff0c\u5b83\u5728\u7ba1\u9053\u5de6\u7aef\uff08\u5199\u5165\u7aef\uff09\u8c03\u7528**fork**\u548c**runcmd**\uff0c\u5728\u53f3\u7aef\uff08\u8bfb\u53d6\u7aef\uff09\u8c03\u7528**fork**\u548c**runcmd**\uff0c\u5e76\u7b49\u5f85\u4e24\u8005\u7ed3\u675f\u3002\u7ba1\u9053\u7684\u53f3\u7aef\uff08\u8bfb\u53d6\u7aef\uff09\u53ef\u4ee5\u662f\u4e00\u4e2a\u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u662f\u5305\u542b\u7ba1\u9053\u7684\u591a\u4e2a\u547d\u4ee4\uff08\u4f8b\u5982\uff0ca | b | c\uff09\uff0c\u5b83\u53c8\u4f1a\u5206\u53c9\u4e3a\u4e24\u4e2a\u65b0\u7684\u5b50\u8fdb\u7a0b\uff08\u4e00\u4e2a\u662f**b**\uff0c\u4e00\u4e2a\u662f**c**\uff09\u3002\u56e0\u6b64\uff0cshell\u53ef\u4ee5\u521b\u5efa\u4e00\u68f5\u8fdb\u7a0b\u6811\u3002\u8fd9\u68f5\u6811\u7684\u53f6\u5b50\u662f\u547d\u4ee4\uff0c\u5185\u90e8\uff08\u975e\u53f6\u5b50\uff09\u8282\u70b9\u662f\u7b49\u5f85\u5de6\u53f3\u5b50\u8fdb\u7a0b\u7ed3\u675f\u7684\u8fdb\u7a0b\u3002</p> <p>\u539f\u5219\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba9\u5185\u90e8\u8282\u70b9\uff08\u975e\u53f6\u8282\u70b9\uff09\u8fd0\u884c\u7ba1\u9053\u7684\u5de6\u7aef\uff0c\u4f46\u8fd9\u6837\u7684\u5b9e\u73b0\u4f1a\u66f4\u52a0\u590d\u6742\u3002\u8003\u8651\u53ea\u505a\u4ee5\u4e0b\u4fee\u6539\uff1a\u4fee\u6539sh.c\uff0c\u4f7f\u5176\u4e0d\u4e3a**runcmd(p-&gt;left)**  fork\u8fdb\u7a0b\uff0c\u76f4\u63a5\u9012\u5f52\u8fd0\u884c**runcmd(p-&gt;left)\u3002\u50cf\u8fd9\u6837\uff0c**echo hi | wc**\u4e0d\u4f1a\u4ea7\u751f\u8f93\u51fa\uff0c\u56e0\u4e3a\u5f53**echo hi**\u5728**runcmd**\u4e2d\u9000\u51fa\u65f6\uff0c\u5185\u90e8\u8fdb\u7a0b\u4f1a\u9000\u51fa\uff0c\u800c\u4e0d\u4f1a\u8c03\u7528**fork**\u6765\u8fd0\u884c\u7ba1\u9053\u7684\u53f3\u7aef\u3002\u8fd9\u79cd\u4e0d\u6b63\u786e\u7684\u884c\u4e3a\u53ef\u4ee5\u901a\u8fc7\u4e0d\u5728**runcmd**\u4e2d\u4e3a\u5185\u90e8\u8fdb\u7a0b\u8c03\u7528**exit**\u6765\u4fee\u6b63\uff0c\u4f46\u662f\u8fd9\u79cd\u4fee\u6b63\u4f1a\u4f7f\u4ee3\u7801\u53d8\u5f97\u590d\u6742\uff1a**runcmd**\u9700\u8981\u77e5\u9053\u8be5\u8fdb\u7a0b\u662f\u5426\u662f\u5185\u90e8\u8fdb\u7a0b\uff08\u975e\u53f6\u8282\u70b9\uff09\u3002\u5f53\u4e0d\u4e3a**runcmd(p-&gt;right)  **fork**\u8fdb\u7a0b\u65f6\uff0c\u4e5f\u4f1a\u51fa\u73b0\u590d\u6742\u7684\u60c5\u51b5\u3002\u50cf\u8fd9\u6837\u7684\u4fee\u6539\uff0c**sleep 10 | echo hi**\u5c31\u4f1a\u7acb\u5373\u6253\u5370\u51fahi\uff0c\u800c\u4e0d\u662f10\u79d2\u540e\uff0c\u56e0\u4e3a**echo**\u4f1a\u7acb\u5373\u8fd0\u884c\u5e76\u9000\u51fa\uff0c\u800c\u4e0d\u662f\u7b49\u5f85**sleep**\u7ed3\u675f\u3002\u7531\u4e8esh.c\u7684\u76ee\u6807\u662f\u5c3d\u53ef\u80fd\u7684\u7b80\u5355\uff0c\u6240\u4ee5\u5b83\u5e76\u6ca1\u6709\u8bd5\u56fe\u907f\u514d\u521b\u5efa\u5185\u90e8\u8fdb\u7a0b\u3002</p> <p>\u7ba1\u9053\u4f3c\u4e4e\u6ca1\u6709\u6bd4\u4e34\u65f6\u6587\u4ef6\u62e5\u6709\u66f4\u591a\u7684\u529f\u80fd\uff1a</p> Bash<pre><code>echo hello world | wc\n</code></pre> <p>\u4e0d\u4f7f\u7528\u7ba1\u9053\uff1a</p> Bash<pre><code>echo hello world &gt;/tmp/xyz; wc &lt;/tmp/xyz\n</code></pre> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7ba1\u9053\u6bd4\u4e34\u65f6\u6587\u4ef6\u81f3\u5c11\u6709\u56db\u4e2a\u4f18\u52bf\u3002\u9996\u5148\uff0c\u7ba1\u9053\u4f1a\u81ea\u52a8\u6e05\u7406\u81ea\u5df1\uff1b\u5982\u679c\u662f\u6587\u4ef6\u91cd\u5b9a\u5411\uff0cshell\u5728\u5b8c\u6210\u540e\u5fc5\u987b\u5c0f\u5fc3\u5730\u5220\u9664/tmp/xyz\u3002\u7b2c\u4e8c\uff0c\u7ba1\u9053\u53ef\u4ee5\u4f20\u9012\u4efb\u610f\u957f\u7684\u6570\u636e\u6d41\uff0c\u800c\u6587\u4ef6\u91cd\u5b9a\u5411\u5219\u9700\u8981\u78c1\u76d8\u4e0a\u6709\u8db3\u591f\u7684\u7a7a\u95f2\u7a7a\u95f4\u6765\u5b58\u50a8\u6240\u6709\u6570\u636e\u3002\u7b2c\u4e09\uff0c\u7ba1\u9053\u53ef\u4ee5\u5206\u9636\u6bb5\u7684\u5e76\u884c\u6267\u884c\uff0c\u800c\u6587\u4ef6\u65b9\u5f0f\u5219\u9700\u8981\u5728\u7b2c\u4e8c\u4e2a\u7a0b\u5e8f\u5f00\u59cb\u4e4b\u524d\u5b8c\u6210\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\u3002\u7b2c\u56db\uff0c\u5982\u679c\u4f60\u8981\u5b9e\u73b0\u8fdb\u7a0b\u95f4\u7684\u901a\u4fe1\uff0c\u7ba1\u9053\u963b\u585e\u8bfb\u5199\u6bd4\u6587\u4ef6\u7684\u975e\u963b\u585e\u8bed\u4e49\u66f4\u6709\u6548\u7387\u3002</p>"},{"location":"os/Chapter-1/#14-file-system14","title":"1.4 File system[1.4 \u6587\u4ef6\u7cfb\u7edf]","text":"<p>xv6\u6587\u4ef6\u7cfb\u7edf\u5305\u542b\u4e86\u6570\u636e\u6587\u4ef6\uff08\u62e5\u6709\u5b57\u8282\u6570\u7ec4\uff09\u548c\u76ee\u5f55\uff08\u62e5\u6709\u5bf9\u6570\u636e\u6587\u4ef6\u548c\u5176\u4ed6\u76ee\u5f55\u7684\u547d\u540d\u5f15\u7528\uff09\u3002\u8fd9\u4e9b\u76ee\u5f55\u5f62\u6210\u4e00\u68f5\u6811\uff0c\u4ece\u4e00\u4e2a\u88ab\u79f0\u4e3a\u6839\u76ee\u5f55\u7684\u7279\u6b8a\u76ee\u5f55\u5f00\u59cb\u3002\u50cf**/a/b/c**\u8fd9\u6837\u7684\u8def\u5f84\u6307\u7684\u662f\u6839\u76ee\u5f55**/\u4e2d\u7684**a**\u76ee\u5f55\u4e2d\u7684**b**\u76ee\u5f55\u4e2d\u7684\u540d\u4e3a**c**\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u3002\u4e0d\u4ee5/**\u5f00\u5934\u7684\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u8c03\u7528\u8fdb\u7a0b\u7684\u5f53\u524d\u76ee\u5f55\u8fdb\u884c\u8ba1\u7b97\u5176\u7edd\u5bf9\u4f4d\u7f6e\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7**chdir**\u7cfb\u7edf\u8c03\u7528\u6765\u6539\u53d8\u8fdb\u7a0b\u7684\u5f53\u524d\u76ee\u5f55\u3002\u4e0b\u9762\u4e24\u4e2a**open**\u6253\u5f00\u4e86\u540c\u4e00\u4e2a\u6587\u4ef6\uff08\u5047\u8bbe\u6240\u6709\u6d89\u53ca\u7684\u76ee\u5f55\u90fd\u5b58\u5728\uff09\u3002</p> C<pre><code>chdir(\"/a\");\nchdir(\"b\");\nopen(\"c\", O_RDONLY);\nopen(\"/a/b/c\", O_RDONLY);\n</code></pre> <p>\u524d\u4e24\u884c\u5c06\u8fdb\u7a0b\u7684\u5f53\u524d\u76ee\u5f55\u6539\u4e3a**/a/b**\uff1b\u540e\u9762\u4e24\u884c\u65e2\u4e0d\u5f15\u7528\u4e5f\u4e0d\u6539\u53d8\u8fdb\u7a0b\u7684\u5f53\u524d\u76ee\u5f55\u3002</p> <p>\u6709\u4e00\u4e9b\u7cfb\u7edf\u8c03\u7528\u6765\u53ef\u4ee5\u521b\u5efa\u65b0\u7684\u6587\u4ef6\u548c\u76ee\u5f55\uff1a**mkdir**\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\uff0c\u7528**open**\u52a0\u4e0a**O_CREATE**\u6807\u5fd7\u521b\u5efa\u5e76\u6253\u5f00\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u6587\u4ef6\uff0c\u4ee5\u53ca**mknod**\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8bbe\u5907\u6587\u4ef6\u3002\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\u4e86\u8fd9\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528\u7684\u4f7f\u7528\u3002</p> C<pre><code>mkdir(\"/dir\");\nfd = open(\"/dir/file\", O_CREATE | O_WRONLY);\nclose(fd);\n\nmknod(\"/console\", 1, 1);\n</code></pre> <p>**mknod**\u521b\u5efa\u4e86\u4e00\u4e2a\u5f15\u7528\u8bbe\u5907\u7684\u7279\u6b8a\u6587\u4ef6\u3002\u4e0e\u8bbe\u5907\u6587\u4ef6\u76f8\u5173\u8054\u7684\u662f\u4e3b\u8981\u8bbe\u5907\u53f7\u548c\u6b21\u8981\u8bbe\u5907\u53f7(**mknod**\u7684\u4e24\u4e2a\u53c2\u6570)\uff0c\u5b83\u4eec\u552f\u4e00\u5730\u6807\u8bc6\u4e00\u4e2a\u5185\u6838\u8bbe\u5907\u3002\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u6253\u5f00\u8bbe\u5907\u6587\u4ef6\u540e\uff0c\u5185\u6838\u4f1a\u5c06\u7cfb\u7edf\u7684\u8bfb\u5199\u8c03\u7528\u8f6c\u79fb\u5230\u5185\u6838\u8bbe\u5907\u5b9e\u73b0\u4e0a\uff0c\u800c\u4e0d\u662f\u5c06\u5b83\u4eec\u4f20\u9012\u7ed9\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u6587\u4ef6\u540d\u79f0\u4e0e\u6587\u4ef6\u662f\u4e0d\u540c\u7684\uff1b\u5e95\u5c42\u6587\u4ef6\uff08\u975e\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\uff09\u88ab\u79f0\u4e3a**inode**\uff0c\u4e00\u4e2ainode\u53ef\u4ee5\u6709\u591a\u4e2a\u540d\u79f0\uff0c\u79f0\u4e3a**\u94fe\u63a5**\u3002\u6bcf\u4e2a\u94fe\u63a5\u7531\u76ee\u5f55\u4e2d\u7684\u4e00\u4e2a\u9879\u7ec4\u6210\uff1b\u8be5\u9879\u5305\u542b\u4e00\u4e2a\u6587\u4ef6\u540d\u548c\u5bf9inode\u7684\u5f15\u7528\u3002inode\u4fdd\u5b58\u7740\u4e00\u4e2a\u6587\u4ef6\u7684***metadata***\uff08\u5143\u6570\u636e\uff09\uff0c\u5305\u62ec\u5b83\u7684\u7c7b\u578b\uff08\u6587\u4ef6\u6216\u76ee\u5f55\u6216\u8bbe\u5907\uff09\uff0c\u5b83\u7684\u957f\u5ea6\uff0c\u6587\u4ef6\u5185\u5bb9\u5728\u78c1\u76d8\u4e0a\u7684\u4f4d\u7f6e\uff0c\u4ee5\u53ca\u6587\u4ef6\u7684\u94fe\u63a5\u6570\u91cf\u3002</p> <p>fstat**\u7cfb\u7edf\u8c03\u7528\u4ece\u6587\u4ef6\u63cf\u8ff0\u7b26\u5f15\u7528\u7684inode\u4e2d\u68c0\u7d22\u4fe1\u606f\u3002\u5b83\u5b9a\u4e49\u5728**stat.h (kernel/stat.h)\u7684 stat \u7ed3\u6784\u4e2d\uff1a</p> C<pre><code>#define T_DIR 1     // Directory\n#define T_FILE 2    // File\n#define T_DEVICE 3  // Device\nstruct stat\n{\n    int dev;        // File system\u2019s disk device\n    uint ino;       // Inode number\n    short type;     // Type of file\n    short nlink;    // Number of links to file\n    uint64 size;    // Size of file in bytes\n};\n</code></pre> <p>**link**\u7cfb\u7edf\u8c03\u7528\u521b\u5efa\u4e86\u4e00\u4e2a\u5f15\u7528\u4e86\u540c\u4e00\u4e2ainode\u7684\u6587\u4ef6\uff08\u6587\u4ef6\u540d\uff09\u3002\u4e0b\u9762\u7684\u7247\u6bb5\u521b\u5efa\u4e86\u5f15\u7528\u4e86\u540c\u4e00\u4e2ainode\u4e24\u4e2a\u6587\u4ef6a\u548cb\u3002</p> C<pre><code>open(\"a\", O_CREATE | O_WRONLY);\nlink(\"a\", \"b\");\n</code></pre> <p>\u8bfb\u5199a\u4e0e\u8bfb\u5199b\u662f\u4e00\u6837\u7684\uff0c\u6bcf\u4e2ainode\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684inode\u53f7\u6765\u6807\u8bc6\u3002\u7ecf\u8fc7\u4e0a\u9762\u7684\u4ee3\u7801\u5e8f\u5217\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5fstat\u7684\u7ed3\u679c\u6765\u786e\u5b9aa\u548cb\u6307\u7684\u662f\u540c\u4e00\u4e2a\u5e95\u5c42\u5185\u5bb9\uff1a\u4e24\u8005\u5c06\u8fd4\u56de\u76f8\u540c\u7684inode\u53f7\uff08ino\uff09\uff0c\u5e76\u4e14nlink\u8ba1\u6570\u4e3a2\u3002</p> <p>**unlink**\u7cfb\u7edf\u8c03\u7528\u4f1a\u4ece\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5220\u9664\u4e00\u4e2a\u6587\u4ef6\u540d\u3002\u53ea\u6709\u5f53\u6587\u4ef6\u7684\u94fe\u63a5\u6570\u4e3a\u96f6\u4e14\u6ca1\u6709\u6587\u4ef6\u63cf\u8ff0\u7b26\u5f15\u7528\u5b83\u65f6\uff0c\u6587\u4ef6\u7684inode\u548c\u5b58\u653e\u5176\u5185\u5bb9\u7684\u78c1\u76d8\u7a7a\u95f4\u624d\u4f1a\u88ab\u91ca\u653e\u3002</p> C<pre><code>unlink(\"a\");\n</code></pre> <p>\u4e0a\u9762\u8fd9\u884c\u4ee3\u7801\u4f1a\u5220\u9664a\uff0c\u6b64\u65f6\u53ea\u6709b\u4f1a\u5f15\u7528inode\u3002</p> C<pre><code>fd = open(\"/tmp/xyz\", O_CREATE | O_RDWR);\nunlink(\"/tmp/xyz\");\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u662f\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\u7684\u4e00\u79cd\u60ef\u7528\u65b9\u5f0f\uff0c\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u65e0\u540d\u79f0inode\uff0c\u6545\u4f1a\u5728\u8fdb\u7a0b\u5173\u95ed**fd**\u6216\u8005\u9000\u51fa\u65f6\u5220\u9664\u6587\u4ef6\u3002</p> <p>Unix\u63d0\u4f9b\u4e86shell\u53ef\u8c03\u7528\u7684\u6587\u4ef6\u64cd\u4f5c\u7a0b\u5e8f\uff0c\u4f5c\u4e3a\u7528\u6237\u7ea7\u7a0b\u5e8f\uff0c\u4f8b\u5982**mkdir**\u3001ln**\u548c**rm\u3002\u8fd9\u79cd\u8bbe\u8ba1\u5141\u8bb8\u4efb\u4f55\u4eba\u901a\u8fc7\u6dfb\u52a0\u65b0\u7684\u7528\u6237\u7ea7\u7a0b\u5e8f\u6765\u6269\u5c55\u547d\u4ee4\u884c\u63a5\u53e3\u3002\u73b0\u5728\u770b\u6765\uff0c\u8fd9\u4e2a\u8bbe\u8ba1\u4f3c\u4e4e\u662f\u663e\u800c\u6613\u89c1\u7684\uff0c\u4f46\u5728Unix\u65f6\u671f\u8bbe\u8ba1\u7684\u5176\u4ed6\u7cfb\u7edf\u901a\u5e38\u5c06\u8fd9\u7c7b\u547d\u4ee4\u5185\u7f6e\u5230shell\u4e2d\uff08\u5e76\u5c06shell\u5185\u7f6e\u5230\u5185\u6838\u4e2d\uff09\u3002</p> <p>\u6709\u4e00\u4e2a\u4f8b\u5916\uff0c\u90a3\u5c31\u662fcd\uff0c\u5b83\u662f\u5728shell\u4e2d\u5b9e\u73b0\u7684 (user/sh.c:160)\u3002cd \u5fc5\u987b\u6539\u53d8 shell \u81ea\u8eab\u7684\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679ccd\u4f5c\u4e3a\u4e00\u4e2a\u666e\u901a\u547d\u4ee4\u6267\u884c\uff0c\u90a3\u4e48shell\u5c31\u4f1afork\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u800c\u5b50\u8fdb\u7a0b\u4f1a\u8fd0\u884ccd\uff0ccd\u53ea\u4f1a\u6539\u53d8\u5b50\u8fdb\u7a0b\u7684\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u3002\u7236\u8fdb\u7a0b\uff08\u5373shell\uff09\u7684\u5de5\u4f5c\u76ee\u5f55\u5219\u4fdd\u6301\u4e0d\u53d8\u3002</p>"},{"location":"os/Chapter-1/#15-real-world15","title":"1.5 Real world[1.5 \u73b0\u5b9e\u60c5\u51b5]","text":"<p>Unix\u5c06\u6807\u51c6\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u7ba1\u9053\u548c\u65b9\u4fbf\u7684shell\u8bed\u6cd5\u7ed3\u5408\u8d77\u6765\u8fdb\u884c\u64cd\u4f5c\uff0c\u662f\u7f16\u5199\u901a\u7528\u53ef\u91cd\u7528\u7a0b\u5e8f\u7684\u4e00\u5927\u8fdb\u6b65\u3002\u8fd9\u4e2a\u60f3\u6cd5\u5f15\u53d1\u4e86\u4e00\u79cd\u201c\u8f6f\u4ef6\u5de5\u5177\u201d\u6587\u5316\uff0c\u8fd9\u4e5f\u662fUnix\u5f3a\u5927\u548c\u6d41\u884c\u7684\u4e3b\u8981\u539f\u56e0\uff0c\u800cshell\u662f\u7b2c\u4e00\u79cd\u6240\u8c13\u7684\u811a\u672c\u8bed\u8a00\u3002Unix\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u4eca\u5929\u4ecd\u7136\u5b58\u5728\u4e8eBSD\u3001Linux\u548cMac OS X\u7b49\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u3002</p> <p>Xv6\u5e76\u4e0d\u7b26\u5408 POSIX \u6807\u51c6\uff1a\u5b83\u7f3a\u5c11\u8bb8\u591a\u7cfb\u7edf\u8c03\u7528\uff08\u5305\u62ec\u57fa\u672c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u5982 lseek\uff09\uff0c\u800c\u4e14\u5b83\u63d0\u4f9b\u7684\u8bb8\u591a\u7cfb\u7edf\u8c03\u7528\u4e0e\u6807\u51c6\u4e0d\u540c\u3002\u6211\u4eec\u5bf9xv6\u7684\u4e3b\u8981\u76ee\u6807\u662f\u7b80\u5355\u660e\u4e86\uff0c\u540c\u65f6\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684\u7c7b\u4f3cUNIX\u7684\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002\u4e00\u4e9b\u4eba\u5df2\u7ecf\u6dfb\u52a0\u4e86\u4e00\u4e9b\u7cfb\u7edf\u8c03\u7528\u548c\u4e00\u4e2a\u7b80\u5355\u7684C\u5e93\u6269\u5c55\u4e86xv6\uff0c\u4ee5\u4fbf\u8fd0\u884c\u57fa\u672c\u7684Unix\u7a0b\u5e8f\u3002\u7136\u800c\uff0c\u73b0\u4ee3\u5185\u6838\u6bd4xv6\u63d0\u4f9b\u4e86\u66f4\u591a\u7684\u7cfb\u7edf\u8c03\u7528\u548c\u66f4\u591a\u79cd\u7c7b\u7684\u5185\u6838\u670d\u52a1\u3002\u4f8b\u5982\uff0c\u5b83\u4eec\u652f\u6301\u7f51\u7edc\u3001\u7a97\u53e3\u7cfb\u7edf\u3001\u7528\u6237\u7ea7\u7ebf\u7a0b\u3001\u8bb8\u591a\u8bbe\u5907\u7684\u9a71\u52a8\u7a0b\u5e8f\u7b49\u7b49\u3002\u73b0\u4ee3\u5185\u6838\u4e0d\u65ad\u5feb\u901f\u53d1\u5c55\uff0c\u5e76\u63d0\u4f9b\u4e86\u8bb8\u591a\u8d85\u8d8aPOSIX\u7684\u529f\u80fd\u3002</p> <p>Unix\u7528\u4e00\u5957\u6587\u4ef6\u540d\u548c\u6587\u4ef6\u63cf\u8ff0\u7b26\u63a5\u53e3\u7edf\u4e00\u4e86\u5bf9\u591a\u79cd\u7c7b\u578b\u8d44\u6e90\uff08\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u8bbe\u5907\uff09\u7684\u8bbf\u95ee\u3002\u8fd9\u4e2a\u601d\u60f3\u53ef\u4ee5\u6269\u5c55\u5230\u66f4\u591a\u79cd\u7c7b\u7684\u8d44\u6e90\uff0c\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u662fPlan 9\u9879\u76ee[13]\uff0c\u5b83\u628a\u8d44\u6e90\u5c31\u662f\u6587\u4ef6\u7684\u6982\u5ff5\u5e94\u7528\u5230\u7f51\u7edc\u3001\u56fe\u5f62\u7b49\u65b9\u9762\u3002\u7136\u800c\uff0c\u5927\u591a\u6570Unix\u884d\u751f\u7684\u64cd\u4f5c\u7cfb\u7edf\u90fd\u6ca1\u6709\u9075\u5faa\u8fd9\u4e00\u8def\u7ebf\u3002</p> <p>\u6587\u4ef6\u7cfb\u7edf\u548c\u6587\u4ef6\u63cf\u8ff0\u7b26\u5df2\u7ecf\u662f\u5f3a\u5927\u7684\u62bd\u8c61\u3002\u5373\u4fbf\u5982\u6b64\uff0c\u64cd\u4f5c\u7cfb\u7edf\u63a5\u53e3\u8fd8\u6709\u5176\u4ed6\u6a21\u5f0f\u3002Multics\u662fUnix\u7684\u524d\u8eab\uff0c\u5b83\u4ee5\u4e00\u79cd\u4f7f\u6587\u4ef6\u5b58\u50a8\u770b\u8d77\u6765\u50cf\u5185\u5b58\u7684\u65b9\u5f0f\u62bd\u8c61\u4e86\u6587\u4ef6\u5b58\u50a8\uff0c\u4ea7\u751f\u4e86\u4e00\u79cd\u622a\u7136\u4e0d\u540c\u7684\u63a5\u53e3\u3002Multics\u8bbe\u8ba1\u7684\u590d\u6742\u6027\u76f4\u63a5\u5f71\u54cd\u4e86Unix\u7684\u8bbe\u8ba1\u8005\uff0c\u4ed6\u4eec\u8bd5\u56fe\u5efa\u7acb\u4e00\u4e9b\u66f4\u7b80\u5355\u7684\u4e1c\u897f\u3002</p> <p>Xv6\u6ca1\u6709\u7528\u6237\u7cfb\u7edf\uff1b\u7528Unix\u7684\u672f\u8bed\u6765\u8bf4\uff0c\u6240\u6709\u7684xv6\u8fdb\u7a0b\u90fd\u4ee5root\u8eab\u4efd\u8fd0\u884c\u3002</p> <p>\u672c\u4e66\u7814\u7a76\u7684\u662fxv6\u5982\u4f55\u5b9e\u73b0\u5176\u7c7b\u4f3cUnix\u7684\u63a5\u53e3\uff0c\u4f46\u5176\u601d\u60f3\u548c\u6982\u5ff5\u4e0d\u4ec5\u4ec5\u9002\u7528\u4e8eUnix\u3002\u4efb\u4f55\u64cd\u4f5c\u7cfb\u7edf\u90fd\u5fc5\u987b\u5c06\u8fdb\u7a0b\u590d\u7528\u5230\u5e95\u5c42\u786c\u4ef6\u4e0a\uff0c\u5c06\u8fdb\u7a0b\u76f8\u4e92\u9694\u79bb\uff0c\u5e76\u63d0\u4f9b\u53d7\u63a7\u8fdb\u7a0b\u95f4\u901a\u4fe1\u7684\u673a\u5236\u3002\u5728\u5b66\u4e60\u4e86xv6\u4e4b\u540e\uff0c\u60a8\u5e94\u8be5\u80fd\u591f\u7814\u7a76\u5176\u4ed6\u66f4\u590d\u6742\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5e76\u5728\u8fd9\u4e9b\u7cfb\u7edf\u4e2d\u770b\u5230xv6\u4e2d\u8574\u542b\u7684\u57fa\u672c\u6982\u5ff5\u3002</p>"},{"location":"os/Chapter-1/#16-exercises16","title":"1.6 Exercises[1.6 \u7ec3\u4e60]","text":"<ol> <li>\u4f7f\u7528UNIX\u7684\u7cfb\u7edf\u8c03\u7528\u7f16\u5199\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u901a\u8fc7\u4e00\u5bf9\u7ba1\u9053\u5728\u4e24\u4e2a\u8fdb\u7a0b\u4e4b\u95f4\u4ea4\u6362\u4e00\u4e2a\u5b57\u8282\uff0c\u6bcf\u4e2a\u65b9\u5411\u5404\u4e00\u4e2a\u3002\u4ee5\u4ea4\u6362\u6b21\u6570/\u79d2\u4e3a\u5355\u4f4d\u6d4b\u91cf\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</li> </ol> <ol> <li>\u672c\u6587\u4e00\u822c\u7528CPU\u4e2d\u592e\u5904\u7406\u5355\u5143\u7684\u7f29\u5199\u6765\u6307\u4ee3\u6267\u884c\u8ba1\u7b97\u7684\u786c\u4ef6\u5355\u5143\u3002\u5176\u4ed6\u6587\u672c(\u5982RISC-V\u89c4\u8303)\u4e5f\u4f7f\u7528processor\u3001core\u548chart\u7b49\u8bcd\u4ee3\u66ffCPU\u3002</li> </ol>"},{"location":"os/Chapter-2/","title":"Chapter 2","text":""},{"location":"os/Chapter-2/#_1","title":"\u7b2c\u4e8c\u7ae0\uff1a\u64cd\u4f5c\u7cfb\u7edf\u7ec4\u7ec7","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e00\u4e2a\u5173\u952e\u8981\u6c42\u662f\u540c\u65f6\u652f\u6301\u51e0\u4e2a\u6d3b\u52a8\u3002\u4f8b\u5982\uff0c\u4f7f\u7528\u7b2c1\u7ae0\u4e2d\u63cf\u8ff0\u7684\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u7528**fork**\u521b\u5efa\u65b0\u8fdb\u7a0b\u3002\u64cd\u4f5c\u7cfb\u7edf\u5fc5\u987b\u5728\u8fd9\u4e9b\u8fdb\u7a0b\u4e4b\u95f4\u5206\u65f6\u5171\u4eab\u8ba1\u7b97\u673a\u7684\u8d44\u6e90\u3002\u4f8b\u5982\uff0c\u5373\u4f7f\u8fdb\u7a0b\u7684\u6570\u91cf\u591a\u4e8e\u786c\u4ef6CPU\u7684\u6570\u91cf\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e5f\u5fc5\u987b\u4fdd\u8bc1\u6240\u6709\u7684\u8fdb\u7a0b\u90fd\u6709\u673a\u4f1a\u6267\u884c\u3002\u64cd\u4f5c\u7cfb\u7edf\u8fd8\u5fc5\u987b\u5b89\u6392\u8fdb\u7a0b\u4e4b\u95f4\u7684\u9694\u79bb\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u51fa\u73b0\u4e86bug\u5e76\u53d1\u751f\u4e86\u6545\u969c\uff0c\u5176\u4e0d\u5e94\u8be5\u5f71\u54cd\u4e0d\u4f9d\u8d56\u8be5bug\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u3002\u7136\u800c\uff0c\u5b8c\u5168\u9694\u79bb\u4e5f\u4e0d\u53ef\u53d6\uff0c\u56e0\u4e3a\u8fdb\u7a0b\u95f4\u53ef\u80fd\u9700\u8981\u8fdb\u884c\u4ea4\u4e92\uff0c\u4f8b\u5982\u7ba1\u9053\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u5fc5\u987b\u6ee1\u8db3\u4e09\u4e2a\u8981\u6c42\uff1a\u591a\u8def\u590d\u7528\u3001\u9694\u79bb\u548c\u4ea4\u4e92\u3002</p> <p>\u672c\u7ae0\u6982\u8ff0\u4e86\u5982\u4f55\u7ec4\u7ec7\u64cd\u4f5c\u7cfb\u7edf\u6765\u5b9e\u73b0\u8fd9\u4e09\u4e2a\u8981\u6c42\u3002\u73b0\u5b9e\u4e2d\u6709\u5f88\u591a\u65b9\u6cd5\uff0c\u4f46\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u4ee5\u5b8f\u5185\u6838[1]\u4e3a\u4e2d\u5fc3\u7684\u4e3b\u6d41\u8bbe\u8ba1\uff0c\u5f88\u591aUnix\u64cd\u4f5c\u7cfb\u7edf\u90fd\u91c7\u7528\u8fd9\u79cd\u8bbe\u8ba1\u3002\u672c\u7ae0\u8fd8\u4ecb\u7ecd\u4e86xv6\u8fdb\u7a0b\u7684\u6982\u8ff0\uff0cxv6\u8fdb\u7a0b\u662fxv6\u4e2d\u7684\u9694\u79bb\u5355\u5143\uff0c\u8fd8\u4ecb\u7ecd\u4e86xv6\u542f\u52a8\u65f6\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\u7684\u521b\u5efa\u3002</p> <p>Xv6\u8fd0\u884c\u5728\u591a\u6838[2]RISC-V\u5fae\u5904\u7406\u5668\u4e0a\uff0c\u5b83\u7684\u8bb8\u591a\u5e95\u5c42\u529f\u80fd\uff08\u4f8b\u5982\uff0c\u5b83\u7684\u8fdb\u7a0b\u5b9e\u73b0\uff09\u662fRISC-V\u6240\u7279\u6709\u7684\u3002RISC-V\u662f\u4e00\u4e2a64\u4f4d\u7684CPU\uff0cxv6\u662f\u7528 \"LP64 \"C\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u8fd9\u610f\u5473\u7740C\u7f16\u7a0b\u8bed\u8a00\u4e2d\u7684long(L)\u548c\u6307\u9488(P)\u662f64\u4f4d\u7684\uff0c\u4f46int\u662f32\u4f4d\u7684\u3002\u672c\u4e66\u5047\u5b9a\u8bfb\u8005\u5728\u67d0\u79cd\u67b6\u6784\u4e0a\u505a\u8fc7\u4e00\u70b9\u673a\u5668\u7ea7\u7684\u7f16\u7a0b\uff0c\u5e76\u4f1a\u4ecb\u7ecd\u4e00\u4e9bRISC-V\u7279\u6709\u7684\u601d\u60f3\u3002RISC-V\u6709\u7528\u7684\u53c2\u8003\u8d44\u6599\u662f \"The RISC-V Reader,An Open Architecture Attlas\"\uff3b12\uff3d\u3002\u7528\u6237\u7ea7ISA[2]\u548c\u7279\u6743\u67b6\u6784[1]\u662f\u5b98\u65b9\u89c4\u8303\u3002</p> <p>\u4e00\u53f0\u5b8c\u6574\u7684\u8ba1\u7b97\u673a\u4e2d\u7684CPU\u88ab\u652f\u6301\u5b83\u7684\u786c\u4ef6\u6240\u5305\u56f4\uff0c\u8fd9\u4e9b\u786c\u4ef6\u5927\u90e8\u5206\u5448I/O\u63a5\u53e3\u7684\u5f62\u5f0f\u3002\u7f16\u5199XV6\u65f6\uff0c\u652f\u6491\u5b83\u7684\u786c\u4ef6\u662f\u901a\u8fc7\u5e26\"-machine virt \"\u9009\u9879\u7684qemu\u6a21\u62df\u51fa\u6765\u7684\u3002\u5176\u4e2d\u5305\u62ecRAM\u3001\u5305\u542b\u542f\u52a8\u4ee3\u7801\u7684ROM\u3001\u4e0e\u7528\u6237\u952e\u76d8/\u5c4f\u5e55\u7684\u4e32\u884c\u8fde\u63a5\u4ee5\u53ca\u7528\u4e8e\u5b58\u50a8\u7684\u78c1\u76d8\u3002</p>"},{"location":"os/Chapter-2/#21-abstracting-physical-resources","title":"2.1 Abstracting physical resources","text":"<p>\u200b    \u9047\u5230\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4eba\u4eec\u53ef\u80fd\u4f1a\u95ee\u7684\u7b2c\u4e00\u4e2a\u95ee\u9898\u662f\u4e3a\u4ec0\u4e48\u9700\u8981\u5b83\u5462\uff1f\u7b54\u6848\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u56fe1.2\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u4f5c\u4e3a\u4e00\u4e2a\u5e93\u6765\u5b9e\u73b0\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e0e\u4e4b\u8fde\u63a5\u3002\u5728\u8fd9\u4e2a\u60f3\u6cd5\u4e2d\uff0c\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u5b9a\u5236\u81ea\u5df1\u7684\u5e93\u3002\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u76f4\u63a5\u4e0e\u786c\u4ef6\u8d44\u6e90\u8fdb\u884c\u4ea4\u4e92\uff0c\u5e76\u4ee5\u6700\u9002\u5408\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u5f0f\u4f7f\u7528\u8fd9\u4e9b\u8d44\u6e90\uff08\u4f8b\u5982\uff0c\u5b9e\u73b0\u9ad8\u6548\u3001\u53ef\u9884\u6d4b\u7684\u6027\u80fd\uff09\u3002\u4e00\u4e9b\u7528\u4e8e\u5d4c\u5165\u5f0f\u8bbe\u5907\u6216\u5b9e\u65f6\u7cfb\u7edf\u7684\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662f\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u7ec4\u7ec7\u7684\u3002</p> <p>\u8fd9\u79cd\u7cfb\u7edf\u5e93\u65b9\u5f0f\u7684\u7f3a\u70b9\u662f\uff0c\u5982\u679c\u6709\u591a\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5728\u8fd0\u884c\uff0c\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u6b63\u786e\u6267\u884c\u3002\u4f8b\u5982\uff0c\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u5b9a\u671f\u653e\u5f03CPU\uff0c\u4ee5\u4fbf\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u8fd0\u884c\u3002\u5982\u679c\u6240\u6709\u7684\u5e94\u7528\u7a0b\u5e8f\u90fd\u76f8\u4e92\u4fe1\u4efb\u5e76\u4e14\u6ca1\u6709bug\uff0c\u8fd9\u6837\u7684***cooperative***\u5206\u65f6\u65b9\u6848\u53ef\u80fd\u662fOK\u7684\u3002\u66f4\u5178\u578b\u7684\u60c5\u51b5\u662f\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u4e92\u4e0d\u4fe1\u4efb\uff0c\u5e76\u4e14\u6709bug\uff0c\u6240\u4ee5\u4eba\u4eec\u901a\u5e38\u5e0c\u671b\u6bd4***cooperative***\u65b9\u6848\u63d0\u4f9b\u66f4\u5f3a\u7684\u9694\u79bb\u6027\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u5f3a\u9694\u79bb\uff0c\u7981\u6b62\u5e94\u7528\u7a0b\u5e8f\u76f4\u63a5\u8bbf\u95ee\u654f\u611f\u7684\u786c\u4ef6\u8d44\u6e90\uff0c\u800c\u5c06\u8d44\u6e90\u62bd\u8c61\u4e3a\u670d\u52a1\u662f\u5f88\u6709\u5e2e\u52a9\u7684\u3002\u4f8b\u5982\uff0cUnix\u5e94\u7528\u7a0b\u5e8f\u53ea\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u7684<code>open</code>\u3001<code>read</code>\u3001<code>write</code>\u548c<code>close</code>\u7cfb\u7edf\u8c03\u7528\u4e0e\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u4ea4\u4e92\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8bfb\u5199\u78c1\u76d8\u3002\u8fd9\u4e3a\u5e94\u7528\u7a0b\u5e8f\u5e26\u6765\u4e86\u8def\u5f84\u540d\u7684\u4fbf\u5229\uff0c\u800c\u4e14\u5b83\u5141\u8bb8\u64cd\u4f5c\u7cfb\u7edf\uff08\u4f5c\u4e3a\u63a5\u53e3\u7684\u5b9e\u73b0\u8005\uff09\u7ba1\u7406\u78c1\u76d8\u3002\u5373\u4f7f\u4e0d\u8003\u8651\u9694\u79bb\u95ee\u9898\uff0c\u90a3\u4e9b\u6709\u610f\u4ea4\u4e92\u7684\u7a0b\u5e8f\uff08\u6216\u8005\u53ea\u662f\u5e0c\u671b\u4e92\u4e0d\u5e72\u6270\uff09\u5f88\u53ef\u80fd\u4f1a\u53d1\u73b0\u6587\u4ef6\u7cfb\u7edf\u662f\u4e00\u4e2a\u6bd4\u76f4\u63a5\u4f7f\u7528\u78c1\u76d8\u66f4\u65b9\u4fbf\u7684\u62bd\u8c61\u3002</p> <p>\u540c\u6837\uff0cUnix\u5728\u8fdb\u7a0b\u4e4b\u95f4\u900f\u660e\u5730\u5207\u6362\u786c\u4ef6CPU\uff0c\u5fc5\u8981\u65f6\u4fdd\u5b58\u548c\u6062\u590d\u5bc4\u5b58\u5668\u72b6\u6001\uff0c\u8fd9\u6837\u5e94\u7528\u7a0b\u5e8f\u5c31\u4e0d\u5fc5\u610f\u8bc6\u5230\u65f6\u95f4\u5171\u4eab\u3002\u8fd9\u79cd\u900f\u660e\u6027\u5141\u8bb8\u64cd\u4f5c\u7cfb\u7edf\u5171\u4eabCPU\uff0c\u5373\u4f7f\u4e00\u4e9b\u5e94\u7528\u7a0b\u5e8f\u5904\u4e8e\u65e0\u9650\u5faa\u73af\u4e2d\u3002</p> <p>\u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\uff0cUnix\u8fdb\u7a0b\u4f7f\u7528<code>exec</code>\u6765\u5efa\u7acb\u5b83\u4eec\u7684\u5185\u5b58\u6620\u50cf\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u4e0e\u7269\u7406\u5185\u5b58\u4ea4\u4e92\u3002\u8fd9\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u51b3\u5b9a\u5c06\u8fdb\u7a0b\u653e\u5728\u5185\u5b58\u7684\u4ec0\u4e48\u4f4d\u7f6e\uff1b\u5982\u679c\u5185\u5b58\u7d27\u5f20\uff0c\u64cd\u4f5c\u7cfb\u7edf\u751a\u81f3\u53ef\u80fd\u5c06\u8fdb\u7a0b\u7684\u90e8\u5206\u6570\u636e\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u3002<code>exec</code>\u8fd8\u5141\u8bb8\u7528\u6237\u5c06\u53ef\u6267\u884c\u6587\u4ef6\u50a8\u5b58\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002</p> <p>Unix\u8fdb\u7a0b\u4e4b\u95f4\u7684\u8bb8\u591a\u5f62\u5f0f\u7684\u4ea4\u4e92\u90fd\u662f\u901a\u8fc7\u6587\u4ef6\u63cf\u8ff0\u7b26\u8fdb\u884c\u7684\u3002\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0d\u4ec5\u53ef\u4ee5\u62bd\u8c61\u51fa\u8bb8\u591a\u7ec6\u8282\uff08\u4f8b\u5982\uff0c\u7ba1\u9053\u6216\u6587\u4ef6\u4e2d\u7684\u6570\u636e\u5b58\u50a8\u5728\u54ea\u91cc\uff09\uff0c\u800c\u4e14\u5b83\u4eec\u7684\u5b9a\u4e49\u65b9\u5f0f\u4e5f\u53ef\u4ee5\u7b80\u5316\u4ea4\u4e92\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7ba1\u9053\u4e2d\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5d29\u6e83\u4e86\uff0c\u5185\u6838\u5c31\u4f1a\u4e3a\u7ba1\u9053\u4e2d\u7684\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u4ea7\u751f\u4e00\u4e2a\u6587\u4ef6\u7ed3\u675f\u4fe1\u53f7\u3002</p> <p>\u56fe1.2\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u7ecf\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\uff0c\u65e2\u4e3a\u7a0b\u5e8f\u5458\u63d0\u4f9b\u4e86\u4fbf\u5229\uff0c\u53c8\u63d0\u4f9b\u4e86\u5f3a\u9694\u79bb\u7684\u53ef\u80fd\u3002Unix\u63a5\u53e3\u5e76\u4e0d\u662f\u62bd\u8c61\u8d44\u6e90\u7684\u552f\u4e00\u65b9\u5f0f\uff0c\u4f46\u4e8b\u5b9e\u8bc1\u660e\u5b83\u662f\u4e00\u79cd\u975e\u5e38\u597d\u7684\u65b9\u5f0f\u3002</p>"},{"location":"os/Chapter-2/#22-user-mode-supervisor-mode-and-system-calls","title":"2.2 User mode, supervisor mode, and system calls","text":"<p>\u5f3a\u9694\u79bb\u8981\u6c42\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u6709\u4e00\u4e2a\u5206\u754c\u7ebf\u3002\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u53d1\u751f\u9519\u8bef\uff0c\u6211\u4eec\u4e0d\u5e0c\u671b\u64cd\u4f5c\u7cfb\u7edf\u5d29\u6e83\uff0c\u4e5f\u4e0d\u5e0c\u671b\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u5d29\u6e83\u3002\u76f8\u53cd\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5e94\u8be5\u80fd\u591f\u6e05\u7406\u5d29\u6e83\u7684\u5e94\u7528\u7a0b\u5e8f\u5e76\u7ee7\u7eed\u8fd0\u884c\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u3002\u4e3a\u4e86\u5b9e\u73b0\u5f3a\u9694\u79bb\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5fc5\u987b\u5b89\u6392\u5e94\u7528\u7a0b\u5e8f\u4e0d\u80fd\u4fee\u6539\uff08\u751a\u81f3\u4e0d\u80fd\u8bfb\u53d6\uff09\u64cd\u4f5c\u7cfb\u7edf\u7684\u6570\u636e\u7ed3\u6784\u548c\u6307\u4ee4\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8fdb\u7a0b\u7684\u5185\u5b58\u3002</p> <p>CPU\u63d0\u4f9b\u4e86\u5f3a\u9694\u79bb\u7684\u786c\u4ef6\u652f\u6301\u3002\u4f8b\u5982\uff0cRISC-V\u6709\u4e09\u79cd\u6a21\u5f0f\uff0cCPU\u53ef\u4ee5\u6267\u884c\u6307\u4ee4\uff1a\u673a\u5668\u6a21\u5f0f\u3001\u76d1\u7763\u8005\uff08supervisor\uff09\u6a21\u5f0f**\u548c**\u7528\u6237\u6a21\u5f0f\u3002\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u6267\u884c\u7684\u6307\u4ee4\u5177\u6709\u5b8c\u5168\u7684\u6743\u9650\uff0c\u4e00\u4e2aCPU\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u542f\u52a8\u3002\u673a\u5668\u6a21\u5f0f\u4e3b\u8981\u7528\u4e8e\u914d\u7f6e\u8ba1\u7b97\u673a\u3002Xv6\u4f1a\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u6267\u884c\u51e0\u6761\u6307\u4ee4\uff0c\u7136\u540e\u8f6c\u4e3a\u76d1\u7763\u8005\u6a21\u5f0f\u3002</p> <p>\u5728\u76d1\u7763\u8005\uff08supervisor\uff09\u6a21\u5f0f\u4e0b\uff0cCPU\u88ab\u5141\u8bb8\u6267\u884c\u7279\u6743\u6307\u4ee4\uff1a\u4f8b\u5982\uff0c\u542f\u7528\u548c\u7981\u7528\u4e2d\u65ad\uff0c\u8bfb\u5199\u4fdd\u5b58\u9875\u8868\u5730\u5740\u7684\u5bc4\u5b58\u5668\u7b49\u3002\u5982\u679c\u7528\u6237\u6a21\u5f0f\u4e0b\u7684\u5e94\u7528\u7a0b\u5e8f\u8bd5\u56fe\u6267\u884c\u4e00\u6761\u7279\u6743\u6307\u4ee4\uff0cCPU\u4e0d\u4f1a\u6267\u884c\u8be5\u6307\u4ee4\uff0c\u800c\u662f\u5207\u6362\u5230\u76d1\u7763\u8005\u6a21\u5f0f\uff0c\u8fd9\u6837\u76d1\u7763\u8005\u6a21\u5f0f\u7684\u4ee3\u7801\u5c31\u53ef\u4ee5\u7ec8\u6b62\u8be5\u5e94\u7528\u7a0b\u5e8f\uff0c\u56e0\u4e3a\u5b83\u505a\u4e86\u4e0d\u8be5\u505a\u7684\u4e8b\u60c5\u3002\u7b2c1\u7ae0\u7684\u56fe1.1\u8bf4\u660e\u4e86\u8fd9\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u3002\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u53ea\u80fd\u6267\u884c\u7528\u6237\u6a21\u5f0f\u7684\u6307\u4ee4\uff08\u5982\u6570\u5b57\u76f8\u52a0\u7b49\uff09\uff0c\u88ab\u79f0\u4e3a\u8fd0\u884c\u5728\u7528\u6237\u7a7a\u95f4\uff0c\u800c\u5904\u4e8e\u76d1\u7763\u8005\u6a21\u5f0f\u7684\u8f6f\u4ef6\u4e5f\u53ef\u4ee5\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u88ab\u79f0\u4e3a\u8fd0\u884c\u5728\u5185\u6838\u7a7a\u95f4\u3002\u8fd0\u884c\u5728\u5185\u6838\u7a7a\u95f4\uff08\u6216\u76d1\u7763\u8005\u6a21\u5f0f\uff09\u7684\u8f6f\u4ef6\u79f0\u4e3a\u5185\u6838\u3002</p> <p>\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5982\u679c\u8981\u8c03\u7528\u5185\u6838\u51fd\u6570\uff08\u5982xv6\u4e2d\u7684<code>read</code>\u7cfb\u7edf\u8c03\u7528\uff09\uff0c\u5fc5\u987b\u8fc7\u6e21\u5230\u5185\u6838\u3002CPU\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7279\u6b8a\u7684\u6307\u4ee4\uff0c\u53ef\u4ee5\u5c06CPU\u4ece\u7528\u6237\u6a21\u5f0f\u5207\u6362\u5230\u76d1\u7763\u8005\u6a21\u5f0f\uff0c\u5e76\u5728\u5185\u6838\u6307\u5b9a\u7684\u5165\u53e3\u5904\u8fdb\u5165\u5185\u6838\u3002(RISC-V\u4e3a\u6b64\u63d0\u4f9b\u4e86<code>ecall</code>\u6307\u4ee4\u3002)\u4e00\u65e6CPU\u5207\u6362\u5230\u76d1\u7763\u8005\u6a21\u5f0f\uff0c\u5185\u6838\u5c31\u53ef\u4ee5\u9a8c\u8bc1\u7cfb\u7edf\u8c03\u7528\u7684\u53c2\u6570\uff0c\u51b3\u5b9a\u662f\u5426\u5141\u8bb8\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u8bf7\u6c42\u7684\u64cd\u4f5c\uff0c\u7136\u540e\u62d2\u7edd\u6216\u6267\u884c\u8be5\u64cd\u4f5c\u3002\u7531\u5185\u6838\u63a7\u5236\u76d1\u7763\u8005\u6a21\u5f0f\u7684\u5165\u53e3\u70b9\u662f\u5f88\u91cd\u8981\u7684\uff1b\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u51b3\u5b9a\u5185\u6838\u7684\u5165\u53e3\u70b9\uff0c\u90a3\u4e48\u6076\u610f\u5e94\u7528\u7a0b\u5e8f\u5c31\u80fd\u591f\u5728\u8df3\u8fc7\u53c2\u6570\u9a8c\u8bc1\u7684\u60c5\u51b5\u4e0b\u8fdb\u5165\u5185\u6838\u3002</p>"},{"location":"os/Chapter-2/#23-kernel-organization","title":"2.3 Kernel organization","text":"<p>\u4e00\u4e2a\u5173\u952e\u7684\u8bbe\u8ba1\u95ee\u9898\u662f\u64cd\u4f5c\u7cfb\u7edf\u7684\u54ea\u4e00\u90e8\u5206\u5e94\u8be5\u5728\u76d1\u7763\u8005\u6a21\u5f0f\u4e0b\u8fd0\u884c\u3002\u4e00\u79cd\u53ef\u80fd\u662f\u6574\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u9a7b\u7559\u5728\u5185\u6838\u4e2d\uff0c\u8fd9\u6837\u6240\u6709\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\u90fd\u5728\u76d1\u7763\u8005\u6a21\u5f0f\u4e0b\u8fd0\u884c\u3002\u8fd9\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u79f0\u4e3a***\u5b8f\u5185\u6838***\u3002</p> <p>\u5728\u8fd9\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u4e2d\uff0c\u6574\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u4ee5\u5168\u786c\u4ef6\u6743\u9650\u8fd0\u884c\u3002\u8fd9\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u5f88\u65b9\u4fbf\uff0c\u56e0\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u8ba1\u8005\u4e0d\u5fc5\u51b3\u5b9a\u64cd\u4f5c\u7cfb\u7edf\u7684\u54ea\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u5168\u786c\u4ef6\u6743\u9650\u3002\u6b64\u5916\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e0d\u540c\u90e8\u5206\u66f4\u5bb9\u6613\u5408\u4f5c\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u53ef\u80fd\u6709\u4e00\u4e2a\u7f13\u51b2\u533a\uff0c\u5176\u88ab\u7f13\u5b58\u6587\u4ef6\u7cfb\u7edf\u548c\u865a\u62df\u5185\u5b58\u7cfb\u7edf\u5171\u4eab\u3002</p> <p>\u5b8f\u5185\u6838\u7ec4\u7ec7\u65b9\u5f0f\u7684\u4e00\u4e2a\u7f3a\u70b9\u662f\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e0d\u540c\u90e8\u5206\u4e4b\u95f4\u7684\u63a5\u53e3\u901a\u5e38\u662f\u590d\u6742\u7684\uff08\u6211\u4eec\u5c06\u5728\u672c\u6587\u7684\u5176\u4f59\u90e8\u5206\u770b\u5230\uff09\uff0c\u56e0\u6b64\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u8005\u5f88\u5bb9\u6613\u5728\u8fd9\u4e0a\u9762\u51fa\u9519\u3002\u5728\u5b8f\u5185\u6838\u4e2d\uff0c\u4e00\u4e2a\u9519\u8bef\u662f\u81f4\u547d\u7684\uff0c\u56e0\u4e3a\u76d1\u7763\u8005\u6a21\u5f0f\u4e0b\u7684\u9519\u8bef\u5f80\u5f80\u4f1a\u5bfc\u81f4\u5185\u6838\u5d29\u6e83\u3002\u5982\u679c\u5185\u6838\u5d29\u6e83\uff0c\u8ba1\u7b97\u673a\u5c31\u4f1a\u505c\u6b62\u5de5\u4f5c\uff0c\u56e0\u6b64\u6240\u6709\u7684\u5e94\u7528\u7a0b\u5e8f\u4e5f\u4f1a\u5d29\u6e83\u3002\u8ba1\u7b97\u673a\u5fc5\u987b\u91cd\u542f\u3002</p> <p>\u4e3a\u4e86\u964d\u4f4e\u5185\u6838\u51fa\u9519\u7684\u98ce\u9669\uff0c\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u8ba1\u8005\u53ef\u4ee5\u5c3d\u91cf\u51cf\u5c11\u5728\u76d1\u7763\u8005\u6a21\u5f0f\u4e0b\u8fd0\u884c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u91cf\uff0c\u800c\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5927\u90e8\u5206\u4ee3\u7801\u3002\u8fd9\u79cd\u5185\u6838\u7ec4\u7ec7\u65b9\u5f0f\u79f0\u4e3a***\u5fae\u5185\u6838***\u3002</p> <p></p> <p>\u56fe2.1\u8bf4\u660e\u4e86\u8fd9\u79cd\u5fae\u5185\u6838\u8bbe\u8ba1\u3002\u5728\u56fe\u4e2d\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f5c\u4e3a\u4e00\u4e2a\u7528\u6237\u7ea7\u8fdb\u7a0b\u8fd0\u884c\u3002\u4f5c\u4e3a\u8fdb\u7a0b\u8fd0\u884c\u7684OS\u670d\u52a1\u79f0\u4e3a\u670d\u52a1\u5668\u3002\u4e3a\u4e86\u8ba9\u5e94\u7528\u7a0b\u5e8f\u4e0e\u6587\u4ef6\u670d\u52a1\u5668\u8fdb\u884c\u4ea4\u4e92\uff0c\u5185\u6838\u63d0\u4f9b\u4e86\u4e00\u79cd\u8fdb\u7a0b\u95f4\u901a\u4fe1\u673a\u5236\uff0c\u7528\u4e8e\u4ece\u4e00\u4e2a\u7528\u6237\u6a21\u5f0f\u8fdb\u7a0b\u5411\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u53d1\u9001\u6d88\u606f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a\u50cfshell\u8fd9\u6837\u7684\u5e94\u7528\u7a0b\u5e8f\u60f3\u8981\u8bfb\u5199\u6587\u4ef6\uff0c\u5b83\u5c31\u4f1a\u5411\u6587\u4ef6\u670d\u52a1\u5668\u53d1\u9001\u4e00\u4e2a\u6d88\u606f\uff0c\u5e76\u7b49\u5f85\u54cd\u5e94\u3002</p> <p>\u5728\u5fae\u5185\u6838\u4e2d\uff0c\u5185\u6838\u63a5\u53e3\u7531\u4e00\u4e9b\u4f4e\u7ea7\u51fd\u6570\u7ec4\u6210\uff0c\u7528\u4e8e\u542f\u52a8\u5e94\u7528\u7a0b\u5e8f\u3001\u53d1\u9001\u6d88\u606f\u3001\u8bbf\u95ee\u8bbe\u5907\u786c\u4ef6\u7b49\u3002\u8fd9\u79cd\u7ec4\u7ec7\u65b9\u5f0f\u4f7f\u5f97\u5185\u6838\u76f8\u5bf9\u7b80\u5355\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u64cd\u4f5c\u7cfb\u7edf\u9a7b\u7559\u5728\u7528\u6237\u7ea7\u670d\u52a1\u5668\u4e2d\u3002</p> <p>xv6\u548c\u5927\u591a\u6570Unix\u64cd\u4f5c\u7cfb\u7edf\u4e00\u6837\uff0c\u662f\u4ee5\u5b8f\u5185\u6838\u7684\u5f62\u5f0f\u5b9e\u73b0\u7684\u3002\u56e0\u6b64\uff0cxv6\u5185\u6838\u63a5\u53e3\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u63a5\u53e3\u76f8\u5bf9\u5e94\uff0c\u5185\u6838\u5b9e\u73b0\u4e86\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u7531\u4e8exv6\u4e0d\u63d0\u4f9b\u5f88\u591a\u670d\u52a1\uff0c\u6240\u4ee5\u5b83\u7684\u5185\u6838\u6bd4\u4e00\u4e9b\u5fae\u5185\u6838\u8981\u5c0f\uff0c\u4f46\u4ece\u6982\u5ff5\u4e0a\u8bb2xv6\u662f\u5b8f\u5185\u6838\u3002</p>"},{"location":"os/Chapter-2/#24-code-xv6-organization","title":"2.4 Code: xv6 organization","text":"<p>xv6\u5185\u6838\u6e90\u7801\u5728<code>kernel/</code>\u5b50\u76ee\u5f55\u4e0b\u3002\u6309\u7167\u6a21\u5757\u5316\u7684\u6982\u5ff5\uff0c\u6e90\u7801\u88ab\u5206\u6210\u4e86\u591a\u4e2a\u6587\u4ef6\uff0c\u56fe2.2\u5217\u51fa\u4e86\u8fd9\u4e9b\u6587\u4ef6\u3002\u6a21\u5757\u95f4\u7684\u63a5\u53e3\u5728<code>kernel/defs.h</code>\u4e2d\u5b9a\u4e49\u3002</p> <p></p>"},{"location":"os/Chapter-2/#25-process-overview","title":"2.5 Process overview","text":"<p>xv6\u4e2d\u7684\u9694\u79bb\u5355\u4f4d\uff08\u548c\u5176\u4ed6Unix\u64cd\u4f5c\u7cfb\u7edf\u4e00\u6837\uff09\u662f\u4e00\u4e2a\u8fdb\u7a0b\u3002\u8fdb\u7a0b\u62bd\u8c61\u53ef\u4ee5\u9632\u6b62\u4e00\u4e2a\u8fdb\u7a0b\u7834\u574f\u6216\u76d1\u89c6\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5185\u5b58\u3001CPU\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u3002\u5b83\u8fd8\u53ef\u4ee5\u9632\u6b62\u8fdb\u7a0b\u7834\u574f\u5185\u6838\uff0c\u6240\u4ee5\u8fdb\u7a0b\u4e0d\u80fd\u7834\u574f\u5185\u6838\u7684\u9694\u79bb\u673a\u5236\u3002\u5185\u6838\u5fc5\u987b\u5c0f\u5fc3\u7ffc\u7ffc\u5730\u5b9e\u73b0\u8fdb\u7a0b\u62bd\u8c61\uff0c\u56e0\u4e3a\u4e00\u4e2a\u9519\u8bef\u6216\u6076\u610f\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u6b3a\u9a97\u5185\u6838\u6216\u786c\u4ef6\u505a\u4e00\u4e9b\u4e0d\u597d\u7684\u4e8b\u60c5\uff08\u4f8b\u5982\uff0c\u89c4\u907f\u9694\u79bb\uff09\u3002\u5185\u6838\u7528\u6765\u5b9e\u73b0\u8fdb\u7a0b\u7684\u673a\u5236\u5305\u62ec\uff1a\u7528\u6237/\u76d1\u7763\u6a21\u5f0f\u6807\u5fd7\u3001\u5730\u5740\u7a7a\u95f4\u548c\u7ebf\u7a0b\u7684\u65f6\u95f4\u7247\u8f6e\u8f6c\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u5b9e\u65bd\u9694\u79bb\uff0c\u8fdb\u7a0b\u62bd\u8c61\u4e3a\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4e00\u79cd\u9519\u89c9\uff0c\u5373\u5b83\u6709\u81ea\u5df1\u7684\u79c1\u6709\u673a\u5668\u3002\u4e00\u4e2a\u8fdb\u7a0b\u4e3a\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u770b\u4f3c\u79c1\u6709\u7684\u5185\u5b58\u7cfb\u7edf\uff0c\u6216\u8005\u8bf4\u662f\u5730\u5740\u7a7a\u95f4\uff0c\u5176\u4ed6\u8fdb\u7a0b\u4e0d\u80fd\u5bf9\u5176\u8fdb\u884c\u8bfb\u5199\u3002\u8fdb\u7a0b\u8fd8\u4e3a\u7a0b\u5e8f\u63d0\u4f9b\u4e86\u201c\u79c1\u6709\u201d\u7684CPU\uff0c\u7528\u6765\u6267\u884c\u7a0b\u5e8f\u7684\u6307\u4ee4\u3002</p> <p>Xv6\u4f7f\u7528\u9875\u8868\uff08\u7531\u786c\u4ef6\u5b9e\u73b0\uff09\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u63d0\u4f9b\u81ea\u5df1\u7684\u5730\u5740\u7a7a\u95f4\u3002RISC-V\u9875\u8868\u5c06**\u865a\u62df\u5730\u5740**\uff08RISC-V\u6307\u4ee4\u64cd\u4f5c\u7684\u5730\u5740\uff09\u8f6c\u6362\uff08\u6216 \"\u6620\u5c04\"\uff09\u4e3a**\u7269\u7406\u5730\u5740**\uff08CPU\u82af\u7247\u53d1\u9001\u5230\u4e3b\u5b58\u50a8\u5668\u7684\u5730\u5740\uff09\u3002</p> <p>Xv6\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u7ef4\u62a4\u4e00\u4e2a\u5355\u72ec\u7684\u9875\u8868\uff0c\u5b9a\u4e49\u8be5\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\u3002\u5982\u56fe2.3\u6240\u793a\uff0c\u8fdb\u7a0b\u7684\u7528\u6237\u7a7a\u95f4\u5185\u5b58\u7684\u5730\u5740\u7a7a\u95f4\u662f\u4ece\u865a\u62df\u5730\u57400\u5f00\u59cb\u7684\u3002\u6307\u4ee4\u5b58\u653e\u5728\u6700\u524d\u9762\uff0c\u5176\u6b21\u662f\u5168\u5c40\u53d8\u91cf\uff0c\u7136\u540e\u662f\u6808\uff0c\u6700\u540e\u662f\u4e00\u4e2a\u5806\u533a\uff08\u7528\u4e8e**malloc**\uff09\uff0c\u8fdb\u7a0b\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6269\u5c55\u3002\u6709\u4e00\u4e9b\u56e0\u7d20\u9650\u5236\u4e86\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\u7684\u6700\u5927\u957f\u5ea6\uff1aRISC-V\u4e0a\u7684\u6307\u9488\u662f64\u4f4d\u5bbd\uff1b\u786c\u4ef6\u5728\u9875\u8868\u4e2d\u67e5\u627e\u865a\u62df\u5730\u5740\u65f6\u53ea\u4f7f\u7528\u4f4e\u768439\u4f4d\uff1bxv6\u53ea\u4f7f\u752839\u4f4d\u4e2d\u768438\u4f4d\u3002\u56e0\u6b64\uff0c\u6700\u5927\u5730\u5740\u662f\\(2^{38}-1\\) = 0x3fffffffff\uff0c\u4e5f\u5c31\u662f<code>MAXVA</code>\uff08kernel/riscv.h:348\uff09\u3002\u5728\u5730\u5740\u7a7a\u95f4\u7684\u9876\u7aef\uff0cxv6\u4fdd\u7559\u4e86\u4e00\u9875\uff0c\u7528\u4e8e**trampoline**\u548c\u6620\u5c04\u8fdb\u7a0b**trapframe**\u7684\u9875\uff0c\u4ee5\u4fbf\u5207\u6362\u5230\u5185\u6838\uff0c\u6211\u4eec\u5c06\u5728\u7b2c4\u7ae0\u4e2d\u89e3\u91ca\u3002</p> <p></p> <p>xv6\u5185\u6838\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u7ef4\u62a4\u4e86\u8bb8\u591a\u72b6\u6001\uff0c\u8bb0\u5f55\u5728<code>proc</code>\u7ed3\u6784\u4f53(kernel/proc.h:86)\u3002\u4e00\u4e2a\u8fdb\u7a0b\u6700\u91cd\u8981\u7684\u5185\u6838\u72b6\u6001\u662f\u5b83\u7684\u9875\u8868\u3001\u5185\u6838\u6808\u548c\u8fd0\u884c\u72b6\u6001\u3002\u6211\u4eec\u7528<code>p-&gt;xxx</code>\u6765\u8868\u793a<code>proc</code>\u7ed3\u6784\u7684\u5143\u7d20\uff0c\u4f8b\u5982\uff0c<code>p-&gt;pagetable</code>\u662f\u6307\u5411\u8fdb\u7a0b\u9875\u8868\u7684\u6307\u9488\u3002</p> <p>\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u6267\u884c\u7ebf\u7a0b\uff08\u7b80\u79f0\u7ebf\u7a0b\uff09\uff0c\u6267\u884c\u8fdb\u7a0b\u7684\u6307\u4ee4\u3002\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u88ab\u6682\u505c\uff0c\u7136\u540e\u518d\u6062\u590d\u3002\u4e3a\u4e86\u5728\u8fdb\u7a0b\u4e4b\u95f4\u900f\u660e\u5730\u5207\u6362\uff0c\u5185\u6838\u4f1a\u6682\u505c\u5f53\u524d\u8fd0\u884c\u7684\u7ebf\u7a0b\uff0c\u5e76\u6062\u590d\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u7684\u7ebf\u7a0b\u3002\u7ebf\u7a0b\u7684\u5927\u90e8\u5206\u72b6\u6001\uff08\u5c40\u90e8\u53d8\u91cf\u3001\u51fd\u6570\u8c03\u7528\u8fd4\u56de\u5730\u5740\uff09\u90fd\u5b58\u50a8\u5728\u7ebf\u7a0b\u7684\u6808\u4e2d\u3002\u6bcf\u4e2a\u8fdb\u7a0b\u6709\u4e24\u4e2a\u6808\uff1a\u7528\u6237\u6808\u548c\u5185\u6838\u6808\uff08<code>p-&gt;kstack</code>\uff09\u3002\u5f53\u8fdb\u7a0b\u5728\u6267\u884c\u7528\u6237\u6307\u4ee4\u65f6\uff0c\u53ea\u6709\u5b83\u7684\u7528\u6237\u6808\u5728\u88ab\u4f7f\u7528\uff0c\u800c\u5b83\u7684\u5185\u6838\u6808\u662f\u7a7a\u7684\u3002\u5f53\u8fdb\u7a0b\u8fdb\u5165\u5185\u6838\u65f6\uff08\u56e0\u4e3a\u7cfb\u7edf\u8c03\u7528\u6216\u4e2d\u65ad\uff09\uff0c\u5185\u6838\u4ee3\u7801\u5728\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u4e0a\u6267\u884c\uff1b\u5f53\u8fdb\u7a0b\u5728\u5185\u6838\u4e2d\u65f6\uff0c\u5b83\u7684\u7528\u6237\u6808\u4ecd\u7136\u5305\u542b\u4fdd\u5b58\u7684\u6570\u636e\uff0c\u4f46\u4e0d\u88ab\u4e3b\u52a8\u4f7f\u7528\u3002\u8fdb\u7a0b\u7684\u7ebf\u7a0b\u5728\u7528\u6237\u6808\u548c\u5185\u6838\u6808\u4e2d\u4ea4\u66ff\u6267\u884c\u3002\u5185\u6838\u6808\u662f\u72ec\u7acb\u7684\uff08\u5e76\u4e14\u53d7\u5230\u4fdd\u62a4\uff0c\u4e0d\u53d7\u7528\u6237\u4ee3\u7801\u7684\u5f71\u54cd\uff09\uff0c\u6240\u4ee5\u5373\u4f7f\u4e00\u4e2a\u8fdb\u7a0b\u7528\u6237\u6808\u88ab\u7834\u574f\u4e86\uff0c\u5185\u6838\u4e5f\u53ef\u4ee5\u6267\u884c\u3002</p> <p>\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u6267\u884cRISC-V <code>ecall</code>\u6307\u4ee4\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u3002\u8be5\u6307\u4ee4\u63d0\u9ad8\u786c\u4ef6\u6743\u9650\u7ea7\u522b\uff0c\u5e76\u5c06\u7a0b\u5e8f\u8ba1\u6570\u5668\u6539\u53d8\u4e3a\u5185\u6838\u5b9a\u4e49\u7684\u5165\u53e3\u70b9\u3002\u5165\u53e3\u70b9\u7684\u4ee3\u7801\u4f1a\u5207\u6362\u5230\u5185\u6838\u6808\uff0c\u5e76\u6267\u884c\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u7684\u5185\u6838\u6307\u4ee4\u3002\u5f53\u7cfb\u7edf\u8c03\u7528\u5b8c\u6210\u540e\uff0c\u5185\u6838\u5207\u6362\u56de\u7528\u6237\u6808\uff0c\u5e76\u901a\u8fc7\u8c03\u7528<code>sret</code>\u6307\u4ee4\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\uff0c\u964d\u4f4e\u786c\u4ef6\u7279\u6743\u7ea7\u522b\uff0c\u6062\u590d\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u524d\u7684\u7528\u6237\u6307\u4ee4\u3002\u8fdb\u7a0b\u7684\u7ebf\u7a0b\u53ef\u4ee5\u5728\u5185\u6838\u4e2d\u963b\u585e\u7b49\u5f85I/O\uff0c\u5f53I/O\u5b8c\u6210\u540e\uff0c\u518d\u4ece\u79bb\u5f00\u7684\u5730\u65b9\u6062\u590d\u3002</p> <p><code>p-&gt;state</code>\u8868\u793a\u8fdb\u7a0b\u662f\u521b\u5efa\u3001\u5c31\u7eea\u3001\u8fd0\u884c\u3001\u7b49\u5f85I/O\uff0c\u8fd8\u662f\u9000\u51fa\u3002</p> <p><code>p-&gt;pagetable</code>\u4ee5RISC-V\u786c\u4ef6\u9700\u8981\u7684\u683c\u5f0f\u4fdd\u5b58\u8fdb\u7a0b\u7684\u9875\u8868\uff0c\u5f53\u8fdb\u7a0b\u5728\u7528\u6237\u7a7a\u95f4\u6267\u884c\u65f6\uff0cxv6\u4f7f\u5206\u9875\u786c\u4ef6\u4f7f\u7528\u8fdb\u7a0b\u7684<code>p-&gt;pagetable</code>\u3002\u8fdb\u7a0b\u7684\u9875\u8868\u4e5f\u4f1a\u8bb0\u5f55\u5206\u914d\u7ed9\u8be5\u8fdb\u7a0b\u5185\u5b58\u7684\u7269\u7406\u9875\u5730\u5740\u3002</p>"},{"location":"os/Chapter-2/#26-code-starting-xv6-and-the-first-process","title":"2.6 Code: starting xv6 and the first process","text":"<p>\u4e3a\u4e86\u4f7fxv6\u66f4\u52a0\u5177\u4f53\uff0c\u6211\u4eec\u5c06\u6982\u8ff0\u5185\u6838\u5982\u4f55\u542f\u52a8\u548c\u8fd0\u884c\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\u3002\u540e\u9762\u7684\u7ae0\u8282\u5c06\u66f4\u8be6\u7ec6\u5730\u63cf\u8ff0\u8fd9\u4e2a\u6982\u8ff0\u4e2d\u51fa\u73b0\u7684\u673a\u5236\u3002</p> <p>\u5f53RISC-V\u8ba1\u7b97\u673a\u5f00\u673a\u65f6\uff0c\u5b83\u4f1a\u521d\u59cb\u5316\u81ea\u5df1\uff0c\u5e76\u8fd0\u884c\u4e00\u4e2a\u5b58\u50a8\u5728\u53ea\u8bfb\u5b58\u50a8\u5668\u4e2d\u7684**boot loader**\u3002**Boot loader**\u5c06xv6\u5185\u6838\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u3002\u7136\u540e\uff0c\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\uff0cCPU\u4ece <code>_entry</code>\uff08kernel/entry.S:6\uff09\u5f00\u59cb\u6267\u884cxv6\u3002RISC-V\u5728\u7981\u7528\u5206\u9875\u786c\u4ef6\u7684\u60c5\u51b5\u4e0b\u542f\u52a8\uff1a\u865a\u62df\u5730\u5740\u76f4\u63a5\u6620\u5c04\u5230\u7269\u7406\u5730\u5740\u3002</p> <p>loader\u5c06xv6\u5185\u6838\u52a0\u8f7d\u5230\u7269\u7406\u5730\u5740<code>0x80000000</code>\u7684\u5185\u5b58\u4e2d\u3002\u4e4b\u6240\u4ee5\u5c06\u5185\u6838\u653e\u5728<code>0x80000000</code>\u800c\u4e0d\u662f<code>0x0</code>\uff0c\u662f\u56e0\u4e3a\u5730\u5740\u8303\u56f4<code>0x0:0x80000000</code>\u5305\u542bI/O\u8bbe\u5907\u3002</p> <p><code>_entry</code>\u5904\u7684\u6307\u4ee4\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u6808\uff0c\u8fd9\u6837xv6\u5c31\u53ef\u4ee5\u8fd0\u884cC\u4ee3\u7801\u3002Xv6\u5728\u6587\u4ef6<code>start.c</code>(kernel/start.c:11)\u4e2d\u58f0\u660e\u4e86\u521d\u59cb\u6808\u7684\u7a7a\u95f4\uff0c\u5373<code>stack0</code>\u3002\u5728<code>_entry</code>\u5904\u7684\u4ee3\u7801\u52a0\u8f7d\u6808\u6307\u9488\u5bc4\u5b58\u5668<code>sp</code>\uff0c\u5730\u5740\u4e3a<code>stack0+4096</code>\uff0c\u4e5f\u5c31\u662f\u6808\u7684\u9876\u90e8\uff0c\u56e0\u4e3aRISC-V\u7684\u6808\u662f\u5411\u4e0b\u6269\u5f20\u7684\u3002\u73b0\u5728\u5185\u6838\u5c31\u62e5\u6709\u4e86\u6808\uff0c<code>_entry</code>\u8c03\u7528<code>start</code>(kernel/start.c:21)\uff0c\u5e76\u6267\u884c\u5176C\u4ee3\u7801\u3002</p> <p>\u51fd\u6570<code>start</code>\u6267\u884c\u4e00\u4e9b\u53ea\u6709\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u624d\u5141\u8bb8\u7684\u914d\u7f6e\uff0c\u7136\u540e\u5207\u6362\u5230\u76d1\u7763\u8005\u6a21\u5f0f\u3002\u4e3a\u4e86\u8fdb\u5165\u76d1\u7763\u8005\u6a21\u5f0f\uff0cRISC-V\u63d0\u4f9b\u4e86\u6307\u4ee4<code>mret</code>\u3002\u8fd9\u6761\u6307\u4ee4\u6700\u5e38\u7528\u6765\u4ece\u4e0a\u4e00\u6b21\u7684\u8c03\u7528\u4e2d\u8fd4\u56de\uff0c\u4e0a\u4e00\u6b21\u8c03\u7528\u4ece\u76d1\u7763\u8005\u6a21\u5f0f\u5230\u673a\u5668\u6a21\u5f0f\u3002<code>start</code>\u5e76\u4e0d\u662f\u4ece\u8fd9\u6837\u7684\u8c03\u7528\u4e2d\u8fd4\u56de\uff0c\u800c\u662f\u628a\u4e8b\u60c5\u8bbe\u7f6e\u5f97\u50cf\u6709\u8fc7\u8fd9\u6837\u7684\u8c03\u7528\u4e00\u6837\uff1a\u5b83\u5728\u5bc4\u5b58\u5668<code>mstatus</code>\u4e2d\u628a\u4e0a\u4e00\u6b21\u7684\u7279\u6743\u6a21\u5f0f\u8bbe\u7f6e\u4e3a\u7279\u6743\u8005\u6a21\u5f0f\uff0c\u5b83\u628a<code>main</code>\u7684\u5730\u5740\u5199\u5165\u5bc4\u5b58\u5668<code>mepc</code>\u4e2d\uff0c\u628a\u8fd4\u56de\u5730\u5740\u8bbe\u7f6e\u4e3a<code>main</code>\u51fd\u6570\u7684\u5730\u5740\uff0c\u5728\u7279\u6743\u8005\u6a21\u5f0f\u4e2d\u628a<code>0</code>\u5199\u5165\u9875\u8868\u5bc4\u5b58\u5668<code>satp</code>\u4e2d\uff0c\u7981\u7528\u865a\u62df\u5730\u5740\u8f6c\u6362\uff0c\u5e76\u628a\u6240\u6709\u4e2d\u65ad\u548c\u5f02\u5e38\u59d4\u6258\u7ed9\u7279\u6743\u8005\u6a21\u5f0f\u3002</p> <p>\u5728\u8fdb\u5165\u7279\u6743\u8005\u6a21\u5f0f\u4e4b\u524d\uff0c<code>start</code>\u8fd8\u8981\u6267\u884c\u4e00\u9879\u4efb\u52a1\uff1a\u5bf9\u65f6\u949f\u82af\u7247\u8fdb\u884c\u7f16\u7a0b\u4ee5\u521d\u59cb\u5316\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002\u5728\u5b8c\u6210\u4e86\u8fd9\u4e9b\u57fa\u672c\u7ba1\u7406\u540e\uff0c<code>start</code>\u901a\u8fc7\u8c03\u7528<code>mret</code>\u201c\u8fd4\u56de\u201d\u5230\u76d1\u7763\u8005\u6a21\u5f0f\u3002\u8fd9\u5c06\u5bfc\u81f4\u7a0b\u5e8f\u8ba1\u6570\u5668\u53d8\u4e3a<code>main</code>\uff08kernel/main.c:11\uff09\u7684\u5730\u5740\u3002</p> <p>\u5728<code>main</code>(kernel/main.c:11)\u521d\u59cb\u5316\u51e0\u4e2a\u8bbe\u5907\u548c\u5b50\u7cfb\u7edf\u540e\uff0c\u5b83\u901a\u8fc7\u8c03\u7528<code>userinit</code>(kernel/proc.c:212)\u6765\u521b\u5efa\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\u3002\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u4e00\u4e2a\u7528RISC-V\u6c47\u7f16\u7f16\u5199\u7684\u5c0f\u7a0b\u5e8f<code>initcode.S</code>\uff08user/initcode.S:1\uff09\uff0c\u5b83\u901a\u8fc7\u8c03\u7528<code>exec</code>\u7cfb\u7edf\u8c03\u7528\u91cd\u65b0\u8fdb\u5165\u5185\u6838\u3002\u6b63\u5982\u6211\u4eec\u5728\u7b2c\u4e00\u7ae0\u4e2d\u6240\u770b\u5230\u7684\uff0c<code>exec</code>\u7528\u4e00\u4e2a\u65b0\u7684\u7a0b\u5e8f\uff08\u672c\u4f8b\u4e2d\u662f<code>/init</code>\uff09\u66ff\u6362\u5f53\u524d\u8fdb\u7a0b\u7684\u5185\u5b58\u548c\u5bc4\u5b58\u5668\u3002</p> <p>\u4e00\u65e6\u5185\u6838\u5b8c\u6210<code>exec</code>\uff0c\u5b83\u5c31\u4f1a\u5728<code>/init</code>\u8fdb\u7a0b\u4e2d\u8fd4\u56de\u5230\u7528\u6237\u7a7a\u95f4\u3002<code>init</code> (user/init.c:15)\u5728\u9700\u8981\u65f6\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u63a7\u5236\u53f0\u8bbe\u5907\u6587\u4ef6\uff0c\u7136\u540e\u4ee5\u6587\u4ef6\u63cf\u8ff0\u7b260\u30011\u548c2\u7684\u5f62\u5f0f\u6253\u5f00\u5b83\u3002\u7136\u540e\u5b83\u5728\u63a7\u5236\u53f0\u4e0a\u542f\u52a8\u4e00\u4e2ashell\u3002\u8fd9\u6837\u7cfb\u7edf\u5c31\u542f\u52a8\u4e86\u3002</p>"},{"location":"os/Chapter-2/#27-real-world","title":"2.7 Real world","text":"<p>\u5728\u73b0\u5b9e\u4e16\u754c\u4e2d\uff0c\u65e2\u53ef\u4ee5\u627e\u5230\u5b8f\u5185\u6838\uff0c\u4e5f\u53ef\u4ee5\u627e\u5230\u5fae\u5185\u6838\u3002\u8bb8\u591aUnix\u5185\u6838\u90fd\u662f\u5b8f\u5185\u6838\u3002\u4f8b\u5982\uff0cLinux\u7684\u5185\u6838\uff0c\u5c3d\u7ba1\u6709\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u7684\u529f\u80fd\u662f\u4f5c\u4e3a\u7528\u6237\u7ea7\u670d\u52a1\u5668\u8fd0\u884c\u7684\uff08\u5982windows\u7cfb\u7edf\uff09\u3002L4\u3001Minix\u548cQNX\u7b49\u5185\u6838\u662f\u4ee5\u670d\u52a1\u5668\u7684\u5f62\u5f0f\u7ec4\u7ec7\u7684\u5fae\u5185\u6838\uff0c\u5e76\u5728\u5d4c\u5165\u5f0f\u73af\u5883\u4e2d\u5f97\u5230\u4e86\u5e7f\u6cdb\u7684\u90e8\u7f72\u3002\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u90fd\u91c7\u7528\u4e86\u8fdb\u7a0b\u6982\u5ff5\uff0c\u5927\u591a\u6570\u8fdb\u7a0b\u90fd\u4e0exv6\u7684\u76f8\u4f3c\u3002</p> <p>\u7136\u800c\uff0c\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u652f\u6301\u8fdb\u7a0b\u53ef\u4ee5\u62e5\u6709\u591a\u4e2a\u7ebf\u7a0b\uff0c\u4ee5\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u5229\u7528\u591a\u4e2aCPU\u3002\u5728\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\u652f\u6301\u591a\u4e2a\u7ebf\u7a0b\u6d89\u53ca\u5230\u4e0d\u5c11xv6\u6ca1\u6709\u7684\u673a\u5236\uff0c\u5305\u62ec\u6f5c\u5728\u7684\u63a5\u53e3\u53d8\u5316(\u5982Linux\u7684<code>clone</code>\uff0c<code>fork</code>\u7684\u53d8\u79cd)\uff0c\u4ee5\u63a7\u5236\u7ebf\u7a0b\u6240\u5171\u4eab\u8fdb\u7a0b\u7684\u90a3\u4e9b\u90e8\u5206\u3002</p>"},{"location":"os/Chapter-2/#28-exercises","title":"2.8 Exercises","text":"<p>1\u3001\u4f60\u53ef\u4ee5\u4f7f\u7528gdb\u6765\u89c2\u5bdfkernel mode\u5230user mode\u7684\u7b2c\u4e00\u6b21\u8f6c\u6362\u3002\u8fd0\u884c<code>make qemu-gdb</code>\u3002\u5728\u540c\u4e00\u76ee\u5f55\u4e0b\u7684\u53e6\u4e00\u4e2a\u7a97\u53e3\u4e2d\uff0c\u8fd0\u884c<code>gdb</code>\u3002\u8f93\u5165gdb\u547d\u4ee4<code>break *0x3ffffff10e</code>\uff0c\u8fd9\u5c06\u5728\u5185\u6838\u4e2d\u8df3\u8f6c\u5230\u7528\u6237\u7a7a\u95f4\u7684<code>sret</code>\u6307\u4ee4\u5904\u8bbe\u7f6e\u4e00\u4e2a\u65ad\u70b9\u3002\u8f93\u5165<code>continue</code> gdb\u547d\u4ee4\uff0cgdb\u5e94\u8be5\u5728\u65ad\u70b9\u5904\u505c\u6b62\uff0c\u5e76\u5373\u5c06\u6267\u884c<code>sret</code>\u3002gdb\u73b0\u5728\u5e94\u8be5\u663e\u793a\u5b83\u6b63\u5728\u5730\u57400x0\u5904\u6267\u884c\uff0c\u8be5\u5730\u5740\u5728<code>initcode.S</code>\u7684\u7528\u6237\u7a7a\u95f4\u5f00\u59cb\u5904\u3002</p> <ol> <li> <p>\u4e0e\u5fae\u5185\u6838\u8bbe\u8ba1\u7406\u5ff5\u76f8\u5bf9\u5e94\u7684\u7406\u5ff5\uff0c\u8fd9\u4e5f\u662f\u4e00\u4e2a\u6e90\u81ea\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u6982\u5ff5\u3002\u5bf9\u4e8e\u5b8f\u5185\u6838\u6765\u8bf4\uff0c\u6574\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662f\u4e00\u4e2a\u6574\u4f53\uff0c\u5305\u62ec\u4e86\u8fdb\u7a0b\u7ba1\u7406\u3001\u5185\u5b58\u7ba1\u7406\u3001\u6587\u4ef6\u7cfb\u7edf\u7b49\u7b49</p> </li> <li> <p>\u672c\u6587\u6240\u8bf4\u7684 \"\u591a\u6838 \"\u662f\u6307\u591a\u4e2a\u5171\u4eab\u5185\u5b58\u4f46\u5e76\u884c\u6267\u884c\u7684CPU\uff0c\u6bcf\u4e2aCPU\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u5957\u5bc4\u5b58\u5668\u3002\u672c\u6587\u6709\u65f6\u4f7f\u7528\u591a\u5904\u7406\u5668\u4e00\u8bcd\u4f5c\u4e3a\u591a\u6838\u7684\u540c\u4e49\u8bcd\uff0c\u4f46\u591a\u5904\u7406\u5668\u4e5f\u53ef\u4ee5\u66f4\u5177\u4f53\u5730\u6307\u5177\u6709\u591a\u4e2a\u4e0d\u540c\u5904\u7406\u5668\u82af\u7247\u7684\u8ba1\u7b97\u673a\u3002</p> </li> </ol>"},{"location":"os/Chapter-3/","title":"Chapter 3","text":""},{"location":"os/Chapter-3/#_1","title":"\u7b2c\u4e09\u7ae0\uff1a\u9875\u8868","text":"<p>\u901a\u8fc7\u9875\u8868\u673a\u5236\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u63d0\u4f9b\u5404\u81ea\u79c1\u6709\u7684\u5730\u5740\u7a7a\u95f4\u548c\u5185\u5b58\u3002\u9875\u8868\u51b3\u5b9a\u4e86\u5185\u5b58\u5730\u5740\u7684\u542b\u4e49\uff0c\u4ee5\u53ca\u7269\u7406\u5185\u5b58\u7684\u54ea\u4e9b\u90e8\u5206\u53ef\u4ee5\u88ab\u8bbf\u95ee\u3002\u5b83\u4eec\u5141\u8bb8 xv6 \u9694\u79bb\u4e0d\u540c\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u5e76\u5c06\u5b83\u4eec\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58\u4e0a\u3002\u9875\u8868\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u95f4\u63a5\u5c42\u6b21\uff0c\u5141\u8bb8 xv6 \u5b9e\u73b0\u4e00\u4e9b\u6280\u5de7\uff1a\u5728\u51e0\u4e2a\u5730\u5740\u7a7a\u95f4\u4e2d\u6620\u5c04\u540c\u4e00\u5185\u5b58\uff08trampoline \u9875\uff09\uff0c\u4ee5\u53ca\u7528\u4e00\u4e2a\u672a\u6620\u5c04\u9875\u6765\u4fdd\u62a4\u5185\u6838\u6808\u548c\u7528\u6237\u6808\u3002\u672c\u7ae0\u5176\u4f59\u90e8\u5206\u5c06\u89e3\u91ca RISC-V \u786c\u4ef6\u63d0\u4f9b\u7684\u9875\u8868\u4ee5\u53ca xv6 \u5982\u4f55\u4f7f\u7528\u5b83\u4eec\u3002</p>"},{"location":"os/Chapter-3/#31-paging-hardware","title":"3.1  Paging hardware","text":"<p>\u63d0\u9192\u4e00\u4e0b\uff0cRISC-V \u6307\u4ee4\uff08\u5305\u62ec\u7528\u6237\u548c\u5185\u6838\uff09\u64cd\u4f5c\u7684\u662f\u865a\u62df\u5730\u5740\u3002\u673a\u5668\u7684 RAM\uff0c\u6216\u8005\u8bf4\u7269\u7406\u5185\u5b58\uff0c\u662f\u7528\u7269\u7406\u5730\u5740\u6765\u505a\u7d22\u5f15\u7684\u3002RISC-V\u7684\u9875\u8868\u786c\u4ef6\u901a\u8fc7\u5c06\u6bcf\u4e2a\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u4e00\u4e2a\u7269\u7406\u5730\u5740\u5c06\u8fd9\u4e24\u79cd\u5730\u5740\u8054\u7cfb\u8d77\u6765\u3002</p> <p>xv6\u8fd0\u884c\u5728Sv39 RISC-V\u4e0a\uff0c\u8fd9\u610f\u5473\u7740\u53ea\u4f1a\u4f7f\u752864\u4f4d\u865a\u62df\u5730\u5740\u7684\u4f4e39\u4f4d\uff0c\u9ad825\u4f4d\u6ca1\u6709\u88ab\u4f7f\u7528\u3002\u5728\u8fd9\u79cdSv39\u914d\u7f6e\u4e2d\uff0c\u4e00\u4e2aRISC-V\u9875\u8868\u5728\u903b\u8f91\u4e0a\u662f\u4e00\u4e2a\u75312\u00b2\u2077\uff08134,217,728\uff09\u4e2a\u9875\u8868\u9879\uff08Page Table Entry, PTE\uff09\u7ec4\u6210\u7684\u6570\u7ec4\u3002\u6bcf\u4e2a**PTE**\u5305\u542b\u4e00\u4e2a44\u4f4d\u7684\u7269\u7406\u9875\u53f7\uff08Physical Page Number, PPN\uff09\u548c\u4e00\u4e9b\u6807\u5fd7\u4f4d\u3002\u5206\u9875\u786c\u4ef6\u901a\u8fc7\u5229\u752839\u4f4d\u4e2d\u7684\u9ad827\u4f4d\u7d22\u5f15\u5230\u9875\u8868\u4e2d\u627e\u5230\u4e00\u4e2a**PTE**\u6765\u8f6c\u6362\u4e00\u4e2a\u865a\u62df\u5730\u5740\uff0c\u5e76\u8ba1\u7b97\u51fa\u4e00\u4e2a56\u4f4d\u7684\u7269\u7406\u5730\u5740\uff0c\u5b83\u7684\u524d44\u4f4d\u6765\u81ea\u4e8e**PTE**\u4e2d\u7684**PPN**\uff0c\u800c\u5b83\u7684\u540e12\u4f4d\u5219\u662f\u4ece\u539f\u6765\u7684\u865a\u62df\u5730\u5740\u590d\u5236\u8fc7\u6765\u7684\u3002\u56fe3.1\u663e\u793a\u4e86\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u5728\u903b\u8f91\u4e0a\u53ef\u4ee5\u628a\u9875\u8868\u770b\u6210\u662f\u4e00\u4e2a\u7b80\u5355\u7684**PTE**\u6570\u7ec4\uff08\u66f4\u5b8c\u6574\u7684\u63cf\u8ff0\u89c1\u56fe3.2\uff09\u3002\u9875\u8868\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u63a7\u5236\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff0c\u5176\u7c92\u5ea6\u4e3a4096\uff082\u00b9\u00b2\uff09\u5b57\u8282\u7684\u5bf9\u9f50\u5757\u3002\u8fd9\u6837\u7684\u5206\u5757\u79f0\u4e3a\u9875\u3002</p> <p>\u5728Sv39 RISC-V\u4e2d\uff0c\u865a\u62df\u5730\u5740\u7684\u9ad825\u4f4d\u4e0d\u7528\u4e8e\u5730\u5740\u8f6c\u6362\uff1b\u5c06\u6765\uff0cRISC-V\u53ef\u80fd\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4f4d\u6765\u5b9a\u4e49\u66f4\u591a\u7684\u8f6c\u6362\u5c42\u3002\u7269\u7406\u5730\u5740\u4e5f\u6709\u589e\u957f\u7684\u7a7a\u95f4\uff1a\u5728**PTE**\u683c\u5f0f\u4e2d\uff0c\u7269\u7406\u9875\u53f7\u8fd8\u6709 10 \u4f4d\u7684\u589e\u957f\u7a7a\u95f4\u3002</p> <p> </p> <p>\u5982\u56fe 3.2 \u6240\u793a\uff0c\u5b9e\u9645\u4e0a\u8f6c\u6362\u8fc7\u7a0b\u5206\u4e09\u6b65\u8fdb\u884c\u3002\u4e00\u4e2a\u9875\u8868\u4ee5\u4e09\u5c42\u6811\u7684\u5f62\u5f0f\u5b58\u50a8\u5728\u7269\u7406\u5185\u5b58\u4e2d\u3002\u6811\u7684\u6839\u90e8\u662f\u4e00\u4e2a 4096 \u5b57\u8282\u7684\u9875\u8868\u9875\uff0c\u5b83\u5305\u542b 512 \u4e2a PTE\uff0c\u8fd9\u4e9b PTE \u5305\u542b\u6811\u7684\u4e0b\u4e00\u7ea7\u9875\u8868\u9875\u7684\u7269\u7406\u5730\u5740\u3002\u6bcf\u4e00\u9875\u90fd\u5305\u542b 512 \u4e2a PTE\uff0c\u7528\u4e8e\u6307\u5411\u4e0b\u4e00\u4e2a\u9875\u8868\u6216\u7269\u7406\u5730\u5740\u3002\u5206\u9875\u786c\u4ef6\u7528 27 \u4f4d\u4e2d\u7684\u9ad8 9 \u4f4d\u9009\u62e9\u6839\u9875\u8868\u9875\u4e2d\u7684 PTE\uff0c\u7528\u4e2d\u95f4 9 \u4f4d\u9009\u62e9\u6811\u4e2d\u4e0b\u4e00\u7ea7\u9875\u8868\u9875\u4e2d\u7684 PTE\uff0c\u7528\u4f4e 9 \u4f4d\u9009\u62e9\u6700\u540e\u7684 PTE\u3002</p> <p>\u5982\u679c\u8f6c\u6362\u4e00\u4e2a\u5730\u5740\u6240\u9700\u7684\u4e09\u4e2a PTE \u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u4e0d\u5b58\u5728\uff0c\u5206\u9875\u786c\u4ef6\u5c31\u4f1a\u5f15\u53d1\u4e00\u4e2a**\u7f3a\u9875\u5f02\u5e38\uff08page-fault exception\uff09**\uff0c\u8ba9\u5185\u6838\u6765\u5904\u7406\u8fd9\u4e2a\u5f02\u5e38\uff08\u89c1\u7b2c 4 \u7ae0\uff09\u3002\u8fd9\u79cd\u4e09\u5c42\u7ed3\u6784\u5141\u8bb8\u9875\u8868\u5728\u5904\u7406\u5927\u8303\u56f4\u7684\u865a\u62df\u5730\u5740\u6ca1\u6709\u88ab\u6620\u5c04\u8fd9\u79cd\u5e38\u89c1\u60c5\u51b5\u65f6\uff0c\u80fd\u591f\u5ffd\u7565\u6574\u4e2a\u9875\u8868\u3002</p> <p>\u6bcf\u4e2a PTE \u90fd\u5305\u542b\u6807\u5fd7\u4f4d\uff0c\u7528\u4e8e\u544a\u8bc9\u5206\u9875\u786c\u4ef6\u76f8\u5173\u7684\u865a\u62df\u5730\u5740\u88ab\u5141\u8bb8\u600e\u6837\u4f7f\u7528\u3002<code>PTE_V</code> \u8868\u793a PTE \u662f\u5426\u5b58\u5728\uff1a\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\uff0c\u5bf9\u8be5\u9875\u7684\u5f15\u7528\u4f1a\u5f15\u8d77\u5f02\u5e38\uff08\u5373\u4e0d\u5141\u8bb8\uff09\u3002<code>PTE_R</code> \u63a7\u5236\u662f\u5426\u5141\u8bb8\u6307\u4ee4\u8bfb\u53d6\u8be5\u9875\u3002<code>PTE_W</code> \u63a7\u5236\u662f\u5426\u5141\u8bb8\u6307\u4ee4\u5411\u8be5\u9875\u5199\u5165\u3002<code>PTE_X</code> \u63a7\u5236 CPU \u662f\u5426\u53ef\u4ee5\u5c06\u9875\u9762\u7684\u5185\u5bb9\u89e3\u91ca\u4e3a\u6307\u4ee4\u5e76\u6267\u884c\u3002<code>PTE_U</code> \u63a7\u5236\u662f\u5426\u5141\u8bb8\u7528\u6237\u6001\u4e0b\u7684\u6307\u4ee4\u8bbf\u95ee\u9875\u9762\uff1b\u5982\u679c\u4e0d\u8bbe\u7f6e <code>PTE_U</code>\uff0c \u5bf9\u5e94 PTE \u53ea\u80fd\u5728\u5185\u6838\u6001\u4e0b\u4f7f\u7528\u3002\u56fe 3.2 \u663e\u793a\u4e86\u8fd9\u4e00\u5207\u7684\u5de5\u4f5c\u539f\u7406\u3002\u6807\u5fd7\u4f4d\u548c\u4e0e\u5206\u9875\u786c\u4ef6\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5728\uff08<code>kernel/riscv.h</code>\uff09\u4e2d\u3002</p> <p></p> <p>\u8981\u544a\u8bc9\u786c\u4ef6\u4f7f\u7528\u4e00\u4e2a\u9875\u8868\uff0c\u5185\u6838\u5fc5\u987b\u5c06\u5bf9\u5e94\u6839\u9875\u8868\u9875\u7684\u7269\u7406\u5730\u5740\u5199\u5165 <code>satp</code> \u5bc4\u5b58\u5668\u4e2d\u3002\u6bcf\u4e2a CPU \u90fd\u6709\u81ea\u5df1\u7684 <code>satp</code> \u5bc4\u5b58\u5668\u3002\u4e00\u4e2a CPU \u5c06\u4f7f\u7528\u81ea\u5df1\u7684 <code>satp</code> \u6240\u6307\u5411\u7684\u9875\u8868\u6765\u7ffb\u8bd1\u540e\u7eed\u6307\u4ee4\u4ea7\u751f\u7684\u6240\u6709\u5730\u5740\u3002\u6bcf\u4e2a CPU \u90fd\u6709\u81ea\u5df1\u7684 <code>satp</code>\uff0c\u8fd9\u6837\u4e0d\u540c\u7684 CPU \u53ef\u4ee5\u8fd0\u884c\u4e0d\u540c\u7684\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u9875\u8868\u6240\u63cf\u8ff0\u7684\u79c1\u6709\u5730\u5740\u7a7a\u95f4\u3002</p> <p>\u5173\u4e8e\u672f\u8bed\u7684\u4e00\u4e9b\u8bf4\u660e\uff1a\u7269\u7406\u5185\u5b58\u6307\u7684\u662f DRAM \u4e2d\u7684\u5b58\u50a8\u5355\u5143\u3002\u7269\u7406\u5b58\u50a8\u5668\u7684\u4e00\u4e2a\u5b57\u8282\u6709\u4e00\u4e2a\u5730\u5740\uff0c\u79f0\u4e3a\u7269\u7406\u5730\u5740\u3002\u5f53\u6307\u4ee4\u64cd\u4f5c\u865a\u62df\u5730\u5740\u65f6\uff0c\u5206\u9875\u786c\u4ef6\u4f1a\u5c06\u5176\u7ffb\u8bd1\u6210\u7269\u7406\u5730\u5740\uff0c\u7136\u540e\u53d1\u9001\u7ed9 DRAM \u786c\u4ef6\uff0c\u4ee5\u8bfb\u53d6\u6216\u5199\u5165\u5b58\u50a8\u3002\u4e0d\u50cf\u7269\u7406\u5185\u5b58\u548c\u865a\u62df\u5730\u5740\uff0c\u865a\u62df\u5185\u5b58\u4e0d\u662f\u4e00\u4e2a\u7269\u7406\u5bf9\u8c61\uff0c\u800c\u662f\u6307\u5185\u6838\u63d0\u4f9b\u7684\u7ba1\u7406\u7269\u7406\u5185\u5b58\u548c\u865a\u62df\u5730\u5740\u7684\u62bd\u8c61\u548c\u673a\u5236\u7684\u96c6\u5408\u3002</p>"},{"location":"os/Chapter-3/#32-kernel-address-space","title":"3.2  Kernel address space","text":"<p>Xv6 \u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u7ef4\u62a4\u4e00\u4e2a\u7528\u4e8e\u63cf\u8ff0\u8fdb\u7a0b\u7684\u7528\u6237\u5730\u5740\u7a7a\u95f4\u7684\u9875\u8868\uff0c\u5916\u52a0\u4e00\u4e2a\u5355\u72ec\u7684\u63cf\u8ff0\u5185\u6838\u5730\u5740\u7a7a\u95f4\u7684\u9875\u8868\u3002\u5185\u6838\u914d\u7f6e\u5176\u5730\u5740\u7a7a\u95f4\u7684\u5e03\u5c40\uff0c\u4f7f\u5176\u80fd\u591f\u901a\u8fc7\u53ef\u9884\u6d4b\u7684\u865a\u62df\u5730\u5740\u8bbf\u95ee\u7269\u7406\u5185\u5b58\u548c\u5404\u79cd\u786c\u4ef6\u8d44\u6e90\u3002\u56fe 3.3 \u663e\u793a\u4e86\u8fd9\u4e2a\u8bbe\u8ba1\u662f\u5982\u4f55\u5c06\u5185\u6838\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u7269\u7406\u5730\u5740\u7684\u3002\u6587\u4ef6\uff08<code>kernel/memlayout.h</code>\uff09\u58f0\u660e\u4e86 xv6 \u5185\u6838\u5185\u5b58\u5e03\u5c40\u7684\u5e38\u91cf\u3002</p> <p> </p> <p>QEMU \u6a21\u62df\u7684\u8ba1\u7b97\u673a\u5305\u542b RAM\uff08 \u7269\u7406\u5185\u5b58\uff09\uff0c\u4ece\u7269\u7406\u5730\u5740 <code>0x80000000</code> \u5f00\u59cb\uff0c \u81f3\u5c11\u5230 <code>0x86400000</code>\uff0cxv6 \u79f0\u4e4b\u4e3a <code>PHYSTOP</code>\u3002QEMU \u6a21\u62df\u8fd8\u5305\u62ec I/O \u8bbe\u5907\uff0c\u5982\u78c1\u76d8\u63a5\u53e3\u3002QEMU \u5c06\u8bbe\u5907\u63a5\u53e3\u4f5c\u4e3a\u5185\u5b58\u6620\u5c04\uff08memory-mapped\uff09\u7684\u63a7\u5236\u5bc4\u5b58\u5668\u66b4\u9732\u7ed9\u8f6f\u4ef6\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4f4d\u4e8e\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684 <code>0x80000000</code> \u4ee5\u4e0b\u3002\u5185\u6838\u53ef\u4ee5\u901a\u8fc7\u8bfb\u53d6/\u5199\u5165\u8fd9\u4e9b\u7279\u6b8a\u7684\u7269\u7406\u5730\u5740\u4e0e\u8bbe\u5907\u8fdb\u884c\u4ea4\u4e92\uff1b\u8fd9\u79cd\u8bfb\u53d6\u548c\u5199\u5165\u4e0e\u8bbe\u5907\u786c\u4ef6\u800c\u4e0d\u662f\u4e0e RAM \u8fdb\u884c\u901a\u4fe1\u3002\u7b2c 4 \u7ae0\u89e3\u91ca\u4e86 xv6 \u5982\u4f55\u4e0e\u8bbe\u5907\u4ea4\u4e92\u3002</p> <p>\u5185\u6838\u5bf9RAM\u548c\u5185\u5b58\u6620\u5c04\u7684\u8bbe\u5907\u5bc4\u5b58\u5668\u4f7f\u7528\u201c\u76f4\u63a5\u6620\u5c04\u201d\uff0c\u4e5f\u5c31\u662f\u5c06\u8fd9\u4e9b\u8d44\u6e90\u6620\u5c04\u5230\u548c\u5b83\u4eec\u7269\u7406\u5730\u5740\u76f8\u540c\u7684\u865a\u62df\u5730\u5740\u4e0a\u3002\u4f8b\u5982\uff0c\u5185\u6838\u672c\u8eab\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4\u548c\u7269\u7406\u5185\u5b58\u4e2d\u7684\u4f4d\u7f6e\u90fd\u662f<code>KERNBASE=0x80000000</code>\u3002\u76f4\u63a5\u6620\u5c04\u7b80\u5316\u4e86\u8bfb/\u5199\u7269\u7406\u5185\u5b58\u7684\u5185\u6838\u4ee3\u7801\u3002\u4f8b\u5982\uff0c\u5f53 <code>fork</code> \u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u7528\u6237\u5185\u5b58\u65f6\uff0c\u5206\u914d\u5668\u8fd4\u56de\u8be5\u5185\u5b58\u7684\u7269\u7406\u5730\u5740\uff1b<code>fork</code> \u5728\u5c06\u7236\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\u590d\u5236\u5230\u5b50\u8fdb\u7a0b\u65f6\uff0c\u76f4\u63a5\u4f7f\u7528\u8be5\u5730\u5740\u4f5c\u4e3a\u865a\u62df\u5730\u5740\u3002</p> <p>\u6709\u51e0\u4e2a\u5185\u6838\u865a\u62df\u5730\u5740\u4e0d\u662f\u76f4\u63a5\u6620\u5c04\uff1a</p> <ul> <li> <p>trampoline \u9875\u3002\u5b83\u88ab\u6620\u5c04\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u9876\u7aef\uff1b\u7528\u6237\u9875\u8868\u4e5f\u6709\u8fd9\u4e2a\u6620\u5c04\u3002\u7b2c 4 \u7ae0\u8ba8\u8bba\u4e86 trampoline \u9875\u7684\u4f5c\u7528\uff0c\u4f46\u6211\u4eec\u5728\u8fd9\u91cc\u770b\u5230\u4e86\u9875\u8868\u7684\u4e00\u4e2a\u6709\u8da3\u7684\u7528\u4f8b\uff1b\u4e00\u4e2a\u7269\u7406\u9875\uff08\u5b58\u653e trampoline \u4ee3\u7801\uff09\u5728\u5185\u6838\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e2d\u88ab\u6620\u5c04\u4e86\u4e24\u6b21\uff1a\u4e00\u6b21\u662f\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u9876\u90e8\uff0c\u4e00\u6b21\u662f\u76f4\u63a5\u6620\u5c04\u3002</p> </li> <li> <p>\u5185\u6838\u6808\u9875\u3002\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u5185\u6838\u6808\uff0c\u5185\u6838\u6808\u88ab\u6620\u5c04\u5230\u9ad8\u5730\u5740\u5904\uff0c\u6240\u4ee5 xv6 \u53ef\u4ee5\u5728\u5b83\u540e\u9762\u7559\u4e0b\u4e00\u4e2a\u672a\u6620\u5c04\u7684\u5b88\u62a4\u9875\u3002\u5b88\u62a4\u9875\u7684 PTE \u662f\u65e0\u6548\u7684\uff08\u4e0d\u8bbe\u7f6e <code>PTE_V</code> \u4f4d\uff09\uff0c\u8fd9\u6837\u5982\u679c\u5185\u6838\u6808\u6ea2\u51fa\uff0c\u5f88\u53ef\u80fd\u4f1a\u5f15\u8d77\u5f02\u5e38\uff0c\u5185\u6838\u4f1a\u62a5\u9519\u3002\u5982\u679c\u6ca1\u6709\u9632\u62a4\u9875\uff0c\u6808\u6ea2\u51fa\u65f6\u4f1a\u8986\u76d6\u5176\u4ed6\u5185\u6838\u5185\u5b58\uff0c\u5bfc\u81f4\u4e0d\u6b63\u786e\u7684\u64cd\u4f5c\u3002\u62a5\u9519\u8fd8\u662f\u6bd4\u8f83\u597d\u7684\u3002</p> </li> </ul> <p>\u5185\u6838\u901a\u8fc7\u9ad8\u5730\u5740\u6620\u5c04\u4f7f\u7528\u5b83\u7684\u6808\u7a7a\u95f4\uff0c\u6808\u7a7a\u95f4\u4e5f\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u7684\u5730\u5740\u88ab\u5185\u6838\u8bbf\u95ee\u3002\u53e6\u4e00\u79cd\u7684\u8bbe\u8ba1\u662f\u53ea\u4f7f\u7528\u76f4\u63a5\u6620\u5c04\uff0c\u5e76\u5728\u76f4\u63a5\u6620\u5c04\u7684\u5730\u5740\u4e0a\u4f7f\u7528 stack\u3002\u4f46\u662f\u5728\u8fd9\u79cd\u5b89\u6392\u4e2d\uff0c\u63d0\u4f9b\u4fdd\u62a4\u9875\u5c06\u6d89\u53ca\u5230\u53d6\u6d88\u6620\u5c04\u865a\u62df\u5730\u5740\uff0c\u5426\u5219\u8fd9\u4e9b\u5730\u5740\u5c06\u6307\u5411\u7269\u7406\u5185\u5b58\uff0c\u8fd9\u5c06\u5f88\u96be\u4f7f\u7528\u3002</p> <p>\u5185\u6838\u5c06 trampoline \u548c text\uff08\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u4ee3\u7801\u6bb5\uff09\u6620\u5c04\u4e3a\u6709 <code>PTE_R</code> \u548c <code>PTE_X</code> \u6743\u9650\u7684\u9875\u3002\u5185\u6838\u4ece\u8fd9\u4e9b\u9875\u8bfb\u53d6\u548c\u6267\u884c\u6307\u4ee4\u3002\u5185\u6838\u6620\u5c04\u7684\u5176\u4ed6\u9875\u4f1a\u6709 <code>PTE_R</code> \u548c <code>PTE_W</code> \u6743\u9650\uff0c\u4ee5\u4fbf\u5185\u6838\u8bfb\u5199\u8fd9\u4e9b\u9875\u9762\u7684\u5185\u5b58\u3002\u5b88\u62a4\u9875\u7684\u6620\u5c04\u662f\u65e0\u6548\u7684\uff08\u4e0d\u8bbe\u7f6e <code>PTE_V</code>\uff09\u3002 </p>"},{"location":"os/Chapter-3/#33-code-creating-an-address-space","title":"3.3  Code: creating an address space","text":"<p>\u5927\u90e8\u5206\u7528\u4e8e\u64cd\u4f5c\u5730\u5740\u7a7a\u95f4\u548c\u9875\u8868\u7684 xv6 \u4ee3\u7801\u90fd\u5728<code>vm.c</code>\uff08<code>kernel/vm.c:1</code>\uff09\u4e2d\u3002\u6838\u5fc3\u6570\u636e\u7ed3\u6784\u662f <code>pagetable_t</code>\uff0c\u5b83\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u6307\u5411 RISC-V \u6839\u9875\u8868\u9875\u7684\u6307\u9488\uff1b<code>pagetable_t</code>\u53ef\u4ee5\u662f\u5185\u6838\u9875\u8868\uff0c\u4e5f\u53ef\u4ee5\u662f\u8fdb\u7a0b\u7684\u9875\u8868\u3002\u6838\u5fc3\u51fd\u6570\u662f <code>walk</code> \u548c <code>mappages</code>\uff0c\u524d\u8005\u901a\u8fc7\u865a\u62df\u5730\u5740\u5f97\u5230 PTE\uff0c\u540e\u8005\u5c06\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u7269\u7406\u5730\u5740\u3002\u4ee5 <code>kvm</code> \u5f00\u5934\u7684\u51fd\u6570\u64cd\u4f5c\u5185\u6838\u9875\u8868\uff1b\u4ee5 <code>uvm</code> \u5f00\u5934\u7684\u51fd\u6570\u64cd\u4f5c\u7528\u6237\u9875\u8868\uff1b\u5176\u4ed6\u51fd\u6570\u540c\u65f6\u7528\u4e8e\u8fd9\u4e24\u79cd\u9875\u8868\u3002<code>copyout</code>\u548c<code>copyin</code>\u5c06\u6570\u636e\u590d\u5236\u5230\u6216\u590d\u5236\u51fa\u88ab\u4f5c\u4e3a\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u7684\u7528\u6237\u865a\u62df\u5730\u5740\uff1b\u5b83\u4eec\u5728 <code>vm.c</code> \u4e2d\uff0c\u56e0\u4e3a\u5b83\u4eec\u9700\u8981\u663e\u5f0f\u8f6c\u6362\u7528\u6237\u7a7a\u95f4\u7684\u5730\u5740\uff0c\u4ee5\u4fbf\u627e\u5230\u76f8\u5e94\u7684\u7269\u7406\u5185\u5b58\u3002</p> <p>\u5728\u673a\u5668\u542f\u52a8\u65f6\uff0c\u5728\u542f\u52a8\u5e8f\u5217\u7684\u9760\u524d\u90e8\u5206\uff0c<code>main</code> \u8c03\u7528 <code>kvminit</code>\uff08<code>kernel/vm.c:22</code>\uff09\u6765\u521b\u5efa\u5185\u6838\u9875\u8868\u3002\u8fd9\u4e2a\u8c03\u7528\u53d1\u751f\u5728 xv6 \u5728 RISC-V \u542f\u7528\u5206\u9875\u4e4b\u524d\uff0c\u6240\u4ee5\u5730\u5740\u76f4\u63a5\u6307\u5411\u7269\u7406\u5185\u5b58\u3002<code>kvminit</code> \u9996\u5148\u5206\u914d\u4e00\u9875\u7269\u7406\u5185\u5b58\u6765\u5b58\u653e\u6839\u9875\u8868\u9875\u3002\u7136\u540e\u8c03\u7528 <code>kvmmap</code> \u5c06\u5185\u6838\u6240\u9700\u8981\u7684\u786c\u4ef6\u8d44\u6e90\u6620\u5c04\u5230\u7269\u7406\u5730\u5740\u3002\u8fd9\u4e9b\u8d44\u6e90\u5305\u62ec\u5185\u6838\u7684\u6307\u4ee4\u548c\u6570\u636e\uff0c<code>KERNBASE</code> \u5230 <code>PHYSTOP</code>\u7684\u7269\u7406\u5185\u5b58\uff0c\u4ee5\u53ca\u5b9e\u9645\u4e0a\u662f\u8bbe\u5907\u7684\u5185\u5b58\u8303\u56f4\u3002</p> <p><code>kvmmap</code>\uff08<code>kernel/vm.c:118</code>\uff09\u8c03\u7528 <code>mappages</code>\uff08<code>kernel/vm.c:149</code>\uff09\uff0c\u5b83\u5c06\u6307\u5b9a\u8303\u56f4\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u4e00\u6bb5\u7269\u7406\u5730\u5740\u3002\u5b83\u5c06\u8303\u56f4\u5185\u5730\u5740\u5206\u5272\u6210\u591a\u9875\uff08\u5ffd\u7565\u4f59\u6570\uff09\uff0c\u6bcf\u6b21\u6620\u5c04\u4e00\u9875\u7684\u8d77\u59cb\u5730\u5740\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u8981\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\uff08\u9875\u7684\u8d77\u59cb\u5730\u5740\uff09\uff0c<code>mapages</code> \u8c03\u7528 <code>walk</code> \u627e\u5230\u8be5\u5730\u5740\u7684\u6700\u540e\u4e00\u7ea7 PTE \u7684\u5730\u5740\u3002\u7136\u540e\uff0c\u5b83\u914d\u7f6e PTE\uff0c\u4f7f\u5176\u6301\u6709\u76f8\u5173\u7684\u7269\u7406\u9875\u53f7\u3001\u6240\u9700\u7684\u6743\u9650\uff08<code>PTE_W</code>\u3001<code>PTE_X</code>\u548c/\u6216<code>PTE_R</code>\uff09\uff0c\u4ee5\u53ca<code>PTE_V</code>\u6765\u6807\u8bb0 PTE \u4e3a\u6709\u6548\uff08<code>kernel/vm.c:161</code>\uff09\u3002</p> <p><code>walk</code>\uff08<code>kernel/vm.c:72</code>\uff09\u6a21\u4eff RISC-V \u5206\u9875\u786c\u4ef6\u67e5\u627e\u865a\u62df\u5730\u5740\u7684 PTE\uff08\u89c1\u56fe 3.2\uff09\u3002<code>walk</code> \u6bcf\u6b21\u964d\u4f4e 9 \u4f4d\u6765\u67e5\u627e\u4e09\u7ea7\u9875\u8868\u3002\u5b83\u4f7f\u7528\u6bcf\u4e00\u7ea7\u7684 9 \u4f4d\u865a\u62df\u5730\u5740\u6765\u67e5\u627e\u4e0b\u4e00\u7ea7\u9875\u8868\u6216\u6700\u540e\u4e00\u7ea7\uff08<code>kernel/vm.c:78</code>\uff09\u7684 PTE\u3002\u5982\u679c PTE \u65e0\u6548\uff0c\u90a3\u4e48\u6240\u9700\u7684\u7269\u7406\u9875\u8fd8\u6ca1\u6709\u88ab\u5206\u914d\uff1b\u5982\u679c <code>alloc</code> \u53c2\u6570\u88ab\u8bbe\u7f6e\uff0c<code>walk</code> \u4f1a\u5206\u914d\u4e00\u4e2a\u65b0\u7684\u9875\u8868\u9875\uff0c\u5e76\u628a\u5b83\u7684\u7269\u7406\u5730\u5740\u653e\u5728 PTE \u4e2d\u3002\u5b83\u8fd4\u56de \u6811\u4e2d\u6700\u4f4e\u5c42PTE\u7684\u5730\u5740\uff08<code>kernel/vm.c:88</code>\uff09\u3002</p> <p><code>main</code> \u8c03\u7528 <code>kvminithart</code>\uff08<code>kernel/vm.c:53</code>\uff09\u6765\u6620\u5c04\u5185\u6838\u9875\u8868\u3002\u5b83\u5c06\u6839\u9875\u8868\u9875\u7684\u7269\u7406\u5730\u5740\u5199\u5165\u5bc4\u5b58\u5668 <code>satp</code> \u4e2d\u3002\u5728\u8fd9\u4e4b\u540e\uff0cCPU \u5c06\u4f7f\u7528\u5185\u6838\u9875\u8868\u7ffb\u8bd1\u5730\u5740\u3002\u7531\u4e8e\u5185\u6838\u4f7f\u7528\u552f\u4e00\u6620\u5c04\uff0c\u6240\u4ee5\u6307\u4ee4\u7684\u865a\u62df\u5730\u5740\u5c06\u6620\u5c04\u5230\u6b63\u786e\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\u3002</p> <p><code>procinit</code>\uff08<code>kernel/proc.c:26</code>\uff09\uff0c\u5b83\u7531 <code>main</code> \u8c03\u7528\uff0c\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u5206\u914d\u4e00\u4e2a\u5185\u6838\u6808\u3002\u5b83\u5c06\u6bcf\u4e2a\u6808\u6620\u5c04\u5728 <code>KSTACK</code> \u751f\u6210\u7684\u865a\u62df\u5730\u5740\u4e0a\uff0c\u8fd9\u5c31\u4e3a\u6808\u5b88\u62a4\u9875\u7559\u4e0b\u4e86\u7a7a\u95f4\u3002<code>kvmmap</code> \u5c06\u5bf9\u5e94\u7684PTE\u52a0\u5165\u5230\u5185\u6838\u9875\u8868\u4e2d\uff0c\u7136\u540e\u8c03\u7528 <code>kvminithart</code> \u5c06\u5185\u6838\u9875\u8868\u91cd\u65b0\u52a0\u8f7d\u5230 <code>satp</code> \u4e2d\uff0c\u8fd9\u6837\u786c\u4ef6\u5c31\u77e5\u9053\u65b0\u7684 PTE \u4e86\u3002</p> <p>\u6bcf\u4e2a RISC-V CPU \u90fd\u4f1a\u5728 **Translation Look-aside Buffer(TLB)**\u4e2d\u7f13\u5b58\u9875\u8868\u9879\uff0c\u5f53 xv6 \u6539\u53d8\u9875\u8868\u65f6\uff0c\u5fc5\u987b\u544a\u8bc9 CPU \u4f7f\u76f8\u5e94\u7684\u7f13\u5b58 TLB \u9879\u65e0\u6548\u3002\u5982\u679c\u5b83\u4e0d\u8fd9\u6837\u505a\uff0c\u90a3\u4e48\u5728\u4ee5\u540e\u7684\u67d0\u4e2a\u65f6\u523b\uff0cTLB \u53ef\u80fd\u4f1a\u4f7f\u7528\u4e00\u4e2a\u65e7\u7684\u7f13\u5b58\u6620\u5c04\uff0c\u6307\u5411\u4e00\u4e2a\u7269\u7406\u9875\uff0c\u800c\u8fd9\u4e2a\u7269\u7406\u9875\u5728\u6b64\u671f\u95f4\u5df2\u7ecf\u5206\u914d\u7ed9\u4e86\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8fd9\u6837\u7684\u8bdd\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u5728\u5176\u4ed6\u8fdb\u7a0b\u7684\u5185\u5b58\u4e0a\u201c\u4e71\u5199\u4e71\u753b\u201c\u3002RISC-V \u6709\u4e00\u6761\u6307\u4ee4 <code>sfence.vma</code>\uff0c\u53ef\u4ee5\u5237\u65b0\u5f53\u524d CPU \u7684 TLB\u3002xv6 \u5728<code>kvminithart</code>\u4e2d\uff0c\u91cd\u65b0\u52a0\u8f7d <code>satp</code> \u5bc4\u5b58\u5668\u540e\uff0c \u6267\u884c <code>sfence.vma</code>\uff0c\u4e5f\u4f1a\u5728\u4ece\u5185\u6838\u7a7a\u95f4\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\u524d\uff0c\u5207\u6362\u5230\u7528\u6237\u9875\u8868\u7684trampoline \u4ee3\u7801\u4e2d\u6267\u884c <code>sfence.vma</code>\uff08<code>kernel/trampoline.S:79</code>\uff09\u3002</p>"},{"location":"os/Chapter-3/#34-physical-memory-allocation","title":"3.4  Physical memory allocation","text":"<p>\u5185\u6838\u5fc5\u987b\u5728\u8fd0\u884c\u65f6\u4e3a\u9875\u8868\u3001\u7528\u6237\u5185\u5b58\u3001\u5185\u6838\u5806\u6808\u548c\u7ba1\u9053\u7f13\u51b2\u533a\u5206\u914d\u548c\u91ca\u653e\u7269\u7406\u5185\u5b58\u3002xv6 \u4f7f\u7528\u5185\u6838\u5730\u5740\u7ed3\u675f\u5230 <code>PHYSTOP</code> \u4e4b\u95f4\u7684\u7269\u7406\u5185\u5b58\u6765\u8fdb\u884c\u8fd0\u884c\u65f6\u5206\u914d\u3002\u5b83\u6bcf\u6b21\u5206\u914d\u548c\u91ca\u653e\u6574\u4e2a4096 \u5b57\u8282\u7684\u9875\u9762\u3002\u5b83\u901a\u8fc7\u4fdd\u5b58\u7a7a\u95f2\u9875\u94fe\u8868\uff0c\u6765\u8bb0\u5f55\u54ea\u4e9b\u9875\u662f\u7a7a\u95f2\u7684\u3002\u5206\u914d\u5305\u62ec\u4ece\u94fe\u8868\u4e2d\u5220\u9664\u4e00\u9875\uff1b\u91ca\u653e\u5305\u62ec\u5c06\u91ca\u653e\u7684\u9875\u9762\u6dfb\u52a0\u5230\u7a7a\u95f2\u9875\u94fe\u8868\u4e2d\u3002</p>"},{"location":"os/Chapter-3/#35-code-physical-memory-allocator","title":"3.5  Code: Physical memory allocator","text":"<p>\u5206\u914d\u5668\u5728 <code>kalloc.c</code>\uff08<code>kernel/kalloc.c:1</code>\uff09\u4e2d\u3002\u5206\u914d\u5668\u7684\u6570\u636e\u7ed3\u6784\u662f\u4e00\u4e2a\u53ef\u4f9b\u5206\u914d\u7684\u7269\u7406\u5185\u5b58\u9875\u7684**\u7a7a\u95f2\u94fe\u8868**\uff0c\u6bcf\u4e2a\u7a7a\u95f2\u9875\u7684\u94fe\u8868\u5143\u7d20\u662f\u4e00\u4e2a\u7ed3\u6784\u4f53 <code>struct run</code>\uff08<code>kernel/kalloc.c:17</code>\uff09\u3002\u5206\u914d\u5668\u4ece\u54ea\u91cc\u83b7\u5f97\u5185\u5b58\u6765\u5b58\u653e\u8fd9\u4e2a\u7ed3\u6784\u4f53\u5462\uff1f\u5b83\u628a\u6bcf\u4e2a\u7a7a\u95f2\u9875\u7684 <code>run</code> \u7ed3\u6784\u4f53\u5b58\u50a8\u5728\u7a7a\u95f2\u9875\u81ea\u8eab\u91cc\u9762\uff0c\u56e0\u4e3a\u90a3\u91cc\u6ca1\u6709\u5176\u4ed6\u4e1c\u897f\u5b58\u50a8\u3002\u7a7a\u95f2\u94fe\u8868\u7531\u4e00\u4e2a**\u81ea\u65cb\u9501**\u4fdd\u62a4\uff08<code>kernel/kalloc.c:21-24</code>\uff09\u3002\u94fe\u8868\u548c\u9501\u88ab\u5305\u88f9\u5728\u4e00\u4e2a\u7ed3\u6784\u4f53\u4e2d\uff0c\u4ee5\u660e\u786e\u9501\u4fdd\u62a4\u7684\u662f\u7ed3\u6784\u4f53\u4e2d\u7684\u5b57\u6bb5\u3002\u73b0\u5728\uff0c\u8bf7\u5ffd\u7565\u9501\u4ee5\u53ca <code>acquire</code> \u548c<code>release</code> \u7684\u8c03\u7528\uff1b\u7b2c 6 \u7ae0\u5c06\u8be6\u7ec6\u7814\u7a76\u9501\u3002</p> <p><code>main</code> \u8c03\u7528 <code>kinit</code> \u6765\u521d\u59cb\u5316\u5206\u914d\u5668\uff08<code>kernel/kalloc.c:27</code>\uff09\u3002<code>kinit</code> \u521d\u59cb\u5316\u7a7a\u95f2\u9875\u94fe\u8868\uff0c\u4ee5\u4fdd\u5b58\u5185\u6838\u5730\u5740\u7ed3\u675f\u5230 <code>PHYSTOP</code> \u4e4b\u95f4\u7684\u6bcf\u4e00\u9875\u3002xv6 \u5e94\u8be5\u901a\u8fc7\u89e3\u6790\u786c\u4ef6\u63d0\u4f9b\u7684\u914d\u7f6e\u4fe1\u606f\u6765\u786e\u5b9a\u6709\u591a\u5c11\u7269\u7406\u5185\u5b58\u53ef\u7528\u3002\u4f46\u662f\u5b83\u6ca1\u6709\u8fd9\u4e48\u505a\uff0c\u800c\u662f\u5047\u8bbe\u673a\u5668\u6709 128M \u5b57\u8282\u7684 RAM\u3002<code>kinit</code> \u901a\u8fc7\u8c03\u7528<code>freerange</code> \u6765\u6dfb\u52a0\u5185\u5b58\u5230\u7a7a\u95f2\u9875\u94fe\u8868\uff0c<code>freerange</code> \u5219\u5bf9\u6bcf\u4e00\u9875\u90fd\u8c03\u7528 <code>kfree</code>\u3002PTE \u53ea\u80fd\u6307\u5411\u63094096 \u5b57\u8282\u5bf9\u9f50\u7684\u7269\u7406\u5730\u5740\uff084096 \u7684\u500d\u6570\uff09\uff0c\u56e0\u6b64 <code>freerange</code> \u4f7f\u7528 <code>PGROUNDUP</code> \u6765\u786e\u4fdd\u5b83\u53ea\u6dfb\u52a0\u5bf9\u9f50\u7684\u7269\u7406\u5730\u5740\u5230\u7a7a\u95f2\u94fe\u8868\u4e2d\u3002\u5206\u914d\u5668\u5f00\u59cb\u65f6\u6ca1\u6709\u5185\u5b58\uff1b\u8fd9\u4e9b\u5bf9 <code>kfree</code> \u7684\u8c03\u7528\u7ed9\u4e86\u5b83\u4e00\u4e9b\u5185\u5b58\u7ba1\u7406\u3002</p> <p>\u5206\u914d\u5668\u6709\u65f6\u628a\u5730\u5740\u5f53\u4f5c\u6574\u6570\u6765\u5904\u7406\uff0c\u4ee5\u4fbf\u5bf9\u5176\u8fdb\u884c\u8fd0\u7b97\uff08\u5982 <code>freerange</code> \u904d\u5386\u6240\u6709\u9875\uff09\uff0c \u6709\u65f6\u628a\u5730\u5740\u5f53\u4f5c\u6307\u9488\u6765\u8bfb\u5199\u5185\u5b58\uff08\u5982\u64cd\u4f5c\u5b58\u50a8\u5728\u6bcf\u9875\u4e2d\u7684 <code>run</code> \u7ed3\u6784\u4f53\uff09\uff1b\u8fd9\u79cd\u5bf9\u5730\u5740\u7684\u53cc\u91cd\u4f7f\u7528\u662f\u5206\u914d\u5668\u4ee3\u7801\u4e2d\u5145\u6ee1 C \u7c7b\u578b\u8f6c\u6362\u7684\u4e3b\u8981\u539f\u56e0\u3002\u53e6\u4e00\u4e2a\u539f\u56e0\u662f\uff0c\u91ca\u653e\u548c\u5206\u914d\u672c\u8d28\u4e0a\u6539\u53d8\u4e86\u5185\u5b58\u7684\u7c7b\u578b\u3002</p> <p><code>kfree</code>\uff08<code>kernel/kalloc.c:47</code>\uff09\u5c06\u88ab\u91ca\u653e\u7684\u5185\u5b58\u4e2d\u7684\u6bcf\u4e2a\u5b57\u8282\u8bbe\u7f6e\u4e3a1\u3002\u8fd9\u5c06\u4f7f\u5f97\u91ca\u653e\u5185\u5b58\u540e\u4f7f\u7528\u5185\u5b58\u7684\u4ee3\u7801\uff08\u4f7f\u7528\u60ac\u7a7a\u5f15\u7528\uff09\u5c06\u4f1a\u8bfb\u53d6\u5783\u573e\u800c\u4e0d\u662f\u65e7\u7684\u6709\u6548\u5185\u5bb9\uff1b\u5e0c\u671b\u8fd9\u5c06\u5bfc\u81f4\u8fd9\u7c7b\u4ee3\u7801\u66f4\u5feb\u5730\u5d29\u6e83\u3002\u7136\u540e <code>kfree</code> \u5c06\u9875\u9762\u9884\u5b58\u5165\u91ca\u653e\u5217\u8868\uff1a\u5b83\u5c06 <code>pa</code>\uff08\u7269\u7406\u5730\u5740\uff09\u8f6c\u4e3a\u6307\u5411\u7ed3\u6784\u4f53 <code>run</code> \u7684\u6307\u9488\uff0c\u5728 <code>r-&gt;next</code> \u4e2d\u8bb0\u5f55\u7a7a\u95f2\u94fe\u8868\u4e4b\u524d\u7684\u8282\u70b9\uff0c\u5e76\u5c06\u91ca\u653e\u5217\u8868\u8bbe\u4e3a <code>r</code>\u3002<code>kalloc</code>\u79fb\u9664\u5e76\u8fd4\u56de\u7a7a\u95f2\u94fe\u8868\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u3002</p>"},{"location":"os/Chapter-3/#36-process-address-space","title":"3.6  Process address space","text":"<p>\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u9875\u8868\uff0c\u5f53 xv6 \u5728\u8fdb\u7a0b\u95f4\u5207\u6362\u65f6\uff0c\u4e5f\u4f1a\u6539\u53d8\u9875\u8868\u3002\u5982\u56fe 2.3 \u6240\u793a\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\u4ece\u865a\u62df\u5730\u5740 0 \u5f00\u59cb\uff0c\u53ef\u4ee5\u589e\u957f\u5230 <code>MAXVA</code>\uff08<code>kernel/riscv.h:348</code>\uff09\uff0c\u539f\u5219\u4e0a\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u5bfb\u5740 256GB \u7684\u5185\u5b58\u3002</p> <p>\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u8981\u6c42 xv6 \u63d0\u4f9b\u66f4\u591a\u7684\u7528\u6237\u5185\u5b58\u65f6\uff0cxv6 \u9996\u5148\u4f7f\u7528 <code>kalloc</code> \u6765\u5206\u914d\u7269\u7406\u9875\uff0c\u7136\u540e\u5c06\u6307\u5411\u65b0\u7269\u7406\u9875\u7684 PTE \u6dfb\u52a0\u5230\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d\u3002Xv6 \u8bbe\u7f6e\u8fd9\u4e9b PTE \u7684 <code>PTE_W</code>\u3001<code>PTE_X</code>\u3001<code>PTE_R</code>\u3001<code>PTE_U</code> \u548c <code>PTE_V</code> \u6807\u5fd7\u3002\u5927\u591a\u6570\u8fdb\u7a0b\u4e0d\u4f7f\u7528\u6574\u4e2a\u7528\u6237\u5730\u5740\u7a7a\u95f4\uff1bxv6 \u5c06\u4e0d\u4f7f\u7528\u7684 PTE \u7684 <code>PTE_V</code> \u4f4d\u4fdd\u6301\u4e3a\u6e05\u9664\u72b6\u6001\u3002</p> <p>\u6211\u4eec\u5728\u8fd9\u91cc\u770b\u5230\u4e86\u51e0\u4e2a\u6709\u8da3\u4f8b\u5b50\uff0c\u662f\u5173\u4e8e\u4f7f\u7528\u9875\u8868\u7684\u3002\u9996\u5148\uff0c\u4e0d\u540c\u7684\u8fdb\u7a0b\u9875\u8868\u5c06\u7528\u6237\u5730\u5740\u8f6c\u5316\u4e3a\u7269\u7406\u5185\u5b58\u7684\u4e0d\u540c\u9875\uff0c\u8fd9\u6837\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u79c1\u6709\u7684\u7528\u6237\u5185\u5b58\u3002\u7b2c\u4e8c\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u8ba4\u4e3a\u81ea\u5df1\u7684\u5185\u5b58\u5177\u6709\u4ece\u96f6\u5f00\u59cb\u7684\u8fde\u7eed\u7684\u865a\u62df\u5730\u5740\uff0c\u800c\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58\u53ef\u4ee5\u662f\u4e0d\u8fde\u7eed\u7684\u3002\u7b2c\u4e09\uff0c\u5185\u6838\u4f1a\u6620\u5c04\u5e26\u6709 <code>trampoline</code> \u4ee3\u7801\u7684\u9875\u5230\u7528\u6237\u5730\u5740\u7a7a\u95f4\u9876\u7aef\uff0c\u56e0\u6b64\uff0c\u6709\u4e00\u7269\u7406\u5185\u5b58\u9875\u5728\u6240\u6709\u5730\u5740\u7a7a\u95f4\u4e2d\u90fd\u4f1a\u51fa\u3002</p> <p></p> <p>\u56fe 3.4 \u66f4\u8be6\u7ec6\u5730\u663e\u793a\u4e86 xv6 \u4e2d\u6267\u884c\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\u5e03\u5c40\u3002\u6808\u53ea\u6709\u4e00\u9875\uff0c\u56fe\u4e2d\u663e\u793a\u7684\u662f\u7531<code>exec</code> \u521b\u5efa\u7684\u521d\u59cb\u5185\u5bb9\u3002\u4f4d\u4e8e\u6808\u9876\u90e8\u7684\u5b57\u7b26\u4e32\u4e2d\u5305\u542b\u4e86\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u53c2\u6570\u548c\u6307\u5411\u4ed6\u4eec\u7684\u6307\u9488\u6570\u7ec4\u3002\u5728\u4e0b\u65b9\u662f\u5141\u8bb8\u7a0b\u5e8f\u5728 <code>main</code> \u542f\u52a8\u7684\u503c\uff0c\u5c31\u50cf\u51fd\u6570 <code>main(argc, argv)</code> \u662f\u521a\u521a\u88ab\u8c03\u7528\u4e00\u6837[1]\u3002</p> <p>\u4e3a\u4e86\u68c0\u6d4b\u7528\u6237\u6808\u6ea2\u51fa\u5206\u914d\u7684\u6808\u5185\u5b58\uff0cxv6 \u4f1a\u5728 stack \u7684\u4e0b\u65b9\u653e\u7f6e\u4e00\u4e2a\u65e0\u6548\u7684\u4fdd\u62a4\u9875\u3002\u5982\u679c\u7528\u6237\u6808\u6ea2\u51fa\uff0c\u800c\u8fdb\u7a0b\u8bd5\u56fe\u4f7f\u7528\u6808\u4e0b\u9762\u7684\u5730\u5740\uff0c\u786c\u4ef6\u4f1a\u56e0\u4e3a\u8be5\u6620\u5c04\u65e0\u6548\u800c\u4ea7\u751f\u4e00\u4e2a\u7f3a\u9875\u5f02\u5e38\u3002\u4e00\u4e2a\u73b0\u5b9e\u4e16\u754c\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u53ef\u80fd\u4f1a\u5728\u7528\u6237\u6808\u6ea2\u51fa\u65f6\u81ea\u52a8\u4e3a\u5176\u5206\u914d\u66f4\u591a\u7684\u5185\u5b58\u3002</p>"},{"location":"os/Chapter-3/#37-code-sbrk","title":"3.7  Code: sbrk","text":"<p><code>sbrk</code> \u662f \u4e00 \u4e2a \u8fdb \u7a0b \u6536 \u7f29 \u6216 \u589e \u957f \u5185 \u5b58 \u7684 \u7cfb \u7edf \u8c03 \u7528 \u3002 \u8be5 \u7cfb \u7edf \u8c03 \u7528 \u7531 \u51fd \u6570<code>growproc</code>\uff08<code>kernel/proc.c:239</code>\uff09\u5b9e\u73b0\uff0c<code>growproc</code> \u8c03\u7528 <code>uvmalloc</code> \u6216 <code>uvmdealloc</code>\uff0c\u53d6\u51b3\u4e8e <code>n</code> \u662f\u6b63\u6570\u8fd8\u662f\u8d1f\u6570\u3002<code>uvmalloc</code>\uff08<code>kernel/vm.c:229</code>\uff09\u901a\u8fc7 <code>kalloc</code> \u5206\u914d\u7269\u7406\u5185\u5b58\uff0c\u5e76\u4f7f\u7528 <code>mappages</code> \u5c06 PTE \u6dfb\u52a0\u5230\u7528\u6237\u9875\u8868\u4e2d\u3002 <code>uvmdealloc</code> \u8c03\u7528 <code>uvmunmap</code>\uff08<code>kernel/vm.c:174</code>\uff09\uff0c\u5b83\u4f7f\u7528 <code>walk</code> \u6765\u67e5\u627e PTE \u5e76\u4f7f\u7528 <code>kfree</code> \u6765\u91ca\u653e\u5b83\u4eec\u6240\u5f15\u7528\u7684\u7269\u7406\u5185\u5b58\u3002</p> <p>xv6 \u4f7f\u7528\u8fdb\u7a0b\u7684\u9875\u8868\u4e0d\u4ec5\u662f\u4e3a\u4e86\u544a\u8bc9\u786c\u4ef6\u5982\u4f55\u6620\u5c04\u7528\u6237\u865a\u62df\u5730\u5740\uff0c\u4e5f\u662f\u5c06\u5176\u4f5c\u4e3a\u5206\u914d\u7ed9\u8be5\u8fdb\u7a0b\u7684\u7269\u7406\u5730\u5740\u7684\u552f\u4e00\u8bb0\u5f55\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u91ca\u653e\u7528\u6237\u5185\u5b58\uff08<code>uvmunmap</code> \u4e2d\uff09\u9700\u8981\u68c0\u67e5\u7528\u6237\u9875\u8868\u7684\u539f\u56e0\u3002</p>"},{"location":"os/Chapter-3/#38-code-exec","title":"3.8  Code: exec","text":"<p><code>exec</code> \u662f\u521b\u5efa\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\u7684\u7528\u6237\u90e8\u5206\u7684\u7cfb\u7edf\u8c03\u7528\u3002\u5b83\u8bfb\u53d6\u50a8\u5b58\u5728\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684\u6587\u4ef6\u7528\u6765\u521d\u59cb\u5316\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\u7684\u7528\u6237\u90e8\u5206\u3002<code>exec</code>\uff08<code>kernel/exec.c:13</code>\uff09\u4f7f\u7528 <code>namei</code>\uff08<code>kernel/exec.c:26</code>\uff09\u6253\u5f00\u4e8c\u8fdb\u5236\u6587\u4ef6\u8def\u5f84\uff0c\u8fd9\u5728\u7b2c 8 \u7ae0\u4e2d\u6709\u89e3\u91ca\u3002\u7136\u540e\uff0c\u5b83\u8bfb\u53d6 ELF \u5934\u3002xv6 \u5e94\u7528\u7a0b\u5e8f\u7528 ELF \u683c\u5f0f\u6765\u63cf\u8ff0\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u5b83\u5b9a\u4e49\u5728\uff08<code>kernel/elf.h</code>\uff09\u3002\u4e00\u4e2a ELF \u4e8c\u8fdb\u5236\u6587\u4ef6\u5305\u62ec\u4e00\u4e2a ELF \u5934\uff0c<code>struct elfhdr</code>\uff08<code>kernel/elf.h:6</code>\uff09\u3002\u4e4b\u540e\u662f\u4e00\u4e32\u7a0b\u5e8f\u6bb5\u5934\uff08program section header\uff09\uff0c<code>struct proghdr</code>\uff08<code>kernel/elf.h:25</code>\uff09\u3002\u6bcf\u4e00\u4e2a<code>proghdr</code>\u63cf\u8ff0\u4e86\u5e94\u7528\u7684\u4e00\u4e2a\u5fc5\u987b\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u7a0b\u5e8f\u6bb5\uff1bxv6 \u7a0b\u5e8f\u53ea\u6709\u4e00\u4e2a\u7a0b\u5e8f\u6bb5\u5934\uff0c\u4f46\u5176\u4ed6\u7cfb\u7edf\u53ef\u80fd\u6709\u5206\u5f00\u7684\u6307\u4ee4\u6bb5\u548c\u6570\u636e\u6bb5\u9700\u8981\u52a0\u8f7d\u5230\u5185\u5b58\u3002</p> <p>\u7b2c\u4e00\u6b65\u662f\u5feb\u901f\u68c0\u67e5\u6587\u4ef6\u662f\u5426\u662fELF\u683c\u5f0f\u3002\u4e00\u4e2a ELF \u4e8c\u8fdb\u5236\u6587\u4ef6\u4ee5\u56db\u4e2a\u5b57\u8282\u7684\u201c\u9b54\u6cd5\u6570\u5b57\u201d <code>0x7F</code>\u3001<code>E</code>\u3001<code>L</code>\u3001<code>F</code>\u6216 <code>ELF_MAGIC</code>\uff08<code>kernel/elf.h:3</code>\uff09\u5f00\u59cb\u3002\u5982\u679c ELF \u5934\u6709\u6b63\u786e\u7684\u201d\u9b54\u6cd5\u6570\u5b57\u201c\uff0c<code>exec</code>\u5c31\u4f1a\u8ba4\u4e3a\u8be5\u4e8c\u8fdb\u5236\u6587\u4ef6\u662f\u6b63\u786e\u7684\u7c7b\u578b\u3002</p> <p><code>exec</code>\u4f7f\u7528<code>proc_pagetable</code>\uff08<code>kernel/exec.c:38</code>\uff09\u5206\u914d\u4e00\u4e2a\u6ca1\u6709\u4f7f\u7528\u7684\u9875\u8868\uff0c\u4f7f\u7528 <code>uvmalloc</code>\uff08<code>kernel/exec.c:52</code>\uff09\u4e3a\u6bcf\u4e00\u4e2a ELF \u6bb5\u5206\u914d\u5185\u5b58\uff0c\u4f7f\u7528 <code>loadseg</code>\uff08<code>kernel/exec.c:10</code>\uff09\u52a0\u8f7d\u6bcf\u4e00\u4e2a\u6bb5\u5230\u5185\u5b58\u4e2d\u3002<code>loadseg</code>\u4f7f\u7528<code>walkaddr</code>\u627e\u5230\u5206\u914d\u5185\u5b58\u7684\u7269\u7406\u5730\u5740\uff0c\u5728\u8be5\u5730\u5740\u5199\u5165 ELF \u6bb5\u7684\u6bcf\u4e00\u9875\uff0c\u9875\u7684\u5185\u5bb9\u901a\u8fc7 <code>readi</code> \u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u3002</p> <p>\u7528 <code>exec</code> \u521b\u5efa\u7684\u7b2c\u4e00\u4e2a\u7528\u6237\u7a0b\u5e8f<code>/init</code> \u7684\u7a0b\u5e8f\u6bb5\u5934\u662f\u8fd9\u6837\u7684\uff1a</p> Bash<pre><code># objdump -p _init\nuser/_init: file format elf64-littleriscv\nProgram Header:\n    LOAD off    0x00000000000000b0 vaddr 0x0000000000000000\n                                   paddr 0x0000000000000000 align 2**3\n         filesz 0x0000000000000840 memsz 0x0000000000000858 flags rwx\n   STACK off    0x0000000000000000 vaddr 0x0000000000000000\n                                   paddr 0x0000000000000000 align 2**4\n         filesz 0x0000000000000000 memsz 0x0000000000000000 flags rw-\n</code></pre> <p>\u7a0b\u5e8f\u6bb5\u5934\u7684 <code>filesz</code> \u53ef\u80fd\u5c0f\u4e8e <code>memsz</code>\uff0c\u8bf4\u660e\u5b83\u4eec\u4e4b\u95f4\u7684\u7a7a\u9699\u5e94\u8be5\u7528 0\u6765\u586b\u5145\uff08\u5bf9\u4e8e C \u8bed\u8a00\u4e2d\u7684\u5168\u5c40\u53d8\u91cf\uff09\uff0c\u800c\u4e0d\u662f\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u3002\u5bf9\u4e8e<code>/init</code>\u6765\u8bf4\uff0c<code>filesz</code>\u662f 2112 \u5b57\u8282\uff0c<code>memsz</code>\u662f 2136\u5b57\u8282\uff0c\u56e0\u6b64 <code>uvmalloc</code> \u5206\u914d\u4e86\u8db3\u591f\u7684\u7269\u7406\u5185\u5b58\u6765\u5bb9\u7eb3 2136 \u5b57\u8282\uff0c\u4f46\u53ea\u4ece\u6587\u4ef6<code>/init</code> \u4e2d\u8bfb\u53d6 2112\u5b57\u8282\u3002</p> <p><code>exec</code> \u5728\u6808\u9875\u7684\u4e0b\u65b9\u653e\u7f6e\u4e86\u4e00\u4e2a\u4e0d\u53ef\u8bbf\u95ee\u9875\uff0c\u8fd9\u6837\u7a0b\u5e8f\u5982\u679c\u8bd5\u56fe\u4f7f\u7528\u591a\u4e2a\u9875\u9762\uff0c\u5c31\u4f1a\u51fa\u73b0\u6545\u969c\u3002\u8fd9\u4e2a\u4e0d\u53ef\u8bbf\u95ee\u7684\u9875\u8fd8\u80fd\u5141\u8bb8<code>exec</code> \u5904\u7406\u8fc7\u5927\u7684\u53c2\u6570\uff1b\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c<code>exec</code>\u7528\u6765\u590d\u5236\u53c2\u6570\u5230\u6808\u7684 <code>copyout</code>\uff08<code>kernel/vm.c:355</code>\uff09\u51fd\u6570\u4f1a\u6ce8\u610f\u5230\u76ee\u6807\u9875\u4e0d\u53ef\u8bbf\u95ee\uff0c\u5e76\u8fd4\u56de-1\u3002</p> <p>\u5728\u51c6\u5907\u65b0\u7684\u5185\u5b58\u6620\u50cf\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c <code>exec</code> \u68c0\u6d4b\u5230\u4e00\u4e2a\u9519\u8bef\uff0c\u6bd4\u5982\u4e00\u4e2a\u65e0\u6548\u7684\u7a0b\u5e8f\u6bb5\uff0c \u5b83\u5c31\u4f1a\u8df3\u8f6c\u5230\u6807\u7b7e <code>bad</code>\uff0c\u91ca\u653e\u65b0\u7684\u6620\u50cf\uff0c\u5e76\u8fd4\u56de-1\u3002<code>exec</code> \u5fc5\u987b\u5ef6\u8fdf\u91ca\u653e\u65e7\u6620\u50cf\uff0c\u76f4\u5230\u5b83\u786e\u5b9a<code>exec</code>\u7cfb\u7edf\u8c03\u7528\u4f1a\u6210\u529f\uff1a\u5982\u679c\u65e7\u6620\u50cf\u6d88\u5931\u4e86\uff0c\u7cfb\u7edf\u8c03\u7528\u5c31\u4e0d\u80fd\u8fd4\u56de-1\u3002<code>exec</code>\u4e2d\u552f\u4e00\u7684\u9519\u8bef\u60c5\u51b5\u53d1\u751f\u5728\u521b\u5efa\u6620\u50cf\u7684\u8fc7\u7a0b\u4e2d\u3002\u4e00\u65e6\u955c\u50cf\u5b8c\u6210\uff0c<code>exec</code>\u5c31\u53ef\u4ee5\u63d0\u4ea4\u5230\u65b0\u7684\u9875\u8868\uff08<code>kernel/exec.c:113</code>\uff09\u5e76\u91ca\u653e\u65e7\u7684\u9875\u8868\uff08<code>kernel/exec.c:117</code>\uff09\u3002</p> <p><code>exec</code> \u5c06 ELF \u6587\u4ef6\u4e2d\u7684\u5b57\u8282\u6309 ELF \u6587\u4ef6\u6307\u5b9a\u7684\u5730\u5740\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u3002\u7528\u6237\u6216\u8fdb\u7a0b\u53ef\u4ee5\u5c06\u4efb\u4f55\u4ed6\u4eec\u60f3\u8981\u7684\u5730\u5740\u653e\u5165 ELF \u6587\u4ef6\u4e2d\u3002\u56e0\u6b64\uff0c<code>exec</code>\u662f\u6709\u98ce\u9669\u7684\uff0c\u56e0\u4e3a ELF \u6587\u4ef6\u4e2d\u7684\u5730\u5740\u53ef\u80fd\u4f1a\u610f\u5916\u5730\u6216\u6545\u610f\u5730\u6307\u5411\u5185\u6838\u3002\u5bf9\u4e8e\u4e00\u4e2a\u4e0d\u5c0f\u5fc3\u7684\u5185\u6838\u6765\u8bf4\uff0c\u540e\u679c\u53ef\u80fd\u4ece\u5d29\u6e83\u5230\u6076\u610f\u98a0\u8986\u5185\u6838\u7684\u9694\u79bb\u673a\u5236(\u5373\u5b89\u5168\u6f0f\u6d1e)\u3002xv6 \u6267\u884c\u4e86\u4e00\u4e9b\u68c0\u67e5\u6765\u907f\u514d\u8fd9\u4e9b\u98ce\u9669\u3002\u4f8b\u5982 <code>if (ph.vaddr + ph.memsz &lt; ph.vaddr)</code>\u68c0\u67e5\u603b\u548c\u662f\u5426\u6ea2\u51fa\u4e00\u4e2a 64 \u4f4d\u6574\u6570\u3002\u5371\u9669\u7684\u662f\uff0c\u7528\u6237\u53ef\u4ee5\u7528\u6307\u5411\u7528\u6237\u9009\u62e9\u7684\u5730\u5740\u7684 <code>ph.vaddr</code> \u548c\u8db3\u591f\u5927\u7684 <code>ph.memsz</code> \u6765\u6784\u9020\u4e00\u4e2a ELF \u4e8c\u8fdb\u5236\uff0c\u4f7f\u603b\u548c\u6ea2\u51fa\u5230 0x1000\uff0c\u8fd9\u770b\u8d77\u6765\u50cf\u662f\u4e00\u4e2a\u6709\u6548\u503c\u3002\u5728\u65e7\u7248\u672c\u7684 xv6 \u4e2d\uff0c\u7528\u6237\u5730\u5740\u7a7a\u95f4\u4e5f\u5305\u542b\u5185\u6838\uff08\u4f46\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u4e0d\u53ef\u8bfb/\u5199\uff09\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9\u4e00\u4e2a\u5bf9\u5e94\u5185\u6838\u5185\u5b58\u7684\u5730\u5740\uff0c\u4ece\u800c\u5c06 ELF \u4e8c\u8fdb\u5236\u4e2d\u7684\u6570\u636e\u590d\u5236\u5230\u5185\u6838\u4e2d\u3002\u5728 RISC-V \u7248\u672c\u7684 xv6 \u4e2d\uff0c\u8fd9\u662f\u4e0d\u53ef\u80fd\u7684\uff0c\u56e0\u4e3a\u5185\u6838\u6709\u81ea\u5df1\u72ec\u7acb\u7684\u9875\u8868\uff1b<code>loadseg</code>\u52a0\u8f7d\u6570\u636e\u5230\u8fdb\u7a0b\u7684\u9875\u8868\u4e2d\uff0c\u800c\u4e0d\u662f\u5185\u6838\u7684\u9875\u8868\u4e2d\u3002</p> <p>\u5185\u6838\u5f00\u53d1\u4eba\u5458\u5f88\u5bb9\u6613\u5ffd\u7565\u4e00\u4e2a\u5173\u952e\u7684\u68c0\u67e5\uff0c\u73b0\u5b9e\u4e2d\u7684\u5185\u6838\u6709\u5f88\u957f\u4e00\u6bb5\u7f3a\u5c11\u68c0\u67e5\u7684\u7a7a\u6863\u671f\uff0c \u7528\u6237\u7a0b\u5e8f\u53ef\u4ee5\u5229\u7528\u7f3a\u5c11\u8fd9\u4e9b\u68c0\u67e5\u6765\u83b7\u5f97\u5185\u6838\u7279\u6743\u3002xv6 \u5728\u9a8c\u8bc1\u9700\u8981\u63d0\u4f9b\u7ed9\u5185\u6838\u7684\u7528\u6237\u7a0b\u5e8f\u6570\u636e\u7684\u65f6\u5019\uff0c\u5e76\u6ca1\u6709\u5b8c\u5168\u9a8c\u8bc1\u5176\u662f\u5426\u662f\u6076\u610f\u7684\uff0c\u6076\u610f\u7528\u6237\u7a0b\u5e8f\u53ef\u80fd\u5229\u7528\u8fd9\u4e9b\u6570\u636e\u6765\u7ed5\u8fc7 xv6 \u7684\u9694\u79bb\u3002</p>"},{"location":"os/Chapter-3/#39-real-world","title":"3.9  Real world","text":"<p>\u50cf\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u4e00\u6837\uff0cxv6 \u4f7f\u7528\u5206\u9875\u786c\u4ef6\u8fdb\u884c\u5185\u5b58\u4fdd\u62a4\u548c\u6620\u5c04\u3002\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u5206\u9875\u7684\u4f7f\u7528\u8981\u6bd4 xv6 \u590d\u6742\u5f97\u591a\uff0c\u5b83\u5c06\u5206\u9875\u548c\u7f3a\u9875\u5f02\u5e38\u7ed3\u5408\u8d77\u6765\uff0c\u6211\u4eec\u5c06\u5728\u7b2c 4 \u7ae0\u4e2d\u8ba8\u8bba\u3002</p> <p>Xv6 \u7684\u5185\u6838\u4f7f\u7528\u865a\u62df\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u4e4b\u95f4\u7684\u76f4\u63a5\u6620\u5c04\uff0c\u8fd9\u6837\u4f1a\u66f4\u7b80\u5355\uff0c\u5e76\u5047\u8bbe\u5728\u5730\u57400x8000000 \u5904\u6709\u7269\u7406 RAM\uff0c\u5373\u5185\u6838\u671f\u671b\u52a0\u8f7d\u7684\u5730\u65b9\u3002\u8fd9\u5728 QEMU \u4e2d\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u5728\u771f\u5b9e\u7684\u786c\u4ef6\u4e0a\uff0c\u5b83\u88ab\u8bc1\u660e\u662f\u4e00\u4e2a\u7cdf\u7cd5\u7684\u60f3\u6cd5\uff1b\u771f\u5b9e\u7684\u786c\u4ef6\u5c06 RAM \u548c\u8bbe\u5907\u653e\u7f6e\u5728\u4e0d\u53ef\u9884\u6d4b\u7684\u7269\u7406\u5730\u5740\u4e0a\uff0c\u4f8b\u5982\u5728 0x8000000 \u5904\u53ef\u80fd\u6ca1\u6709 RAM\uff0c\u800c xv6 \u671f\u671b\u80fd\u591f\u5728\u90a3\u91cc\u5b58\u50a8\u5185\u6838\u3002\u66f4\u597d\u7684\u5185\u6838\u8bbe\u8ba1\u5229\u7528\u9875\u8868\u5c06\u4efb\u610f\u7684\u786c\u4ef6\u7269\u7406\u5185\u5b58\u5e03\u5c40\u53d8\u6210\u53ef\u9884\u6d4b\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u5e03\u5c40\u3002</p> <p>RISC-V \u652f\u6301\u7269\u7406\u5730\u5740\u7ea7\u522b\u7684\u4fdd\u62a4\uff0c\u4f46 xv6 \u6ca1\u6709\u4f7f\u7528\u8be5\u529f\u80fd\u3002</p> <p>\u5728\u6709\u5927\u91cf\u5185\u5b58\u7684\u673a\u5668\u4e0a\uff0c\u4f7f\u7528 RISC-V \u5bf9\u8d85\u7ea7\u9875(4MB \u7684\u9875)\u7684\u652f\u6301\u53ef\u80fd\u662f\u6709\u610f\u4e49\u7684\u3002\u5f53\u7269\u7406\u5185\u5b58\u5f88\u5c0f\u7684\u65f6\u5019\uff0c\u5c0f\u9875\u662f\u6709\u610f\u4e49\u7684\uff0c\u53ef\u4ee5\u5bf9\u78c1\u76d8\u8fdb\u884c\u7cbe\u7ec6\u5730\u5206\u914d\u548c\u5206\u9875\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a\u7a0b\u5e8f\u53ea\u4f7f\u7528 8 \u5343\u5b57\u8282\u7684\u5185\u5b58\uff0c\u90a3\u4e48\u7ed9\u5b83\u6574\u6574 4 \u5146\u5b57\u8282\u7684\u8d85\u7ea7\u7269\u7406\u5185\u5b58\u9875\u662f\u6d6a\u8d39\u7684\u3002\u66f4\u5927\u7684\u9875\u5728\u6709\u5927\u91cf\u5185\u5b58\u7684\u673a\u5668\u4e0a\u662f\u6709\u610f\u4e49\u7684\uff0c\u53ef\u4ee5\u51cf\u5c11\u9875\u8868\u64cd\u4f5c\u7684\u5f00\u9500\u3002</p> <p>xv6 \u5185\u6838\u7f3a\u4e4f\u4e00\u4e2a\u7c7b malloc \u7684\u5206\u914d\u5668\u4e3a\u5c0f\u7a0b\u5e8f\u63d0\u4f9b\u5185\u5b58\uff0c\u8fd9\u4f7f\u5f97\u5185\u6838\u6ca1\u6709\u4f7f\u7528\u9700\u8981\u52a8\u6001\u5206\u914d\u7684\u590d\u6742\u6570\u636e\u7ed3\u6784\uff0c\u4ece\u800c\u7b80\u5316\u4e86\u8bbe\u8ba1\u3002</p> <p>\u5185\u5b58\u5206\u914d\u662f\u4e00\u4e2a\u5e38\u5e74\u7684\u70ed\u95e8\u8bdd\u9898\uff0c\u57fa\u672c\u95ee\u9898\u662f\u6709\u6548\u5229\u7528\u6709\u9650\u7684\u5185\u5b58\u548c\u4e3a\u672a\u6765\u672a\u77e5\u7684\u8bf7\u6c42\u505a\u51c6\u5907[2]\u3002\u5982\u4eca\u4eba\u4eec\u66f4\u5173\u5fc3\u7684\u662f\u901f\u5ea6\u800c\u4e0d\u662f\u7a7a\u95f4\u6548\u7387\u3002\u6b64\u5916\uff0c\u4e00\u4e2a\u66f4\u590d\u6742\u7684\u5185\u6838\u53ef\u80fd\u4f1a\u5206\u914d\u8bb8\u591a\u4e0d\u540c\u5927\u5c0f\u7684\u5c0f\u5757\uff0c\u800c\u4e0d\u662f\uff08\u5728 xv6 \u4e2d\uff09\u53ea\u5206\u914d 4096 \u5b57\u8282\u7684\u5757\uff1b\u4e00\u4e2a\u771f\u6b63\u7684\u5185\u6838\u5206\u914d\u5668\u9700\u8981\u5904\u7406\u5c0f\u5757\u5206\u914d\u4ee5\u53ca\u5927\u5757\u5206\u914d\u3002</p>"},{"location":"os/Chapter-3/#310-exercises","title":"3.10  Exercises","text":"<p>1\u3001\u5206\u6790 RISC-V \u7684\u8bbe\u5907\u6811\uff08device tree\uff09\uff0c\u627e\u51fa\u8ba1\u7b97\u673a\u6709\u591a\u5c11\u7269\u7406\u5185\u5b58\u3002</p> <p>2\u3001\u7f16\u5199\u4e00\u4e2a\u7528\u6237\u7a0b\u5e8f\uff0c\u901a\u8fc7\u8c03\u7528<code>sbrk(1)</code>\u4f7f\u5176\u5730\u5740\u7a7a\u95f4\u589e\u52a0\u4e00\u4e2a\u5b57\u8282\u3002\u8fd0\u884c\u8be5\u7a0b\u5e8f\uff0c\u7814\u7a76\u8c03\u7528 <code>sbrk</code> \u4e4b\u524d\u548c\u8c03\u7528<code>sbrk</code> \u4e4b\u540e\u7684\u7a0b\u5e8f\u9875\u8868\u3002\u5185\u6838\u5206\u914d\u4e86\u591a\u5c11\u7a7a\u95f4\uff1f\u65b0\u5185\u5b58\u7684 PTE \u5305\u542b\u54ea\u4e9b\u5185\u5bb9\uff1f</p> <p>3\u3001\u4fee\u6539 xv6 \u4f7f\u5f97\u5185\u6838\u4f7f\u7528\u8d85\u7ea7\u9875 4M\u3002</p> <p>4\u3001\u4fee\u6539 xv6\uff0c\u4f7f\u7528\u6237\u7a0b\u5e8f\u95f4\u63a5\u5f15\u7528\u4e00\u4e2a\u7a7a\u6307\u9488\u65f6\uff0c\u4f1a\u6536\u5230\u4e00\u4e2a\u5f02\u5e38\uff0c\u5373\u4fee\u6539 xv6\uff0c\u4f7f\u7528\u6237\u7a0b\u5e8f\u7684\u865a\u62df\u5730\u5740 0 \u4e0d\u88ab\u6620\u5c04\u3002</p> <p>5\u3001Unix \u5b9e\u73b0\u7684 exec \u4f20\u7edf\u4e0a\u5305\u62ec\u5bf9 shell \u811a\u672c\u7684\u7279\u6b8a\u5904\u7406\u3002\u5982\u679c\u8981\u6267\u884c\u7684\u6587\u4ef6\u4ee5\u6587\u672c<code>#!</code>\u5f00\u5934\uff0c \u90a3\u4e48\u7b2c\u4e00\u884c\u5c31\u88ab\u8ba4\u4e3a\u662f\u8981\u8fd0\u884c\u7684\u7a0b\u5e8f\u6765\u89e3\u91ca\u6587\u4ef6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8c03\u7528 <code>exec</code> \u8fd0\u884c <code>myprog arg1</code>\uff0c \u800c <code>myprog</code> \u7684\u7b2c\u4e00\u884c\u662f<code>#!/interp</code>\uff0c\u90a3\u4e48<code>exec</code> \u6267\u884c<code>/interp myprog arg1</code>\u3002\u5728 xv6 \u4e2d\u5b9e\u73b0\u5bf9\u8fd9\u4e2a\u7ea6\u5b9a\u7684\u652f\u6301\u3002</p> <p>6\u3001\u4e3a\u5185\u6838\u5b9e\u73b0\u5730\u5740\u7a7a\u95f4\u7684\u968f\u673a\u5316\u3002</p> <ol> <li>\u5373\u5728\u6808\u4e2d\u4fdd\u5b58\u4e86\u4ecemain\u8fd4\u56de\u6240\u9700\u8981\u7684\u4fe1\u606f</li> <li>dereference\uff0c\u5c31\u662f\u5bf9\u5730\u5740\u53d6\u503c\uff0c\u4f8b\u5982*p\u3002</li> </ol>"},{"location":"os/Chapter-4/","title":"Chapter 4","text":""},{"location":"os/Chapter-4/#_1","title":"\u7b2c\u56db\u7ae0\uff1a\u9677\u9631\u548c\u7cfb\u7edf\u8c03\u7528","text":"<p>\u6709\u4e09\u79cd\u4e8b\u4ef6\u4f1a\u5bfc\u81f4CPU\u6401\u7f6e\u666e\u901a\u6307\u4ee4\u7684\u6267\u884c\uff0c\u5f3a\u5236\u5c06\u63a7\u5236\u6743\u8f6c\u79fb\u7ed9\u5904\u7406\u8be5\u4e8b\u4ef6\u7684\u7279\u6b8a\u4ee3\u7801\u3002\u4e00\u79cd\u60c5\u51b5\u662f***\u7cfb\u7edf\u8c03\u7528***\uff0c\u5f53\u7528\u6237\u7a0b\u5e8f\u6267\u884c**ecall**\u6307\u4ee4\u8981\u6c42\u5185\u6838\u4e3a\u5176\u505a\u67d0\u4e8b\u65f6\u3002\u53e6\u4e00\u79cd\u60c5\u51b5\u662f***\u5f02\u5e38***\uff1a\u4e00\u6761\u6307\u4ee4\uff08\u7528\u6237\u6216\u5185\u6838\uff09\u505a\u4e86\u4e00\u4e9b\u975e\u6cd5\u7684\u4e8b\u60c5\uff0c\u5982\u9664\u4ee5\u96f6\u6216\u4f7f\u7528\u65e0\u6548\u7684\u865a\u62df\u5730\u5740\u3002\u7b2c\u4e09\u79cd\u60c5\u51b5\u662f\u8bbe\u5907***\u4e2d\u65ad***\uff0c\u5f53\u4e00\u4e2a\u8bbe\u5907\u53d1\u51fa\u9700\u8981\u6ce8\u610f\u7684\u4fe1\u53f7\u65f6\uff0c\u4f8b\u5982\u5f53\u78c1\u76d8\u786c\u4ef6\u5b8c\u6210\u4e00\u4e2a\u8bfb\u5199\u8bf7\u6c42\u65f6\u3002</p> <p>\u672c\u4e66\u4f7f\u7528***trap***\u4f5c\u4e3a\u8fd9\u4e9b\u60c5\u51b5\u7684\u901a\u7528\u672f\u8bed\u3002\u901a\u5e38\uff0c\u4ee3\u7801\u5728\u6267\u884c\u65f6\u53d1\u751ftrap\uff0c\u4e4b\u540e\u90fd\u4f1a\u88ab\u6062\u590d\uff0c\u800c\u4e14\u4e0d\u9700\u8981\u610f\u8bc6\u5230\u53d1\u751f\u4e86\u4ec0\u4e48\u7279\u6b8a\u7684\u4e8b\u60c5\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u901a\u5e38\u5e0c\u671btrap\u662f\u900f\u660e\u7684\uff1b\u8fd9\u4e00\u70b9\u5bf9\u4e8e\u4e2d\u65ad\u6765\u8bf4\u5c24\u5176\u91cd\u8981\uff0c\u88ab\u4e2d\u65ad\u7684\u4ee3\u7801\u901a\u5e38\u4e0d\u4f1a\u610f\u8bc6\u5230\u4f1a\u53d1\u751ftrap\u3002\u901a\u5e38\u7684\u987a\u5e8f\u662f\uff1atrap\u8feb\u4f7f\u63a7\u5236\u6743\u8f6c\u79fb\u5230\u5185\u6838\uff1b\u5185\u6838\u4fdd\u5b58\u5bc4\u5b58\u5668\u548c\u5176\u4ed6\u72b6\u6001\uff0c\u4ee5\u4fbf\u6062\u590d\u6267\u884c\uff1b\u5185\u6838\u6267\u884c\u9002\u5f53\u7684\u5904\u7406\u7a0b\u5e8f\u4ee3\u7801\uff08\u4f8b\u5982\uff0c\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u6216\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\uff09\uff1b\u5185\u6838\u6062\u590d\u4fdd\u5b58\u7684\u72b6\u6001\uff0c\u5e76\u4ecetrap\u4e2d\u8fd4\u56de\uff1b\u4ee3\u7801\u4ece\u539f\u6765\u7684\u5730\u65b9\u6062\u590d\u6267\u884c\u3002</p> <p>xv6\u5185\u6838\u4f1a\u5904\u7406\u6240\u6709\u7684trap\u3002\u8fd9\u5bf9\u4e8e\u7cfb\u7edf\u8c03\u7528\u6765\u8bf4\u662f\u5f88\u81ea\u7136\u7684\u3002\u8fd9\u5bf9\u4e2d\u65ad\u6765\u8bf4\u4e5f\u662f\u5408\u7406\u7684\uff0c\u56e0\u4e3a\u9694\u79bb\u8981\u6c42\u7528\u6237\u8fdb\u7a0b\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528\u8bbe\u5907\uff0c\u800c\u4e14\u53ea\u6709\u5185\u6838\u624d\u6709\u8bbe\u5907\u5904\u7406\u6240\u9700\u7684\u72b6\u6001\u3002\u8fd9\u5bf9\u5f02\u5e38\u5904\u7406\u6765\u8bf4\u4e5f\u662f\u5408\u7406\u7684\uff0c\u56e0\u4e3axv6\u54cd\u5e94\u6240\u6709\u6765\u81ea\u7528\u6237\u7a7a\u95f4\u7684\u5f02\u5e38\uff0c\u5e76\u6740\u6b7b\u8be5\u8fdd\u89c4\u7a0b\u5e8f\u3002</p> <p>Xv6 trap \u5904\u7406\u5206\u4e3a\u56db\u4e2a\u9636\u6bb5\uff1aRISC-V CPU\u91c7\u53d6\u7684\u786c\u4ef6\u884c\u4e3a\uff0c\u4e3a\u5185\u6838C\u4ee3\u7801\u51c6\u5907\u7684\u6c47\u7f16\u5165\u53e3\uff0c\u5904\u7406trap\u7684C \u5904\u7406\u7a0b\u5e8f\uff0c\u4ee5\u53ca\u7cfb\u7edf\u8c03\u7528\u6216\u8bbe\u5907\u9a71\u52a8\u670d\u52a1\u3002\u867d\u7136\u4e09\u79cdtrap\u7c7b\u578b\u4e4b\u95f4\u7684\u5171\u6027\u8868\u660e\uff0c\u5185\u6838\u53ef\u4ee5\u7528\u5355\u4e00\u7684\u4ee3\u7801\u5165\u53e3\u5904\u7406\u6240\u6709\u7684trap\uff0c\u4f46\u4e8b\u5b9e\u8bc1\u660e\uff0c\u4e3a\u4e09\u79cd\u4e0d\u540c\u7684\u60c5\u51b5\uff0c\u5373\u6765\u81ea\u7528\u6237\u7a7a\u95f4\u7684trap\u3001\u6765\u81ea\u5185\u6838\u7a7a\u95f4\u7684trap\u548c\u5b9a\u65f6\u5668\u4e2d\u65ad\uff0c\u8bbe\u7f6e\u5355\u72ec\u7684\u6c47\u7f16\u5165\u53e3\u548cC trap\u5904\u7406\u7a0b\u5e8f\u4f1a\u66f4\u65b9\u4fbf\u7684\u3002</p>"},{"location":"os/Chapter-4/#41-risc-v-trap-machinery","title":"4.1 RISC-V trap machinery","text":"<p>\u6bcf\u4e2aRISC-V CPU\u90fd\u6709\u4e00\u7ec4\u63a7\u5236\u5bc4\u5b58\u5668\uff0c\u5185\u6838\u5199\u5165\u8fd9\u4e9b\u5bc4\u5b58\u5668\u6765\u544a\u8bc9CPU\u5982\u4f55\u5904\u7406trap\uff0c\u5185\u6838\u53ef\u4ee5\u901a\u8fc7\u8bfb\u53d6\u8fd9\u4e9b\u5bc4\u5b58\u5668\u6765\u53d1\u73b0\u5df2\u7ecf\u53d1\u751f\u7684trap\u3002RISC-V\u6587\u6863\u5305\u542b\u4e86\u5b8c\u6574\u7684\u53d9\u8ff0[1]\u3002riscv.h\uff08kernel/riscv.h:1\uff09\u5305\u542b\u4e86xv6\u4f7f\u7528\u7684\u5b9a\u4e49\u3002\u8fd9\u91cc\u662f\u6700\u91cd\u8981\u7684\u5bc4\u5b58\u5668\u7684\u6982\u8ff0\u3002</p> <ul> <li> <p><code>stvec</code>\uff1a\u5185\u6838\u5728\u8fd9\u91cc\u5199\u4e0btrap\u5904\u7406\u7a0b\u5e8f\u7684\u5730\u5740\uff1bRISC-V\u8df3\u8f6c\u5230\u8fd9\u91cc\u6765\u5904\u7406trap\u3002</p> </li> <li> <p><code>sepc</code>\uff1a\u5f53trap\u53d1\u751f\u65f6\uff0cRISC-V\u4f1a\u5c06\u7a0b\u5e8f\u8ba1\u6570\u5668\u4fdd\u5b58\u5728\u8fd9\u91cc\uff08\u56e0\u4e3a<code>PC</code>\u4f1a\u88ab<code>stvec</code>\u8986\u76d6\uff09\u3002<code>sret</code>\uff08\u4ecetrap\u4e2d\u8fd4\u56de\uff09\u6307\u4ee4\u5c06<code>sepc</code>\u590d\u5236\u5230<code>pc</code>\u4e2d\u3002\u5185\u6838\u53ef\u4ee5\u5199<code>sepc</code>\u6765\u63a7\u5236<code>sret</code>\u7684\u8fd4\u56de\u5230\u54ea\u91cc\u3002</p> </li> <li> <p><code>scause</code>\uff1aRISC -V\u5728\u8fd9\u91cc\u653e\u4e86\u4e00\u4e2a\u6570\u5b57\uff0c\u63cf\u8ff0\u4e86trap\u7684\u539f\u56e0\u3002</p> </li> <li> <p><code>sscratch</code>\uff1a\u5185\u6838\u5728\u8fd9\u91cc\u653e\u7f6e\u4e86\u4e00\u4e2a\u503c\uff0c\u5728trap\u5904\u7406\u7a0b\u5e8f\u5f00\u59cb\u65f6\u53ef\u4ee5\u65b9\u4fbf\u5730\u4f7f\u7528\u3002</p> </li> <li> <p><code>sstatus</code>\uff1a<code>sstatus</code>\u4e2d\u7684**SIE**\u4f4d\u63a7\u5236\u8bbe\u5907\u4e2d\u65ad\u662f\u5426\u88ab\u542f\u7528\uff0c\u5982\u679c\u5185\u6838\u6e05\u9664**SIE**\uff0cRISC-V\u5c06\u63a8\u8fdf\u8bbe\u5907\u4e2d\u65ad\uff0c\u76f4\u5230\u5185\u6838\u8bbe\u7f6e**SIE**\u3002**SPP**\u4f4d\u8868\u793atrap\u662f\u6765\u81ea\u7528\u6237\u6a21\u5f0f\u8fd8\u662fsupervisor\u6a21\u5f0f\uff0c\u5e76\u63a7\u5236<code>sret</code>\u8fd4\u56de\u5230\u4ec0\u4e48\u6a21\u5f0f\u3002</p> </li> </ul> <p>\u4e0a\u8ff0\u5bc4\u5b58\u5668\u4e0e\u5728\u7279\u6743\u6001\u6a21\u5f0f\u4e0b\u5904\u7406\u7684trap\u6709\u5173\uff0c\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u4e0d\u80fd\u8bfb\u6216\u5199\u3002\u5bf9\u4e8e\u673a\u5668\u6a21\u5f0f\u4e0b\u5904\u7406\u7684trap\uff0c\u6709\u4e00\u7ec4\u7b49\u6548\u7684\u63a7\u5236\u5bc4\u5b58\u5668\uff1bxv6\u53ea\u5728\u5b9a\u65f6\u5668\u4e2d\u65ad\u7684\u7279\u6b8a\u60c5\u51b5\u4e0b\u4f7f\u7528\u5b83\u4eec\u3002</p> <p>\u591a\u6838\u82af\u7247\u4e0a\u7684\u6bcf\u4e2aCPU\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7ec4\u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u800c\u4e14\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u53ef\u80fd\u6709\u591a\u4e2aCPU\u5728\u5904\u7406\u4e00\u4e2atrap\u3002</p> <p>\u5f53\u9700\u8981\u6267\u884ctrap\u65f6\uff0cRISC-V\u786c\u4ef6\u5bf9\u6240\u6709\u7684trap\u7c7b\u578b\uff08\u9664\u5b9a\u65f6\u5668\u4e2d\u65ad\u5916\uff09\u8fdb\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u5982\u679c\u8be5trap\u662f\u8bbe\u5907\u4e2d\u65ad\uff0c\u4e14<code>sstatus</code> **SIE**\u4f4d\u4e3a0\uff0c\u5219\u4e0d\u6267\u884c\u4ee5\u4e0b\u4efb\u4f55\u64cd\u4f5c\u3002</li> <li>\u901a\u8fc7\u6e05\u9664SIE\u6765\u7981\u7528\u4e2d\u65ad\u3002</li> <li>\u590d\u5236<code>pc</code>\u5230<code>sepc</code>\u3002</li> <li>\u5c06\u5f53\u524d\u6a21\u5f0f\uff08\u7528\u6237\u6001\u6216\u7279\u6743\u6001\uff09\u4fdd\u5b58\u5728<code>sstatus</code>\u7684**SPP**\u4f4d\u3002</li> <li>\u5728<code>scause</code>\u8bbe\u7f6e\u8be5\u6b21trap\u7684\u539f\u56e0\u3002</li> <li>\u5c06\u6a21\u5f0f\u8f6c\u6362\u4e3a\u7279\u6743\u6001\u3002</li> <li>\u5c06<code>stvec</code>\u590d\u5236\u5230<code>pc</code>\u3002</li> <li>\u4ece\u65b0\u7684<code>pc</code>\u5f00\u59cb\u6267\u884c\u3002</li> </ol> <p>\u6ce8\u610f\uff0cCPU\u4e0d\u4f1a\u5207\u6362\u5230\u5185\u6838\u9875\u8868\uff0c\u4e0d\u4f1a\u5207\u6362\u5230\u5185\u6838\u4e2d\u7684\u6808\uff0c\u4e5f\u4e0d\u4f1a\u4fdd\u5b58pc\u4ee5\u5916\u7684\u4efb\u4f55\u5bc4\u5b58\u5668\u3002\u5185\u6838\u8f6f\u4ef6\u5fc5\u987b\u6267\u884c\u8fd9\u4e9b\u4efb\u52a1\u3002CPU\u5728trap\u671f\u95f4\u505a\u5f88\u5c11\u7684\u5de5\u4f5c\u7684\u4e00\u4e2a\u539f\u56e0\u662f\u4e3a\u4e86\u7ed9\u8f6f\u4ef6\u63d0\u4f9b\u7075\u6d3b\u6027\uff0c\u4f8b\u5982\uff0c\u4e00\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u4e0d\u9700\u8981\u9875\u8868\u5207\u6362\uff0c\u8fd9\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p> <p>\u4f60\u53ef\u80fd\u4f1a\u60f3CPU\u7684trap\u5904\u7406\u6d41\u7a0b\u662f\u5426\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7b80\u5316\u3002\u4f8b\u5982\uff0c\u5047\u8bbeCPU\u6ca1\u6709\u5207\u6362\u7a0b\u5e8f\u8ba1\u6570\u5668\uff08pc\uff09\u3002\u90a3\u4e48trap\u53ef\u4ee5\u5207\u6362\u5230\u76d1\u7763\u8005\u6a21\u5f0f\u65f6\uff0c\u8fd8\u5728\u8fd0\u884c\u7528\u6237\u6307\u4ee4\u3002\u8fd9\u4e9b\u7528\u6237\u6307\u4ee4\u53ef\u4ee5\u6253\u7834\u7528\u6237\u7a7a\u95f4/\u5185\u6838\u7a7a\u95f4\u7684\u9694\u79bb\uff0c\u4f8b\u5982\u901a\u8fc7\u4fee\u6539<code>satp</code>\u5bc4\u5b58\u5668\u6307\u5411\u4e00\u4e2a\u5141\u8bb8\u8bbf\u95ee\u6240\u6709\u7269\u7406\u5185\u5b58\u7684\u9875\u8868\u3002\u56e0\u6b64\uff0cCPU\u5fc5\u987b\u5207\u6362\u5230\u5185\u6838\u6307\u5b9a\u7684\u6307\u4ee4\u5730\u5740\uff0c\u5373<code>stvec</code>\u3002</p>"},{"location":"os/Chapter-4/#42-traps-from-user-space","title":"4.2 Traps from user space","text":"<p>\u5728\u7528\u6237\u7a7a\u95f4\u6267\u884c\u65f6\uff0c\u5982\u679c\u7528\u6237\u7a0b\u5e8f\u8fdb\u884c\u4e86\u7cfb\u7edf\u8c03\u7528\uff08<code>ecall</code>\u6307\u4ee4\uff09\uff0c\u6216\u8005\u505a\u4e86\u4e00\u4e9b\u975e\u6cd5\u7684\u4e8b\u60c5\uff0c\u6216\u8005\u8bbe\u5907\u4e2d\u65ad\uff0c\u90fd\u53ef\u80fd\u53d1\u751ftrap\u3002\u6765\u81ea\u7528\u6237\u7a7a\u95f4\u7684trap\u7684\u5904\u7406\u8def\u5f84\u662f<code>uservec</code>\uff08kernel/trampoline.S:16\uff09\uff0c\u7136\u540e\u662f<code>usertrap</code>\uff08kernel/trap.c:37\uff09\uff1b\u8fd4\u56de\u65f6\u662f<code>usertrapret</code>\uff08kernel/trap.c:90\uff09\uff0c\u7136\u540e\u662f<code>userret</code>\uff08kernel/trampoline.S:16\uff09\u3002</p> <p>\u6765\u81ea\u7528\u6237\u4ee3\u7801\u7684trap\u6bd4\u6765\u81ea\u5185\u6838\u7684trap\u66f4\u5177\u6311\u6218\u6027\uff0c\u56e0\u4e3a<code>satp</code>\u6307\u5411\u7684\u7528\u6237\u9875\u8868\u5e76\u4e0d\u6620\u5c04\u5185\u6838\uff0c\u800c\u4e14\u6808\u6307\u9488\u53ef\u80fd\u5305\u542b\u4e00\u4e2a\u65e0\u6548\u751a\u81f3\u6076\u610f\u7684\u503c\u3002</p> <p>\u56e0\u4e3aRISC-V\u786c\u4ef6\u5728trap\u8fc7\u7a0b\u4e2d\u4e0d\u5207\u6362\u9875\u8868\uff0c\u6240\u4ee5\u7528\u6237\u9875\u8868\u5fc5\u987b\u5305\u542b<code>uservec</code>\u7684\u6620\u5c04\uff0c\u5373<code>stvec</code>\u6307\u5411\u7684trap\u5904\u7406\u7a0b\u5e8f\u5730\u5740\u3002<code>uservec</code>\u5fc5\u987b\u5207\u6362<code>satp</code>\uff0c\u4f7f\u5176\u6307\u5411\u5185\u6838\u9875\u8868\uff1b\u4e3a\u4e86\u5728\u5207\u6362\u540e\u7ee7\u7eed\u6267\u884c\u6307\u4ee4\uff0c<code>uservec</code>\u5fc5\u987b\u88ab\u6620\u5c04\u5230\u5185\u6838\u9875\u8868\u4e0e\u7528\u6237\u9875\u8868\u76f8\u540c\u7684\u5730\u5740\u3002</p> <p>Xv6\u7528\u4e00\u4e2a\u5305\u542b<code>uservec</code>\u7684trampoline\u9875\u6765\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\u3002Xv6\u5728\u5185\u6838\u9875\u8868\u548c\u6bcf\u4e2a\u7528\u6237\u9875\u8868\u4e2d\u7684\u540c\u4e00\u4e2a\u865a\u62df\u5730\u5740\u4e0a\u6620\u5c04\u4e86trampoline\u9875\u3002\u8fd9\u4e2a\u865a\u62df\u5730\u5740\u5c31\u662f<code>TRAMPOLINE</code>\uff08\u5982\u6211\u4eec\u5728\u56fe2.3\u548c\u56fe3.3\u4e2d\u770b\u5230\u7684\uff09\u3002<code>trampoline.S</code>\u4e2d\u5305\u542btrampoline\u7684\u5185\u5bb9\uff0c\uff08\u6267\u884c\u7528\u6237\u4ee3\u7801\u65f6\uff09<code>stvec</code>\u8bbe\u7f6e\u4e3a<code>uservec</code>\uff08kernel/trampoline.S:16\uff09\u3002</p> <p>\u5f53<code>uservec</code>\u542f\u52a8\u65f6\uff0c\u6240\u670932\u4e2a\u5bc4\u5b58\u5668\u90fd\u5305\u542b\u88ab\u4e2d\u65ad\u7684\u4ee3\u7801\u6240\u62e5\u6709\u7684\u503c\u3002\u4f46\u662f<code>uservec</code>\u9700\u8981\u80fd\u591f\u4fee\u6539\u4e00\u4e9b\u5bc4\u5b58\u5668\uff0c\u4ee5\u4fbf\u8bbe\u7f6e<code>satp</code>\u548c\u751f\u6210\u4fdd\u5b58\u5bc4\u5b58\u5668\u7684\u5730\u5740\u3002RISC-V\u901a\u8fc7<code>sscratch</code>\u5bc4\u5b58\u5668\u63d0\u4f9b\u4e86\u5e2e\u52a9\u3002<code>uservec</code>\u5f00\u59cb\u65f6\u7684<code>csrrw</code>\u6307\u4ee4\u5c06<code>a0</code>\u548c<code>sscratch</code>\u7684\u5185\u5bb9\u4e92\u6362\u3002\u73b0\u5728\u7528\u6237\u4ee3\u7801\u7684<code>a0</code>\u88ab\u4fdd\u5b58\u4e86\uff1b<code>uservec</code>\u6709\u4e00\u4e2a\u5bc4\u5b58\u5668\uff08<code>a0</code>\uff09\u53ef\u4ee5\u4f7f\u7528\uff1b<code>a0</code>\u5305\u542b\u4e86\u5185\u6838\u4e4b\u524d\u653e\u5728<code>sscratch</code>\u4e2d\u7684\u503c\u3002</p> <p><code>uservec</code>\u7684\u4e0b\u4e00\u4e2a\u4efb\u52a1\u662f\u4fdd\u5b58\u7528\u6237\u5bc4\u5b58\u5668\u3002\u5728\u8fdb\u5165\u7528\u6237\u7a7a\u95f4\u4e4b\u524d\uff0c\u5185\u6838\u5148\u8bbe\u7f6e<code>sscratch</code>\u6307\u5411\u8be5\u8fdb\u7a0b\u7684<code>trapframe</code>\uff0c\u8fd9\u4e2a<code>trapframe</code>\u53ef\u4ee5\u4fdd\u5b58\u6240\u6709\u7528\u6237\u5bc4\u5b58\u5668\uff08kernel/proc.h:44\uff09\u3002\u56e0\u4e3a<code>satp</code>\u4ecd\u7136\u662f\u6307\u7528\u6237\u9875\u8868\uff0c\u6240\u4ee5<code>uservec</code>\u9700\u8981\u5c06<code>trapframe</code>\u6620\u5c04\u5230\u7528\u6237\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u5f53\u521b\u5efa\u6bcf\u4e2a\u8fdb\u7a0b\u65f6\uff0cxv6\u4e3a\u8fdb\u7a0b\u7684<code>trapframe</code>\u5206\u914d\u4e00\u9875\u5185\u5b58\uff0c\u5e76\u5c06\u5b83\u6620\u5c04\u5728\u7528\u6237\u865a\u62df\u5730\u5740<code>TRAPFRAME</code>\uff0c\u4e5f\u5c31\u662f<code>TRAMPOLINE</code>\u7684\u4e0b\u9762\u3002\u8fdb\u7a0b\u7684<code>p-&gt;trapframe</code>\u4e5f\u6307\u5411<code>trapframe</code>\uff0c\u4e0d\u8fc7\u662f\u6307\u5411\u5b83\u7684\u7269\u7406\u5730\u5740[1]\uff0c\u8fd9\u6837\u5185\u6838\u53ef\u4ee5\u901a\u8fc7\u5185\u6838\u9875\u8868\u6765\u4f7f\u7528\u5b83\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u4ea4\u6362<code>a0</code>\u548c<code>sscratch</code>\u540e\uff0c<code>a0</code>\u5c06\u6307\u5411\u5f53\u524d\u8fdb\u7a0b\u7684<code>trapframe</code>\u3002<code>uservec</code>\u5c06\u5728<code>trapframe</code>\u4fdd\u5b58\u5168\u90e8\u7684\u5bc4\u5b58\u5668\uff0c\u5305\u62ec\u4ece<code>sscratch</code>\u8bfb\u53d6\u7684<code>a0</code>\u3002</p> <p><code>trapframe</code>\u5305\u542b\u6307\u5411\u5f53\u524d\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u3001\u5f53\u524dCPU\u7684hartid\u3001<code>usertrap</code>\u7684\u5730\u5740\u548c\u5185\u6838\u9875\u8868\u7684\u5730\u5740\u7684\u6307\u9488\uff0c<code>uservec</code>\u5c06\u8fd9\u4e9b\u503c\u8bbe\u7f6e\u5230\u76f8\u5e94\u7684\u5bc4\u5b58\u5668\u4e2d\uff0c\u5e76\u5c06<code>satp</code>\u5207\u6362\u5230\u5185\u6838\u9875\u8868\u548c\u5237\u65b0TLB\uff0c\u7136\u540e\u8c03\u7528<code>usertrap</code>\u3002</p> <p><code>usertrap</code>\u7684\u4f5c\u7528\u662f\u786e\u5b9atrap\u7684\u539f\u56e0\uff0c\u5904\u7406\u5b83\uff0c\u7136\u540e\u8fd4\u56de\uff08kernel/ trap.c:37\uff09\u3002\u5982\u4e0a\u6240\u8ff0\uff0c\u5b83\u9996\u5148\u6539\u53d8<code>stvec</code>\uff0c\u8fd9\u6837\u5728\u5185\u6838\u4e2d\u53d1\u751f\u7684trap\u5c06\u7531<code>kernelvec</code>\u5904\u7406\u3002\u5b83\u4fdd\u5b58\u4e86<code>sepc</code>\uff08\u7528\u6237PC\uff09\uff0c\u8fd9\u4e5f\u662f\u56e0\u4e3a<code>usertrap</code>\u4e2d\u53ef\u80fd\u4f1a\u6709\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\uff0c\u5bfc\u81f4<code>sepc</code>\u88ab\u8986\u76d6\u3002\u5982\u679ctrap\u662f\u7cfb\u7edf\u8c03\u7528\uff0c<code>syscall</code>\u4f1a\u5904\u7406\u5b83\uff1b\u5982\u679c\u662f\u8bbe\u5907\u4e2d\u65ad\uff0c<code>devintr</code>\u4f1a\u5904\u7406\uff1b\u5426\u5219\u5c31\u662f\u5f02\u5e38\uff0c\u5185\u6838\u4f1a\u6740\u6b7b\u6545\u969c\u8fdb\u7a0b\u3002<code>usertrap</code>\u4f1a\u628a\u7528\u6237<code>pc</code>\u52a04\uff0c\u56e0\u4e3aRISC-V\u5728\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u4f1a\u7559\u4e0b\u6307\u5411<code>ecall</code>\u6307\u4ee4\u7684\u7a0b\u5e8f\u6307\u9488[2]\u3002\u5728\u9000\u51fa\u65f6\uff0c<code>usertrap</code>\u68c0\u67e5\u8fdb\u7a0b\u662f\u5426\u5df2\u7ecf\u88ab\u6740\u6b7b\u6216\u5e94\u8be5\u8ba9\u51faCPU\uff08\u5982\u679c\u8fd9\u4e2atrap\u662f\u4e00\u4e2a\u5b9a\u65f6\u5668\u4e2d\u65ad\uff09\u3002</p> <p>\u56de\u5230\u7528\u6237\u7a7a\u95f4\u7684\u7b2c\u4e00\u6b65\u662f\u8c03\u7528<code>usertrapret</code>\uff08kernel/trap.c:90\uff09\u3002\u8fd9\u4e2a\u51fd\u6570\u8bbe\u7f6eRISC-V\u63a7\u5236\u5bc4\u5b58\u5668\uff0c\u4e3a\u4ee5\u540e\u7528\u6237\u7a7a\u95f4trap\u505a\u51c6\u5907\u3002\u8fd9\u5305\u62ec\u6539\u53d8<code>stvec</code>\u6765\u5f15\u7528<code>uservec</code>\uff0c\u51c6\u5907<code>uservec</code>\u6240\u4f9d\u8d56\u7684<code>trapframe</code>\u5b57\u6bb5\uff0c\u5e76\u5c06<code>sepc</code>\u8bbe\u7f6e\u4e3a\u5148\u524d\u4fdd\u5b58\u7684\u7528\u6237\u7a0b\u5e8f\u8ba1\u6570\u5668\u3002\u6700\u540e\uff0c<code>usertrapret</code>\u5728\u7528\u6237\u9875\u8868\u548c\u5185\u6838\u9875\u8868\u4e2d\u6620\u5c04\u7684trampoline\u9875\u4e0a\u8c03\u7528<code>userret</code>\uff0c\u56e0\u4e3a<code>userret</code>\u4e2d\u7684\u6c47\u7f16\u4ee3\u7801\u4f1a\u5207\u6362\u9875\u8868\u3002</p> <p><code>usertrapret</code>\u5bf9<code>userret</code>\u7684\u8c03\u7528\u4f20\u9012\u4e86\u53c2\u6570<code>a0</code>\uff0c<code>a1</code>\uff0c <code>a0</code>\u6307\u5411<code>TRAPFRAME</code>\uff0c<code>a1</code>\u6307\u5411\u7528\u6237\u8fdb\u7a0b\u9875\u8868\uff08kernel/trampoline.S:88\uff09\uff0c<code>userret</code>\u5c06<code>satp</code>\u5207\u6362\u5230\u8fdb\u7a0b\u7684\u7528\u6237\u9875\u8868\u3002\u56de\u60f3\u4e00\u4e0b\uff0c\u7528\u6237\u9875\u8868\u540c\u65f6\u6620\u5c04\u4e86trampoline\u9875\u548c<code>TRAPFRAME</code>\uff0c\u4f46\u6ca1\u6709\u6620\u5c04\u5185\u6838\u7684\u5176\u4ed6\u5185\u5bb9\u3002\u540c\u6837\uff0c\u4e8b\u5b9e\u4e0a\uff0c\u5728\u7528\u6237\u9875\u8868\u548c\u5185\u6838\u9875\u8868\u4e2d\uff0ctrampoline\u9875\u88ab\u6620\u5c04\u5728\u76f8\u540c\u7684\u865a\u62df\u5730\u5740\u4e0a\uff0c\u8fd9\u4e5f\u662f\u5141\u8bb8<code>uservec</code>\u5728\u6539\u53d8<code>satp</code>\u540e\u7ee7\u7eed\u6267\u884c\u7684\u539f\u56e0\u3002<code>userret</code>\u5c06<code>trapframe</code>\u4e2d\u4fdd\u5b58\u7684\u7528\u6237<code>a0</code>\u590d\u5236\u5230<code>sscratch</code>\u4e2d\uff0c\u4e3a\u4ee5\u540e\u4e0e<code>TRAPFRAME</code>\u4ea4\u6362\u505a\u51c6\u5907\u3002\u4ece\u8fd9\u65f6\u5f00\u59cb\uff0c<code>userret</code>\u80fd\u4f7f\u7528\u7684\u6570\u636e\u53ea\u6709\u5bc4\u5b58\u5668\u5185\u5bb9\u548c<code>trapframe</code>\u7684\u5185\u5bb9\u3002\u63a5\u4e0b\u6765<code>userret</code>\u4ecetrapframe\u4e2d\u6062\u590d\u4fdd\u5b58\u7684\u7528\u6237\u5bc4\u5b58\u5668\uff0c\u5bf9<code>a0</code>\u548c<code>sscratch</code>\u505a\u6700\u540e\u7684\u4ea4\u6362\uff0c\u6062\u590d\u7528\u6237<code>a0</code>\u5e76\u4fdd\u5b58<code>TRAPFRAME</code>\uff0c\u4e3a\u4e0b\u4e00\u6b21trap\u505a\u51c6\u5907\uff0c\u5e76\u4f7f\u7528<code>sret</code>\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\u3002</p>"},{"location":"os/Chapter-4/#43-code-calling-system-calls","title":"4.3 Code: Calling system calls","text":"<p>\u7b2c2\u7ae0\u4ee5<code>initcode.S</code>\u8c03\u7528<code>exec</code>\u7cfb\u7edf\u8c03\u7528\u7ed3\u675f\uff08user/initcode.S:11\uff09\u3002\u8ba9\u6211\u4eec\u6765\u770b\u770b\u7528\u6237\u8c03\u7528\u662f\u5982\u4f55\u5728\u5185\u6838\u4e2d\u5b9e\u73b0<code>exec</code>\u7cfb\u7edf\u8c03\u7528\u7684\u3002</p> <p>\u7528\u6237\u4ee3\u7801\u5c06<code>exec</code>\u7684\u53c2\u6570\u653e\u5728\u5bc4\u5b58\u5668<code>a0</code>\u548c<code>a1</code>\u4e2d\uff0c\u5e76\u5c06\u7cfb\u7edf\u8c03\u7528\u53f7\u653e\u5728<code>a7</code>\u4e2d\u3002\u7cfb\u7edf\u8c03\u7528\u53f7\u4e0e\u51fd\u6570\u6307\u9488\u8868<code>syscalls</code>\u6570\u7ec4\uff08kernel/syscall.c:108\uff09\u4e2d\u7684\u9879\u5339\u914d\u3002<code>ecall</code>\u6307\u4ee4\u8fdb\u5165\u5185\u6838\uff0c\u6267\u884c<code>uservec</code>\u3001<code>usertrap</code>\uff0c\u7136\u540e\u6267\u884c<code>syscall</code>\uff0c\u5c31\u50cf\u6211\u4eec\u4e0a\u9762\u770b\u5230\u7684\u90a3\u6837\u3002</p> <p><code>syscall</code>\uff08kernel/syscall.c:133\uff09\u4ecetrapframe\u4e2d\u7684<code>a7</code>\u4e2d\u5f97\u5230\u7cfb\u7edf\u8c03\u7528\u53f7\uff0c\u5e76\u5176\u4f5c\u4e3a\u7d22\u5f15\u5728<code>syscalls</code>\u67e5\u627e\u76f8\u5e94\u51fd\u6570\u3002\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528<code>exec</code>\uff0c<code>a7</code>\u5c06\u4e3a<code>SYS_exec</code>\uff08kernel/syscall.h:8\uff09\uff0c\u8fd9\u4f1a\u8ba9<code>syscall</code>\u8c03\u7528<code>exec</code>\u7684\u5b9e\u73b0\u51fd\u6570<code>sys_exec</code>\u3002</p> <p>\u5f53\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u8fd4\u56de\u65f6\uff0c<code>syscall</code>\u5c06\u5176\u8fd4\u56de\u503c\u8bb0\u5f55\u5728<code>p-&gt;trapframe-&gt;a0</code>\u4e2d\u3002\u7528\u6237\u7a7a\u95f4\u7684<code>exec()</code>\u5c06\u4f1a\u8fd4\u56de\u8be5\u503c\uff0c\u56e0\u4e3aRISC-V\u4e0a\u7684C\u8c03\u7528\u901a\u5e38\u5c06\u8fd4\u56de\u503c\u653e\u5728<code>a0</code>\u4e2d\u3002\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\u8d1f\u6570\u8868\u793a\u9519\u8bef\uff0c0\u6216\u6b63\u6570\u8868\u793a\u6210\u529f\u3002\u5982\u679c\u7cfb\u7edf\u8c03\u7528\u53f7\u65e0\u6548\uff0c<code>syscall</code>\u4f1a\u6253\u5370\u9519\u8bef\u5e76\u8fd4\u56de-1\u3002</p>"},{"location":"os/Chapter-4/#44-code-system-call-arguments","title":"4.4 Code: System call arguments","text":"<p>\u5185\u6838\u7684\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u9700\u8981\u627e\u5230\u7528\u6237\u4ee3\u7801\u4f20\u9012\u7684\u53c2\u6570\u3002\u56e0\u4e3a\u7528\u6237\u4ee3\u7801\u8c03\u7528\u7cfb\u7edf\u8c03\u7528\u7684\u5305\u88c5\u51fd\u6570\uff0c\u53c2\u6570\u9996\u5148\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668\u4e2d\uff0c\u8fd9\u662fC\u8bed\u8a00\u5b58\u653e\u53c2\u6570\u7684\u60ef\u4f8b\u4f4d\u7f6e\u3002\u5185\u6838trap\u4ee3\u7801\u5c06\u7528\u6237\u5bc4\u5b58\u5668\u4fdd\u5b58\u5230\u5f53\u524d\u8fdb\u7a0b\u7684trap frame\u4e2d\uff0c\u5185\u6838\u4ee3\u7801\u53ef\u4ee5\u5728\u90a3\u91cc\u627e\u5230\u5b83\u4eec\u3002\u51fd\u6570<code>argint</code>\u3001<code>argaddr</code>\u548c<code>argfd</code>\u4ecetrap frame\u4e2d\u4ee5\u6574\u6570\u3001\u6307\u9488\u6216\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u5f62\u5f0f\u68c0\u7d22\u7b2cn\u4e2a\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u3002\u5b83\u4eec\u90fd\u8c03\u7528<code>argraw</code>\u6765\u83b7\u53d6\u4fdd\u5b58\u7684\u7528\u6237\u5bc4\u5b58\u5668\uff08kernel/syscall.c:35\uff09\u3002</p> <p>\u4e00\u4e9b\u7cfb\u7edf\u8c03\u7528\u4f20\u9012\u6307\u9488\u4f5c\u4e3a\u53c2\u6570\uff0c\u800c\u5185\u6838\u5fc5\u987b\u4f7f\u7528\u8fd9\u4e9b\u6307\u9488\u6765\u8bfb\u53d6\u6216\u5199\u5165\u7528\u6237\u5185\u5b58\u3002\u4f8b\u5982\uff0c<code>exec</code>\u7cfb\u7edf\u8c03\u7528\u4f1a\u5411\u5185\u6838\u4f20\u9012\u4e00\u4e2a\u6307\u5411\u7528\u6237\u7a7a\u95f4\u4e2d\u7684\u5b57\u7b26\u4e32\u7684\u6307\u9488\u6570\u7ec4\u3002\u8fd9\u4e9b\u6307\u9488\u5e26\u6765\u4e86\u4e24\u4e2a\u6311\u6218\u3002\u9996\u5148\uff0c\u7528\u6237\u7a0b\u5e8f\u53ef\u80fd\u662f\u9519\u8bef\u7684\u6216\u6076\u610f\u7684\uff0c\u53ef\u80fd\u4f1a\u4f20\u9012\u7ed9\u5185\u6838\u4e00\u4e2a\u65e0\u6548\u7684\u6307\u9488\u6216\u4e00\u4e2a\u65e8\u5728\u6b3a\u9a97\u5185\u6838\u8bbf\u95ee\u5185\u6838\u5185\u5b58\u800c\u4e0d\u662f\u7528\u6237\u5185\u5b58\u7684\u6307\u9488\u3002\u7b2c\u4e8c\uff0cxv6\u5185\u6838\u9875\u8868\u6620\u5c04\u4e0e\u7528\u6237\u9875\u8868\u6620\u5c04\u4e0d\u4e00\u6837\uff0c\u6240\u4ee5\u5185\u6838\u4e0d\u80fd\u4f7f\u7528\u666e\u901a\u6307\u4ee4\u4ece\u7528\u6237\u63d0\u4f9b\u7684\u5730\u5740\u52a0\u8f7d\u6216\u5b58\u50a8\u3002</p> <p>\u5185\u6838\u5b9e\u73b0\u4e86\u5b89\u5168\u5730\u5c06\u6570\u636e\u590d\u5236\u5230\u7528\u6237\u63d0\u4f9b\u7684\u5730\u5740\u6216\u4ece\u7528\u6237\u63d0\u4f9b\u7684\u5730\u5740\u590d\u5236\u6570\u636e\u7684\u51fd\u6570\u3002\u4f8b\u5982<code>fetchstr</code>\uff08kernel/syscall.c:25\uff09\u3002\u6587\u4ef6\u7cfb\u7edf\u8c03\u7528\uff0c\u5982<code>exec</code>\uff0c\u4f7f\u7528<code>fetchstr</code>\u4ece\u7528\u6237\u7a7a\u95f4\u4e2d\u68c0\u7d22\u5b57\u7b26\u4e32\u6587\u4ef6\u540d\u53c2\u6570\u3002<code>fetchstr</code>\u8c03\u7528<code>copyinstr</code>\u6765\u505a\u8fd9\u4e9b\u56f0\u96be\u7684\u5de5\u4f5c\u3002</p> <p><code>copyinstr</code>\uff08kernel/vm.c:406\uff09\u5c06\u7528\u6237\u9875\u8868<code>pagetable</code>\u4e2d\u7684\u865a\u62df\u5730\u5740<code>srcva</code>\u590d\u5236\u5230<code>dst</code>\uff0c\u9700\u6307\u5b9a\u6700\u5927\u590d\u5236\u5b57\u8282\u6570\u3002\u5b83\u4f7f\u7528<code>walkaddr</code>\uff08\u8c03\u7528<code>walk</code>\u51fd\u6570\uff09\u5728\u8f6f\u4ef6\u4e2d\u6a21\u62df\u5206\u9875\u786c\u4ef6\u7684\u64cd\u4f5c\uff0c\u4ee5\u786e\u5b9a<code>srcva</code>\u7684\u7269\u7406\u5730\u5740<code>pa0</code>\u3002<code>walkaddr</code>\uff08kernel/vm.c:95\uff09\u68c0\u67e5\u7528\u6237\u63d0\u4f9b\u7684\u865a\u62df\u5730\u5740\u662f\u5426\u662f\u8fdb\u7a0b\u7528\u6237\u5730\u5740\u7a7a\u95f4\u7684\u4e00\u90e8\u5206\uff0c\u6240\u4ee5\u7a0b\u5e8f\u4e0d\u80fd\u6b3a\u9a97\u5185\u6838\u8bfb\u53d6\u5176\u4ed6\u5185\u5b58\u3002\u7c7b\u4f3c\u7684\u51fd\u6570<code>copyout</code>\uff0c\u53ef\u4ee5\u5c06\u6570\u636e\u4ece\u5185\u6838\u590d\u5236\u5230\u7528\u6237\u63d0\u4f9b\u7684\u5730\u5740\u3002</p>"},{"location":"os/Chapter-4/#45-traps-from-kernel-space","title":"4.5 Traps from kernel space","text":"<p>Xv6\u6839\u636e\u7528\u6237\u8fd8\u662f\u5185\u6838\u4ee3\u7801\u6b63\u5728\u6267\u884c\uff0c\u5bf9CPU\u9677\u9631\u5bc4\u5b58\u5668\u7684\u914d\u7f6e\u7565\u6709\u4e0d\u540c\u884c\u4e3a\u3002\u5f53\u5185\u6838\u5728CPU\u4e0a\u6267\u884c\u65f6\uff0c\u5185\u6838\u5c06<code>stvec</code>\u6307\u5411<code>kernelvec</code>\u4e0a\u7684\u6c47\u7f16\u4ee3\u7801\uff08kernel/kernelvec.S:10\uff09\u3002\u7531\u4e8exv6\u5df2\u7ecf\u5728\u5185\u6838\u4e2d\uff0c<code>kernelvec</code>\u53ef\u4ee5\u4f7f\u7528<code>satp</code>\uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5185\u6838\u9875\u8868\uff0c\u4ee5\u53ca\u5f15\u7528\u6709\u6548\u5185\u6838\u7684\u5806\u6808\u6307\u9488\u3002<code>kernelvec</code>\u4fdd\u5b58\u6240\u6709\u5bc4\u5b58\u5668\uff0c\u4ee5\u4fbf\u4e2d\u65ad\u7684\u4ee3\u7801\u6700\u540e\u53ef\u4ee5\u5728\u6ca1\u6709\u4e2d\u65ad\u7684\u60c5\u51b5\u4e0b\u6062\u590d\u3002</p> <p><code>kernelvec</code>\u5c06\u5bc4\u5b58\u5668\u4fdd\u5b58\u5728\u4e2d\u65ad\u5185\u6838\u7ebf\u7a0b\u7684\u5806\u6808\u4e0a\uff0c\u56e0\u4e3a\u5bc4\u5b58\u5668\u503c\u5c5e\u4e8e\u8be5\u7ebf\u7a0b\uff0c\u8fd9\u662f\u5408\u7406\u7684\u3002\u5982\u679ctrap\u5bfc\u81f4\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u2014\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0ctrap\u5c06\u5b9e\u9645\u8fd4\u56de\u5230\u65b0\u7ebf\u7a0b\u7684\u6808\u4e0a\uff0c\u5c06\u4e2d\u65ad\u7ebf\u7a0b\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u5b89\u5168\u5730\u4fdd\u7559\u5728\u5176\u5806\u6808\u4e0a\u3002</p> <p><code>kernelvec</code>\u5728\u4fdd\u5b58\u5bc4\u5b58\u5668\u540e\u8df3\u8f6c\u5230<code>kerneltrap</code>\uff08kernel/trap.c:134\uff09\u3002<code>kerneltrap</code>\u662f\u4e3a\u4e24\u79cd\u7c7b\u578b\u7684\u9677\u9631\u51c6\u5907\u7684\uff1a\u8bbe\u5907\u4e2d\u65ad\u548c\u5f02\u5e38\u3002\u5b83\u8c03\u7528<code>devintr</code>\uff08kernel/trap.c:177\uff09\u6765\u68c0\u67e5\u548c\u5904\u7406\u524d\u8005\u3002\u5982\u679ctrap\u4e0d\u662f\u8bbe\u5907\u4e2d\u65ad\uff0c\u90a3\u4e48\u5b83\u5fc5\u987b\u662f\u5f02\u5e38\uff0c\u5982\u679c\u5b83\u53d1\u751f\u5728xv6\u5185\u6838\u4e2d\uff0c\u5219\u4e00\u5b9a\u662f\u4e00\u4e2a\u81f4\u547d\u9519\u8bef\uff1b\u5185\u6838\u8c03\u7528<code>panic</code>\u5e76\u505c\u6b62\u6267\u884c\u3002</p> <p>\u5982\u679c\u7531\u4e8e\u8ba1\u65f6\u5668\u4e2d\u65ad\u800c\u8c03\u7528\u4e86<code>kerneltrap</code>\uff0c\u5e76\u4e14\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\u6b63\u5728\u8fd0\u884c\uff08\u800c\u4e0d\u662f\u8c03\u5ea6\u7a0b\u5e8f\u7ebf\u7a0b\uff09\uff0c<code>kerneltrap</code>\u8c03\u7528<code>yield</code>\u8ba9\u51faCPU\uff0c\u5141\u8bb8\u5176\u4ed6\u7ebf\u7a0b\u8fd0\u884c\u3002\u5728\u67d0\u4e2a\u65f6\u523b\uff0c\u5176\u4e2d\u4e00\u4e2a\u7ebf\u7a0b\u5c06\u9000\u51fa\uff0c\u5e76\u8ba9\u6211\u4eec\u7684\u7ebf\u7a0b\u53ca\u5176<code>kerneltrap</code>\u6062\u590d\u3002\u7b2c7\u7ae0\u89e3\u91ca\u4e86\u7ebf\u7a0b\u8ba9\u51faCPU\u63a7\u5236\u6743\u3002</p> <p>\u5f53<code>kerneltrap</code>\u7684\u5de5\u4f5c\u5b8c\u6210\u65f6\uff0c\u5b83\u9700\u8981\u8fd4\u56de\u5230\u88ab\u4e2d\u65ad\u7684\u4ee3\u7801\u3002\u56e0\u4e3a<code>yield</code>\u53ef\u80fd\u7834\u574f\u4fdd\u5b58\u7684<code>sepc</code>\u548c\u5728<code>sstatus</code>\u4e2d\u4fdd\u5b58\u7684\u4e4b\u524d\u7684\u6a21\u5f0f\u3002<code>kerneltrap</code>\u5728\u542f\u52a8\u65f6\u4fdd\u5b58\u5b83\u4eec\u3002\u5b83\u73b0\u5728\u6062\u590d\u90a3\u4e9b\u63a7\u5236\u5bc4\u5b58\u5668\u5e76\u8fd4\u56de\u5230<code>kernelvec</code>\uff08kernel/kernelvec.S:48\uff09\u3002<code>kernelvec</code>\u4ece\u5806\u6808\u6062\u590d\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u5e76\u6267\u884c<code>sret</code>\uff0c<code>sret</code>\u5c06<code>sepc</code>\u590d\u5236\u5230<code>pc</code>\u5e76\u6062\u590d\u4e2d\u65ad\u7684\u5185\u6838\u4ee3\u7801\u3002</p> <p>\u53ef\u4ee5\u601d\u8003\u4e00\u4e0b\uff0c\u5982\u679c\u56e0\u4e3a\u65f6\u95f4\u4e2d\u65ad\uff0c<code>kerneltrap</code>\u8c03\u7528\u4e86<code>yield</code>\uff0ctrap return\u662f\u5982\u4f55\u53d1\u751f\u7684\u3002</p> <p>\u5f53CPU\u4ece\u7528\u6237\u7a7a\u95f4\u8fdb\u5165\u5185\u6838\u65f6\uff0cXv6\u5c06CPU\u7684<code>stvec</code>\u8bbe\u7f6e\u4e3a<code>kernelvec</code>\uff1b\u53ef\u4ee5\u5728<code>usertrap</code>\uff08kernel/trap.c:29\uff09\u4e2d\u770b\u5230\u8fd9\u4e00\u70b9\u3002\u5185\u6838\u8fd0\u884c\u4f46<code>stvec</code>\u88ab\u8bbe\u7f6e\u4e3a<code>uservec</code>\u65f6\uff0c\u8fd9\u671f\u95f4\u6709\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\uff0c\u5728\u8fd9\u4e2a\u7a97\u53e3\u671f\uff0c\u7981\u7528\u8bbe\u5907\u4e2d\u65ad\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002\u5e78\u8fd0\u7684\u662f\uff0cRISC-V\u603b\u662f\u5728\u5f00\u59cb\u4f7f\u7528trap\u65f6\u7981\u7528\u4e2d\u65ad\uff0cxv6\u5728\u8bbe\u7f6e<code>stvec</code>\u4e4b\u524d\u4e0d\u4f1a\u518d\u6b21\u542f\u7528\u5b83\u4eec\u3002</p>"},{"location":"os/Chapter-4/#46-page-fault-exceptions","title":"4.6 Page-fault exceptions","text":"<p>Xv6\u5bf9\u5f02\u5e38\u7684\u54cd\u5e94\u662f\u76f8\u5f53\u56fa\u5b9a\uff1a\u5982\u679c\u4e00\u4e2a\u5f02\u5e38\u53d1\u751f\u5728\u7528\u6237\u7a7a\u95f4\uff0c\u5185\u6838\u5c31\u4f1a\u6740\u6b7b\u6545\u969c\u8fdb\u7a0b\u3002\u5982\u679c\u4e00\u4e2a\u5f02\u5e38\u53d1\u751f\u5728\u5185\u6838\u4e2d\uff0c\u5185\u6838\u5c31\u4f1a**panic**\u3002\u771f\u6b63\u7684\u64cd\u4f5c\u7cfb\u7edf\u901a\u5e38\u4f1a\u4ee5\u66f4\u6709\u8da3\u7684\u65b9\u5f0f\u8fdb\u884c\u54cd\u5e94\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u8bb8\u591a\u5185\u6838\u4f7f\u7528\u9875\u9762\u6545\u969c\u6765\u5b9e\u73b0***\u5199\u65f6\u590d\u5236\uff08copy-on-write\uff0ccow\uff09fork*\u3002\u8981\u89e3\u91ca\u5199\u65f6\u590d\u5236fork\uff0c\u53ef\u4ee5\u60f3\u4e00\u60f3xv6\u7684<code>fork</code>\uff0c\u5728\u7b2c3\u7ae0\u4e2d\u4ecb\u7ecd\u8fc7\u3002<code>fork</code>\u901a\u8fc7\u8c03\u7528<code>uvmcopy</code>\uff08kernel/vm.c:309\uff09\u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u7269\u7406\u5185\u5b58\uff0c\u5e76\u5c06\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u590d\u5236\u5230\u5b50\u7a0b\u5e8f\u4e2d\uff0c\u4f7f\u5b50\u8fdb\u7a0b\u62e5\u6709\u4e0e\u7236\u8fdb\u7a0b\u76f8\u540c\u7684\u5185\u5b58\u5185\u5bb9\u3002\u5982\u679c\u5b50\u8fdb\u7a0b\u548c\u7236\u8fdb\u7a0b\u80fd\u591f\u5171\u4eab\u7236\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58\uff0c\u6548\u7387\u4f1a\u66f4\u9ad8\u3002\u7136\u800c\uff0c\u76f4\u63a5\u5b9e\u73b0\u8fd9\u79cd\u65b9\u6cd5\u662f\u884c\u4e0d\u901a\u7684\uff0c\u56e0\u4e3a\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u5bf9\u5171\u4eab\u6808\u548c\u5806\u7684\u5199\u5165\u4f1a\u4e2d\u65ad\u5f7c\u6b64\u7684\u6267\u884c\u3002</p> <p>\u901a\u8fc7\u4f7f\u7528\u5199\u65f6\u590d\u5236fork\uff0c\u53ef\u4ee5\u8ba9\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u5b89\u5168\u5730\u5171\u4eab\u7269\u7406\u5185\u5b58\uff0c\u901a\u8fc7\u9875\u9762\u6545\u969c\u6765\u5b9e\u73b0\u3002\u5f53CPU\u4e0d\u80fd\u5c06\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u6210\u7269\u7406\u5730\u5740\u65f6\uff0cCPU\u4f1a\u4ea7\u751f\u4e00\u4e2a\u9875\u9762\u6545\u969c\u5f02\u5e38\uff08page-fault exception\uff09\u3002 RISC-V\u6709\u4e09\u79cd\u4e0d\u540c\u7684\u9875\u6545\u969c\uff1aload\u9875\u6545\u969c\uff08\u5f53\u52a0\u8f7d\u6307\u4ee4\u4e0d\u80fd\u7ffb\u8bd1\u5176\u865a\u62df\u5730\u5740\u65f6\uff09\u3001stote\u9875\u6545\u969c\uff08\u5f53\u5b58\u50a8\u6307\u4ee4\u4e0d\u80fd\u7ffb\u8bd1\u5176\u865a\u62df\u5730\u5740\u65f6\uff09\u548c\u6307\u4ee4\u9875\u6545\u969c\uff08\u5f53\u6307\u4ee4\u7684\u5730\u5740\u4e0d\u80fd\u7ffb\u8bd1\u65f6\uff09\u3002<code>scause</code>\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u8868\u793a\u9875\u9762\u6545\u969c\u7684\u7c7b\u578b\uff0c<code>stval</code>\u5bc4\u5b58\u5668\u4e2d\u5305\u542b\u65e0\u6cd5\u7ffb\u8bd1\u7684\u5730\u5740\u3002</p> <p>COW  fork\u4e2d\u7684\u57fa\u672c\u8bbe\u8ba1\u662f\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u6700\u521d\u5171\u4eab\u6240\u6709\u7684\u7269\u7406\u9875\u9762\uff0c\u4f46\u5c06\u5b83\u4eec\u6620\u5c04\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\u3002\u56e0\u6b64\uff0c\u5f53\u5b50\u8fdb\u7a0b\u6216\u7236\u8fdb\u7a0b\u6267\u884cstore\u6307\u4ee4\u65f6\uff0cRISC-V CPU\u4f1a\u5f15\u53d1\u4e00\u4e2a\u9875\u9762\u6545\u969c\u5f02\u5e38\u3002\u4f5c\u4e3a\u5bf9\u8fd9\u4e2a\u5f02\u5e38\u7684\u54cd\u5e94\uff0c\u5185\u6838\u4f1a\u62f7\u8d1d\u4e00\u4efd\u5305\u542b\u6545\u969c\u5730\u5740\u7684\u9875\u3002\u7136\u540e\u5c06\u4e00\u4e2a\u526f\u672c\u7684\u8bfb/\u5199\u6620\u5c04\u5728\u5b50\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\uff0c\u53e6\u4e00\u4e2a\u526f\u672c\u7684\u8bfb/\u5199\u6620\u5c04\u5728\u7236\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4\u3002\u66f4\u65b0\u9875\u8868\u540e\uff0c\u5185\u6838\u5728\u5f15\u8d77\u6545\u969c\u7684\u6307\u4ee4\u5904\u6062\u590d\u6545\u969c\u5904\u7406\u3002\u56e0\u4e3a\u5185\u6838\u5df2\u7ecf\u66f4\u65b0\u4e86\u76f8\u5173\u7684PTE\uff0c\u5141\u8bb8\u5199\u5165\uff0c\u6240\u4ee5\u73b0\u5728\u6545\u969c\u6307\u4ee4\u5c06\u6b63\u5e38\u6267\u884c\u3002</p> <p>\u8fd9\u4e2aCOW\u8bbe\u8ba1\u5bf9<code>fork</code>\u5f88\u6709\u6548\uff0c\u56e0\u4e3a\u5f80\u5f80\u5b50\u7a0b\u5e8f\u5728fork\u540e\u7acb\u5373\u8c03\u7528exec\uff0c\u7528\u65b0\u7684\u5730\u5740\u7a7a\u95f4\u66ff\u6362\u5176\u5730\u5740\u7a7a\u95f4\u3002\u5728\u8fd9\u79cd\u5e38\u89c1\u7684\u60c5\u51b5\u4e0b\uff0c\u5b50\u7a0b\u5e8f\u53ea\u4f1a\u9047\u5230\u4e00\u4e9b\u9875\u9762\u6545\u969c\uff0c\u800c\u5185\u6838\u53ef\u4ee5\u907f\u514d\u8fdb\u884c\u5b8c\u6574\u7684\u590d\u5236\u3002\u6b64\u5916\uff0cCOW fork\u662f\u900f\u660e\u7684\uff1a\u4e0d\u9700\u8981\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\uff0c\u5e94\u7528\u7a0b\u5e8f\u5c31\u80fd\u53d7\u76ca\u3002</p> <p>\u9875\u8868\u548c\u9875\u6545\u969c\u7684\u7ed3\u5408\uff0c\u5c06\u4f1a\u6709\u66f4\u591a\u79cd\u6709\u8da3\u7684\u53ef\u80fd\u6027\u7684\u5e94\u7528\u3002\u53e6\u4e00\u4e2a\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u7279\u6027\u53eb\u505a***\u61d2\u5206\u914d (lazy allocation)***\uff0c\u5b83\u6709\u4e24\u4e2a\u90e8\u5206\u3002\u9996\u5148\uff0c\u5f53\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528<code>sbrk</code>\u65f6\uff0c\u5185\u6838\u4f1a\u589e\u957f\u5730\u5740\u7a7a\u95f4\uff0c\u4f46\u5728\u9875\u8868\u4e2d\u628a\u65b0\u7684\u5730\u5740\u6807\u8bb0\u4e3a\u65e0\u6548\u3002\u7b2c\u4e8c\uff0c\u5f53\u8fd9\u4e9b\u65b0\u5730\u5740\u4e2d\u7684\u4e00\u4e2a\u51fa\u73b0\u9875\u9762\u6545\u969c\u65f6\uff0c\u5185\u6838\u5206\u914d\u7269\u7406\u5185\u5b58\u5e76\u5c06\u5176\u6620\u5c04\u5230\u9875\u8868\u4e2d\u3002\u7531\u4e8e\u5e94\u7528\u7a0b\u5e8f\u7ecf\u5e38\u8981\u6c42\u83b7\u5f97\u6bd4\u4ed6\u4eec\u9700\u8981\u7684\u66f4\u591a\u7684\u5185\u5b58\uff0c\u6240\u4ee5\u61d2\u5206\u914d\u662f\u4e00\u4e2a\u80dc\u5229\uff1a\u5185\u6838\u53ea\u5728\u5e94\u7528\u7a0b\u5e8f\u5b9e\u9645\u4f7f\u7528\u65f6\u624d\u5206\u914d\u5185\u5b58\u3002\u50cfCOW fork\u4e00\u6837\uff0c\u5185\u6838\u53ef\u4ee5\u5bf9\u5e94\u7528\u7a0b\u5e8f\u900f\u660e\u5730\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u3002</p> <p>\u53e6\u4e00\u4e2a\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u5229\u7528\u9875\u9762\u6545\u969c\u7684\u529f\u80fd\u662f\u4ece***\u78c1\u76d8\u4e0a\u5206\u9875(paging from disk)***\u3002\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u9700\u8981\u7684\u5185\u5b58\u8d85\u8fc7\u4e86\u53ef\u7528\u7684\u7269\u7406RAM\uff0c\u5185\u6838\u53ef\u4ee5\u4ea4\u6362\u51fa\u4e00\u4e9b\u9875\uff1a\u5c06\u5b83\u4eec\u5199\u5165\u4e00\u4e2a\u5b58\u50a8\u8bbe\u5907\uff0c\u6bd4\u5982\u78c1\u76d8\uff0c\u5e76\u5c06\u5176PTE\u6807\u8bb0\u4e3a\u65e0\u6548\u3002\u5982\u679c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8bfb\u53d6\u6216\u5199\u5165\u4e00\u4e2a\u88ab\u6362\u51fa\u5230\u78c1\u76d8\u7684\u9875\uff0cCPU\u5c06\u9047\u5230\u4e00\u4e2a\u9875\u9762\u6545\u969c\u3002\u5185\u6838\u5c31\u53ef\u4ee5\u68c0\u67e5\u6545\u969c\u5730\u5740\u3002\u5982\u679c\u8be5\u5730\u5740\u5c5e\u4e8e\u78c1\u76d8\u4e0a\u7684\u9875\u9762\uff0c\u5185\u6838\u5c31\u4f1a\u5206\u914d\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u7684\u9875\u9762\uff0c\u4ece\u78c1\u76d8\u4e0a\u8bfb\u53d6\u9875\u9762\u5230\u8be5\u5185\u5b58\uff0c\u66f4\u65b0PTE\u4e3a\u6709\u6548\u5e76\u5f15\u7528\u8be5\u5185\u5b58\uff0c\u7136\u540e\u6062\u590d\u5e94\u7528\u7a0b\u5e8f\u3002\u4e3a\u4e86\u7ed9\u8be5\u9875\u817e\u51fa\u7a7a\u95f4\uff0c\u5185\u6838\u53ef\u80fd\u8981\u4ea4\u6362\u53e6\u4e00\u4e2a\u9875\u3002\u8fd9\u4e2a\u7279\u6027\u4e0d\u9700\u8981\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u4efb\u4f55\u4fee\u6539\uff0c\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u5177\u6709\u5f15\u7528\u7684\u4f4d\u7f6e\u6027\uff08\u5373\u5b83\u4eec\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u53ea\u4f7f\u7528\u5176\u5185\u5b58\u7684\u4e00\u4e2a\u5b50\u96c6\uff09\uff0c\u8fd9\u4e2a\u7279\u6027\u5c31\u80fd\u5f88\u597d\u5730\u53d1\u6325\u4f5c\u7528\u3002</p> <p>\u5176\u4ed6\u7ed3\u5408\u5206\u9875\u548c\u5206\u9875\u9519\u8bef\u5f02\u5e38\u7684\u529f\u80fd\u5305\u62ec\u81ea\u52a8\u6269\u5c55\u5806\u6808\u548c\u5185\u5b58\u6620\u5c04\u6587\u4ef6\u3002</p>"},{"location":"os/Chapter-4/#47-real-world","title":"4.7 Real world","text":"<p>\u5982\u679c\u5c06\u5185\u6838\u5185\u5b58\u6620\u5c04\u5230\u6bcf\u4e2a\u8fdb\u7a0b\u7684\u7528\u6237\u9875\u8868\u4e2d\uff08\u4f7f\u7528\u9002\u5f53\u7684PTE\u6743\u9650\u6807\u5fd7\uff09\uff0c\u5c31\u4e0d\u9700\u8981\u7279\u6b8a\u7684trampoline\u9875\u4e86\u3002\u8fd9\u4e5f\u5c06\u6d88\u9664\u4ece\u7528\u6237\u7a7a\u95f4trap\u8fdb\u5165\u5185\u6838\u65f6\u5bf9\u9875\u8868\u5207\u6362\u7684\u9700\u6c42\u3002\u8fd9\u4e5f\u53ef\u4ee5\u8ba9\u5185\u6838\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u5229\u7528\u5f53\u524d\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\u88ab\u6620\u5c04\u7684\u4f18\u52bf\uff0c\u8ba9\u5185\u6838\u4ee3\u7801\u76f4\u63a5\u53bb\u95f4\u63a5\u5f15\u7528\uff08\u5bf9\u5730\u5740\u53d6\u503c\uff09\u7528\u6237\u6307\u9488\u3002\u8bb8\u591a\u64cd\u4f5c\u7cfb\u7edf\u5df2\u7ecf\u4f7f\u7528\u8fd9\u4e9b\u60f3\u6cd5\u6765\u63d0\u9ad8\u6548\u7387\u3002Xv6\u6ca1\u6709\u5b9e\u73b0\u8fd9\u4e9b\u60f3\u6cd5\uff0c\u4ee5\u51cf\u5c11\u7531\u4e8e\u65e0\u610f\u4f7f\u7528\u7528\u6237\u6307\u9488\u800c\u5bfc\u81f4\u5185\u6838\u51fa\u73b0\u5b89\u5168\u6f0f\u6d1e\u7684\u673a\u4f1a\uff0c\u5e76\u51cf\u5c11\u4e00\u4e9b\u590d\u6742\u6027\uff0c\u4ee5\u786e\u4fdd\u7528\u6237\u548c\u5185\u6838\u865a\u62df\u5730\u5740\u4e0d\u91cd\u53e0\u3002</p>"},{"location":"os/Chapter-4/#48-exercises","title":"4.8 Exercises","text":"<ol> <li>\u51fd\u6570<code>copyin</code>\u548c<code>copyinstr</code>\u5728\u8f6f\u4ef6\u4e2dwalk\u7528\u6237\u9875\u8868\u3002\u8bbe\u7f6e\u5185\u6838\u9875\u8868\uff0c\u4f7f\u5185\u6838\u62e5\u6709\u7528\u6237\u7a0b\u5e8f\u7684\u5185\u5b58\u6620\u5c04\uff0c<code>copyin</code>\u548c<code>copyinstr</code>\u53ef\u4ee5\u4f7f\u7528<code>memcpy</code>\u5c06\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u590d\u5236\u5230\u5185\u6838\u7a7a\u95f4\uff0c\u4f9d\u9760\u786c\u4ef6\u6765\u5b8c\u6210\u9875\u8868\u7684walk\u3002</li> <li>\u5b9e\u73b0\u5185\u5b58\u7684\u61d2\u5206\u914d\u3002</li> <li>\u5b9e\u73b0\u5199\u65f6\u590d\u5236 fork\u3002</li> </ol> <ol> <li> <p>\u5185\u6838\u4e2d\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u65f6\u76f4\u63a5\u6620\u5c04\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728\u542f\u7528\u5206\u9875\u65f6\uff0c\u901a\u8fc7\u7269\u7406\u5730\u5740\u8bbf\u95ee\u3002</p> </li> <li> <p>\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u8fdb\u7a0b\u7684pc\u4f1a\u6307\u5411ecall\u6307\u4ee4\uff0c\u8fd9\u91cc\u9700\u8981\u52a04\u6e05\u9664\uff0c\u56e0\u4e3a\u8fdb\u7a0b\u6808\u7684\u5730\u5740\u7a7a\u95f4\u662f\u4ece\u9ad8\u5230\u4f4e\u3002</p> </li> </ol>"},{"location":"os/Chapter-5/","title":"Chapter 5","text":""},{"location":"os/Chapter-5/#_1","title":"\u7b2c\u4e94\u7ae0\uff1a\u4e2d\u65ad\u548c\u8bbe\u5907\u9a71\u52a8","text":"<p>***\u9a71\u52a8***\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7ba1\u7406\u7279\u5b9a\u8bbe\u5907\u7684\u4ee3\u7801\uff0c\u5b83\u6709\u5982\u4e0b\u529f\u80fd\uff1a1\u3001\u914d\u7f6e\u8bbe\u5907\u76f8\u5173\u7684\u786c\u4ef6\uff0c2\u3001\u544a\u8bc9\u8bbe\u5907\u9700\u8981\u600e\u6837\u6267\u884c\uff0c3\u3001\u5904\u7406\u8bbe\u5907\u4ea7\u751f\u7684\u4e2d\u65ad\uff0c4\u3001\u4e0e\u7b49\u5f85\u8bbe\u5907I/O\u7684\u8fdb\u7a0b\u8fdb\u884c\u4ea4\u4e92\u3002\u9a71\u52a8\u7a0b\u5e8f\u7684\u4ee3\u7801\u5199\u8d77\u6765\u53ef\u80fd\u5f88\u68d8\u624b\uff0c\u56e0\u4e3a\u9a71\u52a8\u7a0b\u5e8f\u4e0e\u5b83\u6240\u7ba1\u7406\u7684\u8bbe\u5907\u4f1a\u5e76\u53d1\u3002\u6b64\u5916\uff0c\u9a71\u52a8\u5fc5\u987b\u4e86\u89e3\u8bbe\u5907\u7684\u786c\u4ef6\u63a5\u53e3\uff0c\u4f46\u786c\u4ef6\u63a5\u53e3\u53ef\u80fd\u662f\u5f88\u590d\u6742\u7684\uff0c\u800c\u4e14\u6587\u6863\u4e0d\u591f\u5b8c\u5584\u3002</p> <p>\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u5173\u6ce8\u7684\u8bbe\u5907\u901a\u5e38\u53ef\u4ee5\u88ab\u914d\u7f6e\u4e3a\u4ea7\u751f\u4e2d\u65ad\uff0c\u8fd9\u662ftrap\u7684\u4e00\u79cd\u7c7b\u578b\u3002\u5185\u6838trap\u5904\u7406\u4ee3\u7801\u53ef\u4ee5\u77e5\u9053\u8bbe\u5907\u4f55\u65f6\u5f15\u53d1\u4e86\u4e2d\u65ad\uff0c\u5e76\u8c03\u7528\u9a71\u52a8\u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff1b\u5728xv6\u4e2d\uff0c\u8fd9\u4e2a\u5904\u7406\u53d1\u751f\u5728**devintr**(kernel/trap.c:177)\u4e2d\u3002</p> <p>\u8bb8\u591a\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u5728\u4e24\u4e2acontext\u4e2d\u6267\u884c\u4ee3\u7801\uff1a\u4e0a\u534a\u90e8\u5206\uff08top half\uff09\u5728\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\u4e2d\u8fd0\u884c\uff0c\u4e0b\u534a\u90e8\u5206\uff08bottom half\uff09\u5728\u4e2d\u65ad\u65f6\u6267\u884c\u3002\u4e0a\u534a\u90e8\u5206\u662f\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\uff0c\u5982\u5e0c\u671b\u6267\u884cI/O\u7684 read\u548cwrite\u3002\u8fd9\u6bb5\u4ee3\u7801\u53ef\u80fd\u4f1a\u8981\u6c42\u786c\u4ef6\u5f00\u59cb\u4e00\u4e2a\u64cd\u4f5c\uff08\u6bd4\u5982\u8981\u6c42\u78c1\u76d8\u8bfb\u53d6\u4e00\u4e2a\u5757\uff09\uff1b\u7136\u540e\u4ee3\u7801\u7b49\u5f85\u64cd\u4f5c\u5b8c\u6210\u3002\u6700\u7ec8\u8bbe\u5907\u5b8c\u6210\u64cd\u4f5c\u5e76\u5f15\u53d1\u4e00\u4e2a\u4e2d\u65ad\u3002\u9a71\u52a8\u7a0b\u5e8f\u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\uff0c\u4f5c\u4e3a**\u4e0b\u534a\u90e8\u5206**\uff0c\u627e\u51fa\u4ec0\u4e48\u64cd\u4f5c\u5df2\u7ecf\u5b8c\u6210\uff0c\u5982\u679c\u5408\u9002\u7684\u8bdd\uff0c\u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u8be5\u64cd\u4f5c\u7684\u8fdb\u7a0b\uff0c\u5e76\u544a\u8bc9\u786c\u4ef6\u6267\u884c\u4e0b\u4e00\u4e2a\u64cd\u4f5c\u3002</p>"},{"location":"os/Chapter-5/#51-code-console-input","title":"5.1 Code: Console input","text":"<p>\u200b    \u63a7\u5236\u53f0\u9a71\u52a8(console.c)\u662f\u9a71\u52a8\u7ed3\u6784\u7684\u4e00\u4e2a\u7b80\u5355\u8bf4\u660e\u3002\u63a7\u5236\u53f0\u9a71\u52a8\u901a\u8fc7\u8fde\u63a5\u5230RISC-V\u4e0a\u7684UART\u4e32\u884c\u7aef\u53e3\u786c\u4ef6\uff0c\u63a5\u53d7\u8f93\u5165\u7684\u5b57\u7b26\u3002\u63a7\u5236\u53f0\u9a71\u52a8\u7a0b\u5e8f\u6bcf\u6b21\u7d2f\u8ba1\u4e00\u884c\u8f93\u5165\uff0c\u5904\u7406\u7279\u6b8a\u7684\u8f93\u5165\u5b57\u7b26\uff0c\u5982\u9000\u683c\u952e\u548ccontrol-u\u3002\u7528\u6237\u8fdb\u7a0b\uff0c\u5982shell\uff0c\u4f7f\u7528**read**\u7cfb\u7edf\u8c03\u7528\u4ece\u63a7\u5236\u53f0\u83b7\u53d6\u8f93\u5165\u884c\u3002\u5f53\u4f60\u5728QEMU\u4e2d\u5411xv6\u8f93\u5165\u65f6\uff0c\u4f60\u7684\u6309\u952e\u4f1a\u901a\u8fc7QEMU\u7684\u6a21\u62dfUART\u786c\u4ef6\u4f20\u9012\u7ed9xv6\u3002</p> <p>\u4e0e\u9a71\u52a8\u4ea4\u4e92\u7684UART\u786c\u4ef6\u662f\u7531QEMU\u4eff\u771f\u768416550\u82af\u7247[11]\u3002\u5728\u771f\u5b9e\u7684\u8ba1\u7b97\u673a\u4e0a\uff0c16550\u5c06\u7ba1\u7406\u4e00\u4e2a\u8fde\u63a5\u5230\u7ec8\u7aef\u6216\u5176\u4ed6\u8ba1\u7b97\u673a\u7684RS232\u4e32\u884c\u94fe\u63a5\u3002\u5f53\u8fd0\u884cQEMU\u65f6\uff0c\u5b83\u8fde\u63a5\u5230\u4f60\u7684\u952e\u76d8\u548c\u663e\u793a\u5668\u4e0a\u3002</p> <p>UART\u786c\u4ef6\u5728\u8f6f\u4ef6\u770b\u6765\u662f\u4e00\u7ec4**\u5185\u5b58\u6620\u5c04**\u7684\u63a7\u5236\u5bc4\u5b58\u5668\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6709\u4e00\u4e9bRISC-V\u786c\u4ef6\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\u4f1a\u5173\u8054\u5230UART\u8bbe\u5907\uff0c\u56e0\u6b64\u52a0\u8f7d\u548c\u5b58\u50a8\u4e0e\u8bbe\u5907\u786c\u4ef6\u800c\u4e0d\u662fRAM\u4ea4\u4e92\u3002UART\u7684\u5185\u5b58\u6620\u5c04\u5730\u5740\u4ece0x10000000\u5f00\u59cb\uff0c\u5373**UART0**\uff08kernel/memlayout.h:21\uff09\u3002\u8fd9\u91cc\u6709\u4e00\u4e9bUART\u63a7\u5236\u5bc4\u5b58\u5668\uff0c\u6bcf\u4e2a\u5bc4\u5b58\u5668\u7684\u5bbd\u5ea6\u662f\u4e00\u4e2a\u5b57\u8282\u3002\u5b83\u4eec\u4e0eUART0\u7684\u504f\u79fb\u91cf\u5b9a\u4e49\u5728(kernel/uart.c:22)\u3002\u4f8b\u5982\uff0c**LSR**\u5bc4\u5b58\u5668\u4e2d\u4e00\u4e9b\u4f4d\u8868\u793a\u662f\u5426\u6709\u8f93\u5165\u5b57\u7b26\u5728\u7b49\u5f85\u8f6f\u4ef6\u8bfb\u53d6\u3002\u8fd9\u4e9b\u5b57\u7b26\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\u53ef\u4ee5\u4ece**RHR**\u5bc4\u5b58\u5668\u4e2d\u8bfb\u53d6\u3002\u6bcf\u6b21\u8bfb\u53d6\u4e00\u4e2a\u5b57\u7b26\uff0cUART\u786c\u4ef6\u5c31\u4f1a\u5c06\u5176\u4ece\u5185\u90e8\u7b49\u5f85\u5b57\u7b26\u7684FIFO\u4e2d\u5220\u9664\uff0c\u5e76\u5728FIFO\u4e3a\u7a7a\u65f6\u6e05\u9664**LSR**\u4e2d\u7684\u5c31\u7eea\u4f4d\u3002UART\u4f20\u8f93\u786c\u4ef6\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u662f\u72ec\u7acb\u4e8e\u63a5\u6536\u786c\u4ef6\u7684\uff0c\u5982\u679c\u8f6f\u4ef6\u5411**THR**\u5199\u5165\u4e00\u4e2a\u5b57\u8282\uff0cUART\u5c31\u4f1a\u53d1\u9001\u8be5\u5b57\u8282\u3002</p> <p>Xv6\u7684**main**\u8c03\u7528**consoleinit**\uff08kernel/console.c:184\uff09\u6765\u521d\u59cb\u5316UART\u786c\u4ef6\u3002\u8fd9\u6bb5\u4ee3\u7801\u914d\u7f6e\u4e86UART\uff0c\u5f53UART\u63a5\u6536\u5230\u4e00\u4e2a\u5b57\u8282\u7684\u8f93\u5165\u65f6\uff0c\u5c31\u4ea7\u751f\u4e00\u4e2a\u63a5\u6536\u4e2d\u65ad\uff0c\u5f53UART\u6bcf\u6b21\u5b8c\u6210\u53d1\u9001\u4e00\u4e2a\u5b57\u8282\u7684\u8f93\u51fa\u65f6\uff0c\u4ea7\u751f\u4e00\u4e2a***\u4f20\u8f93\u5b8c\u6210(transmit complete)***\u4e2d\u65ad(kernel/uart.c:53)\u3002</p> <p>xv6 shell\u901a\u8fc7**init.c**(user/init.c:19)\u6253\u5f00\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u4ece\u63a7\u5236\u53f0\u8bfb\u53d6\u3002\u5bf9**read**\u7684\u7cfb\u7edf\u8c03\u7528\u901a\u8fc7\u5185\u6838\u5230\u8fbe**consoleread**\uff08kernel/console.c:82\uff09 \u3002consoleread**\u7b49\u5f85\u8f93\u5165\u7684\u5230\u6765(\u901a\u8fc7\u4e2d\u65ad)\uff0c\u8f93\u5165\u4f1a\u88ab\u7f13\u51b2\u5728**cons.buf\uff0c\u7136\u540e\u5c06\u8f93\u5165\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u518d\u7136\u540e(\u5728\u4e00\u6574\u884c\u5230\u8fbe\u540e)\u8fd4\u56de\u5230\u7528\u6237\u8fdb\u7a0b\u3002\u5982\u679c\u7528\u6237\u8fd8\u6ca1\u6709\u8f93\u5165\u5b8c\u6574\u7684\u884c\uff0c\u4efb\u4f55\u8c03\u7528\u4e86**read**\u8fdb\u7a0b\u5c06\u5728**sleep**\u4e2d\u7b49\u5f85(kernel/console.c:98)(\u7b2c7\u7ae0\u89e3\u91ca\u4e86sleep\u7684\u7ec6\u8282)\u3002</p> <p>\u5f53\u7528\u6237\u952e\u5165\u4e00\u4e2a\u5b57\u7b26\u65f6\uff0cUART\u786c\u4ef6\u5411RISC-V\u629b\u51fa\u4e00\u4e2a\u4e2d\u65ad\uff0c\u4ece\u800c\u6fc0\u6d3bxv6\u7684**trap**\u5904\u7406\u7a0b\u5e8f\u3002trap\u5904\u7406\u7a0b\u5e8f\u8c03\u7528devintr(kernel/trap.c:177)\uff0c\u5b83\u67e5\u770bRISC-V\u7684**scause**\u5bc4\u5b58\u5668\uff0c\u53d1\u73b0\u4e2d\u65ad\u6765\u81ea\u4e00\u4e2a\u5916\u90e8\u8bbe\u5907\u3002\u7136\u540e\u5b83\u5411\u4e00\u4e2a\u53eb\u505aPLIC[1]\u7684\u786c\u4ef6\u5355\u5143\u8be2\u95ee\u54ea\u4e2a\u8bbe\u5907\u4e2d\u65ad\u4e86(kernel/trap.c:186)\u3002\u5982\u679c\u662fUART\uff0cdevintr**\u8c03\u7528**uartintr\u3002</p> <p>uartintr (kernel/uart.c:180) \u4ece**UART**\u786c\u4ef6\u4e2d\u8bfb\u53d6\u5728\u7b49\u5f85\u7684\u8f93\u5165\u5b57\u7b26\uff0c\u5e76\u5c06\u5b83\u4eec\u4ea4\u7ed9**consoleintr** (kernel/console.c:138)\uff1b\u5b83\u4e0d\u4f1a\u7b49\u5f85\u8f93\u5165\u5b57\u7b26\uff0c\u56e0\u4e3a\u4ee5\u540e\u7684\u8f93\u5165\u4f1a\u5f15\u53d1\u4e00\u4e2a\u65b0\u7684\u4e2d\u65ad\u3002consoleintr**\u7684\u5de5\u4f5c\u662f\u5c06\u4e2d\u8f93\u5165\u5b57\u7b26\u79ef\u7d2f**cons.buf**\u4e2d\uff0c\u76f4\u5230\u6709\u4e00\u884c\u5b57\u7b26\u3002 **consoleintr**\u4f1a\u7279\u522b\u5904\u7406\u9000\u683c\u952e\u548c\u5176\u4ed6\u4e00\u4e9b\u5b57\u7b26\u3002\u5f53\u4e00\u4e2a\u65b0\u884c\u5230\u8fbe\u65f6\uff0c**consoleintr**\u4f1a\u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u7684**consoleread\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\u3002</p> <p>\u4e00\u65e6\u88ab\u5524\u9192\uff0c**consoleread**\u5c06\u4f1a\u6ce8\u610f\u5230**cons.buf**\u4e2d\u7684\u5b8c\u6574\u884c\uff0c\u5e76\u5c06\u5176\u5c06\u5176\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u5e76\u8fd4\u56de\uff08\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u673a\u5236\uff09\u5230\u7528\u6237\u7a7a\u95f4\u3002</p>"},{"location":"os/Chapter-5/#52-code-console-output","title":"5.2 Code: Console output","text":"<p>\u200b    \u5411\u63a7\u5236\u53f0\u5199\u6570\u636e\u7684**write**\u7cfb\u7edf\u8c03\u7528\u6700\u7ec8\u4f1a\u5230\u8fbe**uartputc**(kernel/uart.c:87)\u3002\u8bbe\u5907\u9a71\u52a8\u7ef4\u62a4\u4e86\u4e00\u4e2a\u8f93\u51fa\u7f13\u51b2\u533a(uart_tx_buf)\uff0c\u8fd9\u6837\u5199\u8fdb\u7a0b\u5c31\u4e0d\u9700\u8981\u7b49\u5f85UART\u5b8c\u6210\u53d1\u9001\uff1b\u76f8\u53cd\uff0c**uartputc**\u5c06\u6bcf\u4e2a\u5b57\u7b26\u8ffd\u52a0\u5230\u7f13\u51b2\u533a\uff0c\u8c03\u7528**uartstart**\u6765\u542f\u52a8\u8bbe\u5907\u53d1\u9001(\u5982\u679c\u8fd8\u6ca1\u6709\u7684\u8bdd)\uff0c\u7136\u540e\u8fd4\u56de\u3002**Uartputc**\u53ea\u6709\u5728\u7f13\u51b2\u533a\u6ee1\u7684\u65f6\u5019\u624d\u4f1a\u7b49\u5f85\u3002</p> <p>\u200b    \u6bcf\u6b21UART\u53d1\u9001\u5b8c\u6210\u4e00\u4e2a\u5b57\u8282\uff0c\u5b83\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e2d\u65ad\u3002uartintr**\u8c03\u7528**uartstart\uff0c**uartintr**\u68c0\u67e5\u8bbe\u5907\u662f\u5426\u771f\u7684\u53d1\u9001\u5b8c\u6bd5\uff0c\u5e76\u5c06\u4e0b\u4e00\u4e2a\u7f13\u51b2\u8f93\u51fa\u5b57\u7b26\u4ea4\u7ed9\u8bbe\u5907\uff0c\u6bcf\u5f53UART\u53d1\u9001\u5b8c\u4e00\u4e2a\u5b57\u8282\uff0c\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e2d\u65ad\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u5411\u63a7\u5236\u53f0\u5199\u5165\u591a\u4e2a\u5b57\u8282\uff0c\u901a\u5e38\u7b2c\u4e00\u4e2a\u5b57\u8282\u5c06\u7531uartputc s\u8c03\u7528uartstart\u53d1\u9001\uff0c\u5176\u4f59\u7684\u7f13\u51b2\u5b57\u8282\u5c06\u7531uartintr\u8c03\u7528uartstart\u53d1\u9001\uff0c\u56e0\u4e3a\u53d1\u9001\u5b8c\u6210\u4e2d\u65ad\u5230\u6765\u3002</p> <p>uartintr**\u8c03\u7528**uartstart\uff0c**uartintr**\u67e5\u770b\u8bbe\u5907\u662f\u5426\u771f\u7684\u53d1\u9001\u5b8c\u6210\uff0c\u5e76\u5c06\u4e0b\u4e00\u4e2a\u7f13\u51b2\u8f93\u51fa\u5b57\u7b26\u4ea4\u7ed9\u8bbe\u5907\uff0c\u6bcf\u5f53UART\u53d1\u9001\u5b8c\u4e00\u4e2a\u5b57\u8282\uff0c\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e2d\u65ad\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u5411\u63a7\u5236\u53f0\u5199\u5165\u591a\u4e2a\u5b57\u8282\uff0c\u901a\u5e38\u7b2c\u4e00\u4e2a\u5b57\u8282\u5c06\u7531**uartputc**\u5bf9**uartstart**\u7684\u8c03\u7528\u53d1\u9001\uff0c\u5176\u4f59\u7684\u7f13\u51b2\u5b57\u8282\u5c06\u968f\u7740\u53d1\u9001\u5b8c\u6210\u4e2d\u65ad\u7684\u5230\u6765\u7531**uartintr**\u7684**uartstart**\u8c03\u7528\u53d1\u9001\u3002</p> <p>\u6709\u4e00\u4e2a\u901a\u7528\u6a21\u5f0f\u9700\u8981\u6ce8\u610f\uff0c\u8bbe\u5907\u6d3b\u52a8\u548c\u8fdb\u7a0b\u6d3b\u52a8\u9700\u8981\u89e3\u8026\uff0c\u8fd9\u5c06\u901a\u8fc7\u7f13\u51b2\u548c\u4e2d\u65ad\u6765\u5b9e\u73b0\u3002\u63a7\u5236\u53f0\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4ee5\u5904\u7406\u8f93\u5165\uff0c\u5373\u4f7f\u6ca1\u6709\u8fdb\u7a0b\u7b49\u5f85\u8bfb\u53d6\u5b83\uff1b\u968f\u540e\u7684\u8bfb\u53d6\u5c06\u770b\u5230\u8f93\u5165\u3002\u540c\u6837\uff0c\u8fdb\u7a0b\u53ef\u4ee5\u53d1\u9001\u8f93\u51fa\u5b57\u8282\uff0c\u800c\u4e0d\u5fc5\u7b49\u5f85\u8bbe\u5907\u3002\u8fd9\u79cd\u89e3\u8026\u53ef\u4ee5\u901a\u8fc7\u5141\u8bb8\u8fdb\u7a0b\u4e0e\u8bbe\u5907I/O\u5e76\u53d1\u6267\u884c\u6765\u63d0\u9ad8\u6027\u80fd\uff0c\u5f53\u8bbe\u5907\u901f\u5ea6\u5f88\u6162\uff08\u5982UART\uff09\u6216\u9700\u8981\u7acb\u5373\u5173\u6ce8\uff08\u5982\u56de\u663e\u952e\u5165\u7684\u5b57\u8282\uff09\u65f6\uff0c\u8fd9\u79cd\u89e3\u8026\u5c24\u4e3a\u91cd\u8981\u3002\u8fd9\u4e2aidea\u6709\u65f6\u88ab\u79f0\u4e3a***I/O\u5e76\u53d1***\u3002</p>"},{"location":"os/Chapter-5/#53-concurrency-in-drivers","title":"5.3 Concurrency in drivers","text":"<p>\u4f60\u53ef\u80fd\u5df2\u7ecf\u6ce8\u610f\u5230\u5728**consoleread**\u548c**consoleintr**\u4e2d\u4f1a\u8c03\u7528**acquire**\u3002acquire**\u8c03\u7528\u4f1a\u83b7\u53d6\u4e00\u4e2a\u9501\uff0c\u4fdd\u62a4\u63a7\u5236\u53f0\u9a71\u52a8\u7684\u6570\u636e\u7ed3\u6784\u4e0d\u88ab\u5e76\u53d1\u8bbf\u95ee\u3002\u8fd9\u91cc\u6709\u4e09\u4e2a\u5e76\u53d1\u98ce\u9669\uff1a\u4e0d\u540cCPU\u4e0a\u7684\u4e24\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u540c\u65f6\u8c03\u7528**consoleread\uff1b\u786c\u4ef6\u53ef\u80fd\u4f1a\u5728\u4e00\u4e2aCPU\u6b63\u5728\u6267\u884cconsoleread\u65f6\uff0c\u5411\u8be5CPU\u629b\u51fa\u4e00\u4e2a\u63a7\u5236\u53f0\uff08\u5b9e\u9645\u4e0a\u662fUART\uff09\u4e2d\u65ad\uff1b\u786c\u4ef6\u53ef\u80fd\u4f1a\u5728consoleread\u6267\u884c\u65f6\u5411\u53e6\u4e00\u4e2aCPU\u629b\u51fa\u4e00\u4e2a\u63a7\u5236\u53f0\u4e2d\u65ad\u3002\u7b2c6\u7ae0\u63a2\u8ba8\u9501\u5982\u4f55\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\u63d0\u4f9b\u5e2e\u52a9\u3002</p> <p>\u9700\u8981\u5173\u6ce8\u9a71\u52a8\u5e76\u53d1\u5b89\u5168\u7684\u53e6\u4e00\u4e2a\u539f\u56e0\u662f\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u6b63\u5728\u7b49\u5f85\u6765\u81ea\u8bbe\u5907\u7684\u8f93\u5165\uff0c\u4f46\u662f\u5f53\u8868\u660e\u8f93\u5165\u5230\u6765\u7684\u4e2d\u65ad\u53d1\u751f\u65f6\u8be5\u8fdb\u7a0b\u5df2\u7ecf\u6ca1\u6709\u5728\u8fd0\u884c\uff08\u88ab\u5207\u6362\uff09\u3002\u56e0\u6b64\uff0c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4e0d\u5141\u8bb8\u77e5\u9053\u88ab\u4e2d\u65ad\u7684\u8fdb\u7a0b\u6216\u4ee3\u7801\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4e0d\u80fd\u5b89\u5168\u5730\u7528\u5f53\u524d\u8fdb\u7a0b\u7684\u9875\u8868\u8c03\u7528**copyout**\u3002\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u901a\u5e38\u53ea\u505a\u76f8\u5bf9\u8f83\u5c11\u7684\u5de5\u4f5c\uff08\u4f8b\u5982\uff0c\u53ea\u662f\u5c06\u8f93\u5165\u6570\u636e\u590d\u5236\u5230\u7f13\u51b2\u533a\uff09\uff0c\u5e76\u5524\u9192***\u4e0a\u534a\u90e8\u5206***\u4ee3\u7801\u6765\u505a\u5269\u4e0b\u7684\u5de5\u4f5c\u3002</p>"},{"location":"os/Chapter-5/#54-timer-interrupts","title":"5.4 Timer interrupts","text":"<p>Xv6\u4f7f\u7528\u5b9a\u65f6\u5668\u4e2d\u65ad\u6765\u7ef4\u62a4\u5b83\u7684\u65f6\u949f\uff0c\u5e76\u4f7f\u5b83\u80fd\u591f\u5207\u6362\u8ba1\u7b97\u5bc6\u96c6\u578b\u8fdb\u7a0b\uff1b**usertrap**\u548c**kerneltrap**\u4e2d\u7684**yield**\u8c03\u7528\u4f1a\u5bfc\u81f4\u8fd9\u79cd\u5207\u6362\u3002\u6bcf\u4e2aRISC-V CPU\u7684\u65f6\u949f\u786c\u4ef6\u90fd\u4f1a\u629b\u51fa\u65f6\u949f\u4e2d\u65ad\u3002Xv6\u5bf9\u8fd9\u4e2a\u65f6\u949f\u786c\u4ef6\u8fdb\u884c\u7f16\u7a0b\uff0c\u4f7f\u5176\u5b9a\u671f\u5468\u671f\u6027\u5730\u4e2d\u65ad\u76f8\u5e94\u7684CPU\u3002</p> <p>RISC-V\u8981\u6c42\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u5904\u7406\u5b9a\u65f6\u5668\u4e2d\u65ad\uff0c\u800c\u4e0d\u662f\u76d1\u7763\u8005\u6a21\u5f0f\u3002RISCV\u673a\u5668\u6a21\u5f0f\u6267\u884c\u65f6\u6ca1\u6709\u5206\u9875\uff0c\u5e76\u4e14\u6709\u4e00\u5957\u5355\u72ec\u7684\u63a7\u5236\u5bc4\u5b58\u5668\uff0c\u56e0\u6b64\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u8fd0\u884c\u666e\u901a\u7684xv6\u5185\u6838\u4ee3\u7801\u662f\u4e0d\u5b9e\u7528\u7684\u3002\u56e0\u6b64\uff0cxv6\u5bf9\u5b9a\u65f6\u5668\u4e2d\u65ad\u7684\u5904\u7406\u4e0e\u4e0a\u9762\u8c08\u5230\u7684trap\u673a\u5236\u5b8c\u5168\u5206\u79bb\u4e86\u3002</p> <p>\u5728main\u6267\u884c\u4e4b\u524d\u7684**start.c**\uff0c\u662f\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u6267\u884c\u7684\u3002\u5b83\u8bbe\u7f6e\u4e86\u63a5\u6536\u5b9a\u65f6\u5668\u4e2d\u65ad(kernel/start.c:57)\u3002\u4e00\u90e8\u5206\u5de5\u4f5c\u662f\u5bf9**CLINT**\u786c\u4ef6\uff08core-local interruptor\uff09\u8fdb\u884c\u7f16\u7a0b\uff0c\u4f7f\u5176\u6bcf\u9694\u4e00\u5b9a\u65f6\u95f4\u4ea7\u751f\u4e00\u6b21\u4e2d\u65ad\u3002\u53e6\u4e00\u90e8\u5206\u662f\u8bbe\u7f6e\u4e00\u4e2a\u7c7b\u4f3c\u4e8e**trapframe**\u7684\u6682\u5b58\u533a\uff0c\u5e2e\u52a9\u5b9a\u65f6\u5668\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4fdd\u5b58\u5bc4\u5b58\u5668\u548c**CLINT**\u5bc4\u5b58\u5668\u7684\u5730\u5740\u3002\u6700\u540e\uff0cstart**\u5c06**mtvec**\u8bbe\u7f6e\u4e3a**timervec\uff0c\u542f\u7528\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002</p> <p>\u5b9a\u65f6\u5668\u4e2d\u65ad\u53ef\u80fd\u53d1\u751f\u5728\u7528\u6237\u6216\u5185\u6838\u4ee3\u7801\u6267\u884c\u7684\u4efb\u4f55\u65f6\u5019\uff1b\u5185\u6838\u6ca1\u6709\u529e\u6cd5\u5728\u5173\u952e\u64cd\u4f5c\u4e2d\u7981\u7528\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002\u56e0\u6b64\uff0c\u5b9a\u65f6\u5668\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5fc5\u987b\u4ee5\u4fdd\u8bc1\u4e0d\u5e72\u6270\u88ab\u4e2d\u65ad\u7684\u5185\u6838\u4ee3\u7801\u7684\u65b9\u5f0f\u8fdb\u884c\u5de5\u4f5c\u3002\u57fa\u672c\u7b56\u7565\u662f\u5904\u7406\u7a0b\u5e8f\u8981\u6c42RISC-V\u5f15\u53d1\u4e00\u4e2a\u8f6f\u4ef6\u4e2d\u65ad\u5e76\u7acb\u5373\u8fd4\u56de\u3002RISC-V\u7528\u666e\u901a\u7684trap\u673a\u5236\u5c06\u8f6f\u4ef6\u4e2d\u65ad\u4f20\u9012\u7ed9\u5185\u6838\uff0c\u5e76\u5141\u8bb8\u5185\u6838\u7981\u7528\u5b83\u4eec\u3002\u5904\u7406\u5b9a\u65f6\u5668\u4e2d\u65ad\u4ea7\u751f\u7684\u8f6f\u4ef6\u4e2d\u65ad\u7684\u4ee3\u7801\u53ef\u4ee5\u5728**devintr**\uff08kernel/trap.c:204\uff09\u4e2d\u770b\u5230\u3002</p> <p>\u673a\u5668\u6a21\u5f0f\u7684\u5b9a\u65f6\u5668\u4e2d\u65ad\u5411\u91cf\u662f**timervec**(kernel/kernelvec.S:93)\u3002\u5b83\u5728**start**\u51c6\u5907\u7684\u6682\u5b58\u533a\u4fdd\u5b58\u4e00\u4e9b\u5bc4\u5b58\u5668\uff0c\u544a\u8bc9**CLINT**\u4f55\u65f6\u4ea7\u751f\u4e0b\u4e00\u4e2a\u5b9a\u65f6\u5668\u4e2d\u65ad\uff0c\u4f7fRISC-V\u4ea7\u751f\u4e00\u4e2a\u8f6f\u4ef6\u4e2d\u65ad\uff0c\u6062\u590d\u5bc4\u5b58\u5668\uff0c\u7136\u540e\u8fd4\u56de\u3002\u5728\u5b9a\u65f6\u5668\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4e2d\u6ca1\u6709C\u4ee3\u7801\u3002</p>"},{"location":"os/Chapter-5/#55-real-world","title":"5.5 Real world","text":"<p>Xv6\u5141\u8bb8\u5728\u5185\u6838\u548c\u7528\u6237\u7a0b\u5e8f\u6267\u884c\u65f6\u4f7f\u7528\u8bbe\u5907\u548c\u5b9a\u65f6\u5668\u4e2d\u65ad\u3002\u5b9a\u65f6\u5668\u4e2d\u65ad\u53ef\u4ee5\u5f3a\u5236\u4ece\u5b9a\u65f6\u5668\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u8fdb\u884c\u7ebf\u7a0b\u5207\u6362\uff08\u8c03\u7528**yield**\uff09\uff0c\u5373\u4f7f\u662f\u5728\u5185\u6838\u4e2d\u6267\u884c\u3002\u5982\u679c\u5185\u6838\u7ebf\u7a0b\u6709\u65f6\u4f1a\u82b1\u8d39\u5927\u91cf\u7684\u65f6\u95f4\u8fdb\u884c\u8ba1\u7b97\uff0c\u800c\u4e0d\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\uff0c\u90a3\u4e48\u5728\u5185\u6838\u7ebf\u7a0b\u4e4b\u95f4\u516c\u5e73\u5730\u5bf9CPU\u8fdb\u884c\u65f6\u95f4\u5212\u5206\u7684\u80fd\u529b\u662f\u5f88\u6709\u7528\u7684\u3002\u7136\u800c\uff0c\u5185\u6838\u4ee3\u7801\u9700\u8981\u6ce8\u610f\u5b83\u53ef\u80fd\u4f1a\u88ab\u6682\u505c\uff08\u7531\u4e8e\u5b9a\u65f6\u5668\u4e2d\u65ad\uff09\uff0c\u7136\u540e\u5728\u4e0d\u540c\u7684CPU\u4e0a\u6062\u590d\uff0c\u8fd9\u662fxv6\u4e2d\u4e00\u4e9b\u590d\u6742\u7684\u6839\u6e90\u3002\u5982\u679c\u8bbe\u5907\u548c\u5b9a\u65f6\u5668\u4e2d\u65ad\u53ea\u53d1\u751f\u5728\u6267\u884c\u7528\u6237\u4ee3\u7801\u65f6\uff0c\u5185\u6838\u53ef\u4ee5\u53d8\u5f97\u66f4\u7b80\u5355\u4e00\u4e9b\u3002</p> <p>\u5728\u4e00\u53f0\u5178\u578b\u7684\u8ba1\u7b97\u673a\u4e0a\u652f\u6301\u6240\u6709\u8bbe\u5907\u7684\u5168\u8c8c\u662f\u4e00\u4ef6\u5f88\u8f9b\u82e6\u7684\u4e8b\u60c5\uff0c\u56e0\u4e3a\u8bbe\u5907\u5f88\u591a\uff0c\u8bbe\u5907\u6709\u5f88\u591a\u529f\u80fd\uff0c\u8bbe\u5907\u548c\u9a71\u52a8\u7a0b\u5e8f\u4e4b\u95f4\u7684\u534f\u8bae\u53ef\u80fd\u5f88\u590d\u6742\uff0c\u800c\u4e14\u6587\u6863\u4e5f\u4e0d\u5b8c\u5584\u3002\u5728\u8bb8\u591a\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u9a71\u52a8\u7a0b\u5e8f\u6240\u5360\u7684\u4ee3\u7801\u6bd4\u6838\u5fc3\u5185\u6838\u8fd8\u591a\u3002</p> <p>UART\u9a71\u52a8\u5668\u901a\u8fc7\u8bfb\u53d6UART\u63a7\u5236\u5bc4\u5b58\u5668\uff0c\u4e00\u6b21\u8bfb\u53d6\u4e00\u4e2a\u5b57\u8282\u7684\u6570\u636e\uff1b\u8fd9\u79cd\u6a21\u5f0f\u88ab\u79f0\u4e3a\u7f16\u7a0bI/O\uff0c\u56e0\u4e3a\u8f6f\u4ef6\u5728\u63a7\u5236\u6570\u636e\u79fb\u52a8\u3002\u7a0b\u5e8f\u5316I/O\u7b80\u5355\uff0c\u4f46\u901f\u5ea6\u592a\u6162\uff0c\u65e0\u6cd5\u5728\u9ad8\u6570\u636e\u901f\u7387\u4e0b\u4f7f\u7528\u3002\u9700\u8981\u9ad8\u901f\u79fb\u52a8\u5927\u91cf\u6570\u636e\u7684\u8bbe\u5907\u901a\u5e38\u4f7f\u7528***\u76f4\u63a5\u5185\u5b58\u8bbf\u95ee(direct memory access, DMA)***\u3002DMA\u8bbe\u5907\u786c\u4ef6\u76f4\u63a5\u5c06\u4f20\u5165\u6570\u636e\u5199\u5165RAM\uff0c\u5e76\u4eceRAM\u4e2d\u8bfb\u53d6\u4f20\u51fa\u6570\u636e\u3002\u73b0\u4ee3\u78c1\u76d8\u548c\u7f51\u7edc\u8bbe\u5907\u90fd\u4f7f\u7528DMA\u3002DMA\u8bbe\u5907\u7684\u9a71\u52a8\u7a0b\u5e8f\u4f1a\u5728RAM\u4e2d\u51c6\u5907\u6570\u636e\uff0c\u7136\u540e\u4f7f\u7528\u5bf9\u63a7\u5236\u5bc4\u5b58\u5668\u7684\u4e00\u6b21\u5199\u5165\u6765\u544a\u8bc9\u8bbe\u5907\u5904\u7406\u51c6\u5907\u597d\u7684\u6570\u636e\u3002</p> <p>\u5f53\u8bbe\u5907\u5728\u4e0d\u53ef\u9884\u77e5\u7684\u65f6\u95f4\u9700\u8981\u5173\u6ce8,\u4e14\u4e0d\u90a3\u4e48\u9891\u7e41\u65f6\uff0c\u4e2d\u65ad\u662f\u5f88\u6709\u7528\u7684\u3002\u4f46\u4e2d\u65ad\u5bf9CPU\u7684\u5f00\u9500\u5f88\u5927\u3002\u56e0\u6b64\uff0c\u9ad8\u901f\u8bbe\u5907\uff0c\u5982\u7f51\u7edc\u548c\u78c1\u76d8\u63a7\u5236\u5668\uff0c\u4f7f\u7528\u4e86\u51cf\u5c11\u5bf9\u4e2d\u65ad\u9700\u6c42\u7684\u6280\u5de7\u3002\u5176\u4e2d\u4e00\u4e2a\u6280\u5de7\u662f\u5bf9\u6574\u6279\u4f20\u5165\u6216\u4f20\u51fa\u7684\u8bf7\u6c42\u63d0\u51fa\u4e00\u4e2a\u5355\u4e00\u7684\u4e2d\u65ad\u3002\u53e6\u4e00\u4e2a\u6280\u5de7\u662f\u8ba9\u9a71\u52a8\u7a0b\u5e8f\u5b8c\u5168\u7981\u7528\u4e2d\u65ad\uff0c\u5e76\u5b9a\u671f\u68c0\u67e5\u8bbe\u5907\u662f\u5426\u9700\u8981\u5173\u6ce8\u3002\u8fd9\u79cd\u6280\u672f\u79f0\u4e3a***\u8f6e\u8be2\uff08polling\uff09***\u3002\u5982\u679c\u8bbe\u5907\u6267\u884c\u64cd\u4f5c\u7684\u901f\u5ea6\u975e\u5e38\u5feb\uff0c\u8f6e\u8be2\u662f\u6709\u610f\u4e49\u7684\uff0c\u4f46\u5982\u679c\u8bbe\u5907\u5927\u90e8\u5206\u65f6\u95f4\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u5219\u4f1a\u6d6a\u8d39CPU\u65f6\u95f4\u3002\u4e00\u4e9b\u9a71\u52a8\u7a0b\u5e8f\u4f1a\u6839\u636e\u5f53\u524d\u8bbe\u5907\u7684\u8d1f\u8f7d\u60c5\u51b5\uff0c\u5728\u8f6e\u8be2\u548c\u4e2d\u65ad\u4e4b\u95f4\u52a8\u6001\u5207\u6362\u3002</p> <p>UART\u9a71\u52a8\u9996\u5148\u5c06\u8f93\u5165\u7684\u6570\u636e\u590d\u5236\u5230\u5185\u6838\u7684\u7f13\u51b2\u533a\uff0c\u7136\u540e\u518d\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4\u3002\u8fd9\u5728\u4f4e\u6570\u636e\u901f\u7387\u4e0b\u662f\u6709\u610f\u4e49\u7684\uff0c\u4f46\u5bf9\u4e8e\u90a3\u4e9b\u5feb\u901f\u751f\u6210\u6216\u6d88\u8017\u6570\u636e\u7684\u8bbe\u5907\u6765\u8bf4\uff0c\u8fd9\u6837\u7684\u53cc\u91cd\u62f7\u8d1d\u4f1a\u5927\u5927\u964d\u4f4e\u6027\u80fd\u3002\u4e00\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u76f4\u63a5\u5728\u7528\u6237\u7a7a\u95f4\u7f13\u51b2\u533a\u548c\u8bbe\u5907\u786c\u4ef6\u4e4b\u95f4\u79fb\u52a8\u6570\u636e\uff0c\u901a\u5e38\u4f7f\u7528DMA\u3002</p>"},{"location":"os/Chapter-5/#56-exercises","title":"5.6 Exercises","text":"<ol> <li> <p>\u4fee\u6539uart.c\uff0c\u4f7f\u5176\u5b8c\u5168\u4e0d\u4f7f\u7528\u4e2d\u65ad\u3002\u4f60\u53ef\u80fd\u8fd8\u9700\u8981\u4fee\u6539 console.c\u3002</p> </li> <li> <p>\u6dfb\u52a0\u4e00\u4e2a\u7f51\u5361\u9a71\u52a8\u3002</p> </li> </ol>"},{"location":"os/Chapter-6/","title":"Chapter 6","text":""},{"location":"os/Chapter-6/#_1","title":"\u7b2c\u516d\u7ae0\uff1a\u9501","text":"<p>\u5927\u591a\u6570\u5185\u6838\uff0c\u5305\u62ecxv6\uff0c\u90fd\u4f1a\u4ea4\u9519\u6267\u884c\u591a\u4e2a\u4efb\u52a1\u3002\u4e00\u79cd\u5b9e\u73b0\u4ea4\u9519\u6267\u884c\u4efb\u52a1\u7684\u65b9\u5f0f\u662f\u591a\u5904\u7406\u5668\u67b6\u6784\uff1a\u786c\u4ef6\u7cfb\u7edf\u5177\u6709\u591a\u4e2aCPU\u72ec\u7acb\u6267\u884c\uff0c\u5982xv6\u7684RISC-V\u3002\u8fd9\u4e9bCPU\u5171\u4eab\u7269\u7406RAM\uff0cxv6\u5229\u7528\u5171\u4eab\u6765\u7ef4\u62a4\u6240\u6709CPU\u8bfb\u5199\u7684\u6570\u636e\u7ed3\u6784\u3002\u8fd9\u79cd\u5171\u4eab\u5e26\u6765\u4e86\u4e00\u79cd\u53ef\u80fd\u6027\uff0c\u5373\u4e00\u4e2aCPU\u8bfb\u53d6\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\uff0c\u800c\u53e6\u4e00\u4e2aCPU\u6b63\u5728\u4e2d\u9014\u66f4\u65b0\u5b83\uff0c\u751a\u81f3\u591a\u4e2aCPU\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u4e2a\u6570\u636e\u3002\u5982\u679c\u4e0d\u4ed4\u7ec6\u8bbe\u8ba1\uff0c\u8fd9\u79cd\u5e76\u884c\u8bbf\u95ee\u5f88\u53ef\u80fd\u4ea7\u751f\u4e0d\u6b63\u786e\u7684\u7ed3\u679c\u6216\u7834\u574f\u6570\u636e\u7ed3\u6784\u3002\u5373\u4f7f\u5728\u5355\u5904\u7406\u5668\u4e0a\uff0c\u5185\u6838\u4e5f\u53ef\u80fd\u5728\u591a\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u5207\u6362CPU\uff0c\u5bfc\u81f4\u5b83\u4eec\u7684\u6267\u884c\u4ea4\u9519\u3002\u6700\u540e\uff0c\u5982\u679c\u4e2d\u65ad\u53d1\u751f\u7684\u65f6\u95f4\u4e0d\u5bf9\uff0c\u4e00\u4e2a\u8bbe\u5907\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u4fee\u6539\u4e0e\u4e00\u4e9b\u53ef\u4e2d\u65ad\u4ee3\u7801\u76f8\u540c\u7684\u6570\u636e\uff0c\u4ece\u800c\u7834\u574f\u6570\u636e\u3002\u5e76\u53d1\u4e00\u8bcd\u6307\u7684\u662f\u7531\u4e8e\u591a\u5904\u7406\u5668\u5e76\u884c\u3001\u7ebf\u7a0b\u5207\u6362\u6216\u4e2d\u65ad\u800c\u5bfc\u81f4\u591a\u4e2a\u6307\u4ee4\u6d41\u4ea4\u9519\u7684\u60c5\u51b5\u3002</p> <p>\u5185\u6838\u4e2d\u5145\u6ee1\u4e86\u5e76\u53d1\u8bbf\u95ee\u7684\u6570\u636e\u3002\u4f8b\u5982\uff0c\u4e24\u4e2aCPU\u53ef\u4ee5\u540c\u65f6\u8c03\u7528<code>kalloc</code>\uff0c\u4ece\u800c\u5e76\u53d1\u5730\u4ece\u7a7a\u95f2\u5185\u5b58\u94fe\u8868\u7684\u5934\u90e8push\u3002\u5185\u6838\u8bbe\u8ba1\u8005\u559c\u6b22\u5141\u8bb8\u5927\u91cf\u7684\u5e76\u53d1\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u901a\u8fc7\u5e76\u884c\u6765\u63d0\u9ad8\u6027\u80fd\uff0c\u63d0\u9ad8\u54cd\u5e94\u901f\u5ea6\u3002\u7136\u800c\uff0c\u7ed3\u679c\u662f\u5185\u6838\u8bbe\u8ba1\u8005\u82b1\u4e86\u5f88\u591a\u7cbe\u529b\u6765\u8ba9\u81ea\u5df1\u786e\u8ba4\u8fd9\u4e9b\u5b58\u5728\u7684\u5e76\u53d1\u662f\u6b63\u786e\u7684\u3002\u6709\u5f88\u591a\u65b9\u6cd5\u53ef\u4ee5\u5199\u51fa\u6b63\u786e\u7684\u4ee3\u7801\uff0c\u6709\u4e9b\u65b9\u6cd5\u6bd4\u5176\u4ed6\u65b9\u6cd5\u66f4\u7b80\u5355\u3002\u4ee5\u5e76\u53d1\u4e0b\u7684\u6b63\u786e\u6027\u4e3a\u76ee\u6807\u7684\u7b56\u7565\uff0c\u4ee5\u53ca\u652f\u6301\u8fd9\u4e9b\u7b56\u7565\u7684\u62bd\u8c61\uff0c\u88ab\u79f0\u4e3a\u5e76\u53d1\u63a7\u5236\u6280\u672f\u3002</p> <p>\u6839\u636e\u4e0d\u540c\u7684\u60c5\u51b5\uff0cxv6\u4f7f\u7528\u4e86\u5f88\u591a\u5e76\u53d1\u63a7\u5236\u6280\u672f\uff0c\u4e14\u8fd8\u6709\u66f4\u591a\u7684\u53ef\u80fd\u5c1a\u672a\u88ab\u5b9e\u73b0\u3002\u672c\u7ae0\u91cd\u70b9\u4ecb\u7ecd\u4e00\u79cd\u5e7f\u6cdb\u4f7f\u7528\u7684\u6280\u672f:\u9501\uff08lock\uff09\u3002\u9501\u63d0\u4f9b\u4e86\u4e92\u65a5\u7684\u529f\u80fd\uff0c\u786e\u4fdd\u4e00\u6b21\u53ea\u6709\u4e00\u4e2aCPU\u53ef\u4ee5\u6301\u6709\u4e00\u4e2a\u7279\u5b9a\u7684\u9501\u3002\u5982\u679c\u7a0b\u5e8f\u5458\u4e3a\u6bcf\u4e2a\u5171\u4eab\u6570\u636e\u9879\u5173\u8054\u4e00\u4e2a\u9501\uff0c\u5e76\u4e14\u4ee3\u7801\u5728\u4f7f\u7528\u67d0\u9879\u65f6\u603b\u662f\u6301\u6709\u5173\u8054\u7684\u9501\uff0c\u90a3\u4e48\u8be5\u9879\u6bcf\u6b21\u53ea\u80fd\u7531\u4e00\u4e2aCPU\u4f7f\u7528\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u8bf4\u9501\u4fdd\u62a4\u4e86\u6570\u636e\u9879\u3002\u867d\u7136\u9501\u662f\u4e00\u79cd\u7b80\u5355\u6613\u61c2\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u4f46\u5176\u4e5f\u5e26\u6765\u4e86\u6027\u80fd\u964d\u4f4e\u7684\u7f3a\u70b9\uff0c\u56e0\u4e3a\u9501\u5c06\u5e76\u53d1\u64cd\u4f5c\u4e32\u884c\u5316\u4e86\u3002</p> <p>\u672c\u7ae0\u7684\u5176\u4f59\u90e8\u5206\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48xv6\u9700\u8981\u9501\u3001xv6\u5982\u4f55\u5b9e\u73b0\u5b83\u4eec\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u4eec\u3002</p>"},{"location":"os/Chapter-6/#61","title":"6.1 \u7ade\u4e89\u6761\u4ef6","text":"<p>\u4f5c\u4e3a\u6211\u4eec\u4e3a\u4ec0\u4e48\u9700\u8981\u9501\u7684\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8003\u8651\u4e24\u4e2a\u8fdb\u7a0b\u5728\u4e24\u4e2a\u4e0d\u540c\u7684CPU\u4e0a\u8c03\u7528<code>wait</code>\uff0c<code>wait</code>\u91ca\u653e\u5b50\u8fdb\u7a0b\u7684\u5185\u5b58\u3002\u56e0\u6b64\uff0c\u5728\u6bcf\u4e2aCPU\u4e0a\uff0c\u5185\u6838\u90fd\u4f1a\u8c03\u7528<code>kfree</code>\u6765\u91ca\u653e\u5b50\u8fdb\u7a0b\u7684\u5185\u5b58\u9875\u3002\u5185\u6838\u5206\u914d\u5668\u7ef4\u62a4\u4e86\u4e00\u4e2a\u94fe\u8868:<code>kalloc()</code>(kernel/kalloc.c:69)\u4ece\u7a7a\u95f2\u9875\u94fe\u8868\u4e2dpop\u4e00\u9875\u5185\u5b58\uff0c<code>kfree()</code>(kernel/kalloc.c:47)\u5c06\u4e00\u9875push\u7a7a\u95f2\u94fe\u8868\u4e2d\u3002\u4e3a\u4e86\u8fbe\u5230\u6700\u597d\u7684\u6027\u80fd\uff0c\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u4e24\u4e2a\u7236\u8fdb\u7a0b\u7684<code>kfree</code>\u80fd\u591f\u5e76\u884c\u6267\u884c\uff0c\u800c\u4e0d\u9700\u8981\u4efb\u4f55\u4e00\u4e2a\u8fdb\u7a0b\u7b49\u5f85\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u4f46\u662f\u8003\u8651\u5230xv6\u7684<code>kfree</code>\u5b9e\u73b0\uff0c\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u3002</p> <p>\u56fe6.1\u66f4\u8be6\u7ec6\u5730\u8bf4\u660e\u4e86\u8fd9\u79cd\u8bbe\u7f6e\uff1a\u94fe\u8868\u5728\u4e24\u4e2aCPU\u5171\u4eab\u7684\u5185\u5b58\u4e2d\uff0cCPU\u4f7f\u7528\u52a0\u8f7d\u548c\u5b58\u50a8\u6307\u4ee4\u64cd\u4f5c\u94fe\u8868\u3002(\u5728\u73b0\u5b9e\u4e2d\uff0c\u5904\u7406\u5668\u6709\u7f13\u5b58\uff0c\u4f46\u5728\u6982\u5ff5\u4e0a\uff0c\u591a\u5904\u7406\u5668\u7cfb\u7edf\u7684\u884c\u4e3a\u5c31\u50cf\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u5171\u4eab\u5185\u5b58\u4e00\u6837)\u3002\u5982\u679c\u6ca1\u6709\u5e76\u53d1\u8bf7\u6c42\uff0c\u4f60\u53ef\u80fd\u4f1a\u5b9e\u73b0\u5982\u4e0b\u7684\u94fe\u8868push\u64cd\u4f5c:</p> C<pre><code>struct element{\n    int data;\n    struct element *next;\n};\n\nstruct element *list = 0;\n\nvoid\npush(int data)\n{\n    struct element *l;\n\n    l = malloc(sizeof *l);\n    l-&gt;data = data;\n    l-&gt;next = list;\n    list = l;\n}\n</code></pre> <p></p> <p>\u5982\u679c\u5355\u72ec\u6267\u884c\uff0c\u8fd9\u4e2a\u5b9e\u73b0\u662f\u6b63\u786e\u7684\u3002\u4f46\u662f\uff0c\u5982\u679c\u591a\u4e2a\u526f\u672c\u540c\u65f6\u6267\u884c\uff0c\u4ee3\u7801\u5c31\u4e0d\u6b63\u786e\u3002\u5982\u679c\u4e24\u4e2aCPU\u540c\u65f6\u6267\u884c<code>push</code>\uff0c\u90a3\u4e48\u4e24\u4e2aCPU\u53ef\u80fd\u90fd\u4f1a\u6267\u884c\u56fe6.1\u6240\u793a\u7684\u7b2c15\u884c\uff0c\u7136\u540e\u5176\u4e2d\u4e00\u4e2a\u624d\u6267\u884c\u7b2c16\u884c\uff0c\u8fd9\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e0d\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u5982\u56fe6.2\u6240\u793a\u3002\u8fd9\u6837\u5c31\u4f1a\u51fa\u73b0\u4e24\u4e2alist\u5143\u7d20\uff0c\u5c06next\u8bbe\u4e3alist\u7684\u524d\u503c\u3002\u5f53\u5bf9list\u7684\u4e24\u6b21\u8d4b\u503c\u53d1\u751f\u5728\u7b2c16\u884c\u65f6\uff0c\u7b2c\u4e8c\u6b21\u8d4b\u503c\u5c06\u8986\u76d6\u7b2c\u4e00\u6b21\u8d4b\u503c;\u7b2c\u4e00\u6b21\u8d4b\u503c\u4e2d\u6d89\u53ca\u7684\u5143\u7d20\u5c06\u4e22\u5931\u3002</p> <p>\u7b2c16\u884c\u7684\u4e22\u5931\u66f4\u65b0\u662f\u7ade\u4e89\u6761\u4ef6(race condition)\u7684\u4e00\u4e2a\u4f8b\u5b50\u3002\u7ade\u4e89\u6761\u4ef6\u662f\u6307\u540c\u65f6\u8bbf\u95ee\u4e00\u4e2a\u5185\u5b58\u4f4d\u7f6e\uff0c\u5e76\u4e14\u81f3\u5c11\u6709\u4e00\u6b21\u8bbf\u95ee\u662f\u5199\u7684\u60c5\u51b5\u3002\u7ade\u4e89\u901a\u5e38\u662f\u4e00\u4e2a\u9519\u8bef\u7684\u6807\u5fd7\uff0c\u8981\u4e48\u662f\u4e22\u5931\u66f4\u65b0(\u5982\u679c\u8bbf\u95ee\u662f\u5199)\uff0c\u8981\u4e48\u662f\u8bfb\u53d6\u4e00\u4e2a\u4e0d\u5b8c\u5168\u66f4\u65b0\u7684\u6570\u636e\u7ed3\u6784\u3002\u7ade\u4e89\u7684\u7ed3\u679c\u53d6\u51b3\u4e8e\u6240\u6d89\u53ca\u7684\u4e24\u4e2aCPU\u7684\u786e\u5207\u65f6\u95f4\uff0c\u4ee5\u53ca\u5b83\u4eec\u7684\u5185\u5b58\u64cd\u4f5c\u5982\u4f55\u88ab\u5185\u5b58\u7cfb\u7edf\u6392\u5e8f\uff0c\u8fd9\u53ef\u80fd\u4f1a\u4f7f\u7ade\u4e89\u5f15\u8d77\u7684\u9519\u8bef\u96be\u4ee5\u91cd\u73b0\u548c\u8c03\u8bd5\u3002\u4f8b\u5982\uff0c\u5728\u8c03\u8bd5<code>push</code>\u65f6\u52a0\u5165<code>print</code>\u8bed\u53e5\u53ef\u80fd\u4f1a\u6539\u53d8\u6267\u884c\u7684\u65f6\u673a\uff0c\u8db3\u4ee5\u4f7f\u7ade\u4e89\u6d88\u5931\u3002</p> <p>\u907f\u514d\u7ade\u4e89\u7684\u901a\u5e38\u65b9\u6cd5\u662f\u4f7f\u7528\u9501\u3002\u9501\u786e\u4fdd\u4e86\u76f8\u4e92\u6392\u65a5\uff0c\u56e0\u6b64\u4e00\u6b21\u53ea\u80fd\u6709\u4e00\u4e2aCPU\u6267\u884c<code>push</code>\u7684\u54ea\u4e00\u884c;\u8fd9\u5c31\u4f7f\u5f97\u4e0a\u9762\u7684\u60c5\u51b5\u4e0d\u53ef\u80fd\u53d1\u751f\u3002\u4e0a\u9762\u4ee3\u7801\u7684\u6b63\u786e<code>lock</code>\u7248\u672c\u53ea\u589e\u52a0\u4e86\u51e0\u884c\u4ee3\u7801\u3002</p> C<pre><code>struct element *list=0;\nstruct locklist lock;\n\nvoid\npush (int data)\n{\n    struct element *l;\n\n    l = malloc(sizeof *l);\n    l-&gt;data = data;\n    acquire(&amp;listlock);\n    l-&gt;next = list;\n    list = l;\n    release(&amp;listlock);\n}\n</code></pre> <p><code>acquire</code>\u548c<code>release</code>\u4e4b\u95f4\u7684\u6307\u4ee4\u5e8f\u5217\u901a\u5e38\u88ab\u79f0\u4e3a\u4e34\u754c\u533a\u3002\u8fd9\u91cc\u7684\u9501\u4fdd\u62a4<code>list</code>\u3002</p> <p>\u5f53\u6211\u4eec\u8bf4\u9501\u4fdd\u62a4\u6570\u636e\u65f6\uff0c\u6211\u4eec\u771f\u6b63\u7684\u610f\u601d\u662f**\u9501\u4fdd\u62a4\u4e86\u4e00\u4e9b\u9002\u7528\u4e8e\u6570\u636e\u7684\u4e0d\u53d8\u91cf(invariant)\u7684\u96c6\u5408**\u3002\u4e0d\u53d8\u91cf\u662f\u6570\u636e\u7ed3\u6784\u7684\u5c5e\u6027\uff0c\u8fd9\u4e9b\u5c5e\u6027\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u4e2d\u5f97\u5230\u7ef4\u62a4\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u64cd\u4f5c\u7684\u6b63\u786e\u884c\u4e3a\u53d6\u51b3\u4e8e\u64cd\u4f5c\u5f00\u59cb\u65f6\u7684\u4e0d\u53d8\u91cf\u662f\u5426\u4e3a\u771f\u3002\u64cd\u4f5c\u53ef\u80fd\u4f1a\u6682\u65f6\u8fdd\u53cd\u4e0d\u53d8\u91cf\uff0c\u4f46\u5728\u7ed3\u675f\u524d\u5fc5\u987b\u91cd\u65b0\u5efa\u7acb\u4e0d\u53d8\u91cf\u3002\u4f8b\u5982\uff0c\u5728\u94fe\u8868\u4e2d\uff0c\u4e0d\u53d8\u6027\u662f\uff1a\u201clist\u6307\u5411\u5217\u8868\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u5e76\u4e14\u6bcf\u4e2a\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u5b57\u6bb5\u6307\u5411\u4e0b\u4e00\u4e2a\u5143\u7d20\u201d\u3002push\u7684\u5b9e\u73b0\u6682\u65f6\u8fdd\u53cd\u4e86\u8fd9\u4e00\u4e0d\u53d8\u6027\uff1a\u5728\u7b2c17\u884c\uff0cl\u6307\u5411\u4e0b\u4e00\u4e2a\u94fe\u8868\u5143\u7d20list\uff0c\u4f46list\u8fd8\u6ca1\u6709\u6307\u5411l\uff08\u5728\u7b2c18\u884c\u91cd\u65b0\u5efa\u7acb\uff09\u3002\u6211\u4eec\u4e0a\u9762\u6240\u7814\u7a76\u7684\u7ade\u4e89\u6761\u4ef6\u4e4b\u6240\u4ee5\u4f1a\u53d1\u751f\uff0c\u662f\u56e0\u4e3a\u7b2c\u4e8c\u4e2aCPU\u6267\u884c\u4e86\u4f9d\u8d56\u4e8e\u5217\u8868\u4e0d\u53d8\u5f0f\u7684\u4ee3\u7801\uff0c\u800c\u5b83\u4eec\u88ab\uff08\u6682\u65f6\uff09\u8fdd\u53cd\u4e86\u3002\u6b63\u786e\u4f7f\u7528\u9501\u53ef\u4ee5\u786e\u4fdd\u6bcf\u6b21\u53ea\u6709\u4e00\u4e2aCPU\u53ef\u4ee5\u5bf9\u5173\u952e\u90e8\u5206\u7684\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u64cd\u4f5c\uff0c\u56e0\u6b64\u5f53\u6570\u636e\u7ed3\u6784\u7684\u4e0d\u53d8\u5f0f\u4e0d\u6210\u7acb\u65f6\uff0c\u6ca1\u6709CPU\u4f1a\u6267\u884c\u6570\u636e\u7ed3\u6784\u64cd\u4f5c\u3002</p> <p>\u4f60\u53ef\u4ee5\u628a\u9501\u770b\u6210\u662f\u628a\u5e76\u53d1\u7684\u5173\u952e\u90e8\u5206\u5e8f\u5217\u5316\uff0c\u4f7f\u5b83\u4eec\u4e00\u6b21\u53ea\u8fd0\u884c\u4e00\u4e2a\uff0c\u4ece\u800c\u4fdd\u5b58\u4e0d\u53d8\u6027\uff08\u5047\u8bbe\u5173\u952e\u90e8\u5206\u5b64\u7acb\u5730\u6b63\u786e\uff09\u3002\u4f60\u4e5f\u53ef\u4ee5\u8ba4\u4e3a\u7531\u540c\u4e00\u4e2a\u9501\u4fdd\u62a4\u7684\u5173\u952e\u90e8\u5206\u662f\u76f8\u4e92\u539f\u5b50\u7684(atomic)\uff0c\u56e0\u6b64\u6bcf\u4e2a\u5173\u952e\u90e8\u5206\u53ea\u770b\u5230\u6765\u81ea\u66f4\u65e9\u7684\u5173\u952e\u90e8\u5206\u7684\u5b8c\u6574\u53d8\u5316\uff0c\u800c\u6c38\u8fdc\u4e0d\u4f1a\u770b\u5230\u90e8\u5206\u5b8c\u6210\u7684\u66f4\u65b0\u3002</p> <p>\u867d\u7136\u6b63\u786e\u4f7f\u7528\u9501\u53ef\u4ee5\u4f7f\u4e0d\u6b63\u786e\u7684\u4ee3\u7801\u53d8\u5f97\u6b63\u786e\uff0c\u4f46\u9501\u9650\u5236\u4e86\u6027\u80fd\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e24\u4e2a\u8fdb\u7a0b\u540c\u65f6\u8c03\u7528kfree\uff0c\u9501\u4f1a\u5c06\u4e24\u4e2a\u8c03\u7528\u5e8f\u5217\u5316\uff0c\u6211\u4eec\u5728\u4e0d\u540c\u7684CPU\u4e0a\u8fd0\u884c\u5b83\u4eec\u4e0d\u4f1a\u83b7\u5f97\u4efb\u4f55\u597d\u5904\u3002\u6211\u4eec\u8bf4\uff0c\u5982\u679c\u591a\u4e2a\u8fdb\u7a0b\u540c\u65f6\u60f3\u8981\u540c\u4e00\u4e2a\u9501\uff0c\u5c31\u4f1a\u53d1\u751f\u51b2\u7a81\uff0c\u6216\u8005\u8bf4\u9501\u7ecf\u5386\u4e86\u4e89\u593a\u3002\u5185\u6838\u8bbe\u8ba1\u7684\u4e00\u4e2a\u4e3b\u8981\u6311\u6218\u662f\u907f\u514d\u9501\u7684\u4e89\u593a\u3002Xv6\u5728\u8fd9\u65b9\u9762\u505a\u5f97\u5f88\u5c11\uff0c\u4f46\u662f\u590d\u6742\u7684\u5185\u6838\u4f1a\u4e13\u95e8\u7ec4\u7ec7\u6570\u636e\u7ed3\u6784\u548c\u7b97\u6cd5\u6765\u907f\u514d\u9501\u4e89\u7528\u3002\u5728\u5217\u8868\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e00\u4e2a\u5185\u6838\u53ef\u80fd\u4f1a\u7ef4\u62a4\u6bcf\u4e2aCPU\u7684\u7a7a\u95f2\u5217\u8868\uff0c\u53ea\u6709\u5f53CPU\u7684\u5217\u8868\u662f\u7a7a\u7684\uff0c\u5e76\u4e14\u5b83\u5fc5\u987b\u4ece\u53e6\u4e00\u4e2aCPU\u5077\u53d6\u5185\u5b58\u65f6\uff0c\u624d\u4f1a\u63a5\u89e6\u53e6\u4e00\u4e2aCPU\u7684\u7a7a\u95f2\u5217\u8868\u3002\u5176\u4ed6\u7528\u4f8b\u53ef\u80fd\u9700\u8981\u66f4\u590d\u6742\u7684\u8bbe\u8ba1\u3002</p> <p>\u9501\u7684\u4f4d\u7f6e\u5bf9\u6027\u80fd\u4e5f\u5f88\u91cd\u8981\u3002\u4f8b\u5982\uff0c\u5728<code>push</code>\u4e2d\u628a<code>acquisition</code>\u79fb\u52a8\u5230\u8f83\u65e9\u7684\u4f4d\u7f6e\u4e5f\u662f\u6b63\u786e\u7684\uff1a\u5c06<code>acquisition</code>\u7684\u8c03\u7528\u79fb\u52a8\u5230\u7b2c13\u884c\u4e4b\u524d\u662f\u53ef\u4ee5\u7684\u3002\u7136\u800c\uff0c\u8fd9\u53ef\u80fd\u4f1a\u964d\u4f4e\u6027\u80fd\uff0c\u56e0\u4e3a\u8fd9\u6837\u7684\u8bdd\uff0c\u5bf9<code>malloc</code>\u7684\u8c03\u7528\u4e5f\u4f1a\u88ab\u5e8f\u5217\u5316\u3002\u4e0b\u9762\u7684\u201c\u4f7f\u7528\u9501\u201d\u4e00\u8282\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5173\u4e8e\u5728\u54ea\u91cc\u63d2\u5165<code>acquisition</code>\u548c<code>release</code>\u8c03\u7528\u7684\u6307\u5357\u3002</p>"},{"location":"os/Chapter-6/#62","title":"6.2 \u4ee3\u7801\uff1a\u9501","text":"<p>Xv6\u6709\u4e24\u79cd\u7c7b\u578b\u7684\u9501:\u81ea\u65cb\u9501(spinlock)\u548c\u7761\u7720\u9501(sleeplock)\u3002\u6211\u4eec\u5148\u8bf4\u8bf4\u81ea\u65cb\u9501\u3002Xv6\u5c06\u81ea\u65cb\u9501\u8868\u793a\u4e3a\u4e00\u4e2a\u7ed3\u6784\u4f53<code>spinlock</code>(kernel/spinlock.h:2)\u3002\u8be5\u7ed3\u6784\u4e2d\u91cd\u8981\u7684\u5b57\u6bb5\u662f<code>locked</code>\uff0c\u5f53\u9501\u53ef\u83b7\u5f97\u65f6\uff0c<code>locked</code>\u4e3a\u96f6\uff0c\u5f53\u9501\u88ab\u6301\u6709\u65f6\uff0c<code>locked</code>\u4e3a\u975e\u96f6\u3002\u4ece\u903b\u8f91\u4e0a\u8bb2\uff0cxv6\u83b7\u53d6\u9501\u7684\u7684\u4ee3\u7801\u7c7b\u4f3c\u4e8e:</p> C<pre><code>void\nacquire(struct spinlock *lk)//doesnotwork!\n{\n    for(;;){\n        if(lk-&gt;locked == 0){\n            lk-&gt;locked = 1;\n            break;\n        }\n    }\n}\n</code></pre> <p>\u4e0d\u5e78\u7684\u662f\uff0c\u8fd9\u79cd\u5b9e\u73b0\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u591a\u5904\u7406\u5668\u4e0a\u7684\u76f8\u4e92\u6392\u65a5\u3002\u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u6837\u7684\u60c5\u51b5:\u4e24\u4e2aCPU\u540c\u65f6\u5230\u8fbeif\u8bed\u53e5\uff0c\u770b\u5230<code>lk-&gt;locked</code>\u4e3a\u96f6\uff0c\u7136\u540e\u90fd\u901a\u8fc7\u8bbe\u7f6e<code>lk-&gt;locked=1</code>\u6765\u62a2\u593a\u9501\u3002\u6b64\u65f6\uff0c\u4e24\u4e2a\u4e0d\u540c\u7684CPU\u6301\u6709\u9501\uff0c\u8fd9\u5c31\u8fdd\u53cd\u4e86\u4e92\u65a5\u5c5e\u6027\u3002\u6211\u4eec\u9700\u8981\u7684\u662f\u8ba9\u7b2c25\u884c\u548c\u7b2c26\u884c\u4f5c\u4e3a\u4e00\u4e2a\u539f\u5b50(\u5373\u4e0d\u53ef\u5206\u5272)\u6b65\u9aa4\u6765\u6267\u884c\u3002</p> <p>\u7531\u4e8e\u9501\u88ab\u5e7f\u6cdb\u4f7f\u7528\uff0c\u591a\u6838\u5904\u7406\u5668\u901a\u5e38\u63d0\u4f9b\u4e86\u4e00\u4e9b\u539f\u5b50\u7248\u7684\u6307\u4ee4\u3002\u5728RISC-V\u4e0a\uff0c\u8fd9\u6761\u6307\u4ee4\u662f<code>amoswapr,a</code>\u3002<code>amoswap</code>\u8bfb\u53d6\u5185\u5b58\u5730\u5740<code>a</code>\u5904\u7684\u503c\uff0c\u5c06\u5bc4\u5b58\u5668<code>r</code>\u7684\u5185\u5bb9\u5199\u5165\u8be5\u5730\u5740\uff0c\u5e76\u5c06\u5176\u8bfb\u53d6\u7684\u503c\u653e\u5165<code>r</code>\u4e2d\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b83\u5c06\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u548c\u5185\u5b58\u5730\u5740\u8fdb\u884c\u4e86\u4ea4\u6362\u3002\u5b83\u539f\u5b50\u5730\u6267\u884c\u8fd9\u4e2a\u5e8f\u5217\uff0c\u4f7f\u7528\u7279\u6b8a\u7684\u786c\u4ef6\u6765\u9632\u6b62\u4efb\u4f55\u5176\u4ed6CPU\u4f7f\u7528\u8bfb\u548c\u5199\u4e4b\u95f4\u7684\u5185\u5b58\u5730\u5740\u3002</p> <p>Xv6\u7684<code>acquire</code>(kernel/spinlock.c:22\u4f7f\u7528\u4e86\u53ef\u79fb\u690d\u7684C\u5e93\u8c03\u7528<code>__sync_lock_test_and_set</code>\uff0c\u5b83\u672c\u8d28\u4e0a\u4e3a<code>amoswap</code>\u6307\u4ee4;\u8fd4\u56de\u503c\u662f<code>lk-&gt;locked</code>\u7684\u65e7(\u88ab\u4ea4\u6362\u51fa\u6765\u7684)\u5185\u5bb9\u3002<code>acquire</code>\u51fd\u6570\u5faa\u73af\u4ea4\u6362\uff0c\u91cd\u8bd5(\u65cb\u8f6c)\u76f4\u5230\u83b7\u53d6\u4e86\u9501\u3002\u6bcf\u4e00\u6b21\u8fed\u4ee3\u90fd\u4f1a\u5c061\u4ea4\u6362\u5230<code>lk-&gt;locked</code>\u4e2d\uff0c\u5e76\u68c0\u67e5\u4e4b\u524d\u7684\u503c;\u5982\u679c\u4e4b\u524d\u7684\u503c\u4e3a0\uff0c\u90a3\u4e48\u6211\u4eec\u5df2\u7ecf\u83b7\u5f97\u4e86\u9501\uff0c\u5e76\u4e14\u4ea4\u6362\u5c06<code>lk-&gt;locked</code>\u8bbe\u7f6e\u4e3a1\u3002\u5982\u679c\u4e4b\u524d\u7684\u503c\u662f1\uff0c\u90a3\u4e48\u5176\u4ed6CPU\u6301\u6709\u8be5\u9501\uff0c\u800c\u6211\u4eec\u539f\u5b50\u5730\u5c061\u6362\u6210<code>lk-&gt;locked</code>\u5e76\u6ca1\u6709\u6539\u53d8\u5b83\u7684\u503c\u3002</p> <p>\u4e00\u65e6\u9501\u88ab\u83b7\u53d6\uff0c<code>acquire</code>\u5c31\u4f1a\u8bb0\u5f55\u83b7\u53d6\u8be5\u9501\u7684CPU\uff0c\u8fd9\u65b9\u4fbf\u8c03\u8bd5\u3002<code>lk-&gt;cpu</code>\u5b57\u6bb5\u53d7\u5230\u9501\u7684\u4fdd\u62a4\uff0c\u53ea\u6709\u5728\u6301\u6709\u9501\u7684\u65f6\u5019\u624d\u80fd\u6539\u53d8\u3002</p> <p>\u51fd\u6570<code>release</code>(kernel/spinlock.c:47)\u4e0e<code>acquire</code>\u76f8\u53cd:\u5b83\u6e05\u9664<code>lk-&gt;cpu</code>\u5b57\u6bb5\uff0c\u7136\u540e\u91ca\u653e\u9501\u3002\u4ece\u6982\u5ff5\u4e0a\u8bb2\uff0c\u91ca\u653e\u53ea\u9700\u8981\u7ed9<code>lk-&gt;locked</code>\u8d4b\u503c\u4e3a0\u3002C\u6807\u51c6\u5141\u8bb8\u7f16\u8bd1\u5668\u7528\u591a\u6761\u5b58\u50a8\u6307\u4ee4\u6765\u5b9e\u73b0\u8d4b\u503c\uff0c\u6240\u4ee5C\u8d4b\u503c\u5bf9\u4e8e\u5e76\u53d1\u4ee3\u7801\u6765\u8bf4\u53ef\u80fd\u662f\u975e\u539f\u5b50\u6027\u7684\u3002\u76f8\u53cd\uff0c<code>release</code>\u4f7f\u7528C\u5e93\u51fd\u6570<code>__sync_lock_release</code>\u6267\u884c\u539f\u5b50\u8d4b\u503c\u3002\u8fd9\u4e2a\u51fd\u6570\u4e5f\u662f\u4f7f\u7528\u4e86RISC-V\u7684<code>amoswap</code>\u6307\u4ee4\u3002</p>"},{"location":"os/Chapter-6/#63","title":"6.3 \u4ee3\u7801\uff1a\u4f7f\u7528\u9501","text":"<p>Xv6\u5728\u5f88\u591a\u5730\u65b9\u4f7f\u7528\u9501\u6765\u907f\u514d\u7ade\u8d5b\u6761\u4ef6\u3002\u5982\u4e0a\u6240\u8ff0\uff0c<code>kalloc</code>(kernel/kalloc.c:69)\u548c<code>kfree</code>(kernel/kalloc.c:47)\u5c31\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u3002\u8bd5\u7740\u7ec3\u4e601\u548c2\u770b\u770b\u5982\u679c\u8fd9\u4e9b\u51fd\u6570\u7701\u7565\u4e86\u9501\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\u3002\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u5f88\u96be\u89e6\u53d1\u4e0d\u6b63\u786e\u7684\u884c\u4e3a\uff0c\u8fd9\u8bf4\u660e\u5f88\u96be\u53ef\u9760\u5730\u6d4b\u8bd5\u4ee3\u7801\u662f\u5426\u6ca1\u6709\u9501\u5b9a\u9519\u8bef\u548c\u7ade\u4e89\u3002xv6\u6709\u4e00\u4e9b\u7ade\u4e89\u4e5f\u4e0d\u662f\u4e0d\u53ef\u80fd\u7684\u3002</p> <p>\u4f7f\u7528\u9501\u7684\u4e00\u4e2a\u96be\u70b9\u662f\u51b3\u5b9a\u4f7f\u7528\u591a\u5c11\u4e2a\u9501\uff0c\u4ee5\u53ca\u6bcf\u4e2a\u9501\u5e94\u8be5\u4fdd\u62a4\u54ea\u4e9b\u6570\u636e\u548c\u4e0d\u53d8\u91cf\u3002\u6709\u51e0\u4e2a\u57fa\u672c\u539f\u5219\u3002\u9996\u5148\uff0c\u4efb\u4f55\u65f6\u5019\uff0c\u5f53\u4e00\u4e2aCPU\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2aCPU\u8bfb\u6216\u5199\u53d8\u91cf\u7684\u540c\u65f6\u5199\u5165\u53d8\u91cf\u65f6\uff0c\u90fd\u5e94\u8be5\u4f7f\u7528\u9501\u6765\u9632\u6b62\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u91cd\u53e0\u3002\u7b2c\u4e8c\uff0c\u8bb0\u4f4f\u9501\u4fdd\u62a4\u4e0d\u53d8\u91cf\uff1a\u5982\u679c\u4e00\u4e2a\u4e0d\u53d8\u91cf\u6d89\u53ca\u591a\u4e2a\u5185\u5b58\u4f4d\u7f6e\uff0c\u901a\u5e38\u9700\u8981\u7528\u4e00\u4e2a\u9501\u4fdd\u62a4\u6240\u6709\u7684\u4f4d\u7f6e\uff0c\u4ee5\u786e\u4fdd\u4e0d\u53d8\u5f0f\u5f97\u5230\u7ef4\u62a4\u3002</p> <p>\u4e0a\u9762\u7684\u89c4\u5219\u8bf4\u4e86\u4ec0\u4e48\u65f6\u5019\u9700\u8981\u9501\uff0c\u4f46\u6ca1\u6709\u8bf4\u4ec0\u4e48\u65f6\u5019\u4e0d\u9700\u8981\u9501\uff0c\u4e3a\u4e86\u6548\u7387\uff0c\u4e0d\u8981\u9501\u592a\u591a\uff0c\u56e0\u4e3a\u9501\u4f1a\u964d\u4f4e\u5e76\u884c\u6027\u3002\u5982\u679c\u5e76\u884c\u6027\u4e0d\u91cd\u8981\uff0c\u90a3\u4e48\u53ef\u4ee5\u5b89\u6392\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u800c\u4e0d\u7528\u62c5\u5fc3\u9501\u7684\u95ee\u9898\u3002\u4e00\u4e2a\u7b80\u5355\u7684\u5185\u6838\u53ef\u4ee5\u5728\u591a\u5904\u7406\u5668\u4e0a\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u5b83\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u9501\uff0c\u8fd9\u4e2a\u9501\u5fc5\u987b\u5728\u8fdb\u5165\u5185\u6838\u65f6\u83b7\u5f97\uff0c\u5e76\u5728\u9000\u51fa\u5185\u6838\u65f6\u91ca\u653e\uff08\u5c3d\u7ba1\u7cfb\u7edf\u8c03\u7528\uff0c\u5982\u7ba1\u9053\u8bfb\u53d6\u6216\u7b49\u5f85\u4f1a\u5e26\u6765\u4e00\u4e2a\u95ee\u9898\uff09\u3002\u8bb8\u591a\u5355\u5904\u7406\u5668\u64cd\u4f5c\u7cfb\u7edf\u5df2\u7ecf\u88ab\u6539\u9020\u6210\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u5728\u591a\u5904\u7406\u5668\u4e0a\u8fd0\u884c\uff0c\u6709\u65f6\u88ab\u79f0\u4e3a\"\u5927\u5185\u6838\u9501\"\uff0c\u4f46\u8fd9\u79cd\u65b9\u6cd5\u727a\u7272\u4e86\u5e76\u884c\u6027\uff1a\u5185\u6838\u4e2d\u4e00\u6b21\u53ea\u80fd\u6267\u884c\u4e00\u4e2aCPU\u3002\u5982\u679c\u5185\u6838\u505a\u4efb\u4f55\u7e41\u91cd\u7684\u8ba1\u7b97\uff0c\u90a3\u4e48\u4f7f\u7528\u4e00\u7ec4\u66f4\u5927\u7684\u66f4\u7ec6\u7c92\u5ea6\u7684\u9501\uff0c\u8fd9\u6837\u5185\u6838\u53ef\u4ee5\u540c\u65f6\u5728\u591a\u4e2aCPU\u4e0a\u6267\u884c\uff0c\u6548\u7387\u4f1a\u66f4\u9ad8\u3002</p> <p>\u4f5c\u4e3a\u7c97\u7c92\u5ea6\u9501\u7684\u4e00\u4e2a\u4f8b\u5b50\uff0cxv6\u7684kalloc.c\u5206\u914d\u5668\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u7a7a\u95f2\u5217\u8868\uff0c\u7531\u4e00\u4e2a\u5355\u4e00\u7684\u9501\u6784\u6210\u3002\u5982\u679c\u4e0d\u540cCPU\u4e0a\u7684\u591a\u4e2a\u8fdb\u7a0b\u8bd5\u56fe\u540c\u65f6\u5206\u914d\u9875\u9762\uff0c\u90a3\u4e48\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u5fc5\u987b\u901a\u8fc7\u5728<code>acquire</code>\u4e2d\u65cb\u8f6c\u6765\u7b49\u5f85\u8f6e\u5230\u81ea\u5df1\u3002\u65cb\u8f6c\u4f1a\u964d\u4f4e\u6027\u80fd\uff0c\u56e0\u4e3a\u8fd9\u4e0d\u662f\u6709\u7528\u7684\u5de5\u4f5c\u3002\u5982\u679c\u4e89\u593a\u9501\u6d6a\u8d39\u4e86\u76f8\u5f53\u4e00\u90e8\u5206CPU\u65f6\u95f4\uff0c\u4e5f\u8bb8\u53ef\u4ee5\u901a\u8fc7\u6539\u53d8\u5206\u914d\u5668\u7684\u8bbe\u8ba1\u6765\u63d0\u9ad8\u6027\u80fd\uff0c\u4f7f\u5176\u62e5\u6709\u591a\u4e2a\u7a7a\u95f2\u5217\u8868\uff0c\u6bcf\u4e2a\u5217\u8868\u90fd\u6709\u81ea\u5df1\u7684\u9501\uff0c\u4ece\u800c\u5b9e\u73b0\u771f\u6b63\u7684\u5e76\u884c\u5206\u914d\u3002\uff08\u8be5\u5206\u914d\u5668\u5728lockinglab\u4e2d\u4f1a\u88ab\u91cd\u5199\u2014\u2014\u8bd1\u8005\u6ce8\uff09</p> <p>\u4f5c\u4e3a\u7ec6\u7c92\u5ea6\u9501\u7684\u4e00\u4e2a\u4f8b\u5b50\uff0cxv6\u4e3a\u6bcf\u4e2a\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u9501\uff0c\u8fd9\u6837\u64cd\u4f5c\u4e0d\u540c\u6587\u4ef6\u7684\u8fdb\u7a0b\u5f80\u5f80\u53ef\u4ee5\u4e0d\u7528\u7b49\u5f85\u5bf9\u65b9\u7684\u9501\u5c31\u53ef\u4ee5\u8fdb\u884c\u3002\u5982\u679c\u60f3\u8ba9\u8fdb\u7a0b\u6a21\u62df\u5199\u5165\u540c\u4e00\u6587\u4ef6\u7684\u4e0d\u540c\u533a\u57df\uff0c\u6587\u4ef6\u9501\u65b9\u6848\u53ef\u4ee5\u505a\u5f97\u66f4\u7ec6\u3002\u6700\u7ec8\uff0c\u9501\u7684\u7c92\u5ea6\u51b3\u5b9a\u9700\u8981\u7531\u6027\u80fd\u6d4b\u91cf\u4ee5\u53ca\u590d\u6742\u6027\u8003\u8651\u6765\u9a71\u52a8\u3002 \u5728\u540e\u7eed\u7684\u7ae0\u8282\u89e3\u91caxv6\u7684\u6bcf\u4e2a\u90e8\u5206\u65f6\uff0c\u4f1a\u63d0\u5230xv6\u4f7f\u7528\u9501\u6765\u5904\u7406\u5e76\u53d1\u6027\u7684\u4f8b\u5b50\u3002\u4f5c\u4e3a\u9884\u89c8\uff0c\u56fe6.3\u5217\u51fa\u4e86xv6\u4e2d\u6240\u6709\u7684\u9501\u3002</p> <p></p>"},{"location":"os/Chapter-6/#64","title":"6.4 \u6b7b\u9501\u548c\u9501\u7684\u987a\u5e8f","text":"<p>\u5982\u679c\u4e00\u4e2a\u7a7f\u8fc7\u5185\u6838\u7684\u4ee3\u7801\u8def\u5f84\u5fc5\u987b\u540c\u65f6\u6301\u6709\u591a\u4e2a\u9501\uff0c\u90a3\u4e48\u6240\u6709\u7684\u4ee3\u7801\u8def\u5f84\u4ee5\u76f8\u540c\u7684\u987a\u5e8f\u83b7\u53d6\u8fd9\u4e9b\u9501\u662f\u5f88\u91cd\u8981\u7684\u3002\u5982\u679c\u4ed6\u4eec\u4e0d\u8fd9\u6837\u505a\uff0c\u5c31\u4f1a\u6709\u6b7b\u9501\u7684\u98ce\u9669\u3002\u5047\u8bbe\u7ebf\u7a0bT1\u6267\u884c\u4ee3\u7801path1\u5e76\u83b7\u53d6\u9501A\uff0c\u7ebf\u7a0bT2\u6267\u884c\u4ee3\u7801path2\u5e76\u83b7\u53d6\u9501B\uff0c\u63a5\u4e0b\u6765T1\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u9501B\uff0cT2\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u9501A\uff0c\u8fd9\u4e24\u6b21\u83b7\u53d6\u90fd\u4f1a\u65e0\u9650\u671f\u5730\u963b\u585e\uff0c\u56e0\u4e3a\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u90fd\u6301\u6709\u6240\u9700\u7684\u9501\uff0c\u5e76\u4e14\u4e0d\u4f1a\u91ca\u653e\u5b83\uff0c\u76f4\u5230\u5b83\u7684\u83b7\u53d6\u8fd4\u56de\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u6837\u7684\u6b7b\u9501\uff0c\u6240\u6709\u7684\u4ee3\u7801\u8def\u5f84\u5fc5\u987b\u4ee5\u76f8\u540c\u7684\u987a\u5e8f\u83b7\u53d6\u9501\u3002\u5bf9\u5168\u5c40\u9501\u83b7\u53d6\u987a\u5e8f\u7684\u9700\u6c42\u610f\u5473\u7740\u9501\u5b9e\u9645\u4e0a\u662f\u6bcf\u4e2a\u51fd\u6570\u89c4\u8303\u7684\u4e00\u90e8\u5206:\u8c03\u7528\u8005\u8c03\u7528\u51fd\u6570\u7684\u65b9\u5f0f\u5fc5\u987b\u4f7f\u9501\u6309\u7167\u7ea6\u5b9a\u7684\u987a\u5e8f\u88ab\u83b7\u53d6\u3002</p> <p>\u7531\u4e8esleep\u7684\u5de5\u4f5c\u65b9\u5f0f(\u89c1\u7b2c7\u7ae0)\uff0cxv6\u6709\u8bb8\u591a\u957f\u5ea6\u4e3a2\u7684\u9501\u5e8f\u94fe\uff0c\u6d89\u53ca\u5230\u8fdb\u7a0b\u9501(<code>structproc</code>\u4e2d\u7684\u9501)\u3002\u4f8b\u5982\uff0c<code>consoleintr</code>(kernel/console.c:138)\u662f\u5904\u7406\u683c\u5f0f\u5316\u5b57\u7b26\u7684\u4e2d\u65ad\u6d41\u7a0b\u3002\u5f53\u4e00\u4e2a\u65b0\u6570\u636e\u5230\u8fbe\u65f6\uff0c\u4efb\u4f55\u6b63\u5728\u7b49\u5f85\u63a7\u5236\u53f0\uff08\u7ec8\u7aef\uff0c\u5373cmd\uff09\u8f93\u5165\u7684\u8fdb\u7a0b\u90fd\u5e94\u8be5\u88ab\u5524\u9192\u3002\u4e3a\u6b64\uff0c<code>consoleintr</code>\u5728\u8c03\u7528<code>wakeup</code>\u65f6\u6301\u6709<code>cons.lock</code>\uff0c\u4ee5\u83b7\u53d6\u8fdb\u7a0b\u9501\u6765\u5524\u9192\u5b83\u3002\u56e0\u6b64\uff0c\u5168\u5c40\u907f\u514d\u6b7b\u9501\u7684\u9501\u987a\u5e8f\u5305\u62ec\u4e86<code>cons.lock</code>\u5fc5\u987b\u5728\u4efb\u4f55\u8fdb\u7a0b\u9501\u4e4b\u524d\u83b7\u53d6\u7684\u89c4\u5219\u3002\u6587\u4ef6\u7cfb\u7edf\u4ee3\u7801\u5305\u542bxv6\u6700\u957f\u7684\u9501\u94fe\u3002\u4f8b\u5982\uff0c\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u9700\u8981\u540c\u65f6\u6301\u6709\u76ee\u5f55\u7684\u9501\u3001\u65b0\u6587\u4ef6\u7684inode\u7684\u9501\u3001\u78c1\u76d8\u5757\u7f13\u51b2\u533a\u7684\u9501\u3001\u78c1\u76d8\u9a71\u52a8\u5668\u7684<code>vdisk_lock</code>\u548c\u8c03\u7528\u8fdb\u7a0b\u7684<code>p-&gt;lock</code>\u3002\u4e3a\u4e86\u907f\u514d\u6b7b\u9501\uff0c\u6587\u4ef6\u7cfb\u7edf\u4ee3\u7801\u603b\u662f\u6309\u7167\u4e0a\u4e00\u53e5\u63d0\u5230\u7684\u987a\u5e8f\u83b7\u53d6\u9501\u3002</p> <p>\u9075\u5b88\u5168\u5c40\u907f\u514d\u6b7b\u9501\u7684\u987a\u5e8f\u53ef\u80fd\u4f1a\u975e\u5e38\u56f0\u96be\u3002\u6709\u65f6\u9501\u7684\u987a\u5e8f\u4e0e\u903b\u8f91\u7a0b\u5e8f\u7ed3\u6784\u76f8\u51b2\u7a81\uff0c\u4f8b\u5982\uff0c\u4e5f\u8bb8\u4ee3\u7801\u6a21\u5757M1\u8c03\u7528\u6a21\u5757M2\uff0c\u4f46\u9501\u7684\u987a\u5e8f\u8981\u6c42M2\u4e2d\u7684\u9501\u5728M1\u4e2d\u7684\u9501\u4e4b\u524d\u88ab\u83b7\u53d6\u3002\u6709\u65f6\u9501\u7684\u8eab\u4efd\u5e76\u4e0d\u662f\u4e8b\u5148\u77e5\u9053\u7684\uff0c\u4e5f\u8bb8\u662f\u56e0\u4e3a\u5fc5\u987b\u6301\u6709\u4e00\u4e2a\u9501\u624d\u80fd\u53d1\u73b0\u63a5\u4e0b\u6765\u8981\u83b7\u53d6\u7684\u9501\u7684\u8eab\u4efd\u3002\u8fd9\u79cd\u60c5\u51b5\u51fa\u73b0\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u56e0\u4e3a\u5b83\u5728\u8def\u5f84\u540d\u4e2d\u67e5\u627e\u8fde\u7eed\u7684\u7ec4\u4ef6\uff0c\u4e5f\u51fa\u73b0\u5728<code>wait</code>\u548c<code>exit</code>\u7684\u4ee3\u7801\u4e2d\uff0c\u56e0\u4e3a\u5b83\u4eec\u641c\u7d22\u8fdb\u7a0b\u8868\u5bfb\u627e\u5b50\u8fdb\u7a0b\u3002\u6700\u540e\uff0c\u6b7b\u9501\u7684\u5371\u9669\u5f80\u5f80\u5236\u7ea6\u7740\u4eba\u4eec\u5bf9\u9501\u65b9\u6848\u7684\u7ec6\u5316\u7a0b\u5ea6\uff0c\u56e0\u4e3a\u66f4\u591a\u7684\u9501\u5f80\u5f80\u610f\u5473\u7740\u66f4\u591a\u7684\u6b7b\u9501\u673a\u4f1a\u3002\u907f\u514d\u6b7b\u9501\u662f\u5185\u6838\u5b9e\u73b0\u7684\u91cd\u8981\u9700\u6c42\u3002</p>"},{"location":"os/Chapter-6/#65","title":"6.5 \u9501\u4e0e\u4e2d\u65ad\u5904\u7406","text":"<p>\u4e00\u4e9bxv6\u81ea\u65cb\u9501\u4fdd\u62a4\u7684\u6570\u636e\u4f1a\u88ab\u7ebf\u7a0b\u548c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4e24\u8005\u4f7f\u7528\u3002\u4f8b\u5982\uff0c<code>clockintr</code>\u5b9a\u65f6\u5668\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u5728\u5185\u6838\u7ebf\u7a0b\u8bfb\u53d6<code>sys_sleep</code>(kernel/sysproc.c:64)\u4e2d\u7684<code>ticks</code>\u7684\u540c\u65f6\uff0c\u9012\u589e<code>ticks</code>(kernel/trap.c:163)\u3002\u9501<code>tickslock</code>\u5c06\u4fdd\u62a4\u4e24\u6b21\u4e34\u754c\u533a\u3002</p> <p>\u81ea\u65cb\u9501\u548c\u4e2d\u65ad\u7684\u76f8\u4e92\u4f5c\u7528\u5e26\u6765\u4e86\u4e00\u4e2a\u6f5c\u5728\u7684\u5371\u9669\u3002\u5047\u8bbe<code>sys_sleep</code>\u6301\u6709<code>tickslock</code>\uff0c\u800c\u5b83\u7684CPU\u63a5\u6536\u5230\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u3002<code>clockintr</code>\u4f1a\u5c1d\u8bd5\u83b7\u53d6<code>tickslock</code>\uff0c\u770b\u5230\u5b83\u88ab\u6301\u6709\uff0c\u5e76\u7b49\u5f85\u5b83\u88ab\u91ca\u653e\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c<code>tickslock</code>\u6c38\u8fdc\u4e0d\u4f1a\u88ab\u91ca\u653e\uff1a\u53ea\u6709<code>sys_sleep</code>\u53ef\u4ee5\u91ca\u653e\u5b83\uff0c\u4f46<code>sys_sleep</code>\u4e0d\u4f1a\u7ee7\u7eed\u8fd0\u884c\uff0c\u76f4\u5230<code>clockintr</code>\u8fd4\u56de\u3002\u6240\u4ee5CPU\u4f1a\u6b7b\u9501\uff0c\u4efb\u4f55\u9700\u8981\u5176\u4ed6\u9501\u7684\u4ee3\u7801\u4e5f\u4f1a\u51bb\u7ed3\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u5982\u679c\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4f7f\u7528\u4e86\u81ea\u65cb\u9501\uff0cCPU\u51b3\u4e0d\u80fd\u5728\u542f\u7528\u4e2d\u65ad\u7684\u60c5\u51b5\u4e0b\u6301\u6709\u8be5\u9501\u3002Xv6\u5219\u91c7\u7528\u4e86\u66f4\u52a0\u4fdd\u5b88\u7684\u7b56\u7565\uff1a\u5f53\u4e00\u4e2aCPU\u83b7\u53d6\u4efb\u4f55\u9501\u65f6\uff0cxv6\u603b\u662f\u7981\u7528\u8be5CPU\u4e0a\u7684\u4e2d\u65ad\u3002\u4e2d\u65ad\u4ecd\u7136\u53ef\u80fd\u53d1\u751f\u5728\u5176\u4ed6CPU\u4e0a\uff0c\u6240\u4ee5\u4e00\u4e2a\u4e2d\u65ad\u7a0b\u5e8f\u83b7\u53d6\u9501\u4f1a\u7b49\u5f85\u4e00\u4e2a\u7ebf\u7a0b\u91ca\u653e\u81ea\u65cb\u9501\uff0c\u4f46\u5b83\u4eec\u4e0d\u5728\u540c\u4e00\u4e2aCPU\u4e0a\u3002</p> <p>xv6\u5728CPU\u6ca1\u6709\u6301\u6709\u81ea\u65cb\u9501\u65f6\u91cd\u65b0\u542f\u7528\u4e2d\u65ad;\u5b83\u5fc5\u987b\u505a\u4e00\u70b9\u8bb0\u5f55\u6765\u5e94\u5bf9\u5d4c\u5957\u7684\u4e34\u754c\u533a\u3002<code>acquire</code>\u8c03\u7528<code>push_off</code>(kernel/spinlock.c:89)\u548c<code>release</code>\u8c03\u7528<code>pop_off</code>(kernel/spinlock.c:100)\u6765\u8ddf\u8e2a\u5f53\u524dCPU\u4e0a\u9501\u7684\u5d4c\u5957\u7ea7\u522b\u3002\u5f53\u8be5\u8ba1\u6570\u8fbe\u5230\u96f6\u65f6\uff0c<code>pop_off</code>\u4f1a\u6062\u590d\u6700\u5916\u5c42\u4e34\u754c\u533a\u5f00\u59cb\u65f6\u7684\u4e2d\u65ad\u542f\u7528\u72b6\u6001\u3002<code>intr_off</code>\u548c<code>intr_on</code>\u51fd\u6570\u5206\u522b\u6267\u884cRISC-V\u6307\u4ee4\u6765\u7981\u7528\u548c\u542f\u7528\u4e2d\u65ad\u3002</p> <p>\u5728\u8bbe\u7f6e<code>lk-&gt;locked</code>\u4e4b\u524d\uff0c\u4e25\u683c\u8c03\u7528<code>push_off</code>\u662f\u5f88\u91cd\u8981\u7684(kernel/spinlock.c:28)\u3002\u5982\u679c\u4e24\u8005\u53cd\u8fc7\u6765\uff0c\u90a3\u4e48\u5728\u542f\u7528\u4e2d\u65ad\u7684\u60c5\u51b5\u4e0b\uff0c\u9501\u4f1a\u6709\u4e00\u4e2a\u7a97\u53e3(\u672a\u9501\u5230\u7684\u4f4d\u7f6e)\uff0c\u5728\u672a\u7981\u6b62\u4e2d\u65ad\u65f6\u6301\u6709\u9501\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u65f6\u673a\u6070\u5230\u597d\u5904\u7684\u65f6\u949f\u4e2d\u65ad\u4f1a\u4f7f\u7cfb\u7edf\u6b7b\u9501\u3002\u540c\u6837\uff0c\u91ca\u653e\u9501\u540e\u624d\u8c03\u7528<code>pop_off</code>\u4e5f\u5f88\u91cd\u8981(kernel/spinlock.c:66)\u3002</p>"},{"location":"os/Chapter-6/#66","title":"6.6 \u6307\u4ee4\u4e0e\u5b58\u50a8\u7684\u987a\u5e8f","text":"<p>\u4eba\u4eec\u5f88\u81ea\u7136\u5730\u8ba4\u4e3a\u7a0b\u5e8f\u662f\u6309\u7167\u6e90\u4ee3\u7801\u8bed\u53e5\u51fa\u73b0\u7684\u987a\u5e8f\u6765\u6267\u884c\u7684\u3002\u7136\u800c\uff0c\u8bb8\u591a\u7f16\u8bd1\u5668\u548cCPU\u4e3a\u4e86\u83b7\u5f97\u66f4\u9ad8\u7684\u6027\u80fd\uff0c\u4f1a\u4e0d\u6309\u987a\u5e8f\u6267\u884c\u4ee3\u7801\u3002\u5982\u679c\u4e00\u6761\u6307\u4ee4\u9700\u8981\u5f88\u591a\u5468\u671f\u624d\u80fd\u5b8c\u6210\uff0cCPU\u53ef\u80fd\u4f1a\u63d0\u524d\u53d1\u51fa\u8be5\u6307\u4ee4\uff0c\u4ee5\u4fbf\u4e0e\u5176\u4ed6\u6307\u4ee4\u91cd\u53e0\uff0c\u907f\u514dCPU\u505c\u987f\u3002\u4f8b\u5982\uff0cCPU\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\u5728\u4e00\u4e2a\u4e32\u884c\u5e8f\u5217\u4e2d\uff0c\u6307\u4ee4A\u548cB\u4e92\u4e0d\u4f9d\u8d56\u3002CPU\u53ef\u80fd\u5148\u542f\u52a8\u6307\u4ee4B\uff0c\u8fd9\u662f\u56e0\u4e3a\u5b83\u7684\u8f93\u5165\u5728A\u7684\u8f93\u5165\u4e4b\u524d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\uff0c\u6216\u8005\u662f\u4e3a\u4e86\u4f7fA\u548cB\u7684\u6267\u884c\u91cd\u53e0\u3002\u7f16\u8bd1\u5668\u53ef\u4ee5\u6267\u884c\u7c7b\u4f3c\u7684\u91cd\u65b0\u6392\u5e8f\uff0c\u5728\u4e00\u6761\u8bed\u53e5\u7684\u6307\u4ee4\u4e4b\u524d\u53d1\u51fa\u53e6\u4e00\u6761\u8bed\u53e5\u7684\u6307\u4ee4\uff0c\u7531\u4e8e\u5b83\u4eec\u539f\u6765\u7684\u987a\u5e8f\u3002</p> <p>\u7f16\u8bd1\u5668\u548cCPU\u5728\u5bf9\u6307\u4ee4\u91cd\u65b0\u6392\u5e8f\u65f6\u9075\u5faa\u76f8\u5e94\u89c4\u5219\uff0c\u4ee5\u786e\u4fdd\u5b83\u4eec\u4e0d\u4f1a\u6539\u53d8\u6b63\u786e\u7f16\u5199\u7684\u4e32\u884c\u4ee3\u7801\u7684\u7ed3\u679c\u3002\u7136\u800c\uff0c\u8fd9\u4e9b\u89c4\u5219\u786e\u5b9e\u5141\u8bb8\u91cd\u6392\uff0c\u4ece\u800c\u6539\u53d8\u5e76\u53d1\u4ee3\u7801\u7684\u7ed3\u679c\uff0c\u5e76\u4e14\u5f88\u5bb9\u6613\u5bfc\u81f4\u591a\u5904\u7406\u5668\u4e0a\u7684\u4e0d\u6b63\u786e\u884c\u4e3a\u3002CPU\u7684\u6307\u4ee4\u6392\u5e8f\u89c4\u5219\u89c4\u5219\u79f0\u4e3a\u5185\u5b58\u6a21\u578b(memory model)\u3002</p> <p>\u4f8b\u5982\uff0c\u5728\u8fd9\u6bb5<code>push</code>\u7684\u4ee3\u7801\u4e2d\uff0c\u5982\u679c\u7f16\u8bd1\u5668\u6216CPU\u5c06\u7b2c4\u884c\u5bf9\u5e94\u7684\u5b58\u50a8\u79fb\u5230\u7b2c6\u884c\u91ca\u653e\u540e\u7684\u67d0\u4e2a\u70b9\uff0c\u90a3\u5c06\u662f\u4e00\u573a\u707e\u96be\u3002</p> C<pre><code>l = malloc(sizeof *l);\nl-&gt;data = data;\nacquire(&amp;listlock);\nl-&gt;next = list;\nlist = l;\nrelease(&amp;listlock);\n</code></pre> <p>\u5982\u679c\u53d1\u751f\u8fd9\u6837\u7684\u91cd\u6392\uff0c\u5c31\u4f1a\u6709\u4e00\u4e2a\u6307\u4ee4\u6267\u884c\u7684\u7a97\u53e3\u3002\u5728\u8fd9\u4e2a\u7a97\u53e3\u4e2d\uff0c\u53e6\u4e00\u4e2aCPU\u53ef\u4ee5\u83b7\u53d6\u9501\u5e76\u89c2\u5bdf\u66f4\u65b0\u7684\u94fe\u8868\uff0c\u4f46\u770b\u5230\u7684\u662f\u4e00\u4e2a\u672a\u521d\u59cb\u5316\u7684<code>list-&gt;next</code>\u3002</p> <p>\u4e3a\u4e86\u544a\u8bc9\u786c\u4ef6\u548c\u7f16\u8bd1\u5668\u4e0d\u8981\u6267\u884c\u8fd9\u6837\u7684re-ordering\uff0cxv6\u5728<code>acquire</code>(kernel/spinlock.c:22)\u548c<code>release</code>(kernel/spinlock.c:47)\u4e2d\u90fd\u4f7f\u7528\u4e86<code>__sync_synchronize()</code>\u3002<code>__sync_synchronize</code>()\u662f\u4e00\u4e2a\u5185\u5b58\u5c4f\u969c(memory barrier):\u5b83\u544a\u8bc9\u7f16\u8bd1\u5668\u548cCPU\u4e0d\u8981\u5728\u8d8a\u8fc7\u5c4f\u969c\u91cd\u65b0\u6392\u5217\u4efb\u4f55\u7684\u5185\u5b58\u8bfb\u5199\u64cd\u4f5c\u3002<code>acquire</code>\u548c<code>release</code>\u4e2d\u7684\u5c4f\u969c\u51e0\u4e4e\u5728\u6240\u6709\u91cd\u8981\u7684\u60c5\u51b5\u4e0b\u90fd\u4f1a\u5f3a\u5236\u9501\u5b9a\u987a\u5e8f\uff0c\u56e0\u4e3axv6\u5728\u8bbf\u95ee\u5171\u4eab\u6570\u636e\u7684\u5468\u56f4\u4f7f\u7528\u9501\u3002\u7b2c9\u7ae0\u8ba8\u8bba\u4e86\u4e00\u4e9b\u4f8b\u5916\u60c5\u51b5\u3002</p>"},{"location":"os/Chapter-6/#67","title":"6.7 \u7761\u7720\u9501","text":"<p>\u6709\u65f6xv6\u9700\u8981\u957f\u65f6\u95f4\u4fdd\u6301\u4e00\u4e2a\u9501\u3002\u4f8b\u5982\uff0c\u6587\u4ef6\u7cfb\u7edf\uff08\u7b2c8\u7ae0\uff09\u5728\u78c1\u76d8\u4e0a\u8bfb\u5199\u6587\u4ef6\u5185\u5bb9\u65f6\uff0c\u4f1a\u4fdd\u6301\u4e00\u4e2a\u6587\u4ef6\u7684\u9501\u5b9a\uff0c\u8fd9\u4e9b\u78c1\u76d8\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u51e0\u5341\u6beb\u79d2\u3002\u5982\u679c\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u60f3\u83b7\u53d6\u4e00\u4e2a\u81ea\u65cb\u9501\uff0c\u90a3\u4e48\u4fdd\u6301\u90a3\u4e48\u957f\u7684\u65f6\u95f4\u4f1a\u5bfc\u81f4\u6d6a\u8d39\uff0c\u56e0\u4e3a\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\u5728\u7b49\u5f85\u9501\u7684\u540c\u65f6\u4f1a\u6d6a\u8d39CPU\u5f88\u957f\u65f6\u95f4\u3002\u81ea\u65cb\u9501\u7684\u53e6\u4e00\u4e2a\u7f3a\u70b9\u662f\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u5728\u4fdd\u7559\u81ea\u65cb\u9501\u7684\u540c\u65f6\u4e0d\u80fd\u91ca\u653eCPU\u5e76\u5c06\u81ea\u8eab\u8f6c\u53d8\u4e3a\u5c31\u7eea\u6001\uff1b\u6211\u4eec\u5e0c\u671b\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u4ee5\u4fbf\u5728\u62e5\u6709\u81ea\u65cb\u9501\u7684\u8fdb\u7a0b\u7b49\u5f85\u78c1\u76d8\u65f6\uff0c\u5176\u4ed6\u8fdb\u7a0b\u53ef\u4ee5\u4f7f\u7528CPU\u3002\u5728\u6301\u6709\u81ea\u65cb\u9501\u65f6\u91ca\u653eCPU\u662f\u975e\u6cd5\u7684\uff0c\u56e0\u4e3a\u5982\u679c\u7b2c\u4e8c\u4e2a\u7ebf\u7a0b\u518d\u8bd5\u56fe\u83b7\u53d6\u81ea\u65cb\u9501\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6b7b\u9501\uff1b\u7531\u4e8e<code>acquire</code>\u5e76\u4e0d\u80fd\u91ca\u653eCPU\uff0c\u7b2c\u4e8c\u4e2a\u8fdb\u7a0b\u7684\u7b49\u5f85\u53ef\u80fd\u4f1a\u963b\u6b62\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\u8fd0\u884c\u548c\u91ca\u653e\u9501\u3002\u5728\u6301\u6709\u9501\u7684\u540c\u65f6\u91ca\u653eCPU\u4e5f\u4f1a\u8fdd\u53cd\u5728\u6301\u6709\u81ea\u65cb\u9501\u65f6\u4e2d\u65ad\u5fc5\u987b\u5173\u95ed\u7684\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5e0c\u671b\u6709\u4e00\u79cd\u9501\uff0c\u5728\u7b49\u5f85\u83b7\u53d6\u7684\u540c\u65f6\u8ba9CPU\u53ef\u4ee5\u8fdb\u884c\u522b\u7684\u5de5\u4f5c\uff0c\u5e76\u5728\u9501\u88ab\u6301\u6709\u65f6\u5141\u8bb8\u91ca\u653eCPU\uff0c\u540c\u65f6\u5f00\u653e\u4e2d\u65ad\u3002</p> <p>Xv6\u4ee5\u7761\u7720\u9501(sleeplock)\u7684\u5f62\u5f0f\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u9501\u3002<code>acquiresleep</code>(kernel/sleeplock.c:22)\u5728\u7b49\u5f85\u65f6\u4ea7\u751fCPU\uff0c\u4f7f\u7528\u7684\u6280\u672f\u5c06\u5728\u7b2c7\u7ae0\u89e3\u91ca\u3002\u5728\u9ad8\u5c42\u6b21\u4e0a\uff0c\u7761\u7720\u9501\u6709\u4e00\u4e2a\u7531<code>spinlock</code>\u4fdd\u62a4\u7684\u9501\u5b9a\u5b57\u6bb5\uff0c<code>acquiresleep</code>\u8c03\u7528<code>sleep</code>\u539f\u5b50\u6027\u5730\u8ba9\u6e21CPU\u5e76\u91ca\u653e<code>spinlock</code>\u3002\u7ed3\u679c\u5c31\u662f\uff0c\u5728<code>acquireleep</code>\u7b49\u5f85\u7684\u65f6\u5019\uff0c\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u6267\u884c\u3002</p> <p>\u56e0\u4e3a\u7761\u7720\u9501\u4f7f\u4e2d\u65ad\u5904\u4e8e\u542f\u7528\u72b6\u6001\uff0c\u6240\u4ee5\u5b83\u4eec\u4e0d\u80fd\u7528\u4e8e\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u4e2d\u3002\u7531\u4e8e<code>acquiresleep</code>\u53ef\u80fd\u4f1a\u91ca\u653eCPU\uff0c\u6240\u4ee5\u7761\u7720\u9501\u4e0d\u80fd\u5728\u81ea\u65cb\u9501\u7684\u6838\u5fc3\u4ee3\u7801\u4e2d\u4f7f\u7528\uff08\u5c3d\u7ba1\u81ea\u65cb\u9501\u53ef\u4ee5\u5728\u7761\u7720\u9501\u7684\u6838\u5fc3\u4ee3\u7801\u4e2d\u4f7f\u7528\uff09\u3002</p> <p>\u81ea\u65cb\u9501\u6700\u9002\u5408\u4e8e\u77ed\u7684\u5173\u952e\u90e8\u5206\uff0c\u56e0\u4e3a\u7b49\u5f85\u5b83\u4eec\u4f1a\u6d6a\u8d39CPU\u65f6\u95f4\uff1b\u7761\u7720\u9501\u5bf9\u957f\u7684\u64cd\u4f5c\u5f88\u6709\u6548\u3002</p>"},{"location":"os/Chapter-6/#68","title":"6.8 \u73b0\u5b9e\u4e16\u754c","text":"<p>\u5c3d\u7ba1\u5bf9\u5e76\u53d1\u57fa\u5143\u548c\u5e76\u884c\u8fdb\u884c\u4e86\u591a\u5e74\u7684\u7814\u7a76\uff0c\u4f46\u4f7f\u7528\u9501\u8fdb\u884c\u7f16\u7a0b\u4ecd\u7136\u5177\u6709\u6311\u6218\u6027\u3002\u901a\u5e38\u6700\u597d\u662f\u5c06\u9501\u9690\u85cf\u5728\u66f4\u9ad8\u7ea7\u522b\u7684\u6784\u9020\u4e2d\uff0c\u6bd4\u5982\u540c\u6b65\u961f\u5217\uff0c\u5c3d\u7ba1xv6\u6ca1\u6709\u8fd9\u6837\u505a\u3002\u5982\u679c\u60a8\u4f7f\u7528\u9501\u7f16\u7a0b\uff0c\u660e\u667a\u7684\u505a\u6cd5\u662f\u4f7f\u7528\u4e00\u4e2a\u8bd5\u56fe\u8bc6\u522b\u7ade\u4e89\u6761\u4ef6\u7684\u5de5\u5177\uff0c\u56e0\u4e3a\u5f88\u5bb9\u6613\u9519\u8fc7\u4e00\u4e2a\u9700\u8981\u9501\u7684\u4e0d\u53d8\u5f0f\u3002</p> <p>\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u90fd\u652f\u6301POSIX\u7ebf\u7a0b\uff08Pthreads\uff09\uff0c\u5b83\u5141\u8bb8\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u5728\u4e0d\u540c\u7684CPU\u4e0a\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8fd0\u884c\u3002Pthreads\u5bf9\u7528\u6237\u7ea7\u9501\u3001\u5c4f\u969c\u7b49\u90fd\u6709\u652f\u6301\u3002\u652f\u6301Pthreads\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u7684\u652f\u6301\u3002\u4f8b\u5982\uff0c\u5e94\u8be5\u662f\u5982\u679c\u4e00\u4e2apthread\u5728\u7cfb\u7edf\u8c03\u7528\u4e2d\u963b\u585e\uff0c\u540c\u4e00\u8fdb\u7a0b\u7684\u53e6\u4e00\u4e2apthread\u5e94\u8be5\u53ef\u4ee5\u5728\u8be5CPU\u4e0a\u8fd0\u884c\u3002\u53c8\u6bd4\u5982\uff0c\u5982\u679c\u4e00\u4e2apthread\u6539\u53d8\u4e86\u5b83\u7684\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff08\u6bd4\u5982\u6620\u5c04\u6216\u53d6\u6d88\u6620\u5c04\u5185\u5b58\uff09\uff0c\u5185\u6838\u5fc5\u987b\u5b89\u6392\u8fd0\u884c\u540c\u4e00\u8fdb\u7a0b\u7ebf\u7a0b\u7684\u5176\u4ed6CPU\u66f4\u65b0\u5b83\u4eec\u7684\u786c\u4ef6\u9875\u8868\u4ee5\u53cd\u6620\u5730\u5740\u7a7a\u95f4\u7684\u53d8\u5316\u3002</p> <p>\u53ef\u4ee5\u5728\u6ca1\u6709\u539f\u5b50\u6307\u4ee4\u7684\u60c5\u51b5\u4e0b\u5b9e\u73b0\u9501\uff0c\u4f46\u6210\u672c\u5f88\u9ad8\uff0c\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u90fd\u4f7f\u7528\u539f\u5b50\u6307\u4ee4\u3002</p> <p>\u5982\u679c\u8bb8\u591aCPU\u8bd5\u56fe\u540c\u65f6\u83b7\u53d6\u540c\u4e00\u4e2a\u9501\uff0c\u90a3\u4e48\u9501\u7684\u6210\u672c\u4f1a\u5f88\u9ad8\u3002\u5982\u679c\u4e00\u4e2aCPU\u7684\u672c\u5730\u7f13\u5b58\u4e2d\u6709\u4e00\u4e2a\u9501\uff0c\u800c\u53e6\u4e00\u4e2aCPU\u5fc5\u987b\u83b7\u53d6\u8be5\u9501\uff0c\u90a3\u4e48\u66f4\u65b0\u6301\u6709\u8be5\u9501\u7684\u7f13\u5b58\u884c\u7684\u539f\u5b50\u6307\u4ee4\u5fc5\u987b\u5c06\u8be5\u884c\u4ece\u4e00\u4e2aCPU\u7684\u7f13\u5b58\u4e2d\u79fb\u5230\u53e6\u4e00\u4e2aCPU\u7684\u7f13\u5b58\u4e2d\uff0c\u5e76\u4e14\u53ef\u80fd\u4f7f\u7f13\u5b58\u884c\u7684\u4efb\u4f55\u5176\u4ed6\u526f\u672c\u65e0\u6548\u3002\u4ece\u53e6\u4e00\u4e2aCPU\u7684\u7f13\u5b58\u4e2d\u83b7\u53d6\u7f13\u5b58\u5355\u5143\u7684\u4ee3\u4ef7\u53ef\u80fd\u6bd4\u4ece\u672c\u5730\u7f13\u5b58\u4e2d\u83b7\u53d6\u884c\u7684\u4ee3\u4ef7\u9ad8\u51fa\u4e00\u4e2a\u6570\u91cf\u7ea7\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u4e0e\u9501\u76f8\u5173\u7684\u4ee3\u4ef7\uff0c\u8bb8\u591a\u64cd\u4f5c\u7cfb\u7edf\u4f7f\u7528\u65e0\u9501\u6570\u636e\u7ed3\u6784\u548c\u7b97\u6cd5\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u5b9e\u73b0\u50cf\u672c\u7ae0\u5f00\u5934\u90a3\u6837\u7684\u94fe\u63a5\u5217\u8868\uff0c\u5728\u5217\u8868\u641c\u7d22\u8fc7\u7a0b\u4e2d\u4e0d\u9700\u8981\u9501\uff0c\u53ea\u9700\u8981\u4e00\u6761\u539f\u5b50\u6307\u4ee4\u5c31\u53ef\u4ee5\u5728\u5217\u8868\u4e2d\u63d2\u5165\u4e00\u4e2a\u9879\u76ee\u3002\u4e0d\u8fc7\uff0c\u65e0\u9501\u7f16\u7a0b\u6bd4\u6709\u9501\u7f16\u7a0b\u66f4\u590d\u6742\uff0c\u4f8b\u5982\uff0c\u5fc5\u987b\u62c5\u5fc3\u6307\u4ee4\u548c\u5185\u5b58\u7684\u91cd\u65b0\u6392\u5e8f\u95ee\u9898\u3002\u7528\u9501\u7f16\u7a0b\u5df2\u7ecf\u5f88\u96be\u4e86\uff0c\u6240\u4ee5xv6\u907f\u514d\u4e86\u65e0\u9501\u7f16\u7a0b\u7684\u989d\u5916\u590d\u6742\u6027\u3002</p>"},{"location":"os/Chapter-6/#69","title":"6.9 \u4e60\u9898","text":"<ol> <li>\u5220\u53bb<code>kalloc</code>(kernel/kalloc.c:69)\u4e2d\u5bf9acquire\u548crelease\u7684\u8c03\u7528\u3002\u8fd9\u4f3c\u4e4e\u4f1a\u7ed9\u8c03\u7528kalloc\u7684\u5185\u6838\u4ee3\u7801\u5e26\u6765\u95ee\u9898\u3002\u4f60\u89c9\u5f97\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f\u5f53\u4f60\u8fd0\u884cxv6\u65f6\uff0c\u548c\u4f60\u60f3\u7684\u4e00\u6837\u5417\uff1f\u8fd0\u884c<code>usertests</code>\u7684\u65f6\u5019\u5462\uff1f\u5982\u679c\u4f60\u6ca1\u6709\u770b\u5230\u95ee\u9898\uff0c\u4e3a\u4ec0\u4e48\u6ca1\u6709\u5462\uff1f\u770b\u770b\u4f60\u662f\u5426\u53ef\u4ee5\u901a\u8fc7\u5728kalloc\u7684\u5173\u952e\u90e8\u5206\u63d2\u5165dummy loops\u6765\u5f15\u53d1\u95ee\u9898\u3002</li> <li>\u5047\u8bbe\u4f60\u5728<code>kfree</code>\u4e2d\u6ce8\u91ca\u4e86\u9501(\u5728\u6062\u590d<code>kalloc</code>\u7684\u9501\u4e4b\u540e)\u3002\u73b0\u5728\u53ef\u80fd\u51fa\u4e86\u4ec0\u4e48\u95ee\u9898\uff1f<code>kfree</code>\u4e2d\u7f3a\u5c11\u9501\u662f\u5426\u6bd4kalloc\u4e2d\u7f3a\u5c11\u9501\u7684\u5371\u5bb3\u5c0f\uff1f</li> <li>\u5982\u679c\u4e24\u4e2aCPU\u540c\u65f6\u8c03\u7528<code>kalloc</code>\uff0c\u5176\u4e2d\u4e00\u4e2a\u5c31\u8981\u7b49\u5f85\u53e6\u4e00\u4e2a\uff0c\u8fd9\u5bf9\u6027\u80fd\u4e0d\u5229\u3002\u4fee\u6539<code>kalloc.c</code>\uff0c\u4f7f\u5176\u5177\u6709\u66f4\u591a\u7684\u5e76\u884c\u6027\uff0c\u8fd9\u6837\u4e0d\u540cCPU\u5bf9<code>kalloc</code>\u7684\u540c\u65f6\u8c03\u7528\u5c31\u53ef\u4ee5\u8fdb\u884c\uff0c\u800c\u4e0d\u9700\u8981\u7b49\u5f85\u5bf9\u65b9\u3002</li> <li>\u4f7f\u7528\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u90fd\u652f\u6301\u7684POSIX\u7ebf\u7a0b(Pthreads)\u7f16\u5199\u4e00\u4e2a\u5e76\u884c\u7a0b\u5e8f\u3002\u4f8b\u5982\uff0c\u5b9e\u73b0\u4e00\u4e2a\u5e76\u884c\u54c8\u5e0c\u8868\uff0c\u5e76\u6d4b\u91cfput/get\u64cd\u4f5c\u7684\u6570\u91cf\u662f\u5426\u968f\u7740\u6838\u5fc3\u6570\u7684\u589e\u52a0\u800c\u589e\u52a0\u3002</li> <li>\u5728xv6\u4e2d\u5b9e\u73b0Pthreads\u7684\u4e00\u4e2a\u5b50\u96c6\u3002\u5373\u5b9e\u73b0\u7528\u6237\u7ea7\u7ebf\u7a0b\u5e93\uff0c\u4f7f\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u67091\u4e2a\u4ee5\u4e0a\u7684\u7ebf\u7a0b\uff0c\u5e76\u5b89\u6392\u8fd9\u4e9b\u7ebf\u7a0b\u53ef\u4ee5\u5728\u4e0d\u540c\u7684CPU\u4e0a\u5e76\u884c\u8fd0\u884c\u3002\u63d0\u51fa\u4e00\u4e2a\u8bbe\u8ba1\uff0c\u6b63\u786e\u5904\u7406\u7ebf\u7a0b\u8fdb\u884c\u963b\u585e\u7cfb\u7edf\u8c03\u7528\u548c\u6539\u53d8\u5176\u5171\u4eab\u5730\u5740\u7a7a\u95f4\u7684\u95ee\u9898\u3002</li> </ol>"},{"location":"os/Chapter-7/","title":"Chapter 7","text":""},{"location":"os/Chapter-7/#_1","title":"\u7b2c\u4e03\u7ae0\uff1a\u8c03\u5ea6","text":"<p>\u4efb\u4f55\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u7684\u8fdb\u7a0b\u6570\u91cf\u90fd\u53ef\u80fd\u8d85\u8fc7\u8ba1\u7b97\u673a\u7684CPU\u6570\u91cf\uff0c\u56e0\u6b64\u9700\u8981\u5236\u5b9a\u4e00\u4e2a\u65b9\u6848\uff0c\u5728\u5404\u8fdb\u7a0b\u4e4b\u95f4\u5206\u65f6\u5171\u4eabCPU\u3002\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u5171\u4eab\u5bf9\u7528\u6237\u8fdb\u7a0b\u662f\u900f\u660e\u7684\u3002\u4e00\u79cd\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u901a\u8fc7\u5c06\u8fdb\u7a0b\u590d\u7528\u5230\u786c\u4ef6CPU\u4e0a\uff0c\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u63d0\u4f9b\u5b83\u6709\u81ea\u5df1\u7684\u865a\u62dfCPU\u7684\u5047\u8c61\u3002\u672c\u7ae0\u89e3\u91caxv6\u5982\u4f55\u5b9e\u73b0\u8fd9\u79cd\u590d\u7528\u3002</p>"},{"location":"os/Chapter-7/#71-multiplexing","title":"7.1 Multiplexing","text":"<p>xv6\u901a\u8fc7\u5728\u4e24\u79cd\u60c5\u51b5\u4e0b\u5c06CPU\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u6765\u5b9e\u73b0\u590d\u7528\u3002\u9996\u5148\uff0cxv6\u7684**sleep**\u548c**wakeup**\u673a\u5236\u4f1a\u8fdb\u884c\u5207\u6362\uff0c\u8fd9\u4f1a\u53d1\u751f\u5728\u8fdb\u7a0b\u7b49\u5f85\u8bbe\u5907\u6216\u7ba1\u9053I/O\uff0c\u6216\u7b49\u5f85\u5b50\u8fdb\u7a0b\u9000\u51fa\uff0c\u6216\u5728**sleep**\u7cfb\u7edf\u8c03\u7528\u4e2d\u7b49\u5f85\u3002\u5176\u6b21\uff0cxv6\u5468\u671f\u6027\u5730\u5f3a\u5236\u5207\u6362\uff0c\u4ee5\u5e94\u5bf9\u957f\u65f6\u95f4\u4e0d\u8fdb\u884csleep\u64cd\u4f5c\u7684\u8ba1\u7b97\u8fdb\u7a0b\u3002\u8fd9\u79cd\u590d\u7528\u9020\u6210\u4e86\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684CPU\u7684\u5047\u8c61\uff0c\u5c31\u50cfxv6\u4f7f\u7528\u5185\u5b58\u5206\u914d\u5668\u548c\u786c\u4ef6\u9875\u8868\u9020\u6210\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u5185\u5b58\u7684\u5047\u8c61\u4e00\u6837\u3002</p> <p>\u5b9e\u73b0\u590d\u7528\u4f1a\u6709\u4e00\u4e9b\u6311\u6218\u3002\u9996\u5148\uff0c\u5982\u4f55\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff1f\u867d\u7136\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u60f3\u6cd5\u5f88\u7b80\u5355\uff0c\u4f46\u5728XV6\u7684\u5b9e\u73b0\u4e2d\u4e0a\u4e0b\u6587\u5207\u6362\u5374\u662f\u6700\u4e0d\u900f\u660e\u7684\u4ee3\u7801\u4e4b\u4e00\u3002\u7b2c\u4e8c\uff0c\u5982\u4f55\u4ee5\u5bf9\u7528\u6237\u8fdb\u7a0b\u900f\u660e\u7684\u65b9\u5f0f\u8fdb\u884c\u5f3a\u5236\u5207\u6362\uff1fxv6\u91c7\u7528\u6807\u51c6\u901a\u7528\u7684\u65b9\u5f0f\uff0c\u7528\u5b9a\u65f6\u5668\u4e2d\u65ad\u6765\u9a71\u52a8\u4e0a\u4e0b\u6587\u5207\u6362\u3002\u7b2c\u4e09\uff0c\u8bb8\u591aCPU\u53ef\u80fd\u4f1a\u5728\u8fdb\u7a0b\u95f4\u5e76\u53d1\u5207\u6362\uff0c\u9700\u8981\u8bbe\u8ba1\u4e00\u4e2a\u9501\u6765\u907f\u514d\u7ade\u4e89\u3002\u7b2c\u56db\uff0c\u5f53\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u5fc5\u987b\u91ca\u653e\u8fdb\u7a0b\u7684\u5185\u5b58\u548c\u5176\u4ed6\u8d44\u6e90\uff0c\u4f46\u8fdb\u7a0b\u672c\u8eab\u4e0d\u80fd\u5b8c\u5168\u91ca\u653e\u6389\u6240\u6709\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u5b83\u4e0d\u80fd\u5728\u4f7f\u7528\u5185\u6838\u6808\u7684\u540c\u65f6\u91ca\u653e\u81ea\u5df1\u7684\u5185\u6838\u6808\u3002\u7b2c\u4e94\uff0c\u591a\u6838\u673a\u5668\u7684\u6bcf\u4e2a\u5185\u6838\u5fc5\u987b\u8bb0\u4f4f\u5b83\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\uff0c\u8fd9\u6837\u7cfb\u7edf\u8c03\u7528\u624d\u80fd\u4fee\u6539\u76f8\u5e94\u8fdb\u7a0b\u7684\u5185\u6838\u72b6\u6001\u3002\u6700\u540e\uff0c**sleep**\u548c**wakeup**\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u653e\u5f03CPU\uff0c\u5e76\u7761\u7720\u7b49\u5f85\u67d0\u4e00\u4e8b\u4ef6\uff0c\u5e76\u5141\u8bb8\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u5c06\u7761\u7720\u7684\u8fdb\u7a0b\u5524\u9192\u3002\u9700\u8981\u6ce8\u610f\u4e00\u4e9b\u7ade\u4e89\u53ef\u80fd\u4f1a\u4f7f\u5524\u9192\u4e22\u5931\u3002Xv6\u8bd5\u56fe\u5c3d\u53ef\u80fd\u7b80\u5355\u5730\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c3d\u7ba1\u5982\u6b64\uff0c\u5b9e\u9645\u4ee3\u7801\u8fd8\u662f\u5f88\u68d8\u624b\u3002</p>"},{"location":"os/Chapter-7/#72-code-context-switching","title":"7.2 Code: Context switching","text":"<p>\u56fe7.1\u6982\u8ff0\u4e86\u4ece\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6240\u6d89\u53ca\u7684\u6b65\u9aa4\uff1a\u7528\u6237-\u5185\u6838\u7684\u5207\u6362\uff08\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6216\u4e2d\u65ad\uff09\u5230\u65e7\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u4e0a\u4e0b\u6587\uff08context\uff09\u5207\u6362\u5230\u5f53\u524dCPU\u7684\u8c03\u5ea6\u5668\u7ebf\u7a0b\uff0c\u4e0a\u4e0b\u6587\uff08context\uff09\u5207\u6362\u5230\u65b0\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u4ee5\u53catrap\u8fd4\u56de\u5230\u7528\u6237\u7ea7\u8fdb\u7a0b\u3002xv6\u8c03\u5ea6\u5668\u5728\u6bcf\u4e2aCPU\u4e0a\u6709\u4e00\u4e2a\u4e13\u95e8\u7684\u7ebf\u7a0b(\u4fdd\u5b58\u4e86\u5bc4\u5b58\u5668\u548c\u6808)\uff0c\u56e0\u4e3a\u8c03\u5ea6\u5668\u5728\u65e7\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u4e0a\u6267\u884c\u662f\u4e0d\u5b89\u5168\u7684\uff1a\u56e0\u4e3a\u5176\u4ed6\u6838\u5fc3\u53ef\u80fd\u4f1a\u5524\u9192\u8be5\u8fdb\u7a0b\u5e76\u8fd0\u884c\u5b83\uff0c\u800c\u5728\u4e24\u4e2a\u4e0d\u540c\u7684\u6838\u5fc3\u4e0a\u4f7f\u7528\u76f8\u540c\u7684\u6808\u5c06\u662f\u4e00\u573a\u707e\u96be\u3002\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u7814\u7a76\u5728\u5185\u6838\u7ebf\u7a0b\u548c\u8c03\u5ea6\u7ebf\u7a0b\u4e4b\u95f4\u5207\u6362\u7684\u673a\u5236\u3002</p> <p>\u4ece\u4e00\u4e2a\u7ebf\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u9700\u8981\u4fdd\u5b58\u65e7\u7ebf\u7a0b\u7684CPU\u5bc4\u5b58\u5668\uff0c\u5e76\u6062\u590d\u65b0\u7ebf\u7a0b\u4e4b\u524d\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\uff1b\u6808\u6307\u9488\u548cpc\u88ab\u4fdd\u5b58\u548c\u6062\u590d\uff0c\u610f\u5473\u7740CPU\u5c06\u5207\u6362\u6808\u548c\u6b63\u5728\u6267\u884c\u7684\u4ee3\u7801\u3002</p> <p>\u51fd\u6570**swtch**\u6267\u884c\u5185\u6838\u7ebf\u7a0b\u5207\u6362\u7684\u4fdd\u5b58\u548c\u6062\u590d\u3002swtch**\u5e76\u4e0d\u76f4\u63a5\u77e5\u9053\u7ebf\u7a0b\uff0c\u5b83\u53ea\u662f\u4fdd\u5b58\u548c\u6062\u590d\u5bc4\u5b58\u5668\u7ec4\uff0c\u79f0\u4e3a***\u4e0a\u4e0b\u6587(context)*\u3002\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u8981\u653e\u5f03CPU\u7684\u65f6\u5019\uff0c\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\u4f1a\u8c03\u7528**swtch**\u4fdd\u5b58\u81ea\u5df1\u7684\u4e0a\u4e0b\u6587\u5e76\u8fd4\u56de\u5230\u8c03\u5ea6\u5668\u4e0a\u4e0b\u6587\u3002\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u90fd\u5305\u542b\u5728\u4e00\u4e2a\u7ed3\u6784\u4f53 context(kernel/proc.h:2)**\u4e2d\uff0c\u5b83\u672c\u8eab\u5305\u542b\u5728\u8fdb\u7a0b\u7684\u7ed3\u6784\u4f53**proc**\u6216CPU\u7684\u7ed3\u6784\u4f53**cpu**\u4e2d\u3002**Swtch**\u6709\u4e24\u4e2a\u53c2\u6570\uff1a**struct context old**\u548c**struct context new\u3002\u5b83\u5c06\u5f53\u524d\u7684\u5bc4\u5b58\u5668\u4fdd\u5b58\u5728old\u4e2d\uff0c\u4ecenew\u4e2d\u52a0\u8f7d\u5bc4\u5b58\u5668\uff0c\u7136\u540e\u8fd4\u56de\u3002</p> <p>\u8ba9\u6211\u4eec\u8ddf\u968f\u4e00\u4e2a\u8fdb\u7a0b\u901a\u8fc7**swtch**\u8fdb\u5165**scheduler**\u3002\u6211\u4eec\u5728\u7b2c4\u7ae0\u770b\u5230\uff0c\u5728\u4e2d\u65ad\u7ed3\u675f\u65f6\uff0c\u6709\u4e00\u79cd\u60c5\u51b5\u662f**usertrap**\u8c03\u7528**yield**\u3002yield**\u53c8\u8c03\u7528**sched\uff0c**sched**\u8c03\u7528**swtch**\u5c06\u5f53\u524d\u4e0a\u4e0b\u6587\u4fdd\u5b58\u5728**p-&gt;context**\u4e2d\uff0c\u5e76\u5207\u6362\u5230\u4e4b\u524d\u4fdd\u5b58\u5728**cpu-&gt;scheduler**\u4e2d\u7684\u8c03\u5ea6\u5668\u4e0a\u4e0b\u6587\uff08kernel/proc.c:509\uff09\u3002</p> <p>**Swtch(kernel/swtch.S:3)**\u53ea\u4fdd\u5b58callee-saved\u5bc4\u5b58\u5668\uff0ccaller-saved\u5bc4\u5b58\u5668\u7531\u8c03\u7528\u7684C\u4ee3\u7801\u4fdd\u5b58\u5728\u5806\u6808\u4e0a(\u5982\u679c\u9700\u8981)\u3002**Swtch**\u77e5\u9053**struct context**\u4e2d\u6bcf\u4e2a\u5bc4\u5b58\u5668\u5b57\u6bb5\u7684\u504f\u79fb\u91cf\u3002\u5b83\u4e0d\u4fdd\u5b58pc\u3002\u76f8\u53cd\uff0c**swtch**\u4fdd\u5b58\u4e86ra\u5bc4\u5b58\u5668[1]\uff0c\u5b83\u4fdd\u5b58\u4e86**swtch**\u5e94\u8be5\u8fd4\u56de\u7684\u5730\u5740\u3002\u73b0\u5728\uff0c**swtch**\u4ece\u65b0\u7684\u4e0a\u4e0b\u6587\u4e2d\u6062\u590d\u5bc4\u5b58\u5668\uff0c\u65b0\u7684\u4e0a\u4e0b\u6587\u4e2d\u4fdd\u5b58\u7740\u524d\u4e00\u6b21**swtch**\u6240\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u503c\u3002\u5f53**swtch**\u8fd4\u56de\u65f6\uff0c\u5b83\u8fd4\u56de\u5230\u88ab\u6062\u590d\u7684ra\u5bc4\u5b58\u5668\u6240\u6307\u5411\u7684\u6307\u4ee4\uff0c\u4e5f\u5c31\u662f\u65b0\u7ebf\u7a0b\u4e4b\u524d\u8c03\u7528**swtch**\u7684\u6307\u4ee4\u3002\u6b64\u5916\uff0c\u5b83\u8fd8\u4f1a\u8fd4\u56de\u65b0\u7ebf\u7a0b\u7684\u5806\u6808\u3002</p> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0csched**\u8c03\u7528**swtch**\u5207\u6362\u5230**cpu-&gt;scheduler\uff0c\u5373CPU\u8c03\u5ea6\u5668\u7684\u4e0a\u4e0b\u6587\u3002\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5df2\u7ecf\u88ab**scheduler**\u5bf9**swtch**\u7684\u8c03\u7528\u6240\u4fdd\u5b58(kernel/proc.c:475)\u3002\u5f53\u6211\u4eec\u8ddf\u8e2a\u7684**swtch**\u8fd4\u56de\u65f6\uff0c\u5b83\u4e0d\u662f\u8fd4\u56de\u5230**sched**\u800c\u662f\u8fd4\u56de\u5230**scheduler**\uff0c\u5b83\u7684\u6808\u6307\u9488\u6307\u5411\u5f53\u524dCPU\u7684\u8c03\u5ea6\u5668\u6808\u3002</p> <p>\u8865\u5145\u8bf4\u660e\uff08\u4e0d\u5728\u7ffb\u8bd1\u5185\u5bb9\u4e2d\uff09\uff1a</p> <p>\u6839\u636eXV6\u7684\u6e90\u4ee3\u7801\uff0cxv6\u4e2d\u53ea\u6709\u4e24\u5904\u8c03\u7528switch\uff1a</p> <p><code>c void sched(void) {     // ...     swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;scheduler);     // ... }</code></p> <p>``` c void scheduler(void) {     // ...     swtch(&amp;c-&gt;scheduler, &amp;p-&gt;context);     // ... } Text Only<pre><code>**\u53ef\u4ee5\u770b\u51fa\u8fd9\u91cc\u6ca1\u6709\u4e24\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u7684\u76f4\u63a5\u5207\u6362\uff0c\u53ea\u6709\u7528\u6237\u8fdb\u7a0b\u548c\u8c03\u5ea6\u5668\u7ebf\u7a0b\u4e4b\u95f4\u7684\u5207\u6362**\uff1axv6\u4e2d\u8981\u4e3b\u52a8\u8ba9\u51facpu\u7684\u8fdb\u7a0b\u90fd\u662f\u901a\u8fc7\u8c03\u7528exit/sleep/yield\uff0c\u95f4\u63a5\u8c03\u7528sched\uff0c\u4ece\u800c\u5b9e\u73b0\u5207\u6362\u5230\u8c03\u5ea6\u5668\u7ebf\u7a0b\uff0c\u518d\u7531\u8c03\u5ea6\u5668\u7ebf\u7a0b\u9009\u51fa\u5e76\u5207\u6362\u5230\u4e00\u4e2arunnable\u3002\n\n### 7.3 Code: Scheduling\n\n\u4e0a\u4e00\u8282\u7814\u7a76\u4e86**swtch**\u7684\u5e95\u5c42\u7ec6\u8282\uff0c\u73b0\u5728\u6211\u4eec\u628a**swtch**\u4f5c\u4e3a\u4e00\u4e2a\u7ed9\u5b9a\u7684\u6761\u4ef6\uff0c\u7814\u7a76\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\u901a\u8fc7\u8c03\u5ea6\u5668\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002\u8c03\u5ea6\u5668\u4ee5CPU\u7279\u6b8a\u7ebf\u7a0b\uff08\u6bcf\u4e2aCPU\u5404\u4e00\u4e2a\uff09\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u7ebf\u7a0b\u8fd0\u884c**scheduler**\u51fd\u6570\u3002\u8fd9\u4e2a\u51fd\u6570\u8d1f\u8d23\u9009\u62e9\u4e0b\u4e00\u6b65\u8fd0\u884c\u54ea\u4e2a\u8fdb\u7a0b\u3002\u4e00\u4e2a\u60f3\u8981\u653e\u5f03CPU\u7684\u8fdb\u7a0b\uff0c\u5fc5\u987b\u83b7\u53d6\u81ea\u5df1\u7684\u8fdb\u7a0b\u9501**p-&gt;lock**\uff0c\u91ca\u653e\u5b83\u6240\u6301\u6709\u7684\u5176\u4ed6\u9501\uff0c\u66f4\u65b0\u81ea\u5df1\u7684\u72b6\u6001\uff08**p-&gt;state**\uff09\uff0c\u7136\u540e\u8c03\u7528**sched**\u3002**Yield** (kernel/proc.c:515) \u9075\u5faa\u8fd9\u4e2a\u89c4\u5219\uff0c\u6211\u4eec\u7a0d\u540e\u8981\u7814\u7a76\u7684**sleep**\u548c**exit**\u4e5f\u540c\u6837\u9075\u5faa\u8fd9\u4e2a\u89c4\u5219\u3002**Sched**\u5bf9\u8fd9\u4e9b\u6761\u4ef6\u8fdb\u884c\u4ed4\u7ec6\u68c0\u67e5(kernel/proc.c:499-504)\uff0c\u7136\u540e\u518d\u68c0\u67e5\u8fd9\u4e9b\u6761\u4ef6\u7684\u542b\u4e49\uff1a\u65e2\u7136\u9501\u88ab\u6301\u6709\uff0c\u5c31\u5e94\u8be5\u7981\u7528\u4e2d\u65ad\u3002\u6700\u540e\uff0c**sched**\u8c03\u7528**swtch**\u5c06\u5f53\u524d\u4e0a\u4e0b\u6587\u4fdd\u5b58\u5728p-&gt;context\u4e2d\uff0c\u5e76\u5207\u6362\u5230cpu-&gt;scheduler\u4e2d**scheduler**\u7684\u4e0a\u4e0b\u6587\u3002Swtch\u5728**scheduler**\u5806\u6808\u4e0a\u8fd4\u56de\uff0c**scheduler**\u7ee7\u7eedfor\u5faa\u73af\uff0c\u627e\u5230\u4e00\u4e2a\u8981\u8fd0\u884c\u7684\u8fdb\u7a0b\uff0c\u5207\u6362\u5230\u5b83\uff0c\u7136\u540e\u5faa\u73af\u91cd\u590d\u3002\n\n\u6211\u4eec\u521a\u521a\u770b\u5230xv6\u5728\u8c03\u7528**swtch**\u7684\u8fc7\u7a0b\u4e2d\u6301\u6709**p-&gt;lock**\uff1a**swtch**\u7684\u8c03\u7528\u8005\u5fc5\u987b\u5df2\u7ecf\u6301\u6709\u9501\uff0c\u5e76\u628a\u9501\u7684\u63a7\u5236\u6743\u79fb\u4ea4\u7ed9\u5207\u6362\u5230\u7684\u4ee3\u7801\u3002\u8fd9\u79cd\u7ea6\u5b9a\u5bf9\u4e8e\u9501\u6765\u8bf4\u662f\u4e0d\u5bfb\u5e38\u7684\uff1b\u4e00\u822c\u6765\u8bf4\u83b7\u5f97\u9501\u7684\u7ebf\u7a0b\u4e5f\u8981\u8d1f\u8d23\u91ca\u653e\u9501\uff0c\u8fd9\u6837\u624d\u5bb9\u6613\u4fdd\u8bc1\u6b63\u786e\u6027\u3002\u5bf9\u4e8e\u4e0a\u4e0b\u6587\u5207\u6362\u6765\u8bf4\uff0c\u6709\u5fc5\u8981\u6253\u7834\u8fd9\u4e2a\u7ea6\u5b9a\uff0c\u56e0\u4e3a**p-&gt;lock**\u4fdd\u62a4\u4e86\u8fdb\u7a0b\u7684\u72b6\u6001\u548c**context**\u5b57\u6bb5\u4e0a\u7684***\u4e0d\u53d8\u91cf\uff08invariant\uff09***\uff0c\u800c\u8fd9\u4e9b\u4e0d\u53d8\u91cf\u5728**swtch**\u6267\u884c\u65f6\u662f\u4e0d\u6b63\u786e\u7684\u3002\u5982\u679c**p-&gt;lock**\u5728**swtch**\u8fc7\u7a0b\u4e2d\u4e0d\u88ab\u6301\u6709\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u95ee\u9898\u7684\u4e00\u4e2a\u60c5\u51b5\uff1a\u5728**yield**\u5c06\u5176\u72b6\u6001\u8bbe\u7f6e\u4e3a**RUNNABLE**\u4e4b\u540e\uff0c\u4f46\u5728**swtch**\u5207\u6362\u5230\u65b0\u7684\u6808\u4e4b\u524d\uff0c\u5176\u4ed6CPU\u53ef\u80fd\u4f1a\u8fd0\u884c\u8fd9\u4e2a\u8fdb\u7a0b\u3002\u7ed3\u679c\u5c31\u662f\u4e24\u4e2aCPU\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u6808\u4e0a\uff0c\u8fd9\u663e\u7136\u662f\u9519\u8bef\u7684\u3002\n\n\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u5728**sched**\u4e2d\u653e\u5f03\u5b83\u7684CPU\uff0c\u5e76\u4e14\u5207\u6362\u5230**scheduler**\u7684\u540c\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u800c**scheduler**\uff08\u51e0\u4e4e\uff09\u603b\u662f\u5207\u6362\u5230\u4e4b\u524d\u8c03\u7528**sched**\u7684\u67d0\u4e2a\u5185\u6838\u7ebf\u7a0b\u3002\u56e0\u6b64\uff0c\u5982\u679c\u628axv6\u5207\u6362\u7ebf\u7a0b\u7684\u884c\u53f7\u6253\u5370\u51fa\u6765\uff0c\u5c31\u4f1a\u89c2\u5bdf\u5230\u4e0b\u9762\u7684\u7ed3\u679c\uff1a(kernel/proc.c:475)\uff0c(kernel/proc.c:509)\uff0c(kernel/proc.c:475)\uff0c(kernel/proc.c:509)\uff0c\u7b49\u7b49\u3002\u5728\u4e24\u4e2a\u7ebf\u7a0b\u4e4b\u95f4\u53d1\u751f\u8fd9\u79cd\u6837\u5f0f\u5316\u5207\u6362\u7684\u7a0b\u5e8f\u6709\u65f6\u88ab\u79f0\u4e3a***\u534f\u7a0b\uff08coroutine\uff09***\uff1b\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c**sched**\u548c**scheduler**\u662f\u5f7c\u6b64\u7684***coroutines***\u3002\n\n\u6709\u4e00\u79cd\u60c5\u51b5\u662f\u8c03\u5ea6\u5668\u5bf9**swtch**\u7684\u8c03\u7528\u6ca1\u6709\u4ee5**sched**\u7ed3\u675f\u3002\u5f53\u4e00\u4e2a\u65b0\u8fdb\u7a0b\u7b2c\u4e00\u6b21\u88ab\u8c03\u5ea6\u65f6\uff0c\u5b83\u4ece**forkret**\u5f00\u59cb\uff08kernel/proc.c:527\uff09\u3002**forkret**\u7684\u5b58\u5728\u662f\u4e3a\u4e86\u91ca\u653e**p-&gt;lock**\uff1b\u5426\u5219\uff0c\u65b0\u8fdb\u7a0b\u9700\u8981\u4ece**usertrapret**\u5f00\u59cb\u3002\n\n**scheduler(kernel/proc.c:457)**\u8fd0\u884c\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u5faa\u73af\uff1a\u627e\u5230\u4e00\u4e2a\u53ef\u4ee5\u8fd0\u884c\u8fdb\u7a0b\uff0c\u8fd0\u884c\u5b83\uff0c\u76f4\u5230\u5b83\u8ba9\u51faCPU\uff0c\u4e00\u76f4\u91cd\u590d\u3002\u8c03\u5ea6\u5668\u5728\u8fdb\u7a0b\u8868\u4e0a\u5faa\u73af\u5bfb\u627e\u4e00\u4e2a\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\uff0c\u5373p-&gt;state == RUNNABLE\u7684\u8fdb\u7a0b\u3002\u4e00\u65e6\u627e\u5230\u8fd9\u6837\u7684\u8fdb\u7a0b\uff0c\u5b83\u5c31\u4f1a\u8bbe\u7f6eCPU\u5f53\u524d\u8fdb\u7a0b\u53d8\u91cfc-&gt;proc\u6307\u5411\u8be5\u8fdb\u7a0b\uff0c\u5c06\u8be5\u8fdb\u7a0b\u6807\u8bb0\u4e3aRUNNING\uff0c\u7136\u540e\u8c03\u7528**swtch**\u5f00\u59cb\u8fd0\u884c\u5b83(kernel/proc.c:470- 475)\u3002\n\n\u4f60\u53ef\u4ee5\u8fd9\u6837\u7406\u89e3\u8c03\u5ea6\u4ee3\u7801\u7ed3\u6784\uff0c\u5b83\u6267\u884c\u4e00\u7ec4\u5173\u4e8e\u8fdb\u7a0b\u7684\u4e0d\u53d8\u91cf\uff0c\u5e76\u4e14\u6bcf\u5f53\u8fd9\u4e9b\u4e0d\u53d8\u91cf\u4e0d\u6b63\u786e\u65f6\uff0c\u5c31\u6301\u6709**p-&gt;lock**\u3002\u4e00\u4e2a\u4e0d\u53d8\u91cf\u662f\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u6b63\u5728\u8fd0\u884c\uff0c\u90a3\u4e48\u5b9a\u65f6\u4e2d\u65ad\u5bfc\u81f4\u7684yield\u5fc5\u987b\u80fd\u591f\u5b89\u5168\u7684\u8ba9\u4ed6\u8ba9\u51facpu\uff1b\u8fd9\u610f\u5473\u7740CPU\u5bc4\u5b58\u5668\u5fc5\u987b\u6301\u6709\u8be5\u8fdb\u7a0b\u7684\u5bc4\u5b58\u5668\u503c\uff08\u5373**swtch**\u6ca1\u6709\u5c06\u5b83\u4eec\u79fb\u5230\u4e0a\u4e0b\u6587\u4e2d\uff09\uff0c\u5e76\u4e14**c-&gt;proc**\u5fc5\u987b\u6307\u5411\u8be5\u8fdb\u7a0b\u3002\u53e6\u4e00\u4e2a\u4e0d\u53d8\u91cf\u662f\uff0c\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u662f**RUNNABLE**\u7684\uff0c\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a\u7a7a\u95f2\u7684CPU\u8c03\u5ea6\u5668\u6765\u8bf4\uff0c\u8fd0\u884c\u5b83\u5fc5\u987b\u662f\u5b89\u5168\u7684\uff1b\u8fd9\u610f\u5473\u7740 \uff081\uff09**p-&gt;context**\u5fc5\u987b\u62e5\u6709\u8fdb\u7a0b\u7684\u5bc4\u5b58\u5668\uff08\u5373\u5b83\u4eec\u5b9e\u9645\u4e0a\u5e76\u4e0d\u5728\u771f\u5b9e\u7684\u5bc4\u5b58\u5668\u4e2d\uff09\uff0c\uff082\uff09\u6ca1\u6709CPU\u5728\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u4e0a\u6267\u884c\uff0c\uff083\uff09\u4e5f\u6ca1\u6709CPU\u7684c-&gt;proc\u6307\u5411\u8be5\u8fdb\u7a0b\u3002\u8bf7\u6ce8\u610f\uff0c\u5f53p-&gt;lock\u88ab\u6301\u6709\u65f6\uff0c\u8fd9\u4e9b\u5c5e\u6027\u5f80\u5f80\u4e0d\u6b63\u786e\u3002\n\n\u7ef4\u62a4\u4e0a\u8ff0\u4e0d\u53d8\u91cf\u662fxv6\u7ecf\u5e38\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u83b7\u53d6**p-&gt;lock**\uff0c\u7136\u540e\u5728\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u91ca\u653e\u5b83\u7684\u539f\u56e0\uff08\u4f8b\u5982\u5728**yield**\u4e2d\u83b7\u53d6\uff0c\u5728**schedululer**\u4e2d\u91ca\u653e\uff09\u3002\u4e00\u65e6**yield**\u5f00\u59cb\u4fee\u6539\u4e00\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u4f7f\u5176\u6210\u4e3a**RUNNABLE**\uff0c\u9501\u5fc5\u987b\u4e00\u76f4\u4fdd\u6301\uff0c\u76f4\u5230\u4e0d\u53d8\u91cf\u88ab\u6062\u590d\uff1a\u6700\u65e9\u6b63\u786e\u7684\u91ca\u653e\u70b9\u662f\u5728\u8c03\u5ea6\u5668\uff08\u8fd0\u884c\u5728\u81ea\u5df1\u7684\u5806\u6808\u4e0a\uff09\u6e05\u9664**c-&gt;proc**\u4e4b\u540e\u3002\u540c\u6837\uff0c\u4e00\u65e6\u8c03\u5ea6\u5668\u5f00\u59cb\u5c06\u4e00\u4e2a**RUNNABLE**\u8fdb\u7a0b\u8f6c\u6362\u4e3a**RUNNING**\uff0c\u9501\u5c31\u4e0d\u80fd\u88ab\u91ca\u653e\uff0c\u76f4\u5230\u5185\u6838\u7ebf\u7a0b\u5b8c\u6210\u8fd0\u884c\uff08\u5728**swtch**\u4e4b\u540e\uff0c\u4f8b\u5982\u5728**yield**\u4e2d\uff09\u3002\n\n**p-&gt;lock**\u4e5f\u4fdd\u62a4\u5176\u4ed6\u7684\u4e1c\u897f\uff1a**exit**\u548c**wait**\u4e4b\u95f4\u7684\u76f8\u4e92\u4f5c\u7528\uff0c\u907f\u514d\u4e22\u5931\u5524\u9192\u7684\u673a\u5236\uff08\u89c1\u7b2c7.5\u8282\uff09\uff0c\u4ee5\u53ca\u907f\u514d\u907f\u514d\u9000\u51fa\u8fdb\u7a0b\u548c\u8bfb\u5199\u5176\u72b6\u6001\u7684\u5176\u4ed6\u8fdb\u7a0b\u4e4b\u95f4\u7684\u7ade\u4e89\uff08\u4f8b\u5982\uff0c**exit**\u7cfb\u7edf\u8c03\u7528\u67e5\u770b**p-&gt;pid**\u5e76\u8bbe\u7f6e**p-&gt;killed (kernel/proc.c:611)**\u3002\u503c\u5f97\u601d\u8003\u7684\u662f\uff0c\u662f\u5426\u53ef\u4ee5\u5c06**p-&gt;lock**\u7684\u4e0d\u540c\u529f\u80fd\u62c6\u5206\u5f00\u6765\uff0c\u8fd9\u6837\u65e2\u6e05\u6670\uff0c\u4e5f\u53ef\u80fd\u63d0\u9ad8\u6027\u80fd\u3002\n\n### 7.4 Code: mycpu and myproc\n\n\u200b    Xv6\u7ecf\u5e38\u9700\u8981\u4e00\u4e2a\u6307\u5411\u5f53\u524d\u8fdb\u7a0b**proc**\u7684\u6307\u9488\u3002\u5728\u5355\u6838\u5904\u7406\u5668\u4e0a\uff0c\u53ef\u4ee5\u7528\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\u6307\u5411\u5f53\u524d\u7684**proc**\u3002\u8fd9\u5728\u591a\u6838\u673a\u5668\u4e0a\u662f\u884c\u4e0d\u901a\u7684\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u6838\u90fd\u6267\u884c\u4e0d\u540c\u7684\u8fdb\u7a0b\u3002\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u5229\u7528\u6bcf\u4e2a\u6838\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7ec4\u5bc4\u5b58\u5668\u7684\u4e8b\u5b9e\uff1b\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5176\u4e2d\u7684\u4e00\u4e2a\u5bc4\u5b58\u5668\u6765\u5e2e\u52a9\u67e5\u627e\u6bcf\u4e2a\u6838\u7684\u4fe1\u606f\u3002\n\nXv6\u4e3a\u6bcf\u4e2aCPU\u7ef4\u62a4\u4e86\u4e00\u4e2a**cpu**\u7ed3\u6784\u4f53(kernel/proc.h:22)\uff0c\u5b83\u8bb0\u5f55\u4e86\u5f53\u524d\u5728\u8be5CPU\u4e0a\u8fd0\u884c\u7684\u8fdb\u7a0b(\u5982\u679c\u6709\u7684\u8bdd)\uff0c\u4e3aCPU\u7684\u8c03\u5ea6\u7ebf\u7a0b\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\uff0c\u4ee5\u53ca\u7ba1\u7406\u4e2d\u65ad\u7981\u7528\u6240\u9700\u7684\u5d4c\u5957\u81ea\u65cb\u9501\u7684\u8ba1\u6570\u3002\u51fd\u6570**mycpu**(kernel/proc.c:60)\u8fd4\u56de\u4e00\u4e2a\u6307\u5411\u5f53\u524dCPU\u7ed3\u6784\u4f53**cpu**\u7684\u6307\u9488\u3002RISC-V\u5bf9CPU\u8fdb\u884c\u7f16\u53f7\uff0c\u7ed9\u6bcf\u4e2aCPU\u4e00\u4e2a**hartid**\u3002Xv6\u786e\u4fdd\u6bcf\u4e2aCPU\u7684**hartid**\u5728\u5185\u6838\u4e2d\u88ab\u5b58\u50a8\u5728\u8be5CPU\u7684**tp**\u5bc4\u5b58\u5668\u4e2d\u3002\u8fd9\u4f7f\u5f97**mycpu**\u53ef\u4ee5\u4f7f\u7528**tp**\u5bf9**cpu**\u7ed3\u6784\u4f53\u7684\u6570\u7ec4\u8fdb\u884c\u7d22\u5f15\uff0c\u4ece\u800c\u627e\u5230\u6b63\u786e\u7684cpu\u3002\n\n\u786e\u4fdd\u4e00\u4e2aCPU\u7684**tp**\u59cb\u7ec8\u4fdd\u6301CPU\u7684hartid\u662f\u6709\u4e00\u70b9\u590d\u6742\u7684\u3002**mstart**\u5728CPU\u542f\u52a8\u7684\u65e9\u671f\u8bbe\u7f6e**tp**\u5bc4\u5b58\u5668\uff0c\u6b64\u65f6CPU\u5904\u4e8e\u673a\u5668\u6a21\u5f0f(kernel/start.c:46)\u3002**Usertrapret**\u5c06**tp**\u5bc4\u5b58\u5668\u4fdd\u5b58\u5728trampoline\u9875\u4e2d\uff0c\u56e0\u4e3a\u7528\u6237\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u4fee\u6539tp\u5bc4\u5b58\u5668\u3002\u6700\u540e\uff0c\u5f53\u4ece\u7528\u6237\u7a7a\u95f4\u8fdb\u5165\u5185\u6838\u65f6\uff0c**use**rvec\u4f1a\u6062\u590d\u4fdd\u5b58\u7684tp\uff08trapframe\u4e2d\u7684tp\u52a0\u8f7d\u5230tp\u5bc4\u5b58\u5668\uff09(kernel/trampoline.S:70)\u3002\u7f16\u8bd1\u5668\u4fdd\u8bc1\u6c38\u8fdc\u4e0d\u4f7f\u7528tp\u5bc4\u5b58\u5668\u3002\u5982\u679cRISC-V\u5141\u8bb8xv6\u76f4\u63a5\u8bfb\u53d6\u5f53\u524d\u7684hartid\u4f1a\u66f4\u65b9\u4fbf\uff0c\u4f46\u8fd9\u53ea\u5141\u8bb8\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u8bfb\u53d6\uff0c\u800c\u4e0d\u5141\u8bb8\u5728\u7ba1\u7406\u6a21\u5f0f\u4e0b\u8bfb\u53d6\u3002\n\ncpuid\u548cmycpu\u7684\u8fd4\u56de\u503c\u5f88\u5bb9\u6613\u9519\uff1a\u5982\u679c\u5b9a\u65f6\u5668\u4e2d\u65ad\uff0c\u5bfc\u81f4\u7ebf\u7a0b\u8ba9\u51faCPU\uff0c\u7136\u540e\u8f6c\u79fb\u5230\u4e0d\u540c\u7684CPU\u4e0a\uff0c\u4e4b\u524d\u8fd4\u56de\u7684\u503c\u5c06\u4e0d\u518d\u6b63\u786e\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0cxv6\u8981\u6c42\u8c03\u7528\u8005\u7981\u7528\u4e2d\u65ad\uff0c\u53ea\u6709\u5728\u4f7f\u7528\u5b8c\u8fd4\u56de\u7684cpu\u7ed3\u6784\u540e\u624d\u542f\u7528\u4e2d\u65ad\u3002(\u5373\u4e3a\u4e86\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0c\u8c03\u7528cpuid\u548cmycpu\u65f6\uff0c\u9700\u8981\u7981\u7528\u4e2d\u65ad)\n\n**myproc**(kernel/proc.c:68)\u51fd\u6570\u8fd4\u56de\u5f53\u524dCPU\u4e0a\u8fd0\u884c\u7684\u8fdb\u7a0b\u7684**proc**\u6307\u9488\u3002**myproc**\u7981\u7528\u4e2d\u65ad\uff0c\u8c03\u7528**mycpu**\uff0c\u4ece**struct** **cpu**\u4e2d\u83b7\u53d6\u5f53\u524d\u8fdb\u7a0b\u6307\u9488(**c-&gt;proc**)\uff0c\u7136\u540e\u542f\u7528\u4e2d\u65ad\u3002\u5373\u4f7f\u542f\u7528\u4e86\u4e2d\u65ad\uff0c**myproc**\u7684\u8fd4\u56de\u503c\u4e5f\u53ef\u4ee5\u5b89\u5168\u4f7f\u7528\uff1a\u5982\u679c\u5b9a\u65f6\u5668\u4e2d\u65ad\u5c06\u8c03\u7528\u8fdb\u7a0b\u79fb\u5230\u4e86\u53e6\u4e00\u4e2a\u7684CPU\u4e0a\uff0c\u5b83\u7684**proc**\u7ed3\u6784\u6307\u9488\u5c06\u4fdd\u6301\u4e0d\u53d8\u3002\n\n### 7.5 Sleep and wakeup\n\n\u8c03\u5ea6\u548c\u9501\u6709\u52a9\u4e8e\u8ba9\u4e00\u4e2a\u8fdb\u7a0b\u5bf9\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u7684\u4e0d\u53ef\u89c1\uff0c\u4f46\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u5e2e\u52a9\u8fdb\u7a0b\u8fdb\u884c\u4ea4\u4e92\u7684\u62bd\u8c61\u3002\u4eba\u4eec\u53d1\u660e\u4e86\u8bb8\u591a\u673a\u5236\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002Xv6\u4f7f\u7528\u4e86\u4e00\u79cd\u53eb\u505a\u7761\u7720\u548c\u5524\u9192\u7684\u673a\u5236\uff0c\u5b83\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u7761\u7720\u5e76\u7b49\u5f85\u4e8b\u4ef6\uff0c\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u5728\u8be5\u4e8b\u4ef6\u53d1\u751f\u540e\u5c06\u5176\u5524\u9192\u3002\u7761\u7720\u548c\u5524\u9192\u901a\u5e38\u88ab\u79f0\u4e3a***\u5e8f\u5217\u534f\u8c03\uff08sequence coordination\uff09*** \u6216***\u6761\u4ef6\u540c\u6b65\uff08conditional synchronization\uff09*** \u673a\u5236\u3002\n\n\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e00\u70b9\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u4e00\u4e2a\u53eb\u505a***\u4fe1\u53f7\u91cf\uff08semaphore\uff09***[4]\u7684\u540c\u6b65\u673a\u5236\uff0c\u5b83\u534f\u8c03\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u3002\u4fe1\u53f7\u91cf\u7ef4\u62a4\u4e00\u4e2a\u8ba1\u6570\u5e76\u63d0\u4f9b\u4e24\u4e2a\u64cd\u4f5c\u3002V\u64cd\u4f5c\uff08\u9488\u5bf9\u751f\u4ea7\u8005\uff09\u589e\u52a0\u8ba1\u6570\u3002P\u64cd\u4f5c\uff08\u9488\u5bf9\u6d88\u8d39\u8005\uff09\u7b49\u5f85\uff0c\u76f4\u5230\u8ba1\u6570\u975e\u96f6\uff0c\u7136\u540e\u5c06\u5176\u9012\u51cf\u5e76\u8fd4\u56de\u3002\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u751f\u4ea7\u8005\u7ebf\u7a0b\u548c\u4e00\u4e2a\u6d88\u8d39\u8005\u7ebf\u7a0b\uff0c\u800c\u4e14\u5b83\u4eec\u5728\u4e0d\u540c\u7684CPU\u4e0a\u6267\u884c\uff0c\u7f16\u8bd1\u5668\u4e5f\u6ca1\u6709\u592a\u8fc7\u6fc0\u8fdb\u7684\u4f18\u5316\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5b9e\u73b0\u662f\u6b63\u786e\u7684\u3002\n\n``` c\nstruct semaphore\n{\n  struct spinlock lock;\n  int count;\n};\n\nvoid V(struct semaphore *s)\n{\n  acquire(&amp;s-&gt;lock);\n  s-&gt;count += 1;\n  release(&amp;s-&gt;lock);\n}\n\nvoid P(struct semaphore *s)\n{\n  while (s-&gt;count == 0)\n    ;\n  acquire(&amp;s-&gt;lock);\n  s-&gt;count -= 1;\n  release(&amp;s-&gt;lock);\n}\n</code></pre></p> <p>\u4e0a\u9762\u7684\u5b9e\u73b0\u662f\u4ee3\u4ef7\u5f88\u5927\u3002\u5982\u679c\u751f\u4ea7\u8005\u5f88\u5c11\u751f\u4ea7\uff0c\u6d88\u8d39\u8005\u5c06\u628a\u5927\u90e8\u5206\u65f6\u95f4\u82b1\u5728while\u5faa\u73af\u4e2d\uff0c\u5e0c\u671b\u5f97\u5230\u4e00\u4e2a\u975e\u96f6\u7684\u8ba1\u6570\u3002\u6d88\u8d39\u8005\u7684CPU\u53ef\u4ee5\u901a\u8fc7\u53cd\u590d***\u8f6e\u8be2(polling)*** **s-&gt;count**\u53ef\u4ee5\u627e\u5230\u6bd4***\u5fd9\u788c\u7b49\u5f85(busy waiting)***\u66f4\u6709\u6548\u7684\u5de5\u4f5c\u3002\u907f\u514d***\u5fd9\u788c\u7b49\u5f85***\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\uff0c\u8ba9\u6d88\u8d39\u8005\u8ba9\u51faCPU\uff0c\u53ea\u6709\u5728**V**\u589e\u52a0\u8ba1\u6570\u540e\u624d\u6062\u590d\u3002</p> <p>\u8fd9\u91cc\u662f\u671d\u7740\u8fd9\u4e2a\u65b9\u5411\u8fc8\u51fa\u7684\u4e00\u6b65\uff0c\u867d\u7136\u4ed6\u4e0d\u80fd\u5b8c\u5168\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u8ba9\u6211\u4eec\u60f3\u8c61\u4e00\u5bf9\u8c03\u7528\uff0csleep**\u548c**wakeup\uff0c\u5176\u5de5\u4f5c\u539f\u7406\u5982\u4e0b\u3002Sleep(chan)**\u7761\u7720**chan**\u4e0a\uff0c**chan**\u53ef\u4ee5\u4e3a\u4efb\u610f\u503c\uff0c\u79f0\u4e3a***\u7b49\u5f85\u901a\u9053(wait channel)*\u3002Sleep**\u4f7f\u8c03\u7528\u8fdb\u7a0b\u8fdb\u5165\u7761\u7720\u72b6\u6001\uff0c\u91ca\u653eCPU\u8fdb\u884c\u5176\u4ed6\u5de5\u4f5c\u3002**Wakeup(chan)**\u5524\u9192\u6240\u6709\u5728**chan**\u4e0a**sleep**\u7684\u8fdb\u7a0b\uff08\u5982\u679c\u6709\u7684\u8bdd\uff09\uff0c\u4f7f\u5b83\u4eec\u7684**sleep**\u8c03\u7528\u8fd4\u56de\u3002\u5982\u679c\u6ca1\u6709\u8fdb\u7a0b\u5728**chan**\u4e0a\u7b49\u5f85\uff0c\u5219**wakeup**\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\u3002\u6211\u4eec\u4fee\u6539\u4fe1\u53f7\u91cf\u5b9e\u73b0\uff0c\u4ee5\u4f7f\u7528**sleep**\u548c**wakeup\uff08\u4fee\u6539\u5904\u7528\u6ce8\u91ca\u6807\u6ce8\uff09\u3002</p> C<pre><code>void V(struct semaphore *s)\n{\n  acquire(&amp;s-&gt;lock);\n  s-&gt;count += 1;\n  wakeup(s);            // \u4fee\u6539\n  release(&amp;s-&gt;lock);\n}\n\nvoid P(struct semaphore *s)\n{\n  while (s-&gt;count == 0)\n    sleep(s);           // \u4fee\u6539\n  acquire(&amp;s-&gt;lock);\n  s-&gt;count -= 1;\n  release(&amp;s-&gt;lock);\n}\n</code></pre> <p>P\u73b0\u5728\u653e\u5f03CPU\u800c\u4e0d\u662f\u81ea\u65cb\uff0c\u8fd9\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u6539\u8fdb\u3002\u7136\u800c\uff0c\u4e8b\u5b9e\u8bc1\u660e\uff0c\u50cf\u8fd9\u6837\u8bbe\u8ba1**sleep**\u548c**wakeup**\u5e76\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\uff0c\u56e0\u4e3a\u5b83\u4f1a\u9047\u5230\u6240\u8c13\u7684\u4e22\u5931\u5524\u9192\u95ee\u9898\u3002\u5047\u8bbe\u6267\u884cP \u7684**s-&gt;count == 0**\u8fd9\u4e00\u884c\u65f6\u3002\u5f53P\u5728**sleep**\u4e4b\u524d\uff0cV\u5728\u53e6\u4e00\u4e2aCPU\u4e0a\u8fd0\u884c\uff1a\u5b83\u5c06**s-&gt;count**\u6539\u4e3a\u975e\u96f6\uff0c\u5e76\u8c03\u7528**wakeup**\uff0cwakeup**\u53d1\u73b0\u6ca1\u6709\u8fdb\u7a0b\u5728\u7761\u7720\uff0c\u56e0\u6b64\u4ec0\u4e48\u4e5f\u4e0d\u505a\u3002\u73b0\u5728P\u7ee7\u7eed\u6267\u884c\uff1a\u5b83\u8c03\u7528**sleep**\u5e76\u8fdb\u5165\u7761\u7720\u72b6\u6001\u3002\u8fd9\u5c31\u9020\u6210\u4e86\u4e00\u4e2a\u95ee\u9898\uff1aP\u6b63\u5728**sleep\uff0c\u7b49\u5f85\u4e00\u4e2a\u5df2\u7ecf\u53d1\u751f\u7684V\u8c03\u7528\u3002\u9664\u975e\u6211\u4eec\u8fd0\u6c14\u597d\uff0c\u751f\u4ea7\u8005\u518d\u6b21\u8c03\u7528V\uff0c\u5426\u5219\u6d88\u8d39\u8005\u5c06\u6c38\u8fdc\u7b49\u5f85\uff0c\u5373\u4f7f\u8ba1\u6570\u662f\u975e\u96f6\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u6839\u6e90\u5728\u4e8e\uff0c\u5728\u9519\u8bef\u7684\u65f6\u523b\u8fd0\u884c\u7684V\u8fdd\u53cd\u4e86P\u53ea\u5728<code>s-&gt;count==0</code>\u65f6\u4f11\u7720\u7684\u4e0d\u53d8\u91cf\u3002\u4fdd\u62a4\u8fd9\u4e2a\u4e0d\u53d8\u91cf\u7684\u4e00\u4e2a\u4e0d\u6b63\u786e\u7684\u65b9\u6cd5\u662f\u5c06\u9501\u83b7\u53d6\uff08\u4fee\u6539\u7528\u6ce8\u91ca\u6807\u6ce8\uff09\u79fb\u52a8\u5230P\u4e2d\uff0c\u8fd9\u6837\u5b83\u5bf9\u8ba1\u6570\u7684\u68c0\u67e5\u548c\u5bf9sleep\u7684\u8c03\u7528\u662f\u539f\u5b50\u7684\uff1a</p> C<pre><code>void\nV(struct semaphore *s)\n{\n    acquire(&amp;s-&gt;lock);\n    s-&gt;count += 1;\n    wakeup(s);\n    release(&amp;s-&gt;lock);\n}\n\nvoid\nP(struct semaphore *s)\n{\n    acquire(&amp;s-&gt;lock);      // \u4fee\u6539\n    while(s-&gt;count == 0)\n        sleep(s);\n    s-&gt;count -= 1;\n    release(&amp;s-&gt;lock);\n}\n</code></pre> <p>\u4eba\u4eec\u53ef\u80fd\u5e0c\u671b\u8fd9\u4e2a\u7248\u672c\u7684P\u80fd\u591f\u907f\u514d\u4e22\u5931\u7684\u5524\u9192\uff0c\u56e0\u4e3a\u9501\u4f1a\u963b\u6b62V\u5728**s-&gt;count == 0**\u548csleep\u4e4b\u95f4\u6267\u884c\u3002\u5b83\u505a\u5230\u4e86\u8fd9\u4e00\u70b9\uff0c\u4f46\u5b83\u4e5f\u4f1a\u6b7b\u9501\u3002P\u5728**sleep**\u65f6\u4fdd\u6301\u7740\u9501\uff0c\u6240\u4ee5V\u5c06\u6c38\u8fdc\u963b\u585e\u5728\u7b49\u5f85\u9501\u7684\u8fc7\u7a0b\u4e2d\u3002</p> <p>\u6211\u4eec\u5c06\u901a\u8fc7\u6539\u53d8**sleep**\u7684\u63a5\u53e3\u6765\u4fee\u6b63\u524d\u9762\u7684\u65b9\u6848\uff1a\u8c03\u7528\u8005\u5fc5\u987b\u5c06***\u6761\u4ef6\u9501(condition lock)***\u4f20\u9012\u7ed9**sleep**\uff0c\u8fd9\u6837\u5728\u8c03\u7528\u8fdb\u7a0b\u88ab\u6807\u8bb0\u4e3a***SLEEPING***\u5e76\u5728chan\u4e0a\u7b49\u5f85\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u91ca\u653e\u9501\u3002\u9501\u5c06\u5f3a\u5236\u5e76\u53d1\u7684V\u7b49\u5f85\u76f4\u5230P\u5c06\u81ea\u5df1\u7f6e\u4e8e***SLEEPING***\u72b6\u6001\uff0c\u8fd9\u6837**wakeup**\u5c31\u4f1a\u53d1\u73b0***SLEEPING***\u7684\u6d88\u8d39\u8005\u5e76\u5c06\u5176\u5524\u9192\u3002\u4e00\u65e6\u6d88\u8d39\u8005\u518d\u6b21\u88ab\u5524\u9192\uff0c**sleep**\u5c31\u4f1a\u91cd\u65b0\u83b7\u5f97\u9501\uff0c\u7136\u540e\u518d\u8fd4\u56de\u3002\u6211\u4eec\u65b0\u7684\u6b63\u786e\u7684\u7761\u7720/\u5524\u9192\u65b9\u6848\u662f\u53ef\u7528\u7684\uff0c\u5982\u4e0b\u6240\u793a\uff08\u4fee\u6539\u7528\u6ce8\u91ca\u6807\u6ce8\uff09\u3002</p> C<pre><code>void\nP(struct semaphore *s)\n{\n    acquire(&amp;s-&gt;lock);\n    while(s-&gt;count == 0)\n        sleep(s, &amp;s-&gt;lock); // \u4fee\u6539\n    s-&gt;count -= 1;\n    release(&amp;s-&gt;lock);\n}\n</code></pre> <p>P\u6301\u6709**s-&gt;lock**\u4f1a\u963b\u6b62\u4e86V\u5728P\u68c0\u67e5**c-&gt;count**\u548c\u8c03\u7528**sleep**\u4e4b\u95f4\u8bd5\u56fe\u5524\u9192\u5b83\u3002\u4f46\u662f\uff0c\u8bf7\u6ce8\u610f\uff0c\u6211\u4eec\u9700\u8981**sleep**\u6765\u539f\u5b50\u5730\u91ca\u653e**s-&gt;lock**\u5e76\u4f7f\u6d88\u8d39\u8005\u8fdb\u7a0b\u8fdb\u5165***SLEEPING***\u72b6\u6001\u3002</p>"},{"location":"os/Chapter-7/#76-code-sleep-and-wakeup","title":"7.6 Code: Sleep and wakeup","text":"<p>\u8ba9\u6211\u4eec\u770b\u770b**sleep (kernel/proc.c:548)** \u548c wakeup (kernel/proc.c:582) \u7684\u5b9e\u73b0\u3002\u5176\u57fa\u672c\u601d\u60f3\u662f\u8ba9**sleep**\u5c06\u5f53\u524d\u8fdb\u7a0b\u6807\u8bb0\u4e3a**SLEEPING**\uff0c\u7136\u540e\u8c03\u7528**sched**\u8ba9\u51fa**CPU**\uff1bwakeup**\u5219\u5bfb\u627e\u7ed9\u5b9a\u7684***\u7b49\u5f85\u901a\u9053***\u4e0a\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u5e76\u5c06\u5176\u6807\u8bb0\u4e3a**RUNNABLE\u3002sleep**\u548c**wakeup**\u7684\u8c03\u7528\u8005\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u65b9\u4fbf\u7684\u6570\u5b57\u4f5c\u4e3a**channel\u3002Xv6\u7ecf\u5e38\u4f7f\u7528\u53c2\u4e0e\u7b49\u5f85\u7684\u5185\u6838\u6570\u636e\u7ed3\u6784\u7684\u5730\u5740\u3002</p> <p>Sleep**\u9996\u5148\u83b7\u53d6**p-&gt;lock (kernel/proc.c:559)\u3002\u73b0\u5728\u8fdb\u5165\u7761\u7720\u72b6\u6001\u7684\u8fdb\u7a0b\u540c\u65f6\u6301\u6709**p-&gt;lock**\u548c**lk**\u3002\u5728\u8c03\u7528\u8005(\u5728\u672c\u4f8b\u4e2d\u4e3aP)\u4e2d\uff0c\u6301\u6709**lk**\u662f\u5fc5\u8981\u7684\uff1a\u5b83\u4fdd\u8bc1\u4e86\u6ca1\u6709\u5176\u4ed6\u8fdb\u7a0b(\u5728\u672c\u4f8b\u4e2d\uff0c\u8fd0\u884cV\u7684\u8fdb\u7a0b)\u53ef\u4ee5\u8c03\u7528**wakeup(chan)\u3002\u73b0\u5728**sleep**\u6301\u6709**p-&gt;lock\uff0c\u91ca\u653e**lk**\u662f\u5b89\u5168\u7684\uff1a\u5176\u4ed6\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u8c03\u7528**wakeup(chan)\uff0c\u4f46**wakeup**\u4f1a\u7b49\u5f85\u83b7\u5f97**p-&gt;lock\uff0c\u56e0\u6b64\u4f1a\u7b49\u5230**sleep**\u5c06\u8fdb\u7a0b\u72b6\u6001\u8bbe\u7f6e\u4e3a**SLEEPING**\uff0c\u4f7f**wakeup**\u4e0d\u4f1a\u9519\u8fc7**sleep**\u7684\u8fdb\u7a0b\u3002</p> <p>\u6709\u4e00\u4e2a\u590d\u6742\u60c5\u51b5\uff1a\u5982\u679c**lk**\u548c**p-&gt;lock**\u662f\u540c\u4e00\u4e2a\u9501\uff0c\u5982\u679c**sleep**\u4ecd\u8bd5\u56fe\u83b7\u53d6**p-&gt;lock**\uff0c\u5c31\u4f1a\u548c\u81ea\u5df1\u6b7b\u9501\u3002\u4f46\u662f\u5982\u679c\u8c03\u7528**sleep**\u7684\u8fdb\u7a0b\u5df2\u7ecf\u6301\u6709**p-&gt;lock**\uff0c\u90a3\u4e48\u5b83\u5c31\u4e0d\u9700\u8981\u518d\u505a\u4efb\u4f55\u4e8b\u60c5\u6765\u907f\u514d\u9519\u8fc7\u4e00\u4e2a\u5e76\u53d1\u7684**wakeup**\u3002\u8fd9\u6837\u7684\u60c5\u51b5\u53d1\u751f\u5728\uff0c**wait (kernel/proc.c:582)**\u8c03\u7528**sleep**\u5e76\u6301\u6709**p-&gt;lock**\u65f6\u3002</p> <p>\u73b0\u5728**sleep**\u6301\u6709**p-&gt;lock**\uff0c\u800c\u6ca1\u6709\u5176\u4ed6\u7684\u9501\uff0c\u5b83\u53ef\u4ee5\u901a\u8fc7\u8bb0\u5f55\u5b83\u7761\u7720\u7684**channel**\uff0c\u5c06\u8fdb\u7a0b\u72b6\u6001\u8bbe\u7f6e**SLEEPING**\uff0c\u5e76\u8c03\u7528**sched**(kernel/proc.c:564-567)\u6765\u4f7f\u8fdb\u7a0b\u8fdb\u5165\u7761\u7720\u72b6\u6001\u3002\u7a0d\u540e\u6211\u4eec\u5c31\u4f1a\u660e\u767d\u4e3a\u4ec0\u4e48\u5728\u8fdb\u7a0b\u88ab\u6807\u8bb0\u4e3a**SLEEPING**\u4e4b\u524d\uff0c**p-&gt;lock**\u4e0d\u4f1a\u88ab\u91ca\u653e\uff08\u7531\u8c03\u5ea6\u5668\uff09\u3002</p> <p>\u5728\u67d0\u4e9b\u65f6\u5019\uff0c\u4e00\u4e2a\u8fdb\u7a0b\u5c06\u83b7\u53d6\u6761\u4ef6\u9501\uff0c\u8bbe\u7f6e\u7761\u7720\u7b49\u5f85\u7684\u6761\u4ef6\uff0c\u5e76\u8c03\u7528**wakeup(chan)\u3002\u91cd\u8981\u7684\u662f\uff0c**wakeup**\u662f\u5728\u6301\u6709\u6761\u4ef6\u9501[2]\u7684\u60c5\u51b5\u4e0b\u88ab\u8c03\u7528\u7684\u3002**Wakeup**\u5faa\u73af\u6d4f\u89c8\u8fdb\u7a0b\u8868\uff08kernel/proc.c:582\uff09\u3002\u5b83\u83b7\u53d6\u6bcf\u4e2a\u88ab\u68c0\u67e5\u7684\u8fdb\u7a0b\u7684**p-&gt;lock\uff0c\u56e0\u4e3a\u5b83\u53ef\u80fd\u4f1a\u4fee\u6539\u8be5\u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u4e5f\u56e0\u4e3a**p-&gt;sleep**\u786e\u4fdd**sleep**\u548c**wakeup**\u4e0d\u4f1a\u76f8\u4e92\u9519\u8fc7\u3002\u5f53**wakeup**\u53d1\u73b0\u4e00\u4e2a\u8fdb\u7a0b\u5904\u4e8e\u72b6\u6001\u4e3a**SLEEPING**\u5e76\u6709\u4e00\u4e2a\u5339\u914d\u7684**chan**\u65f6\uff0c\u5b83\u5c31\u4f1a\u5c06\u8be5\u8fdb\u7a0b\u7684\u72b6\u6001\u6539\u4e3a**RUNNABLE**\u3002\u4e0b\u4e00\u6b21\u8c03\u5ea6\u5668\u8fd0\u884c\u65f6\uff0c\u5c31\u4f1a\u770b\u5230\u8fd9\u4e2a\u8fdb\u7a0b\u5df2\u7ecf\u51c6\u5907\u597d\u8fd0\u884c\u4e86\u3002</p> <p>\u4e3a\u4ec0\u4e48**sleep**\u548c**wakeup**\u7684\u9501\u89c4\u5219\u80fd\u4fdd\u8bc1\u7761\u7720\u7684\u8fdb\u7a0b\u4e0d\u4f1a\u9519\u8fc7**wakeup**\uff1f**sleep**\u8fdb\u7a0b\u4ece\u68c0\u67e5\u6761\u4ef6\u4e4b\u524d\u5230\u6807\u8bb0\u4e3a**SLEEPING**\u4e4b\u540e\u7684\u8fd9\u6bb5\u65f6\u95f4\u91cc\uff0c\u6301\u6709\u6761\u4ef6\u9501\u6216\u5b83\u81ea\u5df1\u7684**p-&gt;lock**\u6216\u4e24\u8005\u90fd\u6301\u6709\u3002\u8c03\u7528**wakeup**\u7684\u8fdb\u7a0b\u5728**wakeup**\u7684\u5faa\u73af\u4e2d\u6301\u6709\u8fd9\u4e24\u4e2a\u9501\u3002\u56e0\u6b64\uff0c\u5524\u9192\u8005\u8981\u4e48\u5728\u6d88\u8d39\u8005\u68c0\u67e5\u6761\u4ef6\u4e4b\u524d\u4f7f\u6761\u4ef6\u4e3a\u771f\uff1b\u8981\u4e48\u5524\u9192\u8005\u7684**wakeup**\u5728\u6d88\u8d39\u8005\u88ab\u6807\u8bb0\u4e3a**SLEEPING**\u4e4b\u540e\u68c0\u67e5\u5b83\u3002 \u65e0\u8bba\u600e\u6837\uff0c**wakeup**\u5c31\u4f1a\u770b\u5230\u8fd9\u4e2a\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u5e76\u5c06\u5176\u5524\u9192\uff08\u9664\u975e\u6709\u5176\u4ed6\u4e8b\u60c5\u5148\u5c06\u5176\u5524\u9192\uff09\u3002</p> <p>\u6709\u65f6\u4f1a\u51fa\u73b0\u591a\u4e2a\u8fdb\u7a0b\u5728\u540c\u4e00\u4e2a**channel**\u4e0a\u7761\u7720\u7684\u60c5\u51b5\uff1b\u4f8b\u5982\uff0c\u6709\u591a\u4e2a\u8fdb\u7a0b\u4ece\u7ba1\u9053\u4e2d\u8bfb\u53d6\u6570\u636e\u3002\u8c03\u7528\u4e00\u6b21**wakeup**\u5c31\u4f1a\u628a\u5b83\u4eec\u5168\u90e8\u5524\u9192\u3002\u5176\u4e2d\u4e00\u4e2a\u8fdb\u7a0b\u5c06\u9996\u5148\u8fd0\u884c\uff0c\u5e76\u83b7\u5f97**sleep**\u53c2\u6570\u4f20\u9012\u7684\u9501\uff0c\uff08\u5c31\u7ba1\u9053\u800c\u8a00\uff09\u8bfb\u53d6\u6570\u636e\u90fd\u4f1a\u5728\u7ba1\u9053\u4e2d\u7b49\u5f85\u3002\u5176\u4ed6\u8fdb\u7a0b\u4f1a\u53d1\u73b0\uff0c\u5c3d\u7ba1\u88ab\u5524\u9192\u4e86\uff0c\u4f46\u6ca1\u6709\u6570\u636e\u53ef\u8bfb\u3002\u4ece\u4ed6\u4eec\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5524\u9192\u662f\u201c\u865a\u5047\u7684\u201c\uff0c\u4ed6\u4eec\u5fc5\u987b\u518d\u6b21\u7761\u7720\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0\uff0c**sleep**\u603b\u662f\u5728\u4e00\u4e2a\u68c0\u67e5\u6761\u4ef6\u7684\u5faa\u73af\u4e2d\u88ab\u8c03\u7528\u3002</p> <p>\u5982\u679c\u4e24\u6b21\u4f7f\u7528**sleep/wakeup**\u4e0d\u5c0f\u5fc3\u9009\u62e9\u4e86\u540c\u4e00\u4e2a\u901a\u9053\uff0c\u4e5f\u4e0d\u4f1a\u6709\u5bb3\uff1a\u5b83\u4eec\u4f1a\u770b\u5230\u865a\u5047\u7684\u5524\u9192\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u5faa\u73af\u5141\u8bb8\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\u3002sleep/**wakeup**\u7684\u9b45\u529b\u5f88\u5927\u7a0b\u5ea6\u4e0a\u5728\u4e8e\u5b83\u65e2\u662f\u8f7b\u91cf\u7ea7\u7684\uff08\u4e0d\u9700\u8981\u521b\u5efa\u7279\u6b8a\u7684\u6570\u636e\u7ed3\u6784\u6765\u5145\u5f53\u7761\u7720\u901a\u9053\uff09\uff0c\u53c8\u63d0\u4f9b\u4e86\u4e00\u5c42\u95f4\u63a5\u6027\uff08\u8c03\u7528\u8005\u4e0d\u9700\u8981\u77e5\u9053\u4ed6\u4eec\u6b63\u5728\u4e0e\u54ea\u4e2a\u5177\u4f53\u7684\u8fdb\u7a0b\u4ea4\u4e92\uff09\u3002</p>"},{"location":"os/Chapter-7/#77-code-pipes","title":"7.7 Code: Pipes","text":"<p>\u4e00\u4e2a\u4f7f\u7528**sleep**\u548c**wakeup**\u6765\u540c\u6b65\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\u7684\u66f4\u590d\u6742\u7684\u4f8b\u5b50\u662fxv6\u7684\u7ba1\u9053\u5b9e\u73b0\u3002\u6211\u4eec\u5728\u7b2c1\u7ae0\u770b\u5230\u4e86\u7ba1\u9053\u7684\u63a5\u53e3\uff1a\u5199\u5165\u7ba1\u9053\u4e00\u7aef\u7684\u5b57\u8282\u88ab\u590d\u5236\u5230\u5185\u6838\u7f13\u51b2\u533a\uff0c\u7136\u540e\u53ef\u4ee5\u4ece\u7ba1\u9053\u7684\u53e6\u4e00\u7aef\u8bfb\u53d6\u3002\u672a\u6765\u7684\u7ae0\u8282\u5c06\u7814\u7a76\u7ba1\u9053\u5982\u4f55\u652f\u6301\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f46\u6211\u4eec\u73b0\u5728\u6765\u770b\u4e00\u4e0b**pipewrite**\u548c**piperead**\u7684\u5b9e\u73b0\u5427\u3002</p> <p>\u6bcf\u4e2a\u7ba1\u9053\u7531\u4e00\u4e2a\u7ed3\u6784\u4f53 pipe**\u8868\u793a\uff0c\u5b83\u5305\u542b\u4e00\u4e2a\u9501\u548c\u4e00\u4e2a\u6570\u636e\u7f13\u51b2\u533a\u3002**nread**\u548c**nwrite**\u4e24\u4e2a\u5b57\u6bb5\u7edf\u8ba1\u4ece\u7f13\u51b2\u533a\u8bfb\u53d6\u548c\u5199\u5165\u7684\u5b57\u8282\u603b\u6570\u3002\u7f13\u51b2\u533a\u5448\u73af\u5f62\uff1a**buf[PIPESIZE-1]**\u4e4b\u540e\u5199\u5165\u7684\u4e0b\u4e00\u4e2a\u5b57\u8282\u662f**buf[0]\u3002\u8ba1\u6570\u4e0d\u5448\u73af\u5f62\u3002\u8fd9\u4e2a\u7ea6\u5b9a\u4f7f\u5f97\u5b9e\u73b0\u53ef\u4ee5\u533a\u5206\u6ee1\u7f13\u51b2\u533a(nwrite == nread+PIPESIZE)\u548c\u7a7a\u7f13\u51b2\u533a(nwrite == nread)\uff0c\u4f46\u8fd9\u610f\u5473\u7740\u5bf9\u7f13\u51b2\u533a\u7684\u7d22\u5f15\u5fc5\u987b\u4f7f\u7528**buf[nread % PIPESIZE]\uff0c\u800c\u4e0d\u662f\u4f7f\u7528**buf[nread](**nwrite**\u4e5f\u662f\u5982\u6b64)\u3002</p> <p>\u5047\u8bbe\u5bf9**piperead**\u548c**pipewrite**\u7684\u8c03\u7528\u540c\u65f6\u53d1\u751f\u5728\u4e24\u4e2a\u4e0d\u540c\u7684CPU\u4e0a\u3002Pipewrite (kernel/pipe.c:77)**\u9996\u5148\u83b7\u53d6\u7ba1\u9053\u7684\u9501\uff0c\u5b83\u4fdd\u62a4\u4e86\u8ba1\u6570\u3001\u6570\u636e\u548c\u76f8\u5173\u7684\u4e0d\u53d8\u5f0f\u3002\u7136\u540e\uff0c**Piperead (kernel/pipe.c:103)**\u4e5f\u8bd5\u56fe\u83b7\u53d6\u8fd9\u4e2a\u9501\uff0c\u4f46\u662f\u4e0d\u4f1a\u83b7\u53d6\u6210\u529f\u3002\u5b83\u5728**acquire(kernel/spinlock.c:22)**\u4e2d\u5faa\u73af\uff0c\u7b49\u5f85\u9501\u7684\u5230\u6765\u3002\u5f53**piperead**\u7b49\u5f85\u65f6\uff0c**pipewrite**\u4f1a\u5faa\u73af\u5199\uff0c\u4f9d\u6b21\u5c06\u6bcf\u4e2a\u5b57\u8282\u6dfb\u52a0\u5230\u7ba1\u9053\u4e2d(kernel/pipe.c:95)\u3002\u5728\u8fd9\u4e2a\u5faa\u73af\u4e2d\uff0c\u53ef\u80fd\u4f1a\u53d1\u751f\u7f13\u51b2\u533a\u88ab\u586b\u6ee1\u7684\u60c5\u51b5(kernel/pipe.c:85)\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c**pipewrite**\u8c03\u7528**wakeup**\u6765\u63d0\u9192\u6240\u6709\u7761\u7720\u4e2d\u7684reader\u6709\u6570\u636e\u5728\u7f13\u51b2\u533a\u4e2d\u7b49\u5f85\uff0c\u7136\u540e\u5728&amp;pi-&gt;nwrite**\u4e0a**sleep**\uff0c\u7b49\u5f85reader\u4ece\u7f13\u51b2\u533a\u4e2d\u53d6\u51fa\u4e00\u4e9b\u5b57\u8282\u3002Sleep**\u51fd\u6570\u5185\u4f1a\u91ca\u653e**pi-&gt;lock\uff0c\u7136\u540e**pipwrite**\u8fdb\u7a0b\u7761\u7720\u3002</p> <p>\u73b0\u5728**pi-&gt;lock**\u53ef\u7528\u4e86\uff0cpiperead**\u8bbe\u6cd5\u83b7\u53d6\u5b83\u5e76\u8fdb\u5165\u5b83\u7684\u4e34\u754c\u533a\uff1a\u5b83\u53d1\u73b0**pi-&gt;nread != pi-&gt;nwrite (kernel/pipe.c:110) (pipewrite**\u8fdb\u5165\u7761\u7720\u72b6\u6001\u662f\u7531\u4e8e**pi-&gt;nwrite == pi-&gt;nread+PIPESIZE (kernel/pipe.c:85))\uff0c\u6240\u4ee5\u5b83\u8fdb\u5165for\u5faa\u73af\uff0c\u5c06\u6570\u636e\u4ece\u7ba1\u9053\u4e2d\u590d\u5236\u51fa\u6765**(kernel/pipe.c:117)\uff0c\u5e76\u6309\u590d\u5236\u7684\u5b57\u8282\u6570\u589e\u52a0**nread\u3002\u73b0\u5728\u53c8\u53ef\u5199\u4e86\uff0c\u6240\u4ee5 piperead \u5728\u8fd4\u56de\u4e4b\u524d\u8c03\u7528 wakeup (kernel/pipe.c:124) \u6765\u5524\u9192\u5728\u7761\u7720\u7684writer\u3002Wakeup**\u627e\u5230\u4e00\u4e2a\u5728&amp;pi-&gt;nwrite**\u4e0a\u7761\u7720\u7684\u8fdb\u7a0b\uff0c\u8fd9\u4e2a\u8fdb\u7a0b\u6b63\u5728\u8fd0\u884c**pipewrite**\uff0c\u4f46\u5728\u7f13\u51b2\u533a\u586b\u6ee1\u65f6\u505c\u6b62\u4e86\u3002\u5b83\u5c06\u8be5\u8fdb\u7a0b\u6807\u8bb0\u4e3a**RUNNABLE**\u3002</p> <p>\u7ba1\u9053\u4ee3\u7801\u5bf9reader\u548cwriter\u5206\u522b\u4f7f\u7528\u4e0d\u540c\u7684\u7761\u7720**channel**\uff08pi-&gt;nread**\u548c**pi-&gt;nwrite\uff09\uff1b\u8fd9\u53ef\u80fd\u4f1a\u4f7f\u7cfb\u7edf\u5728\u6709\u591a\u4e2areader\u548cwriter\u7b49\u5f85\u540c\u4e00\u4e2a\u7ba1\u9053\u7684\u60c5\u51b5\u4e0b\u66f4\u6709\u6548\u7387\u3002\u7ba1\u9053\u4ee3\u7801\u5728\u5faa\u73af\u5185sleep\uff0c\u68c0\u67e5sleep\u6761\u4ef6\uff1b\u5982\u679c\u6709\u591a\u4e2areader \u548c writer\uff0c\u9664\u4e86\u7b2c\u4e00\u4e2a\u88ab\u5524\u9192\u7684\u8fdb\u7a0b\u5916\uff0c\u5176\u4ed6\u8fdb\u7a0b\u90fd\u4f1a\u770b\u5230\u6761\u4ef6\u4ecd\u7136\u662f\u5047\u7684\uff0c\u7136\u540e\u518d\u6b21\u7761\u7720\u3002</p>"},{"location":"os/Chapter-7/#78-code-wait-exit-and-kill","title":"7.8 Code: Wait, exit, and kill","text":"<p>sleep**\u548c**wakeup**\u53ef\u4ee5\u7528\u4e8e\u8bb8\u591a\u79cd\u9700\u8981\u7b49\u5f85\u7684\u60c5\u51b5\u3002\u5728\u7b2c1\u7ae0\u4e2d\u4ecb\u7ecd\u7684\u4e00\u4e2a\u6709\u8da3\u7684\u4f8b\u5b50\u662f\uff0c\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u7684**exit**\u548c\u5176\u7236\u8fdb\u7a0b\u7684**wait**\u4e4b\u95f4\u7684\u4ea4\u4e92\u3002\u5728\u5b50\u8fdb\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u7236\u8fdb\u7a0b\u53ef\u80fd\u5df2\u7ecf\u5728**wait**\u4e2d\u7761\u7720\u4e86\uff0c\u4e5f\u53ef\u80fd\u5728\u505a\u522b\u7684\u4e8b\u60c5\uff1b\u5728\u540e\u4e00\u79cd\u60c5\u51b5\u4e0b\uff0c\u540e\u7eed\u7684**wait**\u8c03\u7528\u5fc5\u987b\u89c2\u5bdf\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\uff0c\u4e5f\u8bb8\u662f\u5728\u5b83\u8c03\u7528**exit**\u4e4b\u540e\u5f88\u4e45\u3002xv6\u5728**wait**\u89c2\u5bdf\u5230\u5b50\u8fdb\u7a0b\u9000\u51fa\u4e4b\u524d\uff0c\u8bb0\u5f55\u5b50\u8fdb\u7a0b\u9000\u51fa\u7684\u65b9\u5f0f\u662f\u8ba9**exit**\u5c06\u8c03\u7528\u8fdb\u7a0b\u8bbe\u7f6e\u4e3a**ZOMBIE**\u72b6\u6001\uff0c\u5728\u90a3\u91cc\u505c\u7559\uff0c\u76f4\u5230\u7236\u8fdb\u7a0b\u7684**wait**\u6ce8\u610f\u5230\u5b83\uff0c\u5c06\u5b50\u8fdb\u7a0b\u7684\u72b6\u6001\u6539\u4e3a**UNUSED\uff0c\u7136\u540e\u590d\u5236\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u72b6\u6001\uff0c\u5e76\u5c06\u5b50\u8fdb\u7a0b\u7684\u8fdb\u7a0bID\u8fd4\u56de\u7ed9\u7236\u8fdb\u7a0b\u3002\u5982\u679c\u7236\u8fdb\u7a0b\u6bd4\u5b50\u8fdb\u7a0b\u5148\u9000\u51fa\uff0c\u7236\u8fdb\u7a0b\u5c31\u628a\u5b50\u8fdb\u7a0b\u4ea4\u7ed9**init**\u8fdb\u7a0b\uff0c\u800c**init**\u8fdb\u7a0b\u5219\u5faa\u73af\u7684\u8c03\u7528**wait**\uff1b\u8fd9\u6837\u6bcf\u4e2a\u5b50\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u201c\u7236\u8fdb\u7a0b\u201d\u6765\u6e05\u7406\u3002\u4e3b\u8981\u7684\u5b9e\u73b0\u6311\u6218\u662f\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u7684**wait**\u548c**exit**\uff0c\u4ee5\u53ca**exit**\u548c**exit**\u4e4b\u95f4\u53ef\u80fd\u51fa\u73b0\u7ade\u4e89\u548c\u6b7b\u9501\u7684\u60c5\u51b5\u3002</p> <p>Wait**\u4f7f\u7528*\u8c03\u7528\u8fdb\u7a0b* \u7684**p-&gt;lock**\u4f5c\u4e3a\u6761\u4ef6\u9501\uff0c\u4ee5\u907f\u514d\u5524\u9192\u4e22\u5931\uff0c\u5b83\u5728\u5f00\u59cb\u65f6\u83b7\u53d6\u8be5\u9501\uff08kernel/proc.c:398\uff09\u3002\u7136\u540e\u5b83\u626b\u63cf\u8fdb\u7a0b\u8868\u3002\u5982\u679c\u5b83\u53d1\u73b0\u4e00\u4e2a\u5904\u4e8e**ZOMBIE**\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff0c\u5b83\u91ca\u653e\u8fd9\u4e2a\u5b50\u8fdb\u7a0b\u7684\u8d44\u6e90\u548c\u5b83\u7684**proc**\u7ed3\u6784\uff0c\u5c06\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u72b6\u6001\u590d\u5236\u5230\u63d0\u4f9b\u7ed9**wait**\u7684\u5730\u5740(\u5982\u679c\u5b83\u4e0d\u662f0)\uff0c\u5e76\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684ID\u3002\u5982\u679c**wait**\u627e\u5230\u4e86\u5b50\u8fdb\u7a0b\u4f46\u6ca1\u6709\u4e00\u4e2a\u9000\u51fa\uff0c\u5b83\u8c03\u7528**sleep**\u7b49\u5f85\u5176\u4e2d\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u9000\u51fa(kernel/proc.c:445)\uff0c\u7136\u540e\u518d\u6b21\u626b\u63cf\u3002\u8fd9\u91cc\uff0c\u5728**sleep**\u4e2d\u91ca\u653e\u7684\u6761\u4ef6\u9501\u662f\u7b49\u5f85\u8fdb\u7a0b\u7684**p-&gt;lock\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u7279\u6b8a\u60c5\u51b5\u3002\u8bf7\u6ce8\u610f\uff0c**wait**\u7ecf\u5e38\u6301\u6709\u4e24\u4e2a\u9501\uff1b\u5b83\u5728\u8bd5\u56fe\u83b7\u53d6\u4efb\u4f55\u5b50\u9501\u4e4b\u524d\uff0c\u4f1a\u5148\u83b7\u53d6\u81ea\u5df1\u7684\u9501\uff1b\u56e0\u6b64xv6\u7684\u6240\u6709\u9501\u90fd\u5fc5\u987b\u9075\u5b88\u76f8\u540c\u7684\u9501\u987a\u5e8f\uff08\u7236\u8fdb\u7a0b\u7684\u9501\uff0c\u7136\u540e\u662f\u5b50\u8fdb\u7a0b\u7684\u9501\uff09\uff0c\u4ee5\u907f\u514d\u6b7b\u9501\u3002</p> <p>Wait**\u4f1a\u67e5\u770b\u6bcf\u4e2a\u8fdb\u7a0b\u7684**np-&gt;parent**\u6765\u5bfb\u627e\u5b83\u7684\u5b50\u8fdb\u7a0b\u3002\u5b83\u4f7f\u7528 **np-&gt;parent \u800c\u4e0d\u6301\u6709 np-&gt;lock\uff0c\u8fd9\u8fdd\u53cd\u4e86\u5171\u4eab\u53d8\u91cf\u5fc5\u987b\u53d7\u9501\u4fdd\u62a4\u7684\u901a\u5e38\u89c4\u5219\u3002\u4f46\u662f**np**\u6709\u53ef\u80fd\u662f\u5f53\u524d\u8fdb\u7a0b\u7684\u7956\u5148\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u83b7\u53d6**np-&gt;lock**\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6b7b\u9501\uff0c\u56e0\u4e3a\u8fd9\u8fdd\u53cd\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u987a\u5e8f\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5728\u6ca1\u6709\u9501\u7684\u60c5\u51b5\u4e0b\u68c0\u67e5**np-&gt;parent**\u4f3c\u4e4e\u662f\u5b89\u5168\u7684\uff1b\u4e00\u4e2a\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u5b57\u6bb5\u53ea\u6709\u201c\u7236\u4eb2\u201c\u6539\u53d8\uff0c\u6240\u4ee5\u5982\u679c**np-&gt;parent==p**\u4e3a\u771f\uff0c\u9664\u975e\u5f53\u524d\u8fdb\u7a0b\u6539\u53d8\u5b83\uff0c\u5426\u5219\u8be5\u503c\u5c31\u4e0d\u4f1a\u6539\u53d8\u3002</p> <p>Exit (kernel/proc.c:333)**\u8bb0\u5f55\u9000\u51fa\u72b6\u6001\uff0c\u91ca\u653e\u4e00\u4e9b\u8d44\u6e90\uff0c\u5c06\u6240\u6709\u5b50\u8fdb\u7a0b\u4ea4\u7ed9**init**\u8fdb\u7a0b\uff0c\u5728\u7236\u8fdb\u7a0b\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\u65f6\u5524\u9192\u5b83\uff0c\u5c06*\u8c03\u7528\u8fdb\u7a0b*\u6807\u8bb0\u4e3a**zombie\uff0c\u5e76\u6c38\u4e45\u653e\u5f03CPU\u3002\u6700\u540e\u7684\u5e8f\u5217\u6709\u70b9\u68d8\u624b\u3002\u9000\u51fa\u7684\u8fdb\u7a0b\u5fc5\u987b\u6301\u6709\u7236\u8fdb\u7a0b\u7684\u9501\uff0c\u540c\u65f6\u5c06\u81ea\u5df1\u72b6\u6001\u8bbe\u7f6e\u4e3a**ZOMBIE**\u5e76\u5524\u9192\u7236\u8fdb\u7a0b\uff0c\u56e0\u4e3a\u7236\u8fdb\u7a0b\u7684\u9501\u662f\u6761\u4ef6\u9501\uff0c\u53ef\u4ee5\u9632\u6b62\u5728\u7b49\u5f85\u4e2d\u4e22\u5931**wakeup**\u3002\u5b50\u8fdb\u7a0b\u4e5f\u5fc5\u987b\u6301\u6709\u81ea\u5df1\u7684**p-&gt;lock**\uff0c\u5426\u5219\u7236\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u770b\u5230\u5b83\u7684\u72b6\u6001\u4e3a**ZOMBIE**\uff0c\u5e76\u5728\u5b83\u8fd8\u5728\u8fd0\u884c\u65f6\u91ca\u653e\u5b83\u3002\u9501\u7684\u83b7\u53d6\u987a\u5e8f\u5bf9\u907f\u514d\u6b7b\u9501\u5f88\u91cd\u8981\uff1a\u56e0\u4e3a**wait**\u5728\u5b50\u9501\u4e4b\u524d\u83b7\u53d6\u7236\u9501\uff0c\u6240\u4ee5**exit**\u5fc5\u987b\u4f7f\u7528\u76f8\u540c\u7684\u987a\u5e8f\u3002</p> <p>Exit \u8c03\u7528\u4e86\u4e00\u4e2a\u4e13\u95e8\u7684\u5524\u9192\u51fd\u6570 wakeup1\uff0c\u5b83\u53ea\u5524\u9192\u7236\u51fd\u6570\uff0c\u800c\u4e14\u53ea\u6709\u7236\u8fdb\u7a0b\u5728**wait**\u4e2d\u7761\u7720\u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u53bb\u5524\u9192\u5b83**(kernel/proc.c:598)\u3002\u5728\u5c06\u81ea\u5df1\u7684\u72b6\u6001\u8bbe\u7f6e\u4e3a**ZOMBIE**\u4e4b\u524d\uff0c\u5524\u9192\u7236\u8fdb\u7a0b\u53ef\u80fd\u770b\u8d77\u6765\u5e76\u4e0d\u6b63\u786e\uff0c\u4f46\u8fd9\u662f\u5b89\u5168\u7684\uff1a\u5c3d\u7ba1**wakeup1**\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7236\u8fdb\u7a0b\u8fd0\u884c\uff0c\u4f46**wait**\u4e2d\u7684\u5faa\u73af\u4e0d\u80fd\u68c0\u67e5\u5b50\u8fdb\u7a0b\uff0c\u76f4\u5230\u5b50\u8fdb\u7a0b\u7684**p-&gt;lock**\u88ab\u8c03\u5ea6\u5668\u91ca\u653e\u4e3a\u6b62\uff0c\u6240\u4ee5**wait**\u4e0d\u80fd\u67e5\u770b\u9000\u51fa\u7684\u8fdb\u7a0b\uff0c\u76f4\u5230**exit**\u5c06\u5176\u72b6\u6001\u8bbe\u7f6e\u4e3a**ZOMBIE**\u4e4b\u540e(kernel/proc.c:386)**\u3002</p> <p>exit**\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u81ea\u884c\u7ec8\u6b62\uff0c\u800c**kill\uff08kernel/proc.c:611\uff09**\u5219\u5141\u8bb8\u4e00\u4e2a\u8fdb\u7a0b\u8bf7\u6c42\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u7ec8\u6b62\u3002\u5982\u679c\u8ba9**kill**\u76f4\u63a5\u6467\u6bc1\u8fdb\u7a0b\uff0c\u90a3\u5c31\u592a\u590d\u6742\u4e86\uff0c\u56e0\u4e3a\u76f8\u5e94\u8fdb\u7a0b\u53ef\u80fd\u5728\u53e6\u4e00\u4e2aCPU\u4e0a\u6267\u884c\uff0c\u4e5f\u8bb8\u6b63\u5904\u4e8e\u66f4\u65b0\u5185\u6838\u6570\u636e\u7ed3\u6784\u7684\u654f\u611f\u5e8f\u5217\u4e2d\u3002\u56e0\u6b64\uff0ckill\u7684\u4f5c\u7528\u5f88\u5c0f\uff1a\u5b83\u53ea\u662f\u8bbe\u7f6e\u8fdb\u7a0b\u7684**p-&gt;killed\uff0c\u5982\u679c\u5b83\u5728**sleep**\uff0c\u5219**wakeup**\u5b83\u3002\u6700\u7ec8\uff0c\u8fdb\u7a0b\u4f1a\u8fdb\u5165\u6216\u79bb\u5f00\u5185\u6838\uff0c\u8fd9\u65f6\u5982\u679c**p-&gt;killed**\u88ab\u8bbe\u7f6e\uff0cusertrap**\u4e2d\u7684\u4ee3\u7801\u4f1a\u8c03\u7528**exit\u3002\u5982\u679c\u8fdb\u7a0b\u5728\u7528\u6237\u7a7a\u95f4\u8fd0\u884c\uff0c\u5b83\u5c06\u5f88\u5feb\u901a\u8fc7\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u6216\u56e0\u4e3a\u5b9a\u65f6\u5668\uff08\u6216\u5176\u4ed6\u8bbe\u5907\uff09\u4e2d\u65ad\u800c\u8fdb\u5165\u5185\u6838\u3002</p> <p>\u5982\u679c\u8fdb\u7a0b\u5904\u4e8e\u7761\u7720\u72b6\u6001\uff0ckill**\u8c03\u7528**wakeup**\u4f1a\u4f7f\u8fdb\u7a0b\u4ece\u7761\u7720\u4e2d\u8fd4\u56de\u3002\u8fd9\u662f\u6f5c\u5728\u7684\u5371\u9669\uff0c\u56e0\u4e3a\u6b63\u5728\u7b49\u5f85\u7684\u6761\u4ef6\u53ef\u80fd\u4e0d\u4e3a\u771f\u3002\u7136\u800c\uff0cxv6\u5bf9**sleep**\u7684\u8c03\u7528\u603b\u662f\u88ab\u5305\u88f9\u5728\u4e00\u4e2a**while**\u5faa\u73af\u4e2d\uff0c\u5728**sleep**\u8fd4\u56de\u540e\u91cd\u65b0\u68c0\u6d4b\u6761\u4ef6\u3002\u4e00\u4e9b\u5bf9**sleep**\u7684\u8c03\u7528\u4e5f\u4f1a\u5728\u5faa\u73af\u4e2d\u68c0\u6d4b**p-&gt;killed\uff0c\u5982\u679c\u8bbe\u7f6e\u4e86**p-&gt;killed**\uff0c\u5219\u79bb\u5f00\u5f53\u524d\u6d3b\u52a8\u3002\u53ea\u6709\u5f53\u8fd9\u79cd\u79bb\u5f00\u662f\u6b63\u786e\u7684\u65f6\u5019\u624d\u4f1a\u8fd9\u6837\u505a\u3002\u4f8b\u5982\uff0c\u7ba1\u9053\u8bfb\u5199\u4ee3\u7801\u5982\u679c\u8bbe\u7f6e\u4e86**killed**\u6807\u5fd7\u5c31\u4f1a\u8fd4\u56de\uff1b\u6700\u7ec8\u4ee3\u7801\u4f1a\u8fd4\u56de\u5230**trap**\uff0c**trap**\u4f1a\u518d\u6b21\u68c0\u67e5\u6807\u5fd7\u5e76\u9000\u51fa\u3002</p> <p>\u4e00\u4e9bxv6 sleep**\u5faa\u73af\u6ca1\u6709\u68c0\u67e5**p-&gt;killed\uff0c\u56e0\u4e3a\u4ee3\u7801\u5904\u4e8e\u591a\u6b65\u9aa4\u7cfb\u7edf\u8c03\u7528\u7684\u4e2d\u95f4\uff0c\u800c\u8fd9\u4e2a\u8c03\u7528\u5e94\u8be5\u662f\u539f\u5b50\u7684\u3002virtio\u9a71\u52a8**(kernel/virtio_disk.c:242)\u5c31\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a\u5b83\u6ca1\u6709\u68c0\u67e5**p-&gt;killed\uff0c\u56e0\u4e3a\u78c1\u76d8\u64cd\u4f5c\u53ef\u80fd\u662f\u4e00\u7cfb\u5217\u5199\u64cd\u4f5c\u4e2d\u7684\u4e00\u4e2a\uff0c\u800c\u8fd9\u4e9b\u5199\u64cd\u4f5c\u90fd\u662f\u4e3a\u4e86\u8ba9\u6587\u4ef6\u7cfb\u7edf\u5904\u4e8e\u4e00\u4e2a\u6b63\u786e\u7684\u72b6\u6001\u800c\u9700\u8981\u7684\u3002\u4e00\u4e2a\u5728\u7b49\u5f85\u78c1\u76d8I/O\u65f6\u88ab\u6740\u6b7b\u7684\u8fdb\u7a0b\u4e0d\u4f1a\u9000\u51fa\uff0c\u76f4\u5230\u5b83\u5b8c\u6210\u5f53\u524d\u7684\u7cfb\u7edf\u8c03\u7528\u548c**usertrap**\u770b\u5230**killed**\u7684\u6807\u5fd7\u3002</p>"},{"location":"os/Chapter-7/#79-real-world","title":"7.9 Real world","text":"<p>xv6 \u8c03\u5ea6\u5668\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u8c03\u5ea6\u7b56\u7565\uff0c\u5b83\u4f9d\u6b21\u8fd0\u884c\u6bcf\u4e2a\u8fdb\u7a0b\u3002\u8fd9\u79cd\u7b56\u7565\u88ab\u79f0\u4e3a***\u8f6e\u8be2\u8c03\u5ea6(round robin)\u3002\u771f\u6b63\u7684\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u73b0\u4e86\u66f4\u590d\u6742\u7684\u7b56\u7565\uff0c\u4f8b\u5982\uff0c\u5141\u8bb8\u8fdb\u7a0b\u6709\u4f18\u5148\u7ea7\u3002\u8fd9\u4e2a\u7b56\u7565\u662f\uff0c\u4e00\u4e2a\u53ef\u8fd0\u884c\u7684\u9ad8\u4f18\u5148\u7ea7\u8fdb\u7a0b\u5c06\u88ab\u8c03\u5ea6\u5668\u4f18\u5148\u4e8e\u4e00\u4e2a\u53ef\u8fd0\u884c\u7684\u4f4e\u4f18\u5148\u7ea7\u8fdb\u7a0b\u3002\u8fd9\u4e9b\u7b56\u7565\u53ef\u80fd\u4f1a\u5f88\u5feb\u53d8\u5f97\u590d\u6742\uff0c\u56e0\u4e3a\u7ecf\u5e38\u6709\u76f8\u4e92\u7ade\u4e89\u7684\u76ee\u6807\uff1a\u4f8b\u5982\uff0c\u64cd\u4f5c\u8005\u53ef\u80fd\u8fd8\u60f3\u4fdd\u8bc1\u516c\u5e73\u6027\u548c\u9ad8\u541e\u5410\u91cf\u3002\u6b64\u5916\uff0c\u590d\u6742\u7684\u7b56\u7565\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e0d\u5c3d\u4eba\u610f\u7684\u4ea4\u4e92\uff0c\u5982***\u4f18\u5148\u7ea7\u5012\u7f6e(priority inversion)***\u548c***\u62a4\u822a\u73b0\u8c61(convoys)\u3002\u5f53\u4f4e\u4f18\u5148\u7ea7\u548c\u9ad8\u4f18\u5148\u7ea7\u8fdb\u7a0b\u5171\u4eab\u4e00\u4e2a\u9501\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f\u4f18\u5148\u7ea7\u5012\u7f6e\uff0c\u5f53\u4f4e\u4f18\u5148\u7ea7\u8fdb\u7a0b\u83b7\u5f97\u9501\u65f6\uff0c\u5c31\u4f1a\u963b\u6b62\u9ad8\u4f18\u5148\u7ea7\u8fdb\u7a0b\u7684\u8fdb\u5c55\u3002\u5f53\u8bb8\u591a\u9ad8\u4f18\u5148\u7ea7\u8fdb\u7a0b\u90fd\u5728\u7b49\u5f85\u4e00\u4e2a\u83b7\u5f97\u5171\u4eab\u9501\u7684\u4f4e\u4f18\u5148\u7ea7\u8fdb\u7a0b\u65f6\uff0c\u5c31\u4f1a\u5f62\u6210\u4e00\u4e2a\u957f\u957f\u7684\u7b49\u5f85\u8fdb\u7a0b\u7684\u8f66\u961f\uff1b\u4e00\u65e6\u62a4\u822a\u73b0\u8c61\u5f62\u6210\uff0c\u5c31\u4f1a\u6301\u7eed\u5f88\u957f\u65f6\u95f4\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u7c7b\u95ee\u9898\uff0c\u5728\u590d\u6742\u7684\u8c03\u5ea6\u5668\u4e2d\u9700\u8981\u989d\u5916\u7684\u673a\u5236\u3002</p> <p>sleep**\u548c**wakeup**\u662f\u4e00\u79cd\u7b80\u5355\u6709\u6548\u7684\u540c\u6b65\u65b9\u6cd5\uff0c\u4f46\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u65b9\u6cd5\u3002\u5728\u6240\u6709\u8fd9\u4e9b\u65b9\u6cd5\u4e2d\uff0c\u7b2c\u4e00\u4e2a\u6311\u6218\u662f\u907f\u514d\u6211\u4eec\u5728\u672c\u7ae0\u5f00\u5934\u770b\u5230\u7684\u4e22\u5931\u5524\u9192\u95ee\u9898\u3002\u6700\u521d\u7684Unix\u5185\u6838\u7684**sleep**\u53ea\u662f\u7981\u7528\u4e86\u4e2d\u65ad\uff0c\u8fd9\u5df2\u7ecf\u8db3\u591f\u4e86\uff0c\u56e0\u4e3aUnix\u8fd0\u884c\u5728\u5355CPU\u7cfb\u7edf\u4e0a\u3002\u56e0\u4e3axv6\u8fd0\u884c\u5728\u591a\u5904\u7406\u5668\u4e0a\uff0c\u6240\u4ee5\u5b83\u589e\u52a0\u4e86\u4e00\u4e2a\u663e\u5f0f\u7684**sleep**\u9501\u3002FreeBSD \u7684 **msleep \u91c7\u7528\u4e86\u540c\u6837\u7684\u65b9\u6cd5\u3002Plan 9\u7684**sleep**\u4f7f\u7528\u4e86\u4e00\u4e2a\u56de\u8c03\u51fd\u6570\uff0c\u5b83\u5728\u8fdb\u5165\u7761\u7720\u524d\u4fdd\u6301\u8c03\u5ea6\u9501\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c\uff1b\u8fd9\u4e2a\u51fd\u6570\u7684\u4f5c\u7528\u662f\u5728\u6700\u540e\u4e00\u523b\u68c0\u67e5**sleep**\u60c5\u51b5\uff0c\u4ee5\u907f\u514d**wakeup**\u4e22\u5931\u3002Linux\u5185\u6838\u7684**sleep**\u4f7f\u7528\u4e00\u4e2a\u663e\u5f0f\u7684\u8fdb\u7a0b\u961f\u5217\uff0c\u79f0\u4e3a\u7b49\u5f85\u961f\u5217\uff0c\u800c\u4e0d\u662f\u7b49\u5f85\u901a\u9053\uff1b\u961f\u5217\u6709\u81ea\u5df1\u7684\u5185\u90e8\u9501\u3002</p> <p>\u5728**wakeup**\u8fc7\u7a0b\u4e2d\u626b\u63cf\u6574\u4e2a\u8fdb\u7a0b\u94fe\u8868\uff0c\u5bfb\u627e\u76f8\u5339\u914d\u7684**chan**\u7684\u8fdb\u7a0b\uff0c\u6548\u7387\u5f88\u4f4e\u3002\u4e00\u4e2a\u66f4\u597d\u7684\u89e3\u51b3\u65b9\u6848\u662f\u7528\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u4ee3\u66ff**sleep**\u548c**wakeup**\u4e2d\u7684**chan**\uff0c\u8be5\u7ed3\u6784\u4e0a\u5b58\u653e\u7740**sleep**\u7684\u8fdb\u7a0b\u5217\u8868\uff0c\u6bd4\u5982Linux\u7684\u7b49\u5f85\u961f\u5217\u3002Plan 9\u7684**sleep**\u548c**wakeup**\u5c06\u8be5\u7ed3\u6784\u79f0\u4e3arendezvous point\u6216Rendez\u3002\u8bb8\u591a\u7ebf\u7a0b\u5e93\u5c06\u540c\u4e00\u4e2a\u7ed3\u6784\u79f0\u4e3a\u6761\u4ef6\u53d8\u91cf\uff1b\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0csleep\u548cwakeup\u7684\u64cd\u4f5c\u88ab\u79f0\u4e3a**wait**\u548c**signal**\u3002\u6240\u6709\u8fd9\u4e9b\u673a\u5236\u90fd\u6709\u76f8\u540c\u7684\u673a\u5236\uff1a\u7761\u7720\u6761\u4ef6\u88ab\u7761\u7720\u8fc7\u7a0b\u4e2d\u539f\u5b50\u5730\u91ca\u653e\u7684\u9501\u4fdd\u62a4\u3002</p> <p>wakeup**\u5524\u9192\u4e86\u6240\u6709\u5728\u67d0\u4e2a\u7279\u5b9a**channel**\u4e0a\u7b49\u5f85\u7684\u8fdb\u7a0b\uff0c\u53ef\u80fd\u5f88\u591a\u8fdb\u7a0b\u90fd\u5728\u7b49\u5f85\u8fd9\u4e2a\u7279\u5b9a**channel\u3002\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u8c03\u5ea6\u6240\u6709\u8fd9\u4e9b\u8fdb\u7a0b\uff0c\u5b83\u4eec\u4f1a\u4e89\u76f8\u68c0\u67e5\u7761\u7720\u6761\u4ef6\u3002\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u884c\u4e8b\u7684\u8fdb\u7a0b\u6709\u65f6\u88ab\u79f0\u4e3a***\u60ca\u7fa4\u6548\u5e94\uff08thundering herd\uff09***\uff0c\u6700\u597d\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\u3002\u5927\u591a\u6570\u6761\u4ef6\u53d8\u91cf\u90fd\u6709\u4e24\u4e2a\u5524\u9192\u7684\u57fa\u5143\uff1a\u4fe1\u53f7\uff08signal\uff09\uff0c\u5524\u9192\u4e00\u4e2a\u8fdb\u7a0b\uff1b\u5e7f\u64ad\uff08broadcast\uff09\uff0c\u5524\u9192\u6240\u6709\u7b49\u5f85\u7684\u8fdb\u7a0b\u3002</p> <p>\u4fe1\u53f7\u91cf\u901a\u5e38\u7528\u4e8e\u540c\u6b65\u3002count\u901a\u5e38\u5bf9\u5e94\u4e8e\u7c7b\u4f3c\u4e8e\u7ba1\u9053\u7f13\u51b2\u533a\u4e2d\u53ef\u7528\u7684\u5b57\u8282\u6570\u6216\u4e00\u4e2a\u8fdb\u7a0b\u62e5\u6709\u7684\u50f5\u5c38\u5b50\u8fdb\u7a0b\u7684\u6570\u91cf\u3002\u4f7f\u7528\u663e\u5f0f\u8ba1\u6570\u4f5c\u4e3a\u62bd\u8c61\u7684\u4e00\u90e8\u5206\uff0c\u53ef\u4ee5\u907f\u514d\u4e22\u5931**wakeup**\u7684\u95ee\u9898\uff1a\u6709\u4e00\u4e2a\u663e\u5f0f\u7684\u8ba1\u6570\uff0c\u8bf4\u660e\u5df2\u7ecf\u53d1\u751f\u7684\u5524\u9192\u6b21\u6570\u3002\u8be5\u8ba1\u6570\u8fd8\u907f\u514d\u4e86\u201c\u865a\u5047\u7684\u201d\u5524\u9192\u548c***\u60ca\u7fa4\u6548\u5e94***\u95ee\u9898\u3002</p> <p>\u7ec8\u6b62\u8fdb\u7a0b\u548c\u6e05\u7406\u8fdb\u7a0b\u5728xv6\u4e2d\u5f15\u5165\u4e86\u5f88\u591a\u590d\u6742\u6027\u3002\u5728\u5927\u591a\u6570\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u5b83\u751a\u81f3\u66f4\u52a0\u590d\u6742\uff0c\u56e0\u4e3a\uff0c\u5047\u8bbe\u88ab\u6740\u8fdb\u7a0b\u53ef\u80fd**trap**\u5728\u5185\u6838\u4e2d\u7761\u7720\uff0c\u800c\u89e3\u9664\u5b83\u7684\u5806\u6808\u9700\u8981\u5f88\u591a\u4ed4\u7ec6\u7684\u7f16\u7a0b\u3002\u8bb8\u591a\u64cd\u4f5c\u7cfb\u7edf\u4f7f\u7528\u663e\u5f0f\u7684\u5f02\u5e38\u5904\u7406\u673a\u5236\u6765\u89e3\u9664\u5806\u6808\uff0c\u6bd4\u5982**longjmp**[3]\u3002\u6b64\u5916\uff0c\u8fd8\u6709\u5176\u4ed6\u4e00\u4e9b\u4e8b\u4ef6\u53ef\u4ee5\u5bfc\u81f4\u4e00\u4e2a\u7761\u7720\u8fdb\u7a0b\u88ab\u5524\u9192\uff0c\u5373\u4f7f\u5b83\u6b63\u5728\u7b49\u5f85\u7684\u4e8b\u4ef6\u8fd8\u6ca1\u6709\u53d1\u751f\u3002\u4f8b\u5982\uff0c\u5f53\u4e00\u4e2aUnix\u8fdb\u7a0b\u5904\u4e8e\u7761\u7720\u72b6\u6001\u65f6\uff0c\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u4f1a\u5411\u5b83\u53d1\u9001\u4e00\u4e2a**signal**\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8be5\u8fdb\u7a0b\u5c06\u4ece\u4e2d\u65ad\u7684\u7cfb\u7edf\u8c03\u7528\u4e2d\u8fd4\u56de\uff0c\u8fd4\u56de\u503c\u4e3a-1\uff0c\u9519\u8bef\u4ee3\u7801\u8bbe\u7f6e\u4e3a**EINTR**\u3002\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u68c0\u67e5\u8fd9\u4e9b\u503c\u5e76\u51b3\u5b9a\u505a\u4ec0\u4e48\u3002Xv6\u4e0d\u652f\u6301\u4fe1\u53f7\uff0c\u4e5f\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u590d\u6742\u6027\u3002</p> <p>Xv6\u5bf9**kill**\u7684\u652f\u6301\u5e76\u4e0d\u5b8c\u5168\u4ee4\u4eba\u6ee1\u610f\uff1a\u6709\u4e9b**sleep**\u5faa\u73af\u53ef\u80fd\u5e94\u8be5\u68c0\u67e5**p-&gt;killed**\u3002\u4e00\u4e2a\u76f8\u5173\u7684\u95ee\u9898\u662f\uff0c\u5373\u4f7f\u662f\u68c0\u67e5**p-&gt;killed**\u7684**sleep**\u5faa\u73af\uff0c\u5728**sleep**\u548c**kill**\u4e4b\u95f4\u4e5f\u4f1a\u6709\u4e00\u4e2a\u7ade\u4e89\uff1bkill**\u53ef\u80fd\u4f1a\u8bbe\u7f6e**p-&gt;killed\uff0c\u5e76\u8bd5\u56fe\u5524\u9192\u88ab\u6740\u8fdb\u7a0b\uff0c\u5524\u9192\u65f6\u523b\u53d1\u751f\u5728\u5faa\u73af\u68c0\u67e5**p-&gt;killed**\u4e4b\u540e\uff0c \u4f46\u5728\u5b83\u8c03\u7528**sleep**\u4e4b\u524d\uff0c\u5c31\u4f1a\u53d1\u751f\u3002\u5982\u679c\u8fd9\u4e2a\u95ee\u9898\u53d1\u751f\u4e86\uff0c\u88ab\u6740\u8fdb\u7a0b\u4e0d\u4f1a\u6ce8\u610f\u5230**p-&gt;killed**\uff0c\u76f4\u5230\u5b83\u6240\u7b49\u5f85\u7684\u6761\u4ef6\u53d1\u751f\u3002\u8fd9\u53ef\u80fd\u4f1a\u665a\u5f88\u591a\uff08\u4f8b\u5982\uff0c\u5f53virtio\u9a71\u52a8\u8fd4\u56de\u4e00\u4e2a\u88ab\u6740\u8fdb\u7a0b\u6b63\u5728\u7b49\u5f85\u7684\u78c1\u76d8\u5757\u65f6\uff09\uff0c\u4e5f\u53ef\u80fd\u6c38\u8fdc\u4e0d\u4f1a\u53d1\u751f\uff08\u4f8b\u5982\uff0c\u5982\u679c\u88ab\u6740\u8fdb\u7a0b\u6b63\u5728\u7b49\u5f85\u6765\u81ea\u63a7\u5236\u53f0\u7684\u8f93\u5165\uff0c\u4f46\u7528\u6237\u6ca1\u6709\u952e\u5165\u4efb\u4f55\u8f93\u5165\uff09\u3002</p> <p>\u771f\u6b63\u7684\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5728\u5e38\u6570\u65f6\u95f4\u5185\u7528\u663e\u5f0f\u7684\u7a7a\u95f2\u5217\u8868\u6765\u5bfb\u627e\u7a7a\u95f2\u7684\u8fdb\u7a0b\uff0c\u800c\u4e0d\u662f\u5728allocproc\u4e2d\u8fdb\u884c\u7ebf\u6027\u65f6\u95f4\u7684\u641c\u7d22\uff1bxv6\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u4f7f\u7528\u4e86\u7ebf\u6027\u626b\u63cf\u7684\u65b9\u5f0f\u3002</p>"},{"location":"os/Chapter-7/#710-exercises","title":"7.10 Exercises","text":"<ol> <li>Sleep\u5fc5\u987b\u68c0\u67e5lk != &amp; p-&gt;lock\u4ee5\u907f\u514d\u6b7b\u9501**(kernel/proc.c:558-561)**\u3002\u5047\u8bbe\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\u901a\u8fc7\u5c06</li> </ol> C<pre><code>if(lk != &amp;p-&gt;lock){\n     acquire(&amp;p-&gt;lock);\n     release(lk);\n}\n</code></pre> <p>\u66ff\u6362\u4e3a\uff1a</p> C<pre><code>release(lk);\nacquire(&amp;p-&gt;lock);\n</code></pre> <p>\u8fd9\u6837\u4f1a\u7834\u574fsleep\u5417\uff0c\u600e\u6837\u7834\u574f\u3002</p> <ol> <li> <p>\u5927\u90e8\u5206\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u8d44\u6e90\u6e05\u7406\u53ef\u4ee5\u901a\u8fc7**exit**\u6216**wait**\u6765\u5b8c\u6210\u3002\u4e8b\u5b9e\u8bc1\u660e\uff0c\u5173\u95ed\u6253\u5f00\u7684\u6587\u4ef6\u4e00\u5b9a\u8981\u5728**exit**\u4e2d\u8fdb\u884c\u3002\u4e3a\u4ec0\u4e48\uff1f\u7b54\u6848\u548c\u7ba1\u9053\u6709\u5173\u3002</p> </li> <li> <p>\u5728xv6\u4e2d\u5b9e\u73b0\u4fe1\u53f7\u91cf\u800c\u4e0d\u4f7f\u7528**sleep**\u548c**wakeup**(\u4f46\u53ef\u4ee5\u4f7f\u7528**spin** locks)\u3002\u5728xv6\u4e2d\u7528\u4fe1\u53f7\u91cf\u66ff\u6362**sleep**\u548c**wakeup**\u7684\u4f7f\u7528\u3002\u5224\u65ad\u7ed3\u679c\u3002</p> </li> <li> <p>\u4fee\u6b63\u4e0a\u9762\u63d0\u5230\u7684**kill**\u548c**sleep**\u4e4b\u95f4\u7684\u7ade\u4e89\uff0c\u4f7f\u5f97\u53d1\u751f\u5728\u88ab\u6740\u8fdb\u7a0b\u7761\u7720\u5faa\u73af\u68c0\u67e5p-&gt;killed\u4e4b\u540e\uff0c\u5728\u5b83\u8c03\u7528sleep\u4e4b\u524d\u7684kill\u4f1a\u4f7f\u5f97\u88ab\u6740\u8fdb\u7a0b\u653e\u5f03\u5f53\u524d\u7cfb\u7edf\u8c03\u7528\u3002</p> </li> <li> <p>\u8bbe\u8ba1\u4e00\u4e2a\u65b9\u6848\uff0c\u8ba9\u6bcf\u4e00\u4e2a\u7761\u7720\u5faa\u73af\u90fd\u68c0\u67e5**p-&gt;killed**\uff0c\u8fd9\u6837\uff0c\u5728**virtio**\u9a71\u52a8\u4e2d\u7684\u8fdb\u7a0b\u5982\u679c\u88ab\u5176\u4ed6\u8fdb\u7a0b\u6740\u6b7b\uff0c\u5c31\u53ef\u4ee5\u4ece**while**\u5faa\u73af\u4e2d\u5feb\u901f\u8fd4\u56de\u3002</p> </li> <li> <p>\u4fee\u6539xv6\uff0c\u5f53\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5185\u6838\u7ebf\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u65f6\uff0c\u53ea\u4f7f\u7528\u4e00\u6b21\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u800c\u4e0d\u662f\u5148\u5207\u6362\u5230\u8c03\u5ea6\u7ebf\u7a0b\uff0c\u518d\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002\u4f7f\u7528\u4e00\u6b21\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u4ea7\u751f\u7684\u7ebf\u7a0b\u9700\u8981\u81ea\u5df1\u9009\u62e9\u4e0b\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u5e76\u8c03\u7528**swtch**\u3002\u9762\u4e34\u7684\u6311\u6218\u5c06\u662f\u5982\u4f55\u9632\u6b62\u591a\u4e2a\u5185\u6838\u610f\u5916\u6267\u884c\u540c\u4e00\u4e2a\u7ebf\u7a0b\uff1b\u5982\u4f55\u6b63\u786e\u5730\u8fdb\u884c\u9501\u5b9a\uff1b\u4ee5\u53ca\u5982\u4f55\u907f\u514d\u6b7b\u9501\u3002</p> </li> <li> <p>\u4fee\u6539xv6\u7684\u8c03\u5ea6\u5668\uff0c\u5f53\u6ca1\u6709\u8fdb\u7a0b\u53ef\u8fd0\u884c\u65f6\uff0c\u4f7f\u7528RISC-V WFI\uff08\u7b49\u5f85\u4e2d\u65ad\uff09\u6307\u4ee4\u3002\u5c3d\u91cf\u4fdd\u8bc1\u53ea\u8981\u6709\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\u7b49\u5f85\u8fd0\u884c\uff0c\u5c31\u4e0d\u4f1a\u6709\u6838\u5fc3\u901a\u8fc7WFI\u8fdb\u884c\u6682\u505c\u3002</p> </li> <li> <p>\u9501**p-&gt;lock**\u4fdd\u62a4\u4e86\u5f88\u591a\u4e0d\u53d8\u5f0f\uff0c\u5f53\u770b\u5230\u67d0\u6bb5\u88ab**p-&gt;lock**\u4fdd\u62a4\u7684xv6\u4ee3\u7801\u65f6\uff0c\u53ef\u80fd\u5f88\u96be\u5f04\u6e05\u695a\u4fdd\u62a4\u4e86\u90a3\u4e2a\u4e0d\u53d8\u5f0f\u3002\u901a\u8fc7\u5c06**p-&gt;lock**\u62c6\u5206\u6210\u51e0\u4e2a\u9501\uff0c\u8bbe\u8ba1\u4e00\u4e2a\u66f4\u7b80\u6d01\u7684\u65b9\u6848\u3002</p> </li> </ol> <ol> <li> <p>ra\u5bc4\u5b58\u5668: \u51fd\u6570return\u5730\u5740\u3002</p> </li> <li> <p>\u4e25\u683c\u5730\u8bf4\uff0c\u53ea\u662f\u5728**acquire**\u4e4b\u540e**wakeup**\u5c31\u8db3\u591f\u4e86(\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ef\u4ee5\u5728**release**\u4e4b\u540e\u8c03\u7528**wakeup**)\u3002</p> </li> <li> <p>\u4e00\u79cd\u5f02\u5e38\u5904\u7406\u65b9\u5f0f\uff0c\u53ef\u4ee5\u53bbgoogle\u4e0b\u3002</p> </li> </ol>"},{"location":"os/Chapter-8/","title":"Chapter 8","text":""},{"location":"os/Chapter-8/#_1","title":"\u7b2c\u516b\u7ae0\uff1a\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u7684\u76ee\u7684\u662f\u7ec4\u7ec7\u548c\u5b58\u50a8\u6570\u636e\u3002\u6587\u4ef6\u7cfb\u7edf\u901a\u5e38\u652f\u6301\u7528\u6237\u548c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u6570\u636e\u5171\u4eab\uff0c\u4ee5\u53ca\u652f\u6301\u6301\u4e45\u6027\uff0c\u4ee5\u4fbf\u6570\u636e\u5728\u91cd\u542f\u540e\u4ecd\u7136\u53ef\u7528\u3002</p> <p>xv6\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u4e86\u7c7bUnix\u7684\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u8def\u5f84\u540d\uff08\u89c1\u7b2c1\u7ae0\uff09\uff0c\u5e76\u5c06\u5176\u6570\u636e\u5b58\u50a8\u5728virtio\u78c1\u76d8\u4e0a\u4ee5\u5b9e\u73b0\u6301\u4e45\u5316\uff08\u89c1\u7b2c4\u7ae0\uff09\u3002\u8be5\u6587\u4ef6\u7cfb\u7edf\u89e3\u51b3\u4e86\u51e0\u4e2a\u6311\u6218\uff1a</p> <ul> <li> <p>\u6587\u4ef6\u7cfb\u7edf\u9700\u8981\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u7ed3\u6784\u6765\u8868\u793a\u547d\u540d\u76ee\u5f55\u548c\u6587\u4ef6\u7684\u6811\uff0c\u8bb0\u5f55\u4fdd\u5b58\u6bcf\u4e2a\u6587\u4ef6\u5185\u5bb9\u7684\u5757\u7684\u8eab\u4efd\uff0c\u5e76\u8bb0\u5f55\u78c1\u76d8\u4e0a\u54ea\u4e9b\u533a\u57df\u662f\u7a7a\u95f2\u7684\u3002</p> </li> <li> <p>\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u652f\u6301\u5d29\u6e83\u6062\u590d\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u53d1\u751f\u5d29\u6e83\uff08\u5982\u7535\u6e90\u6545\u969c\uff09\uff0c\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u5728\u91cd\u65b0\u542f\u52a8\u540e\u4ecd\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002\u98ce\u9669\u5728\u4e8e\uff0c\u5d29\u6e83\u53ef\u80fd\u4f1a\u4e2d\u65ad\u66f4\u65b0\u5e8f\u5217\uff0c\u5e76\u5728\u78c1\u76d8\u4e0a\u7559\u4e0b\u4e0d\u4e00\u81f4\u7684\u6570\u636e\u7ed3\u6784\uff08\u4f8b\u5982\uff0c\u4e00\u4e2a\u5757\u65e2\u5728\u6587\u4ef6\u4e2d\u4f7f\u7528\uff0c\u53c8\u88ab\u6807\u8bb0\u4e3a\u7a7a\u95f2\uff09\u3002</p> </li> <li> <p>\u4e0d\u540c\u7684\u8fdb\u7a0b\u53ef\u80fd\u5e76\u53d1\u5728\u6587\u4ef6\u7cfb\u7edf\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u6587\u4ef6\u7cfb\u7edf\u4ee3\u7801\u5fc5\u987b\u534f\u8c03\u7ef4\u62a4\u6bcf\u4e00\u4e2a\u4e34\u754c\u533a\u3002</p> </li> <li> <p>\u8bbf\u95ee\u78c1\u76d8\u7684\u901f\u5ea6\u6bd4\u8bbf\u95ee\u5185\u5b58\u7684\u901f\u5ea6\u8981\u6162\u51e0\u4e2a\u6570\u91cf\u7ea7\uff0c\u6240\u4ee5\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u5728\u5185\u5b58\u7ef4\u62a4\u4e00\u4e2a\u7f13\u51b2\u533a\uff0c\u7528\u4e8e\u7f13\u5b58\u5e38\u7528\u5757\u3002</p> </li> </ul> <p>\u672c\u7ae0\u5269\u4e0b\u7684\u90e8\u5206\u5c06\u89e3\u91caxv6\u5982\u4f55\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u3002</p>"},{"location":"os/Chapter-8/#81-overview","title":"8.1 Overview","text":"<p>xv6\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u5206\u4e3a\u4e03\u5c42\uff0c\u5982\u56fe8.1\u6240\u793a\u3002disk\u5c42\u5728virtio\u78c1\u76d8\u4e0a\u8bfb\u5199\u5757\u3002Buffer cache\u7f13\u5b58\u78c1\u76d8\u5757\uff0c\u5e76\u540c\u6b65\u8bbf\u95ee\u5b83\u4eec\uff0c\u786e\u4fdd\u4e00\u4e2a\u5757\u53ea\u80fd\u540c\u65f6\u88ab\u5185\u6838\u4e2d\u7684\u4e00\u4e2a\u8fdb\u7a0b\u8bbf\u95ee\u3002\u65e5\u5fd7\u5c42\u5141\u8bb8\u4e0a\u5c42\u901a\u8fc7\u4e8b\u52a1\u66f4\u65b0\u591a\u4e2a\u78c1\u76d8\u5757\uff0c\u5e76\u786e\u4fdd\u5728\u5d29\u6e83\u65f6\uff0c\u78c1\u76d8\u5757\u662f\u539f\u5b50\u66f4\u65b0\u7684\uff08\u5373\u5168\u90e8\u66f4\u65b0\u6216\u4e0d\u66f4\u65b0\uff09\u3002inode\u5c42\u5c06\u4e00\u4e2a\u6587\u4ef6\u90fd\u8868\u793a\u4e3a\u4e00\u4e2a**inode**\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5305\u542b\u4e00\u4e2a\u552f\u4e00\u7684i-number\u548c\u4e00\u4e9b\u5b58\u653e\u6587\u4ef6\u6570\u636e\u7684\u5757\u3002\u76ee\u5f55\u5c42\u5c06\u5b9e\u73b0\u4e86\u4e00\u79cd\u7279\u6b8a\u7684**inode**\uff0c\u88ab\u79f0\u4e3a\u76ee\u5f55\uff0c\u5176\u5305\u542b\u4e00\u4e2a\u76ee\u5f55\u9879\u5e8f\u5217\uff0c\u6bcf\u4e2a\u76ee\u5f55\u9879\u7531\u6587\u4ef6\u540d\u79f0\u548ci-number\u7ec4\u6210\u3002\u8def\u5f84\u540d\u5c42\u63d0\u4f9b\u4e86\u5c42\u6b21\u5316\u7684\u8def\u5f84\u540d\uff0c\u5982/usr/rtm/xv6/fs.c\uff0c\u53ef\u4ee5\u7528\u9012\u5f52\u67e5\u627e\u89e3\u6790\u4ed6\u4eec\u3002\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c42\u7528\u6587\u4ef6\u7cfb\u7edf\u63a5\u53e3\u62bd\u8c61\u4e86\u8bb8\u591aUnix\u8d44\u6e90\uff08\u5982\u7ba1\u9053\u3001\u8bbe\u5907\u3001\u6587\u4ef6\u7b49\uff09\uff0c\u4f7f\u7a0b\u5e8f\u5458\u7684\u751f\u4ea7\u529b\u5f97\u5230\u5927\u5927\u7684\u63d0\u9ad8\u3002</p> <p></p> <p>\u6587\u4ef6\u7cfb\u7edf\u5fc5\u987b\u5b89\u6392\u597d\u78c1\u76d8\u5b58\u50a8inode\u548c\u5185\u5bb9\u5757\u7684\u4f4d\u7f6e\u3002\u4e3a\u6b64\uff0cxv6\u5c06\u78c1\u76d8\u5206\u4e3a\u51e0\u4e2a\u90e8\u5206\uff0c\u5982\u56fe8.2\u6240\u793a\u3002\u6587\u4ef6\u7cfb\u7edf\u4e0d\u4f7f\u7528\u57570\uff08\u5b83\u5b58\u653eboot sector\uff09\u3002\u7b2c1\u5757\u79f0\u4e3a***superblock***\uff0c\u5b83\u5305\u542b\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u5143\u6570\u636e\uff08\u4ee5\u5757\u4e3a\u5355\u4f4d\u7684\u6587\u4ef6\u7cfb\u7edf\u5927\u5c0f\u3001\u6570\u636e\u5757\u7684\u6570\u91cf\u3001inode\u7684\u6570\u91cf\u548c\u65e5\u5fd7\u4e2d\u7684\u5757\u6570\uff09\u3002\u4ece\u57572\u5f00\u59cb\u5b58\u653e\u7740\u65e5\u5fd7\u3002\u65e5\u5fd7\u4e4b\u540e\u662finodes\uff0c\u6bcf\u4e2a\u5757\u4f1a\u5305\u542b\u591a\u4e2ainode\u3002\u5728\u8fd9\u4e9b\u5757\u4e4b\u540e\u662f***\u4f4d\u56fe\u5757(bitmap)***\uff0c\u8bb0\u5f55\u54ea\u4e9b\u6570\u636e\u5757\u5728\u4f7f\u7528\u3002\u5176\u4f59\u7684\u5757\u662f\u6570\u636e\u5757\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u8981\u4e48\u5728bitmap\u5757\u4e2d\u6807\u8bb0\u4e3a\u7a7a\u95f2\uff0c\u8981\u4e48\u6301\u6709\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5185\u5bb9\u3002\u8d85\u7ea7\u5757\u7531\u4e00\u4e2a\u5355\u72ec\u7684\u7a0b\u5e8f**mkfs**\u5199\u5165\uff0c\u5b83\u5efa\u7acb\u4e86\u4e00\u4e2a\u521d\u59cb\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u672c\u7ae0\u7684\u5176\u4f59\u90e8\u5206\u5c06\u8ba8\u8bba\u6bcf\u4e00\u5c42\uff0c\u4ecebuffer\u7f13\u5b58\u5f00\u59cb\u3002\u4ece\u8ba8\u8bba\u4e2d\u6211\u4eec\u5c06\u770b\u5230\u5982\u4f55\u9009\u62e9\u5408\u9002\u7684\u4f4e\u5c42\u62bd\u8c61\uff0c\u6765\u65b9\u4fbf\u66f4\u9ad8\u5c42\u7684\u8bbe\u8ba1\u3002 </p>"},{"location":"os/Chapter-8/#82-buffer-cache-layer","title":"8.2 Buffer cache layer","text":"<p>buffer\u7f13\u5b58\u6709\u4e24\u9879\u5de5\u4f5c\u3002(1)\u540c\u6b65\u8bbf\u95ee\u78c1\u76d8\u5757\uff0c\u4ee5\u786e\u4fdd\u78c1\u76d8\u5757\u5728\u5185\u5b58\u4e2d\u53ea\u6709\u4e00\u4e2abuffer\u7f13\u5b58\uff0c\u5e76\u4e14\u4e00\u6b21\u53ea\u6709\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u80fd\u4f7f\u7528\u8be5buffer\u7f13\u5b58\uff1b(2)\u7f13\u5b58\u4f7f\u7528\u8f83\u591a\u7684\u5757\uff0c\u8fd9\u6837\u5b83\u4eec\u5c31\u4e0d\u9700\u8981\u4ece\u6162\u901f\u78c1\u76d8\u4e2d\u91cd\u65b0\u8bfb\u53d6\u3002\u4ee3\u7801\u89c1**bio.c**\u3002</p> <p>buffer\u7f13\u5b58\u7684\u4e3b\u8981\u63a5\u53e3\u5305\u62ec**bread**\u548c**bwrite**\uff0cbread\u8fd4\u56de\u4e00\u4e2a\u5728\u5185\u5b58\u4e2d\u53ef\u4ee5\u8bfb\u53d6\u548c\u4fee\u6539\u7684\u5757\u526f\u672c**buf**\uff0cbwrite**\u5c06\u4fee\u6539\u540e\u7684buffer\u5199\u5230\u78c1\u76d8\u4e0a\u76f8\u5e94\u7684\u5757\u3002\u5185\u6838\u7ebf\u7a0b\u5728\u4f7f\u7528\u5b8c\u4e00\u4e2abuffer\u540e\uff0c\u5fc5\u987b\u901a\u8fc7\u8c03\u7528**brelse**\u91ca\u653e\u5b83\u3002buffer\u7f13\u5b58\u4e3a\u6bcf\u4e2abuffer\u7684\u90fd\u8bbe\u6709sleep-lock\uff0c\u4ee5\u786e\u4fdd\u6bcf\u6b21\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f7f\u7528buffer\uff08\u4ece\u800c\u4f7f\u7528\u76f8\u5e94\u7684\u78c1\u76d8\u5757\uff09\uff1b**bread \u8fd4\u56de\u7684buffer\u4f1a\u88ab\u9501\u5b9a\uff0c\u800c**brelse**\u91ca\u653e\u9501\u3002</p> <p>\u6211\u4eec\u518d\u6765\u770b\u770bbuffer\u7f13\u5b58\u3002buffer\u7f13\u5b58\u6709\u56fa\u5b9a\u6570\u91cf\u7684buffer\u6765\u5b58\u653e\u78c1\u76d8\u5757\uff0c\u8fd9\u610f\u5473\u7740\u5982\u679c\u6587\u4ef6\u7cfb\u7edf\u9700\u8981\u4e00\u4e2a\u5c1a\u672a\u88ab\u7f13\u5b58\u7684\u5757\uff0cbuffer\u7f13\u5b58\u5fc5\u987b\u56de\u6536\u4e00\u4e2a\u5f53\u524d\u5b58\u653e\u5176\u4ed6\u5757\u7684buffer\u3002buffer\u7f13\u5b58\u4e3a\u65b0\u5757\u5bfb\u627e\u6700\u8fd1\u4f7f\u7528\u6700\u5c11\u7684buffer\uff08lru\u673a\u5236\uff09\u3002\u56e0\u4e3a\u6700\u8fd1\u4f7f\u7528\u6700\u5c11\u7684buffer\u662f\u6700\u4e0d\u53ef\u80fd\u88ab\u518d\u6b21\u4f7f\u7528\u7684buffer\u3002</p>"},{"location":"os/Chapter-8/#83-code-buffer-cache","title":"8.3 Code: Buffer cache","text":"<p>buffer\u7f13\u5b58\u662f\u4e00\u4e2a\u7531buffer\u7ec4\u6210\u7684\u53cc\u7aef\u94fe\u8868\u3002\u7531\u51fd\u6570**binit**\u7528\u9759\u6001\u6570\u7ec4**buf**\u521d\u59cb\u5316\u8fd9\u4e2a\u94fe\u8868\uff0c binit**\u5728\u542f\u52a8\u65f6\u7531**main(kernel/main.c:27)\u8c03\u7528\u3002\u8bbf\u95eebuffer\u7f13\u5b58\u662f\u901a\u8fc7\u94fe\u8868\uff0c\u800c\u4e0d\u662f**buf**\u6570\u7ec4\u3002</p> <p>buffer\u6709\u4e24\u4e2a\u4e0e\u4e4b\u76f8\u5173\u7684\u72b6\u6001\u5b57\u6bb5\u3002\u5b57\u6bb5**valid**\u8868\u793a\u662f\u5426\u5305\u542b\u8be5\u5757\u7684\u526f\u672c\uff08\u662f\u5426\u4ece\u78c1\u76d8\u8bfb\u53d6\u4e86\u6570\u636e\uff09\u3002\u5b57\u6bb5**disk**\u8868\u793a\u7f13\u51b2\u533a\u7684\u5185\u5bb9\u5df2\u7ecf\u88ab\u4fee\u6539\u9700\u8981\u88ab\u91cd\u65b0\u5199\u5165\u78c1\u76d8\u3002</p> <p>bget (kernel/bio.c:59)\u626b\u63cfbuffer\u94fe\u8868\uff0c\u5bfb\u627e\u7ed9\u5b9a\u8bbe\u5907\u53f7\u548c\u6247\u533a\u53f7\u6765\u67e5\u627e\u7f13\u51b2\u533a(kernel/bio.c:65-73)\u3002\u5982\u679c\u5b58\u5728\uff0c**bget**\u5c31\u4f1a\u83b7\u53d6\u8be5buffer\u7684sleep-lock\u3002\u7136\u540e**bget**\u8fd4\u56de\u88ab\u9501\u5b9a\u7684buffer\u3002</p> <p>\u5982\u679c\u7ed9\u5b9a\u7684\u6247\u533a\u6ca1\u6709\u7f13\u5b58\u7684buffer\uff0cbget**\u5fc5\u987b\u751f\u6210\u4e00\u4e2a\uff0c\u53ef\u80fd\u4f1a\u4f7f\u7528\u4e00\u4e2a\u5b58\u653e\u4e0d\u540c\u6247\u533a\u7684buffer\uff0c\u5b83\u518d\u6b21\u626b\u63cfbuffer\u94fe\u8868\uff0c\u5bfb\u627e\u6ca1\u6709\u88ab\u4f7f\u7528\u7684buffer(**b-&gt;refcnt = 0)\uff1b\u4efb\u4f55\u8fd9\u6837\u7684buffer\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002\u4efb\u4f55\u8fd9\u6837\u7684buffer\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002bget\u4fee\u6539buffer\u5143\u6570\u636e\uff0c\u8bb0\u5f55\u65b0\u7684\u8bbe\u5907\u53f7\u548c\u6247\u533a\u53f7\uff0c\u5e76\u83b7\u5f97\u5176sleep-lock\u3002\u8bf7\u6ce8\u610f\uff0c**b-&gt;valid = 0**\u53ef\u4ee5\u786e\u4fddbread\u4ece\u78c1\u76d8\u8bfb\u53d6\u5757\u6570\u636e\uff0c\u800c\u4e0d\u662f\u9519\u8bef\u5730\u4f7f\u7528buffer\u4e4b\u524d\u7684\u5185\u5bb9\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u6bcf\u4e2a\u78c1\u76d8\u6247\u533a\u6700\u591a\u53ea\u80fd\u6709\u4e00\u4e2abuffer\uff0c\u4ee5\u786e\u4fdd\u5199\u64cd\u4f5c\u5bf9\u8bfb\u53d6\u8005\u53ef\u89c1\uff0c\u4e5f\u56e0\u4e3a\u6587\u4ef6\u7cfb\u7edf\u9700\u8981\u4f7f\u7528buffer\u4e0a\u7684\u9501\u6765\u8fdb\u884c\u540c\u6b65\u3002Bget**\u901a\u8fc7\u4ece\u7b2c\u4e00\u6b21\u5faa\u73af\u68c0\u67e5\u5757\u662f\u5426\u88ab\u7f13\u5b58\uff0c\u7b2c\u4e8c\u6b21\u5faa\u73af\u6765\u751f\u6210\u4e00\u4e2a\u76f8\u5e94\u7684buffer\uff08\u901a\u8fc7\u8bbe\u7f6e**dev\u3001blockno**\u548c**refcnt\uff09\uff0c\u5728\u8fdb\u884c\u8fd9\u4e24\u6b65\u64cd\u4f5c\u65f6\uff0c\u9700\u8981\u4e00\u76f4\u6301\u6709**bache.lock** \u3002\u6301\u6709**bache.lock**\u4f1a\u4fdd\u8bc1\u4e0a\u9762\u4e24\u4e2a\u5faa\u73af\u5728\u6574\u4f53\u4e0a\u662f\u539f\u5b50\u7684\u3002</p> <p>**bget**\u5728**bcache.lock**\u4fdd\u62a4\u7684\u4e34\u754c\u533a\u4e4b\u5916\u83b7\u53d6buffer\u7684sleep-lock\u662f\u5b89\u5168\u7684\uff0c\u56e0\u4e3a\u975e\u96f6\u7684**b-&gt;refcnt**\u53ef\u4ee5\u9632\u6b62\u7f13\u51b2\u533a\u88ab\u91cd\u65b0\u7528\u4e8e\u4e0d\u540c\u7684\u78c1\u76d8\u5757\u3002sleep-lock\u4fdd\u62a4\u7684\u662f\u5757\u7684\u7f13\u51b2\u5185\u5bb9\u7684\u8bfb\u5199\uff0c\u800cbcache.lock\u4fdd\u62a4\u88ab\u7f13\u5b58\u5757\u7684\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u6240\u6709buffer\u90fd\u5728\u4f7f\u7528\uff0c\u90a3\u4e48\u592a\u591a\u7684\u8fdb\u7a0b\u540c\u65f6\u5728\u6267\u884c\u6587\u4ef6\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\uff0cbget\u5c31\u4f1a**panic**\u3002\u4e00\u4e2a\u66f4\u597d\u7684\u5904\u7406\u65b9\u5f0f\u53ef\u80fd\u662f\u7761\u7720\uff0c\u76f4\u5230\u6709buffer\u7a7a\u95f2\uff0c\u5c3d\u7ba1\u8fd9\u65f6\u6709\u53ef\u80fd\u51fa\u73b0\u6b7b\u9501\u3002</p> <p>\u4e00\u65e6**bread**\u8bfb\u53d6\u4e86\u78c1\u76d8\u5185\u5bb9\uff08\u5982\u679c\u9700\u8981\u7684\u8bdd\uff09\u5e76\u5c06\u7f13\u51b2\u533a\u8fd4\u56de\u7ed9\u5b83\u7684\u8c03\u7528\u8005\uff0c\u8c03\u7528\u8005\u5c31\u72ec\u5360\u8be5buffer\uff0c\u53ef\u4ee5\u8bfb\u53d6\u6216\u5199\u5165\u6570\u636e\u3002\u5982\u679c\u8c03\u7528\u8005\u4fee\u6539\u4e86buffer\uff0c\u5b83\u5fc5\u987b\u5728\u91ca\u653ebuffer\u4e4b\u524d\u8c03\u7528**bwrite**\u5c06\u4fee\u6539\u540e\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\u3002bwrite (kernel/bio.c:107)\u8c03\u7528**virtio_disk_rw**\u4e0e\u78c1\u76d8\u786c\u4ef6\u4ea4\u4e92\u3002</p> <p>\u5f53\u8c03\u7528\u8005\u5904\u7406\u5b8c\u4e00\u4e2abuffer\u540e\uff0c\u5fc5\u987b\u8c03\u7528**brelse**\u6765\u91ca\u653e\u5b83\u3002(brelse**\u8fd9\u4e2a\u540d\u5b57\u662f**b-release**\u7684\u7f29\u5199\uff0c\u867d\u7136\u5f88\u795e\u79d8\uff0c\u4f46\u503c\u5f97\u5b66\u4e60\uff0c\u5b83\u8d77\u6e90\u4e8eUnix\uff0c\u5728BSD\u3001Linux\u548cSolaris\u4e2d\u4e5f\u6709\u4f7f\u7528\u3002) **brelse (kernel/bio.c:117)\u91ca\u653esleep-lock\uff0c\u5e76\u5c06\u8be5buffer\u79fb\u52a8\u5230\u94fe\u8868\u7684\u5934\u90e8(kernel/bio.c:128-133)\u3002\u79fb\u52a8buffer\u4f1a\u4f7f\u94fe\u8868\u6309\u7167buffer\u6700\u8fd1\u4f7f\u7528\u7684\u65f6\u95f4\uff08\u6700\u8fd1\u91ca\u653e\uff09\u6392\u5e8f\uff0c\u94fe\u8868\u4e2d\u7684\u7b2c\u4e00\u4e2abuffer\u662f\u6700\u8fd1\u4f7f\u7528\u7684\uff0c\u6700\u540e\u4e00\u4e2a\u662f\u6700\u65e9\u4f7f\u7528\u7684\u3002**bget**\u4e2d\u7684\u4e24\u4e2a\u5faa\u73af\u5229\u7528\u4e86\u8fd9\u4e00\u70b9\uff0c\u5728\u6700\u574f\u7684\u60c5\u51b5\u4e0b\uff0c\u83b7\u53d6\u5df2\u7f13\u5b58buffer\u7684\u626b\u63cf\u5fc5\u987b\u5904\u7406\u6574\u4e2a\u94fe\u8868\uff0c\u7531\u4e8e\u6570\u636e\u5c40\u90e8\u6027\uff0c\u5148\u68c0\u67e5\u6700\u8fd1\u4f7f\u7528\u7684\u7f13\u51b2\u533a\uff08\u4ece**bcache.head**\u5f00\u59cb\uff0c\u901a\u8fc7**next**\u6307\u9488\uff09\u5c06\u51cf\u5c11\u626b\u63cf\u65f6\u95f4\u3002\u626b\u63cf\u9009\u53d6\u53ef\u4f7f\u7528buffer\u7684\u65b9\u6cd5\u662f\u901a\u8fc7\u4ece\u540e\u5411\u524d\u626b\u63cf\uff08\u901a\u8fc7**prev**\u6307\u9488\uff09\u9009\u53d6\u6700\u8fd1\u4f7f\u7528\u6700\u5c11\u7684\u7f13\u51b2\u533a\u3002</p>"},{"location":"os/Chapter-8/#84-logging-layer","title":"8.4 Logging layer","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u4e2d\u6700\u6709\u8da3\u7684\u95ee\u9898\u4e4b\u4e00\u662f\u5d29\u6e83\u6062\u590d\u3002\u8fd9\u4e2a\u95ee\u9898\u7684\u51fa\u73b0\u662f\u56e0\u4e3a\u8bb8\u591a\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\u6d89\u53ca\u5230\u5bf9\u78c1\u76d8\u7684\u591a\u6b21\u5199\u5165\uff0c\u5982\u679c\u53ea\u6267\u884c\u4e86\u90e8\u5206\u5199\u64cd\u4f5c\uff0c\u7136\u540e\u53d1\u751f\u5d29\u6e83\u53ef\u80fd\u4f1a\u4f7f\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u5904\u4e8e\u4e0d\u4e00\u81f4\u7684\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u5047\u8bbe\u5728\u6587\u4ef6\u622a\u65ad\uff08\u5c06\u6587\u4ef6\u7684\u957f\u5ea6\u8bbe\u7f6e\u4e3a\u96f6\u5e76\u91ca\u653e\u5176\u5185\u5bb9\u5757\uff09\u65f6\u53d1\u751f\u5d29\u6e83\u3002\u6839\u636e\u78c1\u76d8\u5199\u5165\u7684\u987a\u5e8f\uff0c\u53ef\u80fd\u4f1a\u7559\u4e0b\u4e00\u4e2a\u5f15\u7528\u7a7a\u95f2\u5185\u5bb9\u5757\u7684inode\uff0c\u4e5f\u53ef\u80fd\u4f1a\u7559\u4e0b\u4e00\u4e2a\u5df2\u5206\u914d\u4f46\u6ca1\u6709\u88ab\u5f15\u7528\u7684\u5185\u5bb9\u5757\u3002</p> <p>\u540e\u9762\u7684\u8fd9\u79cd\u60c5\u51b5\u76f8\u5bf9\u6765\u8bf4\u597d\u4e00\u70b9\uff0c\u4f46\u662f\u5982\u679c\u4e00\u4e2ainode\u6307\u5411\u88ab\u91ca\u653e\u7684\u5757\uff0c\u5f88\u53ef\u80fd\u5728\u91cd\u542f\u540e\u9020\u6210\u4e25\u91cd\u7684\u95ee\u9898\u3002\u91cd\u542f\u540e\uff0c\u5185\u6838\u53ef\u80fd\u4f1a\u5c06\u8be5\u5757\u5206\u914d\u7ed9\u53e6\u4e00\u4e2a\u6587\u4ef6\uff0c\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a\u4e0d\u540c\u7684\u6587\u4ef6\u65e0\u610f\u4e2d\u6307\u5411\u4e86\u540c\u4e00\u4e2a\u5757\u3002\u5982\u679cxv6\u652f\u6301\u591a\u7528\u6237\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u80fd\u662f\u4e00\u4e2a\u5b89\u5168\u95ee\u9898\uff0c\u56e0\u4e3a\u65e7\u6587\u4ef6\u7684\u6240\u6709\u8005\u80fd\u591f\u8bfb\u5199\u65b0\u6587\u4ef6\uff0c\u5373\u4f7f\u8be5\u6587\u4ef6\u88ab\u53e6\u4e00\u4e2a\u7528\u6237\u6240\u62e5\u6709\u3002</p> <p>Xv6\u901a\u8fc7\u7b80\u5355\u7684\u65e5\u5fd7\u7cfb\u7edf\u6765\u89e3\u51b3\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5d29\u6e83\u5e26\u6765\u7684\u95ee\u9898\u3002xv6\u7684\u7cfb\u7edf\u8c03\u7528\u4e0d\u76f4\u63a5\u5199\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u6570\u636e\u7ed3\u6784\u3002\u76f8\u53cd\uff0c\u5b83\u5c06\u5199\u5165\u7684\u6570\u636e\u8bb0\u5f55\u5728\u78c1\u76d8\u4e0a\u7684\u65e5\u5fd7\u4e2d\u3002\u4e00\u65e6\u7cfb\u7edf\u8c03\u7528\u8bb0\u5f55\u4e86\u5168\u90e8\u7684\u5199\u5165\u6570\u636e\uff0c\u5b83\u5c31\u4f1a\u5728\u78c1\u76d8\u4e0a\u5199\u4e00\u4e2a\u7279\u6b8a\u7684\u63d0\u4ea4\u8bb0\u5f55\uff0c\u8868\u660e\u8be5\u65e5\u5fd7\u5305\u542b\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\u3002\u8fd9\u65f6\uff0c\u7cfb\u7edf\u8c03\u7528\u5c31\u4f1a\u5c06\u65e5\u5fd7\u4e2d\u7684\u5199\u5165\u6570\u636e\u5199\u5230\u78c1\u76d8\u4e0a\u76f8\u5e94\u7684\u4f4d\u7f6e\u3002\u5728\u6267\u884c\u5b8c\u6210\u540e\uff0c\u7cfb\u7edf\u8c03\u7528\u5c06\u78c1\u76d8\u4e0a\u7684\u65e5\u5fd7\u6e05\u9664\u3002</p> <p>\u5982\u679c\u7cfb\u7edf\u5d29\u6e83\u5e76\u91cd\u542f\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\u6062\u590d\u81ea\u5df1\u3002\u5982\u679c\u65e5\u5fd7\u88ab\u6807\u8bb0\u4e3a\u5305\u542b\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\uff0c\u90a3\u4e48\u6062\u590d\u4ee3\u7801\u5c31\u4f1a\u5c06\u5199\u5165\u7684\u5185\u5bb9\u590d\u5236\u5230\u5b83\u4eec\u5728\u78c1\u76d8\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u76f8\u5e94\u4f4d\u7f6e\u3002\u5982\u679c\u65e5\u5fd7\u672a\u88ab\u6807\u8bb0\u4e3a\u5305\u542b\u5b8c\u6574\u7684\u64cd\u4f5c\uff0c\u5219\u6062\u590d\u4ee3\u7801\u5c06\u5ffd\u7565\u5e76\u6e05\u9664\u8be5\u65e5\u5fd7\u3002</p> <p>\u4e3a\u4ec0\u4e48xv6\u7684\u65e5\u5fd7\u7cfb\u7edf\u53ef\u4ee5\u89e3\u51b3\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u7684\u5d29\u6e83\u95ee\u9898\uff1f\u5982\u679c\u5d29\u6e83\u53d1\u751f\u5728\u64cd\u4f5c\u63d0\u4ea4\u4e4b\u524d\uff0c\u90a3\u4e48\u78c1\u76d8\u4e0a\u7684\u65e5\u5fd7\u5c06\u4e0d\u4f1a\u88ab\u6807\u8bb0\u4e3a\u5b8c\u6210\uff0c\u6062\u590d\u4ee3\u7801\u5c06\u5ffd\u7565\u5b83\uff0c\u78c1\u76d8\u7684\u72b6\u6001\u5c31\u50cf\u64cd\u4f5c\u6839\u672c\u6ca1\u6709\u5f00\u59cb\u4e00\u6837\u3002\u5982\u679c\u5d29\u6e83\u53d1\u751f\u5728\u64cd\u4f5c\u63d0\u4ea4\u4e4b\u540e\uff0c\u90a3\u4e48\u6062\u590d\u4ee3\u7801\u4f1a\u91cd\u65b0\u6267\u884c\u5199\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u91cd\u590d\u6267\u884c\u4e4b\u524d\u7684\u5199\u64cd\u4f5c\u3002\u4e0d\u7ba1\u662f\u54ea\u79cd\u60c5\u51b5\uff0c\u65e5\u5fd7\u90fd\u4f1a\u4f7f\u5199\u4e0e\u5d29\u6e83\u4e3a\u539f\u5b50\u7684\uff0c\u5373\u6062\u590d\u540e\uff0c\u6240\u6709\u64cd\u4f5c\u7684\u5199\u5165\u5185\u5bb9\uff0c\u8981\u4e48\u90fd\u5728\u78c1\u76d8\u4e0a\uff0c\u8981\u4e48\u90fd\u4e0d\u5728\u3002</p>"},{"location":"os/Chapter-8/#85-log-design","title":"8.5 Log design","text":"<p>\u65e5\u5fd7\u8d2e\u5b58\u5728\u4e00\u4e2a\u56fa\u5b9a\u4f4d\u7f6e\uff0c\u7531***superblock***\u6307\u5b9a\u3002\u5b83\u7531\u4e00\u4e2aheader\u5757\u7ec4\u6210\uff0c\u540e\u9762\u662f\u4e00\u8fde\u4e32\u7684\u66f4\u65b0\u5757\u526f\u672c\uff08\u65e5\u5fd7\u5757\uff09\u3002header\u5757\u5305\u542b\u4e00\u4e2a\u6247\u533a\u53f7\u6570\u7ec4\uff0c\u5176\u4e2d\u7684\u6bcf\u4e2a\u6247\u533a\u53f7\u90fd\u5bf9\u5e94\u4e00\u4e2a\u65e5\u5fd7\u5757[1]\uff0cheader\u8fd8\u5305\u542b\u65e5\u5fd7\u5757\u7684\u6570\u91cf\u3002\u78c1\u76d8\u4e0aheader\u5757\u4e2d\u7684\u6570\u91cf\u8981\u4e48\u4e3a\u96f6\uff0c\u8868\u793a\u65e5\u5fd7\u4e2d\u6ca1\u6709\u4e8b\u52a1\uff0c\u8981\u4e48\u4e3a\u975e\u96f6\uff0c\u8868\u793a\u65e5\u5fd7\u4e2d\u5305\u542b\u4e00\u4e2a\u5b8c\u6574\u7684\u63d0\u4ea4\u4e8b\u52a1\uff0c\u5e76\u6709\u6307\u5b9a\u6570\u91cf\u7684\u65e5\u5fd7\u5757\u3002Xv6\u5728\u4e8b\u52a1\u63d0\u4ea4\u65f6\u4f1a\u4fee\u6539 header\u5757\uff0c\u5c06\u65e5\u5fd7\u5757\u590d\u5236\u5230\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u4f1a\u5c06\u6570\u91cf\u8bbe\u4e3a\u96f6\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u9014\u7684\u5d29\u6e83\u5c06\u5bfc\u81f4\u65e5\u5fd7header\u5757\u4e2d\u7684\u8ba1\u6570\u4e3a\u96f6\uff1b\u63d0\u4ea4\u540e\u7684\u5d29\u6e83\u7684\u8ba1\u6570\u4e3a\u975e\u96f6\u3002</p> <p>\u4e3a\u4e86\u5e94\u5bf9\u5d29\u6e83\uff0c\u6bcf\u4e2a\u7cfb\u7edf\u8c03\u7528\u90fd\u5305\u542b\u4e00\u4e2a\u539f\u5b50\u5199\u5e8f\u5217\u3002\u4e3a\u4e86\u5141\u8bb8\u4e0d\u540c\u8fdb\u7a0b\u5e76\u53d1\u6267\u884c\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\uff0c\u65e5\u5fd7\u7cfb\u7edf\u53ef\u4ee5\u5c06\u591a\u4e2a\u7cfb\u7edf\u8c03\u7528\u7684\u5199\u64cd\u4f5c\u7d2f\u79ef\u5230\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u3002\u56e0\u6b64\uff0c\u4e00\u6b21\u63d0\u4ea4\u53ef\u80fd\u6d89\u53ca\u591a\u4e2a\u5b8c\u6574\u7cfb\u7edf\u8c03\u7528\u7684\u5199\u5165\u3002\u4e3a\u4e86\u907f\u514d\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\u88ab\u5206\u88c2\u5230\u4e0d\u540c\u7684\u4e8b\u52a1\u4e2d\uff0c\u53ea\u6709\u5728\u6ca1\u6709\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u6b63\u5728\u8fdb\u884c\u65f6\uff0c\u65e5\u5fd7\u7cfb\u7edf\u624d\u4f1a\u63d0\u4ea4\u3002</p> <p>\u5c06\u51e0\u4e2a\u4e8b\u52a1\u4e00\u8d77\u63d0\u4ea4\u7684\u65b9\u6cd5\u88ab\u79f0\u4e3a\u7ec4\u63d0\u4ea4\uff08group commit\uff09\u3002\u7ec4\u63d0\u4ea4\u53ef\u4ee5\u51cf\u5c11\u78c1\u76d8\u64cd\u4f5c\u7684\u6b21\u6570\uff0c\u56e0\u4e3a\u5b83\u5c06\u63d0\u4ea4\u7684\u56fa\u5b9a\u6210\u672c\u5206\u644a\u5728\u4e86\u591a\u4e2a\u64cd\u4f5c\u4e0a\u3002\u7ec4\u63d0\u4ea4\u53ef\u4ee5\u8ba9\u6587\u4ef6\u7cfb\u7edf\u540c\u65f6\u6267\u884c\u66f4\u591a\u7684\u5e76\u53d1\u5199\uff0c\u4e5f\u53ef\u4ee5\u8ba9\u78c1\u76d8\u5728\u4e00\u6b21\u78c1\u76d8\u8f6e\u8f6c\u4e2d\u628a\u5b83\u4eec\u5168\u90e8\u5199\u5165\u3002Xv6\u7684virtio\u9a71\u52a8\u4e0d\u652f\u6301\u8fd9\u79cd\u6279\u5904\u7406\uff0c\u4f46xv6\u7684\u6587\u4ef6\u7cfb\u7edf\u5b9e\u73b0\u4e86\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>Xv6\u5728\u78c1\u76d8\u4e0a\u5212\u51fa\u56fa\u5b9a\u7684\u7a7a\u95f4\u6765\u5b58\u653e\u65e5\u5fd7\u3002\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u7cfb\u7edf\u8c03\u7528\u6240\u5199\u7684\u5757\u603b\u6570\u5fc5\u987b\u9002\u5e94\u8fd9\u4e2a\u7a7a\u95f4\u7684\u5927\u5c0f\u3002\u8fd9\u5c06\u5bfc\u81f4\u4e24\u4e2a\u540e\u679c\uff1a</p> <p>1\u3001\u7cfb\u7edf\u8c03\u7528\u5199\u5165\u7684\u65e5\u5fd7\u5927\u5c0f\u5fc5\u987b\u5c0f\u4e8e\u65e5\u5fd7\u7a7a\u95f4\u7684\u5927\u5c0f\u3002\u8fd9\u5bf9\u5927\u591a\u6570\u7cfb\u7edf\u8c03\u7528\u6765\u8bf4\u90fd\u4e0d\u662f\u95ee\u9898\uff0c\u4f46\u6709\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\u53ef\u80fd\u4f1a\u5199\u5f88\u591a\u5757\uff0cwrite**\u548c**unlink\u3002\u5927\u6587\u4ef6\u7684write\u53ef\u80fd\u4f1a\u5199\u5f88\u591a\u6570\u636e\u5757\u548cbitmap\u5757\uff0c\u4ee5\u53ca\u4e00\u4e2ainode\u5757\uff1b\u53d6\u6d88\u94fe\u63a5\u4e00\u4e2a\u5927\u6587\u4ef6\u53ef\u80fd\u4f1a\u5199\u5f88\u591abitmap\u5757\u548c\u4e00\u4e2ainode\u3002Xv6\u7684**write**\u7cfb\u7edf\u8c03\u7528\u5c06\u5927\u7684\u5199\u64cd\u4f5c\u5206\u89e3\u6210\u591a\u4e2a\u5c0f\u7684\u5199\u64cd\u4f5c\uff0c\u4ee5\u9002\u5e94\u5728\u65e5\u5fd7\u7a7a\u95f4\u7684\u5927\u5c0f\uff0c\u800c**unlink**\u4e0d\u4f1a\u5f15\u8d77\u95ee\u9898\uff0c\u56e0\u4e3axv6\u6587\u4ef6\u7cfb\u7edf\u53ea\u4f7f\u7528\u4e00\u4e2a\u4f4d\u56fe\u5757\u3002</p> <p>2\u3001\u65e5\u5fd7\u7a7a\u95f4\u6709\u9650\u7684\u53e6\u4e00\u4e2a\u540e\u679c\u662f\uff0c\u65e5\u5fd7\u7cfb\u7edf\u53ea\u4f1a\u5728\u786e\u5b9a\u4e86\u7cfb\u7edf\u8c03\u7528\u7684\u5199\u64cd\u4f5c\u53ef\u4ee5\u9002\u5e94\u5269\u4f59\u65e5\u5fd7\u7a7a\u95f4\u4e4b\u540e\uff0c\u624d\u4f1a\u5f00\u59cb\u6267\u884c\u8be5\u7cfb\u7edf\u8c03\u7528\u3002</p>"},{"location":"os/Chapter-8/#86-code-logging","title":"8.6 Code: logging","text":"<p>\u7cfb\u7edf\u8c03\u7528\u4e2d\u4e00\u822c\u7528\u6cd5\u5982\u4e0b\uff1a</p> C<pre><code>begin_op();\n...\nbp = bread(...);\nbp-&gt;data[...] = ...;\nlog_write(bp);\n...\nend_op();\n</code></pre> <p>begin_op(kernel/log.c:126)\u4f1a\u4e00\u76f4\u7b49\u5230\u65e5\u5fd7\u7cfb\u7edf\u6ca1\u6709commiting\uff0c\u5e76\u4e14\u6709\u8db3\u591f\u7684\u65e5\u5fd7\u7a7a\u95f4\u6765\u5bb9\u7eb3\u8fd9\u6b21\u8c03\u7528\u7684\u5199\u3002**log.outstanding**\u7edf\u8ba1\u5f53\u524d\u7cfb\u7edf\u8c03\u7528\u7684\u6570\u91cf\uff0c\u53ef\u4ee5\u901a\u8fc7**log.outstanding**\u4e58\u4ee5**MAXOPBLOCKS**\u6765\u8ba1\u7b97\u5df2\u4f7f\u7528\u7684\u65e5\u5fd7\u7a7a\u95f4\u3002\u81ea\u589e**log.outstanding**\u65e2\u80fd\u9884\u7559\u7a7a\u95f4\uff0c\u53c8\u80fd\u9632\u6b62\u8be5\u7cfb\u7edf\u8c03\u7528\u671f\u95f4\u8fdb\u884c\u63d0\u4ea4\u3002\u8be5\u4ee3\u7801\u5047\u8bbe\u6bcf\u6b21\u7cfb\u7edf\u8c03\u7528\u6700\u591a\u5199\u5165**MAXOPBLOCKS**\u4e2a\u5757\u3002</p> <p>\u200b    log_write (kernel/log.c:214) \u662f**bwrite**\u7684\u4ee3\u7406\u3002\u5b83\u5c06\u6247\u533a\u53f7\u8bb0\u5f55\u5728\u5185\u5b58\u4e2d\uff0c\u5728\u78c1\u76d8\u4e0a\u7684\u65e5\u5fd7\u4e2d\u4f7f\u7528\u4e00\u4e2a\u69fd\uff0c\u5e76\u81ea\u589e**buffer.refcnt**\u9632\u6b62\u8be5**buffer**\u88ab\u91cd\u7528\u3002\u5728\u63d0\u4ea4\u4e4b\u524d\uff0c\u5757\u5fc5\u987b\u7559\u5728\u7f13\u5b58\u4e2d\uff0c\u5373\u8be5\u7f13\u5b58\u7684\u526f\u672c\u662f\u4fee\u6539\u7684\u552f\u4e00\u8bb0\u5f55\uff1b\u5728\u63d0\u4ea4\u4e4b\u540e\u624d\u80fd\u5c06\u5176\u5199\u5165\u78c1\u76d8\u4e0a\u7684\u4f4d\u7f6e\uff1b\u8be5\u6b21\u4fee\u6539\u5fc5\u987b\u5bf9\u5176\u4ed6\u8bfb\u53ef\u89c1\u3002 \u6ce8\u610f\uff0c\u5f53\u4e00\u4e2a\u5757\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u88ab\u591a\u6b21\u5199\u5165\u65f6\uff0c\u4ed6\u4eec\u5728\u65e5\u5fd7\u4e2d\u7684\u69fd\u662f\u76f8\u540c\u7684\u3002\u8fd9\u79cd\u4f18\u5316\u901a\u5e38\u88ab\u79f0\u4e3a***absorption***(\u5438\u6536)\u3002\u4f8b\u5982\uff0c\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u5305\u542b\u591a\u4e2a\u6587\u4ef6\u7684\u591a\u4e2ainode\u7684\u78c1\u76d8\u5757\u88ab\u5199\u591a\u6b21\uff0c\u8fd9\u662f\u5e38\u89c1\u7684\u60c5\u51b5\u3002\u901a\u8fc7\u5c06\u51e0\u6b21\u78c1\u76d8\u5199***\u5438\u6536***\u4e3a\u4e00\u6b21\uff0c\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u8282\u7701\u65e5\u5fd7\u7a7a\u95f4\uff0c\u5e76\u4e14\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\uff0c\u56e0\u4e3a\u53ea\u6709\u4e00\u4efd\u78c1\u76d8\u5757\u7684\u526f\u672c\u5fc5\u987b\u5199\u5165\u78c1\u76d8\u3002</p> <p>end_op (kernel/log.c:146)\u9996\u5148\u9012\u51cf**log.outstanding**\u3002\u5982\u679c\u8ba1\u6570\u4e3a\u96f6\uff0c\u5219\u901a\u8fc7\u8c03\u7528**commit()**\u6765\u63d0\u4ea4\u5f53\u524d\u4e8b\u52a1\u3002</p> <p>**Commit**\u5206\u4e3a\u56db\u4e2a\u9636\u6bb5\uff1a</p> <p>1\u3001write_log()(kernel/log.c:178)\u5c06\u4e8b\u52a1\u4e2d\u4fee\u6539\u7684\u6bcf\u4e2a\u5757\u4ecebuffer\u7f13\u5b58\u4e2d\u590d\u5236\u5230\u78c1\u76d8\u4e0a\u7684\u65e5\u5fd7\u69fd\u4e2d\u3002</p> <p>2\u3001 write_head()(kernel/log.c:102)\u5c06header\u5757\u5199\u5230\u78c1\u76d8\u4e0a\uff0c\u5c31\u8868\u660e\u5df2\u63d0\u4ea4\uff0c\u4e3a\u63d0\u4ea4\u70b9\uff0c\u5199\u5b8c\u65e5\u5fd7\u540e\u7684\u5d29\u6e83\uff0c\u4f1a\u5bfc\u81f4\u5728\u91cd\u542f\u540e\u91cd\u65b0\u6267\u884c\u65e5\u5fd7\u3002</p> <p>3\u3001install_trans(kernel/log.c:69)\u4ece\u65e5\u5fd7\u4e2d\u8bfb\u53d6\u6bcf\u4e2a\u5757\uff0c\u5e76\u5c06\u5176\u5199\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u7684\u4f4d\u7f6e\u3002</p> <p>4\u3001\u6700\u540e\u4fee\u6539\u65e5\u5fd7\u5757\u8ba1\u6570\u4e3a0\uff0c\u5e76\u5199\u5165\u65e5\u5fd7\u7a7a\u95f4\u7684header\u90e8\u5206\u3002\u8fd9\u5fc5\u987b\u5728\u4e0b\u4e00\u4e2a\u4e8b\u52a1\u5f00\u59cb\u4e4b\u524d\u4fee\u6539\uff0c\u8fd9\u6837\u5d29\u6e83\u5c31\u4e0d\u4f1a\u5bfc\u81f4\u91cd\u542f\u540e\u7684\u6062\u590d\u4f7f\u7528\u8fd9\u6b21\u7684header\u548c\u4e0b\u6b21\u7684\u65e5\u5fd7\u5757\u3002</p> <p>recover_from_log (kernel/log.c:116) \u662f\u5728 initlog (kernel/log.c:55) \u4e2d\u8c03\u7528\u7684\uff0c\u800c initlog \u662f\u5728\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u8fd0\u884c (kernel/proc.c:539) \u4e4b\u524d, \u7531 fsinit(kernel/fs.c:42) \u8c03\u7528\u7684\u3002\u5b83\u8bfb\u53d6\u65e5\u5fd7\u5934\uff0c\u5982\u679c\u65e5\u5fd7\u5934\u663e\u793a\u65e5\u5fd7\u4e2d\u5305\u542b\u4e00\u4e2a\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u5219\u4f1a\u50cf**end_op**\u90a3\u6837\u6267\u884c\u65e5\u5fd7\u3002</p> <p>\u4e00\u4e2a\u4f7f\u7528\u4e86\u65e5\u5fd7\u7684\u4f8b\u5b50\u662ffilewrite (kernel/file.c:135)\u3002\u8fd9\u4e2a\u4e8b\u52a1\u770b\u8d77\u6765\u50cf\u8fd9\u6837\uff1a</p> C<pre><code>begin_op();\nilock(f-&gt;ip);\nr = writei(f-&gt;ip, ...);\niunlock(f-&gt;ip);\nend_op();\n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u88ab\u5305\u88f9\u5728\u4e00\u4e2a\u5faa\u73af\u4e2d\uff0c\u5b83\u5c06\u5927\u7684\u5199\u5206\u89e3\u6210\u6bcf\u6b21\u53ea\u6709\u51e0\u4e2a\u6247\u533a\u7684\u5355\u72ec\u4e8b\u52a1\uff0c\u4ee5\u907f\u514d\u6ea2\u51fa\u65e5\u5fd7\u7a7a\u95f4\u3002\u8c03\u7528 writei \u5199\u5165\u8bb8\u591a\u5757\u4f5c\u4e3a\u8fd9\u4e2a\u4e8b\u52a1\u7684\u4e00\u90e8\u5206\uff1a\u6587\u4ef6\u7684 inode\uff0c\u4e00\u4e2a\u6216\u591a\u4e2abitmap\u5757\uff0c\u4ee5\u53ca\u4e00\u4e9b\u6570\u636e\u5757\u3002</p>"},{"location":"os/Chapter-8/#87-code-block-allocator","title":"8.7 Code: Block allocator","text":"<p>\u6587\u4ef6\u548c\u76ee\u5f55\u5b58\u50a8\u5728\u78c1\u76d8\u5757\u4e2d\uff0c\u5fc5\u987b\u4ece\u7a7a\u95f2\u6c60\u4e2d\u5206\u914d\uff0cxv6\u7684\u5757\u5206\u914d\u5668\u5728\u78c1\u76d8\u4e0a\u7ef4\u62a4\u4e00\u4e2abitmap\uff0c\u6bcf\u4e2a\u5757\u5bf9\u5e94\u4e00\u4e2a\u4f4d\u30020\u8868\u793a\u5bf9\u5e94\u7684\u5757\u662f\u7a7a\u95f2\u7684\uff0c1\u8868\u793a\u6b63\u5728\u4f7f\u7528\u4e2d\u3002\u7a0b\u5e8fmkfs\u8bbe\u7f6e\u5f15\u5bfc\u6247\u533a\u3001\u8d85\u7ea7\u5757\u3001\u65e5\u5fd7\u5757\u3001inode\u5757\u548c\u4f4d\u56fe\u5757\u5bf9\u5e94\u7684\u4f4d\u3002</p> <p>\u5757\u5206\u914d\u5668\u63d0\u4f9b\u4e86\u4e24\u4e2a\u51fd\u6570\uff1aballoc**\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u78c1\u76d8\u5757\uff0c**bfree**\u91ca\u653e\u4e00\u4e2a\u5757\u3002**balloc (kernel/fs.c:71)\u4f1a\u6709\u4e00\u4e2a\u5faa\u73af\u904d\u5386\u6bcf\u4e00\u4e2a\u5757\uff0c\u4ece\u5757 0 \u5f00\u59cb\uff0c\u76f4\u5230 sb.size\uff0c\u5373\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u5757\u6570\u3002\u5b83\u5bfb\u627e\u4e00\u4e2a\u4f4d\u4e3a0\u7684\u7a7a\u95f2\u5757\u3002\u5982\u679c balloc \u627e\u5230\u4e86\u8fd9\u6837\u4e00\u4e2a\u5757\uff0c\u5b83\u5c31\u4f1a\u66f4\u65b0bitmap\u5e76\u8fd4\u56de\u8be5\u5757\u3002\u4e3a\u4e86\u63d0\u9ad8\u6548\u7387\uff0c\u8fd9\u4e2a\u5faa\u73af\u88ab\u5206\u6210\u4e24\u90e8\u5206\u3002\u5916\u5faa\u73af\u8bfb\u53d6bitmap\u7684\u4e00\u4e2a\u5757\uff0c\u5185\u5faa\u73af\u68c0\u67e5\u5757\u4e2d\u7684\u6240\u6709BPB\u4f4d\u3002\u5982\u679c\u4e24\u4e2a\u8fdb\u7a0b\u540c\u65f6\u8bd5\u56fe\u5206\u914d\u4e00\u4e2a\u5757\uff0c\u53ef\u80fd\u4f1a\u53d1\u751f\u7ade\u4e89\uff0c\u4f46buffer\u7f13\u5b58\u53ea\u5141\u8bb8\u5757\u540c\u65f6\u88ab\u4e00\u4e2a\u8fdb\u7a0b\u8bbf\u95ee\uff0c\u8fd9\u5c31\u907f\u514d\u4e86\u8fd9\u79cd\u60c5\u51b5\u7684\u53d1\u751f\u3002</p> <p>Bfree (kernel/fs.c:90) \u627e\u5230\u76f8\u5e94\u7684bitmap\u5757\u5e76\u6e05\u9664\u76f8\u5e94\u7684\u4f4d\u3002**bread**\u548c**brelse**\u6697\u542b\u7684\u72ec\u5360\u6027\u907f\u514d\u4e86\u663e\u5f0f\u9501\u5b9a\u3002</p> <p>\u4e0e\u672c\u7ae0\u5176\u4f59\u90e8\u5206\u63cf\u8ff0\u7684\u5927\u90e8\u5206\u4ee3\u7801\u4e00\u6837\uff0c**balloc**\u548c**bfree**\u5fc5\u987b\u5728\u4e8b\u52a1\u4e2d\u88ab\u8c03\u7528\u3002</p>"},{"location":"os/Chapter-8/#88-inode-layer","title":"8.8 Inode layer","text":"<p>\u672f\u8bedinode\u6709\u4e24\u79cd\u76f8\u5173\u7684\u542b\u4e49\u30021\u3001\u6307\u7684\u662f\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u6587\u4ef6\u7684\u5927\u5c0f\u548c\u6570\u636e\u5757\u53f7\u7684\u5217\u8868\uff1b2\u3001\u6307\u7684\u662f\u5185\u5b58\u4e2d\u7684inode\uff0c\u5b83\u5305\u542b\u4e86\u78c1\u76d8\u4e0ainode\u7684\u526f\u672c\u4ee5\u53ca\u5185\u6838\u4e2d\u9700\u8981\u7684\u5176\u4ed6\u4fe1\u606f\u3002</p> <p>\u78c1\u76d8\u4e0a\u7684inode\u88ab\u653e\u7f6e\u78c1\u76d8\u7684\u4e00\u4e2a\u8fde\u7eed\u533a\u57df\u3002\u6bcf\u4e00\u4e2ainode\u7684\u5927\u5c0f\u90fd\u662f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\uff0c\u7ed9\u5b9a\u4e00\u4e2a\u6570\u5b57n\uff0c\u5f88\u5bb9\u6613\u627e\u5230\u78c1\u76d8\u4e0a\u7684\u7b2cn\u4e2ainode\u3002\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u4e2a\u6570\u5b57n\uff0c\u88ab\u79f0\u4e3ainode\u53f7\u6216i-number\uff0c\u5728\u5b9e\u73b0\u4e2d\u5c31\u662f\u901a\u8fc7\u8fd9\u4e2a\u8bc6\u522binode\u7684\u3002</p> <p>\u7ed3\u6784\u4f53**dinode**(kernel/fs.h:32)\u5b9a\u4e49\u4e86\u78c1\u76d8\u4e0a\u7684inode\u3002**type**\u5b57\u6bb5\u533a\u5206\u4e86\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u7279\u6b8a\u6587\u4ef6\uff08\u8bbe\u5907\uff09\u3002type\u4e3a0\u8868\u793a\u8be5inode\u662f\u7a7a\u95f2\u7684\u3002**nlink**\u5b57\u6bb5\u7edf\u8ba1\u5f15\u7528\u8fd9\u4e2ainode\u7684\u76ee\u5f55\u9879\u7684\u6570\u91cf\uff0c\u5f53\u5f15\u7528\u6570\u4e3a0\u65f6\u5c31\u91ca\u653e\u78c1\u76d8\u4e0a\u7684inode\u53ca\u5176\u6570\u636e\u5757\u3002**size**\u5b57\u6bb5\u8bb0\u5f55\u4e86\u6587\u4ef6\u4e2d\u5185\u5bb9\u7684\u5b57\u8282\u6570\u3002**addrs**\u6570\u7ec4\u8bb0\u5f55\u4e86\u6301\u6709\u6587\u4ef6\u5185\u5bb9\u7684\u78c1\u76d8\u5757\u7684\u5757\u53f7\u3002</p> <p>\u5185\u6838\u5c06\u5728\u4f7f\u7528\u7684inode\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff1b\u7ed3\u6784\u4f53**inode** (kernel/file.h:17)\u662f\u78c1\u76d8**dinode**\u7684\u62f7\u8d1d\u3002\u5185\u6838\u53ea\u5728\u6709\u6307\u9488\u6307\u5411inode\u624d\u4f1a\u50a8\u5b58\u3002ref**\u5b57\u6bb5\u4e3a\u6307\u5411inode\u7684\u6307\u9488\u7684\u6570\u91cf\uff0c\u5982\u679c\u5f15\u7528\u6570\u91cf\u51cf\u5c11\u5230\u96f6\uff0c\u5185\u6838\u5c31\u4f1a\u4ece\u5185\u5b58\u4e2d\u4e22\u5f03\u8fd9\u4e2ainode\u3002**iget**\u548c**iput**\u51fd\u6570\u5f15\u7528\u548c\u91ca\u653einode\uff0c\u5e76\u4fee\u6539\u5f15\u7528\u8ba1\u6570\u3002\u6307\u5411inode\u7684\u6307\u9488\u53ef\u4ee5\u6765\u81ea\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\uff0c\u4ee5\u53ca\u77ed\u6682\u7684\u5185\u6838\u4ee3\u7801\uff0c\u5982**exec\u3002</p> <p>\u5728xv6\u7684inode\u4ee3\u7801\u4e2d\uff0c\u6709\u56db\u79cd\u9501\u6216\u7c7b\u4f3c\u9501\u7684\u673a\u5236\u3002**icache.lock**\u4fdd\u8bc1\u4e86\u4e00\u4e2ainode\u5728\u7f13\u5b58\u53ea\u6709\u4e00\u4e2a\u526f\u672c\uff0c\u4ee5\u53ca\u7f13\u5b58inode\u7684**ref**\u5b57\u6bb5\u8ba1\u6570\u6b63\u786e\u3002\u6bcf\u4e2a\u5185\u5b58\u4e2d\u7684inode\u90fd\u6709\u4e00\u4e2a\u5305\u542bsleep-lock\u7684\u9501\u5b57\u6bb5\uff0c\u5b83\u4fdd\u8bc1\u4e86\u53ef\u4ee5\u72ec\u5360\u8bbf\u95eeinode\u7684\u5176\u4ed6\u5b57\u6bb5\uff08\u5982\u6587\u4ef6\u957f\u5ea6\uff09\u4ee5\u53cainode\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u5185\u5bb9\u5757\u7684\u3002\u4e00\u4e2ainode\u7684**ref**\u5982\u679c\u5927\u4e8e0\uff0c\u5219\u4f1a\u4f7f\u7cfb\u7edf\u5c06\u8be5inode\u4fdd\u7559\u5728\u7f13\u5b58\u4e2d\uff0c\u800c\u4e0d\u4f1a\u91cd\u7528\u8be5inode\u3002\u6700\u540e\uff0c\u6bcf\u4e2ainode\u90fd\u5305\u542b\u4e00\u4e2a**nlink**\u5b57\u6bb5(\u5728\u78c1\u76d8\u4e0a\uff0c\u7f13\u5b58\u65f6\u4f1a\u590d\u5236\u5230\u5185\u5b58\u4e2d)\uff0c\u8be5\u5b57\u6bb5\u7edf\u8ba1\u94fe\u63a5\u8be5inode\u7684\u76ee\u5f55\u9879\u7684\u6570\u91cf\uff1b\u5982\u679c\u4e00\u4e2ainode\u7684\u94fe\u63a5\u6570\u5927\u4e8e\u96f6\uff0cxv6\u4e0d\u4f1a\u91ca\u653e\u5b83\u3002</p> <p>\u5728xv6\u7684inode\u4ee3\u7801\u4e2d\uff0c\u6709\u56db\u79cd\u9501\u6216\u7c7b\u4f3c\u9501\u7684\u673a\u5236\u3002**icache.lock**\u4fdd\u8bc1\u4e86\u4e00\u4e2ainode\u5728\u7f13\u5b58\u53ea\u6709\u4e00\u4e2a\u526f\u672c\uff0c\u4ee5\u53ca\u7f13\u5b58inode\u7684**ref**\u5b57\u6bb5\u8ba1\u6570\u6b63\u786e\u3002\u6bcf\u4e2a\u5185\u5b58\u4e2d\u7684inode\u90fd\u6709\u4e00\u4e2a\u5305\u542bsleep-lock\u7684\u9501\u5b57\u6bb5\uff0c\u5b83\u4fdd\u8bc1\u4e86\u53ef\u4ee5\u72ec\u5360\u8bbf\u95eeinode\u7684\u5176\u4ed6\u5b57\u6bb5\uff08\u5982\u6587\u4ef6\u957f\u5ea6\uff09\u4ee5\u53cainode\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u5185\u5bb9\u5757\u7684\u3002\u4e00\u4e2ainode\u7684**ref**\u5982\u679c\u5927\u4e8e0\uff0c\u5219\u4f1a\u4f7f\u7cfb\u7edf\u5c06\u8be5inode\u4fdd\u7559\u5728\u7f13\u5b58\u4e2d\uff0c\u800c\u4e0d\u4f1a\u91cd\u7528\u8be5\u7f13\u5b58buffer\u3002\u6700\u540e\uff0c\u6bcf\u4e2ainode\u90fd\u5305\u542b\u4e00\u4e2a**nlink**\u5b57\u6bb5(\u5728\u78c1\u76d8\u4e0a\uff0c\u5982\u679c\u662f\u7f13\u5b58\uff0c\u5219\u590d\u5236\u5728\u5185\u5b58\u4e2d)\uff0c\u8be5\u5b57\u6bb5\u7edf\u8ba1\u5f15\u7528\u6587\u4ef6\u7684\u76ee\u5f55\u9879\u7684\u6570\u91cf\uff1b\u53ea\u6709\u5f53inode\u7684\u94fe\u63a5\u6570\u4e3a\u96f6\u65f6\uff0cxv6\u624d\u4f1a\u91ca\u653e\u5b83\u3002</p> <p>**iget()**\u8fd4\u56de\u7684**inode**\u6307\u9488\u5728\u8c03\u7528iput()\u4e4b\u524d\u90fd\u662f\u6709\u6548\u7684\uff1binode\u4e0d\u4f1a\u88ab\u5220\u9664\uff0c\u6307\u9488\u6240\u5f15\u7528\u7684\u5185\u5b58\u4e5f\u4e0d\u4f1a\u88ab\u53e6\u4e00\u4e2ainode\u91cd\u65b0\u4f7f\u7528\u3002**iget()**\u63d0\u4f9b\u4e86\u5bf9inode\u7684\u975e\u72ec\u5360\u6027\u8bbf\u95ee\uff0c\u56e0\u6b64\u53ef\u4ee5\u6709\u8bb8\u591a\u6307\u9488\u6307\u5411\u540c\u4e00\u4e2ainode\u3002\u6587\u4ef6\u7cfb\u7edf\u4ee3\u7801\u4e2d\u7684\u8bb8\u591a\u90e8\u5206\u90fd\u4f9d\u8d56\u4e8e**iget()**\u7684\u8fd9\u79cd\u884c\u4e3a\uff0c\u65e2\u662f\u4e3a\u4e86\u4fdd\u6301\u5bf9inode\u7684\u957f\u671f\u5f15\u7528(\u5982\u6253\u5f00\u7684\u6587\u4ef6\u548c\u5f53\u524d\u76ee\u5f55)\uff0c\u4e5f\u662f\u4e3a\u4e86\u9632\u6b62\u7ade\u4e89\uff0c\u540c\u65f6\u907f\u514d\u5728\u64cd\u4f5c\u591a\u4e2ainode\u7684\u4ee3\u7801\u4e2d\u51fa\u73b0\u6b7b\u9501(\u5982\u8def\u5f84\u540d\u67e5\u627e)\u3002</p> <p>inode\u7f13\u5b58\u53ea\u7f13\u5b58\u88ab\u6307\u9488\u6307\u5411\u7684inode\u3002\u5b83\u7684\u4e3b\u8981\u5de5\u4f5c\u5176\u5b9e\u662f\u540c\u6b65\u591a\u4e2a\u8fdb\u7a0b\u7684\u8bbf\u95ee\uff0c\u7f13\u5b58\u662f\u6b21\u8981\u7684\u3002\u5982\u679c\u4e00\u4e2ainode\u88ab\u9891\u7e41\u4f7f\u7528\uff0c\u5982\u679c\u4e0d\u88abinode\u7f13\u5b58\u4fdd\u5b58\uff0cbuffer\u7f13\u5b58\u53ef\u80fd\u4f1a\u628a\u5b83\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\u3002inode\u7f13\u5b58\u662f***write-through***\u7684\uff0c\u8fd9\u610f\u5473\u7740\u7f13\u5b58\u7684inode\u88ab\u4fee\u6539\uff0c\u5c31\u5fc5\u987b\u7acb\u5373\u7528**iupdate**\u628a\u5b83\u5199\u5165\u78c1\u76d8\u3002</p>"},{"location":"os/Chapter-8/#89-code-inodes","title":"8.9 Code: Inodes","text":"<p>\u8981\u521b\u5efa\u4e00\u4e2a\u65b0\u7684inode(\u4f8b\u5982\uff0c\u5f53\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u65f6)\uff0cxv6\u4f1a\u8c03\u7528**ialloc**(kernel/fs.c:196)\u3002ialloc \u7c7b\u4f3c\u4e8e balloc\uff1a\u5b83\u904d\u5386\u78c1\u76d8\u4e0a\u7684 inode \uff0c\u5bfb\u627e\u4e00\u4e2a\u88ab\u6807\u8bb0\u4e3a\u7a7a\u95f2\u7684inode\u3002\u5f53\u5b83\u627e\u5230\u540e\uff0c\u5b83\u4f1a\u4fee\u6539\u8be5inode\u7684**type**\u5b57\u6bb5\u6765\u4f7f\u7528\u5b83\uff0c\u6700\u540e\u8c03\u7528 iget (kernel/fs.c:210) \u6765\u4ece inode \u7f13\u5b58\u4e2d\u8fd4\u56de\u4e00\u4e2a\u6761\u76ee\u3002\u7531\u4e8e\u4e00\u6b21\u53ea\u80fd\u6709\u4e00\u4e2a\u8fdb\u7a0b\u6301\u6709\u5bf9**bp:ialloc**\u7684\u5f15\u7528\uff0c\u6240\u4ee5\u53ef\u4ee5\u786e\u4fdd\u5176\u4ed6\u8fdb\u7a0b\u4e0d\u4f1a\u540c\u65f6\u770b\u5230inode\u662f\u53ef\u7528\u7684\u5e76\u4f7f\u7528\u5b83\u3002</p> <p>Iget (kernel/fs.c:243) \u5728 inode \u7f13\u5b58\u4e2d\u5bfb\u627e\u4e00\u4e2a\u5e26\u6709\u6240\u9700\u8bbe\u5907\u53f7\u548c inode \u53f7\u7801\u7684active\u6761\u76ee (ip-&gt;ref &gt; 0)\u3002\u5982\u679c\u5b83\u627e\u5230\u4e86\uff0c\u5b83\u5c31\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u5bf9\u8be5inode\u7684\u5f15\u7528(kernel/fs.c:252-256)\u3002\u5f53 iget \u626b\u63cf\u65f6\uff0c\u5b83\u4f1a\u8bb0\u5f55\u7b2c\u4e00\u4e2a\u7a7a\u69fd\u7684\u4f4d\u7f6e (kernel/fs.c:257- 258)\uff0c\u5f53\u5b83\u9700\u8981\u5206\u914d\u4e00\u4e2a\u7f13\u5b58\u6761\u76ee\u65f6\uff0c\u5b83\u4f1a\u4f7f\u7528\u8fd9\u4e2a\u7a7a\u69fd\u3002</p> <p>\u5728\u8bfb\u5199inode\u7684\u5143\u6570\u636e\u6216\u5185\u5bb9\u4e4b\u524d\uff0c\u4ee3\u7801\u5fc5\u987b\u4f7f\u7528**ilock**\u9501\u5b9a\u5b83\u3002Ilock(kernel/fs.c:289)\u4f7f\u7528sleep-lock\u6765\u9501\u5b9a\u3002\u4e00\u65e6**ilock**\u9501\u5b9a\u4e86inode\uff0c\u5b83\u5c31\u4f1a\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u4ece\u78c1\u76d8\uff08\u66f4\u6709\u53ef\u80fd\u662fbuffer\u7f13\u5b58\uff09\u8bfb\u53d6inode\u3002\u51fd\u6570**iunlock** (kernel/fs.c:317)\u91ca\u653e\u7761\u7720\u9501\uff0c\u8fd9\u4f1a\u5524\u9192\u6b63\u5728\u7b49\u5f85\u8be5\u7761\u7720\u9501\u7684\u8fdb\u7a0b\u3002</p> <p>Iput (kernel/fs.c:333) \u901a\u8fc7\u9012\u51cf\u5f15\u7528\u6b21\u6570 (kernel/fs.c:356) \u91ca\u653e\u6307\u5411inode\u7684\u6307\u9488\u3002\u5982\u679c\u9012\u51cf\u540e\u7684\u5f15\u7528\u6570\u4e3a0\uff0cinode \u7f13\u5b58\u4e2d\u7684 \u5c31\u4f1a\u91ca\u653e\u6389\u8be5inode \u5728inode\u7f13\u5b58\u4e2d\u7684\u69fd\u4f4d\uff0c\u8be5\u69fd\u4f4d\u5c31\u53ef\u4ee5\u88ab\u5176\u4ed6inode\u4f7f\u7528\u3002</p> <p>\u5982\u679c**iput**\u53d1\u73b0\u6ca1\u6709\u6307\u9488\u6307\u5411\u8be5inode\uff0c\u5e76\u4e14\u6ca1\u6709\u4efb\u4f55\u76ee\u5f55\u9879\u94fe\u63a5\u8be5inode\uff08\u4e0d\u5728\u4efb\u4f55\u76ee\u5f55\u4e2d\u51fa\u73b0\uff09\uff0c\u90a3\u4e48\u8be5inode\u548c\u5b83\u7684\u6570\u636e\u5757\u5fc5\u987b\u88ab\u91ca\u653e\u3002**Iput**\u8c03\u7528**itrunc**\u5c06\u6587\u4ef6\u622a\u65ad\u4e3a\u96f6\u5b57\u8282\uff0c\u91ca\u653e\u6570\u636e\u5757\uff1b\u5c06inode\u7c7b\u578b\u8bbe\u7f6e\u4e3a0\uff08\u672a\u5206\u914d\uff09\uff1b\u5e76\u5c06inode\u5199\u5165\u78c1\u76d8\uff08kernel/fs.c:338\uff09\u3002</p> <p>iput**\u5728\u91ca\u653einode\u7684\u9501\u5b9a\u534f\u8bae\u662f\u503c\u5f97\u6211\u4eec\u4ed4\u7ec6\u7814\u7a76\u3002\u4e00\u4e2a\u5371\u9669\u662f\uff0c\u4e00\u4e2a\u5e76\u53d1\u7ebf\u7a0b\u53ef\u80fd\u4f1a\u5728**ilock**\u4e2d\u7b49\u5f85\u4f7f\u7528\u8fd9\u4e2ainode(\u4f8b\u5982\uff0c\u8bfb\u53d6\u4e00\u4e2a\u6587\u4ef6\u6216\u5217\u51fa\u4e00\u4e2a\u76ee\u5f55)\uff0c\u4f46\u5b83\u6ca1\u6709\u610f\u8bc6\u5230\u8be5inode\u53ef\u80fd\u88ab\u91ca\u653e\u6389\u4e86\u3002\u8fd9\u79cd\u60c5\u51b5\u662f\u4e0d\u4f1a\u53d1\u751f\uff0c\u56e0\u4e3a\u8be5inode\u7684\u6ca1\u6709\u88ab\u76ee\u5f55\u9879\u94fe\u63a5\u4e14**ip-&gt;ref**\u4e3a1\uff0c\u90a3\u4e48\u7cfb\u7edf\u8c03\u7528\u662f\u6ca1\u6709\u8fd9\u4e2a\u6307\u9488\u7684\uff08\u5982\u679c\u6709\uff0c**ip-&gt;ref**\u5e94\u8be5\u4e3a2\uff09\u3002\u8fd9\u4e00\u4e2a\u5f15\u7528\u662f\u8c03\u7528 iput \u7684\u7ebf\u7a0b\u6240\u62e5\u6709\u7684\u3002\u7684\u786e\uff0c**iput**\u4f1a\u5728\u5176**icache.lock**\u9501\u5b9a\u7684\u4e34\u754c\u533a\u4e4b\u5916\u68c0\u67e5\u5f15\u7528\u6570\u662f\u5426\u4e3a1\uff0c\u4f46\u6b64\u65f6\u5df2\u77e5\u94fe\u63a5\u6570\u4e3a0\uff0c\u6240\u4ee5\u6ca1\u6709\u7ebf\u7a0b\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u65b0\u7684\u5f15\u7528\u3002\u53e6\u4e00\u4e2a\u4e3b\u8981\u7684\u5371\u9669\u662f\uff0c\u5e76\u53d1\u8c03\u7528**ialloc**\u53ef\u80fd\u4f1a\u4f7f**iput**\u8fd4\u56de\u4e00\u4e2a\u6b63\u5728\u88ab\u91ca\u653e\u7684inode\u3002\u8fd9\u79cd\u60c5\u51b5\u53d1\u751f\u5728**iupdate**\u5199\u78c1\u76d8\u65f6**ip-&gt;type=0\u3002\u8fd9\u79cd\u7ade\u4e89\u662f\u6b63\u5e38\u7684\uff0c\u5206\u914dinode\u7684\u7ebf\u7a0b\u4f1a\u7b49\u5f85\u83b7\u53d6inode\u7684\u7761\u7720\u9501\uff0c\u7136\u540e\u518d\u8bfb\u53d6\u6216\u5199\u5165inode\uff0c\u4f46\u6b64\u65f6**iput**\u5c31\u7ed3\u675f\u4e86\u3002</p> <p>**iput()**\u4f1a\u5199\u78c1\u76d8\u3002\u8fd9\u610f\u5473\u7740\u4efb\u4f55\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u7684\u7cfb\u7edf\u8c03\u7528\u90fd\u4f1a\u5199\u78c1\u76d8\uff0c\u56e0\u4e3a\u7cfb\u7edf\u8c03\u7528\u53ef\u80fd\u662f\u6700\u540e\u4e00\u4e2a\u5bf9\u6587\u4ef6\u6709\u5f15\u7528\u7684\u8c03\u7528\u3002\u751a\u81f3\u50cfread()\u8fd9\u6837\u770b\u4f3c\u53ea\u8bfb\u7684\u8c03\u7528\uff0c\u6700\u7ec8\u4e5f\u53ef\u80fd\u4f1a\u8c03\u7528iput()\u3002\u8fd9\u53c8\u610f\u5473\u7740\uff0c\u5373\u4f7f\u662f\u53ea\u8bfb\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u5982\u679c\u4f7f\u7528\u4e86\u6587\u4ef6\u7cfb\u7edf\uff0c\u4e5f\u5fc5\u987b\u7528\u4e8b\u52a1\u6765\u5305\u88c5\u3002</p> <p>\u5d29\u6e83\u53d1\u751f\u5728**iput()**\u4e2d\u662f\u76f8\u5f53\u68d8\u624b\u7684\u3002\u5f53\u6587\u4ef6\u7684\u94fe\u63a5\u6570\u964d\u5230\u96f6\u65f6\uff0c**iput()**\u4e0d\u4f1a\u7acb\u5373\u622a\u65ad\u4e00\u4e2a\u6587\u4ef6\uff0c\u56e0\u4e3a\u4e00\u4e9b\u8fdb\u7a0b\u53ef\u80fd\u4ecd\u7136\u5728\u5185\u5b58\u4e2d\u6301\u6709\u5bf9inode\u7684\u5f15\u7528\uff1a\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u4ecd\u7136\u5728\u5bf9\u6587\u4ef6\u8fdb\u884c\u8bfb\u5199\uff0c\u56e0\u4e3a\u5b83\u6210\u529f\u5730\u6253\u5f00\u4e86inode\u3002\u4f46\u662f\uff0c\u5982\u679c\u5d29\u6e83\u53d1\u751f\u5728\u8be5\u6587\u4ef6\u7684\u6700\u540e\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u91ca\u653e\u65f6\uff0c\u90a3\u4e48\u8be5\u6587\u4ef6\u5c06\u88ab\u6807\u8bb0\u4e3a\u5df2\u5728\u78c1\u76d8\u4e0a\u5206\u914d\uff0c\u4f46\u6ca1\u6709\u76ee\u5f55\u9879\u6307\u5411\u5b83\u3002</p> <p>\u6587\u4ef6\u7cfb\u7edf\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\u7684\u65b9\u6cd5\u6709\u4e24\u79cd\u3002\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6cd5\u662f\uff0c\u662f\u5728\u91cd\u542f\u540e\u7684\u6062\u590d\u65f6\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u626b\u63cf\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u5bfb\u627e\u90a3\u4e9b\u88ab\u6807\u8bb0\u4e3a\u5df2\u5206\u914d\u7684\u6587\u4ef6\uff0c\u4f46\u6ca1\u6709\u6307\u5411\u5b83\u4eec\u7684\u76ee\u5f55\u9879\u3002\u5982\u679c\u6709\u8fd9\u6837\u7684\u6587\u4ef6\u5b58\u5728\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u91ca\u653e\u8fd9\u4e9b\u6587\u4ef6\u3002</p> <p>\u7b2c\u4e8c\u79cd\u89e3\u51b3\u65b9\u6848\u4e0d\u9700\u8981\u626b\u63cf\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u8fd9\u4e2a\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u6587\u4ef6\u7cfb\u7edf\u5728\u78c1\u76d8\u4e0a\uff08\u4f8b\u5982\uff0c\u5728***superblock***\u4e2d\uff09\u8bb0\u5f55\u94fe\u63a5\u6570\u4e3a0\u4f46\u5f15\u7528\u6570\u4e0d\u4e3a0\u7684\u6587\u4ef6\u7684inode\u7684inumber\u3002\u5982\u679c\u6587\u4ef6\u7cfb\u7edf\u5728\u5176\u5f15\u7528\u8ba1\u6570\u8fbe\u52300\u65f6\u5220\u9664\u8be5\u6587\u4ef6 \u3002\u5f53\u6587\u4ef6\u7684\u5f15\u7528\u6570\u4e3a0\u65f6\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u5220\u9664\u8be5\u6587\u4ef6\uff0c\u540c\u65f6\u5b83\u66f4\u65b0\u78c1\u76d8\u4e0a\u7684\u5217\u8868\uff0c\u4ece\u5217\u8868\u4e2d\u5220\u9664\u8be5inode\u3002\u6062\u590d\u65f6\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u91ca\u653e\u5217\u8868\u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u3002</p> <p>Xv6\u6ca1\u6709\u5b9e\u73b0\u8fd9\u4e24\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u8fd9\u610f\u5473\u7740inode\u53ef\u80fd\u4f1a\u5728\u78c1\u76d8\u4e0a\u88ab\u6807\u8bb0\u5206\u914d\uff0c\u5373\u4f7f\u5b83\u4eec\u4e0d\u518d\u4f7f\u7528\u3002\u8fd9\u610f\u5473\u7740\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0cxv6\u53ef\u80fd\u4f1a\u9762\u4e34\u78c1\u76d8\u7a7a\u95f4\u8017\u5c3d\u7684\u98ce\u9669\u3002</p>"},{"location":"os/Chapter-8/#810-code-inode-content","title":"8.10 Code: Inode content","text":"<p>\u78c1\u76d8\u4e0a\u7684**inode**\uff0c\u5373**dinode**\u7ed3\u6784\u4f53\uff0c\u5305\u542b\u4e00\u4e2asize\u548c\u4e00\u4e2a\u5757\u53f7\u6570\u7ec4\uff08\u89c1\u56fe8.3\uff09\u3002inode**\u6570\u636e\u53ef\u4ee5\u5728**dinode**\u7684**addrs**\u6570\u7ec4\u4e2d\u627e\u5230\u3002\u5f00\u59cb\u7684**NDIRECT**\u4e2a\u6570\u636e\u5757\u5217\u5728\u6570\u7ec4\u4e2d\u7684\u524d**NDIRECT**\u4e2a\u6761\u76ee\u4e2d\uff0c\u8fd9\u4e9b\u5757\u88ab\u79f0\u4e3a***\u76f4\u63a5\u5757*\u3002\u63a5\u4e0b\u6765\u7684**NINDIRECT**\u4e2a\u6570\u636e\u5757\u5e76\u6ca1\u6709\u5217\u5728**inode**\u4e2d\uff0c\u800c\u662f\u5217\u5728\u53eb\u505a***\u95f4\u63a5\u5757***\u7684\u6570\u636e\u5757\u4e2d\u3002addrs**\u6570\u7ec4\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\u6761\u76ee\u7ed9\u51fa\u4e86\u653e\u7f6e\u95f4\u63a5\u5757\u7684\u5730\u5740\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u6587\u4ef6\u7684\u524d**12 kB ( NDIRECT x BSIZE)\u5b57\u8282\u53ef\u4ee5\u4ece**inode**\u4e2d\u5217\u51fa\u7684\u5757\u4e2d\u52a0\u8f7d\uff0c\u800c\u63a5\u4e0b\u6765\u7684**256** kB ( NINDIRECT x BSIZE)\u5b57\u8282\u53ea\u80fd\u5728\u67e5\u9605\u95f4\u63a5\u5757\u540e\u624d\u80fd\u53d6\u51fa\u3002\u5bf9\u4e8e\u78c1\u76d8\u8fd9\u662f\u4e00\u79cd\u4e0d\u9519\u7684\u8868\u793a\u65b9\u5f0f\uff0c\u4f46\u5bf9\u5ba2\u6237\u673a\u5c31\u6709\u70b9\u590d\u6742\u4e86\u3002\u51fd\u6570**bmap**\u5305\u88c5\u4e86\u8fd9\u79cd\u8868\u793a\u65b9\u5f0f\u4f7f\u5f97\u9ad8\u5c42\u6b21\u7684\u51fd\u6570\uff0c\u5982**readi**\u548c**writei**\u53ef\u4ee5\u66f4\u597d\u7684\u4f7f\u7528\u3002**Bmap**\u8fd4\u56deinode **ip**\u7684\u7b2c **bn**\u4e2a\u6570\u636e\u5757\u7684\u78c1\u76d8\u5757\u53f7\u3002\u5982\u679c**ip**\u6ca1\u6709\u7b2c**bn**\u4e2a\u7684\u6570\u636e\u5757\uff0c**bmap**\u5c31\u4f1a\u5206\u914d\u4e00\u4e2a\u3002</p> <p>\u51fd\u6570**bmap**(kernel/fs.c:378)\u4ece\u7b80\u5355\u7684\u60c5\u51b5\u5f00\u59cb\uff1a\u6700\u524d\u9762\u7684**NDIRECT**\u4e2a\u5757\u50a8\u5b58\u5728inode(kernel/fs.c:383-387)\u4e2d\uff0c\u63a5\u4e0b\u6765\u7684**NINDIRECT**\u4e2a\u5757\u653e\u7f6e\u5728**ip-&gt;addrs[NDIRECT]\u6307\u5411\u7684\u7684***\u95f4\u63a5\u5757***\u4e2d\u3002**Bmap**\u8bfb\u53d6\u95f4\u63a5\u5757(kernel/fs.c:394)\uff0c\u7136\u540e\u4ece\u5757\u5185\u7684\u6b63\u786e\u7684\u4f4d\u7f6e\u8bfb\u53d6\u4e00\u4e2a\u5757\u53f7(kernel/fs.c:395)\u3002\u5982\u679c\u5757\u53f7\u8d85\u8fc7\u4e86**NDIRECT+NINDIRECT\uff0cbmap**\u5c31\u4f1a**panic\uff1b**writei**\u4f1a\u68c0\u67e5\u5e76\u9632\u6b62\u8fd9\u79cd\u60c5\u51b5(kernel/fs.c:490)\u3002</p> <p>**Bmap**\u6839\u636e\u9700\u8981\u5206\u914d\u5757\u3002**ip-&gt;addrs[bn]**\u6216\u95f4\u63a5\u6761\u76ee\u4e3a0 \u65f6\u8868\u793a\u6ca1\u6709\u5757\u3002\u5f53**bmap**\u9047\u52300\u65f6\uff0c\u5b83\u4f1a\u7528\u65b0\u7684\u5757\u53f7\u6765\u4ee3\u66ff0(kernel/fs.c:384-385) (kernel/fs.c:392-393)\u3002</p> <p>itrunc \u91ca\u653e\u6587\u4ef6\u7684\u5757\uff0c\u5c06inode\u7684\u5927\u5c0f\u91cd\u7f6e\u4e3a\u96f6\u3002Itrunc (kernel/fs.c:410) \u9996\u5148\u91ca\u653e***\u76f4\u63a5\u5757***(kernel/fs.c:416-421)\uff0c\u7136\u540e\u91ca\u653e***\u95f4\u63a5\u5757***\u4e2d\u6307\u5411\u7684\u5757(kernel/fs.c:426- 429)\uff0c\u6700\u540e\u91ca\u653e***\u95f4\u63a5\u5757***\u672c\u8eab(kernel/fs.c:431-432)\u3002</p> <p>Bmap \u4f7f\u5f97 readi \u548c writei \u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u83b7\u53d6\u4e00\u4e2a inode \u7684\u6570\u636e\u3002Readi (kernel/fs.c:456)\u9996\u5148\u8981\u786e\u5b9a\u504f\u79fb\u91cf\u548c\u8ba1\u6570\u6ca1\u6709\u8d85\u8fc7\u6587\u4ef6\u672b\u7aef\u3002\u4ece\u6587\u4ef6\u8d85\u51fa\u672b\u5c3e\u5f00\u59cb\u7684\u8bfb\u4f1a\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef(kernel/fs.c:461-462)\uff0c\u800c\u4ece\u6587\u4ef6\u672b\u5c3e\u5f00\u59cb\u6216\u8bfb\u53d6\u8fc7\u7a0b\u4e2d\u8d85\u51fa\u672b\u5c3e\u7684\u8bfb\u4f1a\u4e0d\u4f1a\u8fd4\u56de\u9519\u8bef\uff0c\u53ea\u662f\u8fd4\u56de\u7684\u5b57\u8282\u6570\u4f1a\u5c11\u4e8e\u8bf7\u6c42\u7684\u5b57\u8282\u6570(kernel/fs.c:463-464)\u3002</p> <p>\u4e3b\u5faa\u73af\u4f1a\u628a\u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5757\u7684\u6570\u636e\u590d\u5236\u5230**dst**\u4e2d(kernel/fs.c:466-474)\u3002writei (kernel/fs.c:483)\u4e0e**readi**\u76f8\u540c\uff0c\u4f46\u6709\u4e09\u4e2a\u4e0d\u540c\uff1a\uff081\uff09\u3001\u4ece\u6587\u4ef6\u672b\u5c3e\u5f00\u59cb\u6216\u8d8a\u8fc7\u6587\u4ef6\u672b\u5c3e\u7684\u5199\u5165\u4f1a\u4f7f\u6587\u4ef6\u589e\u957f\uff0c\u4f46\u4e0d\u4f1a\u8d85\u8fc7\u6587\u4ef6\u7684\u6700\u5927\u957f\u5ea6(kernel/fs.c:490-491)\uff1b\uff082\uff09\u3001\u5faa\u73af\u5c06\u6570\u636e\u590d\u5236\u5230\u7f13\u51b2\u533a\u800c\u4e0d\u662f**out**(kernel/fs.c:36)\uff1b\uff083\uff09\u3001\u5982\u679c\u5199\u4f7f\u6587\u4ef6\u589e\u957f\u4e86\uff0c**writi**\u5fc5\u987b\u66f4\u65b0\u5b83\u7684\u5927\u5c0f(kernel/fs.c:504-511)\u3002</p> <p>readi**\u548c**writei**\u5f00\u59cb\u90fd\u4f1a\u68c0\u67e5**ip-&gt;type == T_DEV\u3002\u8fd9\u79cd\u60c5\u51b5\u5904\u7406\u7684\u662f\u6570\u636e\u4e0d\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u7279\u6b8a\u8bbe\u5907\uff1b\u6211\u4eec\u5c06\u5728\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c42\u4e2d\u518d\u8ba8\u8bba\u8fd9\u79cd\u60c5\u51b5\u3002</p> <p>\u51fd\u6570 stati (kernel/fs.c:442) \u5c06 inode \u5143\u6570\u636e\u590d\u5236\u5230 stat \u7ed3\u6784\u4f53\u4e2d\uff0c\u901a\u8fc7 stat \u7cfb\u7edf\u8c03\u7528\u66b4\u9732\u7ed9\u7528\u6237\u7a0b\u5e8f\u3002</p>"},{"location":"os/Chapter-8/#811-code-directory-layer","title":"8.11 Code: directory layer","text":"<p>\u76ee\u5f55\u7684\u5b9e\u73b0\u673a\u5236\u548c\u6587\u4ef6\u5f88\u7c7b\u4f3c\u3002\u5b83\u7684**inode**\u7c7b\u578b\u662f**T_DIR**\uff0c\u5b83\u7684\u6570\u636e\u662f\u4e00\u4e2a\u76ee\u5f55\u9879\u7684\u5e8f\u5217\u3002\u6bcf\u4e2a\u6761\u76ee\u662f\u4e00\u4e2a\u7ed3\u6784\u4f53**dirent**(kernel/fs.h:56)\uff0c\u5b83\u5305\u542b\u4e00\u4e2a\u540d\u79f0\u548c\u4e00\u4e2ainode\u53f7\u3002\u540d\u79f0\u6700\u591a\u5305\u542b**DIRSIZ**(14)\u4e2a\u5b57\u7b26\uff0c\u8f83\u77ed\u7684\u540d\u79f0\u4ee5**NULL**(0)\u7ed3\u675f\u3002inode\u53f7\u4e3a0\u7684\u76ee\u5f55\u9879\u662f\u7a7a\u95f2\u7684\u3002</p> <p>\u51fd\u6570**dirlookup** (kernel/fs.c:527)\u5728\u4e00\u4e2a\u76ee\u5f55\u4e2d\u641c\u7d22\u4e00\u4e2a\u5e26\u6709\u7ed9\u5b9a\u540d\u79f0\u7684\u6761\u76ee\u3002\u5982\u679c\u627e\u5230\u4e86\uff0c\u5b83\u8fd4\u56de\u4e00\u4e2a\u6307\u5411\u76f8\u5e94\u672a\u4e0a\u9501\u7684inode\u7684\u6307\u9488\uff0c\u5e76\u5c06***poff**\u8bbe\u7f6e\u4e3a\u76ee\u5f55\u4e2d\u6761\u76ee\u7684\u5b57\u8282\u504f\u79fb\u91cf\uff0c\u4ee5\u4fbf\u8c03\u7528\u8005\u60f3\u8981\u7f16\u8f91\u5b83\u3002\u5982\u679cdirlookup\u627e\u5230\u4e00\u4e2a\u5bf9\u5e94\u540d\u79f0\u7684\u6761\u76ee\uff0c\u5219\u66f4\u65b0*poff\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u901a\u8fc7iget\u83b7\u5f97\u7684\u672a\u88ab\u9501\u5b9a\u7684inode\u3002Dirlookup\u662figet\u8fd4\u56de\u672a\u9501\u5b9a\u7684inode\u7684\u539f\u56e0\u3002\u8c03\u7528\u8005\u5df2\u7ecf\u9501\u5b9a\u4e86dp\uff0c\u6240\u4ee5\u5982\u679c\u67e5\u627e\u7684\u662f \u201c.\u201d \uff0c\u5f53\u524d\u76ee\u5f55\u7684\u522b\u540d\uff0c\u5728\u8fd4\u56de\u4e4b\u524d\u8bd5\u56fe\u9501\u5b9ainode\uff0c\u5c31\u4f1a\u8bd5\u56fe\u91cd\u65b0\u9501\u5b9adp\u800c\u6b7b\u9501\u3002(\u8fd8\u6709\u66f4\u590d\u6742\u7684\u6b7b\u9501\u60c5\u51b5\uff0c\u6d89\u53ca\u5230\u591a\u4e2a\u8fdb\u7a0b\u548c\u201d..\u201d\uff0c\u7236\u76ee\u5f55\u7684\u522b\u540d\uff1b\u201d**.\u201d**\u4e0d\u662f\u552f\u4e00\u7684\u95ee\u9898\u3002) \u8c03\u7528\u8005\u53ef\u4ee5\u5148\u89e3\u9501dp\uff0c\u7136\u540e\u518d\u9501\u5b9aip\uff0c\u4fdd\u8bc1\u4e00\u6b21\u53ea\u6301\u6709\u4e00\u4e2a\u9501\u3002</p> <p>\u51fd\u6570**dirlink** (kernel/fs.c:554)\u4f1a\u5728\u5f53\u524d\u76ee\u5f55dp\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\u9879\uff0c\u901a\u8fc7\u7ed9\u5b9a\u7684\u540d\u79f0\u548cinode\u53f7\u3002\u5982\u679c\u540d\u79f0\u5df2\u7ecf\u5b58\u5728\uff0cdirlink \u5c06\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef(kernel/fs.c:560- 564)\u3002\u4e3b\u5faa\u73af\u8bfb\u53d6\u76ee\u5f55\u9879\uff0c\u5bfb\u627e\u4e00\u4e2a\u672a\u4f7f\u7528\u7684\u6761\u76ee\u3002\u5f53\u5b83\u627e\u5230\u4e00\u4e2a\u65f6\uff0c\u5b83\u4f1a\u63d0\u524d\u8df3\u51fa\u5faa\u73af (kernel/fs.c:538-539)\uff0c\u5e76\u5c06 off \u8bbe\u7f6e\u4e3a\u8be5\u53ef\u7528\u6761\u76ee\u7684\u504f\u79fb\u91cf\u3002\u5426\u5219\uff0c\u5faa\u73af\u7ed3\u675f\u65f6\uff0c\u5c06**off**\u8bbe\u7f6e\u4e3a**dp-&gt;size**\u3002\u4e0d\u7ba1\u662f\u54ea\u79cd\u65b9\u5f0f\uff0c**dirlink**\u90fd\u4f1a\u5728\u504f\u79fb\u91cf**off**\u7684\u4f4d\u7f6e\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6761\u76ee\u5230\u76ee\u5f55\u4e2d(kernel/fs.c:574-577)\u3002</p>"},{"location":"os/Chapter-8/#812-code-path-names","title":"8.12 Code: Path names","text":"<p>\u67e5\u627e\u8def\u5f84\u540d\u4f1a\u5bf9\u6bcf\u4e00\u4e2a\u8282\u70b9\u8c03\u7528\u4e00\u6b21**dirlookup**\u3002Namei (kernel/fs.c:661) \u89e3\u6790\u8def\u5f84\u5e76\u8fd4\u56de\u76f8\u5e94\u7684inode\u3002\u51fd\u6570**nameiparent**\u662f**namei**\u7684\u4e00\u4e2a\u53d8\u79cd\uff1a\u5b83\u8fd4\u56de\u76f8\u5e94inode\u7684\u7236\u76ee\u5f55inode\uff0c\u5e76\u5c06\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u590d\u5236\u5230**name**\u4e2d\u3002\u8fd9\u4e24\u4e2a\u51fd\u6570\u90fd\u901a\u8fc7\u8c03\u7528**namex**\u6765\u5b9e\u73b0\u3002</p> <p>Namex (kernel/fs.c:626)\u9996\u5148\u786e\u5b9a\u8def\u5f84\u89e3\u6790\u4ece\u54ea\u91cc\u5f00\u59cb\u3002\u5982\u679c\u8def\u5f84\u4ee5\u659c\u7ebf\u5f00\u5934\uff0c\u5219\u4ece\u6839\u76ee\u5f55\u5f00\u59cb\u89e3\u6790\uff1b\u5426\u5219\uff0c\u4ece\u5f53\u524d\u76ee\u5f55\u5f00\u59cb\u89e3\u6790(kernel/fs.c:630-633)\u3002\u7136\u540e\u5b83\u4f7f\u7528 skipelem \u6765\u904d\u5386\u8def\u5f84\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20(kernel/fs.c:635)\u3002\u5faa\u73af\u7684\u6bcf\u6b21\u8fed\u4ee3\u90fd\u5fc5\u987b\u5728\u5f53\u524dinode ip**\u4e2d\u67e5\u627e**name\u3002\u8fed\u4ee3\u7684\u5f00\u59cb\u662f\u9501\u5b9a**ip**\u5e76\u68c0\u67e5\u5b83\u662f\u5426\u662f\u4e00\u4e2a\u76ee\u5f55\u3002\u5982\u679c\u4e0d\u662f\uff0c\u67e5\u627e\u5c31\u4f1a\u5931\u8d25(kernel/fs.c:636-640)\u3002(\u9501\u5b9a**ip**\u662f\u5fc5\u8981\u7684\uff0c\u4e0d\u662f\u56e0\u4e3a**ip-&gt;type**\u53ef\u80fd\u4f1a\u6539\u53d8\uff0c\u800c\u662f\u56e0\u4e3a\u5728**ilock**\u8fd0\u884c\u4e4b\u524d\uff0c\u4e0d\u80fd\u4fdd\u8bc1ip-&gt;type\u5df2\u7ecf\u4ece\u78c1\u76d8\u8f7d\u5165)\u3002\u5982\u679c\u8c03\u7528\u7684\u662f**nameiparent**\uff0c\u800c\u4e14\u8fd9\u662f\u6700\u540e\u4e00\u4e2a\u8def\u5f84\u5143\u7d20\uff0c\u6309\u7167\u4e4b\u524d**nameiparent**\u7684\u5b9a\u4e49\uff0c\u5faa\u73af\u5e94\u8be5\u63d0\u524d\u505c\u6b62\uff0c\u6700\u540e\u4e00\u4e2a\u8def\u5f84\u5143\u7d20\u5df2\u7ecf\u88ab\u590d\u5236\u5230name\u4e2d\uff0c\u6240\u4ee5**namex**\u53ea\u9700\u8981\u8fd4\u56de\u89e3\u9501\u7684ip(kernel/fs.c:641-645)\u3002\u6700\u540e\uff0c\u5faa\u73af\u4f7f\u7528**dirlookup**\u67e5\u627e\u8def\u5f84\u5143\u7d20\uff0c\u5e76\u901a\u8fc7\u8bbe\u7f6e**ip** = next**\u4e3a\u4e0b\u4e00\u6b21\u8fed\u4ee3\u505a\u51c6\u5907(kernel/fs.c:646-651)\u3002\u5f53\u5faa\u73af\u904d\u5386\u5b8c\u8def\u5f84\u5143\u7d20\u65f6\uff0c\u5b83\u8fd4\u56de**ip\u3002</p> <p>**namex**\u53ef\u80fd\u9700\u8981\u5f88\u957f\u7684\u65f6\u95f4\u6765\u5b8c\u6210\uff1a\u5b83\u53ef\u80fd\u4f1a\u6d89\u53ca\u51e0\u4e2a\u78c1\u76d8\u64cd\u4f5c\uff0c\u901a\u8fc7\u904d\u5386\u8def\u5f84\u540d\u5f97\u5230\u7684\u76ee\u5f55\u7684inode\u548c\u76ee\u5f55\u5757\uff08\u5982\u679c\u5b83\u4eec\u4e0d\u5728buffer\u7f13\u5b58\u4e2d\uff09\u3002Xv6\u7ecf\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\uff0c\u5982\u679c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u5bf9**namex**\u7684\u8c03\u7528\u963b\u585e\u5728\u78c1\u76d8I/O\u4e0a\uff0c\u53e6\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u67e5\u627e\u4e0d\u540c\u7684\u8def\u5f84\u540d\u53ef\u4ee5\u540c\u65f6\u8fdb\u884c\u3002**Namex**\u5206\u522b\u9501\u5b9a\u8def\u5f84\u4e2d\u7684\u6bcf\u4e2a\u76ee\u5f55\uff0c\u8fd9\u6837\u4e0d\u540c\u76ee\u5f55\u7684\u67e5\u627e\u5c31\u53ef\u4ee5\u5e76\u884c\u8fdb\u884c\u3002</p> <p>\u8fd9\u79cd\u5e76\u53d1\u6027\u5e26\u6765\u4e86\u4e00\u4e9b\u6311\u6218\u3002\u4f8b\u5982\uff0c\u5f53\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u5728\u67e5\u627e\u4e00\u4e2a\u8def\u5f84\u540d\u65f6\uff0c\u53e6\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u53ef\u80fd\u6b63\u5728\u53d6\u6d88\u94fe\u63a5\u4e00\u4e2a\u76ee\u5f55\uff0c\u8fd9\u4f1a\u6539\u53d8\u76ee\u5f55\u6570\u3002\u4e00\u4e2a\u6f5c\u5728\u7684\u98ce\u9669\u662f\uff0c\u53ef\u80fd\u4e00\u4e2a\u67e5\u627e\u7ebf\u7a0b\u6b63\u5728\u641c\u7d22\u7684\u76ee\u5f55\u53ef\u80fd\u5df2\u7ecf\u88ab\u53e6\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0b\u5220\u9664\u4e86\uff0c\u800c\u5b83\u7684\u5757\u5df2\u7ecf\u88ab\u53e6\u4e00\u4e2a\u76ee\u5f55\u6216\u6587\u4ef6\u91cd\u7528\u4e86\u3002</p> <p>Xv6\u907f\u514d\u4e86\u8fd9\u79cd\u7ade\u4e89\u3002\u4f8b\u5982\uff0c\u5728**namex**\u4e2d\u6267\u884c**dirlookup**\u65f6\uff0c\u67e5\u627e\u7ebf\u7a0b\u4f1a\u6301\u6709\u76ee\u5f55\u7684\u9501\uff0c**dirlookup**\u8fd4\u56de\u4e00\u4e2a\u4f7f\u7528**iget**\u83b7\u5f97\u7684inode\u3002**iget**\u4f1a\u589e\u52a0inode\u7684\u5f15\u7528\u6b21\u6570\u3002\u53ea\u6709\u4ece**dirlookup**\u6536\u5230inode\u540e\uff0c**namex**\u624d\u4f1a\u91ca\u653e\u76ee\u5f55\u4e0a\u7684\u9501\u3002\u73b0\u5728\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u4f1a\u4ece\u76ee\u5f55\u4e2d\u53d6\u6d88\u94fe\u63a5inode\uff0c\u4f46xv6\u8fd8\u4e0d\u4f1a\u5220\u9664inode\uff0c\u56e0\u4e3ainode\u7684\u5f15\u7528\u6570\u4ecd\u7136\u5927\u4e8e\u96f6\u3002</p> <p>\u53e6\u4e00\u4e2a\u98ce\u9669\u662f\u6b7b\u9501\u3002\u4f8b\u5982\uff0c\u5f53\u67e5\u627e**\". \"**\u65f6\uff0cnext\u6307\u5411\u7684inode\u4e0e**ip**\u76f8\u540c\u3002\u5728\u91ca\u653e\u5bf9**ip**\u7684\u9501\u4e4b\u524d\u9501\u5b9anext\u4f1a\u5bfc\u81f4\u6b7b\u9501\u3002\u4e3a\u4e86\u907f\u514d\u8fd9\u79cd\u6b7b\u9501\uff0c**namex**\u5728\u83b7\u5f97\u5bf9next\u7684\u9501\u4e4b\u524d\u5c31\u4f1a\u89e3\u9501\u76ee\u5f55\u3002\u8fd9\u91cc\u6211\u4eec\u518d\u6b21\u770b\u5230\u4e3a\u4ec0\u4e48**iget**\u548c**ilock**\u4e4b\u95f4\u7684\u5206\u79bb\u662f\u5f88\u91cd\u8981\u7684\u3002</p>"},{"location":"os/Chapter-8/#813-file-descriptor-layer","title":"8.13 File descriptor layer","text":"<p>Unix\u63a5\u53e3\u5f88\u9177\u7684\u4e00\u70b9\u662f\uff1aUnix\u4e2d\u7684\u5927\u90e8\u5206\u8d44\u6e90\u90fd\u662f\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u8868\u793a\u7684\u3002\u5305\u62ec\u63a7\u5236\u53f0\u3001\u7ba1\u9053\u7b49\u8bbe\u5907\uff0c\u5f53\u7136\u8fd8\u6709\u771f\u5b9e\u7684\u6587\u4ef6\u3002\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c42\u5c31\u662f\u5b9e\u73b0\u8fd9\u79cd\u7edf\u4e00\u6027\u7684\u4e00\u5c42\u3002</p> <p>Xv6\u7ed9\u6bcf\u4e2a\u8fdb\u7a0b\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684\u6253\u5f00\u6587\u4ef6\u8868\uff0c\u6216\u8005\u8bf4\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\uff0c\u5c31\u50cf\u6211\u4eec\u5728\u7b2c\u4e00\u7ae0\u4e2d\u770b\u5230\u7684\u90a3\u6837\u3002\u6bcf\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\u7531\u4e00\u4e2a\u7ed3\u6784\u4f53**file**(kernel/file.h:1)\u8868\u793a\uff0c\u5b83\u5305\u88c5inode\u6216\u7ba1\u9053\uff0c\u4e5f\u5305\u542b\u4e00\u4e2aI/O\u504f\u79fb\u91cf\u3002\u6bcf\u6b21\u8c03\u7528**open**\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6253\u5f00\u6587\u4ef6\uff08\u4e00\u4e2a\u65b0\u7684\u7ed3\u6784\u4f53file\uff09\uff0c\u5982\u679c\u591a\u4e2a\u8fdb\u7a0b\u72ec\u7acb\u6253\u5f00\u540c\u4e00\u4e2a\u6587\u4ef6\uff0c\u90a3\u4e48\u4e0d\u540c\u7684**file**\u5b9e\u4f8b\u4f1a\u6709\u4e0d\u540c\u7684I/O\u504f\u79fb\u91cf\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e00\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\uff08\u540c\u4e00\u4e2a\u7ed3\u6784\u6587\u4ef6\uff09\u53ef\u4ee5\u5728\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6587\u4ef6\u8868\u4e2d\u51fa\u73b0\u591a\u6b21\uff0c\u4e5f\u53ef\u4ee5\u5728\u591a\u4e2a\u8fdb\u7a0b\u7684\u6587\u4ef6\u8868\u4e2d\u51fa\u73b0\u3002\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528**open**\u6253\u5f00\u6587\u4ef6\uff0c\u7136\u540e\u4f7f\u7528**dup**\u521b\u5efa\u522b\u540d\uff0c\u6216\u8005\u4f7f\u7528**fork**\u4e0e\u5b50\u8fdb\u7a0b\u5171\u4eab\u6587\u4ef6\uff0c\u5c31\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u3002\u5f15\u7528\u8ba1\u6570\u53ef\u4ee5\u8ddf\u8e2a\u7279\u5b9a\u6253\u5f00\u6587\u4ef6\u7684\u5f15\u7528\u6570\u91cf\u3002\u4e00\u4e2a\u6587\u4ef6\u7684\u6253\u5f00\u65b9\u5f0f\u53ef\u4ee5\u4e3a\u8bfb\uff0c\u5199\uff0c\u6216\u8005\u8bfb\u5199\u3002\u901a\u8fc7**readable**\u548c**writable**\u6765\u6307\u660e\u3002</p> <p>\u7cfb\u7edf\u4e2d\u6240\u6709\u6253\u5f00\u7684\u6587\u4ef6\u90fd\u4fdd\u5b58\u5728\u4e00\u4e2a\u5168\u5c40\u6587\u4ef6\u8868\u4e2d\uff0c\u5373**ftable**\u3002\u6587\u4ef6\u8868\u7684\u529f\u80fd\u6709: \u5206\u914d\u6587\u4ef6(filealloc)\u3001\u521b\u5efa\u91cd\u590d\u5f15\u7528(fileup)\u3001\u91ca\u653e\u5f15\u7528(fileclose)\u3001\u8bfb\u5199\u6570\u636e(fileeread**\u548c**filewrite)\u3002</p> <p>\u524d\u4e09\u4e2a\u51fd\u6570\u5e94\u8be5\u6bd4\u8f83\u719f\u6089\u4e86,\u5c31\u4e0d\u8fc7\u591a\u7684\u8ba8\u8bba\u3002Filealloc (kernel/file.c:30) \u626b\u63cf\u6587\u4ef6\u8868\uff0c\u5bfb\u627e\u4e00\u4e2a\u672a\u5f15\u7528\u7684\u6587\u4ef6 (f-&gt;ref == 0)\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u5f15\u7528\uff1bfileup (kernel/file.c:48) \u589e\u52a0\u5f15\u7528\u8ba1\u6570\uff1bfileclose (kernel/file.c:60) \u51cf\u5c11\u5f15\u7528\u8ba1\u6570\u3002\u5f53\u4e00\u4e2a\u6587\u4ef6\u7684\u5f15\u7528\u6570\u8fbe\u52300\u65f6\uff0c**fileclose**\u4f1a\u6839\u636e\u7c7b\u578b\u91ca\u653e\u5e95\u5c42\u7684\u7ba1\u9053\u6216inode\u3002</p> <p>\u51fd\u6570**filestat**\u3001fileread**\u548c**filewrite**\u5b9e\u73b0\u4e86\u5bf9\u6587\u4ef6\u7684\u7edf\u8ba1\u3001\u8bfb\u548c\u5199\u64cd\u4f5c\u3002Filestat(kernel/file.c:88)\u53ea\u5141\u8bb8\u5bf9inodes\u8fdb\u884c\u64cd\u4f5c\uff0c\u5e76\u8c03\u7528**stati\u3002**Fileread**\u548c**filewrite**\u9996\u5148\u68c0\u67e5\u6253\u5f00\u6a21\u5f0f\u662f\u5426\u5141\u8bb8\u8be5\u64cd\u4f5c\uff0c\u7136\u540e\u518d\u8c03\u7528\u7ba1\u9053\u6216inode\u7684\u76f8\u5173\u5b9e\u73b0\u3002\u5982\u679c\u6587\u4ef6\u4ee3\u8868\u4e00\u4e2ainode\uff0c**fileread**\u548c**filewrite**\u4f7f\u7528I/O\u504f\u79fb\u91cf\u4f5c\u4e3a\u672c\u6b21\u64cd\u4f5c\u7684\u504f\u79fb\u91cf\uff0c\u7136\u540e\u524d\u79fb\u504f\u79fb\u91cf\uff08kernel/file.c:122- 123\uff09\uff08kernel/file.c:153-154\uff09\u3002Pipes\u6ca1\u6709\u504f\u79fb\u91cf\u7684\u6982\u5ff5\u3002\u56de\u60f3\u4e00\u4e0binode\u7684\u51fd\u6570\u9700\u8981\u8c03\u7528\u8005\u5904\u7406\u9501\u7684\u76f8\u5173\u64cd\u4f5c\uff08kernel/file.c:94-96\uff09\uff08kernel/file.c:121-124\uff09\uff08kernel/file.c:163-166\uff09\u3002inode\u52a0\u9501\u9644\u5e26\u4e86\u4e00\u4e2a\u4e0d\u9519\u7684\u4f5c\u7528\uff0c\u90a3\u5c31\u662f\u8bfb\u5199\u504f\u79fb\u91cf\u662f\u539f\u5b50\u5f0f\u66f4\u65b0\u7684\uff0c\u8fd9\u6837\u591a\u4e2a\u8fdb\u7a0b\u5199\u4e00\u4e2a\u6587\u4ef6\u65f6\uff0c\u81ea\u5df1\u5199\u7684\u6570\u636e\u5c31\u4e0d\u4f1a\u88ab\u5176\u4ed6\u8fdb\u7a0b\u6240\u8986\u76d6\uff0c\u5c3d\u7ba1\u4ed6\u4eec\u7684\u5199\u5165\u53ef\u80fd\u6700\u7ec8\u4f1a\u4ea4\u9519\u8fdb\u884c\u3002</p>"},{"location":"os/Chapter-8/#814-code-system-calls","title":"8.14 Code: System calls","text":"<p>\u6709\u4e86\u66f4\u4f4e\u5c42\u63d0\u4f9b\u7684\u51fd\u6570\uff0c\u5927\u591a\u6570\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\u90fd\u662f\u6bd4\u8f83\u7b80\u5355\u7684\uff08\u89c1(kernel/sysfile.c)\uff09\u3002\u6709\u51e0\u4e2a\u8c03\u7528\u503c\u5f97\u4ed4\u7ec6\u7814\u7a76\u4e00\u4e0b\u3002</p> <p>\u51fd\u6570 sys_link \u548c sys_unlink \u53ef\u4ee5\u7f16\u8f91\u76ee\u5f55\uff0c\u521b\u5efa\u6216\u5220\u9664\u5bf9 inodes \u7684\u5f15\u7528\u3002\u5b83\u4eec\u662f\u4f7f\u7528\u4e8b\u52a1\u7684\u53e6\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u3002Sys_link (kernel/sysfile.c:120) \u9996\u5148\u83b7\u53d6\u5b83\u7684\u53c2\u6570\uff0c\u4e24\u4e2a\u5b57\u7b26\u4e32 old \u548c new (kernel/sysfile.c:125) \u3002\u5047\u8bbe old \u5b58\u5728\u5e76\u4e14\u4e0d\u662f\u4e00\u4e2a\u76ee\u5f55 (kernel/sysfile.c:129-132)\uff0csys_link \u4f1a\u9012\u589e\u5b83\u7684 ip-&gt;nlink \u8ba1\u6570\u3002\u7136\u540e sys_link \u8c03\u7528 nameiparent \u627e\u5230 new (kernel/sysfile.c:145) \u7684\u7236\u76ee\u5f55\u548c\u6700\u7ec8\u8def\u5f84\u5143\u7d20\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u6307\u5411 old**\u7684 inode \u7684\u65b0\u76ee\u5f55\u9879 (kernel/sysfile.c:148)\u3002\u65b0\u7684\u7236\u76ee\u5f55\u5fc5\u987b\u5b58\u5728\uff0c\u5e76\u4e14\u548c\u73b0\u6709\u7684inode\u5728\u540c\u4e00\u4e2a\u8bbe\u5907\u4e0a\uff0cinode\u53f7\u53ea\u5728\u540c\u4e00\u4e2a\u78c1\u76d8\u4e0a\u6709\u610f\u4e49\u3002\u5982\u679c\u51fa\u73b0\u8fd9\u6837\u7684\u9519\u8bef\uff0c**sys_link**\u5fc5\u987b\u8fd4\u56de\u5e76\u51cf\u5c11**ip-&gt;nlink\u3002</p> <p>\u4e8b\u52a1\u7b80\u5316\u4e86\u8fd9\u4e2a\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u66f4\u65b0\u591a\u4e2a\u78c1\u76d8\u5757\uff0c\u4f46\u6211\u4eec\u4e0d\u5fc5\u62c5\u5fc3\u505a\u8fd9\u4e9b\u4e8b\u60c5\u7684\u987a\u5e8f\u3002\u5b83\u4eec\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u90fd\u4e0d\u6210\u529f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6ca1\u6709\u4e8b\u52a1\uff0c\u5728\u521b\u5efa\u94fe\u63a5\u4e4b\u524d\u66f4\u65b0**ip-&gt;nlink**\uff0c\u4f1a\u4f7f\u6587\u4ef6\u7cfb\u7edf\u6682\u65f6\u5904\u4e8e\u4e0d\u5b89\u5168\u7684\u72b6\u6001\uff0c\u4e2d\u95f4\u7684\u5d29\u6e83\u53ef\u80fd\u4f1a\u9020\u6210\u7834\u574f\u3002\u6709\u4e86\u4e8b\u52a1\uff0c\u6211\u4eec\u5c31\u4e0d\u7528\u62c5\u5fc3\u8fd9\u4e2a\u95ee\u9898\u4e86\u3002</p> <p>Sys_link**\u4e3a\u4e00\u4e2a\u73b0\u6709\u7684inode\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u540d\u5b57\u3002\u800c\u51fd\u6570**create (kernel/sysfile.c:242)\u4e3a\u4e00\u4e2a\u65b0\u7684inode\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u540d\u5b57\u3002\u5b83\u662f\u4e09\u4e2a\u6587\u4ef6\u521b\u5efa\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u7684\u7efc\u5408\uff1a\u4f7f\u7528O_CREATE\u6807\u5fd7\u7684open\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u666e\u901a\u6587\u4ef6\uff0cmkdir**\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\uff0c\u4ee5\u53camkdev\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8bbe\u5907\u6587\u4ef6\u3002\u548c**sys_link**\u4e00\u6837\uff0c**create**\u4e5f\u662f\u901a\u8fc7\u8c03\u7528**nameiparent**\u6765\u83b7\u53d6\u7236\u76ee\u5f55\u7684inode\u3002\u7136\u540e\u8c03\u7528 **dirlookup \u6765\u68c0\u67e5\u540d\u79f0\u662f\u5426\u5df2\u7ecf\u5b58\u5728 (kernel/sysfile.c:252)\u3002\u5982\u679c\u540d\u79f0\u5b58\u5728\uff0ccreate\u7684\u884c\u4e3a\u53d6\u51b3\u4e8e\u5b83\u88ab\u7528\u4e8e\u54ea\u4e2a\u7cfb\u7edf\u8c03\u7528\uff1aopen\uff0cmkdir\uff0cmkdev**\u7684\u8bed\u4e49\u4e0d\u540c\u3002\u5982\u679c**create**\u662f\u7531**open**\u4f7f\u7528\u7684 (**type == T_FILE)\uff0c\u5982\u679c\u80fd\u6839\u636e\u8be5\u540d\u5b57\u5b58\u5728\u4e14\u4e3a\u666e\u901a\u6587\u4ef6\uff0c\u90a3\u4e48\u6253\u5f00\u5c31\u4f1a\u6210\u529f\uff0c\u6240\u4ee5**create**\u4e5f\u4f1a\u6210\u529f (kernel/sysfile.c:256)\u3002\u5426\u5219\uff0c\u5c31\u4f1a\u62a5\u9519\uff08kernel/sysfile.c:257-258\uff09\u3002\u5982\u679c\u8fd9\u4e2a\u540d\u5b57\u4e0d\u5b58\u5728\uff0ccreate**\u5c31\u4f1a\u7528**ialloc**\u5206\u914d\u4e00\u4e2a\u65b0\u7684inode(kernel/sysfile.c:261)\u3002\u5982\u679c\u65b0\u7684inode\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c**create**\u4f1a\u5728\u8be5\u76ee\u5f55\u6dfb\u52a0\u6761\u76ee\u201c.\u201d\u548c\u201c..\u201d\u3002\u6700\u540e\uff0c\u73b0\u5728\u6570\u636e\u5df2\u7ecf\u88ab\u6b63\u786e\u5730\u521d\u59cb\u5316\u4e86\uff0c**create**\u53ef\u4ee5\u628a\u5b83\u94fe\u63a5\u5230\u7236\u76ee\u5f55\u4e2d(kernel/sysfile.c:274)\u3002\u548c**sys_link**\u4e00\u6837\uff0ccreate\u540c\u65f6\u62e5\u6709\u4e24\u4e2ainode\u9501\uff1a**ip**\u548c**dp\u3002\u6ca1\u6709\u6b7b\u9501\u7684\u53ef\u80fd\u6027\uff0c\u56e0\u4e3ainode **ip**\u662f\u65b0\u5206\u914d\u7684\uff1a\u7cfb\u7edf\u4e2d\u6ca1\u6709\u5176\u4ed6\u8fdb\u7a0b\u4f1a\u6301\u6709**ip**\u7684\u9501\u5e76\u5c1d\u8bd5\u9501\u4f4fdp\u3002\u3002</p> <p>\u4f7f\u7528**create**\uff0c\u5f88\u5bb9\u6613\u5b9e\u73b0**sys_open**\u3001sys_mkdir**\u548c**sys_mknod\u3002Sys_open (kernel/sysfile.c:287)\u662f\u5176\u4e2d\u6700\u590d\u6742\u7684\uff0c\u56e0\u4e3a\u521b\u5efa\u4e00\u4e2a\u65b0\u6587\u4ef6\u53ea\u662f\u5b83\u505a\u7684\u4e00\u5c0f\u90e8\u5206\u3002\u5982\u679c**open**\u7684\u6253\u5f00\u6a21\u5f0f\u5305\u542b\u4e3a**O_CREATE**\uff0c\u5b83\u5c31\u4f1a\u8c03\u7528**create** (kernel/sysfile.c:301)\u3002\u5426\u5219\uff0c\u5b83\u4f1a\u8c03\u7528 namei (kernel/sysfile.c:307)\u3002**Create**\u4f1a\u8fd4\u56de\u4e00\u4e2a\u9501\u5b9a\u7684inode\uff0c\u4f46**namei**\u4e0d\u4f1a\uff0c\u6240\u4ee5**sys_open**\u5fc5\u987b\u9501\u5b9ainode\u3002\u8fd9\u6bd4\u8f83\u6709\u4e00\u4e2a\u65b9\u4fbf\u7684\u5730\u65b9\u662f\u76ee\u5f55\u53ea\u4f1a\u4ee5\u8bfb\u6253\u5f00\uff0c\u800c\u4e0d\u662f\u5199\u3002\u5047\u8bbeinode\u662f\u901a\u8fc7\u67d0\u79cd\u65b9\u5f0f\u83b7\u5f97\u7684\uff0csys_open\u4f1a\u5206\u914d\u4e00\u4e2a\u6587\u4ef6\u548c\u4e00\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26(kernel/sysfile.c:325)\uff0c\u7136\u540e\u8bbe\u7f6efile\u76f8\u5173\u7684\u5b57\u6bb5(kernel/sysfile.c:337- 94 342)\u3002\u6ce8\u610f\uff0c\u6ca1\u6709\u5176\u4ed6\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u8fd9\u4e2a\u90e8\u5206\u521d\u59cb\u5316\u7684\u6587\u4ef6\uff0c\u56e0\u4e3a\u5b83\u53ea\u5728\u5f53\u524d\u8fdb\u7a0b\u7684\u8868\u4e2d\u3002</p> <p>\u7b2c7\u7ae0\u5728\u6211\u4eec\u8fd8\u6ca1\u6709\u6587\u4ef6\u7cfb\u7edf\u4e4b\u524d\u5c31\u7814\u7a76\u4e86\u7ba1\u9053\u7684\u5b9e\u73b0\u3002\u51fd\u6570**sys_pipe**\u901a\u8fc7\u63d0\u4f9b\u521b\u5efa\u7ba1\u9053\u5bf9\u7684\u65b9\u6cd5\u5c06\u7ba1\u9053\u5b9e\u73b0\u4e0e\u6587\u4ef6\u7cfb\u7edf\u8fde\u63a5\u8d77\u6765\u3002\u5b83\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u6307\u9488\uff0c\u8be5\u6307\u9488\u6307\u5411\u4e00\u4e2a\u957f\u5ea6\u4e3a2\u7684int\u7c7b\u578b\u6570\u7ec4\uff0c\u5b83\u5c06\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e24\u4e2a\u65b0\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u7136\u540e\u5b83\u5206\u914d\u7ba1\u9053\u5e76\u88c5\u5165\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002</p>"},{"location":"os/Chapter-8/#815-real-world","title":"8.15 Real world","text":"<p>\u5b9e\u9645\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684buffer\u7f13\u5b58\u8981\u6bd4xv6\u7684\u590d\u6742\u5f97\u591a\uff0c\u4f46\u5b83\u6709\u540c\u6837\u7684\u4e24\u4e2a\u76ee\u7684\uff1a\u7f13\u5b58\u548c\u540c\u6b65\u8bbf\u95ee\u78c1\u76d8\u3002xv6\u7684buffer\u7f13\u5b58\u548cV6\u662f\u4e00\u6837\u7684\uff0c\u4f7f\u7528\u7b80\u5355\u7684\u6700\u8fd1\u6700\u5c11\u4f7f\u7528\uff08LRU\uff09\u629b\u5f03\u7b56\u7565\uff1b\u53ef\u4ee5\u5b9e\u73b0\u8bb8\u591a\u66f4\u590d\u6742\u7684\u7b56\u7565\uff0c\u6bcf\u79cd\u7b56\u7565\u90fd\u5bf9\u67d0\u4e9b\u60c5\u51b5\u6709\u597d\u5904\uff0c\u800c\u5bf9\u5176\u5b83\u60c5\u51b5\u6ca1\u6709\u597d\u5904\u3002\u66f4\u9ad8\u6548\u7684LRU\u7f13\u5b58\u4e0d\u4f7f\u7528\u94fe\u8868\uff0c\u800c\u4f7f\u7528\u54c8\u5e0c\u8868\u8fdb\u884c\u67e5\u627e\uff0c\u4f7f\u7528\u5806\u8fdb\u884cLRU\u629b\u5f03\u3002\u73b0\u4ee3\u7684buffer\u7f13\u5b58\u901a\u5e38\u4e0e\u865a\u62df\u5185\u5b58\u7cfb\u7edf\u96c6\u6210\u5728\u4e00\u8d77\uff0c\u4ee5\u652f\u6301\u5185\u5b58\u6620\u5c04\u7684\u6587\u4ef6\u3002</p> <p>Xv6\u7684\u65e5\u5fd7\u7cfb\u7edf\u6548\u7387\u4f4e\u4e0b\u3002\u63d0\u4ea4\u4e0d\u80fd\u4e0e\u6587\u4ef6\u7cfb\u7edf\u7cfb\u7edf\u8c03\u7528\u540c\u65f6\u53d1\u751f\u3002\u7cfb\u7edf\u4f1a\u8bb0\u5f55\u6574\u4e2a\u5757\uff0c\u5373\u4f7f\u4e00\u4e2a\u5757\u4e2d\u53ea\u6709\u51e0\u4e2a\u5b57\u8282\u88ab\u6539\u53d8\u3002\u5b83\u6267\u884c\u540c\u6b65\u7684\u65e5\u5fd7\u5199\u5165\uff0c\u4e00\u6b21\u5199\u4e00\u4e2a\u5757\uff0c\u6bcf\u4e00\u4e2a\u5757\u90fd\u53ef\u80fd\u9700\u8981\u6574\u4e2a\u78c1\u76d8\u65cb\u8f6c\u65f6\u95f4\u3002\u771f\u6b63\u7684\u65e5\u5fd7\u7cfb\u7edf\u53ef\u4ee5\u89e3\u51b3\u6240\u6709\u8fd9\u4e9b\u95ee\u9898\u3002</p> <p>\u65e5\u5fd7\u4e0d\u662f\u63d0\u4f9b\u5d29\u6e83\u6062\u590d\u7684\u552f\u4e00\u65b9\u6cd5\u3002\u65e9\u671f\u7684\u6587\u4ef6\u7cfb\u7edf\u5728\u91cd\u542f\u671f\u95f4\u4f7f\u7528scavenger\uff08\u4f8b\u5982UNIX fsck\u7a0b\u5e8f\uff09\u6765\u68c0\u67e5\u6bcf\u4e2a\u6587\u4ef6\u548c\u76ee\u5f55\u4ee5\u53ca\u5757\u548cinode\u7a7a\u95f2\u5217\u8868\uff0c\u5bfb\u627e\u5e76\u89e3\u51b3\u4e0d\u4e00\u81f4\u7684\u5730\u65b9\u3002\u5bf9\u4e8e\u5927\u578b\u6587\u4ef6\u7cfb\u7edf\u6765\u8bf4\uff0c\u6e05\u626b\u53ef\u80fd\u9700\u8981\u51e0\u4e2a\u5c0f\u65f6\u7684\u65f6\u95f4\uff0c\u800c\u4e14\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u8fd9\u79cd\u65b9\u5f0f\u8981\u60f3\u83b7\u5f97\u7684\u6570\u636e\u4e00\u81f4\u6027\uff0c\u5176\u7cfb\u7edf\u8c03\u7528\u5fc5\u987b\u662f\u4e00\u81f4\u6027\u7684\u3002\u4ece\u65e5\u5fd7\u4e2d\u6062\u590d\u8981\u5feb\u5f97\u591a\uff0c\u800c\u4e14\u5728\u5d29\u6e83\u65f6\uff0c\u7cfb\u7edf\u8c03\u7528\u662f\u539f\u5b50\u7684\u3002</p> <p>Xv6\u4f7f\u7528\u4e86\u4e0e\u65e9\u671fUNIX\u76f8\u540c\u7684inodes\u548c\u76ee\u5f55\u7684\u57fa\u672c\u78c1\u76d8\u5e03\u5c40\uff1b\u8fd9\u4e2a\u65b9\u6848\u591a\u5e74\u6765\u4ecd\u5728\u4f7f\u7528\u3002BSD\u7684UFS/FFS\u548cLinux\u7684ext2/ext3\u4f7f\u7528\u57fa\u672c\u76f8\u540c\u7684\u6570\u636e\u7ed3\u6784\u3002\u6587\u4ef6\u7cfb\u7edf\u5e03\u5c40\u4e2d\u6700\u4f4e\u6548\u7684\u90e8\u5206\u662f\u76ee\u5f55\uff0c\u5728\u6bcf\u6b21\u67e5\u627e\u8fc7\u7a0b\u4e2d\u9700\u8981\u5bf9\u6240\u6709\u78c1\u76d8\u5757\u8fdb\u884c\u7ebf\u6027\u626b\u63cf\u3002\u5f53\u76ee\u5f55\u53ea\u6709\u51e0\u4e2a\u78c1\u76d8\u5757\u65f6\uff0c\u8fd9\u662f\u5408\u7406\u7684\uff0c\u4f46\u5bf9\u4e8e\u6709\u8bb8\u591a\u6587\u4ef6\u7684\u76ee\u5f55\u6765\u8bf4\u662f\u6602\u8d35\u7684\u3002\u5fae\u8f6fWindows\u7684NTFS\uff0cMac OS X\u7684HFS\uff0c\u4ee5\u53caSolaris\u7684ZFS\uff0c\u5c06\u76ee\u5f55\u5b9e\u73b0\u4e3a\u78c1\u76d8\u4e0a\u5757\u7684\u5e73\u8861\u6811\u3002\u8fd9\u5f88\u590d\u6742\uff0c\u4f46\u53ef\u4ee5\u4fdd\u8bc1\u76ee\u5f55\u67e5\u627e\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f\u5bf9\u6570\u7ea7\u7684\u3002</p> <p>Xv6\u5bf9\u78c1\u76d8\u6545\u969c\u7684\u5904\u7406\u5f88\u6734\u7d20\uff1a\u5982\u679c\u78c1\u76d8\u64cd\u4f5c\u5931\u8d25\uff0cxv6\u5c31\u4f1a**panic**\u3002\u8fd9\u662f\u5426\u5408\u7406\u53d6\u51b3\u4e8e\u786c\u4ef6\uff1a\u5982\u679c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u4f4d\u4e8e\u7279\u6b8a\u7684\u786c\u4ef6\u4e4b\u4e0a\uff0c\u8fd9\u79cd\u786c\u4ef6\u4f1a\u4f7f\u7528\u5197\u4f59\u6765\u63a9\u76d6\u6545\u969c\uff0c\u4e5f\u8bb8\u64cd\u4f5c\u7cfb\u7edf\u770b\u5230\u6545\u969c\u7684\u9891\u7387\u5f88\u4f4e\uff0c\u4ee5\u81f3\u4e8e\u76f4\u63a5**panic**\u662f\u53ef\u4ee5\u7684\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4f7f\u7528\u666e\u901a\u78c1\u76d8\u7684\u64cd\u4f5c\u7cfb\u7edf\u5e94\u8be5\u4f7f\u7528\u66f4\u52a0\u4f18\u96c5\u7684\u65b9\u5f0f\u6765\u5904\u7406\u5f02\u5e38\uff0c\u8fd9\u6837\u4e00\u4e2a\u6587\u4ef6\u4e2d\u4e00\u4e2a\u5757\u7684\u4e22\u5931\u5c31\u4e0d\u4f1a\u5f71\u54cd\u6587\u4ef6\u7cfb\u7edf\u5176\u4ed6\u90e8\u5206\u7684\u4f7f\u7528\u3002</p> <p>Xv6\u8981\u6c42\u6587\u4ef6\u7cfb\u7edf\u56fa\u5b9a\u5728\u5355\u4e00\u78c1\u76d8\u8bbe\u5907\u4e0a\uff0c\u800c\u4e14\u5927\u5c0f\u4e0d\u80fd\u6539\u53d8\u3002\u968f\u7740\u5927\u578b\u6570\u636e\u5e93\u548c\u591a\u5a92\u4f53\u6587\u4ef6\u5bf9\u5b58\u50a8\u8981\u6c42\u8d8a\u6765\u8d8a\u9ad8\uff0c\u64cd\u4f5c\u7cfb\u7edf\u6b63\u5728\u5f00\u53d1\u6d88\u9664\u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e00\u4e2a\u78c1\u76d8\u74f6\u9888\u7684\u65b9\u6cd5\u3002\u57fa\u672c\u7684\u65b9\u6cd5\u662f\u5c06\u8bb8\u591a\u78c1\u76d8\u7ec4\u5408\u6210\u4e00\u4e2a\u903b\u8f91\u78c1\u76d8\u3002\u786c\u4ef6\u89e3\u51b3\u65b9\u6848\uff08\u5982RAID\uff09\u4ecd\u7136\u662f\u6700\u6d41\u884c\u7684\uff0c\u4f46\u76ee\u524d\u7684\u8d8b\u52bf\u662f\u5c3d\u53ef\u80fd\u5730\u5728\u8f6f\u4ef6\u4e2d\u5b9e\u73b0\u8fd9\u79cd\u903b\u8f91\u3002\u8fd9\u4e9b\u8f6f\u4ef6\u5b9e\u73b0\u901a\u5e38\u5141\u8bb8\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u5982\u5728\u8fd0\u884c\u65f6\u901a\u8fc7\u5feb\u901f\u6dfb\u52a0\u6216\u5220\u9664\u78c1\u76d8\u6765\u589e\u957f\u6216\u7f29\u5c0f\u903b\u8f91\u8bbe\u5907\u3002\u5f53\u7136\uff0c\u4e00\u4e2a\u80fd\u591f\u5feb\u901f\u589e\u957f\u6216\u6536\u7f29\u7684\u5b58\u50a8\u5c42\u9700\u8981\u4e00\u4e2a\u80fd\u591f\u505a\u5230\u540c\u6837\u7684\u6587\u4ef6\u7cfb\u7edf\uff1axv6\u4f7f\u7528\u7684\u56fa\u5b9a\u5927\u5c0f\u7684inode\u5757\u9635\u5217\u5728\u8fd9\u6837\u7684\u73af\u5883\u4e2d\u4e0d\u80fd\u5f88\u597d\u5730\u5de5\u4f5c\u3002\u5c06\u78c1\u76d8\u7ba1\u7406\u4e0e\u6587\u4ef6\u7cfb\u7edf\u5206\u79bb\u53ef\u80fd\u662f\u6700\u7b80\u6d01\u7684\u8bbe\u8ba1\uff0c\u4f46\u7531\u4e8e\u4e24\u8005\u4e4b\u95f4\u590d\u6742\u7684\u63a5\u53e3\uff0c\u4f7f\u5f97\u6709\u4e9b\u7cfb\u7edf\uff0c\u5982Sun\u516c\u53f8\u7684ZFS\uff0c\u5c06\u4e24\u8005\u76f4\u63a5\u7ed3\u5408\u8d77\u6765\u3002</p> <p>Xv6\u7684\u6587\u4ef6\u7cfb\u7edf\u7f3a\u4e4f\u73b0\u4ee3\u6587\u4ef6\u7cfb\u7edf\u7684\u8bb8\u591a\u5176\u4ed6\u529f\u80fd\uff0c\u4f8b\u5982\uff0c\u5b83\u7f3a\u4e4f\u5bf9\u5feb\u7167\u548c\u589e\u91cf\u5907\u4efd\u7684\u652f\u6301\u3002</p> <p>\u73b0\u4ee3Unix\u7cfb\u7edf\u5141\u8bb8\u7528\u4e0e\u78c1\u76d8\u5b58\u50a8\u76f8\u540c\u7684\u7cfb\u7edf\u8c03\u7528\u6765\u8bbf\u95ee\u8bb8\u591a\u79cd\u7c7b\u7684\u8d44\u6e90\uff1a\u547d\u540d\u7ba1\u9053\u3001\u7f51\u7edc\u8fde\u63a5\u3001\u8fdc\u7a0b\u8bbf\u95ee\u7684\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf\u4ee5\u53ca\u76d1\u89c6\u548c\u63a7\u5236\u63a5\u53e3\uff0c\u5982/proc\u3002\u4e0exv6\u5728fileread\u548cfilewrite\u4e2d\u7684if\u8bed\u53e5\uff0c\u8fd9\u4e9b\u7cfb\u7edf\u901a\u5e38\u7ed9\u6bcf\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u8868\uff0c\u6bcf\u4e2a\u4ee3\u8868\u4e00\u4e2a\u64cd\u4f5c\uff0c\u8c03\u7528\u51fd\u6570\u6307\u9488\u6765\u8c03\u7528\u8be5inode\u7684\u5b9e\u73b0\u8c03\u7528\u3002\u7f51\u7edc\u6587\u4ef6\u7cfb\u7edf\u548c\u7528\u6237\u7ea7\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u4e86\u5c06\u8fd9\u4e9b\u8c03\u7528\u53d8\u6210\u7f51\u7edcRPC\u7684\u51fd\u6570\uff0c\u5e76\u5728\u8fd4\u56de\u524d\u7b49\u5f85\u54cd\u5e94\u3002</p>"},{"location":"os/Chapter-8/#816-exercises","title":"8.16 Exercises","text":"<ol> <li> <p>\u4e3a\u4ec0\u4e48**balloc**\u9700\u8981**panic**\uff1fxv6\u80fd\u6062\u590d\u5417\uff1f</p> </li> <li> <p>\u4e3a\u4ec0\u4e48**ialloc**\u9700\u8981**panic**\uff1fxv6\u80fd\u6062\u590d\u5417\uff1f</p> </li> <li> <p>\u4e3a\u4ec0\u4e48**filealloc**\u7528\u5b8c\u6587\u4ef6\u540e\u4e0d**panic**\uff1f\u4e3a\u4ec0\u4e48\u8fd9\u79cd\u60c5\u51b5\u6bd4\u8f83\u5e38\u89c1\uff0c\u800c\u503c\u5f97\u5904\u7406\uff1f</p> </li> <li> <p>\u5047\u8bbe\u5728\u6267\u884c**sys_lin**k\u65f6\uff0c\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u5728**iunlock(ip)**\u548c**dirlink**\u4e4b\u95f4\u89e3\u9664\u94fe\u63a5\u8be5**ip**\u5bf9\u5e94\u7684\u6587\u4ef6\u3002\u94fe\u63a5\u4f1a\u88ab\u6b63\u786e\u521b\u5efa\u5417\uff1f\u4e3a\u4ec0\u4e48\uff1f</p> </li> <li> <p>create**\u8c03\u7528\u4e86\u56db\u6b21\u51fd\u6570\uff08\u4e00\u4e2a**ialloc\uff0c\u4e09\u6b21**dirlink**\uff09\uff0c\u5b83\u9700\u8981\u8fd9\u4e9b\u51fd\u6570\u6210\u529f\u8fd4\u56de\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u4e0d\u6210\u529f\uff0ccreate**\u8c03\u7528\u5c31\u4f1a**panic\u3002\u4e3a\u4ec0\u4e48\u8fd9\u53ef\u4ee5\u63a5\u53d7\uff1f\u4e3a\u4ec0\u4e48\u8fd9\u56db\u4e2a\u8c03\u7528\u4e0d\u80fd\u6709\u4e00\u4e2a\u5931\u8d25\u5462\uff1f</p> </li> <li> <p>sys_chdir**\u5728**iput(cp-&gt;cwd)**\u4e4b\u524d\u8c03\u7528**iunlock(ip)\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5c1d\u8bd5\u9501\u5b9a**cp-&gt;cwd**\uff0c\u4f46\u5c06**iunlock(ip)**\u63a8\u8fdf\u5230**iput**\u4e4b\u540e\u4e0d\u4f1a\u9020\u6210\u6b7b\u9501\u3002\u4e3a\u4ec0\u4e48\u4e0d\u4f1a\u5462\uff1f</p> </li> <li> <p>\u5b9e\u73b0**lseek**\u7cfb\u7edf\u8c03\u7528\u3002lseek**\u8fd8\u9700\u8981\u4f60\u4fee\u6539**filewrite\uff0c\u5982\u679c**lseek**\u8bbe\u7f6e\u8d85\u8fc7**f-&gt;ip-&gt;size**\uff0c\u5219\u5728\u6587\u4ef6\u4e2d\u7528\u96f6\u6765\u586b\u8865\u7a7a\u7f3a\u3002</p> </li> <li> <p>\u7ed9**open**\u589e\u52a0O_TRUNC\u548cO_APPEND\uff0c\u4f7f&gt;\u548c&gt;&gt;\u64cd\u4f5c\u7b26\u5728shell\u4e2d\u53ef\u4ee5\u4f7f\u7528\u3002</p> </li> <li> <p>\u4fee\u6539\u6587\u4ef6\u7cfb\u7edf\u4f7f\u5176\u652f\u6301\u7b26\u53f7\u94fe\u63a5\u3002</p> </li> <li> <p>\u4fee\u6539\u6587\u4ef6\u7cfb\u7edf\u4f7f\u5176\u652f\u6301\u547d\u540d\u7ba1\u9053\u3002</p> </li> <li> <p>\u4fee\u6539\u6587\u4ef6\u7cfb\u7edf\u548cVM\u4f7f\u5176\u652f\u6301memory-map\u6587\u4ef6\uff08\u5185\u5b58\u6620\u5c04\u6587\u4ef6\uff09\u3002</p> </li> </ol> <ol> <li>\u6247\u533a\u53f7\u8868\u660e\u8be5\u65e5\u5fd7\u5757\uff0c\u5e94\u8be5\u5199\u5165\u7684\u4f4d\u7f6e\u3002</li> </ol>"},{"location":"os/Chapter-9/","title":"Chapter 9","text":""},{"location":"os/Chapter-9/#_1","title":"\u7b2c\u4e5d\u7ae0\uff1a\u5e76\u53d1","text":"<p>\u8981\u540c\u65f6\u83b7\u5f97\u826f\u597d\u7684\u7684\u6027\u80fd\u3001\u5e76\u53d1\u7684\u6b63\u786e\u6027\u548c\u6613\u4e8e\u7406\u89e3\u7684\u4ee3\u7801\u662f\u5185\u6838\u8bbe\u8ba1\u7684\u4e00\u5927\u6311\u6218\u3002\u76f4\u63a5\u4f7f\u7528\u9501\u662f\u4fdd\u8bc1\u6b63\u786e\u6027\u7684\u6700\u4f73\u9014\u5f84\uff0c\u4f46\u4e0d\u603b\u662f\u53ef\u884c\u7684\u3002\u672c\u7ae0\u91cd\u70b9\u4ecb\u7ecd\u4e86xv6\u4e0d\u5f97\u4e0d\u4f7f\u7528\u9501\u7684\u4f8b\u5b50\uff0c\u4ee5\u53ca\u4f7f\u7528\u7c7b\u4f3c\u9501\uff08\u4f46\u4e0d\u662f\u9501\uff09\u7684\u4f8b\u5b50\u3002</p>"},{"location":"os/Chapter-9/#91-locking-patterns","title":"9.1 Locking patterns","text":"<p>\u7f13\u5b58\u9879\u901a\u5e38\u662f\u9501\u7684\u4e00\u4e2a\u6311\u6218\u3002\u4f8b\u5982\uff0c\u6587\u4ef6\u7cfb\u7edf\u7684\u5757\u7f13\u5b58(kernel/bio.c:26)\u5b58\u50a8\u4e86**NBUF**\u4e2a\u78c1\u76d8\u5757\u7684\u526f\u672c\u3002\u4e00\u4e2a\u7ed9\u5b9a\u7684\u78c1\u76d8\u5757\u5728\u7f13\u5b58\u4e2d\u6700\u591a\u53ea\u6709\u4e00\u4e2a\u526f\u672c\uff0c\u8fd9\u4e00\u70b9\u975e\u5e38\u91cd\u8981\uff1b\u5426\u5219\uff0c\u4e0d\u540c\u7684\u8fdb\u7a0b\u5bf9\u540c\u4e00\u78c1\u76d8\u5757\u7684\u4e0d\u540c\u526f\u672c\u8fdb\u884c\u4fee\u6539\u65f6\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\u3002\u6bcf\u4e00\u4e2a\u7f13\u5b58\u7684\u78c1\u76d8\u5757\u90fd\u88ab\u5b58\u50a8\u5728\u4e00\u4e2a**buf**\u7ed3\u6784\u4e2d(kernel/buf.h:1)\u3002buf**\u7ed3\u6784\u6709\u4e00\u4e2a\u9501\u5b57\u6bb5\uff0c\u5b83\u786e\u4fdd\u6bcf\u6b21\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u4f7f\u7528\u4e00\u4e2a\u7ed9\u5b9a\u7684\u78c1\u76d8\u5757\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u9501\u662f\u4e0d\u591f\u7684\uff1a\u5982\u679c\u4e00\u4e2a\u5757\u6839\u672c\u4e0d\u5b58\u5728\u4e8e\u7f13\u5b58\u4e2d\uff0c\u800c\u4e24\u4e2a\u8fdb\u7a0b\u60f3\u540c\u65f6\u4f7f\u7528\u5b83\u600e\u4e48\u529e\uff1f\u6ca1\u6709 **buf (\u56e0\u4e3a\u8be5\u5757\u8fd8\u6ca1\u6709\u88ab\u7f13\u5b58)\uff0c\u56e0\u6b64\u6ca1\u6709\u80fd\u52a0\u9501\u7684\u4e1c\u897f\u3002Xv6\u5bf9\u6240\u6709\u5757\u7684\u6807\u8bc6\u7b26\u5173\u8054\u4e00\u4e2a\u989d\u5916\u7684\u9501\u6765\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\u3002\u5224\u65ad\u5757\u662f\u5426\u88ab\u7f13\u5b58\u7684\u4ee3\u7801\uff08e.g.  bget(kernel/bio.c:59)\uff09\uff0c\u6216\u6539\u53d8\u7f13\u5b58\u5757\u96c6\u5408\u7684\u4ee3\u7801\uff0c\u5fc5\u987b\u6301\u6709**bcache.lock**\u3002\u5f53\u4ee3\u7801\u627e\u5230\u5b83\u6240\u9700\u8981\u7684\u5757\u548c**buf**\u7ed3\u6784\u540e\uff0c\u5b83\u5c31\u53ef\u4ee5\u91ca\u653e**bcache.lock\uff0c**\u7136\u540e\u9501\u5b9a\u7279\u5b9a\u7684\u5757\uff0c\u8fd9\u662f\u4e00\u79cd\u901a\u7528\u6a21\u5f0f\uff1a\u4e00\u7ec4\u4e00\u628a\u9501\uff0c\u5916\u52a0\u6bcf\u4e2a\u9879\u4e00\u628a\u9501\u3002</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u83b7\u53d6\u9501\u7684\u51fd\u6570\u4f1a\u91ca\u653e\u90a3\u628a\u9501\u3002\u4f46\u66f4\u51c6\u786e\u7684\u8bf4\u6cd5\u662f\uff0c\u5f53\u4e00\u4e2a\u5e8f\u5217\u9700\u8981\u4fdd\u8bc1\u539f\u5b50\u6027\u65f6\uff0c\u4f1a\u5728\u8be5\u5e8f\u5217\u5f00\u59cb\u65f6\u83b7\u53d6\u9501\uff0c\u800c\u5728\u5e8f\u5217\u7ed3\u675f\u65f6\u91ca\u653e\u9501\u3002\u5982\u679c\u5e8f\u5217\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u5728\u4e0d\u540c\u7684\u51fd\u6570\u4e2d\uff0c\u6216\u8005\u4e0d\u540c\u7684\u7ebf\u7a0b\u4e2d\uff0c\u6216\u8005\u5728\u4e0d\u540c\u7684CPU\u4e0a\uff0c\u90a3\u4e48\u9501\u7684\u83b7\u53d6\u548c\u91ca\u653e\u4e5f\u5fc5\u987b\u662f\u4e00\u6837\u7684\u3002\u9501\u7684\u529f\u80fd\u662f\u5f3a\u5236\u5176\u4ed6\u7684\u4f7f\u7528\u8005\u7b49\u5f85\uff0c\u800c\u4e0d\u662f\u5c06\u4e00\u6bb5\u6570\u636e\u7ed1\u5b9a\u7ed9\u7279\u5b9a\u7684\u4ee3\u7406\u3002\u4e00\u4e2a\u4f8b\u5b50\u662fyield\u4e2d\u7684**acquire**(kernel/proc.c:515)\uff0c\u5b83\u662f\u5728\u8c03\u5ea6\u7ebf\u7a0b\u4e2d\u91ca\u653e\u7684\uff0c\u800c\u4e0d\u662f\u5728\u83b7\u53d6\u9501\u7684\u8fdb\u7a0b\u4e2d\u91ca\u653e\u7684\u3002\u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f**ilock**(kernel/fs.c:289)\u4e2d\u7684**acquiresleep**\uff1b\u8fd9\u6bb5\u4ee3\u7801\u7ecf\u5e38\u5728\u8bfb\u53d6\u78c1\u76d8\u65f6\u7761\u7720\uff1b\u5b83\u53ef\u80fd\u5728\u4e0d\u540c\u7684CPU\u4e0a\u88ab\u5524\u9192\uff0c\u8fd9\u610f\u5473\u7740\u9501\u53ef\u80fd\u5728\u4e0d\u540c\u7684CPU\u4e0a\u83b7\u53d6\u548c\u91ca\u653e\u3002</p> <p>\u91ca\u653e\u4e00\u4e2a\u88ab\u9501\u4fdd\u62a4\u7684\u4e14\u9501\u5185\u5d4c\u5728\u5176\u4e2d\u7684\u5bf9\u8c61\u662f\u4e00\u4ef6\u5f88\u68d8\u624b\u7684\u4e8b\u60c5\uff0c\u56e0\u4e3a\u62e5\u6709\u9501\u5e76\u4e0d\u8db3\u4ee5\u4fdd\u8bc1\u91ca\u653e\u5bf9\u8c61\u7684\u6b63\u786e\u6027\u3002\u5f53\u6709\u5176\u4ed6\u7ebf\u7a0b\u5728**acquire**\u4e2d\u7b49\u5f85\u65f6\uff0c\u95ee\u9898\u5c31\u4f1a\u51fa\u73b0\uff1b\u91ca\u653e\u8fd9\u4e2a\u5bf9\u8c61\u5c31\u610f\u5473\u7740\u91ca\u653e\u5185\u5d4c\u7684\u9501\uff0c\u800c\u91ca\u653e\u8fd9\u4e2a\u9501\u4f1a\u5bfc\u81f4\u7b49\u5f85\u7ebf\u7a0b\u51fa\u9519\u3002\u4e00\u79cd\u65b9\u5f0f\u662f\u8ffd\u8e2a\u8be5\u5bf9\u8c61\u6709\u591a\u5c11\u4e2a\u5f15\u7528\uff0c\u53ea\u6709\u5728\u6700\u540e\u4e00\u4e2a\u5f15\u7528\u6d88\u5931\u65f6\u624d\u4f1a\u91ca\u653e\u5bf9\u8c61\u3002**pipeclose (kernel/pipe.c:59)**\u5c31\u662f\u8fd9\u6837\u7684\u4f8b\u5b50\u3002**pi-&gt;readopen**\u548c**pi-&gt;writeopen**\u8ddf\u8e2a\u662f\u5426\u6709\u6587\u4ef6\u63cf\u8ff0\u7b26\u5f15\u7528\u8be5\u7ba1\u9053\u3002</p>"},{"location":"os/Chapter-9/#92-lock-like-patterns","title":"9.2 Lock-like patterns","text":"<p>\u5728\u8bb8\u591a\u5730\u65b9\uff0cxv6\u4f7f\u7528\u5f15\u7528\u8ba1\u6570\u6216\u6807\u5fd7\u4f4d\u4f5c\u4e3a\u4e00\u79cd\u8f6f\u9501\uff08soft lock\uff09\uff0c\u4ee5\u8868\u660e\u4e00\u4e2a\u5bf9\u8c61\u5df2\u88ab\u5206\u914d\uff0c\u4e0d\u5e94\u8be5\u88ab\u91ca\u653e\u6216\u91cd\u7528\u3002\u8fdb\u7a0b\u7684**p-&gt;state**\u4f9d\u6b64\u5de5\u4f5c\uff0cfile\u3001**inode**\u548c**buf**\u7ed3\u6784\u4e2d\u7684\u5f15\u7528\u8ba1\u6570\u4e5f\u662f\u5982\u6b64\u3002\u867d\u7136\u5728\u6bcf\u79cd\u60c5\u51b5\u4e0b\uff0c\u9501\u90fd\u4f1a\u4fdd\u62a4\u6807\u5fd7\u4f4d\u6216\u5f15\u7528\u8ba1\u6570\uff0c\u4f46\u6b63\u662f\u6807\u5fd7\u4f4d\u6216\u5f15\u7528\u8ba1\u6570\u9632\u6b62\u4e86\u5bf9\u8c61\u88ab\u8fc7\u65e9\u91ca\u653e\u3002  </p> <p>\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u7ed3\u6784\u4f53**inode**\u7684\u5f15\u7528\u8ba1\u6570\u4f5c\u4e3a\u4e00\u79cd\u5171\u4eab\u9501\uff0c\u53ef\u4ee5\u7531\u591a\u4e2a\u8fdb\u7a0b\u6301\u6709\uff0c\u4ee5\u907f\u514d\u4ee3\u7801\u4f7f\u7528\u666e\u901a\u9501\u65f6\u51fa\u73b0\u7684\u6b7b\u9501\u3002\u4f8b\u5982\uff0cnamex(kernel/fs.c:626)\u4e2d\u7684\u5faa\u73af\u4f9d\u6b21\u9501\u5b9a\u8def\u5f84\u4e0a\u7684\u6bcf\u4e2a\u76ee\u5f55\u3002\u7136\u800c\uff0c**namex**\u5fc5\u987b\u5728\u5faa\u73af\u672b\u5c3e\u91ca\u653e\u6bcf\u4e00\u4e2a\u9501\uff0c\u56e0\u4e3a\u5982\u679c\u5b83\u6301\u6709\u591a\u4e2a\u9501\uff0c\u90a3\u4e48\u5982\u679c\u8def\u5f84\u540d\u4e2d\u5305\u542b.(\u5373\u5f53\u524d\u76ee\u5f55\uff0c\u4f8b\u5982\uff0ca/./b)\uff0c\u5b83\u53ef\u80fd\u4f1a\u4e0e\u81ea\u5df1\u53d1\u751f\u6b7b\u9501\u3002\u5b83\u4e5f\u53ef\u80fd\u56e0\u4e3a\u6d89\u53ca\u76ee\u5f55\u548c..\u7684\u5e76\u53d1\u67e5\u627e\u800c\u6b7b\u9501\u3002\u6b63\u5982\u7b2c8\u7ae0\u6240\u89e3\u91ca\u7684\u90a3\u6837\uff0c\u89e3\u51b3\u65b9\u6848\u662f\u8ba9\u5faa\u73af\u5c06\u76ee\u5f55\u7684inode\u5e26\u5165\u4e0b\u4e00\u6b21\u8fed\u4ee3\uff0c\u5e76\u589e\u52a0\u5176\u5f15\u7528\u8ba1\u6570\uff0c\u4f46\u4e0d\u9501\u5b9a\u3002</p> <p>\u6709\u4e9b\u6570\u636e\u9879\u5728\u4e0d\u540c\u7684\u65f6\u5019\u4f1a\u53d7\u5230\u4e0d\u540c\u673a\u5236\u7684\u4fdd\u62a4\u3002\u5b83\u6709\u65f6\u53ef\u80fd\u4f1a\u88abxv6\u4ee3\u7801\u7684\u7ed3\u6784\u9690\u5f0f\u4fdd\u62a4\uff0c\u800c\u4e0d\u662f\u901a\u8fc7\u663e\u5f0f\u7684\u9501\u6765\u9632\u6b62\u5e76\u53d1\u8bbf\u95ee\u3002\u4f8b\u5982\uff0c\u5f53\u4e00\u4e2a\u7269\u7406\u9875\u662f\u7a7a\u95f2\u7684\u65f6\u5019\uff0c\u5b83\u88ab**kmem.lock\uff08kernel/kalloc.c:24\uff09\u4fdd\u62a4\u3002\u5982\u679c\u9875\u9762\u88ab\u5206\u914d\u4f5c\u4e3a\u7ba1\u9053(kernel/pipe.c:23)\uff0c\u5b83\u5c06\u88ab\u4e00\u4e2a\u4e0d\u540c\u7684\u9501(\u5185\u5d4c\u7684**pi-&gt;lock)\u4fdd\u62a4\u3002\u5982\u679c\u8be5\u9875\u88ab\u91cd\u65b0\u5206\u914d\u7ed9\u4e00\u4e2a\u65b0\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\uff0c\u5b83\u5c31\u4e0d\u4f1a\u53d7\u5230\u9501\u7684\u4fdd\u62a4\u3002\u76f8\u53cd\uff0c\u5206\u914d\u5668\u4e0d\u4f1a\u5c06\u8be5\u9875\u4ea4\u7ed9\u4efb\u4f55\u5176\u4ed6\u8fdb\u7a0b\uff08\u76f4\u5230\u5b83\u88ab\u91ca\u653e\uff09\u7684\u4e8b\u5b9e\u4fdd\u62a4\u4e86\u5b83\u4e0d\u88ab\u5e76\u53d1\u8bbf\u95ee\u3002\u4e00\u4e2a\u65b0\u8fdb\u7a0b\u7684\u5185\u5b58\u7684\u6240\u6709\u6743\u662f\u5f88\u590d\u6742\u7684\uff1a\u9996\u5148\u7236\u8fdb\u7a0b\u5728**fork**\u4e2d\u5206\u914d\u548c\u64cd\u4f5c\u5b83\uff0c\u7136\u540e\u5b50\u8fdb\u7a0b\u4f7f\u7528\u5b83\uff0c\uff08\u5728\u5b50\u8fdb\u7a0b\u9000\u51fa\u540e\uff09\u7236\u8fdb\u7a0b\u518d\u6b21\u62e5\u6709\u5185\u5b58\uff0c\u5e76\u5c06\u5176\u4f20\u9012\u7ed9**kfree**\u3002\u8fd9\u91cc\u6709\u4e24\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\uff1a\u7b2c\u4e00\uff0c\u4e00\u4e2a\u6570\u636e\u5bf9\u8c61\u5728\u5176\u751f\u547d\u5468\u671f\u4e2d\u7684\u4e0d\u540c\u65f6\u523b\u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u6765\u4fdd\u62a4\u5b83\u4e0d\u88ab\u5e76\u53d1\u8bbf\u95ee\uff1b\u7b2c\u4e8c\uff0c\u4fdd\u62a4\u7684\u5f62\u5f0f\u53ef\u80fd\u662f\u9690\u5f0f\u7ed3\u6784\u800c\u4e0d\u662f\u663e\u5f0f\u9501\u3002</p> <p>\u6700\u540e\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u9501\u7684\u4f8b\u5b50\u662f\u5728\u8c03\u7528**mycpu()**(kernel/proc.c:68)\u65f6\u9700\u8981\u7981\u7528\u4e2d\u65ad\u3002\u7981\u7528\u4e2d\u65ad\u4f1a\u5bfc\u81f4\u8c03\u7528\u4ee3\u7801\u5bf9\u5b9a\u65f6\u5668\u4e2d\u65ad\u662f\u539f\u5b50\u6027\u7684\uff0c\u800c\u5b9a\u65f6\u5668\u4e2d\u65ad\u53ef\u80fd\u4f1a\u5f3a\u5236\u4e0a\u4e0b\u6587\u5207\u6362\uff0c\u4ece\u800c\u5c06\u8fdb\u7a0b\u79fb\u5230\u4e0d\u540c\u7684CPU\u4e0a\u3002</p>"},{"location":"os/Chapter-9/#93-no-locks-at-all","title":"9.3 No locks at all","text":"<p>xv6\u6709\u51e0\u4e2a\u5730\u65b9\u662f\u5728\u5b8c\u5168\u6ca1\u6709\u9501\u7684\u60c5\u51b5\u4e0b\u5171\u4eab\u53ef\u53d8\u6570\u636e\u7684\u3002\u4e00\u4e2a\u662f\u5728**spinlocks**\u7684\u5b9e\u73b0\u4e2d\uff0c\u5c3d\u7ba1\u4f60\u53ef\u4ee5\u628aRISC-V\u539f\u5b50\u6307\u4ee4\u770b\u4f5c\u662f\u4f9d\u9760\u786c\u4ef6\u5b9e\u73b0\u7684\u9501\u3002\u53e6\u4e00\u4e2a\u662f**main.c** (kernel/main.c:7)\u4e2d\u7684**started**\u53d8\u91cf\uff0c\u7528\u6765\u9632\u6b62\u5176\u4ed6CPU\u8fd0\u884c\uff0c\u76f4\u5230CPU 0\u5b8c\u6210xv6\u7684\u521d\u59cb\u5316\uff1b**volatile**\u786e\u4fdd\u7f16\u8bd1\u5668\u771f\u6b63\u751f\u6210\u52a0\u8f7d\u548c\u5b58\u50a8\u6307\u4ee4\u3002\u7b2c\u4e09\u4e2a\u4f8b\u5b50\u662fproc.c(kernel.proc.c:398)(kernel/proc.c:306)\u4e2d\u7684p-&gt;parent\u3002\u5b83\u7684\u4e00\u4e9b\u7528\u6cd5\u4f1a\u5bfc\u81f4\u6b7b\u9501\uff0c\u4f46\u662f\u660e\u663e\u4e0d\u4f1a\u6709\u5176\u4ed6\u8fdb\u7a0b\u80fd\u591f\u540c\u65f6\u4fee\u6539p-&gt;parent\u3002\u7b2c\u56db\u4e2a\u4f8b\u5b50\u662fp-&gt;killed\u3002\u5b83\u5728\u6301\u6709p-&gt;lock\u65f6\u88ab\u8bbe\u7f6e\uff0c\u4f46\u5728\u68c0\u67e5\u65f6\u5374\u5e76\u4e0d\u9700\u8981\u9501\u3002</p> <p>Xv6\u5305\u542b\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u4e00\u4e2aCPU\u6216\u7ebf\u7a0b\u5199\u4e00\u4e9b\u6570\u636e\uff0c\u53e6\u4e00\u4e2aCPU\u6216\u7ebf\u7a0b\u8bfb\u6570\u636e\uff0c\u4f46\u6ca1\u6709\u4e13\u95e8\u7684\u9501\u6765\u4fdd\u62a4\u8fd9\u4e9b\u6570\u636e\u3002\u4f8b\u5982\uff0c\u5728**fork**\u4e2d\uff0c\u7236\u8fdb\u7a0b\u5199\u5165\u5b50\u8fdb\u7a0b\u7684\u7528\u6237\u5185\u5b58\u9875\uff0c\u5b50\u8fdb\u7a0b(\u53ef\u80fd\u5728\u4e0d\u540c\u7684CPU\u4e0a)\u8bfb\u53d6\u8fd9\u4e9b\u9875\u3002\u8fd9\u4e9b\u9875\u6ca1\u6709\u9501\u6765\u663e\u5f0f\u5730\u4fdd\u62a4\u3002\u4e25\u683c\u6765\u8bf4\uff0c\u8fd9\u4e0d\u662f\u9501\u7684\u95ee\u9898\uff0c\u56e0\u4e3a\u5b50\u8fdb\u7a0b\u5728\u7236\u8fdb\u7a0b\u5199\u5b8c\u540e\u624d\u5f00\u59cb\u6267\u884c\u3002\u8fd9\u662f\u4e00\u4e2a\u6f5c\u5728\u7684\u5185\u5b58\u64cd\u4f5c\u7684\u987a\u5e8f\u95ee\u9898\uff08\u89c1\u7b2c6\u7ae0\uff09\uff0c\u56e0\u4e3a\u6ca1\u6709\u5185\u5b58\u5c4f\u969c\uff0c\u6ca1\u6709\u7406\u7531\u671f\u671b\u4e00\u4e2aCPU\u770b\u5230\u53e6\u4e00\u4e2aCPU\u7684\u5199\u5165\u3002\u7136\u800c\uff0c\u7531\u4e8e\u7236\u8fdb\u7a0bCPU\u91ca\u653e\u9501\uff0c\u800c\u5b50\u8fdb\u7a0bCPU\u5728\u542f\u52a8\u65f6\u83b7\u53d6\u9501\uff0c\u6240\u4ee5\u5728**acquire**\u548c**release**\u4e2d\u7684\u5185\u5b58\u5c4f\u969c\u4fdd\u8bc1\u4e86\u5b50\u8fdb\u7a0bCPU\u80fd\u770b\u5230\u7236\u8fdb\u7a0bCPU\u7684\u5199\u5165\u3002</p>"},{"location":"os/Chapter-9/#94-parallelism","title":"9.4 Parallelism","text":"<p>\u9501\u4e3b\u8981\u662f\u4e3a\u4e86\u6b63\u786e\u6027\u800c\u6291\u5236\u5e76\u884c\u6027\u3002\u4f46\u662f\u6027\u80fd\u4e5f\u5f88\u91cd\u8981\uff0c\u6240\u4ee5\u5185\u6838\u8bbe\u8ba1\u8005\u7ecf\u5e38\u8981\u8003\u8651\u5982\u4f55\u4f7f\u7528\u9501\uff0c\u6765\u540c\u65f6\u4fdd\u8bc1\u6b63\u786e\u6027\u548c\u826f\u597d\u7684\u5e76\u884c\u6027\u3002\u867d\u7136xv6\u5e76\u672a\u5bf9\u9ad8\u6027\u80fd\u8fdb\u884c\u7cfb\u7edf\u5730\u8bbe\u8ba1\uff0c\u4f46\u4ecd\u7136\u503c\u5f97\u8003\u8651\u54ea\u4e9bxv6\u64cd\u4f5c\u53ef\u4ee5\u5e76\u884c\u6267\u884c\uff0c\u54ea\u4e9b\u64cd\u4f5c\u53ef\u80fd\u5728\u9501\u4e0a\u53d1\u751f\u51b2\u7a81\u3002</p> <p>xv6\u4e2d\u7684\u7ba1\u9053\u662f\u4e00\u4e2a\u5e76\u884c\u6027\u76f8\u5f53\u597d\u7684\u4f8b\u5b50\u3002\u6bcf\u4e2a\u7ba1\u9053\u90fd\u6709\u81ea\u5df1\u7684\u9501\uff0c\u56e0\u6b64\u4e0d\u540c\u7684\u8fdb\u7a0b\u53ef\u4ee5\u5728\u4e0d\u540c\u7684CPU\u4e0a\u5e76\u884c\u8bfb\u5199\u4e0d\u540c\u7684\u7ba1\u9053\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7ed9\u5b9a\u7684\u7ba1\u9053\uff0cwriter\u548creader\u5fc5\u987b\u7b49\u5f85\u5bf9\u65b9\u91ca\u653e\u9501\uff0c\u4ed6\u4eec\u4e0d\u80fd\u540c\u65f6\u8bfb/\u5199\u540c\u4e00\u4e2a\u7ba1\u9053\u3002\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u662f\uff0c\u4ece\u4e00\u4e2a\u7a7a\u7ba1\u9053\u8bfb\uff08\u6216\u5411\u4e00\u4e2a\u6ee1\u7ba1\u9053\u5199\uff09\u5fc5\u987b\u963b\u585e\uff0c\u4f46\u8fd9\u4e0d\u662f\u9501\u7684\u65b9\u6848\u5bfc\u81f4\u7684\u95ee\u9898\u3002</p> <p>\u4e0a\u4e0b\u6587\u5207\u6362\u662f\u4e00\u4e2a\u66f4\u590d\u6742\u7684\u4f8b\u5b50\u3002\u4e24\u4e2a\u5728\u5404\u81eaCPU\u4e0a\u6267\u884c\u7684\u5185\u6838\u7ebf\u7a0b\uff0c\u53ef\u4ee5\u540c\u65f6\u8c03\u7528**yield**\u3001sched**\u548c**swtch\uff0c\u5e76\u4e14\u8fd9\u4e9b\u8c03\u7528\u80fd\u5e76\u884c\u6267\u884c\u3002\u8fd9\u4e24\u4e2a\u7ebf\u7a0b\u5404\u81ea\u6301\u6709\u4e00\u4e2a\u9501\uff0c\u4f46\u662f\u4e0d\u540c\u7684\u9501\uff0c\u6240\u4ee5\u5b83\u4eec\u4e0d\u5fc5\u7b49\u5f85\u5bf9\u65b9\u3002\u4e00\u65e6\u8fdb\u5165**scheduler**\uff0c\u4e24\u4e2aCPU\u5728\u904d\u5386\u8fdb\u7a0b\u8868\u5bfb\u627e\u4e00\u4e2aRUNNABLE\u7684\u8fdb\u7a0b\u7684\u65f6\u5019\uff0c\u5374\u53ef\u80fd\u4f1a\u53d1\u751f\u9501\u51b2\u7a81\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cxv6\u5728\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5f88\u53ef\u80fd\u4f1a\u4ece\u591a\u4e2aCPU\u4e2d\u83b7\u5f97\u6027\u80fd\u4e0a\u7684\u597d\u5904\uff0c\u4f46\u53ef\u80fd\u6ca1\u6709\u90a3\u4e48\u591a\u3002</p> <p>\u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\u5728\u4e0d\u540c\u7684CPU\u4e0a\u4ece\u4e0d\u540c\u7684\u8fdb\u7a0b\u5e76\u53d1\u8c03\u7528**fork**\u3002\u8fd9\u4e9b\u8c03\u7528\u53ef\u80fd\u9700\u8981\u4e92\u76f8\u7b49\u5f85**pid_lock**\u548c**kmem.lock**\uff0c\u4ee5\u53ca\u5728\u8fdb\u7a0b\u8868\u4e2d\u641c\u7d22\u4e00\u4e2a**UNUSED**\u8fdb\u7a0b\u6240\u9700\u7684\u8fdb\u7a0b\u9501\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e24\u4e2a\u6b63\u5728fork\u7684\u8fdb\u7a0b\u53ef\u4ee5\u5b8c\u5168\u5e76\u884c\u5730\u590d\u5236\u7528\u6237\u5185\u5b58\u9875\u548c\u683c\u5f0f\u5316\u9875\u8868\u9875\u3002</p> <p>\u4e0a\u8ff0\u6bcf\u4e2a\u4f8b\u5b50\u4e2d\u7684\u9501\u65b9\u6848\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u90fd\u727a\u7272\u4e86\u5e76\u884c\u6027\u80fd\u3002\u5728\u6bcf\u4e00\u79cd\u60c5\u51b5\u4e0b\uff0c\u90fd\u6709\u53ef\u80fd\u901a\u8fc7\u66f4\u590d\u6742\u7684\u8bbe\u8ba1\u83b7\u5f97\u66f4\u591a\u7684\u5e76\u884c\u6027\u3002\u8fd9\u662f\u5426\u503c\u5f97\u53d6\u51b3\u4e8e\u7ec6\u8282\uff1a\u76f8\u5173\u64cd\u4f5c\u88ab\u8c03\u7528\u7684\u9891\u7387\u3001\u4ee3\u7801\u5728\u9501\u7ade\u4e89\u7684\u60c5\u51b5\u4e0b\u6240\u82b1\u8d39\u7684\u65f6\u95f4\u3001\u6709\u591a\u5c11CPU\u53ef\u80fd\u540c\u65f6\u8fd0\u884c\u51b2\u7a81\u7684\u64cd\u4f5c\u3001\u662f\u5426\u4ee3\u7801\u7684\u5176\u4ed6\u90e8\u5206\u624d\u662f\u6027\u80fd\u74f6\u9888\u3002\u5f88\u96be\u731c\u6d4b\u4e00\u4e2a\u7ed9\u5b9a\u7684\u9501\u65b9\u6848\u662f\u5426\u4f1a\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\uff0c\u6216\u8005\u4e00\u4e2a\u65b0\u7684\u8bbe\u8ba1\u662f\u5426\u6709\u660e\u663e\u7684\u6539\u8fdb\uff0c\u6240\u4ee5\u5f80\u5f80\u9700\u8981\u5728\u73b0\u5b9e\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u8fdb\u884c\u6d4b\u91cf\u3002</p>"},{"location":"os/Chapter-9/#95-exercises","title":"9.5 Exercises","text":"<ol> <li> <p>\u4fee\u6539xv6\u7ba1\u9053\u7684\u5b9e\u73b0\uff0c\u5141\u8bb8\u5bf9\u540c\u4e00\u7ba1\u9053\u7684\u8bfb\u548c\u5199\u5728\u4e0d\u540c\u5185\u6838\u4e0a\u5e76\u884c\u8fdb\u884c\u3002</p> </li> <li> <p>\u4fee\u6539xv6 scheduler()\uff0c\u4ee5\u51cf\u5c11\u4e0d\u540c\u5185\u6838\u540c\u65f6\u5bfb\u627e\u53ef\u8fd0\u884c\u8fdb\u7a0b\u65f6\u7684\u9501\u7ade\u4e89\u3002</p> </li> <li> <p>\u6d88\u9664**fork**\u4e2d\u4e00\u4e9b\u4e32\u884c\u6267\u884c\u7684\u4ee3\u7801\u3002</p> </li> </ol>"},{"location":"blog/archive/2024/","title":"2024","text":""},{"location":"blog/category/fuzz/","title":"Fuzz","text":""},{"location":"blog/category/discussion/","title":"Discussion","text":""},{"location":"blog/category/source-code-reading/","title":"Source Code Reading","text":""},{"location":"blog/category/paper-reading-notes/","title":"Paper Reading Notes","text":""},{"location":"tags/","title":"\u6807\u7b7e\u7d22\u5f15","text":"<p>\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u901a\u8fc7\u6807\u7b7e\u8fdb\u884c\u6587\u7ae0\u7d22\u5f15</p>"},{"location":"tags/#fuzz","title":"Fuzz","text":"<ul> <li>Libfuzzer \u6e90\u7801\u9605\u8bfb\uff08\u4e00\uff09</li> <li>\u8bba\u6587\u7cbe\u8bfb\uff1aIJON: Exploring Deep State Spaces via Fuzzing \uff08\u66f4\u65b0\u4e2d\uff09</li> <li>\u8bb0\u7b2c\u4e8c\u6b21\u8bba\u6587\u7814\u8ba8</li> <li>\u8bb0\u7b2c\u4e00\u6b21\u8bba\u6587\u7814\u8ba8</li> </ul>"},{"location":"tags/#iie","title":"IIE","text":"<ul> <li>Libfuzzer \u6e90\u7801\u9605\u8bfb\uff08\u4e00\uff09</li> <li>\u8bba\u6587\u7cbe\u8bfb\uff1aIJON: Exploring Deep State Spaces via Fuzzing \uff08\u66f4\u65b0\u4e2d\uff09</li> <li>\u8bb0\u7b2c\u4e8c\u6b21\u8bba\u6587\u7814\u8ba8</li> <li>\u8bb0\u7b2c\u4e00\u6b21\u8bba\u6587\u7814\u8ba8</li> </ul>"},{"location":"tags/#libfuzzer","title":"Libfuzzer","text":"<ul> <li>Libfuzzer \u6e90\u7801\u9605\u8bfb\uff08\u4e00\uff09</li> </ul>"}]}